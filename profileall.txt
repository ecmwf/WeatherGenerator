                                                                                                                  Memory usage: ▁▁▁▁▂▂▂▂▂▃▃▃▃▄▅▅▅▅▆▆▆▇▇▇▇██ (max: 374.853 MB, growth rate:  86%)                                                                                                                   
                                                                               /p/software/juwels/stages/2025/software/Python/3.12.3-GCCcore-13.3.0/lib/python3.12/threading.py: % of time =  66.67% (1m:5.889s) out of 2m:38.834s.                                                                                
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/software/juwels/stages/2025/software/Python/3.12.3-GCCcore-13.3.0/lib/python3.12/threading.py                                                                                                                                          
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │"""Thread module emulating a subset of Java's threading model."""                                                                                                                                                                         
     2 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
     3 │       │       │       │        │       │               │       │import os as _os                                                                                                                                                                                                                          
     4 │       │       │       │        │       │               │       │import sys as _sys                                                                                                                                                                                                                        
     5 │       │       │       │        │       │               │       │import _thread                                                                                                                                                                                                                            
     6 │       │       │       │        │       │               │       │import functools                                                                                                                                                                                                                          
     7 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
     8 │       │       │       │        │       │               │       │from time import monotonic as _time                                                                                                                                                                                                       
     9 │       │       │       │        │       │               │       │from _weakrefset import WeakSet                                                                                                                                                                                                           
    10 │       │       │       │        │       │               │       │from itertools import count as _count                                                                                                                                                                                                     
    11 │       │       │       │        │       │               │       │try:                                                                                                                                                                                                                                      
    12 │       │       │       │        │       │               │       │    from _collections import deque as _deque                                                                                                                                                                                              
    13 │       │       │       │        │       │               │       │except ImportError:                                                                                                                                                                                                                       
    14 │       │       │       │        │       │               │       │    from collections import deque as _deque                                                                                                                                                                                               
    15 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    16 │       │       │       │        │       │               │       │# Note regarding PEP 8 compliant names                                                                                                                                                                                                    
    17 │       │       │       │        │       │               │       │#  This threading model was originally inspired by Java, and inherited                                                                                                                                                                    
    18 │       │       │       │        │       │               │       │# the convention of camelCase function and method names from that                                                                                                                                                                         
    19 │       │       │       │        │       │               │       │# language. Those original names are not in any imminent danger of                                                                                                                                                                        
    20 │       │       │       │        │       │               │       │# being deprecated (even for Py3k),so this module provides them as an                                                                                                                                                                     
    21 │       │       │       │        │       │               │       │# alias for the PEP 8 compliant names                                                                                                                                                                                                     
    22 │       │       │       │        │       │               │       │# Note that using the new PEP 8 compliant names facilitates substitution                                                                                                                                                                  
    23 │       │       │       │        │       │               │       │# with the multiprocessing module, which doesn't provide the old                                                                                                                                                                          
    24 │       │       │       │        │       │               │       │# Java inspired names.                                                                                                                                                                                                                    
    25 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    26 │       │       │       │        │       │               │       │__all__ = ['get_ident', 'active_count', 'Condition', 'current_thread',                                                                                                                                                                    
    27 │       │       │       │        │       │               │       │           'enumerate', 'main_thread', 'TIMEOUT_MAX',                                                                                                                                                                                     
    28 │       │       │       │        │       │               │       │           'Event', 'Lock', 'RLock', 'Semaphore', 'BoundedSemaphore', 'Thread',                                                                                                                                                           
    29 │       │       │       │        │       │               │       │           'Barrier', 'BrokenBarrierError', 'Timer', 'ThreadError',                                                                                                                                                                       
    30 │       │       │       │        │       │               │       │           'setprofile', 'settrace', 'local', 'stack_size',                                                                                                                                                                               
    31 │       │       │       │        │       │               │       │           'excepthook', 'ExceptHookArgs', 'gettrace', 'getprofile',                                                                                                                                                                      
    32 │       │       │       │        │       │               │       │           'setprofile_all_threads','settrace_all_threads']                                                                                                                                                                               
    33 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    34 │       │       │       │        │       │               │       │# Rename some stuff so "from threading import *" is safe                                                                                                                                                                                  
    35 │       │       │       │        │       │               │       │_start_new_thread = _thread.start_new_thread                                                                                                                                                                                              
    36 │       │       │       │        │       │               │       │_daemon_threads_allowed = _thread.daemon_threads_allowed                                                                                                                                                                                  
    37 │       │       │       │        │       │               │       │_allocate_lock = _thread.allocate_lock                                                                                                                                                                                                    
    38 │       │       │       │        │       │               │       │_set_sentinel = _thread._set_sentinel                                                                                                                                                                                                     
    39 │       │       │       │        │       │               │       │get_ident = _thread.get_ident                                                                                                                                                                                                             
    40 │       │       │       │        │       │               │       │try:                                                                                                                                                                                                                                      
    41 │       │       │       │        │       │               │       │    _is_main_interpreter = _thread._is_main_interpreter                                                                                                                                                                                   
    42 │       │       │       │        │       │               │       │except AttributeError:                                                                                                                                                                                                                    
    43 │       │       │       │        │       │               │       │    # See https://github.com/python/cpython/issues/112826.                                                                                                                                                                                
    44 │       │       │       │        │       │               │       │    # We can pretend a subinterpreter is the main interpreter for the                                                                                                                                                                     
    45 │       │       │       │        │       │               │       │    # sake of _shutdown(), since that only means we do not wait for the                                                                                                                                                                   
    46 │       │       │       │        │       │               │       │    # subinterpreter's threads to finish.  Instead, they will be stopped                                                                                                                                                                  
    47 │       │       │       │        │       │               │       │    # later by the mechanism we use for daemon threads.  The likelihood                                                                                                                                                                   
    48 │       │       │       │        │       │               │       │    # of this case is small because rarely will the _thread module be                                                                                                                                                                     
    49 │       │       │       │        │       │               │       │    # replaced by a module without _is_main_interpreter().                                                                                                                                                                                
    50 │       │       │       │        │       │               │       │    # Furthermore, this is all irrelevant in applications                                                                                                                                                                                 
    51 │       │       │       │        │       │               │       │    # that do not use subinterpreters.                                                                                                                                                                                                    
    52 │       │       │       │        │       │               │       │    def _is_main_interpreter():                                                                                                                                                                                                           
    53 │       │       │       │        │       │               │       │        return True                                                                                                                                                                                                                       
    54 │       │       │       │        │       │               │       │try:                                                                                                                                                                                                                                      
    55 │       │       │       │        │       │               │       │    get_native_id = _thread.get_native_id                                                                                                                                                                                                 
    56 │       │       │       │        │       │               │       │    _HAVE_THREAD_NATIVE_ID = True                                                                                                                                                                                                         
    57 │       │       │       │        │       │               │       │    __all__.append('get_native_id')                                                                                                                                                                                                       
    58 │       │       │       │        │       │               │       │except AttributeError:                                                                                                                                                                                                                    
    59 │       │       │       │        │       │               │       │    _HAVE_THREAD_NATIVE_ID = False                                                                                                                                                                                                        
    60 │       │       │       │        │       │               │       │ThreadError = _thread.error                                                                                                                                                                                                               
    61 │       │       │       │        │       │               │       │try:                                                                                                                                                                                                                                      
    62 │       │       │       │        │       │               │       │    _CRLock = _thread.RLock                                                                                                                                                                                                               
    63 │       │       │       │        │       │               │       │except AttributeError:                                                                                                                                                                                                                    
    64 │       │       │       │        │       │               │       │    _CRLock = None                                                                                                                                                                                                                        
    65 │       │       │       │        │       │               │       │TIMEOUT_MAX = _thread.TIMEOUT_MAX                                                                                                                                                                                                         
    66 │       │       │       │        │       │               │       │del _thread                                                                                                                                                                                                                               
    67 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    68 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    69 │       │       │       │        │       │               │       │# Support for profile and trace hooks                                                                                                                                                                                                     
    70 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    71 │       │       │       │        │       │               │       │_profile_hook = None                                                                                                                                                                                                                      
    72 │       │       │       │        │       │               │       │_trace_hook = None                                                                                                                                                                                                                        
    73 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    74 │       │       │       │        │       │               │       │def setprofile(func):                                                                                                                                                                                                                     
    75 │       │       │       │        │       │               │       │    """Set a profile function for all threads started from the threading module.                                                                                                                                                          
    76 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    77 │       │       │       │        │       │               │       │    The func will be passed to sys.setprofile() for each thread, before its                                                                                                                                                               
    78 │       │       │       │        │       │               │       │    run() method is called.                                                                                                                                                                                                               
    79 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    80 │       │       │       │        │       │               │       │    global _profile_hook                                                                                                                                                                                                                  
    81 │       │       │       │        │       │               │       │    _profile_hook = func                                                                                                                                                                                                                  
    82 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    83 │       │       │       │        │       │               │       │def setprofile_all_threads(func):                                                                                                                                                                                                         
    84 │       │       │       │        │       │               │       │    """Set a profile function for all threads started from the threading module                                                                                                                                                           
    85 │       │       │       │        │       │               │       │    and all Python threads that are currently executing.                                                                                                                                                                                  
    86 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    87 │       │       │       │        │       │               │       │    The func will be passed to sys.setprofile() for each thread, before its                                                                                                                                                               
    88 │       │       │       │        │       │               │       │    run() method is called.                                                                                                                                                                                                               
    89 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    90 │       │       │       │        │       │               │       │    setprofile(func)                                                                                                                                                                                                                      
    91 │       │       │       │        │       │               │       │    _sys._setprofileallthreads(func)                                                                                                                                                                                                      
    92 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    93 │       │       │       │        │       │               │       │def getprofile():                                                                                                                                                                                                                         
    94 │       │       │       │        │       │               │       │    """Get the profiler function as set by threading.setprofile()."""                                                                                                                                                                     
    95 │       │       │       │        │       │               │       │    return _profile_hook                                                                                                                                                                                                                  
    96 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    97 │       │       │       │        │       │               │       │def settrace(func):                                                                                                                                                                                                                       
    98 │       │       │       │        │       │               │       │    """Set a trace function for all threads started from the threading module.                                                                                                                                                            
    99 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   100 │       │       │       │        │       │               │       │    The func will be passed to sys.settrace() for each thread, before its run()                                                                                                                                                           
   101 │       │       │       │        │       │               │       │    method is called.                                                                                                                                                                                                                     
   102 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   103 │       │       │       │        │       │               │       │    global _trace_hook                                                                                                                                                                                                                    
   104 │       │       │       │        │       │               │       │    _trace_hook = func                                                                                                                                                                                                                    
   105 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   106 │       │       │       │        │       │               │       │def settrace_all_threads(func):                                                                                                                                                                                                           
   107 │       │       │       │        │       │               │       │    """Set a trace function for all threads started from the threading module                                                                                                                                                             
   108 │       │       │       │        │       │               │       │    and all Python threads that are currently executing.                                                                                                                                                                                  
   109 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   110 │       │       │       │        │       │               │       │    The func will be passed to sys.settrace() for each thread, before its run()                                                                                                                                                           
   111 │       │       │       │        │       │               │       │    method is called.                                                                                                                                                                                                                     
   112 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   113 │       │       │       │        │       │               │       │    settrace(func)                                                                                                                                                                                                                        
   114 │       │       │       │        │       │               │       │    _sys._settraceallthreads(func)                                                                                                                                                                                                        
   115 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   116 │       │       │       │        │       │               │       │def gettrace():                                                                                                                                                                                                                           
   117 │       │       │       │        │       │               │       │    """Get the trace function as set by threading.settrace()."""                                                                                                                                                                          
   118 │       │       │       │        │       │               │       │    return _trace_hook                                                                                                                                                                                                                    
   119 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   120 │       │       │       │        │       │               │       │# Synchronization classes                                                                                                                                                                                                                 
   121 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   122 │       │       │       │        │       │               │       │Lock = _allocate_lock                                                                                                                                                                                                                     
   123 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   124 │       │       │       │        │       │               │       │def RLock(*args, **kwargs):                                                                                                                                                                                                               
   125 │       │       │       │        │       │               │       │    """Factory function that returns a new reentrant lock.                                                                                                                                                                                
   126 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   127 │       │       │       │        │       │               │       │    A reentrant lock must be released by the thread that acquired it. Once a                                                                                                                                                              
   128 │       │       │       │        │       │               │       │    thread has acquired a reentrant lock, the same thread may acquire it again                                                                                                                                                            
   129 │       │       │       │        │       │               │       │    without blocking; the thread must release it once for each time it has                                                                                                                                                                
   130 │       │       │       │        │       │               │       │    acquired it.                                                                                                                                                                                                                          
   131 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   132 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   133 │       │       │       │        │       │               │       │    if _CRLock is None:                                                                                                                                                                                                                   
   134 │       │       │       │        │       │               │       │        return _PyRLock(*args, **kwargs)                                                                                                                                                                                                  
   135 │       │       │       │        │       │               │       │    return _CRLock(*args, **kwargs)                                                                                                                                                                                                       
   136 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   137 │       │       │       │        │       │               │       │class _RLock:                                                                                                                                                                                                                             
   138 │       │       │       │        │       │               │       │    """This class implements reentrant lock objects.                                                                                                                                                                                      
   139 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   140 │       │       │       │        │       │               │       │    A reentrant lock must be released by the thread that acquired it. Once a                                                                                                                                                              
   141 │       │       │       │        │       │               │       │    thread has acquired a reentrant lock, the same thread may acquire it                                                                                                                                                                  
   142 │       │       │       │        │       │               │       │    again without blocking; the thread must release it once for each time it                                                                                                                                                              
   143 │       │       │       │        │       │               │       │    has acquired it.                                                                                                                                                                                                                      
   144 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   145 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   146 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   147 │       │       │       │        │       │               │       │    def __init__(self):                                                                                                                                                                                                                   
   148 │       │       │       │        │       │               │       │        self._block = _allocate_lock()                                                                                                                                                                                                    
   149 │       │       │       │        │       │               │       │        self._owner = None                                                                                                                                                                                                                
   150 │       │       │       │        │       │               │       │        self._count = 0                                                                                                                                                                                                                   
   151 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   152 │       │       │       │        │       │               │       │    def __repr__(self):                                                                                                                                                                                                                   
   153 │       │       │       │        │       │               │       │        owner = self._owner                                                                                                                                                                                                               
   154 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   155 │       │       │       │        │       │               │       │            owner = _active[owner].name                                                                                                                                                                                                   
   156 │       │       │       │        │       │               │       │        except KeyError:                                                                                                                                                                                                                  
   157 │       │       │       │        │       │               │       │            pass                                                                                                                                                                                                                          
   158 │       │       │       │        │       │               │       │        return "<%s %s.%s object owner=%r count=%d at %s>" % (                                                                                                                                                                            
   159 │       │       │       │        │       │               │       │            "locked" if self._block.locked() else "unlocked",                                                                                                                                                                             
   160 │       │       │       │        │       │               │       │            self.__class__.__module__,                                                                                                                                                                                                    
   161 │       │       │       │        │       │               │       │            self.__class__.__qualname__,                                                                                                                                                                                                  
   162 │       │       │       │        │       │               │       │            owner,                                                                                                                                                                                                                        
   163 │       │       │       │        │       │               │       │            self._count,                                                                                                                                                                                                                  
   164 │       │       │       │        │       │               │       │            hex(id(self))                                                                                                                                                                                                                 
   165 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   166 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   167 │       │       │       │        │       │               │       │    def _at_fork_reinit(self):                                                                                                                                                                                                            
   168 │       │       │       │        │       │               │       │        self._block._at_fork_reinit()                                                                                                                                                                                                     
   169 │       │       │       │        │       │               │       │        self._owner = None                                                                                                                                                                                                                
   170 │       │       │       │        │       │               │       │        self._count = 0                                                                                                                                                                                                                   
   171 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   172 │       │       │       │        │       │               │       │    def acquire(self, blocking=True, timeout=-1):                                                                                                                                                                                         
   173 │       │       │       │        │       │               │       │        """Acquire a lock, blocking or non-blocking.                                                                                                                                                                                      
   174 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   175 │       │       │       │        │       │               │       │        When invoked without arguments: if this thread already owns the lock,                                                                                                                                                             
   176 │       │       │       │        │       │               │       │        increment the recursion level by one, and return immediately. Otherwise,                                                                                                                                                          
   177 │       │       │       │        │       │               │       │        if another thread owns the lock, block until the lock is unlocked. Once                                                                                                                                                           
   178 │       │       │       │        │       │               │       │        the lock is unlocked (not owned by any thread), then grab ownership, set                                                                                                                                                          
   179 │       │       │       │        │       │               │       │        the recursion level to one, and return. If more than one thread is                                                                                                                                                                
   180 │       │       │       │        │       │               │       │        blocked waiting until the lock is unlocked, only one at a time will be                                                                                                                                                            
   181 │       │       │       │        │       │               │       │        able to grab ownership of the lock. There is no return value in this                                                                                                                                                              
   182 │       │       │       │        │       │               │       │        case.                                                                                                                                                                                                                             
   183 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   184 │       │       │       │        │       │               │       │        When invoked with the blocking argument set to true, do the same thing                                                                                                                                                            
   185 │       │       │       │        │       │               │       │        as when called without arguments, and return true.                                                                                                                                                                                
   186 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   187 │       │       │       │        │       │               │       │        When invoked with the blocking argument set to false, do not block. If a                                                                                                                                                          
   188 │       │       │       │        │       │               │       │        call without an argument would block, return false immediately;                                                                                                                                                                   
   189 │       │       │       │        │       │               │       │        otherwise, do the same thing as when called without arguments, and                                                                                                                                                                
   190 │       │       │       │        │       │               │       │        return true.                                                                                                                                                                                                                      
   191 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   192 │       │       │       │        │       │               │       │        When invoked with the floating-point timeout argument set to a positive                                                                                                                                                           
   193 │       │       │       │        │       │               │       │        value, block for at most the number of seconds specified by timeout                                                                                                                                                               
   194 │       │       │       │        │       │               │       │        and as long as the lock cannot be acquired.  Return true if the lock has                                                                                                                                                          
   195 │       │       │       │        │       │               │       │        been acquired, false if the timeout has elapsed.                                                                                                                                                                                  
   196 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   197 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   198 │       │       │       │        │       │               │       │        me = get_ident()                                                                                                                                                                                                                  
   199 │       │       │       │        │       │               │       │        if self._owner == me:                                                                                                                                                                                                             
   200 │       │       │       │        │       │               │       │            self._count += 1                                                                                                                                                                                                              
   201 │       │       │       │        │       │               │       │            return 1                                                                                                                                                                                                                      
   202 │       │       │       │        │       │               │       │        rc = self._block.acquire(blocking, timeout)                                                                                                                                                                                       
   203 │       │       │       │        │       │               │       │        if rc:                                                                                                                                                                                                                            
   204 │       │       │       │        │       │               │       │            self._owner = me                                                                                                                                                                                                              
   205 │       │       │       │        │       │               │       │            self._count = 1                                                                                                                                                                                                               
   206 │       │       │       │        │       │               │       │        return rc                                                                                                                                                                                                                         
   207 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   208 │       │       │       │        │       │               │       │    __enter__ = acquire                                                                                                                                                                                                                   
   209 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   210 │       │       │       │        │       │               │       │    def release(self):                                                                                                                                                                                                                    
   211 │       │       │       │        │       │               │       │        """Release a lock, decrementing the recursion level.                                                                                                                                                                              
   212 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   213 │       │       │       │        │       │               │       │        If after the decrement it is zero, reset the lock to unlocked (not owned                                                                                                                                                          
   214 │       │       │       │        │       │               │       │        by any thread), and if any other threads are blocked waiting for the                                                                                                                                                              
   215 │       │       │       │        │       │               │       │        lock to become unlocked, allow exactly one of them to proceed. If after                                                                                                                                                           
   216 │       │       │       │        │       │               │       │        the decrement the recursion level is still nonzero, the lock remains                                                                                                                                                              
   217 │       │       │       │        │       │               │       │        locked and owned by the calling thread.                                                                                                                                                                                           
   218 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   219 │       │       │       │        │       │               │       │        Only call this method when the calling thread owns the lock. A                                                                                                                                                                    
   220 │       │       │       │        │       │               │       │        RuntimeError is raised if this method is called when the lock is                                                                                                                                                                  
   221 │       │       │       │        │       │               │       │        unlocked.                                                                                                                                                                                                                         
   222 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   223 │       │       │       │        │       │               │       │        There is no return value.                                                                                                                                                                                                         
   224 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   225 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   226 │       │       │       │        │       │               │       │        if self._owner != get_ident():                                                                                                                                                                                                    
   227 │       │       │       │        │       │               │       │            raise RuntimeError("cannot release un-acquired lock")                                                                                                                                                                         
   228 │       │       │       │        │       │               │       │        self._count = count = self._count - 1                                                                                                                                                                                             
   229 │       │       │       │        │       │               │       │        if not count:                                                                                                                                                                                                                     
   230 │       │       │       │        │       │               │       │            self._owner = None                                                                                                                                                                                                            
   231 │       │       │       │        │       │               │       │            self._block.release()                                                                                                                                                                                                         
   232 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   233 │       │       │       │        │       │               │       │    def __exit__(self, t, v, tb):                                                                                                                                                                                                         
   234 │       │       │       │        │       │               │       │        self.release()                                                                                                                                                                                                                    
   235 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   236 │       │       │       │        │       │               │       │    # Internal methods used by condition variables                                                                                                                                                                                        
   237 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   238 │       │       │       │        │       │               │       │    def _acquire_restore(self, state):                                                                                                                                                                                                    
   239 │       │       │       │        │       │               │       │        self._block.acquire()                                                                                                                                                                                                             
   240 │       │       │       │        │       │               │       │        self._count, self._owner = state                                                                                                                                                                                                  
   241 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   242 │       │       │       │        │       │               │       │    def _release_save(self):                                                                                                                                                                                                              
   243 │       │       │       │        │       │               │       │        if self._count == 0:                                                                                                                                                                                                              
   244 │       │       │       │        │       │               │       │            raise RuntimeError("cannot release un-acquired lock")                                                                                                                                                                         
   245 │       │       │       │        │       │               │       │        count = self._count                                                                                                                                                                                                               
   246 │       │       │       │        │       │               │       │        self._count = 0                                                                                                                                                                                                                   
   247 │       │       │       │        │       │               │       │        owner = self._owner                                                                                                                                                                                                               
   248 │       │       │       │        │       │               │       │        self._owner = None                                                                                                                                                                                                                
   249 │       │       │       │        │       │               │       │        self._block.release()                                                                                                                                                                                                             
   250 │       │       │       │        │       │               │       │        return (count, owner)                                                                                                                                                                                                             
   251 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   252 │       │       │       │        │       │               │       │    def _is_owned(self):                                                                                                                                                                                                                  
   253 │       │       │       │        │       │               │       │        return self._owner == get_ident()                                                                                                                                                                                                 
   254 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   255 │       │       │       │        │       │               │       │    # Internal method used for reentrancy checks                                                                                                                                                                                          
   256 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   257 │       │       │       │        │       │               │       │    def _recursion_count(self):                                                                                                                                                                                                           
   258 │       │       │       │        │       │               │       │        if self._owner != get_ident():                                                                                                                                                                                                    
   259 │       │       │       │        │       │               │       │            return 0                                                                                                                                                                                                                      
   260 │       │       │       │        │       │               │       │        return self._count                                                                                                                                                                                                                
   261 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   262 │       │       │       │        │       │               │       │_PyRLock = _RLock                                                                                                                                                                                                                         
   263 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   264 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   265 │       │       │       │        │       │               │       │class Condition:                                                                                                                                                                                                                          
   266 │       │       │       │        │       │               │       │    """Class that implements a condition variable.                                                                                                                                                                                        
   267 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   268 │       │       │       │        │       │               │       │    A condition variable allows one or more threads to wait until they are                                                                                                                                                                
   269 │       │       │       │        │       │               │       │    notified by another thread.                                                                                                                                                                                                           
   270 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   271 │       │       │       │        │       │               │       │    If the lock argument is given and not None, it must be a Lock or RLock                                                                                                                                                                
   272 │       │       │       │        │       │               │       │    object, and it is used as the underlying lock. Otherwise, a new RLock object                                                                                                                                                          
   273 │       │       │       │        │       │               │       │    is created and used as the underlying lock.                                                                                                                                                                                           
   274 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   275 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   276 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   277 │       │       │       │        │       │               │       │    def __init__(self, lock=None):                                                                                                                                                                                                        
   278 │       │       │       │        │       │               │       │        if lock is None:                                                                                                                                                                                                                  
   279 │       │       │       │        │       │               │       │            lock = RLock()                                                                                                                                                                                                                
   280 │       │       │       │        │       │               │       │        self._lock = lock                                                                                                                                                                                                                 
   281 │       │       │       │        │       │               │       │        # Export the lock's acquire() and release() methods                                                                                                                                                                               
   282 │       │       │       │        │       │               │       │        self.acquire = lock.acquire                                                                                                                                                                                                       
   283 │       │       │       │        │       │               │       │        self.release = lock.release                                                                                                                                                                                                       
   284 │       │       │       │        │       │               │       │        # If the lock defines _release_save() and/or _acquire_restore(),                                                                                                                                                                  
   285 │       │       │       │        │       │               │       │        # these override the default implementations (which just call                                                                                                                                                                     
   286 │       │       │       │        │       │               │       │        # release() and acquire() on the lock).  Ditto for _is_owned().                                                                                                                                                                   
   287 │       │       │       │        │       │               │       │        if hasattr(lock, '_release_save'):                                                                                                                                                                                                
   288 │       │       │       │        │       │               │       │            self._release_save = lock._release_save                                                                                                                                                                                       
   289 │       │       │       │        │       │               │       │        if hasattr(lock, '_acquire_restore'):                                                                                                                                                                                             
   290 │       │       │       │        │       │               │       │            self._acquire_restore = lock._acquire_restore                                                                                                                                                                                 
   291 │       │       │       │        │       │               │       │        if hasattr(lock, '_is_owned'):                                                                                                                                                                                                    
   292 │       │       │       │        │       │               │       │            self._is_owned = lock._is_owned                                                                                                                                                                                               
   293 │       │       │       │        │       │               │       │        self._waiters = _deque()                                                                                                                                                                                                          
   294 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   295 │       │       │       │        │       │               │       │    def _at_fork_reinit(self):                                                                                                                                                                                                            
   296 │       │       │       │        │       │               │       │        self._lock._at_fork_reinit()                                                                                                                                                                                                      
   297 │       │       │       │        │       │               │       │        self._waiters.clear()                                                                                                                                                                                                             
   298 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   299 │       │       │       │        │       │               │       │    def __enter__(self):                                                                                                                                                                                                                  
   300 │       │       │       │        │       │               │       │        return self._lock.__enter__()                                                                                                                                                                                                     
   301 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   302 │       │       │       │        │       │               │       │    def __exit__(self, *args):                                                                                                                                                                                                            
   303 │       │       │       │        │       │               │       │        return self._lock.__exit__(*args)                                                                                                                                                                                                 
   304 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   305 │       │       │       │        │       │               │       │    def __repr__(self):                                                                                                                                                                                                                   
   306 │       │       │       │        │       │               │       │        return "<Condition(%s, %d)>" % (self._lock, len(self._waiters))                                                                                                                                                                   
   307 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   308 │       │       │       │        │       │               │       │    def _release_save(self):                                                                                                                                                                                                              
   309 │       │       │       │        │       │               │       │        self._lock.release()           # No state to save                                                                                                                                                                                 
   310 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   311 │       │       │       │        │       │               │       │    def _acquire_restore(self, x):                                                                                                                                                                                                        
   312 │       │       │       │        │       │               │       │        self._lock.acquire()           # Ignore saved state                                                                                                                                                                               
   313 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   314 │       │       │       │        │       │               │       │    def _is_owned(self):                                                                                                                                                                                                                  
   315 │       │       │       │        │       │               │       │        # Return True if lock is owned by current_thread.                                                                                                                                                                                 
   316 │       │       │       │        │       │               │       │        # This method is called only if _lock doesn't have _is_owned().                                                                                                                                                                   
   317 │       │       │       │        │       │               │       │        if self._lock.acquire(False):                                                                                                                                                                                                     
   318 │       │       │       │        │       │               │       │            self._lock.release()                                                                                                                                                                                                          
   319 │       │       │       │        │       │               │       │            return False                                                                                                                                                                                                                  
   320 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   321 │       │       │       │        │       │               │       │            return True                                                                                                                                                                                                                   
   322 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   323 │       │       │       │        │       │               │       │    def wait(self, timeout=None):                                                                                                                                                                                                         
   324 │       │       │       │        │       │               │       │        """Wait until notified or until a timeout occurs.                                                                                                                                                                                 
   325 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   326 │       │       │       │        │       │               │       │        If the calling thread has not acquired the lock when this method is                                                                                                                                                               
   327 │       │       │       │        │       │               │       │        called, a RuntimeError is raised.                                                                                                                                                                                                 
   328 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   329 │       │       │       │        │       │               │       │        This method releases the underlying lock, and then blocks until it is                                                                                                                                                             
   330 │       │       │       │        │       │               │       │        awakened by a notify() or notify_all() call for the same condition                                                                                                                                                                
   331 │       │       │       │        │       │               │       │        variable in another thread, or until the optional timeout occurs. Once                                                                                                                                                            
   332 │       │       │       │        │       │               │       │        awakened or timed out, it re-acquires the lock and returns.                                                                                                                                                                       
   333 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   334 │       │       │       │        │       │               │       │        When the timeout argument is present and not None, it should be a                                                                                                                                                                 
   335 │       │       │       │        │       │               │       │        floating point number specifying a timeout for the operation in seconds                                                                                                                                                           
   336 │       │       │       │        │       │               │       │        (or fractions thereof).                                                                                                                                                                                                           
   337 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   338 │       │       │       │        │       │               │       │        When the underlying lock is an RLock, it is not released using its                                                                                                                                                                
   339 │       │       │       │        │       │               │       │        release() method, since this may not actually unlock the lock when it                                                                                                                                                             
   340 │       │       │       │        │       │               │       │        was acquired multiple times recursively. Instead, an internal interface                                                                                                                                                           
   341 │       │       │       │        │       │               │       │        of the RLock class is used, which really unlocks it even when it has                                                                                                                                                              
   342 │       │       │       │        │       │               │       │        been recursively acquired several times. Another internal interface is                                                                                                                                                            
   343 │       │       │       │        │       │               │       │        then used to restore the recursion level when the lock is reacquired.                                                                                                                                                             
   344 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   345 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   346 │       │       │       │        │       │               │       │        if not self._is_owned():                                                                                                                                                                                                          
   347 │       │       │       │        │       │               │       │            raise RuntimeError("cannot wait on un-acquired lock")                                                                                                                                                                         
   348 │       │       │       │        │       │               │       │        waiter = _allocate_lock()                                                                                                                                                                                                         
   349 │       │       │       │        │       │               │       │        waiter.acquire()                                                                                                                                                                                                                  
   350 │       │       │       │        │       │               │       │        self._waiters.append(waiter)                                                                                                                                                                                                      
   351 │       │       │       │        │       │               │       │        saved_state = self._release_save()                                                                                                                                                                                                
   352 │       │       │       │        │       │               │       │        gotit = False                                                                                                                                                                                                                     
   353 │       │       │       │        │       │               │       │        try:    # restore state no matter what (e.g., KeyboardInterrupt)                                                                                                                                                                  
   354 │       │       │       │        │       │               │       │            if timeout is None:                                                                                                                                                                                                           
   355 │       │       │       │        │       │               │       │                waiter.acquire()                                                                                                                                                                                                          
   356 │       │       │       │        │       │               │       │                gotit = True                                                                                                                                                                                                              
   357 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   358 │       │       │       │        │       │               │       │                if timeout > 0:                                                                                                                                                                                                           
   359 │       │       │       │        │       │               │       │                    gotit = waiter.acquire(True, timeout)                                                                                                                                                                                 
   360 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
   361 │       │       │       │        │       │               │       │                    gotit = waiter.acquire(False)                                                                                                                                                                                         
   362 │       │       │       │        │       │               │       │            return gotit                                                                                                                                                                                                                  
   363 │       │       │       │        │       │               │       │        finally:                                                                                                                                                                                                                          
   364 │       │       │       │        │       │               │       │            self._acquire_restore(saved_state)                                                                                                                                                                                            
   365 │       │       │       │        │       │               │       │            if not gotit:                                                                                                                                                                                                                 
   366 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
   367 │       │       │       │        │       │               │       │                    self._waiters.remove(waiter)                                                                                                                                                                                          
   368 │       │       │       │        │       │               │       │                except ValueError:                                                                                                                                                                                                        
   369 │       │       │       │        │       │               │       │                    pass                                                                                                                                                                                                                  
   370 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   371 │       │       │       │        │       │               │       │    def wait_for(self, predicate, timeout=None):                                                                                                                                                                                          
   372 │       │       │       │        │       │               │       │        """Wait until a condition evaluates to True.                                                                                                                                                                                      
   373 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   374 │       │       │       │        │       │               │       │        predicate should be a callable which result will be interpreted as a                                                                                                                                                              
   375 │       │       │       │        │       │               │       │        boolean value.  A timeout may be provided giving the maximum time to                                                                                                                                                              
   376 │       │       │       │        │       │               │       │        wait.                                                                                                                                                                                                                             
   377 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   378 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   379 │       │       │       │        │       │               │       │        endtime = None                                                                                                                                                                                                                    
   380 │       │       │       │        │       │               │       │        waittime = timeout                                                                                                                                                                                                                
   381 │       │       │       │        │       │               │       │        result = predicate()                                                                                                                                                                                                              
   382 │       │       │       │        │       │               │       │        while not result:                                                                                                                                                                                                                 
   383 │       │       │       │        │       │               │       │            if waittime is not None:                                                                                                                                                                                                      
   384 │       │       │       │        │       │               │       │                if endtime is None:                                                                                                                                                                                                       
   385 │       │       │       │        │       │               │       │                    endtime = _time() + waittime                                                                                                                                                                                          
   386 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
   387 │       │       │       │        │       │               │       │                    waittime = endtime - _time()                                                                                                                                                                                          
   388 │       │       │       │        │       │               │       │                    if waittime <= 0:                                                                                                                                                                                                     
   389 │       │       │       │        │       │               │       │                        break                                                                                                                                                                                                             
   390 │       │       │       │        │       │               │       │            self.wait(waittime)                                                                                                                                                                                                           
   391 │       │       │       │        │       │               │       │            result = predicate()                                                                                                                                                                                                          
   392 │       │       │       │        │       │               │       │        return result                                                                                                                                                                                                                     
   393 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   394 │       │       │       │        │       │               │       │    def notify(self, n=1):                                                                                                                                                                                                                
   395 │       │       │       │        │       │               │       │        """Wake up one or more threads waiting on this condition, if any.                                                                                                                                                                 
   396 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   397 │       │       │       │        │       │               │       │        If the calling thread has not acquired the lock when this method is                                                                                                                                                               
   398 │       │       │       │        │       │               │       │        called, a RuntimeError is raised.                                                                                                                                                                                                 
   399 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   400 │       │       │       │        │       │               │       │        This method wakes up at most n of the threads waiting for the condition                                                                                                                                                           
   401 │       │       │       │        │       │               │       │        variable; it is a no-op if no threads are waiting.                                                                                                                                                                                
   402 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   403 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   404 │       │       │       │        │       │               │       │        if not self._is_owned():                                                                                                                                                                                                          
   405 │       │       │       │        │       │               │       │            raise RuntimeError("cannot notify on un-acquired lock")                                                                                                                                                                       
   406 │       │       │       │        │       │               │       │        waiters = self._waiters                                                                                                                                                                                                           
   407 │       │       │       │        │       │               │       │        while waiters and n > 0:                                                                                                                                                                                                          
   408 │       │       │       │        │       │               │       │            waiter = waiters[0]                                                                                                                                                                                                           
   409 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
   410 │       │       │       │        │       │               │       │                waiter.release()                                                                                                                                                                                                          
   411 │       │       │       │        │       │               │       │            except RuntimeError:                                                                                                                                                                                                          
   412 │       │       │       │        │       │               │       │                # gh-92530: The previous call of notify() released the lock,                                                                                                                                                              
   413 │       │       │       │        │       │               │       │                # but was interrupted before removing it from the queue.                                                                                                                                                                  
   414 │       │       │       │        │       │               │       │                # It can happen if a signal handler raises an exception,                                                                                                                                                                  
   415 │       │       │       │        │       │               │       │                # like CTRL+C which raises KeyboardInterrupt.                                                                                                                                                                             
   416 │       │       │       │        │       │               │       │                pass                                                                                                                                                                                                                      
   417 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   418 │       │       │       │        │       │               │       │                n -= 1                                                                                                                                                                                                                    
   419 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
   420 │       │       │       │        │       │               │       │                waiters.remove(waiter)                                                                                                                                                                                                    
   421 │       │       │       │        │       │               │       │            except ValueError:                                                                                                                                                                                                            
   422 │       │       │       │        │       │               │       │                pass                                                                                                                                                                                                                      
   423 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   424 │       │       │       │        │       │               │       │    def notify_all(self):                                                                                                                                                                                                                 
   425 │       │       │       │        │       │               │       │        """Wake up all threads waiting on this condition.                                                                                                                                                                                 
   426 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   427 │       │       │       │        │       │               │       │        If the calling thread has not acquired the lock when this method                                                                                                                                                                  
   428 │       │       │       │        │       │               │       │        is called, a RuntimeError is raised.                                                                                                                                                                                              
   429 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   430 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   431 │       │       │       │        │       │               │       │        self.notify(len(self._waiters))                                                                                                                                                                                                   
   432 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   433 │       │       │       │        │       │               │       │    def notifyAll(self):                                                                                                                                                                                                                  
   434 │       │       │       │        │       │               │       │        """Wake up all threads waiting on this condition.                                                                                                                                                                                 
   435 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   436 │       │       │       │        │       │               │       │        This method is deprecated, use notify_all() instead.                                                                                                                                                                              
   437 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   438 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   439 │       │       │       │        │       │               │       │        import warnings                                                                                                                                                                                                                   
   440 │       │       │       │        │       │               │       │        warnings.warn('notifyAll() is deprecated, use notify_all() instead',                                                                                                                                                              
   441 │       │       │       │        │       │               │       │                      DeprecationWarning, stacklevel=2)                                                                                                                                                                                   
   442 │       │       │       │        │       │               │       │        self.notify_all()                                                                                                                                                                                                                 
   443 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   444 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   445 │       │       │       │        │       │               │       │class Semaphore:                                                                                                                                                                                                                          
   446 │       │       │       │        │       │               │       │    """This class implements semaphore objects.                                                                                                                                                                                           
   447 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   448 │       │       │       │        │       │               │       │    Semaphores manage a counter representing the number of release() calls minus                                                                                                                                                          
   449 │       │       │       │        │       │               │       │    the number of acquire() calls, plus an initial value. The acquire() method                                                                                                                                                            
   450 │       │       │       │        │       │               │       │    blocks if necessary until it can return without making the counter                                                                                                                                                                    
   451 │       │       │       │        │       │               │       │    negative. If not given, value defaults to 1.                                                                                                                                                                                          
   452 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   453 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   454 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   455 │       │       │       │        │       │               │       │    # After Tim Peters' semaphore class, but not quite the same (no maximum)                                                                                                                                                              
   456 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   457 │       │       │       │        │       │               │       │    def __init__(self, value=1):                                                                                                                                                                                                          
   458 │       │       │       │        │       │               │       │        if value < 0:                                                                                                                                                                                                                     
   459 │       │       │       │        │       │               │       │            raise ValueError("semaphore initial value must be >= 0")                                                                                                                                                                      
   460 │       │       │       │        │       │               │       │        self._cond = Condition(Lock())                                                                                                                                                                                                    
   461 │       │       │       │        │       │               │       │        self._value = value                                                                                                                                                                                                               
   462 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   463 │       │       │       │        │       │               │       │    def __repr__(self):                                                                                                                                                                                                                   
   464 │       │       │       │        │       │               │       │        cls = self.__class__                                                                                                                                                                                                              
   465 │       │       │       │        │       │               │       │        return (f"<{cls.__module__}.{cls.__qualname__} at {id(self):#x}:"                                                                                                                                                                 
   466 │       │       │       │        │       │               │       │                f" value={self._value}>")                                                                                                                                                                                                 
   467 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   468 │       │       │       │        │       │               │       │    def acquire(self, blocking=True, timeout=None):                                                                                                                                                                                       
   469 │       │       │       │        │       │               │       │        """Acquire a semaphore, decrementing the internal counter by one.                                                                                                                                                                 
   470 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   471 │       │       │       │        │       │               │       │        When invoked without arguments: if the internal counter is larger than                                                                                                                                                            
   472 │       │       │       │        │       │               │       │        zero on entry, decrement it by one and return immediately. If it is zero                                                                                                                                                          
   473 │       │       │       │        │       │               │       │        on entry, block, waiting until some other thread has called release() to                                                                                                                                                          
   474 │       │       │       │        │       │               │       │        make it larger than zero. This is done with proper interlocking so that                                                                                                                                                           
   475 │       │       │       │        │       │               │       │        if multiple acquire() calls are blocked, release() will wake exactly one                                                                                                                                                          
   476 │       │       │       │        │       │               │       │        of them up. The implementation may pick one at random, so the order in                                                                                                                                                            
   477 │       │       │       │        │       │               │       │        which blocked threads are awakened should not be relied on. There is no                                                                                                                                                           
   478 │       │       │       │        │       │               │       │        return value in this case.                                                                                                                                                                                                        
   479 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   480 │       │       │       │        │       │               │       │        When invoked with blocking set to true, do the same thing as when called                                                                                                                                                          
   481 │       │       │       │        │       │               │       │        without arguments, and return true.                                                                                                                                                                                               
   482 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   483 │       │       │       │        │       │               │       │        When invoked with blocking set to false, do not block. If a call without                                                                                                                                                          
   484 │       │       │       │        │       │               │       │        an argument would block, return false immediately; otherwise, do the                                                                                                                                                              
   485 │       │       │       │        │       │               │       │        same thing as when called without arguments, and return true.                                                                                                                                                                     
   486 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   487 │       │       │       │        │       │               │       │        When invoked with a timeout other than None, it will block for at                                                                                                                                                                 
   488 │       │       │       │        │       │               │       │        most timeout seconds.  If acquire does not complete successfully in                                                                                                                                                               
   489 │       │       │       │        │       │               │       │        that interval, return false.  Return true otherwise.                                                                                                                                                                              
   490 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   491 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   492 │       │       │       │        │       │               │       │        if not blocking and timeout is not None:                                                                                                                                                                                          
   493 │       │       │       │        │       │               │       │            raise ValueError("can't specify timeout for non-blocking acquire")                                                                                                                                                            
   494 │       │       │       │        │       │               │       │        rc = False                                                                                                                                                                                                                        
   495 │       │       │       │        │       │               │       │        endtime = None                                                                                                                                                                                                                    
   496 │       │       │       │        │       │               │       │        with self._cond:                                                                                                                                                                                                                  
   497 │       │       │       │        │       │               │       │            while self._value == 0:                                                                                                                                                                                                       
   498 │       │       │       │        │       │               │       │                if not blocking:                                                                                                                                                                                                          
   499 │       │       │       │        │       │               │       │                    break                                                                                                                                                                                                                 
   500 │       │       │       │        │       │               │       │                if timeout is not None:                                                                                                                                                                                                   
   501 │       │       │       │        │       │               │       │                    if endtime is None:                                                                                                                                                                                                   
   502 │       │       │       │        │       │               │       │                        endtime = _time() + timeout                                                                                                                                                                                       
   503 │       │       │       │        │       │               │       │                    else:                                                                                                                                                                                                                 
   504 │       │       │       │        │       │               │       │                        timeout = endtime - _time()                                                                                                                                                                                       
   505 │       │       │       │        │       │               │       │                        if timeout <= 0:                                                                                                                                                                                                  
   506 │       │       │       │        │       │               │       │                            break                                                                                                                                                                                                         
   507 │       │       │       │        │       │               │       │                self._cond.wait(timeout)                                                                                                                                                                                                  
   508 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   509 │       │       │       │        │       │               │       │                self._value -= 1                                                                                                                                                                                                          
   510 │       │       │       │        │       │               │       │                rc = True                                                                                                                                                                                                                 
   511 │       │       │       │        │       │               │       │        return rc                                                                                                                                                                                                                         
   512 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   513 │       │       │       │        │       │               │       │    __enter__ = acquire                                                                                                                                                                                                                   
   514 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   515 │       │       │       │        │       │               │       │    def release(self, n=1):                                                                                                                                                                                                               
   516 │       │       │       │        │       │               │       │        """Release a semaphore, incrementing the internal counter by one or more.                                                                                                                                                         
   517 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   518 │       │       │       │        │       │               │       │        When the counter is zero on entry and another thread is waiting for it                                                                                                                                                            
   519 │       │       │       │        │       │               │       │        to become larger than zero again, wake up that thread.                                                                                                                                                                            
   520 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   521 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   522 │       │       │       │        │       │               │       │        if n < 1:                                                                                                                                                                                                                         
   523 │       │       │       │        │       │               │       │            raise ValueError('n must be one or more')                                                                                                                                                                                     
   524 │       │       │       │        │       │               │       │        with self._cond:                                                                                                                                                                                                                  
   525 │       │       │       │        │       │               │       │            self._value += n                                                                                                                                                                                                              
   526 │       │       │       │        │       │               │       │            self._cond.notify(n)                                                                                                                                                                                                          
   527 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   528 │       │       │       │        │       │               │       │    def __exit__(self, t, v, tb):                                                                                                                                                                                                         
   529 │       │       │       │        │       │               │       │        self.release()                                                                                                                                                                                                                    
   530 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   531 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   532 │       │       │       │        │       │               │       │class BoundedSemaphore(Semaphore):                                                                                                                                                                                                        
   533 │       │       │       │        │       │               │       │    """Implements a bounded semaphore.                                                                                                                                                                                                    
   534 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   535 │       │       │       │        │       │               │       │    A bounded semaphore checks to make sure its current value doesn't exceed its                                                                                                                                                          
   536 │       │       │       │        │       │               │       │    initial value. If it does, ValueError is raised. In most situations                                                                                                                                                                   
   537 │       │       │       │        │       │               │       │    semaphores are used to guard resources with limited capacity.                                                                                                                                                                         
   538 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   539 │       │       │       │        │       │               │       │    If the semaphore is released too many times it's a sign of a bug. If not                                                                                                                                                              
   540 │       │       │       │        │       │               │       │    given, value defaults to 1.                                                                                                                                                                                                           
   541 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   542 │       │       │       │        │       │               │       │    Like regular semaphores, bounded semaphores manage a counter representing                                                                                                                                                             
   543 │       │       │       │        │       │               │       │    the number of release() calls minus the number of acquire() calls, plus an                                                                                                                                                            
   544 │       │       │       │        │       │               │       │    initial value. The acquire() method blocks if necessary until it can return                                                                                                                                                           
   545 │       │       │       │        │       │               │       │    without making the counter negative. If not given, value defaults to 1.                                                                                                                                                               
   546 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   547 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   548 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   549 │       │       │       │        │       │               │       │    def __init__(self, value=1):                                                                                                                                                                                                          
   550 │       │       │       │        │       │               │       │        super().__init__(value)                                                                                                                                                                                                           
   551 │       │       │       │        │       │               │       │        self._initial_value = value                                                                                                                                                                                                       
   552 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   553 │       │       │       │        │       │               │       │    def __repr__(self):                                                                                                                                                                                                                   
   554 │       │       │       │        │       │               │       │        cls = self.__class__                                                                                                                                                                                                              
   555 │       │       │       │        │       │               │       │        return (f"<{cls.__module__}.{cls.__qualname__} at {id(self):#x}:"                                                                                                                                                                 
   556 │       │       │       │        │       │               │       │                f" value={self._value}/{self._initial_value}>")                                                                                                                                                                           
   557 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   558 │       │       │       │        │       │               │       │    def release(self, n=1):                                                                                                                                                                                                               
   559 │       │       │       │        │       │               │       │        """Release a semaphore, incrementing the internal counter by one or more.                                                                                                                                                         
   560 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   561 │       │       │       │        │       │               │       │        When the counter is zero on entry and another thread is waiting for it                                                                                                                                                            
   562 │       │       │       │        │       │               │       │        to become larger than zero again, wake up that thread.                                                                                                                                                                            
   563 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   564 │       │       │       │        │       │               │       │        If the number of releases exceeds the number of acquires,                                                                                                                                                                         
   565 │       │       │       │        │       │               │       │        raise a ValueError.                                                                                                                                                                                                               
   566 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   567 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   568 │       │       │       │        │       │               │       │        if n < 1:                                                                                                                                                                                                                         
   569 │       │       │       │        │       │               │       │            raise ValueError('n must be one or more')                                                                                                                                                                                     
   570 │       │       │       │        │       │               │       │        with self._cond:                                                                                                                                                                                                                  
   571 │       │       │       │        │       │               │       │            if self._value + n > self._initial_value:                                                                                                                                                                                     
   572 │       │       │       │        │       │               │       │                raise ValueError("Semaphore released too many times")                                                                                                                                                                     
   573 │       │       │       │        │       │               │       │            self._value += n                                                                                                                                                                                                              
   574 │       │       │       │        │       │               │       │            self._cond.notify(n)                                                                                                                                                                                                          
   575 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   576 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   577 │       │       │       │        │       │               │       │class Event:                                                                                                                                                                                                                              
   578 │       │       │       │        │       │               │       │    """Class implementing event objects.                                                                                                                                                                                                  
   579 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   580 │       │       │       │        │       │               │       │    Events manage a flag that can be set to true with the set() method and reset                                                                                                                                                          
   581 │       │       │       │        │       │               │       │    to false with the clear() method. The wait() method blocks until the flag is                                                                                                                                                          
   582 │       │       │       │        │       │               │       │    true.  The flag is initially false.                                                                                                                                                                                                   
   583 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   584 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   585 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   586 │       │       │       │        │       │               │       │    # After Tim Peters' event class (without is_posted())                                                                                                                                                                                 
   587 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   588 │       │       │       │        │       │               │       │    def __init__(self):                                                                                                                                                                                                                   
   589 │       │       │       │        │       │               │       │        self._cond = Condition(Lock())                                                                                                                                                                                                    
   590 │       │       │       │        │       │               │       │        self._flag = False                                                                                                                                                                                                                
   591 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   592 │       │       │       │        │       │               │       │    def __repr__(self):                                                                                                                                                                                                                   
   593 │       │       │       │        │       │               │       │        cls = self.__class__                                                                                                                                                                                                              
   594 │       │       │       │        │       │               │       │        status = 'set' if self._flag else 'unset'                                                                                                                                                                                         
   595 │       │       │       │        │       │               │       │        return f"<{cls.__module__}.{cls.__qualname__} at {id(self):#x}: {status}>"                                                                                                                                                        
   596 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   597 │       │       │       │        │       │               │       │    def _at_fork_reinit(self):                                                                                                                                                                                                            
   598 │       │       │       │        │       │               │       │        # Private method called by Thread._reset_internal_locks()                                                                                                                                                                         
   599 │       │       │       │        │       │               │       │        self._cond._at_fork_reinit()                                                                                                                                                                                                      
   600 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   601 │       │       │       │        │       │               │       │    def is_set(self):                                                                                                                                                                                                                     
   602 │       │       │       │        │       │               │       │        """Return true if and only if the internal flag is true."""                                                                                                                                                                       
   603 │       │       │       │        │       │               │       │        return self._flag                                                                                                                                                                                                                 
   604 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   605 │       │       │       │        │       │               │       │    def isSet(self):                                                                                                                                                                                                                      
   606 │       │       │       │        │       │               │       │        """Return true if and only if the internal flag is true.                                                                                                                                                                          
   607 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   608 │       │       │       │        │       │               │       │        This method is deprecated, use is_set() instead.                                                                                                                                                                                  
   609 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   610 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   611 │       │       │       │        │       │               │       │        import warnings                                                                                                                                                                                                                   
   612 │       │       │       │        │       │               │       │        warnings.warn('isSet() is deprecated, use is_set() instead',                                                                                                                                                                      
   613 │       │       │       │        │       │               │       │                      DeprecationWarning, stacklevel=2)                                                                                                                                                                                   
   614 │       │       │       │        │       │               │       │        return self.is_set()                                                                                                                                                                                                              
   615 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   616 │       │       │       │        │       │               │       │    def set(self):                                                                                                                                                                                                                        
   617 │       │       │       │        │       │               │       │        """Set the internal flag to true.                                                                                                                                                                                                 
   618 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   619 │       │       │       │        │       │               │       │        All threads waiting for it to become true are awakened. Threads                                                                                                                                                                   
   620 │       │       │       │        │       │               │       │        that call wait() once the flag is true will not block at all.                                                                                                                                                                     
   621 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   622 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   623 │       │       │       │        │       │               │       │        with self._cond:                                                                                                                                                                                                                  
   624 │       │       │       │        │       │               │       │            self._flag = True                                                                                                                                                                                                             
   625 │       │       │       │        │       │               │       │            self._cond.notify_all()                                                                                                                                                                                                       
   626 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   627 │       │       │       │        │       │               │       │    def clear(self):                                                                                                                                                                                                                      
   628 │       │       │       │        │       │               │       │        """Reset the internal flag to false.                                                                                                                                                                                              
   629 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   630 │       │       │       │        │       │               │       │        Subsequently, threads calling wait() will block until set() is called to                                                                                                                                                          
   631 │       │       │       │        │       │               │       │        set the internal flag to true again.                                                                                                                                                                                              
   632 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   633 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   634 │       │       │       │        │       │               │       │        with self._cond:                                                                                                                                                                                                                  
   635 │       │       │       │        │       │               │       │            self._flag = False                                                                                                                                                                                                            
   636 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   637 │       │       │       │        │       │               │       │    def wait(self, timeout=None):                                                                                                                                                                                                         
   638 │       │       │       │        │       │               │       │        """Block until the internal flag is true.                                                                                                                                                                                         
   639 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   640 │       │       │       │        │       │               │       │        If the internal flag is true on entry, return immediately. Otherwise,                                                                                                                                                             
   641 │       │       │       │        │       │               │       │        block until another thread calls set() to set the flag to true, or until                                                                                                                                                          
   642 │       │       │       │        │       │               │       │        the optional timeout occurs.                                                                                                                                                                                                      
   643 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   644 │       │       │       │        │       │               │       │        When the timeout argument is present and not None, it should be a                                                                                                                                                                 
   645 │       │       │       │        │       │               │       │        floating point number specifying a timeout for the operation in seconds                                                                                                                                                           
   646 │       │       │       │        │       │               │       │        (or fractions thereof).                                                                                                                                                                                                           
   647 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   648 │       │       │       │        │       │               │       │        This method returns the internal flag on exit, so it will always return                                                                                                                                                           
   649 │       │       │       │        │       │               │       │        True except if a timeout is given and the operation times out.                                                                                                                                                                    
   650 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   651 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   652 │       │       │       │        │       │               │       │        with self._cond:                                                                                                                                                                                                                  
   653 │       │       │       │        │       │               │       │            signaled = self._flag                                                                                                                                                                                                         
   654 │       │       │       │        │       │               │       │            if not signaled:                                                                                                                                                                                                              
   655 │       │       │       │        │       │               │       │                signaled = self._cond.wait(timeout)                                                                                                                                                                                       
   656 │       │       │       │        │       │               │       │            return signaled                                                                                                                                                                                                               
   657 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   658 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   659 │       │       │       │        │       │               │       │# A barrier class.  Inspired in part by the pthread_barrier_* api and                                                                                                                                                                     
   660 │       │       │       │        │       │               │       │# the CyclicBarrier class from Java.  See                                                                                                                                                                                                 
   661 │       │       │       │        │       │               │       │# http://sourceware.org/pthreads-win32/manual/pthread_barrier_init.html and                                                                                                                                                               
   662 │       │       │       │        │       │               │       │# http://java.sun.com/j2se/1.5.0/docs/api/java/util/concurrent/                                                                                                                                                                           
   663 │       │       │       │        │       │               │       │#        CyclicBarrier.html                                                                                                                                                                                                               
   664 │       │       │       │        │       │               │       │# for information.                                                                                                                                                                                                                        
   665 │       │       │       │        │       │               │       │# We maintain two main states, 'filling' and 'draining' enabling the barrier                                                                                                                                                              
   666 │       │       │       │        │       │               │       │# to be cyclic.  Threads are not allowed into it until it has fully drained                                                                                                                                                               
   667 │       │       │       │        │       │               │       │# since the previous cycle.  In addition, a 'resetting' state exists which is                                                                                                                                                             
   668 │       │       │       │        │       │               │       │# similar to 'draining' except that threads leave with a BrokenBarrierError,                                                                                                                                                              
   669 │       │       │       │        │       │               │       │# and a 'broken' state in which all threads get the exception.                                                                                                                                                                            
   670 │       │       │       │        │       │               │       │class Barrier:                                                                                                                                                                                                                            
   671 │       │       │       │        │       │               │       │    """Implements a Barrier.                                                                                                                                                                                                              
   672 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   673 │       │       │       │        │       │               │       │    Useful for synchronizing a fixed number of threads at known synchronization                                                                                                                                                           
   674 │       │       │       │        │       │               │       │    points.  Threads block on 'wait()' and are simultaneously awoken once they                                                                                                                                                            
   675 │       │       │       │        │       │               │       │    have all made that call.                                                                                                                                                                                                              
   676 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   677 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   678 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   679 │       │       │       │        │       │               │       │    def __init__(self, parties, action=None, timeout=None):                                                                                                                                                                               
   680 │       │       │       │        │       │               │       │        """Create a barrier, initialised to 'parties' threads.                                                                                                                                                                            
   681 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   682 │       │       │       │        │       │               │       │        'action' is a callable which, when supplied, will be called by one of                                                                                                                                                             
   683 │       │       │       │        │       │               │       │        the threads after they have all entered the barrier and just prior to                                                                                                                                                             
   684 │       │       │       │        │       │               │       │        releasing them all. If a 'timeout' is provided, it is used as the                                                                                                                                                                 
   685 │       │       │       │        │       │               │       │        default for all subsequent 'wait()' calls.                                                                                                                                                                                        
   686 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   687 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   688 │       │       │       │        │       │               │       │        self._cond = Condition(Lock())                                                                                                                                                                                                    
   689 │       │       │       │        │       │               │       │        self._action = action                                                                                                                                                                                                             
   690 │       │       │       │        │       │               │       │        self._timeout = timeout                                                                                                                                                                                                           
   691 │       │       │       │        │       │               │       │        self._parties = parties                                                                                                                                                                                                           
   692 │       │       │       │        │       │               │       │        self._state = 0  # 0 filling, 1 draining, -1 resetting, -2 broken                                                                                                                                                                 
   693 │       │       │       │        │       │               │       │        self._count = 0                                                                                                                                                                                                                   
   694 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   695 │       │       │       │        │       │               │       │    def __repr__(self):                                                                                                                                                                                                                   
   696 │       │       │       │        │       │               │       │        cls = self.__class__                                                                                                                                                                                                              
   697 │       │       │       │        │       │               │       │        if self.broken:                                                                                                                                                                                                                   
   698 │       │       │       │        │       │               │       │            return f"<{cls.__module__}.{cls.__qualname__} at {id(self):#x}: broken>"                                                                                                                                                      
   699 │       │       │       │        │       │               │       │        return (f"<{cls.__module__}.{cls.__qualname__} at {id(self):#x}:"                                                                                                                                                                 
   700 │       │       │       │        │       │               │       │                f" waiters={self.n_waiting}/{self.parties}>")                                                                                                                                                                             
   701 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   702 │       │       │       │        │       │               │       │    def wait(self, timeout=None):                                                                                                                                                                                                         
   703 │       │       │       │        │       │               │       │        """Wait for the barrier.                                                                                                                                                                                                          
   704 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   705 │       │       │       │        │       │               │       │        When the specified number of threads have started waiting, they are all                                                                                                                                                           
   706 │       │       │       │        │       │               │       │        simultaneously awoken. If an 'action' was provided for the barrier, one                                                                                                                                                           
   707 │       │       │       │        │       │               │       │        of the threads will have executed that callback prior to returning.                                                                                                                                                               
   708 │       │       │       │        │       │               │       │        Returns an individual index number from 0 to 'parties-1'.                                                                                                                                                                         
   709 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   710 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   711 │       │       │       │        │       │               │       │        if timeout is None:                                                                                                                                                                                                               
   712 │       │       │       │        │       │               │       │            timeout = self._timeout                                                                                                                                                                                                       
   713 │       │       │       │        │       │               │       │        with self._cond:                                                                                                                                                                                                                  
   714 │       │       │       │        │       │               │       │            self._enter() # Block while the barrier drains.                                                                                                                                                                               
   715 │       │       │       │        │       │               │       │            index = self._count                                                                                                                                                                                                           
   716 │       │       │       │        │       │               │       │            self._count += 1                                                                                                                                                                                                              
   717 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
   718 │       │       │       │        │       │               │       │                if index + 1 == self._parties:                                                                                                                                                                                            
   719 │       │       │       │        │       │               │       │                    # We release the barrier                                                                                                                                                                                              
   720 │       │       │       │        │       │               │       │                    self._release()                                                                                                                                                                                                       
   721 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
   722 │       │       │       │        │       │               │       │                    # We wait until someone releases us                                                                                                                                                                                   
   723 │       │       │       │        │       │               │       │                    self._wait(timeout)                                                                                                                                                                                                   
   724 │       │       │       │        │       │               │       │                return index                                                                                                                                                                                                              
   725 │       │       │       │        │       │               │       │            finally:                                                                                                                                                                                                                      
   726 │       │       │       │        │       │               │       │                self._count -= 1                                                                                                                                                                                                          
   727 │       │       │       │        │       │               │       │                # Wake up any threads waiting for barrier to drain.                                                                                                                                                                       
   728 │       │       │       │        │       │               │       │                self._exit()                                                                                                                                                                                                              
   729 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   730 │       │       │       │        │       │               │       │    # Block until the barrier is ready for us, or raise an exception                                                                                                                                                                      
   731 │       │       │       │        │       │               │       │    # if it is broken.                                                                                                                                                                                                                    
   732 │       │       │       │        │       │               │       │    def _enter(self):                                                                                                                                                                                                                     
   733 │       │       │       │        │       │               │       │        while self._state in (-1, 1):                                                                                                                                                                                                     
   734 │       │       │       │        │       │               │       │            # It is draining or resetting, wait until done                                                                                                                                                                                
   735 │       │       │       │        │       │               │       │            self._cond.wait()                                                                                                                                                                                                             
   736 │       │       │       │        │       │               │       │        #see if the barrier is in a broken state                                                                                                                                                                                          
   737 │       │       │       │        │       │               │       │        if self._state < 0:                                                                                                                                                                                                               
   738 │       │       │       │        │       │               │       │            raise BrokenBarrierError                                                                                                                                                                                                      
   739 │       │       │       │        │       │               │       │        assert self._state == 0                                                                                                                                                                                                           
   740 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   741 │       │       │       │        │       │               │       │    # Optionally run the 'action' and release the threads waiting                                                                                                                                                                         
   742 │       │       │       │        │       │               │       │    # in the barrier.                                                                                                                                                                                                                     
   743 │       │       │       │        │       │               │       │    def _release(self):                                                                                                                                                                                                                   
   744 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   745 │       │       │       │        │       │               │       │            if self._action:                                                                                                                                                                                                              
   746 │       │       │       │        │       │               │       │                self._action()                                                                                                                                                                                                            
   747 │       │       │       │        │       │               │       │            # enter draining state                                                                                                                                                                                                        
   748 │       │       │       │        │       │               │       │            self._state = 1                                                                                                                                                                                                               
   749 │       │       │       │        │       │               │       │            self._cond.notify_all()                                                                                                                                                                                                       
   750 │       │       │       │        │       │               │       │        except:                                                                                                                                                                                                                           
   751 │       │       │       │        │       │               │       │            #an exception during the _action handler.  Break and reraise                                                                                                                                                                  
   752 │       │       │       │        │       │               │       │            self._break()                                                                                                                                                                                                                 
   753 │       │       │       │        │       │               │       │            raise                                                                                                                                                                                                                         
   754 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   755 │       │       │       │        │       │               │       │    # Wait in the barrier until we are released.  Raise an exception                                                                                                                                                                      
   756 │       │       │       │        │       │               │       │    # if the barrier is reset or broken.                                                                                                                                                                                                  
   757 │       │       │       │        │       │               │       │    def _wait(self, timeout):                                                                                                                                                                                                             
   758 │       │       │       │        │       │               │       │        if not self._cond.wait_for(lambda : self._state != 0, timeout):                                                                                                                                                                   
   759 │       │       │       │        │       │               │       │            #timed out.  Break the barrier                                                                                                                                                                                                
   760 │       │       │       │        │       │               │       │            self._break()                                                                                                                                                                                                                 
   761 │       │       │       │        │       │               │       │            raise BrokenBarrierError                                                                                                                                                                                                      
   762 │       │       │       │        │       │               │       │        if self._state < 0:                                                                                                                                                                                                               
   763 │       │       │       │        │       │               │       │            raise BrokenBarrierError                                                                                                                                                                                                      
   764 │       │       │       │        │       │               │       │        assert self._state == 1                                                                                                                                                                                                           
   765 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   766 │       │       │       │        │       │               │       │    # If we are the last thread to exit the barrier, signal any threads                                                                                                                                                                   
   767 │       │       │       │        │       │               │       │    # waiting for the barrier to drain.                                                                                                                                                                                                   
   768 │       │       │       │        │       │               │       │    def _exit(self):                                                                                                                                                                                                                      
   769 │       │       │       │        │       │               │       │        if self._count == 0:                                                                                                                                                                                                              
   770 │       │       │       │        │       │               │       │            if self._state in (-1, 1):                                                                                                                                                                                                    
   771 │       │       │       │        │       │               │       │                #resetting or draining                                                                                                                                                                                                    
   772 │       │       │       │        │       │               │       │                self._state = 0                                                                                                                                                                                                           
   773 │       │       │       │        │       │               │       │                self._cond.notify_all()                                                                                                                                                                                                   
   774 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   775 │       │       │       │        │       │               │       │    def reset(self):                                                                                                                                                                                                                      
   776 │       │       │       │        │       │               │       │        """Reset the barrier to the initial state.                                                                                                                                                                                        
   777 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   778 │       │       │       │        │       │               │       │        Any threads currently waiting will get the BrokenBarrier exception                                                                                                                                                                
   779 │       │       │       │        │       │               │       │        raised.                                                                                                                                                                                                                           
   780 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   781 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   782 │       │       │       │        │       │               │       │        with self._cond:                                                                                                                                                                                                                  
   783 │       │       │       │        │       │               │       │            if self._count > 0:                                                                                                                                                                                                           
   784 │       │       │       │        │       │               │       │                if self._state == 0:                                                                                                                                                                                                      
   785 │       │       │       │        │       │               │       │                    #reset the barrier, waking up threads                                                                                                                                                                                 
   786 │       │       │       │        │       │               │       │                    self._state = -1                                                                                                                                                                                                      
   787 │       │       │       │        │       │               │       │                elif self._state == -2:                                                                                                                                                                                                   
   788 │       │       │       │        │       │               │       │                    #was broken, set it to reset state                                                                                                                                                                                    
   789 │       │       │       │        │       │               │       │                    #which clears when the last thread exits                                                                                                                                                                              
   790 │       │       │       │        │       │               │       │                    self._state = -1                                                                                                                                                                                                      
   791 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   792 │       │       │       │        │       │               │       │                self._state = 0                                                                                                                                                                                                           
   793 │       │       │       │        │       │               │       │            self._cond.notify_all()                                                                                                                                                                                                       
   794 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   795 │       │       │       │        │       │               │       │    def abort(self):                                                                                                                                                                                                                      
   796 │       │       │       │        │       │               │       │        """Place the barrier into a 'broken' state.                                                                                                                                                                                       
   797 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   798 │       │       │       │        │       │               │       │        Useful in case of error.  Any currently waiting threads and threads                                                                                                                                                               
   799 │       │       │       │        │       │               │       │        attempting to 'wait()' will have BrokenBarrierError raised.                                                                                                                                                                       
   800 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   801 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   802 │       │       │       │        │       │               │       │        with self._cond:                                                                                                                                                                                                                  
   803 │       │       │       │        │       │               │       │            self._break()                                                                                                                                                                                                                 
   804 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   805 │       │       │       │        │       │               │       │    def _break(self):                                                                                                                                                                                                                     
   806 │       │       │       │        │       │               │       │        # An internal error was detected.  The barrier is set to                                                                                                                                                                          
   807 │       │       │       │        │       │               │       │        # a broken state all parties awakened.                                                                                                                                                                                            
   808 │       │       │       │        │       │               │       │        self._state = -2                                                                                                                                                                                                                  
   809 │       │       │       │        │       │               │       │        self._cond.notify_all()                                                                                                                                                                                                           
   810 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   811 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   812 │       │       │       │        │       │               │       │    def parties(self):                                                                                                                                                                                                                    
   813 │       │       │       │        │       │               │       │        """Return the number of threads required to trip the barrier."""                                                                                                                                                                  
   814 │       │       │       │        │       │               │       │        return self._parties                                                                                                                                                                                                              
   815 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   816 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   817 │       │       │       │        │       │               │       │    def n_waiting(self):                                                                                                                                                                                                                  
   818 │       │       │       │        │       │               │       │        """Return the number of threads currently waiting at the barrier."""                                                                                                                                                              
   819 │       │       │       │        │       │               │       │        # We don't need synchronization here since this is an ephemeral result                                                                                                                                                            
   820 │       │       │       │        │       │               │       │        # anyway.  It returns the correct value in the steady state.                                                                                                                                                                      
   821 │       │       │       │        │       │               │       │        if self._state == 0:                                                                                                                                                                                                              
   822 │       │       │       │        │       │               │       │            return self._count                                                                                                                                                                                                            
   823 │       │       │       │        │       │               │       │        return 0                                                                                                                                                                                                                          
   824 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   825 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   826 │       │       │       │        │       │               │       │    def broken(self):                                                                                                                                                                                                                     
   827 │       │       │       │        │       │               │       │        """Return True if the barrier is in a broken state."""                                                                                                                                                                            
   828 │       │       │       │        │       │               │       │        return self._state == -2                                                                                                                                                                                                          
   829 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   830 │       │       │       │        │       │               │       │# exception raised by the Barrier class                                                                                                                                                                                                   
   831 │       │       │       │        │       │               │       │class BrokenBarrierError(RuntimeError):                                                                                                                                                                                                   
   832 │       │       │       │        │       │               │       │    pass                                                                                                                                                                                                                                  
   833 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   834 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   835 │       │       │       │        │       │               │       │# Helper to generate new thread names                                                                                                                                                                                                     
   836 │       │       │       │        │       │               │       │_counter = _count(1).__next__                                                                                                                                                                                                             
   837 │       │       │       │        │       │               │       │def _newname(name_template):                                                                                                                                                                                                              
   838 │       │       │       │        │       │               │       │    return name_template % _counter()                                                                                                                                                                                                     
   839 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   840 │       │       │       │        │       │               │       │# Active thread administration.                                                                                                                                                                                                           
   841 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
   842 │       │       │       │        │       │               │       │# bpo-44422: Use a reentrant lock to allow reentrant calls to functions like                                                                                                                                                              
   843 │       │       │       │        │       │               │       │# threading.enumerate().                                                                                                                                                                                                                  
   844 │       │       │       │        │       │               │       │_active_limbo_lock = RLock()                                                                                                                                                                                                              
   845 │       │       │       │        │       │               │       │_active = {}    # maps thread id to Thread object                                                                                                                                                                                         
   846 │       │       │       │        │       │               │       │_limbo = {}                                                                                                                                                                                                                               
   847 │       │       │       │        │       │               │       │_dangling = WeakSet()                                                                                                                                                                                                                     
   848 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   849 │       │       │       │        │       │               │       │# Set of Thread._tstate_lock locks of non-daemon threads used by _shutdown()                                                                                                                                                              
   850 │       │       │       │        │       │               │       │# to wait until all Python thread states get deleted:                                                                                                                                                                                     
   851 │       │       │       │        │       │               │       │# see Thread._set_tstate_lock().                                                                                                                                                                                                          
   852 │       │       │       │        │       │               │       │_shutdown_locks_lock = _allocate_lock()                                                                                                                                                                                                   
   853 │       │       │       │        │       │               │       │_shutdown_locks = set()                                                                                                                                                                                                                   
   854 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   855 │       │       │       │        │       │               │       │def _maintain_shutdown_locks():                                                                                                                                                                                                           
   856 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   857 │       │       │       │        │       │               │       │    Drop any shutdown locks that don't correspond to running threads anymore.                                                                                                                                                             
   858 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   859 │       │       │       │        │       │               │       │    Calling this from time to time avoids an ever-growing _shutdown_locks                                                                                                                                                                 
   860 │       │       │       │        │       │               │       │    set when Thread objects are not joined explicitly. See bpo-37788.                                                                                                                                                                     
   861 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   862 │       │       │       │        │       │               │       │    This must be called with _shutdown_locks_lock acquired.                                                                                                                                                                               
   863 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   864 │       │       │       │        │       │               │       │    # If a lock was released, the corresponding thread has exited                                                                                                                                                                         
   865 │       │       │       │        │       │               │       │    to_remove = [lock for lock in _shutdown_locks if not lock.locked()]                                                                                                                                                                   
   866 │       │       │       │        │       │               │       │    _shutdown_locks.difference_update(to_remove)                                                                                                                                                                                          
   867 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   868 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   869 │       │       │       │        │       │               │       │# Main class for threads                                                                                                                                                                                                                  
   870 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   871 │       │       │       │        │       │               │       │class Thread:                                                                                                                                                                                                                             
   872 │       │       │       │        │       │               │       │    """A class that represents a thread of control.                                                                                                                                                                                       
   873 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   874 │       │       │       │        │       │               │       │    This class can be safely subclassed in a limited fashion. There are two ways                                                                                                                                                          
   875 │       │       │       │        │       │               │       │    to specify the activity: by passing a callable object to the constructor, or                                                                                                                                                          
   876 │       │       │       │        │       │               │       │    by overriding the run() method in a subclass.                                                                                                                                                                                         
   877 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   878 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   879 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   880 │       │       │       │        │       │               │       │    _initialized = False                                                                                                                                                                                                                  
   881 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   882 │       │       │       │        │       │               │       │    def __init__(self, group=None, target=None, name=None,                                                                                                                                                                                
   883 │       │       │       │        │       │               │       │                 args=(), kwargs=None, *, daemon=None):                                                                                                                                                                                   
   884 │       │       │       │        │       │               │       │        """This constructor should always be called with keyword arguments. Arguments are:                                                                                                                                                
   885 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   886 │       │       │       │        │       │               │       │        *group* should be None; reserved for future extension when a ThreadGroup                                                                                                                                                          
   887 │       │       │       │        │       │               │       │        class is implemented.                                                                                                                                                                                                             
   888 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   889 │       │       │       │        │       │               │       │        *target* is the callable object to be invoked by the run()                                                                                                                                                                        
   890 │       │       │       │        │       │               │       │        method. Defaults to None, meaning nothing is called.                                                                                                                                                                              
   891 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   892 │       │       │       │        │       │               │       │        *name* is the thread name. By default, a unique name is constructed of                                                                                                                                                            
   893 │       │       │       │        │       │               │       │        the form "Thread-N" where N is a small decimal number.                                                                                                                                                                            
   894 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   895 │       │       │       │        │       │               │       │        *args* is a list or tuple of arguments for the target invocation. Defaults to ().                                                                                                                                                 
   896 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   897 │       │       │       │        │       │               │       │        *kwargs* is a dictionary of keyword arguments for the target                                                                                                                                                                      
   898 │       │       │       │        │       │               │       │        invocation. Defaults to {}.                                                                                                                                                                                                       
   899 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   900 │       │       │       │        │       │               │       │        If a subclass overrides the constructor, it must make sure to invoke                                                                                                                                                              
   901 │       │       │       │        │       │               │       │        the base class constructor (Thread.__init__()) before doing anything                                                                                                                                                              
   902 │       │       │       │        │       │               │       │        else to the thread.                                                                                                                                                                                                               
   903 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   904 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   905 │       │       │       │        │       │               │       │        assert group is None, "group argument must be None for now"                                                                                                                                                                       
   906 │       │       │       │        │       │               │       │        if kwargs is None:                                                                                                                                                                                                                
   907 │       │       │       │        │       │               │       │            kwargs = {}                                                                                                                                                                                                                   
   908 │       │       │       │        │       │               │       │        if name:                                                                                                                                                                                                                          
   909 │       │       │       │        │       │               │       │            name = str(name)                                                                                                                                                                                                              
   910 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   911 │       │       │       │        │       │               │       │            name = _newname("Thread-%d")                                                                                                                                                                                                  
   912 │       │       │       │        │       │               │       │            if target is not None:                                                                                                                                                                                                        
   913 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
   914 │       │       │       │        │       │               │       │                    target_name = target.__name__                                                                                                                                                                                         
   915 │       │       │       │        │       │               │       │                    name += f" ({target_name})"                                                                                                                                                                                           
   916 │       │       │       │        │       │               │       │                except AttributeError:                                                                                                                                                                                                    
   917 │       │       │       │        │       │               │       │                    pass                                                                                                                                                                                                                  
   918 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   919 │       │       │       │        │       │               │       │        self._target = target                                                                                                                                                                                                             
   920 │       │       │       │        │       │               │       │        self._name = name                                                                                                                                                                                                                 
   921 │       │       │       │        │       │               │       │        self._args = args                                                                                                                                                                                                                 
   922 │       │       │       │        │       │               │       │        self._kwargs = kwargs                                                                                                                                                                                                             
   923 │       │       │       │        │       │               │       │        if daemon is not None:                                                                                                                                                                                                            
   924 │       │       │       │        │       │               │       │            if daemon and not _daemon_threads_allowed():                                                                                                                                                                                  
   925 │       │       │       │        │       │               │       │                raise RuntimeError('daemon threads are disabled in this (sub)interpreter')                                                                                                                                                
   926 │       │       │       │        │       │               │       │            self._daemonic = daemon                                                                                                                                                                                                       
   927 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   928 │       │       │       │        │       │               │       │            self._daemonic = current_thread().daemon                                                                                                                                                                                      
   929 │       │       │       │        │       │               │       │        self._ident = None                                                                                                                                                                                                                
   930 │       │       │       │        │       │               │       │        if _HAVE_THREAD_NATIVE_ID:                                                                                                                                                                                                        
   931 │       │       │       │        │       │               │       │            self._native_id = None                                                                                                                                                                                                        
   932 │       │       │       │        │       │               │       │        self._tstate_lock = None                                                                                                                                                                                                          
   933 │       │       │       │        │       │               │       │        self._started = Event()                                                                                                                                                                                                           
   934 │       │       │       │        │       │               │       │        self._is_stopped = False                                                                                                                                                                                                          
   935 │       │       │       │        │       │               │       │        self._initialized = True                                                                                                                                                                                                          
   936 │       │       │       │        │       │               │       │        # Copy of sys.stderr used by self._invoke_excepthook()                                                                                                                                                                            
   937 │       │       │       │        │       │               │       │        self._stderr = _sys.stderr                                                                                                                                                                                                        
   938 │       │       │       │        │       │               │       │        self._invoke_excepthook = _make_invoke_excepthook()                                                                                                                                                                               
   939 │       │       │       │        │       │               │       │        # For debugging and _after_fork()                                                                                                                                                                                                 
   940 │       │       │       │        │       │               │       │        _dangling.add(self)                                                                                                                                                                                                               
   941 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   942 │       │       │       │        │       │               │       │    def _reset_internal_locks(self, is_alive):                                                                                                                                                                                            
   943 │       │       │       │        │       │               │       │        # private!  Called by _after_fork() to reset our internal locks as                                                                                                                                                                
   944 │       │       │       │        │       │               │       │        # they may be in an invalid state leading to a deadlock or crash.                                                                                                                                                                 
   945 │       │       │       │        │       │               │       │        self._started._at_fork_reinit()                                                                                                                                                                                                   
   946 │       │       │       │        │       │               │       │        if is_alive:                                                                                                                                                                                                                      
   947 │       │       │       │        │       │               │       │            # bpo-42350: If the fork happens when the thread is already stopped                                                                                                                                                           
   948 │       │       │       │        │       │               │       │            # (ex: after threading._shutdown() has been called), _tstate_lock                                                                                                                                                             
   949 │       │       │       │        │       │               │       │            # is None. Do nothing in this case.                                                                                                                                                                                           
   950 │       │       │       │        │       │               │       │            if self._tstate_lock is not None:                                                                                                                                                                                             
   951 │       │       │       │        │       │               │       │                self._tstate_lock._at_fork_reinit()                                                                                                                                                                                       
   952 │       │       │       │        │       │               │       │                self._tstate_lock.acquire()                                                                                                                                                                                               
   953 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   954 │       │       │       │        │       │               │       │            # The thread isn't alive after fork: it doesn't have a tstate                                                                                                                                                                 
   955 │       │       │       │        │       │               │       │            # anymore.                                                                                                                                                                                                                    
   956 │       │       │       │        │       │               │       │            self._is_stopped = True                                                                                                                                                                                                       
   957 │       │       │       │        │       │               │       │            self._tstate_lock = None                                                                                                                                                                                                      
   958 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   959 │       │       │       │        │       │               │       │    def __repr__(self):                                                                                                                                                                                                                   
   960 │       │       │       │        │       │               │       │        assert self._initialized, "Thread.__init__() was not called"                                                                                                                                                                      
   961 │       │       │       │        │       │               │       │        status = "initial"                                                                                                                                                                                                                
   962 │       │       │       │        │       │               │       │        if self._started.is_set():                                                                                                                                                                                                        
   963 │       │       │       │        │       │               │       │            status = "started"                                                                                                                                                                                                            
   964 │       │       │       │        │       │               │       │        self.is_alive() # easy way to get ._is_stopped set when appropriate                                                                                                                                                               
   965 │       │       │       │        │       │               │       │        if self._is_stopped:                                                                                                                                                                                                              
   966 │       │       │       │        │       │               │       │            status = "stopped"                                                                                                                                                                                                            
   967 │       │       │       │        │       │               │       │        if self._daemonic:                                                                                                                                                                                                                
   968 │       │       │       │        │       │               │       │            status += " daemon"                                                                                                                                                                                                           
   969 │       │       │       │        │       │               │       │        if self._ident is not None:                                                                                                                                                                                                       
   970 │       │       │       │        │       │               │       │            status += " %s" % self._ident                                                                                                                                                                                                 
   971 │       │       │       │        │       │               │       │        return "<%s(%s, %s)>" % (self.__class__.__name__, self._name, status)                                                                                                                                                             
   972 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   973 │       │       │       │        │       │               │       │    def start(self):                                                                                                                                                                                                                      
   974 │       │       │       │        │       │               │       │        """Start the thread's activity.                                                                                                                                                                                                   
   975 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   976 │       │       │       │        │       │               │       │        It must be called at most once per thread object. It arranges for the                                                                                                                                                             
   977 │       │       │       │        │       │               │       │        object's run() method to be invoked in a separate thread of control.                                                                                                                                                              
   978 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   979 │       │       │       │        │       │               │       │        This method will raise a RuntimeError if called more than once on the                                                                                                                                                             
   980 │       │       │       │        │       │               │       │        same thread object.                                                                                                                                                                                                               
   981 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   982 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   983 │       │       │       │        │       │               │       │        if not self._initialized:                                                                                                                                                                                                         
   984 │       │       │       │        │       │               │       │            raise RuntimeError("thread.__init__() not called")                                                                                                                                                                            
   985 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   986 │       │       │       │        │       │               │       │        if self._started.is_set():                                                                                                                                                                                                        
   987 │       │       │       │        │       │               │       │            raise RuntimeError("threads can only be started once")                                                                                                                                                                        
   988 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   989 │       │       │       │        │       │               │       │        with _active_limbo_lock:                                                                                                                                                                                                          
   990 │       │       │       │        │       │               │       │            _limbo[self] = self                                                                                                                                                                                                           
   991 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   992 │       │       │       │        │       │               │       │            _start_new_thread(self._bootstrap, ())                                                                                                                                                                                        
   993 │       │       │       │        │       │               │       │        except Exception:                                                                                                                                                                                                                 
   994 │       │       │       │        │       │               │       │            with _active_limbo_lock:                                                                                                                                                                                                      
   995 │       │       │       │        │       │               │       │                del _limbo[self]                                                                                                                                                                                                          
   996 │       │       │       │        │       │               │       │            raise                                                                                                                                                                                                                         
   997 │       │       │       │        │       │               │       │        self._started.wait()                                                                                                                                                                                                              
   998 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   999 │       │       │       │        │       │               │       │    def run(self):                                                                                                                                                                                                                        
  1000 │       │       │       │        │       │               │       │        """Method representing the thread's activity.                                                                                                                                                                                     
  1001 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1002 │       │       │       │        │       │               │       │        You may override this method in a subclass. The standard run() method                                                                                                                                                             
  1003 │       │       │       │        │       │               │       │        invokes the callable object passed to the object's constructor as the                                                                                                                                                             
  1004 │       │       │       │        │       │               │       │        target argument, if any, with sequential and keyword arguments taken                                                                                                                                                              
  1005 │       │       │       │        │       │               │       │        from the args and kwargs arguments, respectively.                                                                                                                                                                                 
  1006 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1007 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1008 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  1009 │       │       │       │        │       │               │       │            if self._target is not None:                                                                                                                                                                                                  
  1010 │       │   10% │  57%  │        │       │               │       │                self._target(*self._args, **self._kwargs)                                                                                                                                                                                 
  1011 │       │       │       │        │       │               │       │        finally:                                                                                                                                                                                                                          
  1012 │       │       │       │        │       │               │       │            # Avoid a refcycle if the thread is running a function with                                                                                                                                                                   
  1013 │       │       │       │        │       │               │       │            # an argument that has a member that points to the thread.                                                                                                                                                                    
  1014 │       │       │       │        │       │               │       │            del self._target, self._args, self._kwargs                                                                                                                                                                                    
  1015 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1016 │       │       │       │        │       │               │       │    def _bootstrap(self):                                                                                                                                                                                                                 
  1017 │       │       │       │        │       │               │       │        # Wrapper around the real bootstrap code that ignores                                                                                                                                                                             
  1018 │       │       │       │        │       │               │       │        # exceptions during interpreter cleanup.  Those typically                                                                                                                                                                         
  1019 │       │       │       │        │       │               │       │        # happen when a daemon thread wakes up at an unfortunate                                                                                                                                                                          
  1020 │       │       │       │        │       │               │       │        # moment, finds the world around it destroyed, and raises some                                                                                                                                                                    
  1021 │       │       │       │        │       │               │       │        # random exception *** while trying to report the exception in                                                                                                                                                                    
  1022 │       │       │       │        │       │               │       │        # _bootstrap_inner() below ***.  Those random exceptions                                                                                                                                                                          
  1023 │       │       │       │        │       │               │       │        # don't help anybody, and they confuse users, so we suppress                                                                                                                                                                      
  1024 │       │       │       │        │       │               │       │        # them.  We suppress them only when it appears that the world                                                                                                                                                                     
  1025 │       │       │       │        │       │               │       │        # indeed has already been destroyed, so that exceptions in                                                                                                                                                                        
  1026 │       │       │       │        │       │               │       │        # _bootstrap_inner() during normal business hours are properly                                                                                                                                                                    
  1027 │       │       │       │        │       │               │       │        # reported.  Also, we only suppress them for daemonic threads;                                                                                                                                                                    
  1028 │       │       │       │        │       │               │       │        # if a non-daemonic encounters this, something else is wrong.                                                                                                                                                                     
  1029 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  1030 │       │       │       │        │       │               │       │            self._bootstrap_inner()                                                                                                                                                                                                       
  1031 │       │       │       │        │       │               │       │        except:                                                                                                                                                                                                                           
  1032 │       │       │       │        │       │               │       │            if self._daemonic and _sys is None:                                                                                                                                                                                           
  1033 │       │       │       │        │       │               │       │                return                                                                                                                                                                                                                    
  1034 │       │       │       │        │       │               │       │            raise                                                                                                                                                                                                                         
  1035 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1036 │       │       │       │        │       │               │       │    def _set_ident(self):                                                                                                                                                                                                                 
  1037 │       │       │       │        │       │               │       │        self._ident = get_ident()                                                                                                                                                                                                         
  1038 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1039 │       │       │       │        │       │               │       │    if _HAVE_THREAD_NATIVE_ID:                                                                                                                                                                                                            
  1040 │       │       │       │        │       │               │       │        def _set_native_id(self):                                                                                                                                                                                                         
  1041 │       │       │       │        │       │               │       │            self._native_id = get_native_id()                                                                                                                                                                                             
  1042 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1043 │       │       │       │        │       │               │       │    def _set_tstate_lock(self):                                                                                                                                                                                                           
  1044 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1045 │       │       │       │        │       │               │       │        Set a lock object which will be released by the interpreter when                                                                                                                                                                  
  1046 │       │       │       │        │       │               │       │        the underlying thread state (see pystate.h) gets deleted.                                                                                                                                                                         
  1047 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1048 │       │       │       │        │       │               │       │        self._tstate_lock = _set_sentinel()                                                                                                                                                                                               
  1049 │       │       │       │        │       │               │       │        self._tstate_lock.acquire()                                                                                                                                                                                                       
  1050 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1051 │       │       │       │        │       │               │       │        if not self.daemon:                                                                                                                                                                                                               
  1052 │       │       │       │        │       │               │       │            with _shutdown_locks_lock:                                                                                                                                                                                                    
  1053 │       │       │       │        │       │               │       │                _maintain_shutdown_locks()                                                                                                                                                                                                
  1054 │       │       │       │        │       │               │       │                _shutdown_locks.add(self._tstate_lock)                                                                                                                                                                                    
  1055 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1056 │       │       │       │        │       │               │       │    def _bootstrap_inner(self):                                                                                                                                                                                                           
  1057 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  1058 │       │       │       │        │       │               │       │            self._set_ident()                                                                                                                                                                                                             
  1059 │       │       │       │        │       │               │       │            self._set_tstate_lock()                                                                                                                                                                                                       
  1060 │       │       │       │        │       │               │       │            if _HAVE_THREAD_NATIVE_ID:                                                                                                                                                                                                    
  1061 │       │       │       │        │       │               │       │                self._set_native_id()                                                                                                                                                                                                     
  1062 │       │       │       │        │       │               │       │            self._started.set()                                                                                                                                                                                                           
  1063 │       │       │       │        │       │               │       │            with _active_limbo_lock:                                                                                                                                                                                                      
  1064 │       │       │       │        │       │               │       │                _active[self._ident] = self                                                                                                                                                                                               
  1065 │       │       │       │        │       │               │       │                del _limbo[self]                                                                                                                                                                                                          
  1066 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1067 │       │       │       │        │       │               │       │            if _trace_hook:                                                                                                                                                                                                               
  1068 │       │       │       │        │       │               │       │                _sys.settrace(_trace_hook)                                                                                                                                                                                                
  1069 │       │       │       │        │       │               │       │            if _profile_hook:                                                                                                                                                                                                             
  1070 │       │       │       │        │       │               │       │                _sys.setprofile(_profile_hook)                                                                                                                                                                                            
  1071 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1072 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
  1073 │       │       │       │        │       │               │       │                self.run()                                                                                                                                                                                                                
  1074 │       │       │       │        │       │               │       │            except:                                                                                                                                                                                                                       
  1075 │       │       │       │        │       │               │       │                self._invoke_excepthook(self)                                                                                                                                                                                             
  1076 │       │       │       │        │       │               │       │        finally:                                                                                                                                                                                                                          
  1077 │       │       │       │        │       │               │       │            self._delete()                                                                                                                                                                                                                
  1078 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1079 │       │       │       │        │       │               │       │    def _stop(self):                                                                                                                                                                                                                      
  1080 │       │       │       │        │       │               │       │        # After calling ._stop(), .is_alive() returns False and .join() returns                                                                                                                                                           
  1081 │       │       │       │        │       │               │       │        # immediately.  ._tstate_lock must be released before calling ._stop().                                                                                                                                                           
  1082 │       │       │       │        │       │               │       │        #                                                                                                                                                                                                                                 
  1083 │       │       │       │        │       │               │       │        # Normal case:  C code at the end of the thread's life                                                                                                                                                                            
  1084 │       │       │       │        │       │               │       │        # (release_sentinel in _threadmodule.c) releases ._tstate_lock, and                                                                                                                                                               
  1085 │       │       │       │        │       │               │       │        # that's detected by our ._wait_for_tstate_lock(), called by .join()                                                                                                                                                              
  1086 │       │       │       │        │       │               │       │        # and .is_alive().  Any number of threads _may_ call ._stop()                                                                                                                                                                     
  1087 │       │       │       │        │       │               │       │        # simultaneously (for example, if multiple threads are blocked in                                                                                                                                                                 
  1088 │       │       │       │        │       │               │       │        # .join() calls), and they're not serialized.  That's harmless -                                                                                                                                                                  
  1089 │       │       │       │        │       │               │       │        # they'll just make redundant rebindings of ._is_stopped and                                                                                                                                                                      
  1090 │       │       │       │        │       │               │       │        # ._tstate_lock.  Obscure:  we rebind ._tstate_lock last so that the                                                                                                                                                              
  1091 │       │       │       │        │       │               │       │        # "assert self._is_stopped" in ._wait_for_tstate_lock() always works                                                                                                                                                              
  1092 │       │       │       │        │       │               │       │        # (the assert is executed only if ._tstate_lock is None).                                                                                                                                                                         
  1093 │       │       │       │        │       │               │       │        #                                                                                                                                                                                                                                 
  1094 │       │       │       │        │       │               │       │        # Special case:  _main_thread releases ._tstate_lock via this                                                                                                                                                                     
  1095 │       │       │       │        │       │               │       │        # module's _shutdown() function.                                                                                                                                                                                                  
  1096 │       │       │       │        │       │               │       │        lock = self._tstate_lock                                                                                                                                                                                                          
  1097 │       │       │       │        │       │               │       │        if lock is not None:                                                                                                                                                                                                              
  1098 │       │       │       │        │       │               │       │            assert not lock.locked()                                                                                                                                                                                                      
  1099 │       │       │       │        │       │               │       │        self._is_stopped = True                                                                                                                                                                                                           
  1100 │       │       │       │        │       │               │       │        self._tstate_lock = None                                                                                                                                                                                                          
  1101 │       │       │       │        │       │               │       │        if not self.daemon:                                                                                                                                                                                                               
  1102 │       │       │       │        │       │               │       │            with _shutdown_locks_lock:                                                                                                                                                                                                    
  1103 │       │       │       │        │       │               │       │                # Remove our lock and other released locks from _shutdown_locks                                                                                                                                                           
  1104 │       │       │       │        │       │               │       │                _maintain_shutdown_locks()                                                                                                                                                                                                
  1105 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1106 │       │       │       │        │       │               │       │    def _delete(self):                                                                                                                                                                                                                    
  1107 │       │       │       │        │       │               │       │        "Remove current thread from the dict of currently running threads."                                                                                                                                                               
  1108 │       │       │       │        │       │               │       │        with _active_limbo_lock:                                                                                                                                                                                                          
  1109 │       │       │       │        │       │               │       │            del _active[get_ident()]                                                                                                                                                                                                      
  1110 │       │       │       │        │       │               │       │            # There must not be any python code between the previous line                                                                                                                                                                 
  1111 │       │       │       │        │       │               │       │            # and after the lock is released.  Otherwise a tracing function                                                                                                                                                               
  1112 │       │       │       │        │       │               │       │            # could try to acquire the lock again in the same thread, (in                                                                                                                                                                 
  1113 │       │       │       │        │       │               │       │            # current_thread()), and would block.                                                                                                                                                                                         
  1114 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1115 │       │       │       │        │       │               │       │    def join(self, timeout=None):                                                                                                                                                                                                         
  1116 │       │       │       │        │       │               │       │        """Wait until the thread terminates.                                                                                                                                                                                              
  1117 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1118 │       │       │       │        │       │               │       │        This blocks the calling thread until the thread whose join() method is                                                                                                                                                            
  1119 │       │       │       │        │       │               │       │        called terminates -- either normally or through an unhandled exception                                                                                                                                                            
  1120 │       │       │       │        │       │               │       │        or until the optional timeout occurs.                                                                                                                                                                                             
  1121 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1122 │       │       │       │        │       │               │       │        When the timeout argument is present and not None, it should be a                                                                                                                                                                 
  1123 │       │       │       │        │       │               │       │        floating point number specifying a timeout for the operation in seconds                                                                                                                                                           
  1124 │       │       │       │        │       │               │       │        (or fractions thereof). As join() always returns None, you must call                                                                                                                                                              
  1125 │       │       │       │        │       │               │       │        is_alive() after join() to decide whether a timeout happened -- if the                                                                                                                                                            
  1126 │       │       │       │        │       │               │       │        thread is still alive, the join() call timed out.                                                                                                                                                                                 
  1127 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1128 │       │       │       │        │       │               │       │        When the timeout argument is not present or None, the operation will                                                                                                                                                              
  1129 │       │       │       │        │       │               │       │        block until the thread terminates.                                                                                                                                                                                                
  1130 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1131 │       │       │       │        │       │               │       │        A thread can be join()ed many times.                                                                                                                                                                                              
  1132 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1133 │       │       │       │        │       │               │       │        join() raises a RuntimeError if an attempt is made to join the current                                                                                                                                                            
  1134 │       │       │       │        │       │               │       │        thread as that would cause a deadlock. It is also an error to join() a                                                                                                                                                            
  1135 │       │       │       │        │       │               │       │        thread before it has been started and attempts to do so raises the same                                                                                                                                                           
  1136 │       │       │       │        │       │               │       │        exception.                                                                                                                                                                                                                        
  1137 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1138 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1139 │       │       │       │        │       │               │       │        if not self._initialized:                                                                                                                                                                                                         
  1140 │       │       │       │        │       │               │       │            raise RuntimeError("Thread.__init__() not called")                                                                                                                                                                            
  1141 │       │       │       │        │       │               │       │        if not self._started.is_set():                                                                                                                                                                                                    
  1142 │       │       │       │        │       │               │       │            raise RuntimeError("cannot join thread before it is started")                                                                                                                                                                 
  1143 │       │       │       │        │       │               │       │        if self is current_thread():                                                                                                                                                                                                      
  1144 │       │       │       │        │       │               │       │            raise RuntimeError("cannot join current thread")                                                                                                                                                                              
  1145 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1146 │       │       │       │        │       │               │       │        if timeout is None:                                                                                                                                                                                                               
  1147 │       │       │       │        │       │               │       │            self._wait_for_tstate_lock()                                                                                                                                                                                                  
  1148 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1149 │       │       │       │        │       │               │       │            # the behavior of a negative timeout isn't documented, but                                                                                                                                                                    
  1150 │       │       │       │        │       │               │       │            # historically .join(timeout=x) for x<0 has acted as if timeout=0                                                                                                                                                             
  1151 │       │       │       │        │       │               │       │            self._wait_for_tstate_lock(timeout=max(timeout, 0))                                                                                                                                                                           
  1152 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1153 │       │       │       │        │       │               │       │    def _wait_for_tstate_lock(self, block=True, timeout=-1):                                                                                                                                                                              
  1154 │       │       │       │        │       │               │       │        # Issue #18808: wait for the thread state to be gone.                                                                                                                                                                             
  1155 │       │       │       │        │       │               │       │        # At the end of the thread's life, after all knowledge of the thread                                                                                                                                                              
  1156 │       │       │       │        │       │               │       │        # is removed from C data structures, C code releases our _tstate_lock.                                                                                                                                                            
  1157 │       │       │       │        │       │               │       │        # This method passes its arguments to _tstate_lock.acquire().                                                                                                                                                                     
  1158 │       │       │       │        │       │               │       │        # If the lock is acquired, the C code is done, and self._stop() is                                                                                                                                                                
  1159 │       │       │       │        │       │               │       │        # called.  That sets ._is_stopped to True, and ._tstate_lock to None.                                                                                                                                                             
  1160 │       │       │       │        │       │               │       │        lock = self._tstate_lock                                                                                                                                                                                                          
  1161 │       │       │       │        │       │               │       │        if lock is None:                                                                                                                                                                                                                  
  1162 │       │       │       │        │       │               │       │            # already determined that the C code is done                                                                                                                                                                                  
  1163 │       │       │       │        │       │               │       │            assert self._is_stopped                                                                                                                                                                                                       
  1164 │       │       │       │        │       │               │       │            return                                                                                                                                                                                                                        
  1165 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1166 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  1167 │       │       │       │        │       │               │       │            if lock.acquire(block, timeout):                                                                                                                                                                                              
  1168 │       │       │       │        │       │               │       │                lock.release()                                                                                                                                                                                                            
  1169 │       │       │       │        │       │               │       │                self._stop()                                                                                                                                                                                                              
  1170 │       │       │       │        │       │               │       │        except:                                                                                                                                                                                                                           
  1171 │       │       │       │        │       │               │       │            if lock.locked():                                                                                                                                                                                                             
  1172 │       │       │       │        │       │               │       │                # bpo-45274: lock.acquire() acquired the lock, but the function                                                                                                                                                           
  1173 │       │       │       │        │       │               │       │                # was interrupted with an exception before reaching the                                                                                                                                                                   
  1174 │       │       │       │        │       │               │       │                # lock.release(). It can happen if a signal handler raises an                                                                                                                                                             
  1175 │       │       │       │        │       │               │       │                # exception, like CTRL+C which raises KeyboardInterrupt.                                                                                                                                                                  
  1176 │       │       │       │        │       │               │       │                lock.release()                                                                                                                                                                                                            
  1177 │       │       │       │        │       │               │       │                self._stop()                                                                                                                                                                                                              
  1178 │       │       │       │        │       │               │       │            raise                                                                                                                                                                                                                         
  1179 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1180 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
  1181 │       │       │       │        │       │               │       │    def name(self):                                                                                                                                                                                                                       
  1182 │       │       │       │        │       │               │       │        """A string used for identification purposes only.                                                                                                                                                                                
  1183 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1184 │       │       │       │        │       │               │       │        It has no semantics. Multiple threads may be given the same name. The                                                                                                                                                             
  1185 │       │       │       │        │       │               │       │        initial name is set by the constructor.                                                                                                                                                                                           
  1186 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1187 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1188 │       │       │       │        │       │               │       │        assert self._initialized, "Thread.__init__() not called"                                                                                                                                                                          
  1189 │       │       │       │        │       │               │       │        return self._name                                                                                                                                                                                                                 
  1190 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1191 │       │       │       │        │       │               │       │    @name.setter                                                                                                                                                                                                                          
  1192 │       │       │       │        │       │               │       │    def name(self, name):                                                                                                                                                                                                                 
  1193 │       │       │       │        │       │               │       │        assert self._initialized, "Thread.__init__() not called"                                                                                                                                                                          
  1194 │       │       │       │        │       │               │       │        self._name = str(name)                                                                                                                                                                                                            
  1195 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1196 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
  1197 │       │       │       │        │       │               │       │    def ident(self):                                                                                                                                                                                                                      
  1198 │       │       │       │        │       │               │       │        """Thread identifier of this thread or None if it has not been started.                                                                                                                                                           
  1199 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1200 │       │       │       │        │       │               │       │        This is a nonzero integer. See the get_ident() function. Thread                                                                                                                                                                   
  1201 │       │       │       │        │       │               │       │        identifiers may be recycled when a thread exits and another thread is                                                                                                                                                             
  1202 │       │       │       │        │       │               │       │        created. The identifier is available even after the thread has exited.                                                                                                                                                            
  1203 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1204 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1205 │       │       │       │        │       │               │       │        assert self._initialized, "Thread.__init__() not called"                                                                                                                                                                          
  1206 │       │       │       │        │       │               │       │        return self._ident                                                                                                                                                                                                                
  1207 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1208 │       │       │       │        │       │               │       │    if _HAVE_THREAD_NATIVE_ID:                                                                                                                                                                                                            
  1209 │       │       │       │        │       │               │       │        @property                                                                                                                                                                                                                         
  1210 │       │       │       │        │       │               │       │        def native_id(self):                                                                                                                                                                                                              
  1211 │       │       │       │        │       │               │       │            """Native integral thread ID of this thread, or None if it has not been started.                                                                                                                                              
  1212 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1213 │       │       │       │        │       │               │       │            This is a non-negative integer. See the get_native_id() function.                                                                                                                                                             
  1214 │       │       │       │        │       │               │       │            This represents the Thread ID as reported by the kernel.                                                                                                                                                                      
  1215 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1216 │       │       │       │        │       │               │       │            """                                                                                                                                                                                                                           
  1217 │       │       │       │        │       │               │       │            assert self._initialized, "Thread.__init__() not called"                                                                                                                                                                      
  1218 │       │       │       │        │       │               │       │            return self._native_id                                                                                                                                                                                                        
  1219 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1220 │       │       │       │        │       │               │       │    def is_alive(self):                                                                                                                                                                                                                   
  1221 │       │       │       │        │       │               │       │        """Return whether the thread is alive.                                                                                                                                                                                            
  1222 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1223 │       │       │       │        │       │               │       │        This method returns True just before the run() method starts until just                                                                                                                                                           
  1224 │       │       │       │        │       │               │       │        after the run() method terminates. See also the module function                                                                                                                                                                   
  1225 │       │       │       │        │       │               │       │        enumerate().                                                                                                                                                                                                                      
  1226 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1227 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1228 │       │       │       │        │       │               │       │        assert self._initialized, "Thread.__init__() not called"                                                                                                                                                                          
  1229 │       │       │       │        │       │               │       │        if self._is_stopped or not self._started.is_set():                                                                                                                                                                                
  1230 │       │       │       │        │       │               │       │            return False                                                                                                                                                                                                                  
  1231 │       │       │       │        │       │               │       │        self._wait_for_tstate_lock(False)                                                                                                                                                                                                 
  1232 │       │       │       │        │       │               │       │        return not self._is_stopped                                                                                                                                                                                                       
  1233 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1234 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
  1235 │       │       │       │        │       │               │       │    def daemon(self):                                                                                                                                                                                                                     
  1236 │       │       │       │        │       │               │       │        """A boolean value indicating whether this thread is a daemon thread.                                                                                                                                                             
  1237 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1238 │       │       │       │        │       │               │       │        This must be set before start() is called, otherwise RuntimeError is                                                                                                                                                              
  1239 │       │       │       │        │       │               │       │        raised. Its initial value is inherited from the creating thread; the                                                                                                                                                              
  1240 │       │       │       │        │       │               │       │        main thread is not a daemon thread and therefore all threads created in                                                                                                                                                           
  1241 │       │       │       │        │       │               │       │        the main thread default to daemon = False.                                                                                                                                                                                        
  1242 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1243 │       │       │       │        │       │               │       │        The entire Python program exits when only daemon threads are left.                                                                                                                                                                
  1244 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1245 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1246 │       │       │       │        │       │               │       │        assert self._initialized, "Thread.__init__() not called"                                                                                                                                                                          
  1247 │       │       │       │        │       │               │       │        return self._daemonic                                                                                                                                                                                                             
  1248 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1249 │       │       │       │        │       │               │       │    @daemon.setter                                                                                                                                                                                                                        
  1250 │       │       │       │        │       │               │       │    def daemon(self, daemonic):                                                                                                                                                                                                           
  1251 │       │       │       │        │       │               │       │        if not self._initialized:                                                                                                                                                                                                         
  1252 │       │       │       │        │       │               │       │            raise RuntimeError("Thread.__init__() not called")                                                                                                                                                                            
  1253 │       │       │       │        │       │               │       │        if daemonic and not _daemon_threads_allowed():                                                                                                                                                                                    
  1254 │       │       │       │        │       │               │       │            raise RuntimeError('daemon threads are disabled in this interpreter')                                                                                                                                                         
  1255 │       │       │       │        │       │               │       │        if self._started.is_set():                                                                                                                                                                                                        
  1256 │       │       │       │        │       │               │       │            raise RuntimeError("cannot set daemon status of active thread")                                                                                                                                                               
  1257 │       │       │       │        │       │               │       │        self._daemonic = daemonic                                                                                                                                                                                                         
  1258 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1259 │       │       │       │        │       │               │       │    def isDaemon(self):                                                                                                                                                                                                                   
  1260 │       │       │       │        │       │               │       │        """Return whether this thread is a daemon.                                                                                                                                                                                        
  1261 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1262 │       │       │       │        │       │               │       │        This method is deprecated, use the daemon attribute instead.                                                                                                                                                                      
  1263 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1264 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1265 │       │       │       │        │       │               │       │        import warnings                                                                                                                                                                                                                   
  1266 │       │       │       │        │       │               │       │        warnings.warn('isDaemon() is deprecated, get the daemon attribute instead',                                                                                                                                                       
  1267 │       │       │       │        │       │               │       │                      DeprecationWarning, stacklevel=2)                                                                                                                                                                                   
  1268 │       │       │       │        │       │               │       │        return self.daemon                                                                                                                                                                                                                
  1269 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1270 │       │       │       │        │       │               │       │    def setDaemon(self, daemonic):                                                                                                                                                                                                        
  1271 │       │       │       │        │       │               │       │        """Set whether this thread is a daemon.                                                                                                                                                                                           
  1272 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1273 │       │       │       │        │       │               │       │        This method is deprecated, use the .daemon property instead.                                                                                                                                                                      
  1274 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1275 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1276 │       │       │       │        │       │               │       │        import warnings                                                                                                                                                                                                                   
  1277 │       │       │       │        │       │               │       │        warnings.warn('setDaemon() is deprecated, set the daemon attribute instead',                                                                                                                                                      
  1278 │       │       │       │        │       │               │       │                      DeprecationWarning, stacklevel=2)                                                                                                                                                                                   
  1279 │       │       │       │        │       │               │       │        self.daemon = daemonic                                                                                                                                                                                                            
  1280 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1281 │       │       │       │        │       │               │       │    def getName(self):                                                                                                                                                                                                                    
  1282 │       │       │       │        │       │               │       │        """Return a string used for identification purposes only.                                                                                                                                                                         
  1283 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1284 │       │       │       │        │       │               │       │        This method is deprecated, use the name attribute instead.                                                                                                                                                                        
  1285 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1286 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1287 │       │       │       │        │       │               │       │        import warnings                                                                                                                                                                                                                   
  1288 │       │       │       │        │       │               │       │        warnings.warn('getName() is deprecated, get the name attribute instead',                                                                                                                                                          
  1289 │       │       │       │        │       │               │       │                      DeprecationWarning, stacklevel=2)                                                                                                                                                                                   
  1290 │       │       │       │        │       │               │       │        return self.name                                                                                                                                                                                                                  
  1291 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1292 │       │       │       │        │       │               │       │    def setName(self, name):                                                                                                                                                                                                              
  1293 │       │       │       │        │       │               │       │        """Set the name string for this thread.                                                                                                                                                                                           
  1294 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1295 │       │       │       │        │       │               │       │        This method is deprecated, use the name attribute instead.                                                                                                                                                                        
  1296 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1297 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1298 │       │       │       │        │       │               │       │        import warnings                                                                                                                                                                                                                   
  1299 │       │       │       │        │       │               │       │        warnings.warn('setName() is deprecated, set the name attribute instead',                                                                                                                                                          
  1300 │       │       │       │        │       │               │       │                      DeprecationWarning, stacklevel=2)                                                                                                                                                                                   
  1301 │       │       │       │        │       │               │       │        self.name = name                                                                                                                                                                                                                  
  1302 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1303 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1304 │       │       │       │        │       │               │       │try:                                                                                                                                                                                                                                      
  1305 │       │       │       │        │       │               │       │    from _thread import (_excepthook as excepthook,                                                                                                                                                                                       
  1306 │       │       │       │        │       │               │       │                         _ExceptHookArgs as ExceptHookArgs)                                                                                                                                                                               
  1307 │       │       │       │        │       │               │       │except ImportError:                                                                                                                                                                                                                       
  1308 │       │       │       │        │       │               │       │    # Simple Python implementation if _thread._excepthook() is not available                                                                                                                                                              
  1309 │       │       │       │        │       │               │       │    from traceback import print_exception as _print_exception                                                                                                                                                                             
  1310 │       │       │       │        │       │               │       │    from collections import namedtuple                                                                                                                                                                                                    
  1311 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1312 │       │       │       │        │       │               │       │    _ExceptHookArgs = namedtuple(                                                                                                                                                                                                         
  1313 │       │       │       │        │       │               │       │        'ExceptHookArgs',                                                                                                                                                                                                                 
  1314 │       │       │       │        │       │               │       │        'exc_type exc_value exc_traceback thread')                                                                                                                                                                                        
  1315 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1316 │       │       │       │        │       │               │       │    def ExceptHookArgs(args):                                                                                                                                                                                                             
  1317 │       │       │       │        │       │               │       │        return _ExceptHookArgs(*args)                                                                                                                                                                                                     
  1318 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1319 │       │       │       │        │       │               │       │    def excepthook(args, /):                                                                                                                                                                                                              
  1320 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1321 │       │       │       │        │       │               │       │        Handle uncaught Thread.run() exception.                                                                                                                                                                                           
  1322 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1323 │       │       │       │        │       │               │       │        if args.exc_type == SystemExit:                                                                                                                                                                                                   
  1324 │       │       │       │        │       │               │       │            # silently ignore SystemExit                                                                                                                                                                                                  
  1325 │       │       │       │        │       │               │       │            return                                                                                                                                                                                                                        
  1326 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1327 │       │       │       │        │       │               │       │        if _sys is not None and _sys.stderr is not None:                                                                                                                                                                                  
  1328 │       │       │       │        │       │               │       │            stderr = _sys.stderr                                                                                                                                                                                                          
  1329 │       │       │       │        │       │               │       │        elif args.thread is not None:                                                                                                                                                                                                     
  1330 │       │       │       │        │       │               │       │            stderr = args.thread._stderr                                                                                                                                                                                                  
  1331 │       │       │       │        │       │               │       │            if stderr is None:                                                                                                                                                                                                            
  1332 │       │       │       │        │       │               │       │                # do nothing if sys.stderr is None and sys.stderr was None                                                                                                                                                                
  1333 │       │       │       │        │       │               │       │                # when the thread was created                                                                                                                                                                                             
  1334 │       │       │       │        │       │               │       │                return                                                                                                                                                                                                                    
  1335 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1336 │       │       │       │        │       │               │       │            # do nothing if sys.stderr is None and args.thread is None                                                                                                                                                                    
  1337 │       │       │       │        │       │               │       │            return                                                                                                                                                                                                                        
  1338 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1339 │       │       │       │        │       │               │       │        if args.thread is not None:                                                                                                                                                                                                       
  1340 │       │       │       │        │       │               │       │            name = args.thread.name                                                                                                                                                                                                       
  1341 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1342 │       │       │       │        │       │               │       │            name = get_ident()                                                                                                                                                                                                            
  1343 │       │       │       │        │       │               │       │        print(f"Exception in thread {name}:",                                                                                                                                                                                             
  1344 │       │       │       │        │       │               │       │              file=stderr, flush=True)                                                                                                                                                                                                    
  1345 │       │       │       │        │       │               │       │        _print_exception(args.exc_type, args.exc_value, args.exc_traceback,                                                                                                                                                               
  1346 │       │       │       │        │       │               │       │                         file=stderr)                                                                                                                                                                                                     
  1347 │       │       │       │        │       │               │       │        stderr.flush()                                                                                                                                                                                                                    
  1348 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1349 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1350 │       │       │       │        │       │               │       │# Original value of threading.excepthook                                                                                                                                                                                                  
  1351 │       │       │       │        │       │               │       │__excepthook__ = excepthook                                                                                                                                                                                                               
  1352 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1353 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1354 │       │       │       │        │       │               │       │def _make_invoke_excepthook():                                                                                                                                                                                                            
  1355 │       │       │       │        │       │               │       │    # Create a local namespace to ensure that variables remain alive                                                                                                                                                                      
  1356 │       │       │       │        │       │               │       │    # when _invoke_excepthook() is called, even if it is called late during                                                                                                                                                               
  1357 │       │       │       │        │       │               │       │    # Python shutdown. It is mostly needed for daemon threads.                                                                                                                                                                            
  1358 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1359 │       │       │       │        │       │               │       │    old_excepthook = excepthook                                                                                                                                                                                                           
  1360 │       │       │       │        │       │               │       │    old_sys_excepthook = _sys.excepthook                                                                                                                                                                                                  
  1361 │       │       │       │        │       │               │       │    if old_excepthook is None:                                                                                                                                                                                                            
  1362 │       │       │       │        │       │               │       │        raise RuntimeError("threading.excepthook is None")                                                                                                                                                                                
  1363 │       │       │       │        │       │               │       │    if old_sys_excepthook is None:                                                                                                                                                                                                        
  1364 │       │       │       │        │       │               │       │        raise RuntimeError("sys.excepthook is None")                                                                                                                                                                                      
  1365 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1366 │       │       │       │        │       │               │       │    sys_exc_info = _sys.exc_info                                                                                                                                                                                                          
  1367 │       │       │       │        │       │               │       │    local_print = print                                                                                                                                                                                                                   
  1368 │       │       │       │        │       │               │       │    local_sys = _sys                                                                                                                                                                                                                      
  1369 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1370 │       │       │       │        │       │               │       │    def invoke_excepthook(thread):                                                                                                                                                                                                        
  1371 │       │       │       │        │       │               │       │        global excepthook                                                                                                                                                                                                                 
  1372 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  1373 │       │       │       │        │       │               │       │            hook = excepthook                                                                                                                                                                                                             
  1374 │       │       │       │        │       │               │       │            if hook is None:                                                                                                                                                                                                              
  1375 │       │       │       │        │       │               │       │                hook = old_excepthook                                                                                                                                                                                                     
  1376 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1377 │       │       │       │        │       │               │       │            args = ExceptHookArgs([*sys_exc_info(), thread])                                                                                                                                                                              
  1378 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1379 │       │       │       │        │       │               │       │            hook(args)                                                                                                                                                                                                                    
  1380 │       │       │       │        │       │               │       │        except Exception as exc:                                                                                                                                                                                                          
  1381 │       │       │       │        │       │               │       │            exc.__suppress_context__ = True                                                                                                                                                                                               
  1382 │       │       │       │        │       │               │       │            del exc                                                                                                                                                                                                                       
  1383 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1384 │       │       │       │        │       │               │       │            if local_sys is not None and local_sys.stderr is not None:                                                                                                                                                                    
  1385 │       │       │       │        │       │               │       │                stderr = local_sys.stderr                                                                                                                                                                                                 
  1386 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  1387 │       │       │       │        │       │               │       │                stderr = thread._stderr                                                                                                                                                                                                   
  1388 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1389 │       │       │       │        │       │               │       │            local_print("Exception in threading.excepthook:",                                                                                                                                                                             
  1390 │       │       │       │        │       │               │       │                        file=stderr, flush=True)                                                                                                                                                                                          
  1391 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1392 │       │       │       │        │       │               │       │            if local_sys is not None and local_sys.excepthook is not None:                                                                                                                                                                
  1393 │       │       │       │        │       │               │       │                sys_excepthook = local_sys.excepthook                                                                                                                                                                                     
  1394 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  1395 │       │       │       │        │       │               │       │                sys_excepthook = old_sys_excepthook                                                                                                                                                                                       
  1396 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1397 │       │       │       │        │       │               │       │            sys_excepthook(*sys_exc_info())                                                                                                                                                                                               
  1398 │       │       │       │        │       │               │       │        finally:                                                                                                                                                                                                                          
  1399 │       │       │       │        │       │               │       │            # Break reference cycle (exception stored in a variable)                                                                                                                                                                      
  1400 │       │       │       │        │       │               │       │            args = None                                                                                                                                                                                                                   
  1401 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1402 │       │       │       │        │       │               │       │    return invoke_excepthook                                                                                                                                                                                                              
  1403 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1404 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1405 │       │       │       │        │       │               │       │# The timer class was contributed by Itamar Shtull-Trauring                                                                                                                                                                               
  1406 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1407 │       │       │       │        │       │               │       │class Timer(Thread):                                                                                                                                                                                                                      
  1408 │       │       │       │        │       │               │       │    """Call a function after a specified number of seconds:                                                                                                                                                                               
  1409 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1410 │       │       │       │        │       │               │       │            t = Timer(30.0, f, args=None, kwargs=None)                                                                                                                                                                                    
  1411 │       │       │       │        │       │               │       │            t.start()                                                                                                                                                                                                                     
  1412 │       │       │       │        │       │               │       │            t.cancel()     # stop the timer's action if it's still waiting                                                                                                                                                                
  1413 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1414 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1415 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1416 │       │       │       │        │       │               │       │    def __init__(self, interval, function, args=None, kwargs=None):                                                                                                                                                                       
  1417 │       │       │       │        │       │               │       │        Thread.__init__(self)                                                                                                                                                                                                             
  1418 │       │       │       │        │       │               │       │        self.interval = interval                                                                                                                                                                                                          
  1419 │       │       │       │        │       │               │       │        self.function = function                                                                                                                                                                                                          
  1420 │       │       │       │        │       │               │       │        self.args = args if args is not None else []                                                                                                                                                                                      
  1421 │       │       │       │        │       │               │       │        self.kwargs = kwargs if kwargs is not None else {}                                                                                                                                                                                
  1422 │       │       │       │        │       │               │       │        self.finished = Event()                                                                                                                                                                                                           
  1423 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1424 │       │       │       │        │       │               │       │    def cancel(self):                                                                                                                                                                                                                     
  1425 │       │       │       │        │       │               │       │        """Stop the timer if it hasn't finished yet."""                                                                                                                                                                                   
  1426 │       │       │       │        │       │               │       │        self.finished.set()                                                                                                                                                                                                               
  1427 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1428 │       │       │       │        │       │               │       │    def run(self):                                                                                                                                                                                                                        
  1429 │       │       │       │        │       │               │       │        self.finished.wait(self.interval)                                                                                                                                                                                                 
  1430 │       │       │       │        │       │               │       │        if not self.finished.is_set():                                                                                                                                                                                                    
  1431 │       │       │       │        │       │               │       │            self.function(*self.args, **self.kwargs)                                                                                                                                                                                      
  1432 │       │       │       │        │       │               │       │        self.finished.set()                                                                                                                                                                                                               
  1433 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1434 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1435 │       │       │       │        │       │               │       │# Special thread class to represent the main thread                                                                                                                                                                                       
  1436 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1437 │       │       │       │        │       │               │       │class _MainThread(Thread):                                                                                                                                                                                                                
  1438 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1439 │       │       │       │        │       │               │       │    def __init__(self):                                                                                                                                                                                                                   
  1440 │       │       │       │        │       │               │       │        Thread.__init__(self, name="MainThread", daemon=False)                                                                                                                                                                            
  1441 │       │       │       │        │       │               │       │        self._set_tstate_lock()                                                                                                                                                                                                           
  1442 │       │       │       │        │       │               │       │        self._started.set()                                                                                                                                                                                                               
  1443 │       │       │       │        │       │               │       │        self._set_ident()                                                                                                                                                                                                                 
  1444 │       │       │       │        │       │               │       │        if _HAVE_THREAD_NATIVE_ID:                                                                                                                                                                                                        
  1445 │       │       │       │        │       │               │       │            self._set_native_id()                                                                                                                                                                                                         
  1446 │       │       │       │        │       │               │       │        with _active_limbo_lock:                                                                                                                                                                                                          
  1447 │       │       │       │        │       │               │       │            _active[self._ident] = self                                                                                                                                                                                                   
  1448 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1449 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1450 │       │       │       │        │       │               │       │# Dummy thread class to represent threads not started here.                                                                                                                                                                               
  1451 │       │       │       │        │       │               │       │# These aren't garbage collected when they die, nor can they be waited for.                                                                                                                                                               
  1452 │       │       │       │        │       │               │       │# If they invoke anything in threading.py that calls current_thread(), they                                                                                                                                                               
  1453 │       │       │       │        │       │               │       │# leave an entry in the _active dict forever after.                                                                                                                                                                                       
  1454 │       │       │       │        │       │               │       │# Their purpose is to return *something* from current_thread().                                                                                                                                                                           
  1455 │       │       │       │        │       │               │       │# They are marked as daemon threads so we won't wait for them                                                                                                                                                                             
  1456 │       │       │       │        │       │               │       │# when we exit (conform previous semantics).                                                                                                                                                                                              
  1457 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1458 │       │       │       │        │       │               │       │class _DummyThread(Thread):                                                                                                                                                                                                               
  1459 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1460 │       │       │       │        │       │               │       │    def __init__(self):                                                                                                                                                                                                                   
  1461 │       │       │       │        │       │               │       │        Thread.__init__(self, name=_newname("Dummy-%d"),                                                                                                                                                                                  
  1462 │       │       │       │        │       │               │       │                        daemon=_daemon_threads_allowed())                                                                                                                                                                                 
  1463 │       │       │       │        │       │               │       │        self._started.set()                                                                                                                                                                                                               
  1464 │       │       │       │        │       │               │       │        self._set_ident()                                                                                                                                                                                                                 
  1465 │       │       │       │        │       │               │       │        if _HAVE_THREAD_NATIVE_ID:                                                                                                                                                                                                        
  1466 │       │       │       │        │       │               │       │            self._set_native_id()                                                                                                                                                                                                         
  1467 │       │       │       │        │       │               │       │        with _active_limbo_lock:                                                                                                                                                                                                          
  1468 │       │       │       │        │       │               │       │            _active[self._ident] = self                                                                                                                                                                                                   
  1469 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1470 │       │       │       │        │       │               │       │    def _stop(self):                                                                                                                                                                                                                      
  1471 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
  1472 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1473 │       │       │       │        │       │               │       │    def is_alive(self):                                                                                                                                                                                                                   
  1474 │       │       │       │        │       │               │       │        assert not self._is_stopped and self._started.is_set()                                                                                                                                                                            
  1475 │       │       │       │        │       │               │       │        return True                                                                                                                                                                                                                       
  1476 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1477 │       │       │       │        │       │               │       │    def join(self, timeout=None):                                                                                                                                                                                                         
  1478 │       │       │       │        │       │               │       │        assert False, "cannot join a dummy thread"                                                                                                                                                                                        
  1479 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1480 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1481 │       │       │       │        │       │               │       │# Global API functions                                                                                                                                                                                                                    
  1482 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1483 │       │       │       │        │       │               │       │def current_thread():                                                                                                                                                                                                                     
  1484 │       │       │       │        │       │               │       │    """Return the current Thread object, corresponding to the caller's thread of control.                                                                                                                                                 
  1485 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1486 │       │       │       │        │       │               │       │    If the caller's thread of control was not created through the threading                                                                                                                                                               
  1487 │       │       │       │        │       │               │       │    module, a dummy thread object with limited functionality is returned.                                                                                                                                                                 
  1488 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1489 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1490 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
  1491 │       │       │       │        │       │               │       │        return _active[get_ident()]                                                                                                                                                                                                       
  1492 │       │       │       │        │       │               │       │    except KeyError:                                                                                                                                                                                                                      
  1493 │       │       │       │        │       │               │       │        return _DummyThread()                                                                                                                                                                                                             
  1494 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1495 │       │       │       │        │       │               │       │def currentThread():                                                                                                                                                                                                                      
  1496 │       │       │       │        │       │               │       │    """Return the current Thread object, corresponding to the caller's thread of control.                                                                                                                                                 
  1497 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1498 │       │       │       │        │       │               │       │    This function is deprecated, use current_thread() instead.                                                                                                                                                                            
  1499 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1500 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1501 │       │       │       │        │       │               │       │    import warnings                                                                                                                                                                                                                       
  1502 │       │       │       │        │       │               │       │    warnings.warn('currentThread() is deprecated, use current_thread() instead',                                                                                                                                                          
  1503 │       │       │       │        │       │               │       │                  DeprecationWarning, stacklevel=2)                                                                                                                                                                                       
  1504 │       │       │       │        │       │               │       │    return current_thread()                                                                                                                                                                                                               
  1505 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1506 │       │       │       │        │       │               │       │def active_count():                                                                                                                                                                                                                       
  1507 │       │       │       │        │       │               │       │    """Return the number of Thread objects currently alive.                                                                                                                                                                               
  1508 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1509 │       │       │       │        │       │               │       │    The returned count is equal to the length of the list returned by                                                                                                                                                                     
  1510 │       │       │       │        │       │               │       │    enumerate().                                                                                                                                                                                                                          
  1511 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1512 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1513 │       │       │       │        │       │               │       │    # NOTE: if the logic in here ever changes, update Modules/posixmodule.c                                                                                                                                                               
  1514 │       │       │       │        │       │               │       │    # warn_about_fork_with_threads() to match.                                                                                                                                                                                            
  1515 │       │       │       │        │       │               │       │    with _active_limbo_lock:                                                                                                                                                                                                              
  1516 │       │       │       │        │       │               │       │        return len(_active) + len(_limbo)                                                                                                                                                                                                 
  1517 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1518 │       │       │       │        │       │               │       │def activeCount():                                                                                                                                                                                                                        
  1519 │       │       │       │        │       │               │       │    """Return the number of Thread objects currently alive.                                                                                                                                                                               
  1520 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1521 │       │       │       │        │       │               │       │    This function is deprecated, use active_count() instead.                                                                                                                                                                              
  1522 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1523 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1524 │       │       │       │        │       │               │       │    import warnings                                                                                                                                                                                                                       
  1525 │       │       │       │        │       │               │       │    warnings.warn('activeCount() is deprecated, use active_count() instead',                                                                                                                                                              
  1526 │       │       │       │        │       │               │       │                  DeprecationWarning, stacklevel=2)                                                                                                                                                                                       
  1527 │       │       │       │        │       │               │       │    return active_count()                                                                                                                                                                                                                 
  1528 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1529 │       │       │       │        │       │               │       │def _enumerate():                                                                                                                                                                                                                         
  1530 │       │       │       │        │       │               │       │    # Same as enumerate(), but without the lock. Internal use only.                                                                                                                                                                       
  1531 │       │       │       │        │       │               │       │    return list(_active.values()) + list(_limbo.values())                                                                                                                                                                                 
  1532 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1533 │       │       │       │        │       │               │       │def enumerate():                                                                                                                                                                                                                          
  1534 │       │       │       │        │       │               │       │    """Return a list of all Thread objects currently alive.                                                                                                                                                                               
  1535 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1536 │       │       │       │        │       │               │       │    The list includes daemonic threads, dummy thread objects created by                                                                                                                                                                   
  1537 │       │       │       │        │       │               │       │    current_thread(), and the main thread. It excludes terminated threads and                                                                                                                                                             
  1538 │       │       │       │        │       │               │       │    threads that have not yet been started.                                                                                                                                                                                               
  1539 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1540 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1541 │       │       │       │        │       │               │       │    with _active_limbo_lock:                                                                                                                                                                                                              
  1542 │       │       │       │        │       │               │       │        return list(_active.values()) + list(_limbo.values())                                                                                                                                                                             
  1543 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1544 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1545 │       │       │       │        │       │               │       │_threading_atexits = []                                                                                                                                                                                                                   
  1546 │       │       │       │        │       │               │       │_SHUTTING_DOWN = False                                                                                                                                                                                                                    
  1547 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1548 │       │       │       │        │       │               │       │def _register_atexit(func, *arg, **kwargs):                                                                                                                                                                                               
  1549 │       │       │       │        │       │               │       │    """CPython internal: register *func* to be called before joining threads.                                                                                                                                                             
  1550 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1551 │       │       │       │        │       │               │       │    The registered *func* is called with its arguments just before all                                                                                                                                                                    
  1552 │       │       │       │        │       │               │       │    non-daemon threads are joined in `_shutdown()`. It provides a similar                                                                                                                                                                 
  1553 │       │       │       │        │       │               │       │    purpose to `atexit.register()`, but its functions are called prior to                                                                                                                                                                 
  1554 │       │       │       │        │       │               │       │    threading shutdown instead of interpreter shutdown.                                                                                                                                                                                   
  1555 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1556 │       │       │       │        │       │               │       │    For similarity to atexit, the registered functions are called in reverse.                                                                                                                                                             
  1557 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1558 │       │       │       │        │       │               │       │    if _SHUTTING_DOWN:                                                                                                                                                                                                                    
  1559 │       │       │       │        │       │               │       │        raise RuntimeError("can't register atexit after shutdown")                                                                                                                                                                        
  1560 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1561 │       │       │       │        │       │               │       │    call = functools.partial(func, *arg, **kwargs)                                                                                                                                                                                        
  1562 │       │       │       │        │       │               │       │    _threading_atexits.append(call)                                                                                                                                                                                                       
  1563 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1564 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1565 │       │       │       │        │       │               │       │from _thread import stack_size                                                                                                                                                                                                            
  1566 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1567 │       │       │       │        │       │               │       │# Create the main thread object,                                                                                                                                                                                                          
  1568 │       │       │       │        │       │               │       │# and make it available for the interpreter                                                                                                                                                                                               
  1569 │       │       │       │        │       │               │       │# (Py_Main) as threading._shutdown.                                                                                                                                                                                                       
  1570 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1571 │       │       │       │        │       │               │       │_main_thread = _MainThread()                                                                                                                                                                                                              
  1572 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1573 │       │       │       │        │       │               │       │def _shutdown():                                                                                                                                                                                                                          
  1574 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1575 │       │       │       │        │       │               │       │    Wait until the Python thread state of all non-daemon threads get deleted.                                                                                                                                                             
  1576 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1577 │       │       │       │        │       │               │       │    # Obscure:  other threads may be waiting to join _main_thread.  That's                                                                                                                                                                
  1578 │       │       │       │        │       │               │       │    # dubious, but some code does it.  We can't wait for C code to release                                                                                                                                                                
  1579 │       │       │       │        │       │               │       │    # the main thread's tstate_lock - that won't happen until the interpreter                                                                                                                                                             
  1580 │       │       │       │        │       │               │       │    # is nearly dead.  So we release it here.  Note that just calling _stop()                                                                                                                                                             
  1581 │       │       │       │        │       │               │       │    # isn't enough:  other threads may already be waiting on _tstate_lock.                                                                                                                                                                
  1582 │       │       │       │        │       │               │       │    if _main_thread._is_stopped and _is_main_interpreter():                                                                                                                                                                               
  1583 │       │       │       │        │       │               │       │        # _shutdown() was already called                                                                                                                                                                                                  
  1584 │       │       │       │        │       │               │       │        return                                                                                                                                                                                                                            
  1585 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1586 │       │       │       │        │       │               │       │    global _SHUTTING_DOWN                                                                                                                                                                                                                 
  1587 │       │       │       │        │       │               │       │    _SHUTTING_DOWN = True                                                                                                                                                                                                                 
  1588 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1589 │       │       │       │        │       │               │       │    # Call registered threading atexit functions before threads are joined.                                                                                                                                                               
  1590 │       │       │       │        │       │               │       │    # Order is reversed, similar to atexit.                                                                                                                                                                                               
  1591 │       │       │       │        │       │               │       │    for atexit_call in reversed(_threading_atexits):                                                                                                                                                                                      
  1592 │       │       │       │        │       │               │       │        atexit_call()                                                                                                                                                                                                                     
  1593 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1594 │       │       │       │        │       │               │       │    # Main thread                                                                                                                                                                                                                         
  1595 │       │       │       │        │       │               │       │    if _main_thread.ident == get_ident():                                                                                                                                                                                                 
  1596 │       │       │       │        │       │               │       │        tlock = _main_thread._tstate_lock                                                                                                                                                                                                 
  1597 │       │       │       │        │       │               │       │        # The main thread isn't finished yet, so its thread state lock can't                                                                                                                                                              
  1598 │       │       │       │        │       │               │       │        # have been released.                                                                                                                                                                                                             
  1599 │       │       │       │        │       │               │       │        assert tlock is not None                                                                                                                                                                                                          
  1600 │       │       │       │        │       │               │       │        assert tlock.locked()                                                                                                                                                                                                             
  1601 │       │       │       │        │       │               │       │        tlock.release()                                                                                                                                                                                                                   
  1602 │       │       │       │        │       │               │       │        _main_thread._stop()                                                                                                                                                                                                              
  1603 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
  1604 │       │       │       │        │       │               │       │        # bpo-1596321: _shutdown() must be called in the main thread.                                                                                                                                                                     
  1605 │       │       │       │        │       │               │       │        # If the threading module was not imported by the main thread,                                                                                                                                                                    
  1606 │       │       │       │        │       │               │       │        # _main_thread is the thread which imported the threading module.                                                                                                                                                                 
  1607 │       │       │       │        │       │               │       │        # In this case, ignore _main_thread, similar behavior than for threads                                                                                                                                                            
  1608 │       │       │       │        │       │               │       │        # spawned by C libraries or using _thread.start_new_thread().                                                                                                                                                                     
  1609 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
  1610 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1611 │       │       │       │        │       │               │       │    # Join all non-deamon threads                                                                                                                                                                                                         
  1612 │       │       │       │        │       │               │       │    while True:                                                                                                                                                                                                                           
  1613 │       │       │       │        │       │               │       │        with _shutdown_locks_lock:                                                                                                                                                                                                        
  1614 │       │       │       │        │       │               │       │            locks = list(_shutdown_locks)                                                                                                                                                                                                 
  1615 │       │       │       │        │       │               │       │            _shutdown_locks.clear()                                                                                                                                                                                                       
  1616 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1617 │       │       │       │        │       │               │       │        if not locks:                                                                                                                                                                                                                     
  1618 │       │       │       │        │       │               │       │            break                                                                                                                                                                                                                         
  1619 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1620 │       │       │       │        │       │               │       │        for lock in locks:                                                                                                                                                                                                                
  1621 │       │       │       │        │       │               │       │            # mimic Thread.join()                                                                                                                                                                                                         
  1622 │       │       │       │        │       │               │       │            lock.acquire()                                                                                                                                                                                                                
  1623 │       │       │       │        │       │               │       │            lock.release()                                                                                                                                                                                                                
  1624 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1625 │       │       │       │        │       │               │       │        # new threads can be spawned while we were waiting for the other                                                                                                                                                                  
  1626 │       │       │       │        │       │               │       │        # threads to complete                                                                                                                                                                                                             
  1627 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1628 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1629 │       │       │       │        │       │               │       │def main_thread():                                                                                                                                                                                                                        
  1630 │       │       │       │        │       │               │       │    """Return the main thread object.                                                                                                                                                                                                     
  1631 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1632 │       │       │       │        │       │               │       │    In normal conditions, the main thread is the thread from which the                                                                                                                                                                    
  1633 │       │       │       │        │       │               │       │    Python interpreter was started.                                                                                                                                                                                                       
  1634 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1635 │       │       │       │        │       │               │       │    # XXX Figure this out for subinterpreters.  (See gh-75698.)                                                                                                                                                                           
  1636 │       │       │       │        │       │               │       │    return _main_thread                                                                                                                                                                                                                   
  1637 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1638 │       │       │       │        │       │               │       │# get thread-local implementation, either from the thread                                                                                                                                                                                 
  1639 │       │       │       │        │       │               │       │# module, or from the python fallback                                                                                                                                                                                                     
  1640 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1641 │       │       │       │        │       │               │       │try:                                                                                                                                                                                                                                      
  1642 │       │       │       │        │       │               │       │    from _thread import _local as local                                                                                                                                                                                                   
  1643 │       │       │       │        │       │               │       │except ImportError:                                                                                                                                                                                                                       
  1644 │       │       │       │        │       │               │       │    from _threading_local import local                                                                                                                                                                                                    
  1645 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1646 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1647 │       │       │       │        │       │               │       │def _after_fork():                                                                                                                                                                                                                        
  1648 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1649 │       │       │       │        │       │               │       │    Cleanup threading module state that should not exist after a fork.                                                                                                                                                                    
  1650 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  1651 │       │       │       │        │       │               │       │    # Reset _active_limbo_lock, in case we forked while the lock was held                                                                                                                                                                 
  1652 │       │       │       │        │       │               │       │    # by another (non-forked) thread.  http://bugs.python.org/issue874900                                                                                                                                                                 
  1653 │       │       │       │        │       │               │       │    global _active_limbo_lock, _main_thread                                                                                                                                                                                               
  1654 │       │       │       │        │       │               │       │    global _shutdown_locks_lock, _shutdown_locks                                                                                                                                                                                          
  1655 │       │       │       │        │       │               │       │    _active_limbo_lock = RLock()                                                                                                                                                                                                          
  1656 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1657 │       │       │       │        │       │               │       │    # fork() only copied the current thread; clear references to others.                                                                                                                                                                  
  1658 │       │       │       │        │       │               │       │    new_active = {}                                                                                                                                                                                                                       
  1659 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1660 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
  1661 │       │       │       │        │       │               │       │        current = _active[get_ident()]                                                                                                                                                                                                    
  1662 │       │       │       │        │       │               │       │    except KeyError:                                                                                                                                                                                                                      
  1663 │       │       │       │        │       │               │       │        # fork() was called in a thread which was not spawned                                                                                                                                                                             
  1664 │       │       │       │        │       │               │       │        # by threading.Thread. For example, a thread spawned                                                                                                                                                                              
  1665 │       │       │       │        │       │               │       │        # by thread.start_new_thread().                                                                                                                                                                                                   
  1666 │       │       │       │        │       │               │       │        current = _MainThread()                                                                                                                                                                                                           
  1667 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1668 │       │       │       │        │       │               │       │    _main_thread = current                                                                                                                                                                                                                
  1669 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1670 │       │       │       │        │       │               │       │    # reset _shutdown() locks: threads re-register their _tstate_lock below                                                                                                                                                               
  1671 │       │       │       │        │       │               │       │    _shutdown_locks_lock = _allocate_lock()                                                                                                                                                                                               
  1672 │       │       │       │        │       │               │       │    _shutdown_locks = set()                                                                                                                                                                                                               
  1673 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1674 │       │       │       │        │       │               │       │    with _active_limbo_lock:                                                                                                                                                                                                              
  1675 │       │       │       │        │       │               │       │        # Dangling thread instances must still have their locks reset,                                                                                                                                                                    
  1676 │       │       │       │        │       │               │       │        # because someone may join() them.                                                                                                                                                                                                
  1677 │       │       │       │        │       │               │       │        threads = set(_enumerate())                                                                                                                                                                                                       
  1678 │       │       │       │        │       │               │       │        threads.update(_dangling)                                                                                                                                                                                                         
  1679 │       │       │       │        │       │               │       │        for thread in threads:                                                                                                                                                                                                            
  1680 │       │       │       │        │       │               │       │            # Any lock/condition variable may be currently locked or in an                                                                                                                                                                
  1681 │       │       │       │        │       │               │       │            # invalid state, so we reinitialize them.                                                                                                                                                                                     
  1682 │       │       │       │        │       │               │       │            if thread is current:                                                                                                                                                                                                         
  1683 │       │       │       │        │       │               │       │                # There is only one active thread. We reset the ident to                                                                                                                                                                  
  1684 │       │       │       │        │       │               │       │                # its new value since it can have changed.                                                                                                                                                                                
  1685 │       │       │       │        │       │               │       │                thread._reset_internal_locks(True)                                                                                                                                                                                        
  1686 │       │       │       │        │       │               │       │                ident = get_ident()                                                                                                                                                                                                       
  1687 │       │       │       │        │       │               │       │                if isinstance(thread, _DummyThread):                                                                                                                                                                                      
  1688 │       │       │       │        │       │               │       │                    thread.__class__ = _MainThread                                                                                                                                                                                        
  1689 │       │       │       │        │       │               │       │                    thread._name = 'MainThread'                                                                                                                                                                                           
  1690 │       │       │       │        │       │               │       │                    thread._daemonic = False                                                                                                                                                                                              
  1691 │       │       │       │        │       │               │       │                    thread._set_tstate_lock()                                                                                                                                                                                             
  1692 │       │       │       │        │       │               │       │                thread._ident = ident                                                                                                                                                                                                     
  1693 │       │       │       │        │       │               │       │                new_active[ident] = thread                                                                                                                                                                                                
  1694 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  1695 │       │       │       │        │       │               │       │                # All the others are already stopped.                                                                                                                                                                                     
  1696 │       │       │       │        │       │               │       │                thread._reset_internal_locks(False)                                                                                                                                                                                       
  1697 │       │       │       │        │       │               │       │                thread._stop()                                                                                                                                                                                                            
  1698 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1699 │       │       │       │        │       │               │       │        _limbo.clear()                                                                                                                                                                                                                    
  1700 │       │       │       │        │       │               │       │        _active.clear()                                                                                                                                                                                                                   
  1701 │       │       │       │        │       │               │       │        _active.update(new_active)                                                                                                                                                                                                        
  1702 │       │       │       │        │       │               │       │        assert len(_active) == 1                                                                                                                                                                                                          
  1703 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1704 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1705 │       │       │       │        │       │               │       │if hasattr(_os, "register_at_fork"):                                                                                                                                                                                                      
  1706 │       │       │       │        │       │               │       │    _os.register_at_fork(after_in_child=_after_fork)                                                                                                                                                                                      
  1707 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
╶──────┼───────┼───────┼───────┼────────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │       │        │       │               │       │function summary for /p/software/juwels/stages/2025/software/Python/3.12.3-GCCcore-13.3.0/lib/python3.12/threading.py                                                                                                                     
   999 │       │   10% │  57%  │        │       │               │       │Thread.run                                                                                                                                                                                                                                
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
                                                                                 /p/software/juwels/stages/2025/software/Python/3.12.3-GCCcore-13.3.0/lib/python3.12/selectors.py: % of time =   3.63% (3.589s) out of 2m:38.834s.                                                                                 
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/software/juwels/stages/2025/software/Python/3.12.3-GCCcore-13.3.0/lib/python3.12/selectors.py                                                                                                                                          
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │"""Selectors module.                                                                                                                                                                                                                      
     2 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
     3 │       │       │       │        │       │               │       │This module allows high-level and efficient I/O multiplexing, built upon the                                                                                                                                                              
     4 │       │       │       │        │       │               │       │`select` module primitives.                                                                                                                                                                                                               
     5 │       │       │       │        │       │               │       │"""                                                                                                                                                                                                                                       
     6 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
     7 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
     8 │       │       │       │        │       │               │       │from abc import ABCMeta, abstractmethod                                                                                                                                                                                                   
     9 │       │       │       │        │       │               │       │from collections import namedtuple                                                                                                                                                                                                        
    10 │       │       │       │        │       │               │       │from collections.abc import Mapping                                                                                                                                                                                                       
    11 │       │       │       │        │       │               │       │import math                                                                                                                                                                                                                               
    12 │       │       │       │        │       │               │       │import select                                                                                                                                                                                                                             
    13 │       │       │       │        │       │               │       │import sys                                                                                                                                                                                                                                
    14 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    15 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    16 │       │       │       │        │       │               │       │# generic events, that must be mapped to implementation-specific ones                                                                                                                                                                     
    17 │       │       │       │        │       │               │       │EVENT_READ = (1 << 0)                                                                                                                                                                                                                     
    18 │       │       │       │        │       │               │       │EVENT_WRITE = (1 << 1)                                                                                                                                                                                                                    
    19 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    20 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    21 │       │       │       │        │       │               │       │def _fileobj_to_fd(fileobj):                                                                                                                                                                                                              
    22 │       │       │       │        │       │               │       │    """Return a file descriptor from a file object.                                                                                                                                                                                       
    23 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    24 │       │       │       │        │       │               │       │    Parameters:                                                                                                                                                                                                                           
    25 │       │       │       │        │       │               │       │    fileobj -- file object or file descriptor                                                                                                                                                                                             
    26 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    27 │       │       │       │        │       │               │       │    Returns:                                                                                                                                                                                                                              
    28 │       │       │       │        │       │               │       │    corresponding file descriptor                                                                                                                                                                                                         
    29 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    30 │       │       │       │        │       │               │       │    Raises:                                                                                                                                                                                                                               
    31 │       │       │       │        │       │               │       │    ValueError if the object is invalid                                                                                                                                                                                                   
    32 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    33 │       │       │       │        │       │               │       │    if isinstance(fileobj, int):                                                                                                                                                                                                          
    34 │       │       │       │        │       │               │       │        fd = fileobj                                                                                                                                                                                                                      
    35 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
    36 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
    37 │       │       │       │        │       │               │       │            fd = int(fileobj.fileno())                                                                                                                                                                                                    
    38 │       │       │       │        │       │               │       │        except (AttributeError, TypeError, ValueError):                                                                                                                                                                                   
    39 │       │       │       │        │       │               │       │            raise ValueError("Invalid file object: "                                                                                                                                                                                      
    40 │       │       │       │        │       │               │       │                             "{!r}".format(fileobj)) from None                                                                                                                                                                            
    41 │       │       │       │        │       │               │       │    if fd < 0:                                                                                                                                                                                                                            
    42 │       │       │       │        │       │               │       │        raise ValueError("Invalid file descriptor: {}".format(fd))                                                                                                                                                                        
    43 │       │       │       │        │       │               │       │    return fd                                                                                                                                                                                                                             
    44 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    45 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    46 │       │       │       │        │       │               │       │SelectorKey = namedtuple('SelectorKey', ['fileobj', 'fd', 'events', 'data'])                                                                                                                                                              
    47 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    48 │       │       │       │        │       │               │       │SelectorKey.__doc__ = """SelectorKey(fileobj, fd, events, data)                                                                                                                                                                           
    49 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    50 │       │       │       │        │       │               │       │    Object used to associate a file object to its backing                                                                                                                                                                                 
    51 │       │       │       │        │       │               │       │    file descriptor, selected event mask, and attached data.                                                                                                                                                                              
    52 │       │       │       │        │       │               │       │"""                                                                                                                                                                                                                                       
    53 │       │       │       │        │       │               │       │SelectorKey.fileobj.__doc__ = 'File object registered.'                                                                                                                                                                                   
    54 │       │       │       │        │       │               │       │SelectorKey.fd.__doc__ = 'Underlying file descriptor.'                                                                                                                                                                                    
    55 │       │       │       │        │       │               │       │SelectorKey.events.__doc__ = 'Events that must be waited for on this file object.'                                                                                                                                                        
    56 │       │       │       │        │       │               │       │SelectorKey.data.__doc__ = ('''Optional opaque data associated to this file object.                                                                                                                                                       
    57 │       │       │       │        │       │               │       │For example, this could be used to store a per-client session ID.''')                                                                                                                                                                     
    58 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    59 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    60 │       │       │       │        │       │               │       │class _SelectorMapping(Mapping):                                                                                                                                                                                                          
    61 │       │       │       │        │       │               │       │    """Mapping of file objects to selector keys."""                                                                                                                                                                                       
    62 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    63 │       │       │       │        │       │               │       │    def __init__(self, selector):                                                                                                                                                                                                         
    64 │       │       │       │        │       │               │       │        self._selector = selector                                                                                                                                                                                                         
    65 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    66 │       │       │       │        │       │               │       │    def __len__(self):                                                                                                                                                                                                                    
    67 │       │       │       │        │       │               │       │        return len(self._selector._fd_to_key)                                                                                                                                                                                             
    68 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    69 │       │       │       │        │       │               │       │    def __getitem__(self, fileobj):                                                                                                                                                                                                       
    70 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
    71 │       │       │       │        │       │               │       │            fd = self._selector._fileobj_lookup(fileobj)                                                                                                                                                                                  
    72 │       │       │       │        │       │               │       │            return self._selector._fd_to_key[fd]                                                                                                                                                                                          
    73 │       │       │       │        │       │               │       │        except KeyError:                                                                                                                                                                                                                  
    74 │       │       │       │        │       │               │       │            raise KeyError("{!r} is not registered".format(fileobj)) from None                                                                                                                                                            
    75 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    76 │       │       │       │        │       │               │       │    def __iter__(self):                                                                                                                                                                                                                   
    77 │       │       │       │        │       │               │       │        return iter(self._selector._fd_to_key)                                                                                                                                                                                            
    78 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    79 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    80 │       │       │       │        │       │               │       │class BaseSelector(metaclass=ABCMeta):                                                                                                                                                                                                    
    81 │       │       │       │        │       │               │       │    """Selector abstract base class.                                                                                                                                                                                                      
    82 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    83 │       │       │       │        │       │               │       │    A selector supports registering file objects to be monitored for specific                                                                                                                                                             
    84 │       │       │       │        │       │               │       │    I/O events.                                                                                                                                                                                                                           
    85 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    86 │       │       │       │        │       │               │       │    A file object is a file descriptor or any object with a `fileno()` method.                                                                                                                                                            
    87 │       │       │       │        │       │               │       │    An arbitrary object can be attached to the file object, which can be used                                                                                                                                                             
    88 │       │       │       │        │       │               │       │    for example to store context information, a callback, etc.                                                                                                                                                                            
    89 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    90 │       │       │       │        │       │               │       │    A selector can use various implementations (select(), poll(), epoll()...)                                                                                                                                                             
    91 │       │       │       │        │       │               │       │    depending on the platform. The default `Selector` class uses the most                                                                                                                                                                 
    92 │       │       │       │        │       │               │       │    efficient implementation on the current platform.                                                                                                                                                                                     
    93 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    94 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    95 │       │       │       │        │       │               │       │    @abstractmethod                                                                                                                                                                                                                       
    96 │       │       │       │        │       │               │       │    def register(self, fileobj, events, data=None):                                                                                                                                                                                       
    97 │       │       │       │        │       │               │       │        """Register a file object.                                                                                                                                                                                                        
    98 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    99 │       │       │       │        │       │               │       │        Parameters:                                                                                                                                                                                                                       
   100 │       │       │       │        │       │               │       │        fileobj -- file object or file descriptor                                                                                                                                                                                         
   101 │       │       │       │        │       │               │       │        events  -- events to monitor (bitwise mask of EVENT_READ|EVENT_WRITE)                                                                                                                                                             
   102 │       │       │       │        │       │               │       │        data    -- attached data                                                                                                                                                                                                          
   103 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   104 │       │       │       │        │       │               │       │        Returns:                                                                                                                                                                                                                          
   105 │       │       │       │        │       │               │       │        SelectorKey instance                                                                                                                                                                                                              
   106 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   107 │       │       │       │        │       │               │       │        Raises:                                                                                                                                                                                                                           
   108 │       │       │       │        │       │               │       │        ValueError if events is invalid                                                                                                                                                                                                   
   109 │       │       │       │        │       │               │       │        KeyError if fileobj is already registered                                                                                                                                                                                         
   110 │       │       │       │        │       │               │       │        OSError if fileobj is closed or otherwise is unacceptable to                                                                                                                                                                      
   111 │       │       │       │        │       │               │       │                the underlying system call (if a system call is made)                                                                                                                                                                     
   112 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   113 │       │       │       │        │       │               │       │        Note:                                                                                                                                                                                                                             
   114 │       │       │       │        │       │               │       │        OSError may or may not be raised                                                                                                                                                                                                  
   115 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   116 │       │       │       │        │       │               │       │        raise NotImplementedError                                                                                                                                                                                                         
   117 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   118 │       │       │       │        │       │               │       │    @abstractmethod                                                                                                                                                                                                                       
   119 │       │       │       │        │       │               │       │    def unregister(self, fileobj):                                                                                                                                                                                                        
   120 │       │       │       │        │       │               │       │        """Unregister a file object.                                                                                                                                                                                                      
   121 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   122 │       │       │       │        │       │               │       │        Parameters:                                                                                                                                                                                                                       
   123 │       │       │       │        │       │               │       │        fileobj -- file object or file descriptor                                                                                                                                                                                         
   124 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   125 │       │       │       │        │       │               │       │        Returns:                                                                                                                                                                                                                          
   126 │       │       │       │        │       │               │       │        SelectorKey instance                                                                                                                                                                                                              
   127 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   128 │       │       │       │        │       │               │       │        Raises:                                                                                                                                                                                                                           
   129 │       │       │       │        │       │               │       │        KeyError if fileobj is not registered                                                                                                                                                                                             
   130 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   131 │       │       │       │        │       │               │       │        Note:                                                                                                                                                                                                                             
   132 │       │       │       │        │       │               │       │        If fileobj is registered but has since been closed this does                                                                                                                                                                      
   133 │       │       │       │        │       │               │       │        *not* raise OSError (even if the wrapped syscall does)                                                                                                                                                                            
   134 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   135 │       │       │       │        │       │               │       │        raise NotImplementedError                                                                                                                                                                                                         
   136 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   137 │       │       │       │        │       │               │       │    def modify(self, fileobj, events, data=None):                                                                                                                                                                                         
   138 │       │       │       │        │       │               │       │        """Change a registered file object monitored events or attached data.                                                                                                                                                             
   139 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   140 │       │       │       │        │       │               │       │        Parameters:                                                                                                                                                                                                                       
   141 │       │       │       │        │       │               │       │        fileobj -- file object or file descriptor                                                                                                                                                                                         
   142 │       │       │       │        │       │               │       │        events  -- events to monitor (bitwise mask of EVENT_READ|EVENT_WRITE)                                                                                                                                                             
   143 │       │       │       │        │       │               │       │        data    -- attached data                                                                                                                                                                                                          
   144 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   145 │       │       │       │        │       │               │       │        Returns:                                                                                                                                                                                                                          
   146 │       │       │       │        │       │               │       │        SelectorKey instance                                                                                                                                                                                                              
   147 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   148 │       │       │       │        │       │               │       │        Raises:                                                                                                                                                                                                                           
   149 │       │       │       │        │       │               │       │        Anything that unregister() or register() raises                                                                                                                                                                                   
   150 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   151 │       │       │       │        │       │               │       │        self.unregister(fileobj)                                                                                                                                                                                                          
   152 │       │       │       │        │       │               │       │        return self.register(fileobj, events, data)                                                                                                                                                                                       
   153 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   154 │       │       │       │        │       │               │       │    @abstractmethod                                                                                                                                                                                                                       
   155 │       │       │       │        │       │               │       │    def select(self, timeout=None):                                                                                                                                                                                                       
   156 │       │       │       │        │       │               │       │        """Perform the actual selection, until some monitored file objects are                                                                                                                                                            
   157 │       │       │       │        │       │               │       │        ready or a timeout expires.                                                                                                                                                                                                       
   158 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   159 │       │       │       │        │       │               │       │        Parameters:                                                                                                                                                                                                                       
   160 │       │       │       │        │       │               │       │        timeout -- if timeout > 0, this specifies the maximum wait time, in                                                                                                                                                               
   161 │       │       │       │        │       │               │       │                   seconds                                                                                                                                                                                                                
   162 │       │       │       │        │       │               │       │                   if timeout <= 0, the select() call won't block, and will                                                                                                                                                               
   163 │       │       │       │        │       │               │       │                   report the currently ready file objects                                                                                                                                                                                
   164 │       │       │       │        │       │               │       │                   if timeout is None, select() will block until a monitored                                                                                                                                                              
   165 │       │       │       │        │       │               │       │                   file object becomes ready                                                                                                                                                                                              
   166 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   167 │       │       │       │        │       │               │       │        Returns:                                                                                                                                                                                                                          
   168 │       │       │       │        │       │               │       │        list of (key, events) for ready file objects                                                                                                                                                                                      
   169 │       │       │       │        │       │               │       │        `events` is a bitwise mask of EVENT_READ|EVENT_WRITE                                                                                                                                                                              
   170 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   171 │       │       │       │        │       │               │       │        raise NotImplementedError                                                                                                                                                                                                         
   172 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   173 │       │       │       │        │       │               │       │    def close(self):                                                                                                                                                                                                                      
   174 │       │       │       │        │       │               │       │        """Close the selector.                                                                                                                                                                                                            
   175 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   176 │       │       │       │        │       │               │       │        This must be called to make sure that any underlying resource is freed.                                                                                                                                                           
   177 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   178 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   179 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   180 │       │       │       │        │       │               │       │    def get_key(self, fileobj):                                                                                                                                                                                                           
   181 │       │       │       │        │       │               │       │        """Return the key associated to a registered file object.                                                                                                                                                                         
   182 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   183 │       │       │       │        │       │               │       │        Returns:                                                                                                                                                                                                                          
   184 │       │       │       │        │       │               │       │        SelectorKey for this file object                                                                                                                                                                                                  
   185 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   186 │       │       │       │        │       │               │       │        mapping = self.get_map()                                                                                                                                                                                                          
   187 │       │       │       │        │       │               │       │        if mapping is None:                                                                                                                                                                                                               
   188 │       │       │       │        │       │               │       │            raise RuntimeError('Selector is closed')                                                                                                                                                                                      
   189 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   190 │       │       │       │        │       │               │       │            return mapping[fileobj]                                                                                                                                                                                                       
   191 │       │       │       │        │       │               │       │        except KeyError:                                                                                                                                                                                                                  
   192 │       │       │       │        │       │               │       │            raise KeyError("{!r} is not registered".format(fileobj)) from None                                                                                                                                                            
   193 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   194 │       │       │       │        │       │               │       │    @abstractmethod                                                                                                                                                                                                                       
   195 │       │       │       │        │       │               │       │    def get_map(self):                                                                                                                                                                                                                    
   196 │       │       │       │        │       │               │       │        """Return a mapping of file objects to selector keys."""                                                                                                                                                                          
   197 │       │       │       │        │       │               │       │        raise NotImplementedError                                                                                                                                                                                                         
   198 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   199 │       │       │       │        │       │               │       │    def __enter__(self):                                                                                                                                                                                                                  
   200 │       │       │       │        │       │               │       │        return self                                                                                                                                                                                                                       
   201 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   202 │       │       │       │        │       │               │       │    def __exit__(self, *args):                                                                                                                                                                                                            
   203 │       │       │       │        │       │               │       │        self.close()                                                                                                                                                                                                                      
   204 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   205 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   206 │       │       │       │        │       │               │       │class _BaseSelectorImpl(BaseSelector):                                                                                                                                                                                                    
   207 │       │       │       │        │       │               │       │    """Base selector implementation."""                                                                                                                                                                                                   
   208 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   209 │       │       │       │        │       │               │       │    def __init__(self):                                                                                                                                                                                                                   
   210 │       │       │       │        │       │               │       │        # this maps file descriptors to keys                                                                                                                                                                                              
   211 │       │       │       │        │       │               │       │        self._fd_to_key = {}                                                                                                                                                                                                              
   212 │       │       │       │        │       │               │       │        # read-only mapping returned by get_map()                                                                                                                                                                                         
   213 │       │       │       │        │       │               │       │        self._map = _SelectorMapping(self)                                                                                                                                                                                                
   214 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   215 │       │       │       │        │       │               │       │    def _fileobj_lookup(self, fileobj):                                                                                                                                                                                                   
   216 │       │       │       │        │       │               │       │        """Return a file descriptor from a file object.                                                                                                                                                                                   
   217 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   218 │       │       │       │        │       │               │       │        This wraps _fileobj_to_fd() to do an exhaustive search in case                                                                                                                                                                    
   219 │       │       │       │        │       │               │       │        the object is invalid but we still have it in our map.  This                                                                                                                                                                      
   220 │       │       │       │        │       │               │       │        is used by unregister() so we can unregister an object that                                                                                                                                                                       
   221 │       │       │       │        │       │               │       │        was previously registered even if it is closed.  It is also                                                                                                                                                                       
   222 │       │       │       │        │       │               │       │        used by _SelectorMapping.                                                                                                                                                                                                         
   223 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   224 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   225 │       │       │       │        │       │               │       │            return _fileobj_to_fd(fileobj)                                                                                                                                                                                                
   226 │       │       │       │        │       │               │       │        except ValueError:                                                                                                                                                                                                                
   227 │       │       │       │        │       │               │       │            # Do an exhaustive search.                                                                                                                                                                                                    
   228 │       │       │       │        │       │               │       │            for key in self._fd_to_key.values():                                                                                                                                                                                          
   229 │       │       │       │        │       │               │       │                if key.fileobj is fileobj:                                                                                                                                                                                                
   230 │       │       │       │        │       │               │       │                    return key.fd                                                                                                                                                                                                         
   231 │       │       │       │        │       │               │       │            # Raise ValueError after all.                                                                                                                                                                                                 
   232 │       │       │       │        │       │               │       │            raise                                                                                                                                                                                                                         
   233 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   234 │       │       │       │        │       │               │       │    def register(self, fileobj, events, data=None):                                                                                                                                                                                       
   235 │       │       │       │        │       │               │       │        if (not events) or (events & ~(EVENT_READ | EVENT_WRITE)):                                                                                                                                                                        
   236 │       │       │       │        │       │               │       │            raise ValueError("Invalid events: {!r}".format(events))                                                                                                                                                                       
   237 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   238 │       │       │       │        │       │               │       │        key = SelectorKey(fileobj, self._fileobj_lookup(fileobj), events, data)                                                                                                                                                           
   239 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   240 │       │       │       │        │       │               │       │        if key.fd in self._fd_to_key:                                                                                                                                                                                                     
   241 │       │       │       │        │       │               │       │            raise KeyError("{!r} (FD {}) is already registered"                                                                                                                                                                           
   242 │       │       │       │        │       │               │       │                           .format(fileobj, key.fd))                                                                                                                                                                                      
   243 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   244 │       │       │       │        │       │               │       │        self._fd_to_key[key.fd] = key                                                                                                                                                                                                     
   245 │       │       │       │        │       │               │       │        return key                                                                                                                                                                                                                        
   246 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   247 │       │       │       │        │       │               │       │    def unregister(self, fileobj):                                                                                                                                                                                                        
   248 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   249 │       │       │       │        │       │               │       │            key = self._fd_to_key.pop(self._fileobj_lookup(fileobj))                                                                                                                                                                      
   250 │       │       │       │        │       │               │       │        except KeyError:                                                                                                                                                                                                                  
   251 │       │       │       │        │       │               │       │            raise KeyError("{!r} is not registered".format(fileobj)) from None                                                                                                                                                            
   252 │       │       │       │        │       │               │       │        return key                                                                                                                                                                                                                        
   253 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   254 │       │       │       │        │       │               │       │    def modify(self, fileobj, events, data=None):                                                                                                                                                                                         
   255 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   256 │       │       │       │        │       │               │       │            key = self._fd_to_key[self._fileobj_lookup(fileobj)]                                                                                                                                                                          
   257 │       │       │       │        │       │               │       │        except KeyError:                                                                                                                                                                                                                  
   258 │       │       │       │        │       │               │       │            raise KeyError("{!r} is not registered".format(fileobj)) from None                                                                                                                                                            
   259 │       │       │       │        │       │               │       │        if events != key.events:                                                                                                                                                                                                          
   260 │       │       │       │        │       │               │       │            self.unregister(fileobj)                                                                                                                                                                                                      
   261 │       │       │       │        │       │               │       │            key = self.register(fileobj, events, data)                                                                                                                                                                                    
   262 │       │       │       │        │       │               │       │        elif data != key.data:                                                                                                                                                                                                            
   263 │       │       │       │        │       │               │       │            # Use a shortcut to update the data.                                                                                                                                                                                          
   264 │       │       │       │        │       │               │       │            key = key._replace(data=data)                                                                                                                                                                                                 
   265 │       │       │       │        │       │               │       │            self._fd_to_key[key.fd] = key                                                                                                                                                                                                 
   266 │       │       │       │        │       │               │       │        return key                                                                                                                                                                                                                        
   267 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   268 │       │       │       │        │       │               │       │    def close(self):                                                                                                                                                                                                                      
   269 │       │       │       │        │       │               │       │        self._fd_to_key.clear()                                                                                                                                                                                                           
   270 │       │       │       │        │       │               │       │        self._map = None                                                                                                                                                                                                                  
   271 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   272 │       │       │       │        │       │               │       │    def get_map(self):                                                                                                                                                                                                                    
   273 │       │       │       │        │       │               │       │        return self._map                                                                                                                                                                                                                  
   274 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   275 │       │       │       │        │       │               │       │    def _key_from_fd(self, fd):                                                                                                                                                                                                           
   276 │       │       │       │        │       │               │       │        """Return the key associated to a given file descriptor.                                                                                                                                                                          
   277 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   278 │       │       │       │        │       │               │       │        Parameters:                                                                                                                                                                                                                       
   279 │       │       │       │        │       │               │       │        fd -- file descriptor                                                                                                                                                                                                             
   280 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   281 │       │       │       │        │       │               │       │        Returns:                                                                                                                                                                                                                          
   282 │       │       │       │        │       │               │       │        corresponding key, or None if not found                                                                                                                                                                                           
   283 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   284 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   285 │       │       │       │        │       │               │       │            return self._fd_to_key[fd]                                                                                                                                                                                                    
   286 │       │       │       │        │       │               │       │        except KeyError:                                                                                                                                                                                                                  
   287 │       │       │       │        │       │               │       │            return None                                                                                                                                                                                                                   
   288 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   289 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   290 │       │       │       │        │       │               │       │class SelectSelector(_BaseSelectorImpl):                                                                                                                                                                                                  
   291 │       │       │       │        │       │               │       │    """Select-based selector."""                                                                                                                                                                                                          
   292 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   293 │       │       │       │        │       │               │       │    def __init__(self):                                                                                                                                                                                                                   
   294 │       │       │       │        │       │               │       │        super().__init__()                                                                                                                                                                                                                
   295 │       │       │       │        │       │               │       │        self._readers = set()                                                                                                                                                                                                             
   296 │       │       │       │        │       │               │       │        self._writers = set()                                                                                                                                                                                                             
   297 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   298 │       │       │       │        │       │               │       │    def register(self, fileobj, events, data=None):                                                                                                                                                                                       
   299 │       │       │       │        │       │               │       │        key = super().register(fileobj, events, data)                                                                                                                                                                                     
   300 │       │       │       │        │       │               │       │        if events & EVENT_READ:                                                                                                                                                                                                           
   301 │       │       │       │        │       │               │       │            self._readers.add(key.fd)                                                                                                                                                                                                     
   302 │       │       │       │        │       │               │       │        if events & EVENT_WRITE:                                                                                                                                                                                                          
   303 │       │       │       │        │       │               │       │            self._writers.add(key.fd)                                                                                                                                                                                                     
   304 │       │       │       │        │       │               │       │        return key                                                                                                                                                                                                                        
   305 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   306 │       │       │       │        │       │               │       │    def unregister(self, fileobj):                                                                                                                                                                                                        
   307 │       │       │       │        │       │               │       │        key = super().unregister(fileobj)                                                                                                                                                                                                 
   308 │       │       │       │        │       │               │       │        self._readers.discard(key.fd)                                                                                                                                                                                                     
   309 │       │       │       │        │       │               │       │        self._writers.discard(key.fd)                                                                                                                                                                                                     
   310 │       │       │       │        │       │               │       │        return key                                                                                                                                                                                                                        
   311 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   312 │       │       │       │        │       │               │       │    if sys.platform == 'win32':                                                                                                                                                                                                           
   313 │       │       │       │        │       │               │       │        def _select(self, r, w, _, timeout=None):                                                                                                                                                                                         
   314 │       │       │       │        │       │               │       │            r, w, x = select.select(r, w, w, timeout)                                                                                                                                                                                     
   315 │       │       │       │        │       │               │       │            return r, w + x, []                                                                                                                                                                                                           
   316 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
   317 │       │       │       │        │       │               │       │        _select = select.select                                                                                                                                                                                                           
   318 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   319 │       │       │       │        │       │               │       │    def select(self, timeout=None):                                                                                                                                                                                                       
   320 │       │       │       │        │       │               │       │        timeout = None if timeout is None else max(timeout, 0)                                                                                                                                                                            
   321 │       │       │       │        │       │               │       │        ready = []                                                                                                                                                                                                                        
   322 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   323 │       │       │       │        │       │               │       │            r, w, _ = self._select(self._readers, self._writers, [], timeout)                                                                                                                                                             
   324 │       │       │       │        │       │               │       │        except InterruptedError:                                                                                                                                                                                                          
   325 │       │       │       │        │       │               │       │            return ready                                                                                                                                                                                                                  
   326 │       │       │       │        │       │               │       │        r = set(r)                                                                                                                                                                                                                        
   327 │       │       │       │        │       │               │       │        w = set(w)                                                                                                                                                                                                                        
   328 │       │       │       │        │       │               │       │        for fd in r | w:                                                                                                                                                                                                                  
   329 │       │       │       │        │       │               │       │            events = 0                                                                                                                                                                                                                    
   330 │       │       │       │        │       │               │       │            if fd in r:                                                                                                                                                                                                                   
   331 │       │       │       │        │       │               │       │                events |= EVENT_READ                                                                                                                                                                                                      
   332 │       │       │       │        │       │               │       │            if fd in w:                                                                                                                                                                                                                   
   333 │       │       │       │        │       │               │       │                events |= EVENT_WRITE                                                                                                                                                                                                     
   334 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   335 │       │       │       │        │       │               │       │            key = self._key_from_fd(fd)                                                                                                                                                                                                   
   336 │       │       │       │        │       │               │       │            if key:                                                                                                                                                                                                                       
   337 │       │       │       │        │       │               │       │                ready.append((key, events & key.events))                                                                                                                                                                                  
   338 │       │       │       │        │       │               │       │        return ready                                                                                                                                                                                                                      
   339 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   340 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   341 │       │       │       │        │       │               │       │class _PollLikeSelector(_BaseSelectorImpl):                                                                                                                                                                                               
   342 │       │       │       │        │       │               │       │    """Base class shared between poll, epoll and devpoll selectors."""                                                                                                                                                                    
   343 │       │       │       │        │       │               │       │    _selector_cls = None                                                                                                                                                                                                                  
   344 │       │       │       │        │       │               │       │    _EVENT_READ = None                                                                                                                                                                                                                    
   345 │       │       │       │        │       │               │       │    _EVENT_WRITE = None                                                                                                                                                                                                                   
   346 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   347 │       │       │       │        │       │               │       │    def __init__(self):                                                                                                                                                                                                                   
   348 │       │       │       │        │       │               │       │        super().__init__()                                                                                                                                                                                                                
   349 │       │       │       │        │       │               │       │        self._selector = self._selector_cls()                                                                                                                                                                                             
   350 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   351 │       │       │       │        │       │               │       │    def register(self, fileobj, events, data=None):                                                                                                                                                                                       
   352 │       │       │       │        │       │               │       │        key = super().register(fileobj, events, data)                                                                                                                                                                                     
   353 │       │       │       │        │       │               │       │        poller_events = 0                                                                                                                                                                                                                 
   354 │       │       │       │        │       │               │       │        if events & EVENT_READ:                                                                                                                                                                                                           
   355 │       │       │       │        │       │               │       │            poller_events |= self._EVENT_READ                                                                                                                                                                                             
   356 │       │       │       │        │       │               │       │        if events & EVENT_WRITE:                                                                                                                                                                                                          
   357 │       │       │       │        │       │               │       │            poller_events |= self._EVENT_WRITE                                                                                                                                                                                            
   358 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   359 │       │       │       │        │       │               │       │            self._selector.register(key.fd, poller_events)                                                                                                                                                                                
   360 │       │       │       │        │       │               │       │        except:                                                                                                                                                                                                                           
   361 │       │       │       │        │       │               │       │            super().unregister(fileobj)                                                                                                                                                                                                   
   362 │       │       │       │        │       │               │       │            raise                                                                                                                                                                                                                         
   363 │       │       │       │        │       │               │       │        return key                                                                                                                                                                                                                        
   364 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   365 │       │       │       │        │       │               │       │    def unregister(self, fileobj):                                                                                                                                                                                                        
   366 │       │       │       │        │       │               │       │        key = super().unregister(fileobj)                                                                                                                                                                                                 
   367 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   368 │       │       │       │        │       │               │       │            self._selector.unregister(key.fd)                                                                                                                                                                                             
   369 │       │       │       │        │       │               │       │        except OSError:                                                                                                                                                                                                                   
   370 │       │       │       │        │       │               │       │            # This can happen if the FD was closed since it                                                                                                                                                                               
   371 │       │       │       │        │       │               │       │            # was registered.                                                                                                                                                                                                             
   372 │       │       │       │        │       │               │       │            pass                                                                                                                                                                                                                          
   373 │       │       │       │        │       │               │       │        return key                                                                                                                                                                                                                        
   374 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   375 │       │       │       │        │       │               │       │    def modify(self, fileobj, events, data=None):                                                                                                                                                                                         
   376 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   377 │       │       │       │        │       │               │       │            key = self._fd_to_key[self._fileobj_lookup(fileobj)]                                                                                                                                                                          
   378 │       │       │       │        │       │               │       │        except KeyError:                                                                                                                                                                                                                  
   379 │       │       │       │        │       │               │       │            raise KeyError(f"{fileobj!r} is not registered") from None                                                                                                                                                                    
   380 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   381 │       │       │       │        │       │               │       │        changed = False                                                                                                                                                                                                                   
   382 │       │       │       │        │       │               │       │        if events != key.events:                                                                                                                                                                                                          
   383 │       │       │       │        │       │               │       │            selector_events = 0                                                                                                                                                                                                           
   384 │       │       │       │        │       │               │       │            if events & EVENT_READ:                                                                                                                                                                                                       
   385 │       │       │       │        │       │               │       │                selector_events |= self._EVENT_READ                                                                                                                                                                                       
   386 │       │       │       │        │       │               │       │            if events & EVENT_WRITE:                                                                                                                                                                                                      
   387 │       │       │       │        │       │               │       │                selector_events |= self._EVENT_WRITE                                                                                                                                                                                      
   388 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
   389 │       │       │       │        │       │               │       │                self._selector.modify(key.fd, selector_events)                                                                                                                                                                            
   390 │       │       │       │        │       │               │       │            except:                                                                                                                                                                                                                       
   391 │       │       │       │        │       │               │       │                super().unregister(fileobj)                                                                                                                                                                                               
   392 │       │       │       │        │       │               │       │                raise                                                                                                                                                                                                                     
   393 │       │       │       │        │       │               │       │            changed = True                                                                                                                                                                                                                
   394 │       │       │       │        │       │               │       │        if data != key.data:                                                                                                                                                                                                              
   395 │       │       │       │        │       │               │       │            changed = True                                                                                                                                                                                                                
   396 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   397 │       │       │       │        │       │               │       │        if changed:                                                                                                                                                                                                                       
   398 │       │       │       │        │       │               │       │            key = key._replace(events=events, data=data)                                                                                                                                                                                  
   399 │       │       │       │        │       │               │       │            self._fd_to_key[key.fd] = key                                                                                                                                                                                                 
   400 │       │       │       │        │       │               │       │        return key                                                                                                                                                                                                                        
   401 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   402 │       │       │       │        │       │               │       │    def select(self, timeout=None):                                                                                                                                                                                                       
   403 │       │       │       │        │       │               │       │        # This is shared between poll() and epoll().                                                                                                                                                                                      
   404 │       │       │       │        │       │               │       │        # epoll() has a different signature and handling of timeout parameter.                                                                                                                                                            
   405 │       │       │       │        │       │               │       │        if timeout is None:                                                                                                                                                                                                               
   406 │       │       │       │        │       │               │       │            timeout = None                                                                                                                                                                                                                
   407 │       │       │       │        │       │               │       │        elif timeout <= 0:                                                                                                                                                                                                                
   408 │       │       │       │        │       │               │       │            timeout = 0                                                                                                                                                                                                                   
   409 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   410 │       │       │       │        │       │               │       │            # poll() has a resolution of 1 millisecond, round away from                                                                                                                                                                   
   411 │       │       │       │        │       │               │       │            # zero to wait *at least* timeout seconds.                                                                                                                                                                                    
   412 │       │       │       │        │       │               │       │            timeout = math.ceil(timeout * 1e3)                                                                                                                                                                                            
   413 │       │       │       │        │       │               │       │        ready = []                                                                                                                                                                                                                        
   414 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   415 │       │       │   3%  │        │       │               │       │            fd_event_list = self._selector.poll(timeout)                                                                                                                                                                                  
   416 │       │       │       │        │       │               │       │        except InterruptedError:                                                                                                                                                                                                          
   417 │       │       │       │        │       │               │       │            return ready                                                                                                                                                                                                                  
   418 │       │       │       │        │       │               │       │        for fd, event in fd_event_list:                                                                                                                                                                                                   
   419 │       │       │       │        │       │               │       │            events = 0                                                                                                                                                                                                                    
   420 │       │       │       │        │       │               │       │            if event & ~self._EVENT_READ:                                                                                                                                                                                                 
   421 │       │       │       │        │       │               │       │                events |= EVENT_WRITE                                                                                                                                                                                                     
   422 │       │       │       │        │       │               │       │            if event & ~self._EVENT_WRITE:                                                                                                                                                                                                
   423 │       │       │       │        │       │               │       │                events |= EVENT_READ                                                                                                                                                                                                      
   424 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   425 │       │       │       │        │       │               │       │            key = self._key_from_fd(fd)                                                                                                                                                                                                   
   426 │       │       │       │        │       │               │       │            if key:                                                                                                                                                                                                                       
   427 │       │       │       │        │       │               │       │                ready.append((key, events & key.events))                                                                                                                                                                                  
   428 │       │       │       │        │       │               │       │        return ready                                                                                                                                                                                                                      
   429 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   430 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   431 │       │       │       │        │       │               │       │if hasattr(select, 'poll'):                                                                                                                                                                                                               
   432 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   433 │       │       │       │        │       │               │       │    class PollSelector(_PollLikeSelector):                                                                                                                                                                                                
   434 │       │       │       │        │       │               │       │        """Poll-based selector."""                                                                                                                                                                                                        
   435 │       │       │       │        │       │               │       │        _selector_cls = select.poll                                                                                                                                                                                                       
   436 │       │       │       │        │       │               │       │        _EVENT_READ = select.POLLIN                                                                                                                                                                                                       
   437 │       │       │       │        │       │               │       │        _EVENT_WRITE = select.POLLOUT                                                                                                                                                                                                     
   438 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   439 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   440 │       │       │       │        │       │               │       │if hasattr(select, 'epoll'):                                                                                                                                                                                                              
   441 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   442 │       │       │       │        │       │               │       │    class EpollSelector(_PollLikeSelector):                                                                                                                                                                                               
   443 │       │       │       │        │       │               │       │        """Epoll-based selector."""                                                                                                                                                                                                       
   444 │       │       │       │        │       │               │       │        _selector_cls = select.epoll                                                                                                                                                                                                      
   445 │       │       │       │        │       │               │       │        _EVENT_READ = select.EPOLLIN                                                                                                                                                                                                      
   446 │       │       │       │        │       │               │       │        _EVENT_WRITE = select.EPOLLOUT                                                                                                                                                                                                    
   447 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   448 │       │       │       │        │       │               │       │        def fileno(self):                                                                                                                                                                                                                 
   449 │       │       │       │        │       │               │       │            return self._selector.fileno()                                                                                                                                                                                                
   450 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   451 │       │       │       │        │       │               │       │        def select(self, timeout=None):                                                                                                                                                                                                   
   452 │       │       │       │        │       │               │       │            if timeout is None:                                                                                                                                                                                                           
   453 │       │       │       │        │       │               │       │                timeout = -1                                                                                                                                                                                                              
   454 │       │       │       │        │       │               │       │            elif timeout <= 0:                                                                                                                                                                                                            
   455 │       │       │       │        │       │               │       │                timeout = 0                                                                                                                                                                                                               
   456 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   457 │       │       │       │        │       │               │       │                # epoll_wait() has a resolution of 1 millisecond, round away                                                                                                                                                              
   458 │       │       │       │        │       │               │       │                # from zero to wait *at least* timeout seconds.                                                                                                                                                                           
   459 │       │       │       │        │       │               │       │                timeout = math.ceil(timeout * 1e3) * 1e-3                                                                                                                                                                                 
   460 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   461 │       │       │       │        │       │               │       │            # epoll_wait() expects `maxevents` to be greater than zero;                                                                                                                                                                   
   462 │       │       │       │        │       │               │       │            # we want to make sure that `select()` can be called when no                                                                                                                                                                  
   463 │       │       │       │        │       │               │       │            # FD is registered.                                                                                                                                                                                                           
   464 │       │       │       │        │       │               │       │            max_ev = max(len(self._fd_to_key), 1)                                                                                                                                                                                         
   465 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   466 │       │       │       │        │       │               │       │            ready = []                                                                                                                                                                                                                    
   467 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
   468 │       │       │       │        │       │               │       │                fd_event_list = self._selector.poll(timeout, max_ev)                                                                                                                                                                      
   469 │       │       │       │        │       │               │       │            except InterruptedError:                                                                                                                                                                                                      
   470 │       │       │       │        │       │               │       │                return ready                                                                                                                                                                                                              
   471 │       │       │       │        │       │               │       │            for fd, event in fd_event_list:                                                                                                                                                                                               
   472 │       │       │       │        │       │               │       │                events = 0                                                                                                                                                                                                                
   473 │       │       │       │        │       │               │       │                if event & ~select.EPOLLIN:                                                                                                                                                                                               
   474 │       │       │       │        │       │               │       │                    events |= EVENT_WRITE                                                                                                                                                                                                 
   475 │       │       │       │        │       │               │       │                if event & ~select.EPOLLOUT:                                                                                                                                                                                              
   476 │       │       │       │        │       │               │       │                    events |= EVENT_READ                                                                                                                                                                                                  
   477 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   478 │       │       │       │        │       │               │       │                key = self._key_from_fd(fd)                                                                                                                                                                                               
   479 │       │       │       │        │       │               │       │                if key:                                                                                                                                                                                                                   
   480 │       │       │       │        │       │               │       │                    ready.append((key, events & key.events))                                                                                                                                                                              
   481 │       │       │       │        │       │               │       │            return ready                                                                                                                                                                                                                  
   482 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   483 │       │       │       │        │       │               │       │        def close(self):                                                                                                                                                                                                                  
   484 │       │       │       │        │       │               │       │            self._selector.close()                                                                                                                                                                                                        
   485 │       │       │       │        │       │               │       │            super().close()                                                                                                                                                                                                               
   486 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   487 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   488 │       │       │       │        │       │               │       │if hasattr(select, 'devpoll'):                                                                                                                                                                                                            
   489 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   490 │       │       │       │        │       │               │       │    class DevpollSelector(_PollLikeSelector):                                                                                                                                                                                             
   491 │       │       │       │        │       │               │       │        """Solaris /dev/poll selector."""                                                                                                                                                                                                 
   492 │       │       │       │        │       │               │       │        _selector_cls = select.devpoll                                                                                                                                                                                                    
   493 │       │       │       │        │       │               │       │        _EVENT_READ = select.POLLIN                                                                                                                                                                                                       
   494 │       │       │       │        │       │               │       │        _EVENT_WRITE = select.POLLOUT                                                                                                                                                                                                     
   495 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   496 │       │       │       │        │       │               │       │        def fileno(self):                                                                                                                                                                                                                 
   497 │       │       │       │        │       │               │       │            return self._selector.fileno()                                                                                                                                                                                                
   498 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   499 │       │       │       │        │       │               │       │        def close(self):                                                                                                                                                                                                                  
   500 │       │       │       │        │       │               │       │            self._selector.close()                                                                                                                                                                                                        
   501 │       │       │       │        │       │               │       │            super().close()                                                                                                                                                                                                               
   502 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   503 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   504 │       │       │       │        │       │               │       │if hasattr(select, 'kqueue'):                                                                                                                                                                                                             
   505 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   506 │       │       │       │        │       │               │       │    class KqueueSelector(_BaseSelectorImpl):                                                                                                                                                                                              
   507 │       │       │       │        │       │               │       │        """Kqueue-based selector."""                                                                                                                                                                                                      
   508 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   509 │       │       │       │        │       │               │       │        def __init__(self):                                                                                                                                                                                                               
   510 │       │       │       │        │       │               │       │            super().__init__()                                                                                                                                                                                                            
   511 │       │       │       │        │       │               │       │            self._selector = select.kqueue()                                                                                                                                                                                              
   512 │       │       │       │        │       │               │       │            self._max_events = 0                                                                                                                                                                                                          
   513 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   514 │       │       │       │        │       │               │       │        def fileno(self):                                                                                                                                                                                                                 
   515 │       │       │       │        │       │               │       │            return self._selector.fileno()                                                                                                                                                                                                
   516 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   517 │       │       │       │        │       │               │       │        def register(self, fileobj, events, data=None):                                                                                                                                                                                   
   518 │       │       │       │        │       │               │       │            key = super().register(fileobj, events, data)                                                                                                                                                                                 
   519 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
   520 │       │       │       │        │       │               │       │                if events & EVENT_READ:                                                                                                                                                                                                   
   521 │       │       │       │        │       │               │       │                    kev = select.kevent(key.fd, select.KQ_FILTER_READ,                                                                                                                                                                    
   522 │       │       │       │        │       │               │       │                                        select.KQ_EV_ADD)                                                                                                                                                                                 
   523 │       │       │       │        │       │               │       │                    self._selector.control([kev], 0, 0)                                                                                                                                                                                   
   524 │       │       │       │        │       │               │       │                    self._max_events += 1                                                                                                                                                                                                 
   525 │       │       │       │        │       │               │       │                if events & EVENT_WRITE:                                                                                                                                                                                                  
   526 │       │       │       │        │       │               │       │                    kev = select.kevent(key.fd, select.KQ_FILTER_WRITE,                                                                                                                                                                   
   527 │       │       │       │        │       │               │       │                                        select.KQ_EV_ADD)                                                                                                                                                                                 
   528 │       │       │       │        │       │               │       │                    self._selector.control([kev], 0, 0)                                                                                                                                                                                   
   529 │       │       │       │        │       │               │       │                    self._max_events += 1                                                                                                                                                                                                 
   530 │       │       │       │        │       │               │       │            except:                                                                                                                                                                                                                       
   531 │       │       │       │        │       │               │       │                super().unregister(fileobj)                                                                                                                                                                                               
   532 │       │       │       │        │       │               │       │                raise                                                                                                                                                                                                                     
   533 │       │       │       │        │       │               │       │            return key                                                                                                                                                                                                                    
   534 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   535 │       │       │       │        │       │               │       │        def unregister(self, fileobj):                                                                                                                                                                                                    
   536 │       │       │       │        │       │               │       │            key = super().unregister(fileobj)                                                                                                                                                                                             
   537 │       │       │       │        │       │               │       │            if key.events & EVENT_READ:                                                                                                                                                                                                   
   538 │       │       │       │        │       │               │       │                kev = select.kevent(key.fd, select.KQ_FILTER_READ,                                                                                                                                                                        
   539 │       │       │       │        │       │               │       │                                    select.KQ_EV_DELETE)                                                                                                                                                                                  
   540 │       │       │       │        │       │               │       │                self._max_events -= 1                                                                                                                                                                                                     
   541 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
   542 │       │       │       │        │       │               │       │                    self._selector.control([kev], 0, 0)                                                                                                                                                                                   
   543 │       │       │       │        │       │               │       │                except OSError:                                                                                                                                                                                                           
   544 │       │       │       │        │       │               │       │                    # This can happen if the FD was closed since it                                                                                                                                                                       
   545 │       │       │       │        │       │               │       │                    # was registered.                                                                                                                                                                                                     
   546 │       │       │       │        │       │               │       │                    pass                                                                                                                                                                                                                  
   547 │       │       │       │        │       │               │       │            if key.events & EVENT_WRITE:                                                                                                                                                                                                  
   548 │       │       │       │        │       │               │       │                kev = select.kevent(key.fd, select.KQ_FILTER_WRITE,                                                                                                                                                                       
   549 │       │       │       │        │       │               │       │                                    select.KQ_EV_DELETE)                                                                                                                                                                                  
   550 │       │       │       │        │       │               │       │                self._max_events -= 1                                                                                                                                                                                                     
   551 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
   552 │       │       │       │        │       │               │       │                    self._selector.control([kev], 0, 0)                                                                                                                                                                                   
   553 │       │       │       │        │       │               │       │                except OSError:                                                                                                                                                                                                           
   554 │       │       │       │        │       │               │       │                    # See comment above.                                                                                                                                                                                                  
   555 │       │       │       │        │       │               │       │                    pass                                                                                                                                                                                                                  
   556 │       │       │       │        │       │               │       │            return key                                                                                                                                                                                                                    
   557 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   558 │       │       │       │        │       │               │       │        def select(self, timeout=None):                                                                                                                                                                                                   
   559 │       │       │       │        │       │               │       │            timeout = None if timeout is None else max(timeout, 0)                                                                                                                                                                        
   560 │       │       │       │        │       │               │       │            # If max_ev is 0, kqueue will ignore the timeout. For consistent                                                                                                                                                              
   561 │       │       │       │        │       │               │       │            # behavior with the other selector classes, we prevent that here                                                                                                                                                              
   562 │       │       │       │        │       │               │       │            # (using max). See https://bugs.python.org/issue29255                                                                                                                                                                         
   563 │       │       │       │        │       │               │       │            max_ev = self._max_events or 1                                                                                                                                                                                                
   564 │       │       │       │        │       │               │       │            ready = []                                                                                                                                                                                                                    
   565 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
   566 │       │       │       │        │       │               │       │                kev_list = self._selector.control(None, max_ev, timeout)                                                                                                                                                                  
   567 │       │       │       │        │       │               │       │            except InterruptedError:                                                                                                                                                                                                      
   568 │       │       │       │        │       │               │       │                return ready                                                                                                                                                                                                              
   569 │       │       │       │        │       │               │       │            for kev in kev_list:                                                                                                                                                                                                          
   570 │       │       │       │        │       │               │       │                fd = kev.ident                                                                                                                                                                                                            
   571 │       │       │       │        │       │               │       │                flag = kev.filter                                                                                                                                                                                                         
   572 │       │       │       │        │       │               │       │                events = 0                                                                                                                                                                                                                
   573 │       │       │       │        │       │               │       │                if flag == select.KQ_FILTER_READ:                                                                                                                                                                                         
   574 │       │       │       │        │       │               │       │                    events |= EVENT_READ                                                                                                                                                                                                  
   575 │       │       │       │        │       │               │       │                if flag == select.KQ_FILTER_WRITE:                                                                                                                                                                                        
   576 │       │       │       │        │       │               │       │                    events |= EVENT_WRITE                                                                                                                                                                                                 
   577 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   578 │       │       │       │        │       │               │       │                key = self._key_from_fd(fd)                                                                                                                                                                                               
   579 │       │       │       │        │       │               │       │                if key:                                                                                                                                                                                                                   
   580 │       │       │       │        │       │               │       │                    ready.append((key, events & key.events))                                                                                                                                                                              
   581 │       │       │       │        │       │               │       │            return ready                                                                                                                                                                                                                  
   582 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   583 │       │       │       │        │       │               │       │        def close(self):                                                                                                                                                                                                                  
   584 │       │       │       │        │       │               │       │            self._selector.close()                                                                                                                                                                                                        
   585 │       │       │       │        │       │               │       │            super().close()                                                                                                                                                                                                               
   586 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   587 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   588 │       │       │       │        │       │               │       │def _can_use(method):                                                                                                                                                                                                                     
   589 │       │       │       │        │       │               │       │    """Check if we can use the selector depending upon the                                                                                                                                                                                
   590 │       │       │       │        │       │               │       │    operating system. """                                                                                                                                                                                                                 
   591 │       │       │       │        │       │               │       │    # Implementation based upon https://github.com/sethmlarson/selectors2/blob/master/selectors2.py                                                                                                                                       
   592 │       │       │       │        │       │               │       │    selector = getattr(select, method, None)                                                                                                                                                                                              
   593 │       │       │       │        │       │               │       │    if selector is None:                                                                                                                                                                                                                  
   594 │       │       │       │        │       │               │       │        # select module does not implement method                                                                                                                                                                                         
   595 │       │       │       │        │       │               │       │        return False                                                                                                                                                                                                                      
   596 │       │       │       │        │       │               │       │    # check if the OS and Kernel actually support the method. Call may fail with                                                                                                                                                          
   597 │       │       │       │        │       │               │       │    # OSError: [Errno 38] Function not implemented                                                                                                                                                                                        
   598 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   599 │       │       │       │        │       │               │       │        selector_obj = selector()                                                                                                                                                                                                         
   600 │       │       │       │        │       │               │       │        if method == 'poll':                                                                                                                                                                                                              
   601 │       │       │       │        │       │               │       │            # check that poll actually works                                                                                                                                                                                              
   602 │       │       │       │        │       │               │       │            selector_obj.poll(0)                                                                                                                                                                                                          
   603 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   604 │       │       │       │        │       │               │       │            # close epoll, kqueue, and devpoll fd                                                                                                                                                                                         
   605 │       │       │       │        │       │               │       │            selector_obj.close()                                                                                                                                                                                                          
   606 │       │       │       │        │       │               │       │        return True                                                                                                                                                                                                                       
   607 │       │       │       │        │       │               │       │    except OSError:                                                                                                                                                                                                                       
   608 │       │       │       │        │       │               │       │        return False                                                                                                                                                                                                                      
   609 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   610 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   611 │       │       │       │        │       │               │       │# Choose the best implementation, roughly:                                                                                                                                                                                                
   612 │       │       │       │        │       │               │       │#    epoll|kqueue|devpoll > poll > select.                                                                                                                                                                                                
   613 │       │       │       │        │       │               │       │# select() also can't accept a FD > FD_SETSIZE (usually around 1024)                                                                                                                                                                      
   614 │       │       │       │        │       │               │       │if _can_use('kqueue'):                                                                                                                                                                                                                    
   615 │       │       │       │        │       │               │       │    DefaultSelector = KqueueSelector                                                                                                                                                                                                      
   616 │       │       │       │        │       │               │       │elif _can_use('epoll'):                                                                                                                                                                                                                   
   617 │       │       │       │        │       │               │       │    DefaultSelector = EpollSelector                                                                                                                                                                                                       
   618 │       │       │       │        │       │               │       │elif _can_use('devpoll'):                                                                                                                                                                                                                 
   619 │       │       │       │        │       │               │       │    DefaultSelector = DevpollSelector                                                                                                                                                                                                     
   620 │       │       │       │        │       │               │       │elif _can_use('poll'):                                                                                                                                                                                                                    
   621 │       │       │       │        │       │               │       │    DefaultSelector = PollSelector                                                                                                                                                                                                        
   622 │       │       │       │        │       │               │       │else:                                                                                                                                                                                                                                     
   623 │       │       │       │        │       │               │       │    DefaultSelector = SelectSelector                                                                                                                                                                                                      
   624 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
╶──────┼───────┼───────┼───────┼────────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │       │        │       │               │       │function summary for /p/software/juwels/stages/2025/software/Python/3.12.3-GCCcore-13.3.0/lib/python3.12/selectors.py                                                                                                                     
   402 │       │       │   3%  │        │       │               │       │_PollLikeSelector.select                                                                                                                                                                                                                  
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
                                                                       /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/.venv/lib/python3.12/site-packages/PIL/ImageFile.py: % of time =   1.62% (1.597s) out of 2m:38.834s.                                                                       
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/.venv/lib/python3.12/site-packages/PIL/ImageFile.py                                                                                                                      
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     2 │       │       │       │        │       │               │       │# The Python Imaging Library.                                                                                                                                                                                                             
     3 │       │       │       │        │       │               │       │# $Id$                                                                                                                                                                                                                                    
     4 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     5 │       │       │       │        │       │               │       │# base class for image file handlers                                                                                                                                                                                                      
     6 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     7 │       │       │       │        │       │               │       │# history:                                                                                                                                                                                                                                
     8 │       │       │       │        │       │               │       │# 1995-09-09 fl   Created                                                                                                                                                                                                                 
     9 │       │       │       │        │       │               │       │# 1996-03-11 fl   Fixed load mechanism.                                                                                                                                                                                                   
    10 │       │       │       │        │       │               │       │# 1996-04-15 fl   Added pcx/xbm decoders.                                                                                                                                                                                                 
    11 │       │       │       │        │       │               │       │# 1996-04-30 fl   Added encoders.                                                                                                                                                                                                         
    12 │       │       │       │        │       │               │       │# 1996-12-14 fl   Added load helpers                                                                                                                                                                                                      
    13 │       │       │       │        │       │               │       │# 1997-01-11 fl   Use encode_to_file where possible                                                                                                                                                                                       
    14 │       │       │       │        │       │               │       │# 1997-08-27 fl   Flush output in _save                                                                                                                                                                                                   
    15 │       │       │       │        │       │               │       │# 1998-03-05 fl   Use memory mapping for some modes                                                                                                                                                                                       
    16 │       │       │       │        │       │               │       │# 1999-02-04 fl   Use memory mapping also for "I;16" and "I;16B"                                                                                                                                                                          
    17 │       │       │       │        │       │               │       │# 1999-05-31 fl   Added image parser                                                                                                                                                                                                      
    18 │       │       │       │        │       │               │       │# 2000-10-12 fl   Set readonly flag on memory-mapped images                                                                                                                                                                               
    19 │       │       │       │        │       │               │       │# 2002-03-20 fl   Use better messages for common decoder errors                                                                                                                                                                           
    20 │       │       │       │        │       │               │       │# 2003-04-21 fl   Fall back on mmap/map_buffer if map is not available                                                                                                                                                                    
    21 │       │       │       │        │       │               │       │# 2003-10-30 fl   Added StubImageFile class                                                                                                                                                                                               
    22 │       │       │       │        │       │               │       │# 2004-02-25 fl   Made incremental parser more robust                                                                                                                                                                                     
    23 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
    24 │       │       │       │        │       │               │       │# Copyright (c) 1997-2004 by Secret Labs AB                                                                                                                                                                                               
    25 │       │       │       │        │       │               │       │# Copyright (c) 1995-2004 by Fredrik Lundh                                                                                                                                                                                                
    26 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
    27 │       │       │       │        │       │               │       │# See the README file for information on usage and redistribution.                                                                                                                                                                        
    28 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
    29 │       │       │       │        │       │               │       │from __future__ import annotations                                                                                                                                                                                                        
    30 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    31 │       │       │       │        │       │               │       │import abc                                                                                                                                                                                                                                
    32 │       │       │       │        │       │               │       │import io                                                                                                                                                                                                                                 
    33 │       │       │       │        │       │               │       │import itertools                                                                                                                                                                                                                          
    34 │       │       │       │        │       │               │       │import logging                                                                                                                                                                                                                            
    35 │       │       │       │        │       │               │       │import os                                                                                                                                                                                                                                 
    36 │       │       │       │        │       │               │       │import struct                                                                                                                                                                                                                             
    37 │       │       │       │        │       │               │       │from typing import IO, Any, NamedTuple, cast                                                                                                                                                                                              
    38 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    39 │       │       │       │        │       │               │       │from . import ExifTags, Image                                                                                                                                                                                                             
    40 │       │       │       │        │       │               │       │from ._deprecate import deprecate                                                                                                                                                                                                         
    41 │       │       │       │        │       │               │       │from ._util import DeferredError, is_path                                                                                                                                                                                                 
    42 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    43 │       │       │       │        │       │               │       │TYPE_CHECKING = False                                                                                                                                                                                                                     
    44 │       │       │       │        │       │               │       │if TYPE_CHECKING:                                                                                                                                                                                                                         
    45 │       │       │       │        │       │               │       │    from ._typing import StrOrBytesPath                                                                                                                                                                                                   
    46 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    47 │       │       │       │        │       │               │       │logger = logging.getLogger(__name__)                                                                                                                                                                                                      
    48 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    49 │       │       │       │        │       │               │       │MAXBLOCK = 65536                                                                                                                                                                                                                          
    50 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    51 │       │       │       │        │       │               │       │SAFEBLOCK = 1024 * 1024                                                                                                                                                                                                                   
    52 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    53 │       │       │       │        │       │               │       │LOAD_TRUNCATED_IMAGES = False                                                                                                                                                                                                             
    54 │       │       │       │        │       │               │       │"""Whether or not to load truncated image files. User code may change this."""                                                                                                                                                            
    55 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    56 │       │       │       │        │       │               │       │ERRORS = {                                                                                                                                                                                                                                
    57 │       │       │       │        │       │               │       │    -1: "image buffer overrun error",                                                                                                                                                                                                     
    58 │       │       │       │        │       │               │       │    -2: "decoding error",                                                                                                                                                                                                                 
    59 │       │       │       │        │       │               │       │    -3: "unknown error",                                                                                                                                                                                                                  
    60 │       │       │       │        │       │               │       │    -8: "bad configuration",                                                                                                                                                                                                              
    61 │       │       │       │        │       │               │       │    -9: "out of memory error",                                                                                                                                                                                                            
    62 │       │       │       │        │       │               │       │}                                                                                                                                                                                                                                         
    63 │       │       │       │        │       │               │       │"""                                                                                                                                                                                                                                       
    64 │       │       │       │        │       │               │       │Dict of known error codes returned from :meth:`.PyDecoder.decode`,                                                                                                                                                                        
    65 │       │       │       │        │       │               │       │:meth:`.PyEncoder.encode` :meth:`.PyEncoder.encode_to_pyfd` and                                                                                                                                                                           
    66 │       │       │       │        │       │               │       │:meth:`.PyEncoder.encode_to_file`.                                                                                                                                                                                                        
    67 │       │       │       │        │       │               │       │"""                                                                                                                                                                                                                                       
    68 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    69 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    70 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
    71 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
    72 │       │       │       │        │       │               │       │# Helpers                                                                                                                                                                                                                                 
    73 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    74 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    75 │       │       │       │        │       │               │       │def _get_oserror(error: int, *, encoder: bool) -> OSError:                                                                                                                                                                                
    76 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
    77 │       │       │       │        │       │               │       │        msg = Image.core.getcodecstatus(error)                                                                                                                                                                                            
    78 │       │       │       │        │       │               │       │    except AttributeError:                                                                                                                                                                                                                
    79 │       │       │       │        │       │               │       │        msg = ERRORS.get(error)                                                                                                                                                                                                           
    80 │       │       │       │        │       │               │       │    if not msg:                                                                                                                                                                                                                           
    81 │       │       │       │        │       │               │       │        msg = f"{'encoder' if encoder else 'decoder'} error {error}"                                                                                                                                                                      
    82 │       │       │       │        │       │               │       │    msg += f" when {'writing' if encoder else 'reading'} image file"                                                                                                                                                                      
    83 │       │       │       │        │       │               │       │    return OSError(msg)                                                                                                                                                                                                                   
    84 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    85 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    86 │       │       │       │        │       │               │       │def raise_oserror(error: int) -> OSError:                                                                                                                                                                                                 
    87 │       │       │       │        │       │               │       │    deprecate(                                                                                                                                                                                                                            
    88 │       │       │       │        │       │               │       │        "raise_oserror",                                                                                                                                                                                                                  
    89 │       │       │       │        │       │               │       │        12,                                                                                                                                                                                                                               
    90 │       │       │       │        │       │               │       │        action="It is only useful for translating error codes returned by a codec's "                                                                                                                                                     
    91 │       │       │       │        │       │               │       │        "decode() method, which ImageFile already does automatically.",                                                                                                                                                                   
    92 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
    93 │       │       │       │        │       │               │       │    raise _get_oserror(error, encoder=False)                                                                                                                                                                                              
    94 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    95 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    96 │       │       │       │        │       │               │       │def _tilesort(t: _Tile) -> int:                                                                                                                                                                                                           
    97 │       │       │       │        │       │               │       │    # sort on offset                                                                                                                                                                                                                      
    98 │       │       │       │        │       │               │       │    return t[2]                                                                                                                                                                                                                           
    99 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   100 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   101 │       │       │       │        │       │               │       │class _Tile(NamedTuple):                                                                                                                                                                                                                  
   102 │       │       │       │        │       │               │       │    codec_name: str                                                                                                                                                                                                                       
   103 │       │       │       │        │       │               │       │    extents: tuple[int, int, int, int] | None                                                                                                                                                                                             
   104 │       │       │       │        │       │               │       │    offset: int = 0                                                                                                                                                                                                                       
   105 │       │       │       │        │       │               │       │    args: tuple[Any, ...] | str | None = None                                                                                                                                                                                             
   106 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   107 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   108 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
   109 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
   110 │       │       │       │        │       │               │       │# ImageFile base class                                                                                                                                                                                                                    
   111 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   112 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   113 │       │       │       │        │       │               │       │class ImageFile(Image.Image):                                                                                                                                                                                                             
   114 │       │       │       │        │       │               │       │    """Base class for image file format handlers."""                                                                                                                                                                                      
   115 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   116 │       │       │       │        │       │               │       │    def __init__(                                                                                                                                                                                                                         
   117 │       │       │       │        │       │               │       │        self, fp: StrOrBytesPath | IO[bytes], filename: str | bytes | None = None                                                                                                                                                         
   118 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
   119 │       │       │       │        │       │               │       │        super().__init__()                                                                                                                                                                                                                
   120 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   121 │       │       │       │        │       │               │       │        self._min_frame = 0                                                                                                                                                                                                               
   122 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   123 │       │       │       │        │       │               │       │        self.custom_mimetype: str | None = None                                                                                                                                                                                           
   124 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   125 │       │       │       │        │       │               │       │        self.tile: list[_Tile] = []                                                                                                                                                                                                       
   126 │       │       │       │        │       │               │       │        """ A list of tile descriptors """                                                                                                                                                                                                
   127 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   128 │       │       │       │        │       │               │       │        self.readonly = 1  # until we know better                                                                                                                                                                                         
   129 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   130 │       │       │       │        │       │               │       │        self.decoderconfig: tuple[Any, ...] = ()                                                                                                                                                                                          
   131 │       │       │       │        │       │               │       │        self.decodermaxblock = MAXBLOCK                                                                                                                                                                                                   
   132 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   133 │       │       │       │        │       │               │       │        if is_path(fp):                                                                                                                                                                                                                   
   134 │       │       │       │        │       │               │       │            # filename                                                                                                                                                                                                                    
   135 │       │       │       │        │       │               │       │            self.fp = open(fp, "rb")                                                                                                                                                                                                      
   136 │       │       │       │        │       │               │       │            self.filename = os.fspath(fp)                                                                                                                                                                                                 
   137 │       │       │       │        │       │               │       │            self._exclusive_fp = True                                                                                                                                                                                                     
   138 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   139 │       │       │       │        │       │               │       │            # stream                                                                                                                                                                                                                      
   140 │       │       │       │        │       │               │       │            self.fp = cast(IO[bytes], fp)                                                                                                                                                                                                 
   141 │       │       │       │        │       │               │       │            self.filename = filename if filename is not None else ""                                                                                                                                                                      
   142 │       │       │       │        │       │               │       │            # can be overridden                                                                                                                                                                                                           
   143 │       │       │       │        │       │               │       │            self._exclusive_fp = False                                                                                                                                                                                                    
   144 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   145 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   146 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
   147 │       │       │       │        │       │               │       │                self._open()                                                                                                                                                                                                              
   148 │       │       │       │        │       │               │       │            except (                                                                                                                                                                                                                      
   149 │       │       │       │        │       │               │       │                IndexError,  # end of data                                                                                                                                                                                                
   150 │       │       │       │        │       │               │       │                TypeError,  # end of data (ord)                                                                                                                                                                                           
   151 │       │       │       │        │       │               │       │                KeyError,  # unsupported mode                                                                                                                                                                                             
   152 │       │       │       │        │       │               │       │                EOFError,  # got header but not the first frame                                                                                                                                                                           
   153 │       │       │       │        │       │               │       │                struct.error,                                                                                                                                                                                                             
   154 │       │       │       │        │       │               │       │            ) as v:                                                                                                                                                                                                                       
   155 │       │       │       │        │       │               │       │                raise SyntaxError(v) from v                                                                                                                                                                                               
   156 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   157 │       │       │       │        │       │               │       │            if not self.mode or self.size[0] <= 0 or self.size[1] <= 0:                                                                                                                                                                   
   158 │       │       │       │        │       │               │       │                msg = "not identified by this driver"                                                                                                                                                                                     
   159 │       │       │       │        │       │               │       │                raise SyntaxError(msg)                                                                                                                                                                                                    
   160 │       │       │       │        │       │               │       │        except BaseException:                                                                                                                                                                                                             
   161 │       │       │       │        │       │               │       │            # close the file only if we have opened it this constructor                                                                                                                                                                   
   162 │       │       │       │        │       │               │       │            if self._exclusive_fp:                                                                                                                                                                                                        
   163 │       │       │       │        │       │               │       │                self.fp.close()                                                                                                                                                                                                           
   164 │       │       │       │        │       │               │       │            raise                                                                                                                                                                                                                         
   165 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   166 │       │       │       │        │       │               │       │    def _open(self) -> None:                                                                                                                                                                                                              
   167 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   168 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   169 │       │       │       │        │       │               │       │    def _close_fp(self):                                                                                                                                                                                                                  
   170 │       │       │       │        │       │               │       │        if getattr(self, "_fp", False) and not isinstance(self._fp, DeferredError):                                                                                                                                                       
   171 │       │       │       │        │       │               │       │            if self._fp != self.fp:                                                                                                                                                                                                       
   172 │       │       │       │        │       │               │       │                self._fp.close()                                                                                                                                                                                                          
   173 │       │       │       │        │       │               │       │            self._fp = DeferredError(ValueError("Operation on closed image"))                                                                                                                                                             
   174 │       │       │       │        │       │               │       │        if self.fp:                                                                                                                                                                                                                       
   175 │       │       │       │        │       │               │       │            self.fp.close()                                                                                                                                                                                                               
   176 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   177 │       │       │       │        │       │               │       │    def close(self) -> None:                                                                                                                                                                                                              
   178 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   179 │       │       │       │        │       │               │       │        Closes the file pointer, if possible.                                                                                                                                                                                             
   180 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   181 │       │       │       │        │       │               │       │        This operation will destroy the image core and release its memory.                                                                                                                                                                
   182 │       │       │       │        │       │               │       │        The image data will be unusable afterward.                                                                                                                                                                                        
   183 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   184 │       │       │       │        │       │               │       │        This function is required to close images that have multiple frames or                                                                                                                                                            
   185 │       │       │       │        │       │               │       │        have not had their file read and closed by the                                                                                                                                                                                    
   186 │       │       │       │        │       │               │       │        :py:meth:`~PIL.Image.Image.load` method. See :ref:`file-handling` for                                                                                                                                                             
   187 │       │       │       │        │       │               │       │        more information.                                                                                                                                                                                                                 
   188 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   189 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   190 │       │       │       │        │       │               │       │            self._close_fp()                                                                                                                                                                                                              
   191 │       │       │       │        │       │               │       │            self.fp = None                                                                                                                                                                                                                
   192 │       │       │       │        │       │               │       │        except Exception as msg:                                                                                                                                                                                                          
   193 │       │       │       │        │       │               │       │            logger.debug("Error closing: %s", msg)                                                                                                                                                                                        
   194 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   195 │       │       │       │        │       │               │       │        super().close()                                                                                                                                                                                                                   
   196 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   197 │       │       │       │        │       │               │       │    def get_child_images(self) -> list[ImageFile]:                                                                                                                                                                                        
   198 │       │       │       │        │       │               │       │        child_images = []                                                                                                                                                                                                                 
   199 │       │       │       │        │       │               │       │        exif = self.getexif()                                                                                                                                                                                                             
   200 │       │       │       │        │       │               │       │        ifds = []                                                                                                                                                                                                                         
   201 │       │       │       │        │       │               │       │        if ExifTags.Base.SubIFDs in exif:                                                                                                                                                                                                 
   202 │       │       │       │        │       │               │       │            subifd_offsets = exif[ExifTags.Base.SubIFDs]                                                                                                                                                                                  
   203 │       │       │       │        │       │               │       │            if subifd_offsets:                                                                                                                                                                                                            
   204 │       │       │       │        │       │               │       │                if not isinstance(subifd_offsets, tuple):                                                                                                                                                                                 
   205 │       │       │       │        │       │               │       │                    subifd_offsets = (subifd_offsets,)                                                                                                                                                                                    
   206 │       │       │       │        │       │               │       │                for subifd_offset in subifd_offsets:                                                                                                                                                                                      
   207 │       │       │       │        │       │               │       │                    ifds.append((exif._get_ifd_dict(subifd_offset), subifd_offset))                                                                                                                                                       
   208 │       │       │       │        │       │               │       │        ifd1 = exif.get_ifd(ExifTags.IFD.IFD1)                                                                                                                                                                                            
   209 │       │       │       │        │       │               │       │        if ifd1 and ifd1.get(ExifTags.Base.JpegIFOffset):                                                                                                                                                                                 
   210 │       │       │       │        │       │               │       │            assert exif._info is not None                                                                                                                                                                                                 
   211 │       │       │       │        │       │               │       │            ifds.append((ifd1, exif._info.next))                                                                                                                                                                                          
   212 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   213 │       │       │       │        │       │               │       │        offset = None                                                                                                                                                                                                                     
   214 │       │       │       │        │       │               │       │        for ifd, ifd_offset in ifds:                                                                                                                                                                                                      
   215 │       │       │       │        │       │               │       │            assert self.fp is not None                                                                                                                                                                                                    
   216 │       │       │       │        │       │               │       │            current_offset = self.fp.tell()                                                                                                                                                                                               
   217 │       │       │       │        │       │               │       │            if offset is None:                                                                                                                                                                                                            
   218 │       │       │       │        │       │               │       │                offset = current_offset                                                                                                                                                                                                   
   219 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   220 │       │       │       │        │       │               │       │            fp = self.fp                                                                                                                                                                                                                  
   221 │       │       │       │        │       │               │       │            if ifd is not None:                                                                                                                                                                                                           
   222 │       │       │       │        │       │               │       │                thumbnail_offset = ifd.get(ExifTags.Base.JpegIFOffset)                                                                                                                                                                    
   223 │       │       │       │        │       │               │       │                if thumbnail_offset is not None:                                                                                                                                                                                          
   224 │       │       │       │        │       │               │       │                    thumbnail_offset += getattr(self, "_exif_offset", 0)                                                                                                                                                                  
   225 │       │       │       │        │       │               │       │                    self.fp.seek(thumbnail_offset)                                                                                                                                                                                        
   226 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   227 │       │       │       │        │       │               │       │                    length = ifd.get(ExifTags.Base.JpegIFByteCount)                                                                                                                                                                       
   228 │       │       │       │        │       │               │       │                    assert isinstance(length, int)                                                                                                                                                                                        
   229 │       │       │       │        │       │               │       │                    data = self.fp.read(length)                                                                                                                                                                                           
   230 │       │       │       │        │       │               │       │                    fp = io.BytesIO(data)                                                                                                                                                                                                 
   231 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   232 │       │       │       │        │       │               │       │            with Image.open(fp) as im:                                                                                                                                                                                                    
   233 │       │       │       │        │       │               │       │                from . import TiffImagePlugin                                                                                                                                                                                             
   234 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   235 │       │       │       │        │       │               │       │                if thumbnail_offset is None and isinstance(                                                                                                                                                                               
   236 │       │       │       │        │       │               │       │                    im, TiffImagePlugin.TiffImageFile                                                                                                                                                                                     
   237 │       │       │       │        │       │               │       │                ):                                                                                                                                                                                                                        
   238 │       │       │       │        │       │               │       │                    im._frame_pos = [ifd_offset]                                                                                                                                                                                          
   239 │       │       │       │        │       │               │       │                    im._seek(0)                                                                                                                                                                                                           
   240 │       │       │       │        │       │               │       │                im.load()                                                                                                                                                                                                                 
   241 │       │       │       │        │       │               │       │                child_images.append(im)                                                                                                                                                                                                   
   242 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   243 │       │       │       │        │       │               │       │        if offset is not None:                                                                                                                                                                                                            
   244 │       │       │       │        │       │               │       │            assert self.fp is not None                                                                                                                                                                                                    
   245 │       │       │       │        │       │               │       │            self.fp.seek(offset)                                                                                                                                                                                                          
   246 │       │       │       │        │       │               │       │        return child_images                                                                                                                                                                                                               
   247 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   248 │       │       │       │        │       │               │       │    def get_format_mimetype(self) -> str | None:                                                                                                                                                                                          
   249 │       │       │       │        │       │               │       │        if self.custom_mimetype:                                                                                                                                                                                                          
   250 │       │       │       │        │       │               │       │            return self.custom_mimetype                                                                                                                                                                                                   
   251 │       │       │       │        │       │               │       │        if self.format is not None:                                                                                                                                                                                                       
   252 │       │       │       │        │       │               │       │            return Image.MIME.get(self.format.upper())                                                                                                                                                                                    
   253 │       │       │       │        │       │               │       │        return None                                                                                                                                                                                                                       
   254 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   255 │       │       │       │        │       │               │       │    def __getstate__(self) -> list[Any]:                                                                                                                                                                                                  
   256 │       │       │       │        │       │               │       │        return super().__getstate__() + [self.filename]                                                                                                                                                                                   
   257 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   258 │       │       │       │        │       │               │       │    def __setstate__(self, state: list[Any]) -> None:                                                                                                                                                                                     
   259 │       │       │       │        │       │               │       │        self.tile = []                                                                                                                                                                                                                    
   260 │       │       │       │        │       │               │       │        self.filename = state[5]                                                                                                                                                                                                          
   261 │       │       │       │        │       │               │       │        super().__setstate__(state)                                                                                                                                                                                                       
   262 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   263 │       │       │       │        │       │               │       │    def verify(self) -> None:                                                                                                                                                                                                             
   264 │       │       │       │        │       │               │       │        """Check file integrity"""                                                                                                                                                                                                        
   265 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   266 │       │       │       │        │       │               │       │        # raise exception if something's wrong.  must be called                                                                                                                                                                           
   267 │       │       │       │        │       │               │       │        # directly after open, and closes file when finished.                                                                                                                                                                             
   268 │       │       │       │        │       │               │       │        if self._exclusive_fp:                                                                                                                                                                                                            
   269 │       │       │       │        │       │               │       │            self.fp.close()                                                                                                                                                                                                               
   270 │       │       │       │        │       │               │       │        self.fp = None                                                                                                                                                                                                                    
   271 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   272 │       │       │       │        │       │               │       │    def load(self) -> Image.core.PixelAccess | None:                                                                                                                                                                                      
   273 │       │       │       │        │       │               │       │        """Load image data based on tile list"""                                                                                                                                                                                          
   274 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   275 │       │       │       │        │       │               │       │        if not self.tile and self._im is None:                                                                                                                                                                                            
   276 │       │       │       │        │       │               │       │            msg = "cannot load this image"                                                                                                                                                                                                
   277 │       │       │       │        │       │               │       │            raise OSError(msg)                                                                                                                                                                                                            
   278 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   279 │       │       │       │        │       │               │       │        pixel = Image.Image.load(self)                                                                                                                                                                                                    
   280 │       │       │       │        │       │               │       │        if not self.tile:                                                                                                                                                                                                                 
   281 │       │       │       │        │       │               │       │            return pixel                                                                                                                                                                                                                  
   282 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   283 │       │       │       │        │       │               │       │        self.map: mmap.mmap | None = None                                                                                                                                                                                                 
   284 │       │       │       │        │       │               │       │        use_mmap = self.filename and len(self.tile) == 1                                                                                                                                                                                  
   285 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   286 │       │       │       │        │       │               │       │        readonly = 0                                                                                                                                                                                                                      
   287 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   288 │       │       │       │        │       │               │       │        # look for read/seek overrides                                                                                                                                                                                                    
   289 │       │       │       │        │       │               │       │        if hasattr(self, "load_read"):                                                                                                                                                                                                    
   290 │       │       │       │        │       │               │       │            read = self.load_read                                                                                                                                                                                                         
   291 │       │       │       │        │       │               │       │            # don't use mmap if there are custom read/seek functions                                                                                                                                                                      
   292 │       │       │       │        │       │               │       │            use_mmap = False                                                                                                                                                                                                              
   293 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   294 │       │       │       │        │       │               │       │            read = self.fp.read                                                                                                                                                                                                           
   295 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   296 │       │       │       │        │       │               │       │        if hasattr(self, "load_seek"):                                                                                                                                                                                                    
   297 │       │       │       │        │       │               │       │            seek = self.load_seek                                                                                                                                                                                                         
   298 │       │       │       │        │       │               │       │            use_mmap = False                                                                                                                                                                                                              
   299 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   300 │       │       │       │        │       │               │       │            seek = self.fp.seek                                                                                                                                                                                                           
   301 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   302 │       │       │       │        │       │               │       │        if use_mmap:                                                                                                                                                                                                                      
   303 │       │       │       │        │       │               │       │            # try memory mapping                                                                                                                                                                                                          
   304 │       │       │       │        │       │               │       │            decoder_name, extents, offset, args = self.tile[0]                                                                                                                                                                            
   305 │       │       │       │        │       │               │       │            if isinstance(args, str):                                                                                                                                                                                                     
   306 │       │       │       │        │       │               │       │                args = (args, 0, 1)                                                                                                                                                                                                       
   307 │       │       │       │        │       │               │       │            if (                                                                                                                                                                                                                          
   308 │       │       │       │        │       │               │       │                decoder_name == "raw"                                                                                                                                                                                                     
   309 │       │       │       │        │       │               │       │                and isinstance(args, tuple)                                                                                                                                                                                               
   310 │       │       │       │        │       │               │       │                and len(args) >= 3                                                                                                                                                                                                        
   311 │       │       │       │        │       │               │       │                and args[0] == self.mode                                                                                                                                                                                                  
   312 │       │       │       │        │       │               │       │                and args[0] in Image._MAPMODES                                                                                                                                                                                            
   313 │       │       │       │        │       │               │       │            ):                                                                                                                                                                                                                            
   314 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
   315 │       │       │       │        │       │               │       │                    # use mmap, if possible                                                                                                                                                                                               
   316 │       │       │       │        │       │               │       │                    import mmap                                                                                                                                                                                                           
   317 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   318 │       │       │       │        │       │               │       │                    with open(self.filename) as fp:                                                                                                                                                                                       
   319 │       │       │       │        │       │               │       │                        self.map = mmap.mmap(fp.fileno(), 0, access=mmap.ACCESS_READ)                                                                                                                                                     
   320 │       │       │       │        │       │               │       │                    if offset + self.size[1] * args[1] > self.map.size():                                                                                                                                                                 
   321 │       │       │       │        │       │               │       │                        msg = "buffer is not large enough"                                                                                                                                                                                
   322 │       │       │       │        │       │               │       │                        raise OSError(msg)                                                                                                                                                                                                
   323 │       │       │       │        │       │               │       │                    self.im = Image.core.map_buffer(                                                                                                                                                                                      
   324 │       │       │       │        │       │               │       │                        self.map, self.size, decoder_name, offset, args                                                                                                                                                                   
   325 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
   326 │       │       │       │        │       │               │       │                    readonly = 1                                                                                                                                                                                                          
   327 │       │       │       │        │       │               │       │                    # After trashing self.im,                                                                                                                                                                                             
   328 │       │       │       │        │       │               │       │                    # we might need to reload the palette data.                                                                                                                                                                           
   329 │       │       │       │        │       │               │       │                    if self.palette:                                                                                                                                                                                                      
   330 │       │       │       │        │       │               │       │                        self.palette.dirty = 1                                                                                                                                                                                            
   331 │       │       │       │        │       │               │       │                except (AttributeError, OSError, ImportError):                                                                                                                                                                            
   332 │       │       │       │        │       │               │       │                    self.map = None                                                                                                                                                                                                       
   333 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   334 │       │       │       │        │       │               │       │        self.load_prepare()                                                                                                                                                                                                               
   335 │       │       │       │        │       │               │       │        err_code = -3  # initialize to unknown error                                                                                                                                                                                      
   336 │       │       │       │        │       │               │       │        if not self.map:                                                                                                                                                                                                                  
   337 │       │       │       │        │       │               │       │            # sort tiles in file order                                                                                                                                                                                                    
   338 │       │       │       │        │       │               │       │            self.tile.sort(key=_tilesort)                                                                                                                                                                                                 
   339 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   340 │       │       │       │        │       │               │       │            # FIXME: This is a hack to handle TIFF's JpegTables tag.                                                                                                                                                                      
   341 │       │       │       │        │       │               │       │            prefix = getattr(self, "tile_prefix", b"")                                                                                                                                                                                    
   342 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   343 │       │       │       │        │       │               │       │            # Remove consecutive duplicates that only differ by their offset                                                                                                                                                              
   344 │       │       │       │        │       │               │       │            self.tile = [                                                                                                                                                                                                                 
   345 │       │       │       │        │       │               │       │                list(tiles)[-1]                                                                                                                                                                                                           
   346 │       │       │       │        │       │               │       │                for _, tiles in itertools.groupby(                                                                                                                                                                                        
   347 │       │       │       │        │       │               │       │                    self.tile, lambda tile: (tile[0], tile[1], tile[3])                                                                                                                                                                   
   348 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   349 │       │       │       │        │       │               │       │            ]                                                                                                                                                                                                                             
   350 │       │       │       │        │       │               │       │            for i, (decoder_name, extents, offset, args) in enumerate(self.tile):                                                                                                                                                         
   351 │       │       │       │        │       │               │       │                seek(offset)                                                                                                                                                                                                              
   352 │       │       │       │        │       │               │       │                decoder = Image._getdecoder(                                                                                                                                                                                              
   353 │       │       │       │        │       │               │       │                    self.mode, decoder_name, args, self.decoderconfig                                                                                                                                                                     
   354 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   355 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
   356 │       │       │       │        │       │               │       │                    decoder.setimage(self.im, extents)                                                                                                                                                                                    
   357 │       │       │       │        │       │               │       │                    if decoder.pulls_fd:                                                                                                                                                                                                  
   358 │       │       │       │        │       │               │       │                        decoder.setfd(self.fp)                                                                                                                                                                                            
   359 │       │       │       │        │       │               │       │                        err_code = decoder.decode(b"")[1]                                                                                                                                                                                 
   360 │       │       │       │        │       │               │       │                    else:                                                                                                                                                                                                                 
   361 │       │       │       │        │       │               │       │                        b = prefix                                                                                                                                                                                                        
   362 │       │       │       │        │       │               │       │                        while True:                                                                                                                                                                                                       
   363 │       │       │       │        │       │               │       │                            read_bytes = self.decodermaxblock                                                                                                                                                                             
   364 │       │       │       │        │       │               │       │                            if i + 1 < len(self.tile):                                                                                                                                                                                    
   365 │       │       │       │        │       │               │       │                                next_offset = self.tile[i + 1].offset                                                                                                                                                                     
   366 │       │       │       │        │       │               │       │                                if next_offset > offset:                                                                                                                                                                                  
   367 │       │       │       │        │       │               │       │                                    read_bytes = next_offset - offset                                                                                                                                                                     
   368 │       │       │       │        │       │               │       │                            try:                                                                                                                                                                                                          
   369 │       │       │       │        │       │               │       │                                s = read(read_bytes)                                                                                                                                                                                      
   370 │       │       │       │        │       │               │       │                            except (IndexError, struct.error) as e:                                                                                                                                                                       
   371 │       │       │       │        │       │               │       │                                # truncated png/gif                                                                                                                                                                                       
   372 │       │       │       │        │       │               │       │                                if LOAD_TRUNCATED_IMAGES:                                                                                                                                                                                 
   373 │       │       │       │        │       │               │       │                                    break                                                                                                                                                                                                 
   374 │       │       │       │        │       │               │       │                                else:                                                                                                                                                                                                     
   375 │       │       │       │        │       │               │       │                                    msg = "image file is truncated"                                                                                                                                                                       
   376 │       │       │       │        │       │               │       │                                    raise OSError(msg) from e                                                                                                                                                                             
   377 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   378 │       │       │       │        │       │               │       │                            if not s:  # truncated jpeg                                                                                                                                                                                   
   379 │       │       │       │        │       │               │       │                                if LOAD_TRUNCATED_IMAGES:                                                                                                                                                                                 
   380 │       │       │       │        │       │               │       │                                    break                                                                                                                                                                                                 
   381 │       │       │       │        │       │               │       │                                else:                                                                                                                                                                                                     
   382 │       │       │       │        │       │               │       │                                    msg = (                                                                                                                                                                                               
   383 │       │       │       │        │       │               │       │                                        "image file is truncated "                                                                                                                                                                        
   384 │       │       │       │        │       │               │       │                                        f"({len(b)} bytes not processed)"                                                                                                                                                                 
   385 │       │       │       │        │       │               │       │                                    )                                                                                                                                                                                                     
   386 │       │       │       │        │       │               │       │                                    raise OSError(msg)                                                                                                                                                                                    
   387 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   388 │       │       │       │        │       │               │       │                            b = b + s                                                                                                                                                                                                     
   389 │       │       │       │        │       │               │       │                            n, err_code = decoder.decode(b)                                                                                                                                                                               
   390 │       │       │       │        │       │               │       │                            if n < 0:                                                                                                                                                                                                     
   391 │       │       │       │        │       │               │       │                                break                                                                                                                                                                                                     
   392 │       │       │       │        │       │               │       │                            b = b[n:]                                                                                                                                                                                                     
   393 │       │       │       │        │       │               │       │                finally:                                                                                                                                                                                                                  
   394 │       │       │       │        │       │               │       │                    # Need to cleanup here to prevent leaks                                                                                                                                                                               
   395 │       │       │       │        │       │               │       │                    decoder.cleanup()                                                                                                                                                                                                     
   396 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   397 │       │       │       │        │       │               │       │        self.tile = []                                                                                                                                                                                                                    
   398 │       │       │       │        │       │               │       │        self.readonly = readonly                                                                                                                                                                                                          
   399 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   400 │       │       │       │        │       │               │       │        self.load_end()                                                                                                                                                                                                                   
   401 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   402 │       │       │       │        │       │               │       │        if self._exclusive_fp and self._close_exclusive_fp_after_loading:                                                                                                                                                                 
   403 │       │       │       │        │       │               │       │            self.fp.close()                                                                                                                                                                                                               
   404 │       │       │       │        │       │               │       │        self.fp = None                                                                                                                                                                                                                    
   405 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   406 │       │       │       │        │       │               │       │        if not self.map and not LOAD_TRUNCATED_IMAGES and err_code < 0:                                                                                                                                                                   
   407 │       │       │       │        │       │               │       │            # still raised if decoder fails to return anything                                                                                                                                                                            
   408 │       │       │       │        │       │               │       │            raise _get_oserror(err_code, encoder=False)                                                                                                                                                                                   
   409 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   410 │       │       │       │        │       │               │       │        return Image.Image.load(self)                                                                                                                                                                                                     
   411 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   412 │       │       │       │        │       │               │       │    def load_prepare(self) -> None:                                                                                                                                                                                                       
   413 │       │       │       │        │       │               │       │        # create image memory if necessary                                                                                                                                                                                                
   414 │       │       │       │        │       │               │       │        if self._im is None:                                                                                                                                                                                                              
   415 │       │       │       │        │       │               │       │            self.im = Image.core.new(self.mode, self.size)                                                                                                                                                                                
   416 │       │       │       │        │       │               │       │        # create palette (optional)                                                                                                                                                                                                       
   417 │       │       │       │        │       │               │       │        if self.mode == "P":                                                                                                                                                                                                              
   418 │       │       │       │        │       │               │       │            Image.Image.load(self)                                                                                                                                                                                                        
   419 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   420 │       │       │       │        │       │               │       │    def load_end(self) -> None:                                                                                                                                                                                                           
   421 │       │       │       │        │       │               │       │        # may be overridden                                                                                                                                                                                                               
   422 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   423 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   424 │       │       │       │        │       │               │       │    # may be defined for contained formats                                                                                                                                                                                                
   425 │       │       │       │        │       │               │       │    # def load_seek(self, pos: int) -> None:                                                                                                                                                                                              
   426 │       │       │       │        │       │               │       │    #     pass                                                                                                                                                                                                                            
   427 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   428 │       │       │       │        │       │               │       │    # may be defined for blocked formats (e.g. PNG)                                                                                                                                                                                       
   429 │       │       │       │        │       │               │       │    # def load_read(self, read_bytes: int) -> bytes:                                                                                                                                                                                      
   430 │       │       │       │        │       │               │       │    #     pass                                                                                                                                                                                                                            
   431 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   432 │       │       │       │        │       │               │       │    def _seek_check(self, frame: int) -> bool:                                                                                                                                                                                            
   433 │       │       │       │        │       │               │       │        if (                                                                                                                                                                                                                              
   434 │       │       │       │        │       │               │       │            frame < self._min_frame                                                                                                                                                                                                       
   435 │       │       │       │        │       │               │       │            # Only check upper limit on frames if additional seek operations                                                                                                                                                              
   436 │       │       │       │        │       │               │       │            # are not required to do so                                                                                                                                                                                                   
   437 │       │       │       │        │       │               │       │            or (                                                                                                                                                                                                                          
   438 │       │       │       │        │       │               │       │                not (hasattr(self, "_n_frames") and self._n_frames is None)                                                                                                                                                               
   439 │       │       │       │        │       │               │       │                and frame >= getattr(self, "n_frames") + self._min_frame                                                                                                                                                                  
   440 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   441 │       │       │       │        │       │               │       │        ):                                                                                                                                                                                                                                
   442 │       │       │       │        │       │               │       │            msg = "attempt to seek outside sequence"                                                                                                                                                                                      
   443 │       │       │       │        │       │               │       │            raise EOFError(msg)                                                                                                                                                                                                           
   444 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   445 │       │       │       │        │       │               │       │        return self.tell() != frame                                                                                                                                                                                                       
   446 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   447 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   448 │       │       │       │        │       │               │       │class StubHandler(abc.ABC):                                                                                                                                                                                                               
   449 │       │       │       │        │       │               │       │    def open(self, im: StubImageFile) -> None:                                                                                                                                                                                            
   450 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   451 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   452 │       │       │       │        │       │               │       │    @abc.abstractmethod                                                                                                                                                                                                                   
   453 │       │       │       │        │       │               │       │    def load(self, im: StubImageFile) -> Image.Image:                                                                                                                                                                                     
   454 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   455 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   456 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   457 │       │       │       │        │       │               │       │class StubImageFile(ImageFile, metaclass=abc.ABCMeta):                                                                                                                                                                                    
   458 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   459 │       │       │       │        │       │               │       │    Base class for stub image loaders.                                                                                                                                                                                                    
   460 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   461 │       │       │       │        │       │               │       │    A stub loader is an image loader that can identify files of a                                                                                                                                                                         
   462 │       │       │       │        │       │               │       │    certain format, but relies on external code to load the file.                                                                                                                                                                         
   463 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   464 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   465 │       │       │       │        │       │               │       │    @abc.abstractmethod                                                                                                                                                                                                                   
   466 │       │       │       │        │       │               │       │    def _open(self) -> None:                                                                                                                                                                                                              
   467 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   468 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   469 │       │       │       │        │       │               │       │    def load(self) -> Image.core.PixelAccess | None:                                                                                                                                                                                      
   470 │       │       │       │        │       │               │       │        loader = self._load()                                                                                                                                                                                                             
   471 │       │       │       │        │       │               │       │        if loader is None:                                                                                                                                                                                                                
   472 │       │       │       │        │       │               │       │            msg = f"cannot find loader for this {self.format} file"                                                                                                                                                                       
   473 │       │       │       │        │       │               │       │            raise OSError(msg)                                                                                                                                                                                                            
   474 │       │       │       │        │       │               │       │        image = loader.load(self)                                                                                                                                                                                                         
   475 │       │       │       │        │       │               │       │        assert image is not None                                                                                                                                                                                                          
   476 │       │       │       │        │       │               │       │        # become the other object (!)                                                                                                                                                                                                     
   477 │       │       │       │        │       │               │       │        self.__class__ = image.__class__  # type: ignore[assignment]                                                                                                                                                                      
   478 │       │       │       │        │       │               │       │        self.__dict__ = image.__dict__                                                                                                                                                                                                    
   479 │       │       │       │        │       │               │       │        return image.load()                                                                                                                                                                                                               
   480 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   481 │       │       │       │        │       │               │       │    @abc.abstractmethod                                                                                                                                                                                                                   
   482 │       │       │       │        │       │               │       │    def _load(self) -> StubHandler | None:                                                                                                                                                                                                
   483 │       │       │       │        │       │               │       │        """(Hook) Find actual image loader."""                                                                                                                                                                                            
   484 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   485 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   486 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   487 │       │       │       │        │       │               │       │class Parser:                                                                                                                                                                                                                             
   488 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   489 │       │       │       │        │       │               │       │    Incremental image parser.  This class implements the standard                                                                                                                                                                         
   490 │       │       │       │        │       │               │       │    feed/close consumer interface.                                                                                                                                                                                                        
   491 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   492 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   493 │       │       │       │        │       │               │       │    incremental = None                                                                                                                                                                                                                    
   494 │       │       │       │        │       │               │       │    image: Image.Image | None = None                                                                                                                                                                                                      
   495 │       │       │       │        │       │               │       │    data: bytes | None = None                                                                                                                                                                                                             
   496 │       │       │       │        │       │               │       │    decoder: Image.core.ImagingDecoder | PyDecoder | None = None                                                                                                                                                                          
   497 │       │       │       │        │       │               │       │    offset = 0                                                                                                                                                                                                                            
   498 │       │       │       │        │       │               │       │    finished = 0                                                                                                                                                                                                                          
   499 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   500 │       │       │       │        │       │               │       │    def reset(self) -> None:                                                                                                                                                                                                              
   501 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   502 │       │       │       │        │       │               │       │        (Consumer) Reset the parser.  Note that you can only call this                                                                                                                                                                    
   503 │       │       │       │        │       │               │       │        method immediately after you've created a parser; parser                                                                                                                                                                          
   504 │       │       │       │        │       │               │       │        instances cannot be reused.                                                                                                                                                                                                       
   505 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   506 │       │       │       │        │       │               │       │        assert self.data is None, "cannot reuse parsers"                                                                                                                                                                                  
   507 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   508 │       │       │       │        │       │               │       │    def feed(self, data: bytes) -> None:                                                                                                                                                                                                  
   509 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   510 │       │       │       │        │       │               │       │        (Consumer) Feed data to the parser.                                                                                                                                                                                               
   511 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   512 │       │       │       │        │       │               │       │        :param data: A string buffer.                                                                                                                                                                                                     
   513 │       │       │       │        │       │               │       │        :exception OSError: If the parser failed to parse the image file.                                                                                                                                                                 
   514 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   515 │       │       │       │        │       │               │       │        # collect data                                                                                                                                                                                                                    
   516 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   517 │       │       │       │        │       │               │       │        if self.finished:                                                                                                                                                                                                                 
   518 │       │       │       │        │       │               │       │            return                                                                                                                                                                                                                        
   519 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   520 │       │       │       │        │       │               │       │        if self.data is None:                                                                                                                                                                                                             
   521 │       │       │       │        │       │               │       │            self.data = data                                                                                                                                                                                                              
   522 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   523 │       │       │       │        │       │               │       │            self.data = self.data + data                                                                                                                                                                                                  
   524 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   525 │       │       │       │        │       │               │       │        # parse what we have                                                                                                                                                                                                              
   526 │       │       │       │        │       │               │       │        if self.decoder:                                                                                                                                                                                                                  
   527 │       │       │       │        │       │               │       │            if self.offset > 0:                                                                                                                                                                                                           
   528 │       │       │       │        │       │               │       │                # skip header                                                                                                                                                                                                             
   529 │       │       │       │        │       │               │       │                skip = min(len(self.data), self.offset)                                                                                                                                                                                   
   530 │       │       │       │        │       │               │       │                self.data = self.data[skip:]                                                                                                                                                                                              
   531 │       │       │       │        │       │               │       │                self.offset = self.offset - skip                                                                                                                                                                                          
   532 │       │       │       │        │       │               │       │                if self.offset > 0 or not self.data:                                                                                                                                                                                      
   533 │       │       │       │        │       │               │       │                    return                                                                                                                                                                                                                
   534 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   535 │       │       │       │        │       │               │       │            n, e = self.decoder.decode(self.data)                                                                                                                                                                                         
   536 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   537 │       │       │       │        │       │               │       │            if n < 0:                                                                                                                                                                                                                     
   538 │       │       │       │        │       │               │       │                # end of stream                                                                                                                                                                                                           
   539 │       │       │       │        │       │               │       │                self.data = None                                                                                                                                                                                                          
   540 │       │       │       │        │       │               │       │                self.finished = 1                                                                                                                                                                                                         
   541 │       │       │       │        │       │               │       │                if e < 0:                                                                                                                                                                                                                 
   542 │       │       │       │        │       │               │       │                    # decoding error                                                                                                                                                                                                      
   543 │       │       │       │        │       │               │       │                    self.image = None                                                                                                                                                                                                     
   544 │       │       │       │        │       │               │       │                    raise _get_oserror(e, encoder=False)                                                                                                                                                                                  
   545 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
   546 │       │       │       │        │       │               │       │                    # end of image                                                                                                                                                                                                        
   547 │       │       │       │        │       │               │       │                    return                                                                                                                                                                                                                
   548 │       │       │       │        │       │               │       │            self.data = self.data[n:]                                                                                                                                                                                                     
   549 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   550 │       │       │       │        │       │               │       │        elif self.image:                                                                                                                                                                                                                  
   551 │       │       │       │        │       │               │       │            # if we end up here with no decoder, this file cannot                                                                                                                                                                         
   552 │       │       │       │        │       │               │       │            # be incrementally parsed.  wait until we've gotten all                                                                                                                                                                       
   553 │       │       │       │        │       │               │       │            # available data                                                                                                                                                                                                              
   554 │       │       │       │        │       │               │       │            pass                                                                                                                                                                                                                          
   555 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   556 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   557 │       │       │       │        │       │               │       │            # attempt to open this file                                                                                                                                                                                                   
   558 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
   559 │       │       │       │        │       │               │       │                with io.BytesIO(self.data) as fp:                                                                                                                                                                                         
   560 │       │       │       │        │       │               │       │                    im = Image.open(fp)                                                                                                                                                                                                   
   561 │       │       │       │        │       │               │       │            except OSError:                                                                                                                                                                                                               
   562 │       │       │       │        │       │               │       │                pass  # not enough data                                                                                                                                                                                                   
   563 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   564 │       │       │       │        │       │               │       │                flag = hasattr(im, "load_seek") or hasattr(im, "load_read")                                                                                                                                                               
   565 │       │       │       │        │       │               │       │                if flag or len(im.tile) != 1:                                                                                                                                                                                             
   566 │       │       │       │        │       │               │       │                    # custom load code, or multiple tiles                                                                                                                                                                                 
   567 │       │       │       │        │       │               │       │                    self.decode = None                                                                                                                                                                                                    
   568 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
   569 │       │       │       │        │       │               │       │                    # initialize decoder                                                                                                                                                                                                  
   570 │       │       │       │        │       │               │       │                    im.load_prepare()                                                                                                                                                                                                     
   571 │       │       │       │        │       │               │       │                    d, e, o, a = im.tile[0]                                                                                                                                                                                               
   572 │       │       │       │        │       │               │       │                    im.tile = []                                                                                                                                                                                                          
   573 │       │       │       │        │       │               │       │                    self.decoder = Image._getdecoder(im.mode, d, a, im.decoderconfig)                                                                                                                                                     
   574 │       │       │       │        │       │               │       │                    self.decoder.setimage(im.im, e)                                                                                                                                                                                       
   575 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   576 │       │       │       │        │       │               │       │                    # calculate decoder offset                                                                                                                                                                                            
   577 │       │       │       │        │       │               │       │                    self.offset = o                                                                                                                                                                                                       
   578 │       │       │       │        │       │               │       │                    if self.offset <= len(self.data):                                                                                                                                                                                     
   579 │       │       │       │        │       │               │       │                        self.data = self.data[self.offset :]                                                                                                                                                                              
   580 │       │       │       │        │       │               │       │                        self.offset = 0                                                                                                                                                                                                   
   581 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   582 │       │       │       │        │       │               │       │                self.image = im                                                                                                                                                                                                           
   583 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   584 │       │       │       │        │       │               │       │    def __enter__(self) -> Parser:                                                                                                                                                                                                        
   585 │       │       │       │        │       │               │       │        return self                                                                                                                                                                                                                       
   586 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   587 │       │       │       │        │       │               │       │    def __exit__(self, *args: object) -> None:                                                                                                                                                                                            
   588 │       │       │       │        │       │               │       │        self.close()                                                                                                                                                                                                                      
   589 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   590 │       │       │       │        │       │               │       │    def close(self) -> Image.Image:                                                                                                                                                                                                       
   591 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   592 │       │       │       │        │       │               │       │        (Consumer) Close the stream.                                                                                                                                                                                                      
   593 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   594 │       │       │       │        │       │               │       │        :returns: An image object.                                                                                                                                                                                                        
   595 │       │       │       │        │       │               │       │        :exception OSError: If the parser failed to parse the image file either                                                                                                                                                           
   596 │       │       │       │        │       │               │       │                            because it cannot be identified or cannot be                                                                                                                                                                  
   597 │       │       │       │        │       │               │       │                            decoded.                                                                                                                                                                                                      
   598 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   599 │       │       │       │        │       │               │       │        # finish decoding                                                                                                                                                                                                                 
   600 │       │       │       │        │       │               │       │        if self.decoder:                                                                                                                                                                                                                  
   601 │       │       │       │        │       │               │       │            # get rid of what's left in the buffers                                                                                                                                                                                       
   602 │       │       │       │        │       │               │       │            self.feed(b"")                                                                                                                                                                                                                
   603 │       │       │       │        │       │               │       │            self.data = self.decoder = None                                                                                                                                                                                               
   604 │       │       │       │        │       │               │       │            if not self.finished:                                                                                                                                                                                                         
   605 │       │       │       │        │       │               │       │                msg = "image was incomplete"                                                                                                                                                                                              
   606 │       │       │       │        │       │               │       │                raise OSError(msg)                                                                                                                                                                                                        
   607 │       │       │       │        │       │               │       │        if not self.image:                                                                                                                                                                                                                
   608 │       │       │       │        │       │               │       │            msg = "cannot parse this image"                                                                                                                                                                                               
   609 │       │       │       │        │       │               │       │            raise OSError(msg)                                                                                                                                                                                                            
   610 │       │       │       │        │       │               │       │        if self.data:                                                                                                                                                                                                                     
   611 │       │       │       │        │       │               │       │            # incremental parsing not possible; reopen the file                                                                                                                                                                           
   612 │       │       │       │        │       │               │       │            # not that we have all data                                                                                                                                                                                                   
   613 │       │       │       │        │       │               │       │            with io.BytesIO(self.data) as fp:                                                                                                                                                                                             
   614 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
   615 │       │       │       │        │       │               │       │                    self.image = Image.open(fp)                                                                                                                                                                                           
   616 │       │       │       │        │       │               │       │                finally:                                                                                                                                                                                                                  
   617 │       │       │       │        │       │               │       │                    self.image.load()                                                                                                                                                                                                     
   618 │       │       │       │        │       │               │       │        return self.image                                                                                                                                                                                                                 
   619 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   620 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   621 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
   622 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   623 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   624 │       │       │       │        │       │               │       │def _save(im: Image.Image, fp: IO[bytes], tile: list[_Tile], bufsize: int = 0) -> None:                                                                                                                                                   
   625 │       │       │       │        │       │               │       │    """Helper to save image based on tile list                                                                                                                                                                                            
   626 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   627 │       │       │       │        │       │               │       │    :param im: Image object.                                                                                                                                                                                                              
   628 │       │       │       │        │       │               │       │    :param fp: File object.                                                                                                                                                                                                               
   629 │       │       │       │        │       │               │       │    :param tile: Tile list.                                                                                                                                                                                                               
   630 │       │       │       │        │       │               │       │    :param bufsize: Optional buffer size                                                                                                                                                                                                  
   631 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   632 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   633 │       │       │       │        │       │               │       │    im.load()                                                                                                                                                                                                                             
   634 │       │       │       │        │       │               │       │    if not hasattr(im, "encoderconfig"):                                                                                                                                                                                                  
   635 │       │       │       │        │       │               │       │        im.encoderconfig = ()                                                                                                                                                                                                             
   636 │       │       │       │        │       │               │       │    tile.sort(key=_tilesort)                                                                                                                                                                                                              
   637 │       │       │       │        │       │               │       │    # FIXME: make MAXBLOCK a configuration parameter                                                                                                                                                                                      
   638 │       │       │       │        │       │               │       │    # It would be great if we could have the encoder specify what it needs                                                                                                                                                                
   639 │       │       │       │        │       │               │       │    # But, it would need at least the image size in most cases. RawEncode is                                                                                                                                                              
   640 │       │       │       │        │       │               │       │    # a tricky case.                                                                                                                                                                                                                      
   641 │       │       │       │        │       │               │       │    bufsize = max(MAXBLOCK, bufsize, im.size[0] * 4)  # see RawEncode.c                                                                                                                                                                   
   642 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   643 │       │       │       │        │       │               │       │        fh = fp.fileno()                                                                                                                                                                                                                  
   644 │       │       │       │        │       │               │       │        fp.flush()                                                                                                                                                                                                                        
   645 │       │       │       │        │       │               │       │        _encode_tile(im, fp, tile, bufsize, fh)                                                                                                                                                                                           
   646 │       │       │       │        │       │               │       │    except (AttributeError, io.UnsupportedOperation) as exc:                                                                                                                                                                              
   647 │       │       │       │        │       │               │       │        _encode_tile(im, fp, tile, bufsize, None, exc)                                                                                                                                                                                    
   648 │       │       │       │        │       │               │       │    if hasattr(fp, "flush"):                                                                                                                                                                                                              
   649 │       │       │       │        │       │               │       │        fp.flush()                                                                                                                                                                                                                        
   650 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   651 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   652 │       │       │       │        │       │               │       │def _encode_tile(                                                                                                                                                                                                                         
   653 │       │       │       │        │       │               │       │    im: Image.Image,                                                                                                                                                                                                                      
   654 │       │       │       │        │       │               │       │    fp: IO[bytes],                                                                                                                                                                                                                        
   655 │       │       │       │        │       │               │       │    tile: list[_Tile],                                                                                                                                                                                                                    
   656 │       │       │       │        │       │               │       │    bufsize: int,                                                                                                                                                                                                                         
   657 │       │       │       │        │       │               │       │    fh: int | None,                                                                                                                                                                                                                       
   658 │       │       │       │        │       │               │       │    exc: BaseException | None = None,                                                                                                                                                                                                     
   659 │       │       │       │        │       │               │       │) -> None:                                                                                                                                                                                                                                
   660 │       │       │       │        │       │               │       │    for encoder_name, extents, offset, args in tile:                                                                                                                                                                                      
   661 │       │       │       │        │       │               │       │        if offset > 0:                                                                                                                                                                                                                    
   662 │       │       │       │        │       │               │       │            fp.seek(offset)                                                                                                                                                                                                               
   663 │       │       │       │        │       │               │       │        encoder = Image._getencoder(im.mode, encoder_name, args, im.encoderconfig)                                                                                                                                                        
   664 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   665 │       │       │       │        │       │               │       │            encoder.setimage(im.im, extents)                                                                                                                                                                                              
   666 │       │       │       │        │       │               │       │            if encoder.pushes_fd:                                                                                                                                                                                                         
   667 │       │       │       │        │       │               │       │                encoder.setfd(fp)                                                                                                                                                                                                         
   668 │       │       │       │        │       │               │       │                errcode = encoder.encode_to_pyfd()[1]                                                                                                                                                                                     
   669 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   670 │       │       │       │        │       │               │       │                if exc:                                                                                                                                                                                                                   
   671 │       │       │       │        │       │               │       │                    # compress to Python file-compatible object                                                                                                                                                                           
   672 │       │       │       │        │       │               │       │                    while True:                                                                                                                                                                                                           
   673 │       │    1% │       │        │       │               │     7 │                        errcode, data = encoder.encode(bufsize)[1:]                                                                                                                                                                       
   674 │       │       │       │        │       │               │       │                        fp.write(data)                                                                                                                                                                                                    
   675 │       │       │       │        │       │               │       │                        if errcode:                                                                                                                                                                                                       
   676 │       │       │       │        │       │               │       │                            break                                                                                                                                                                                                         
   677 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
   678 │       │       │       │        │       │               │       │                    # slight speedup: compress to real file object                                                                                                                                                                        
   679 │       │       │       │        │       │               │       │                    assert fh is not None                                                                                                                                                                                                 
   680 │       │       │       │        │       │               │       │                    errcode = encoder.encode_to_file(fh, bufsize)                                                                                                                                                                         
   681 │       │       │       │        │       │               │       │            if errcode < 0:                                                                                                                                                                                                               
   682 │       │       │       │        │       │               │       │                raise _get_oserror(errcode, encoder=True) from exc                                                                                                                                                                        
   683 │       │       │       │        │       │               │       │        finally:                                                                                                                                                                                                                          
   684 │       │       │       │        │       │               │       │            encoder.cleanup()                                                                                                                                                                                                             
   685 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   686 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   687 │       │       │       │        │       │               │       │def _safe_read(fp: IO[bytes], size: int) -> bytes:                                                                                                                                                                                        
   688 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   689 │       │       │       │        │       │               │       │    Reads large blocks in a safe way.  Unlike fp.read(n), this function                                                                                                                                                                   
   690 │       │       │       │        │       │               │       │    doesn't trust the user.  If the requested size is larger than                                                                                                                                                                         
   691 │       │       │       │        │       │               │       │    SAFEBLOCK, the file is read block by block.                                                                                                                                                                                           
   692 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   693 │       │       │       │        │       │               │       │    :param fp: File handle.  Must implement a <b>read</b> method.                                                                                                                                                                         
   694 │       │       │       │        │       │               │       │    :param size: Number of bytes to read.                                                                                                                                                                                                 
   695 │       │       │       │        │       │               │       │    :returns: A string containing <i>size</i> bytes of data.                                                                                                                                                                              
   696 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   697 │       │       │       │        │       │               │       │    Raises an OSError if the file is truncated and the read cannot be completed                                                                                                                                                           
   698 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   699 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   700 │       │       │       │        │       │               │       │    if size <= 0:                                                                                                                                                                                                                         
   701 │       │       │       │        │       │               │       │        return b""                                                                                                                                                                                                                        
   702 │       │       │       │        │       │               │       │    if size <= SAFEBLOCK:                                                                                                                                                                                                                 
   703 │       │       │       │        │       │               │       │        data = fp.read(size)                                                                                                                                                                                                              
   704 │       │       │       │        │       │               │       │        if len(data) < size:                                                                                                                                                                                                              
   705 │       │       │       │        │       │               │       │            msg = "Truncated File Read"                                                                                                                                                                                                   
   706 │       │       │       │        │       │               │       │            raise OSError(msg)                                                                                                                                                                                                            
   707 │       │       │       │        │       │               │       │        return data                                                                                                                                                                                                                       
   708 │       │       │       │        │       │               │       │    blocks: list[bytes] = []                                                                                                                                                                                                              
   709 │       │       │       │        │       │               │       │    remaining_size = size                                                                                                                                                                                                                 
   710 │       │       │       │        │       │               │       │    while remaining_size > 0:                                                                                                                                                                                                             
   711 │       │       │       │        │       │               │       │        block = fp.read(min(remaining_size, SAFEBLOCK))                                                                                                                                                                                   
   712 │       │       │       │        │       │               │       │        if not block:                                                                                                                                                                                                                     
   713 │       │       │       │        │       │               │       │            break                                                                                                                                                                                                                         
   714 │       │       │       │        │       │               │       │        blocks.append(block)                                                                                                                                                                                                              
   715 │       │       │       │        │       │               │       │        remaining_size -= len(block)                                                                                                                                                                                                      
   716 │       │       │       │        │       │               │       │    if sum(len(block) for block in blocks) < size:                                                                                                                                                                                        
   717 │       │       │       │        │       │               │       │        msg = "Truncated File Read"                                                                                                                                                                                                       
   718 │       │       │       │        │       │               │       │        raise OSError(msg)                                                                                                                                                                                                                
   719 │       │       │       │        │       │               │       │    return b"".join(blocks)                                                                                                                                                                                                               
   720 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   721 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   722 │       │       │       │        │       │               │       │class PyCodecState:                                                                                                                                                                                                                       
   723 │       │       │       │        │       │               │       │    def __init__(self) -> None:                                                                                                                                                                                                           
   724 │       │       │       │        │       │               │       │        self.xsize = 0                                                                                                                                                                                                                    
   725 │       │       │       │        │       │               │       │        self.ysize = 0                                                                                                                                                                                                                    
   726 │       │       │       │        │       │               │       │        self.xoff = 0                                                                                                                                                                                                                     
   727 │       │       │       │        │       │               │       │        self.yoff = 0                                                                                                                                                                                                                     
   728 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   729 │       │       │       │        │       │               │       │    def extents(self) -> tuple[int, int, int, int]:                                                                                                                                                                                       
   730 │       │       │       │        │       │               │       │        return self.xoff, self.yoff, self.xoff + self.xsize, self.yoff + self.ysize                                                                                                                                                       
   731 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   732 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   733 │       │       │       │        │       │               │       │class PyCodec:                                                                                                                                                                                                                            
   734 │       │       │       │        │       │               │       │    fd: IO[bytes] | None                                                                                                                                                                                                                  
   735 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   736 │       │       │       │        │       │               │       │    def __init__(self, mode: str, *args: Any) -> None:                                                                                                                                                                                    
   737 │       │       │       │        │       │               │       │        self.im: Image.core.ImagingCore | None = None                                                                                                                                                                                     
   738 │       │       │       │        │       │               │       │        self.state = PyCodecState()                                                                                                                                                                                                       
   739 │       │       │       │        │       │               │       │        self.fd = None                                                                                                                                                                                                                    
   740 │       │       │       │        │       │               │       │        self.mode = mode                                                                                                                                                                                                                  
   741 │       │       │       │        │       │               │       │        self.init(args)                                                                                                                                                                                                                   
   742 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   743 │       │       │       │        │       │               │       │    def init(self, args: tuple[Any, ...]) -> None:                                                                                                                                                                                        
   744 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   745 │       │       │       │        │       │               │       │        Override to perform codec specific initialization                                                                                                                                                                                 
   746 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   747 │       │       │       │        │       │               │       │        :param args: Tuple of arg items from the tile entry                                                                                                                                                                               
   748 │       │       │       │        │       │               │       │        :returns: None                                                                                                                                                                                                                    
   749 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   750 │       │       │       │        │       │               │       │        self.args = args                                                                                                                                                                                                                  
   751 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   752 │       │       │       │        │       │               │       │    def cleanup(self) -> None:                                                                                                                                                                                                            
   753 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   754 │       │       │       │        │       │               │       │        Override to perform codec specific cleanup                                                                                                                                                                                        
   755 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   756 │       │       │       │        │       │               │       │        :returns: None                                                                                                                                                                                                                    
   757 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   758 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   759 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   760 │       │       │       │        │       │               │       │    def setfd(self, fd: IO[bytes]) -> None:                                                                                                                                                                                               
   761 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   762 │       │       │       │        │       │               │       │        Called from ImageFile to set the Python file-like object                                                                                                                                                                          
   763 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   764 │       │       │       │        │       │               │       │        :param fd: A Python file-like object                                                                                                                                                                                              
   765 │       │       │       │        │       │               │       │        :returns: None                                                                                                                                                                                                                    
   766 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   767 │       │       │       │        │       │               │       │        self.fd = fd                                                                                                                                                                                                                      
   768 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   769 │       │       │       │        │       │               │       │    def setimage(                                                                                                                                                                                                                         
   770 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   771 │       │       │       │        │       │               │       │        im: Image.core.ImagingCore,                                                                                                                                                                                                       
   772 │       │       │       │        │       │               │       │        extents: tuple[int, int, int, int] | None = None,                                                                                                                                                                                 
   773 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
   774 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   775 │       │       │       │        │       │               │       │        Called from ImageFile to set the core output image for the codec                                                                                                                                                                  
   776 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   777 │       │       │       │        │       │               │       │        :param im: A core image object                                                                                                                                                                                                    
   778 │       │       │       │        │       │               │       │        :param extents: a 4 tuple of (x0, y0, x1, y1) defining the rectangle                                                                                                                                                              
   779 │       │       │       │        │       │               │       │            for this tile                                                                                                                                                                                                                 
   780 │       │       │       │        │       │               │       │        :returns: None                                                                                                                                                                                                                    
   781 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   782 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   783 │       │       │       │        │       │               │       │        # following c code                                                                                                                                                                                                                
   784 │       │       │       │        │       │               │       │        self.im = im                                                                                                                                                                                                                      
   785 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   786 │       │       │       │        │       │               │       │        if extents:                                                                                                                                                                                                                       
   787 │       │       │       │        │       │               │       │            (x0, y0, x1, y1) = extents                                                                                                                                                                                                    
   788 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   789 │       │       │       │        │       │               │       │            (x0, y0, x1, y1) = (0, 0, 0, 0)                                                                                                                                                                                               
   790 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   791 │       │       │       │        │       │               │       │        if x0 == 0 and x1 == 0:                                                                                                                                                                                                           
   792 │       │       │       │        │       │               │       │            self.state.xsize, self.state.ysize = self.im.size                                                                                                                                                                             
   793 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   794 │       │       │       │        │       │               │       │            self.state.xoff = x0                                                                                                                                                                                                          
   795 │       │       │       │        │       │               │       │            self.state.yoff = y0                                                                                                                                                                                                          
   796 │       │       │       │        │       │               │       │            self.state.xsize = x1 - x0                                                                                                                                                                                                    
   797 │       │       │       │        │       │               │       │            self.state.ysize = y1 - y0                                                                                                                                                                                                    
   798 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   799 │       │       │       │        │       │               │       │        if self.state.xsize <= 0 or self.state.ysize <= 0:                                                                                                                                                                                
   800 │       │       │       │        │       │               │       │            msg = "Size cannot be negative"                                                                                                                                                                                               
   801 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
   802 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   803 │       │       │       │        │       │               │       │        if (                                                                                                                                                                                                                              
   804 │       │       │       │        │       │               │       │            self.state.xsize + self.state.xoff > self.im.size[0]                                                                                                                                                                          
   805 │       │       │       │        │       │               │       │            or self.state.ysize + self.state.yoff > self.im.size[1]                                                                                                                                                                       
   806 │       │       │       │        │       │               │       │        ):                                                                                                                                                                                                                                
   807 │       │       │       │        │       │               │       │            msg = "Tile cannot extend outside image"                                                                                                                                                                                      
   808 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
   809 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   810 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   811 │       │       │       │        │       │               │       │class PyDecoder(PyCodec):                                                                                                                                                                                                                 
   812 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   813 │       │       │       │        │       │               │       │    Python implementation of a format decoder. Override this class and                                                                                                                                                                    
   814 │       │       │       │        │       │               │       │    add the decoding logic in the :meth:`decode` method.                                                                                                                                                                                  
   815 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   816 │       │       │       │        │       │               │       │    See :ref:`Writing Your Own File Codec in Python<file-codecs-py>`                                                                                                                                                                      
   817 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   818 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   819 │       │       │       │        │       │               │       │    _pulls_fd = False                                                                                                                                                                                                                     
   820 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   821 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   822 │       │       │       │        │       │               │       │    def pulls_fd(self) -> bool:                                                                                                                                                                                                           
   823 │       │       │       │        │       │               │       │        return self._pulls_fd                                                                                                                                                                                                             
   824 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   825 │       │       │       │        │       │               │       │    def decode(self, buffer: bytes | Image.SupportsArrayInterface) -> tuple[int, int]:                                                                                                                                                    
   826 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   827 │       │       │       │        │       │               │       │        Override to perform the decoding process.                                                                                                                                                                                         
   828 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   829 │       │       │       │        │       │               │       │        :param buffer: A bytes object with the data to be decoded.                                                                                                                                                                        
   830 │       │       │       │        │       │               │       │        :returns: A tuple of ``(bytes consumed, errcode)``.                                                                                                                                                                               
   831 │       │       │       │        │       │               │       │            If finished with decoding return -1 for the bytes consumed.                                                                                                                                                                   
   832 │       │       │       │        │       │               │       │            Err codes are from :data:`.ImageFile.ERRORS`.                                                                                                                                                                                 
   833 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   834 │       │       │       │        │       │               │       │        msg = "unavailable in base decoder"                                                                                                                                                                                               
   835 │       │       │       │        │       │               │       │        raise NotImplementedError(msg)                                                                                                                                                                                                    
   836 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   837 │       │       │       │        │       │               │       │    def set_as_raw(                                                                                                                                                                                                                       
   838 │       │       │       │        │       │               │       │        self, data: bytes, rawmode: str | None = None, extra: tuple[Any, ...] = ()                                                                                                                                                        
   839 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
   840 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   841 │       │       │       │        │       │               │       │        Convenience method to set the internal image from a stream of raw data                                                                                                                                                            
   842 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   843 │       │       │       │        │       │               │       │        :param data: Bytes to be set                                                                                                                                                                                                      
   844 │       │       │       │        │       │               │       │        :param rawmode: The rawmode to be used for the decoder.                                                                                                                                                                           
   845 │       │       │       │        │       │               │       │            If not specified, it will default to the mode of the image                                                                                                                                                                    
   846 │       │       │       │        │       │               │       │        :param extra: Extra arguments for the decoder.                                                                                                                                                                                    
   847 │       │       │       │        │       │               │       │        :returns: None                                                                                                                                                                                                                    
   848 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   849 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   850 │       │       │       │        │       │               │       │        if not rawmode:                                                                                                                                                                                                                   
   851 │       │       │       │        │       │               │       │            rawmode = self.mode                                                                                                                                                                                                           
   852 │       │       │       │        │       │               │       │        d = Image._getdecoder(self.mode, "raw", rawmode, extra)                                                                                                                                                                           
   853 │       │       │       │        │       │               │       │        assert self.im is not None                                                                                                                                                                                                        
   854 │       │       │       │        │       │               │       │        d.setimage(self.im, self.state.extents())                                                                                                                                                                                         
   855 │       │       │       │        │       │               │       │        s = d.decode(data)                                                                                                                                                                                                                
   856 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   857 │       │       │       │        │       │               │       │        if s[0] >= 0:                                                                                                                                                                                                                     
   858 │       │       │       │        │       │               │       │            msg = "not enough image data"                                                                                                                                                                                                 
   859 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
   860 │       │       │       │        │       │               │       │        if s[1] != 0:                                                                                                                                                                                                                     
   861 │       │       │       │        │       │               │       │            msg = "cannot decode image data"                                                                                                                                                                                              
   862 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
   863 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   864 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   865 │       │       │       │        │       │               │       │class PyEncoder(PyCodec):                                                                                                                                                                                                                 
   866 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   867 │       │       │       │        │       │               │       │    Python implementation of a format encoder. Override this class and                                                                                                                                                                    
   868 │       │       │       │        │       │               │       │    add the decoding logic in the :meth:`encode` method.                                                                                                                                                                                  
   869 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   870 │       │       │       │        │       │               │       │    See :ref:`Writing Your Own File Codec in Python<file-codecs-py>`                                                                                                                                                                      
   871 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   872 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   873 │       │       │       │        │       │               │       │    _pushes_fd = False                                                                                                                                                                                                                    
   874 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   875 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   876 │       │       │       │        │       │               │       │    def pushes_fd(self) -> bool:                                                                                                                                                                                                          
   877 │       │       │       │        │       │               │       │        return self._pushes_fd                                                                                                                                                                                                            
   878 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   879 │       │       │       │        │       │               │       │    def encode(self, bufsize: int) -> tuple[int, int, bytes]:                                                                                                                                                                             
   880 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   881 │       │       │       │        │       │               │       │        Override to perform the encoding process.                                                                                                                                                                                         
   882 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   883 │       │       │       │        │       │               │       │        :param bufsize: Buffer size.                                                                                                                                                                                                      
   884 │       │       │       │        │       │               │       │        :returns: A tuple of ``(bytes encoded, errcode, bytes)``.                                                                                                                                                                         
   885 │       │       │       │        │       │               │       │            If finished with encoding return 1 for the error code.                                                                                                                                                                        
   886 │       │       │       │        │       │               │       │            Err codes are from :data:`.ImageFile.ERRORS`.                                                                                                                                                                                 
   887 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   888 │       │       │       │        │       │               │       │        msg = "unavailable in base encoder"                                                                                                                                                                                               
   889 │       │       │       │        │       │               │       │        raise NotImplementedError(msg)                                                                                                                                                                                                    
   890 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   891 │       │       │       │        │       │               │       │    def encode_to_pyfd(self) -> tuple[int, int]:                                                                                                                                                                                          
   892 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   893 │       │       │       │        │       │               │       │        If ``pushes_fd`` is ``True``, then this method will be used,                                                                                                                                                                      
   894 │       │       │       │        │       │               │       │        and ``encode()`` will only be called once.                                                                                                                                                                                        
   895 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   896 │       │       │       │        │       │               │       │        :returns: A tuple of ``(bytes consumed, errcode)``.                                                                                                                                                                               
   897 │       │       │       │        │       │               │       │            Err codes are from :data:`.ImageFile.ERRORS`.                                                                                                                                                                                 
   898 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   899 │       │       │       │        │       │               │       │        if not self.pushes_fd:                                                                                                                                                                                                            
   900 │       │       │       │        │       │               │       │            return 0, -8  # bad configuration                                                                                                                                                                                             
   901 │       │       │       │        │       │               │       │        bytes_consumed, errcode, data = self.encode(0)                                                                                                                                                                                    
   902 │       │       │       │        │       │               │       │        if data:                                                                                                                                                                                                                          
   903 │       │       │       │        │       │               │       │            assert self.fd is not None                                                                                                                                                                                                    
   904 │       │       │       │        │       │               │       │            self.fd.write(data)                                                                                                                                                                                                           
   905 │       │       │       │        │       │               │       │        return bytes_consumed, errcode                                                                                                                                                                                                    
   906 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   907 │       │       │       │        │       │               │       │    def encode_to_file(self, fh: int, bufsize: int) -> int:                                                                                                                                                                               
   908 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   909 │       │       │       │        │       │               │       │        :param fh: File handle.                                                                                                                                                                                                           
   910 │       │       │       │        │       │               │       │        :param bufsize: Buffer size.                                                                                                                                                                                                      
   911 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   912 │       │       │       │        │       │               │       │        :returns: If finished successfully, return 0.                                                                                                                                                                                     
   913 │       │       │       │        │       │               │       │            Otherwise, return an error code. Err codes are from                                                                                                                                                                           
   914 │       │       │       │        │       │               │       │            :data:`.ImageFile.ERRORS`.                                                                                                                                                                                                    
   915 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   916 │       │       │       │        │       │               │       │        errcode = 0                                                                                                                                                                                                                       
   917 │       │       │       │        │       │               │       │        while errcode == 0:                                                                                                                                                                                                               
   918 │       │       │       │        │       │               │       │            status, errcode, buf = self.encode(bufsize)                                                                                                                                                                                   
   919 │       │       │       │        │       │               │       │            if status > 0:                                                                                                                                                                                                                
   920 │       │       │       │        │       │               │       │                os.write(fh, buf[status:])                                                                                                                                                                                                
   921 │       │       │       │        │       │               │       │        return errcode                                                                                                                                                                                                                    
   922 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
╶──────┼───────┼───────┼───────┼────────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │       │        │       │               │       │function summary for /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/.venv/lib/python3.12/site-packages/PIL/ImageFile.py                                                                                                 
   652 │       │    1% │       │        │       │               │     7 │_encode_tile                                                                                                                                                                                                                              
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
                                                            /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/.venv/lib/python3.12/site-packages/matplotlib/backends/backend_agg.py: % of time =   0.39% (385.978ms) out of 2m:38.834s.                                                             
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/.venv/lib/python3.12/site-packages/matplotlib/backends/backend_agg.py                                                                                                    
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │"""                                                                                                                                                                                                                                       
     2 │       │       │       │        │       │               │       │An `Anti-Grain Geometry`_ (AGG) backend.                                                                                                                                                                                                  
     3 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
     4 │       │       │       │        │       │               │       │Features that are implemented:                                                                                                                                                                                                            
     5 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
     6 │       │       │       │        │       │               │       │* capstyles and join styles                                                                                                                                                                                                               
     7 │       │       │       │        │       │               │       │* dashes                                                                                                                                                                                                                                  
     8 │       │       │       │        │       │               │       │* linewidth                                                                                                                                                                                                                               
     9 │       │       │       │        │       │               │       │* lines, rectangles, ellipses                                                                                                                                                                                                             
    10 │       │       │       │        │       │               │       │* clipping to a rectangle                                                                                                                                                                                                                 
    11 │       │       │       │        │       │               │       │* output to RGBA and Pillow-supported image formats                                                                                                                                                                                       
    12 │       │       │       │        │       │               │       │* alpha blending                                                                                                                                                                                                                          
    13 │       │       │       │        │       │               │       │* DPI scaling properly - everything scales properly (dashes, linewidths, etc)                                                                                                                                                             
    14 │       │       │       │        │       │               │       │* draw polygon                                                                                                                                                                                                                            
    15 │       │       │       │        │       │               │       │* freetype2 w/ ft2font                                                                                                                                                                                                                    
    16 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    17 │       │       │       │        │       │               │       │Still TODO:                                                                                                                                                                                                                               
    18 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    19 │       │       │       │        │       │               │       │* integrate screen dpi w/ ppi and text                                                                                                                                                                                                    
    20 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    21 │       │       │       │        │       │               │       │.. _Anti-Grain Geometry: http://agg.sourceforge.net/antigrain.com                                                                                                                                                                         
    22 │       │       │       │        │       │               │       │"""                                                                                                                                                                                                                                       
    23 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    24 │       │       │       │        │       │               │       │from contextlib import nullcontext                                                                                                                                                                                                        
    25 │       │       │       │        │       │               │       │from math import radians, cos, sin                                                                                                                                                                                                        
    26 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    27 │       │       │       │        │       │               │       │import numpy as np                                                                                                                                                                                                                        
    28 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    29 │       │       │       │        │       │               │       │import matplotlib as mpl                                                                                                                                                                                                                  
    30 │       │       │       │        │       │               │       │from matplotlib import _api, cbook                                                                                                                                                                                                        
    31 │       │       │       │        │       │               │       │from matplotlib.backend_bases import (                                                                                                                                                                                                    
    32 │       │       │       │        │       │               │       │    _Backend, FigureCanvasBase, FigureManagerBase, RendererBase)                                                                                                                                                                          
    33 │       │       │       │        │       │               │       │from matplotlib.font_manager import fontManager as _fontManager, get_font                                                                                                                                                                 
    34 │       │       │       │        │       │               │       │from matplotlib.ft2font import LoadFlags                                                                                                                                                                                                  
    35 │       │       │       │        │       │               │       │from matplotlib.mathtext import MathTextParser                                                                                                                                                                                            
    36 │       │       │       │        │       │               │       │from matplotlib.path import Path                                                                                                                                                                                                          
    37 │       │       │       │        │       │               │       │from matplotlib.transforms import Bbox, BboxBase                                                                                                                                                                                          
    38 │       │       │       │        │       │               │       │from matplotlib.backends._backend_agg import RendererAgg as _RendererAgg                                                                                                                                                                  
    39 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    40 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    41 │       │       │       │        │       │               │       │def get_hinting_flag():                                                                                                                                                                                                                   
    42 │       │       │       │        │       │               │       │    mapping = {                                                                                                                                                                                                                           
    43 │       │       │       │        │       │               │       │        'default': LoadFlags.DEFAULT,                                                                                                                                                                                                     
    44 │       │       │       │        │       │               │       │        'no_autohint': LoadFlags.NO_AUTOHINT,                                                                                                                                                                                             
    45 │       │       │       │        │       │               │       │        'force_autohint': LoadFlags.FORCE_AUTOHINT,                                                                                                                                                                                       
    46 │       │       │       │        │       │               │       │        'no_hinting': LoadFlags.NO_HINTING,                                                                                                                                                                                               
    47 │       │       │       │        │       │               │       │        True: LoadFlags.FORCE_AUTOHINT,                                                                                                                                                                                                   
    48 │       │       │       │        │       │               │       │        False: LoadFlags.NO_HINTING,                                                                                                                                                                                                      
    49 │       │       │       │        │       │               │       │        'either': LoadFlags.DEFAULT,                                                                                                                                                                                                      
    50 │       │       │       │        │       │               │       │        'native': LoadFlags.NO_AUTOHINT,                                                                                                                                                                                                  
    51 │       │       │       │        │       │               │       │        'auto': LoadFlags.FORCE_AUTOHINT,                                                                                                                                                                                                 
    52 │       │       │       │        │       │               │       │        'none': LoadFlags.NO_HINTING,                                                                                                                                                                                                     
    53 │       │       │       │        │       │               │       │    }                                                                                                                                                                                                                                     
    54 │       │       │       │        │       │               │       │    return mapping[mpl.rcParams['text.hinting']]                                                                                                                                                                                          
    55 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    56 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    57 │       │       │       │        │       │               │       │class RendererAgg(RendererBase):                                                                                                                                                                                                          
    58 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    59 │       │       │       │        │       │               │       │    The renderer handles all the drawing primitives using a graphics                                                                                                                                                                      
    60 │       │       │       │        │       │               │       │    context instance that controls the colors/styles                                                                                                                                                                                      
    61 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    62 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    63 │       │       │       │        │       │               │       │    def __init__(self, width, height, dpi):                                                                                                                                                                                               
    64 │       │       │       │        │       │               │       │        super().__init__()                                                                                                                                                                                                                
    65 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    66 │       │       │       │        │       │               │       │        self.dpi = dpi                                                                                                                                                                                                                    
    67 │       │       │       │        │       │               │       │        self.width = width                                                                                                                                                                                                                
    68 │       │       │       │        │       │               │       │        self.height = height                                                                                                                                                                                                              
    69 │       │       │       │  46%   │  197M │▃▃▃▃▄▄▄▄  45%  │       │        self._renderer = _RendererAgg(int(width), int(height), dpi)                                                                                                                                                                       
    70 │       │       │       │        │       │               │       │        self._filter_renderers = []                                                                                                                                                                                                       
    71 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    72 │       │       │       │        │       │               │       │        self._update_methods()                                                                                                                                                                                                            
    73 │       │       │       │        │       │               │       │        self.mathtext_parser = MathTextParser('agg')                                                                                                                                                                                      
    74 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    75 │       │       │       │        │       │               │       │        self.bbox = Bbox.from_bounds(0, 0, self.width, self.height)                                                                                                                                                                       
    76 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    77 │       │       │       │        │       │               │       │    def __getstate__(self):                                                                                                                                                                                                               
    78 │       │       │       │        │       │               │       │        # We only want to preserve the init keywords of the Renderer.                                                                                                                                                                     
    79 │       │       │       │        │       │               │       │        # Anything else can be re-created.                                                                                                                                                                                                
    80 │       │       │       │        │       │               │       │        return {'width': self.width, 'height': self.height, 'dpi': self.dpi}                                                                                                                                                              
    81 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    82 │       │       │       │        │       │               │       │    def __setstate__(self, state):                                                                                                                                                                                                        
    83 │       │       │       │        │       │               │       │        self.__init__(state['width'], state['height'], state['dpi'])                                                                                                                                                                      
    84 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    85 │       │       │       │        │       │               │       │    def _update_methods(self):                                                                                                                                                                                                            
    86 │       │       │       │        │       │               │       │        self.draw_gouraud_triangles = self._renderer.draw_gouraud_triangles                                                                                                                                                               
    87 │       │       │       │        │       │               │       │        self.draw_image = self._renderer.draw_image                                                                                                                                                                                       
    88 │       │       │       │        │       │               │       │        self.draw_markers = self._renderer.draw_markers                                                                                                                                                                                   
    89 │       │       │       │        │       │               │       │        self.draw_path_collection = self._renderer.draw_path_collection                                                                                                                                                                   
    90 │       │       │       │        │       │               │       │        self.draw_quad_mesh = self._renderer.draw_quad_mesh                                                                                                                                                                               
    91 │       │       │       │        │       │               │       │        self.copy_from_bbox = self._renderer.copy_from_bbox                                                                                                                                                                               
    92 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    93 │       │       │       │        │       │               │       │    def draw_path(self, gc, path, transform, rgbFace=None):                                                                                                                                                                               
    94 │       │       │       │        │       │               │       │        # docstring inherited                                                                                                                                                                                                             
    95 │       │       │       │        │       │               │       │        nmax = mpl.rcParams['agg.path.chunksize']  # here at least for testing                                                                                                                                                            
    96 │       │       │       │        │       │               │       │        npts = path.vertices.shape[0]                                                                                                                                                                                                     
    97 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    98 │       │       │       │        │       │               │       │        if (npts > nmax > 100 and path.should_simplify and                                                                                                                                                                                
    99 │       │       │       │        │       │               │       │                rgbFace is None and gc.get_hatch() is None):                                                                                                                                                                              
   100 │       │       │       │        │       │               │       │            nch = np.ceil(npts / nmax)                                                                                                                                                                                                    
   101 │       │       │       │        │       │               │       │            chsize = int(np.ceil(npts / nch))                                                                                                                                                                                             
   102 │       │       │       │        │       │               │       │            i0 = np.arange(0, npts, chsize)                                                                                                                                                                                               
   103 │       │       │       │        │       │               │       │            i1 = np.zeros_like(i0)                                                                                                                                                                                                        
   104 │       │       │       │        │       │               │       │            i1[:-1] = i0[1:] - 1                                                                                                                                                                                                          
   105 │       │       │       │        │       │               │       │            i1[-1] = npts                                                                                                                                                                                                                 
   106 │       │       │       │        │       │               │       │            for ii0, ii1 in zip(i0, i1):                                                                                                                                                                                                  
   107 │       │       │       │        │       │               │       │                v = path.vertices[ii0:ii1, :]                                                                                                                                                                                             
   108 │       │       │       │        │       │               │       │                c = path.codes                                                                                                                                                                                                            
   109 │       │       │       │        │       │               │       │                if c is not None:                                                                                                                                                                                                         
   110 │       │       │       │        │       │               │       │                    c = c[ii0:ii1]                                                                                                                                                                                                        
   111 │       │       │       │        │       │               │       │                    c[0] = Path.MOVETO  # move to end of last chunk                                                                                                                                                                       
   112 │       │       │       │        │       │               │       │                p = Path(v, c)                                                                                                                                                                                                            
   113 │       │       │       │        │       │               │       │                p.simplify_threshold = path.simplify_threshold                                                                                                                                                                            
   114 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
   115 │       │       │       │        │       │               │       │                    self._renderer.draw_path(gc, p, transform, rgbFace)                                                                                                                                                                   
   116 │       │       │       │        │       │               │       │                except OverflowError:                                                                                                                                                                                                     
   117 │       │       │       │        │       │               │       │                    msg = (                                                                                                                                                                                                               
   118 │       │       │       │        │       │               │       │                        "Exceeded cell block limit in Agg.\n\n"                                                                                                                                                                           
   119 │       │       │       │        │       │               │       │                        "Please reduce the value of "                                                                                                                                                                                     
   120 │       │       │       │        │       │               │       │                        f"rcParams['agg.path.chunksize'] (currently {nmax}) "                                                                                                                                                             
   121 │       │       │       │        │       │               │       │                        "or increase the path simplification threshold"                                                                                                                                                                   
   122 │       │       │       │        │       │               │       │                        "(rcParams['path.simplify_threshold'] = "                                                                                                                                                                         
   123 │       │       │       │        │       │               │       │                        f"{mpl.rcParams['path.simplify_threshold']:.2f} by "                                                                                                                                                              
   124 │       │       │       │        │       │               │       │                        "default and path.simplify_threshold = "                                                                                                                                                                          
   125 │       │       │       │        │       │               │       │                        f"{path.simplify_threshold:.2f} on the input)."                                                                                                                                                                   
   126 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
   127 │       │       │       │        │       │               │       │                    raise OverflowError(msg) from None                                                                                                                                                                                    
   128 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   129 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
   130 │       │       │       │        │       │               │       │                self._renderer.draw_path(gc, path, transform, rgbFace)                                                                                                                                                                    
   131 │       │       │       │        │       │               │       │            except OverflowError:                                                                                                                                                                                                         
   132 │       │       │       │        │       │               │       │                cant_chunk = ''                                                                                                                                                                                                           
   133 │       │       │       │        │       │               │       │                if rgbFace is not None:                                                                                                                                                                                                   
   134 │       │       │       │        │       │               │       │                    cant_chunk += "- cannot split filled path\n"                                                                                                                                                                          
   135 │       │       │       │        │       │               │       │                if gc.get_hatch() is not None:                                                                                                                                                                                            
   136 │       │       │       │        │       │               │       │                    cant_chunk += "- cannot split hatched path\n"                                                                                                                                                                         
   137 │       │       │       │        │       │               │       │                if not path.should_simplify:                                                                                                                                                                                              
   138 │       │       │       │        │       │               │       │                    cant_chunk += "- path.should_simplify is False\n"                                                                                                                                                                     
   139 │       │       │       │        │       │               │       │                if len(cant_chunk):                                                                                                                                                                                                       
   140 │       │       │       │        │       │               │       │                    msg = (                                                                                                                                                                                                               
   141 │       │       │       │        │       │               │       │                        "Exceeded cell block limit in Agg, however for the "                                                                                                                                                              
   142 │       │       │       │        │       │               │       │                        "following reasons:\n\n"                                                                                                                                                                                          
   143 │       │       │       │        │       │               │       │                        f"{cant_chunk}\n"                                                                                                                                                                                                 
   144 │       │       │       │        │       │               │       │                        "we cannot automatically split up this path to draw."                                                                                                                                                             
   145 │       │       │       │        │       │               │       │                        "\n\nPlease manually simplify your path."                                                                                                                                                                         
   146 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
   147 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   148 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
   149 │       │       │       │        │       │               │       │                    inc_threshold = (                                                                                                                                                                                                     
   150 │       │       │       │        │       │               │       │                        "or increase the path simplification threshold"                                                                                                                                                                   
   151 │       │       │       │        │       │               │       │                        "(rcParams['path.simplify_threshold'] = "                                                                                                                                                                         
   152 │       │       │       │        │       │               │       │                        f"{mpl.rcParams['path.simplify_threshold']} "                                                                                                                                                                     
   153 │       │       │       │        │       │               │       │                        "by default and path.simplify_threshold "                                                                                                                                                                         
   154 │       │       │       │        │       │               │       │                        f"= {path.simplify_threshold} "                                                                                                                                                                                   
   155 │       │       │       │        │       │               │       │                        "on the input)."                                                                                                                                                                                                  
   156 │       │       │       │        │       │               │       │                        )                                                                                                                                                                                                                 
   157 │       │       │       │        │       │               │       │                    if nmax > 100:                                                                                                                                                                                                        
   158 │       │       │       │        │       │               │       │                        msg = (                                                                                                                                                                                                           
   159 │       │       │       │        │       │               │       │                            "Exceeded cell block limit in Agg.  Please reduce "                                                                                                                                                           
   160 │       │       │       │        │       │               │       │                            "the value of rcParams['agg.path.chunksize'] "                                                                                                                                                                
   161 │       │       │       │        │       │               │       │                            f"(currently {nmax}) {inc_threshold}"                                                                                                                                                                         
   162 │       │       │       │        │       │               │       │                        )                                                                                                                                                                                                                 
   163 │       │       │       │        │       │               │       │                    else:                                                                                                                                                                                                                 
   164 │       │       │       │        │       │               │       │                        msg = (                                                                                                                                                                                                           
   165 │       │       │       │        │       │               │       │                            "Exceeded cell block limit in Agg.  Please set "                                                                                                                                                              
   166 │       │       │       │        │       │               │       │                            "the value of rcParams['agg.path.chunksize'], "                                                                                                                                                               
   167 │       │       │       │        │       │               │       │                            f"(currently {nmax}) to be greater than 100 "                                                                                                                                                                 
   168 │       │       │       │        │       │               │       │                            + inc_threshold                                                                                                                                                                                               
   169 │       │       │       │        │       │               │       │                        )                                                                                                                                                                                                                 
   170 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   171 │       │       │       │        │       │               │       │                raise OverflowError(msg) from None                                                                                                                                                                                        
   172 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   173 │       │       │       │        │       │               │       │    def draw_mathtext(self, gc, x, y, s, prop, angle):                                                                                                                                                                                    
   174 │       │       │       │        │       │               │       │        """Draw mathtext using :mod:`matplotlib.mathtext`."""                                                                                                                                                                             
   175 │       │       │       │        │       │               │       │        ox, oy, width, height, descent, font_image = \                                                                                                                                                                                    
   176 │       │       │       │        │       │               │       │            self.mathtext_parser.parse(s, self.dpi, prop,                                                                                                                                                                                 
   177 │       │       │       │        │       │               │       │                                       antialiased=gc.get_antialiased())                                                                                                                                                                  
   178 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   179 │       │       │       │        │       │               │       │        xd = descent * sin(radians(angle))                                                                                                                                                                                                
   180 │       │       │       │        │       │               │       │        yd = descent * cos(radians(angle))                                                                                                                                                                                                
   181 │       │       │       │        │       │               │       │        x = round(x + ox + xd)                                                                                                                                                                                                            
   182 │       │       │       │        │       │               │       │        y = round(y - oy + yd)                                                                                                                                                                                                            
   183 │       │       │       │        │       │               │       │        self._renderer.draw_text_image(font_image, x, y + 1, angle, gc)                                                                                                                                                                   
   184 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   185 │       │       │       │        │       │               │       │    def draw_text(self, gc, x, y, s, prop, angle, ismath=False, mtext=None):                                                                                                                                                              
   186 │       │       │       │        │       │               │       │        # docstring inherited                                                                                                                                                                                                             
   187 │       │       │       │        │       │               │       │        if ismath:                                                                                                                                                                                                                        
   188 │       │       │       │        │       │               │       │            return self.draw_mathtext(gc, x, y, s, prop, angle)                                                                                                                                                                           
   189 │       │       │       │        │       │               │       │        font = self._prepare_font(prop)                                                                                                                                                                                                   
   190 │       │       │       │        │       │               │       │        # We pass '0' for angle here, since it will be rotated (in raster                                                                                                                                                                 
   191 │       │       │       │        │       │               │       │        # space) in the following call to draw_text_image).                                                                                                                                                                               
   192 │       │       │       │        │       │               │       │        font.set_text(s, 0, flags=get_hinting_flag())                                                                                                                                                                                     
   193 │       │       │       │        │       │               │       │        font.draw_glyphs_to_bitmap(                                                                                                                                                                                                       
   194 │       │       │       │        │       │               │       │            antialiased=gc.get_antialiased())                                                                                                                                                                                             
   195 │       │       │       │        │       │               │       │        d = font.get_descent() / 64.0                                                                                                                                                                                                     
   196 │       │       │       │        │       │               │       │        # The descent needs to be adjusted for the angle.                                                                                                                                                                                 
   197 │       │       │       │        │       │               │       │        xo, yo = font.get_bitmap_offset()                                                                                                                                                                                                 
   198 │       │       │       │        │       │               │       │        xo /= 64.0                                                                                                                                                                                                                        
   199 │       │       │       │        │       │               │       │        yo /= 64.0                                                                                                                                                                                                                        
   200 │       │       │       │        │       │               │       │        xd = d * sin(radians(angle))                                                                                                                                                                                                      
   201 │       │       │       │        │       │               │       │        yd = d * cos(radians(angle))                                                                                                                                                                                                      
   202 │       │       │       │        │       │               │       │        x = round(x + xo + xd)                                                                                                                                                                                                            
   203 │       │       │       │        │       │               │       │        y = round(y + yo + yd)                                                                                                                                                                                                            
   204 │       │       │       │        │       │               │       │        self._renderer.draw_text_image(font, x, y + 1, angle, gc)                                                                                                                                                                         
   205 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   206 │       │       │       │        │       │               │       │    def get_text_width_height_descent(self, s, prop, ismath):                                                                                                                                                                             
   207 │       │       │       │        │       │               │       │        # docstring inherited                                                                                                                                                                                                             
   208 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   209 │       │       │       │        │       │               │       │        _api.check_in_list(["TeX", True, False], ismath=ismath)                                                                                                                                                                           
   210 │       │       │       │        │       │               │       │        if ismath == "TeX":                                                                                                                                                                                                               
   211 │       │       │       │        │       │               │       │            return super().get_text_width_height_descent(s, prop, ismath)                                                                                                                                                                 
   212 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   213 │       │       │       │        │       │               │       │        if ismath:                                                                                                                                                                                                                        
   214 │       │       │       │        │       │               │       │            ox, oy, width, height, descent, font_image = \                                                                                                                                                                                
   215 │       │       │       │        │       │               │       │                self.mathtext_parser.parse(s, self.dpi, prop)                                                                                                                                                                             
   216 │       │       │       │        │       │               │       │            return width, height, descent                                                                                                                                                                                                 
   217 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   218 │       │       │       │        │       │               │       │        font = self._prepare_font(prop)                                                                                                                                                                                                   
   219 │       │       │       │        │       │               │       │        font.set_text(s, 0.0, flags=get_hinting_flag())                                                                                                                                                                                   
   220 │       │       │       │        │       │               │       │        w, h = font.get_width_height()  # width and height of unrotated string                                                                                                                                                            
   221 │       │       │       │        │       │               │       │        d = font.get_descent()                                                                                                                                                                                                            
   222 │       │       │       │        │       │               │       │        w /= 64.0  # convert from subpixels                                                                                                                                                                                               
   223 │       │       │       │        │       │               │       │        h /= 64.0                                                                                                                                                                                                                         
   224 │       │       │       │        │       │               │       │        d /= 64.0                                                                                                                                                                                                                         
   225 │       │       │       │        │       │               │       │        return w, h, d                                                                                                                                                                                                                    
   226 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   227 │       │       │       │        │       │               │       │    def draw_tex(self, gc, x, y, s, prop, angle, *, mtext=None):                                                                                                                                                                          
   228 │       │       │       │        │       │               │       │        # docstring inherited                                                                                                                                                                                                             
   229 │       │       │       │        │       │               │       │        # todo, handle props, angle, origins                                                                                                                                                                                              
   230 │       │       │       │        │       │               │       │        size = prop.get_size_in_points()                                                                                                                                                                                                  
   231 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   232 │       │       │       │        │       │               │       │        texmanager = self.get_texmanager()                                                                                                                                                                                                
   233 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   234 │       │       │       │        │       │               │       │        Z = texmanager.get_grey(s, size, self.dpi)                                                                                                                                                                                        
   235 │       │       │       │        │       │               │       │        Z = np.array(Z * 255.0, np.uint8)                                                                                                                                                                                                 
   236 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   237 │       │       │       │        │       │               │       │        w, h, d = self.get_text_width_height_descent(s, prop, ismath="TeX")                                                                                                                                                               
   238 │       │       │       │        │       │               │       │        xd = d * sin(radians(angle))                                                                                                                                                                                                      
   239 │       │       │       │        │       │               │       │        yd = d * cos(radians(angle))                                                                                                                                                                                                      
   240 │       │       │       │        │       │               │       │        x = round(x + xd)                                                                                                                                                                                                                 
   241 │       │       │       │        │       │               │       │        y = round(y + yd)                                                                                                                                                                                                                 
   242 │       │       │       │        │       │               │       │        self._renderer.draw_text_image(Z, x, y, angle, gc)                                                                                                                                                                                
   243 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   244 │       │       │       │        │       │               │       │    def get_canvas_width_height(self):                                                                                                                                                                                                    
   245 │       │       │       │        │       │               │       │        # docstring inherited                                                                                                                                                                                                             
   246 │       │       │       │        │       │               │       │        return self.width, self.height                                                                                                                                                                                                    
   247 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   248 │       │       │       │        │       │               │       │    def _prepare_font(self, font_prop):                                                                                                                                                                                                   
   249 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   250 │       │       │       │        │       │               │       │        Get the `.FT2Font` for *font_prop*, clear its buffer, and set its size.                                                                                                                                                           
   251 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   252 │       │       │       │        │       │               │       │        font = get_font(_fontManager._find_fonts_by_props(font_prop))                                                                                                                                                                     
   253 │       │       │       │        │       │               │       │        font.clear()                                                                                                                                                                                                                      
   254 │       │       │       │        │       │               │       │        size = font_prop.get_size_in_points()                                                                                                                                                                                             
   255 │       │       │       │        │       │               │       │        font.set_size(size, self.dpi)                                                                                                                                                                                                     
   256 │       │       │       │        │       │               │       │        return font                                                                                                                                                                                                                       
   257 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   258 │       │       │       │        │       │               │       │    def points_to_pixels(self, points):                                                                                                                                                                                                   
   259 │       │       │       │        │       │               │       │        # docstring inherited                                                                                                                                                                                                             
   260 │       │       │       │        │       │               │       │        return points * self.dpi / 72                                                                                                                                                                                                     
   261 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   262 │       │       │       │        │       │               │       │    def buffer_rgba(self):                                                                                                                                                                                                                
   263 │       │       │       │        │       │               │       │        return memoryview(self._renderer)                                                                                                                                                                                                 
   264 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   265 │       │       │       │        │       │               │       │    def tostring_argb(self):                                                                                                                                                                                                              
   266 │       │       │       │        │       │               │       │        return np.asarray(self._renderer).take([3, 0, 1, 2], axis=2).tobytes()                                                                                                                                                            
   267 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   268 │       │       │       │        │       │               │       │    def clear(self):                                                                                                                                                                                                                      
   269 │       │       │       │        │       │               │       │        self._renderer.clear()                                                                                                                                                                                                            
   270 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   271 │       │       │       │        │       │               │       │    def option_image_nocomposite(self):                                                                                                                                                                                                   
   272 │       │       │       │        │       │               │       │        # docstring inherited                                                                                                                                                                                                             
   273 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   274 │       │       │       │        │       │               │       │        # It is generally faster to composite each image directly to                                                                                                                                                                      
   275 │       │       │       │        │       │               │       │        # the Figure, and there's no file size benefit to compositing                                                                                                                                                                     
   276 │       │       │       │        │       │               │       │        # with the Agg backend                                                                                                                                                                                                            
   277 │       │       │       │        │       │               │       │        return True                                                                                                                                                                                                                       
   278 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   279 │       │       │       │        │       │               │       │    def option_scale_image(self):                                                                                                                                                                                                         
   280 │       │       │       │        │       │               │       │        # docstring inherited                                                                                                                                                                                                             
   281 │       │       │       │        │       │               │       │        return False                                                                                                                                                                                                                      
   282 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   283 │       │       │       │        │       │               │       │    def restore_region(self, region, bbox=None, xy=None):                                                                                                                                                                                 
   284 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   285 │       │       │       │        │       │               │       │        Restore the saved region. If bbox (instance of BboxBase, or                                                                                                                                                                       
   286 │       │       │       │        │       │               │       │        its extents) is given, only the region specified by the bbox                                                                                                                                                                      
   287 │       │       │       │        │       │               │       │        will be restored. *xy* (a pair of floats) optionally                                                                                                                                                                              
   288 │       │       │       │        │       │               │       │        specifies the new position (the LLC of the original region,                                                                                                                                                                       
   289 │       │       │       │        │       │               │       │        not the LLC of the bbox) where the region will be restored.                                                                                                                                                                       
   290 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   291 │       │       │       │        │       │               │       │        >>> region = renderer.copy_from_bbox()                                                                                                                                                                                            
   292 │       │       │       │        │       │               │       │        >>> x1, y1, x2, y2 = region.get_extents()                                                                                                                                                                                         
   293 │       │       │       │        │       │               │       │        >>> renderer.restore_region(region, bbox=(x1+dx, y1, x2, y2),                                                                                                                                                                     
   294 │       │       │       │        │       │               │       │        ...                         xy=(x1-dx, y1))                                                                                                                                                                                       
   295 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   296 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   297 │       │       │       │        │       │               │       │        if bbox is not None or xy is not None:                                                                                                                                                                                            
   298 │       │       │       │        │       │               │       │            if bbox is None:                                                                                                                                                                                                              
   299 │       │       │       │        │       │               │       │                x1, y1, x2, y2 = region.get_extents()                                                                                                                                                                                     
   300 │       │       │       │        │       │               │       │            elif isinstance(bbox, BboxBase):                                                                                                                                                                                              
   301 │       │       │       │        │       │               │       │                x1, y1, x2, y2 = bbox.extents                                                                                                                                                                                             
   302 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   303 │       │       │       │        │       │               │       │                x1, y1, x2, y2 = bbox                                                                                                                                                                                                     
   304 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   305 │       │       │       │        │       │               │       │            if xy is None:                                                                                                                                                                                                                
   306 │       │       │       │        │       │               │       │                ox, oy = x1, y1                                                                                                                                                                                                           
   307 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   308 │       │       │       │        │       │               │       │                ox, oy = xy                                                                                                                                                                                                               
   309 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   310 │       │       │       │        │       │               │       │            # The incoming data is float, but the _renderer type-checking wants                                                                                                                                                           
   311 │       │       │       │        │       │               │       │            # to see integers.                                                                                                                                                                                                            
   312 │       │       │       │        │       │               │       │            self._renderer.restore_region(region, int(x1), int(y1),                                                                                                                                                                       
   313 │       │       │       │        │       │               │       │                                          int(x2), int(y2), int(ox), int(oy))                                                                                                                                                             
   314 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   315 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   316 │       │       │       │        │       │               │       │            self._renderer.restore_region(region)                                                                                                                                                                                         
   317 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   318 │       │       │       │        │       │               │       │    def start_filter(self):                                                                                                                                                                                                               
   319 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   320 │       │       │       │        │       │               │       │        Start filtering. It simply creates a new canvas (the old one is saved).                                                                                                                                                           
   321 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   322 │       │       │       │        │       │               │       │        self._filter_renderers.append(self._renderer)                                                                                                                                                                                     
   323 │       │       │       │        │       │               │       │        self._renderer = _RendererAgg(int(self.width), int(self.height),                                                                                                                                                                  
   324 │       │       │       │        │       │               │       │                                      self.dpi)                                                                                                                                                                                           
   325 │       │       │       │        │       │               │       │        self._update_methods()                                                                                                                                                                                                            
   326 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   327 │       │       │       │        │       │               │       │    def stop_filter(self, post_processing):                                                                                                                                                                                               
   328 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   329 │       │       │       │        │       │               │       │        Save the current canvas as an image and apply post processing.                                                                                                                                                                    
   330 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   331 │       │       │       │        │       │               │       │        The *post_processing* function::                                                                                                                                                                                                  
   332 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   333 │       │       │       │        │       │               │       │           def post_processing(image, dpi):                                                                                                                                                                                               
   334 │       │       │       │        │       │               │       │             # ny, nx, depth = image.shape                                                                                                                                                                                                
   335 │       │       │       │        │       │               │       │             # image (numpy array) has RGBA channels and has a depth of 4.                                                                                                                                                                
   336 │       │       │       │        │       │               │       │             ...                                                                                                                                                                                                                          
   337 │       │       │       │        │       │               │       │             # create a new_image (numpy array of 4 channels, size can be                                                                                                                                                                 
   338 │       │       │       │        │       │               │       │             # different). The resulting image may have offsets from                                                                                                                                                                      
   339 │       │       │       │        │       │               │       │             # lower-left corner of the original image                                                                                                                                                                                    
   340 │       │       │       │        │       │               │       │             return new_image, offset_x, offset_y                                                                                                                                                                                         
   341 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   342 │       │       │       │        │       │               │       │        The saved renderer is restored and the returned image from                                                                                                                                                                        
   343 │       │       │       │        │       │               │       │        post_processing is plotted (using draw_image) on it.                                                                                                                                                                              
   344 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   345 │       │       │       │        │       │               │       │        orig_img = np.asarray(self.buffer_rgba())                                                                                                                                                                                         
   346 │       │       │       │        │       │               │       │        slice_y, slice_x = cbook._get_nonzero_slices(orig_img[..., 3])                                                                                                                                                                    
   347 │       │       │       │        │       │               │       │        cropped_img = orig_img[slice_y, slice_x]                                                                                                                                                                                          
   348 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   349 │       │       │       │        │       │               │       │        self._renderer = self._filter_renderers.pop()                                                                                                                                                                                     
   350 │       │       │       │        │       │               │       │        self._update_methods()                                                                                                                                                                                                            
   351 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   352 │       │       │       │        │       │               │       │        if cropped_img.size:                                                                                                                                                                                                              
   353 │       │       │       │        │       │               │       │            img, ox, oy = post_processing(cropped_img / 255, self.dpi)                                                                                                                                                                    
   354 │       │       │       │        │       │               │       │            gc = self.new_gc()                                                                                                                                                                                                            
   355 │       │       │       │        │       │               │       │            if img.dtype.kind == 'f':                                                                                                                                                                                                     
   356 │       │       │       │        │       │               │       │                img = np.asarray(img * 255., np.uint8)                                                                                                                                                                                    
   357 │       │       │       │        │       │               │       │            self._renderer.draw_image(                                                                                                                                                                                                    
   358 │       │       │       │        │       │               │       │                gc, slice_x.start + ox, int(self.height) - slice_y.stop + oy,                                                                                                                                                             
   359 │       │       │       │        │       │               │       │                img[::-1])                                                                                                                                                                                                                
   360 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   361 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   362 │       │       │       │        │       │               │       │class FigureCanvasAgg(FigureCanvasBase):                                                                                                                                                                                                  
   363 │       │       │       │        │       │               │       │    # docstring inherited                                                                                                                                                                                                                 
   364 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   365 │       │       │       │        │       │               │       │    _lastKey = None  # Overwritten per-instance on the first draw.                                                                                                                                                                        
   366 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   367 │       │       │       │        │       │               │       │    def copy_from_bbox(self, bbox):                                                                                                                                                                                                       
   368 │       │       │       │        │       │               │       │        renderer = self.get_renderer()                                                                                                                                                                                                    
   369 │       │       │       │        │       │               │       │        return renderer.copy_from_bbox(bbox)                                                                                                                                                                                              
   370 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   371 │       │       │       │        │       │               │       │    def restore_region(self, region, bbox=None, xy=None):                                                                                                                                                                                 
   372 │       │       │       │        │       │               │       │        renderer = self.get_renderer()                                                                                                                                                                                                    
   373 │       │       │       │        │       │               │       │        return renderer.restore_region(region, bbox, xy)                                                                                                                                                                                  
   374 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   375 │       │       │       │        │       │               │       │    def draw(self):                                                                                                                                                                                                                       
   376 │       │       │       │        │       │               │       │        # docstring inherited                                                                                                                                                                                                             
   377 │       │       │       │        │       │               │       │        self.renderer = self.get_renderer()                                                                                                                                                                                               
   378 │       │       │       │        │       │               │       │        self.renderer.clear()                                                                                                                                                                                                             
   379 │       │       │       │        │       │               │       │        # Acquire a lock on the shared font cache.                                                                                                                                                                                        
   380 │       │       │       │        │       │               │       │        with (self.toolbar._wait_cursor_for_draw_cm() if self.toolbar                                                                                                                                                                     
   381 │       │       │       │        │       │               │       │              else nullcontext()):                                                                                                                                                                                                        
   382 │       │       │       │        │       │               │       │            self.figure.draw(self.renderer)                                                                                                                                                                                               
   383 │       │       │       │        │       │               │       │            # A GUI class may be need to update a window using this draw, so                                                                                                                                                              
   384 │       │       │       │        │       │               │       │            # don't forget to call the superclass.                                                                                                                                                                                        
   385 │       │       │       │        │       │               │       │            super().draw()                                                                                                                                                                                                                
   386 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   387 │       │       │       │        │       │               │       │    def get_renderer(self):                                                                                                                                                                                                               
   388 │       │       │       │        │       │               │       │        w, h = self.figure.bbox.size                                                                                                                                                                                                      
   389 │       │       │       │        │       │               │       │        key = w, h, self.figure.dpi                                                                                                                                                                                                       
   390 │       │       │       │        │       │               │       │        reuse_renderer = (self._lastKey == key)                                                                                                                                                                                           
   391 │       │       │       │        │       │               │       │        if not reuse_renderer:                                                                                                                                                                                                            
   392 │       │       │       │        │       │               │       │            self.renderer = RendererAgg(w, h, self.figure.dpi)                                                                                                                                                                            
   393 │       │       │       │        │       │               │       │            self._lastKey = key                                                                                                                                                                                                           
   394 │       │       │       │        │       │               │       │        return self.renderer                                                                                                                                                                                                              
   395 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   396 │       │       │       │        │       │               │       │    def tostring_argb(self):                                                                                                                                                                                                              
   397 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   398 │       │       │       │        │       │               │       │        Get the image as ARGB `bytes`.                                                                                                                                                                                                    
   399 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   400 │       │       │       │        │       │               │       │        `draw` must be called at least once before this function will work and                                                                                                                                                            
   401 │       │       │       │        │       │               │       │        to update the renderer for any subsequent changes to the Figure.                                                                                                                                                                  
   402 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   403 │       │       │       │        │       │               │       │        return self.renderer.tostring_argb()                                                                                                                                                                                              
   404 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   405 │       │       │       │        │       │               │       │    def buffer_rgba(self):                                                                                                                                                                                                                
   406 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   407 │       │       │       │        │       │               │       │        Get the image as a `memoryview` to the renderer's buffer.                                                                                                                                                                         
   408 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   409 │       │       │       │        │       │               │       │        `draw` must be called at least once before this function will work and                                                                                                                                                            
   410 │       │       │       │        │       │               │       │        to update the renderer for any subsequent changes to the Figure.                                                                                                                                                                  
   411 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   412 │       │       │       │        │       │               │       │        return self.renderer.buffer_rgba()                                                                                                                                                                                                
   413 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   414 │       │       │       │        │       │               │       │    def print_raw(self, filename_or_obj, *, metadata=None):                                                                                                                                                                               
   415 │       │       │       │        │       │               │       │        if metadata is not None:                                                                                                                                                                                                          
   416 │       │       │       │        │       │               │       │            raise ValueError("metadata not supported for raw/rgba")                                                                                                                                                                       
   417 │       │       │       │        │       │               │       │        FigureCanvasAgg.draw(self)                                                                                                                                                                                                        
   418 │       │       │       │        │       │               │       │        renderer = self.get_renderer()                                                                                                                                                                                                    
   419 │       │       │       │        │       │               │       │        with cbook.open_file_cm(filename_or_obj, "wb") as fh:                                                                                                                                                                             
   420 │       │       │       │        │       │               │       │            fh.write(renderer.buffer_rgba())                                                                                                                                                                                              
   421 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   422 │       │       │       │        │       │               │       │    print_rgba = print_raw                                                                                                                                                                                                                
   423 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   424 │       │       │       │        │       │               │       │    def _print_pil(self, filename_or_obj, fmt, pil_kwargs, metadata=None):                                                                                                                                                                
   425 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   426 │       │       │       │        │       │               │       │        Draw the canvas, then save it using `.image.imsave` (to which                                                                                                                                                                     
   427 │       │       │       │        │       │               │       │        *pil_kwargs* and *metadata* are forwarded).                                                                                                                                                                                       
   428 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   429 │       │       │       │        │       │               │       │        FigureCanvasAgg.draw(self)                                                                                                                                                                                                        
   430 │       │       │       │        │       │               │       │        mpl.image.imsave(                                                                                                                                                                                                                 
   431 │       │       │       │        │       │               │       │            filename_or_obj, self.buffer_rgba(), format=fmt, origin="upper",                                                                                                                                                              
   432 │       │       │       │        │       │               │       │            dpi=self.figure.dpi, metadata=metadata, pil_kwargs=pil_kwargs)                                                                                                                                                                
   433 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   434 │       │       │       │        │       │               │       │    def print_png(self, filename_or_obj, *, metadata=None, pil_kwargs=None):                                                                                                                                                              
   435 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   436 │       │       │       │        │       │               │       │        Write the figure to a PNG file.                                                                                                                                                                                                   
   437 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   438 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   439 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   440 │       │       │       │        │       │               │       │        filename_or_obj : str or path-like or file-like                                                                                                                                                                                   
   441 │       │       │       │        │       │               │       │            The file to write to.                                                                                                                                                                                                         
   442 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   443 │       │       │       │        │       │               │       │        metadata : dict, optional                                                                                                                                                                                                         
   444 │       │       │       │        │       │               │       │            Metadata in the PNG file as key-value pairs of bytes or latin-1                                                                                                                                                               
   445 │       │       │       │        │       │               │       │            encodable strings.                                                                                                                                                                                                            
   446 │       │       │       │        │       │               │       │            According to the PNG specification, keys must be shorter than 79                                                                                                                                                              
   447 │       │       │       │        │       │               │       │            chars.                                                                                                                                                                                                                        
   448 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   449 │       │       │       │        │       │               │       │            The `PNG specification`_ defines some common keywords that may be                                                                                                                                                             
   450 │       │       │       │        │       │               │       │            used as appropriate:                                                                                                                                                                                                          
   451 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   452 │       │       │       │        │       │               │       │            - Title: Short (one line) title or caption for image.                                                                                                                                                                         
   453 │       │       │       │        │       │               │       │            - Author: Name of image's creator.                                                                                                                                                                                            
   454 │       │       │       │        │       │               │       │            - Description: Description of image (possibly long).                                                                                                                                                                          
   455 │       │       │       │        │       │               │       │            - Copyright: Copyright notice.                                                                                                                                                                                                
   456 │       │       │       │        │       │               │       │            - Creation Time: Time of original image creation                                                                                                                                                                              
   457 │       │       │       │        │       │               │       │              (usually RFC 1123 format).                                                                                                                                                                                                  
   458 │       │       │       │        │       │               │       │            - Software: Software used to create the image.                                                                                                                                                                                
   459 │       │       │       │        │       │               │       │            - Disclaimer: Legal disclaimer.                                                                                                                                                                                               
   460 │       │       │       │        │       │               │       │            - Warning: Warning of nature of content.                                                                                                                                                                                      
   461 │       │       │       │        │       │               │       │            - Source: Device used to create the image.                                                                                                                                                                                    
   462 │       │       │       │        │       │               │       │            - Comment: Miscellaneous comment;                                                                                                                                                                                             
   463 │       │       │       │        │       │               │       │              conversion from other image format.                                                                                                                                                                                         
   464 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   465 │       │       │       │        │       │               │       │            Other keywords may be invented for other purposes.                                                                                                                                                                            
   466 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   467 │       │       │       │        │       │               │       │            If 'Software' is not given, an autogenerated value for Matplotlib                                                                                                                                                             
   468 │       │       │       │        │       │               │       │            will be used.  This can be removed by setting it to *None*.                                                                                                                                                                   
   469 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   470 │       │       │       │        │       │               │       │            For more details see the `PNG specification`_.                                                                                                                                                                                
   471 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   472 │       │       │       │        │       │               │       │            .. _PNG specification: \                                                                                                                                                                                                      
   473 │       │       │       │        │       │               │       │                https://www.w3.org/TR/2003/REC-PNG-20031110/#11keywords                                                                                                                                                                   
   474 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   475 │       │       │       │        │       │               │       │        pil_kwargs : dict, optional                                                                                                                                                                                                       
   476 │       │       │       │        │       │               │       │            Keyword arguments passed to `PIL.Image.Image.save`.                                                                                                                                                                           
   477 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   478 │       │       │       │        │       │               │       │            If the 'pnginfo' key is present, it completely overrides                                                                                                                                                                      
   479 │       │       │       │        │       │               │       │            *metadata*, including the default 'Software' key.                                                                                                                                                                             
   480 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   481 │       │       │       │        │       │               │       │        self._print_pil(filename_or_obj, "png", pil_kwargs, metadata)                                                                                                                                                                     
   482 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   483 │       │       │       │        │       │               │       │    def print_to_buffer(self):                                                                                                                                                                                                            
   484 │       │       │       │        │       │               │       │        FigureCanvasAgg.draw(self)                                                                                                                                                                                                        
   485 │       │       │       │        │       │               │       │        renderer = self.get_renderer()                                                                                                                                                                                                    
   486 │       │       │       │        │       │               │       │        return (bytes(renderer.buffer_rgba()),                                                                                                                                                                                            
   487 │       │       │       │        │       │               │       │                (int(renderer.width), int(renderer.height)))                                                                                                                                                                              
   488 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   489 │       │       │       │        │       │               │       │    # Note that these methods should typically be called via savefig() and                                                                                                                                                                
   490 │       │       │       │        │       │               │       │    # print_figure(), and the latter ensures that `self.figure.dpi` already                                                                                                                                                               
   491 │       │       │       │        │       │               │       │    # matches the dpi kwarg (if any).                                                                                                                                                                                                     
   492 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   493 │       │       │       │        │       │               │       │    def print_jpg(self, filename_or_obj, *, metadata=None, pil_kwargs=None):                                                                                                                                                              
   494 │       │       │       │        │       │               │       │        # savefig() has already applied savefig.facecolor; we now set it to                                                                                                                                                               
   495 │       │       │       │        │       │               │       │        # white to make imsave() blend semi-transparent figures against an                                                                                                                                                                
   496 │       │       │       │        │       │               │       │        # assumed white background.                                                                                                                                                                                                       
   497 │       │       │       │        │       │               │       │        with mpl.rc_context({"savefig.facecolor": "white"}):                                                                                                                                                                              
   498 │       │       │       │        │       │               │       │            self._print_pil(filename_or_obj, "jpeg", pil_kwargs, metadata)                                                                                                                                                                
   499 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   500 │       │       │       │        │       │               │       │    print_jpeg = print_jpg                                                                                                                                                                                                                
   501 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   502 │       │       │       │        │       │               │       │    def print_tif(self, filename_or_obj, *, metadata=None, pil_kwargs=None):                                                                                                                                                              
   503 │       │       │       │        │       │               │       │        self._print_pil(filename_or_obj, "tiff", pil_kwargs, metadata)                                                                                                                                                                    
   504 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   505 │       │       │       │        │       │               │       │    print_tiff = print_tif                                                                                                                                                                                                                
   506 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   507 │       │       │       │        │       │               │       │    def print_webp(self, filename_or_obj, *, metadata=None, pil_kwargs=None):                                                                                                                                                             
   508 │       │       │       │        │       │               │       │        self._print_pil(filename_or_obj, "webp", pil_kwargs, metadata)                                                                                                                                                                    
   509 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   510 │       │       │       │        │       │               │       │    print_jpg.__doc__, print_tif.__doc__, print_webp.__doc__ = map(                                                                                                                                                                       
   511 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   512 │       │       │       │        │       │               │       │        Write the figure to a {} file.                                                                                                                                                                                                    
   513 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   514 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   515 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   516 │       │       │       │        │       │               │       │        filename_or_obj : str or path-like or file-like                                                                                                                                                                                   
   517 │       │       │       │        │       │               │       │            The file to write to.                                                                                                                                                                                                         
   518 │       │       │       │        │       │               │       │        pil_kwargs : dict, optional                                                                                                                                                                                                       
   519 │       │       │       │        │       │               │       │            Additional keyword arguments that are passed to                                                                                                                                                                               
   520 │       │       │       │        │       │               │       │            `PIL.Image.Image.save` when saving the figure.                                                                                                                                                                                
   521 │       │       │       │        │       │               │       │        """.format, ["JPEG", "TIFF", "WebP"])                                                                                                                                                                                             
   522 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   523 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   524 │       │       │       │        │       │               │       │@_Backend.export                                                                                                                                                                                                                          
   525 │       │       │       │        │       │               │       │class _BackendAgg(_Backend):                                                                                                                                                                                                              
   526 │       │       │       │        │       │               │       │    backend_version = 'v2.2'                                                                                                                                                                                                              
   527 │       │       │       │        │       │               │       │    FigureCanvas = FigureCanvasAgg                                                                                                                                                                                                        
   528 │       │       │       │        │       │               │       │    FigureManager = FigureManagerBase                                                                                                                                                                                                     
   529 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
╶──────┼───────┼───────┼───────┼────────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │       │        │       │               │       │function summary for /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/.venv/lib/python3.12/site-packages/matplotlib/backends/backend_agg.py                                                                               
    63 │       │       │       │  46%   │  197M │████████  45%  │       │RendererAgg.__init__                                                                                                                                                                                                                      
    93 │       │       │       │        │       │               │       │RendererAgg.draw_path                                                                                                                                                                                                                     
   185 │       │       │       │        │       │               │       │RendererAgg.draw_text                                                                                                                                                                                                                     
   206 │       │       │       │        │       │               │       │RendererAgg.get_text_width_height_descent                                                                                                                                                                                                 
   248 │       │       │       │        │       │               │       │RendererAgg._prepare_font                                                                                                                                                                                                                 
   268 │       │       │       │        │       │               │       │RendererAgg.clear                                                                                                                                                                                                                         
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
Top PEAK memory consumption, by line:
(1)    69:   197 MB                                                                                                                                                                                                                                                                                                 
                                                                        /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/.venv/lib/python3.12/site-packages/PIL/Image.py: % of time =   0.08% (79.743ms) out of 2m:38.834s.                                                                        
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/.venv/lib/python3.12/site-packages/PIL/Image.py                                                                                                                          
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     2 │       │       │       │        │       │               │       │# The Python Imaging Library.                                                                                                                                                                                                             
     3 │       │       │       │        │       │               │       │# $Id$                                                                                                                                                                                                                                    
     4 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     5 │       │       │       │        │       │               │       │# the Image class wrapper                                                                                                                                                                                                                 
     6 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     7 │       │       │       │        │       │               │       │# partial release history:                                                                                                                                                                                                                
     8 │       │       │       │        │       │               │       │# 1995-09-09 fl   Created                                                                                                                                                                                                                 
     9 │       │       │       │        │       │               │       │# 1996-03-11 fl   PIL release 0.0 (proof of concept)                                                                                                                                                                                      
    10 │       │       │       │        │       │               │       │# 1996-04-30 fl   PIL release 0.1b1                                                                                                                                                                                                       
    11 │       │       │       │        │       │               │       │# 1999-07-28 fl   PIL release 1.0 final                                                                                                                                                                                                   
    12 │       │       │       │        │       │               │       │# 2000-06-07 fl   PIL release 1.1                                                                                                                                                                                                         
    13 │       │       │       │        │       │               │       │# 2000-10-20 fl   PIL release 1.1.1                                                                                                                                                                                                       
    14 │       │       │       │        │       │               │       │# 2001-05-07 fl   PIL release 1.1.2                                                                                                                                                                                                       
    15 │       │       │       │        │       │               │       │# 2002-03-15 fl   PIL release 1.1.3                                                                                                                                                                                                       
    16 │       │       │       │        │       │               │       │# 2003-05-10 fl   PIL release 1.1.4                                                                                                                                                                                                       
    17 │       │       │       │        │       │               │       │# 2005-03-28 fl   PIL release 1.1.5                                                                                                                                                                                                       
    18 │       │       │       │        │       │               │       │# 2006-12-02 fl   PIL release 1.1.6                                                                                                                                                                                                       
    19 │       │       │       │        │       │               │       │# 2009-11-15 fl   PIL release 1.1.7                                                                                                                                                                                                       
    20 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
    21 │       │       │       │        │       │               │       │# Copyright (c) 1997-2009 by Secret Labs AB.  All rights reserved.                                                                                                                                                                        
    22 │       │       │       │        │       │               │       │# Copyright (c) 1995-2009 by Fredrik Lundh.                                                                                                                                                                                               
    23 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
    24 │       │       │       │        │       │               │       │# See the README file for information on usage and redistribution.                                                                                                                                                                        
    25 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
    26 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    27 │       │       │       │        │       │               │       │from __future__ import annotations                                                                                                                                                                                                        
    28 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    29 │       │       │       │        │       │               │       │import abc                                                                                                                                                                                                                                
    30 │       │       │       │        │       │               │       │import atexit                                                                                                                                                                                                                             
    31 │       │       │       │        │       │               │       │import builtins                                                                                                                                                                                                                           
    32 │       │       │       │        │       │               │       │import io                                                                                                                                                                                                                                 
    33 │       │       │       │        │       │               │       │import logging                                                                                                                                                                                                                            
    34 │       │       │       │        │       │               │       │import math                                                                                                                                                                                                                               
    35 │       │       │       │        │       │               │       │import os                                                                                                                                                                                                                                 
    36 │       │       │       │        │       │               │       │import re                                                                                                                                                                                                                                 
    37 │       │       │       │        │       │               │       │import struct                                                                                                                                                                                                                             
    38 │       │       │       │        │       │               │       │import sys                                                                                                                                                                                                                                
    39 │       │       │       │        │       │               │       │import tempfile                                                                                                                                                                                                                           
    40 │       │       │       │        │       │               │       │import warnings                                                                                                                                                                                                                           
    41 │       │       │       │        │       │               │       │from collections.abc import Callable, Iterator, MutableMapping, Sequence                                                                                                                                                                  
    42 │       │       │       │        │       │               │       │from enum import IntEnum                                                                                                                                                                                                                  
    43 │       │       │       │        │       │               │       │from types import ModuleType                                                                                                                                                                                                              
    44 │       │       │       │        │       │               │       │from typing import IO, Any, Literal, Protocol, cast                                                                                                                                                                                       
    45 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    46 │       │       │       │        │       │               │       │# VERSION was removed in Pillow 6.0.0.                                                                                                                                                                                                    
    47 │       │       │       │        │       │               │       │# PILLOW_VERSION was removed in Pillow 9.0.0.                                                                                                                                                                                             
    48 │       │       │       │        │       │               │       │# Use __version__ instead.                                                                                                                                                                                                                
    49 │       │       │       │        │       │               │       │from . import (                                                                                                                                                                                                                           
    50 │       │       │       │        │       │               │       │    ExifTags,                                                                                                                                                                                                                             
    51 │       │       │       │        │       │               │       │    ImageMode,                                                                                                                                                                                                                            
    52 │       │       │       │        │       │               │       │    TiffTags,                                                                                                                                                                                                                             
    53 │       │       │       │        │       │               │       │    UnidentifiedImageError,                                                                                                                                                                                                               
    54 │       │       │       │        │       │               │       │    __version__,                                                                                                                                                                                                                          
    55 │       │       │       │        │       │               │       │    _plugins,                                                                                                                                                                                                                             
    56 │       │       │       │        │       │               │       │)                                                                                                                                                                                                                                         
    57 │       │       │       │        │       │               │       │from ._binary import i32le, o32be, o32le                                                                                                                                                                                                  
    58 │       │       │       │        │       │               │       │from ._deprecate import deprecate                                                                                                                                                                                                         
    59 │       │       │       │        │       │               │       │from ._util import DeferredError, is_path                                                                                                                                                                                                 
    60 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    61 │       │       │       │        │       │               │       │ElementTree: ModuleType | None                                                                                                                                                                                                            
    62 │       │       │       │        │       │               │       │try:                                                                                                                                                                                                                                      
    63 │       │       │       │        │       │               │       │    from defusedxml import ElementTree                                                                                                                                                                                                    
    64 │       │       │       │        │       │               │       │except ImportError:                                                                                                                                                                                                                       
    65 │       │       │       │        │       │               │       │    ElementTree = None                                                                                                                                                                                                                    
    66 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    67 │       │       │       │        │       │               │       │logger = logging.getLogger(__name__)                                                                                                                                                                                                      
    68 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    69 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    70 │       │       │       │        │       │               │       │class DecompressionBombWarning(RuntimeWarning):                                                                                                                                                                                           
    71 │       │       │       │        │       │               │       │    pass                                                                                                                                                                                                                                  
    72 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    73 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    74 │       │       │       │        │       │               │       │class DecompressionBombError(Exception):                                                                                                                                                                                                  
    75 │       │       │       │        │       │               │       │    pass                                                                                                                                                                                                                                  
    76 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    77 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    78 │       │       │       │        │       │               │       │WARN_POSSIBLE_FORMATS: bool = False                                                                                                                                                                                                       
    79 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    80 │       │       │       │        │       │               │       │# Limit to around a quarter gigabyte for a 24-bit (3 bpp) image                                                                                                                                                                           
    81 │       │       │       │        │       │               │       │MAX_IMAGE_PIXELS: int | None = int(1024 * 1024 * 1024 // 4 // 3)                                                                                                                                                                          
    82 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    83 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    84 │       │       │       │        │       │               │       │try:                                                                                                                                                                                                                                      
    85 │       │       │       │        │       │               │       │    # If the _imaging C module is not present, Pillow will not load.                                                                                                                                                                      
    86 │       │       │       │        │       │               │       │    # Note that other modules should not refer to _imaging directly;                                                                                                                                                                      
    87 │       │       │       │        │       │               │       │    # import Image and use the Image.core variable instead.                                                                                                                                                                               
    88 │       │       │       │        │       │               │       │    # Also note that Image.core is not a publicly documented interface,                                                                                                                                                                   
    89 │       │       │       │        │       │               │       │    # and should be considered private and subject to change.                                                                                                                                                                             
    90 │       │       │       │        │       │               │       │    from . import _imaging as core                                                                                                                                                                                                        
    91 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    92 │       │       │       │        │       │               │       │    if __version__ != getattr(core, "PILLOW_VERSION", None):                                                                                                                                                                              
    93 │       │       │       │        │       │               │       │        msg = (                                                                                                                                                                                                                           
    94 │       │       │       │        │       │               │       │            "The _imaging extension was built for another version of Pillow or PIL:\n"                                                                                                                                                    
    95 │       │       │       │        │       │               │       │            f"Core version: {getattr(core, 'PILLOW_VERSION', None)}\n"                                                                                                                                                                    
    96 │       │       │       │        │       │               │       │            f"Pillow version: {__version__}"                                                                                                                                                                                              
    97 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
    98 │       │       │       │        │       │               │       │        raise ImportError(msg)                                                                                                                                                                                                            
    99 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   100 │       │       │       │        │       │               │       │except ImportError as v:                                                                                                                                                                                                                  
   101 │       │       │       │        │       │               │       │    core = DeferredError.new(ImportError("The _imaging C module is not installed."))                                                                                                                                                      
   102 │       │       │       │        │       │               │       │    # Explanations for ways that we know we might have an import error                                                                                                                                                                    
   103 │       │       │       │        │       │               │       │    if str(v).startswith("Module use of python"):                                                                                                                                                                                         
   104 │       │       │       │        │       │               │       │        # The _imaging C module is present, but not compiled for                                                                                                                                                                          
   105 │       │       │       │        │       │               │       │        # the right version (windows only).  Print a warning, if                                                                                                                                                                          
   106 │       │       │       │        │       │               │       │        # possible.                                                                                                                                                                                                                       
   107 │       │       │       │        │       │               │       │        warnings.warn(                                                                                                                                                                                                                    
   108 │       │       │       │        │       │               │       │            "The _imaging extension was built for another version of Python.",                                                                                                                                                            
   109 │       │       │       │        │       │               │       │            RuntimeWarning,                                                                                                                                                                                                               
   110 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   111 │       │       │       │        │       │               │       │    elif str(v).startswith("The _imaging extension"):                                                                                                                                                                                     
   112 │       │       │       │        │       │               │       │        warnings.warn(str(v), RuntimeWarning)                                                                                                                                                                                             
   113 │       │       │       │        │       │               │       │    # Fail here anyway. Don't let people run with a mostly broken Pillow.                                                                                                                                                                 
   114 │       │       │       │        │       │               │       │    # see docs/porting.rst                                                                                                                                                                                                                
   115 │       │       │       │        │       │               │       │    raise                                                                                                                                                                                                                                 
   116 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   117 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   118 │       │       │       │        │       │               │       │def isImageType(t: Any) -> TypeGuard[Image]:                                                                                                                                                                                              
   119 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   120 │       │       │       │        │       │               │       │    Checks if an object is an image object.                                                                                                                                                                                               
   121 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   122 │       │       │       │        │       │               │       │    .. warning::                                                                                                                                                                                                                          
   123 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   124 │       │       │       │        │       │               │       │       This function is for internal use only.                                                                                                                                                                                            
   125 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   126 │       │       │       │        │       │               │       │    :param t: object to check if it's an image                                                                                                                                                                                            
   127 │       │       │       │        │       │               │       │    :returns: True if the object is an image                                                                                                                                                                                              
   128 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   129 │       │       │       │        │       │               │       │    deprecate("Image.isImageType(im)", 12, "isinstance(im, Image.Image)")                                                                                                                                                                 
   130 │       │       │       │        │       │               │       │    return hasattr(t, "im")                                                                                                                                                                                                               
   131 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   132 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   133 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
   134 │       │       │       │        │       │               │       │# Constants                                                                                                                                                                                                                               
   135 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   136 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   137 │       │       │       │        │       │               │       │# transpose                                                                                                                                                                                                                               
   138 │       │       │       │        │       │               │       │class Transpose(IntEnum):                                                                                                                                                                                                                 
   139 │       │       │       │        │       │               │       │    FLIP_LEFT_RIGHT = 0                                                                                                                                                                                                                   
   140 │       │       │       │        │       │               │       │    FLIP_TOP_BOTTOM = 1                                                                                                                                                                                                                   
   141 │       │       │       │        │       │               │       │    ROTATE_90 = 2                                                                                                                                                                                                                         
   142 │       │       │       │        │       │               │       │    ROTATE_180 = 3                                                                                                                                                                                                                        
   143 │       │       │       │        │       │               │       │    ROTATE_270 = 4                                                                                                                                                                                                                        
   144 │       │       │       │        │       │               │       │    TRANSPOSE = 5                                                                                                                                                                                                                         
   145 │       │       │       │        │       │               │       │    TRANSVERSE = 6                                                                                                                                                                                                                        
   146 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   147 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   148 │       │       │       │        │       │               │       │# transforms (also defined in Imaging.h)                                                                                                                                                                                                  
   149 │       │       │       │        │       │               │       │class Transform(IntEnum):                                                                                                                                                                                                                 
   150 │       │       │       │        │       │               │       │    AFFINE = 0                                                                                                                                                                                                                            
   151 │       │       │       │        │       │               │       │    EXTENT = 1                                                                                                                                                                                                                            
   152 │       │       │       │        │       │               │       │    PERSPECTIVE = 2                                                                                                                                                                                                                       
   153 │       │       │       │        │       │               │       │    QUAD = 3                                                                                                                                                                                                                              
   154 │       │       │       │        │       │               │       │    MESH = 4                                                                                                                                                                                                                              
   155 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   156 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   157 │       │       │       │        │       │               │       │# resampling filters (also defined in Imaging.h)                                                                                                                                                                                          
   158 │       │       │       │        │       │               │       │class Resampling(IntEnum):                                                                                                                                                                                                                
   159 │       │       │       │        │       │               │       │    NEAREST = 0                                                                                                                                                                                                                           
   160 │       │       │       │        │       │               │       │    BOX = 4                                                                                                                                                                                                                               
   161 │       │       │       │        │       │               │       │    BILINEAR = 2                                                                                                                                                                                                                          
   162 │       │       │       │        │       │               │       │    HAMMING = 5                                                                                                                                                                                                                           
   163 │       │       │       │        │       │               │       │    BICUBIC = 3                                                                                                                                                                                                                           
   164 │       │       │       │        │       │               │       │    LANCZOS = 1                                                                                                                                                                                                                           
   165 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   166 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   167 │       │       │       │        │       │               │       │_filters_support = {                                                                                                                                                                                                                      
   168 │       │       │       │        │       │               │       │    Resampling.BOX: 0.5,                                                                                                                                                                                                                  
   169 │       │       │       │        │       │               │       │    Resampling.BILINEAR: 1.0,                                                                                                                                                                                                             
   170 │       │       │       │        │       │               │       │    Resampling.HAMMING: 1.0,                                                                                                                                                                                                              
   171 │       │       │       │        │       │               │       │    Resampling.BICUBIC: 2.0,                                                                                                                                                                                                              
   172 │       │       │       │        │       │               │       │    Resampling.LANCZOS: 3.0,                                                                                                                                                                                                              
   173 │       │       │       │        │       │               │       │}                                                                                                                                                                                                                                         
   174 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   175 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   176 │       │       │       │        │       │               │       │# dithers                                                                                                                                                                                                                                 
   177 │       │       │       │        │       │               │       │class Dither(IntEnum):                                                                                                                                                                                                                    
   178 │       │       │       │        │       │               │       │    NONE = 0                                                                                                                                                                                                                              
   179 │       │       │       │        │       │               │       │    ORDERED = 1  # Not yet implemented                                                                                                                                                                                                    
   180 │       │       │       │        │       │               │       │    RASTERIZE = 2  # Not yet implemented                                                                                                                                                                                                  
   181 │       │       │       │        │       │               │       │    FLOYDSTEINBERG = 3  # default                                                                                                                                                                                                         
   182 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   183 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   184 │       │       │       │        │       │               │       │# palettes/quantizers                                                                                                                                                                                                                     
   185 │       │       │       │        │       │               │       │class Palette(IntEnum):                                                                                                                                                                                                                   
   186 │       │       │       │        │       │               │       │    WEB = 0                                                                                                                                                                                                                               
   187 │       │       │       │        │       │               │       │    ADAPTIVE = 1                                                                                                                                                                                                                          
   188 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   189 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   190 │       │       │       │        │       │               │       │class Quantize(IntEnum):                                                                                                                                                                                                                  
   191 │       │       │       │        │       │               │       │    MEDIANCUT = 0                                                                                                                                                                                                                         
   192 │       │       │       │        │       │               │       │    MAXCOVERAGE = 1                                                                                                                                                                                                                       
   193 │       │       │       │        │       │               │       │    FASTOCTREE = 2                                                                                                                                                                                                                        
   194 │       │       │       │        │       │               │       │    LIBIMAGEQUANT = 3                                                                                                                                                                                                                     
   195 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   196 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   197 │       │       │       │        │       │               │       │module = sys.modules[__name__]                                                                                                                                                                                                            
   198 │       │       │       │        │       │               │       │for enum in (Transpose, Transform, Resampling, Dither, Palette, Quantize):                                                                                                                                                                
   199 │       │       │       │        │       │               │       │    for item in enum:                                                                                                                                                                                                                     
   200 │       │       │       │        │       │               │       │        setattr(module, item.name, item.value)                                                                                                                                                                                            
   201 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   202 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   203 │       │       │       │        │       │               │       │if hasattr(core, "DEFAULT_STRATEGY"):                                                                                                                                                                                                     
   204 │       │       │       │        │       │               │       │    DEFAULT_STRATEGY = core.DEFAULT_STRATEGY                                                                                                                                                                                              
   205 │       │       │       │        │       │               │       │    FILTERED = core.FILTERED                                                                                                                                                                                                              
   206 │       │       │       │        │       │               │       │    HUFFMAN_ONLY = core.HUFFMAN_ONLY                                                                                                                                                                                                      
   207 │       │       │       │        │       │               │       │    RLE = core.RLE                                                                                                                                                                                                                        
   208 │       │       │       │        │       │               │       │    FIXED = core.FIXED                                                                                                                                                                                                                    
   209 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   210 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   211 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
   212 │       │       │       │        │       │               │       │# Registries                                                                                                                                                                                                                              
   213 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   214 │       │       │       │        │       │               │       │TYPE_CHECKING = False                                                                                                                                                                                                                     
   215 │       │       │       │        │       │               │       │if TYPE_CHECKING:                                                                                                                                                                                                                         
   216 │       │       │       │        │       │               │       │    import mmap                                                                                                                                                                                                                           
   217 │       │       │       │        │       │               │       │    from xml.etree.ElementTree import Element                                                                                                                                                                                             
   218 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   219 │       │       │       │        │       │               │       │    from IPython.lib.pretty import PrettyPrinter                                                                                                                                                                                          
   220 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   221 │       │       │       │        │       │               │       │    from . import ImageFile, ImageFilter, ImagePalette, ImageQt, TiffImagePlugin                                                                                                                                                          
   222 │       │       │       │        │       │               │       │    from ._typing import CapsuleType, NumpyArray, StrOrBytesPath, TypeGuard                                                                                                                                                               
   223 │       │       │       │        │       │               │       │ID: list[str] = []                                                                                                                                                                                                                        
   224 │       │       │       │        │       │               │       │OPEN: dict[                                                                                                                                                                                                                               
   225 │       │       │       │        │       │               │       │    str,                                                                                                                                                                                                                                  
   226 │       │       │       │        │       │               │       │    tuple[                                                                                                                                                                                                                                
   227 │       │       │       │        │       │               │       │        Callable[[IO[bytes], str | bytes], ImageFile.ImageFile],                                                                                                                                                                          
   228 │       │       │       │        │       │               │       │        Callable[[bytes], bool | str] | None,                                                                                                                                                                                             
   229 │       │       │       │        │       │               │       │    ],                                                                                                                                                                                                                                    
   230 │       │       │       │        │       │               │       │] = {}                                                                                                                                                                                                                                    
   231 │       │       │       │        │       │               │       │MIME: dict[str, str] = {}                                                                                                                                                                                                                 
   232 │       │       │       │        │       │               │       │SAVE: dict[str, Callable[[Image, IO[bytes], str | bytes], None]] = {}                                                                                                                                                                     
   233 │       │       │       │        │       │               │       │SAVE_ALL: dict[str, Callable[[Image, IO[bytes], str | bytes], None]] = {}                                                                                                                                                                 
   234 │       │       │       │        │       │               │       │EXTENSION: dict[str, str] = {}                                                                                                                                                                                                            
   235 │       │       │       │        │       │               │       │DECODERS: dict[str, type[ImageFile.PyDecoder]] = {}                                                                                                                                                                                       
   236 │       │       │       │        │       │               │       │ENCODERS: dict[str, type[ImageFile.PyEncoder]] = {}                                                                                                                                                                                       
   237 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   238 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
   239 │       │       │       │        │       │               │       │# Modes                                                                                                                                                                                                                                   
   240 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   241 │       │       │       │        │       │               │       │_ENDIAN = "<" if sys.byteorder == "little" else ">"                                                                                                                                                                                       
   242 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   243 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   244 │       │       │       │        │       │               │       │def _conv_type_shape(im: Image) -> tuple[tuple[int, ...], str]:                                                                                                                                                                           
   245 │       │       │       │        │       │               │       │    m = ImageMode.getmode(im.mode)                                                                                                                                                                                                        
   246 │       │       │       │        │       │               │       │    shape: tuple[int, ...] = (im.height, im.width)                                                                                                                                                                                        
   247 │       │       │       │        │       │               │       │    extra = len(m.bands)                                                                                                                                                                                                                  
   248 │       │       │       │        │       │               │       │    if extra != 1:                                                                                                                                                                                                                        
   249 │       │       │       │        │       │               │       │        shape += (extra,)                                                                                                                                                                                                                 
   250 │       │       │       │        │       │               │       │    return shape, m.typestr                                                                                                                                                                                                               
   251 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   252 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   253 │       │       │       │        │       │               │       │MODES = [                                                                                                                                                                                                                                 
   254 │       │       │       │        │       │               │       │    "1",                                                                                                                                                                                                                                  
   255 │       │       │       │        │       │               │       │    "CMYK",                                                                                                                                                                                                                               
   256 │       │       │       │        │       │               │       │    "F",                                                                                                                                                                                                                                  
   257 │       │       │       │        │       │               │       │    "HSV",                                                                                                                                                                                                                                
   258 │       │       │       │        │       │               │       │    "I",                                                                                                                                                                                                                                  
   259 │       │       │       │        │       │               │       │    "I;16",                                                                                                                                                                                                                               
   260 │       │       │       │        │       │               │       │    "I;16B",                                                                                                                                                                                                                              
   261 │       │       │       │        │       │               │       │    "I;16L",                                                                                                                                                                                                                              
   262 │       │       │       │        │       │               │       │    "I;16N",                                                                                                                                                                                                                              
   263 │       │       │       │        │       │               │       │    "L",                                                                                                                                                                                                                                  
   264 │       │       │       │        │       │               │       │    "LA",                                                                                                                                                                                                                                 
   265 │       │       │       │        │       │               │       │    "La",                                                                                                                                                                                                                                 
   266 │       │       │       │        │       │               │       │    "LAB",                                                                                                                                                                                                                                
   267 │       │       │       │        │       │               │       │    "P",                                                                                                                                                                                                                                  
   268 │       │       │       │        │       │               │       │    "PA",                                                                                                                                                                                                                                 
   269 │       │       │       │        │       │               │       │    "RGB",                                                                                                                                                                                                                                
   270 │       │       │       │        │       │               │       │    "RGBA",                                                                                                                                                                                                                               
   271 │       │       │       │        │       │               │       │    "RGBa",                                                                                                                                                                                                                               
   272 │       │       │       │        │       │               │       │    "RGBX",                                                                                                                                                                                                                               
   273 │       │       │       │        │       │               │       │    "YCbCr",                                                                                                                                                                                                                              
   274 │       │       │       │        │       │               │       │]                                                                                                                                                                                                                                         
   275 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   276 │       │       │       │        │       │               │       │# raw modes that may be memory mapped.  NOTE: if you change this, you                                                                                                                                                                     
   277 │       │       │       │        │       │               │       │# may have to modify the stride calculation in map.c too!                                                                                                                                                                                 
   278 │       │       │       │        │       │               │       │_MAPMODES = ("L", "P", "RGBX", "RGBA", "CMYK", "I;16", "I;16L", "I;16B")                                                                                                                                                                  
   279 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   280 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   281 │       │       │       │        │       │               │       │def getmodebase(mode: str) -> str:                                                                                                                                                                                                        
   282 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   283 │       │       │       │        │       │               │       │    Gets the "base" mode for given mode.  This function returns "L" for                                                                                                                                                                   
   284 │       │       │       │        │       │               │       │    images that contain grayscale data, and "RGB" for images that                                                                                                                                                                         
   285 │       │       │       │        │       │               │       │    contain color data.                                                                                                                                                                                                                   
   286 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   287 │       │       │       │        │       │               │       │    :param mode: Input mode.                                                                                                                                                                                                              
   288 │       │       │       │        │       │               │       │    :returns: "L" or "RGB".                                                                                                                                                                                                               
   289 │       │       │       │        │       │               │       │    :exception KeyError: If the input mode was not a standard mode.                                                                                                                                                                       
   290 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   291 │       │       │       │        │       │               │       │    return ImageMode.getmode(mode).basemode                                                                                                                                                                                               
   292 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   293 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   294 │       │       │       │        │       │               │       │def getmodetype(mode: str) -> str:                                                                                                                                                                                                        
   295 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   296 │       │       │       │        │       │               │       │    Gets the storage type mode.  Given a mode, this function returns a                                                                                                                                                                    
   297 │       │       │       │        │       │               │       │    single-layer mode suitable for storing individual bands.                                                                                                                                                                              
   298 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   299 │       │       │       │        │       │               │       │    :param mode: Input mode.                                                                                                                                                                                                              
   300 │       │       │       │        │       │               │       │    :returns: "L", "I", or "F".                                                                                                                                                                                                           
   301 │       │       │       │        │       │               │       │    :exception KeyError: If the input mode was not a standard mode.                                                                                                                                                                       
   302 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   303 │       │       │       │        │       │               │       │    return ImageMode.getmode(mode).basetype                                                                                                                                                                                               
   304 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   305 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   306 │       │       │       │        │       │               │       │def getmodebandnames(mode: str) -> tuple[str, ...]:                                                                                                                                                                                       
   307 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   308 │       │       │       │        │       │               │       │    Gets a list of individual band names.  Given a mode, this function returns                                                                                                                                                            
   309 │       │       │       │        │       │               │       │    a tuple containing the names of individual bands (use                                                                                                                                                                                 
   310 │       │       │       │        │       │               │       │    :py:method:`~PIL.Image.getmodetype` to get the mode used to store each                                                                                                                                                                
   311 │       │       │       │        │       │               │       │    individual band.                                                                                                                                                                                                                      
   312 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   313 │       │       │       │        │       │               │       │    :param mode: Input mode.                                                                                                                                                                                                              
   314 │       │       │       │        │       │               │       │    :returns: A tuple containing band names.  The length of the tuple                                                                                                                                                                     
   315 │       │       │       │        │       │               │       │        gives the number of bands in an image of the given mode.                                                                                                                                                                          
   316 │       │       │       │        │       │               │       │    :exception KeyError: If the input mode was not a standard mode.                                                                                                                                                                       
   317 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   318 │       │       │       │        │       │               │       │    return ImageMode.getmode(mode).bands                                                                                                                                                                                                  
   319 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   320 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   321 │       │       │       │        │       │               │       │def getmodebands(mode: str) -> int:                                                                                                                                                                                                       
   322 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   323 │       │       │       │        │       │               │       │    Gets the number of individual bands for this mode.                                                                                                                                                                                    
   324 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   325 │       │       │       │        │       │               │       │    :param mode: Input mode.                                                                                                                                                                                                              
   326 │       │       │       │        │       │               │       │    :returns: The number of bands in this mode.                                                                                                                                                                                           
   327 │       │       │       │        │       │               │       │    :exception KeyError: If the input mode was not a standard mode.                                                                                                                                                                       
   328 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   329 │       │       │       │        │       │               │       │    return len(ImageMode.getmode(mode).bands)                                                                                                                                                                                             
   330 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   331 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   332 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
   333 │       │       │       │        │       │               │       │# Helpers                                                                                                                                                                                                                                 
   334 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   335 │       │       │       │        │       │               │       │_initialized = 0                                                                                                                                                                                                                          
   336 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   337 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   338 │       │       │       │        │       │               │       │def preinit() -> None:                                                                                                                                                                                                                    
   339 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   340 │       │       │       │        │       │               │       │    Explicitly loads BMP, GIF, JPEG, PPM and PPM file format drivers.                                                                                                                                                                     
   341 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   342 │       │       │       │        │       │               │       │    It is called when opening or saving images.                                                                                                                                                                                           
   343 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   344 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   345 │       │       │       │        │       │               │       │    global _initialized                                                                                                                                                                                                                   
   346 │       │       │       │        │       │               │       │    if _initialized >= 1:                                                                                                                                                                                                                 
   347 │       │       │       │        │       │               │       │        return                                                                                                                                                                                                                            
   348 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   349 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   350 │       │       │       │        │       │               │       │        from . import BmpImagePlugin                                                                                                                                                                                                      
   351 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   352 │       │       │       │        │       │               │       │        assert BmpImagePlugin                                                                                                                                                                                                             
   353 │       │       │       │        │       │               │       │    except ImportError:                                                                                                                                                                                                                   
   354 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   355 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   356 │       │       │       │        │       │               │       │        from . import GifImagePlugin                                                                                                                                                                                                      
   357 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   358 │       │       │       │        │       │               │       │        assert GifImagePlugin                                                                                                                                                                                                             
   359 │       │       │       │        │       │               │       │    except ImportError:                                                                                                                                                                                                                   
   360 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   361 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   362 │       │       │       │        │       │               │       │        from . import JpegImagePlugin                                                                                                                                                                                                     
   363 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   364 │       │       │       │        │       │               │       │        assert JpegImagePlugin                                                                                                                                                                                                            
   365 │       │       │       │        │       │               │       │    except ImportError:                                                                                                                                                                                                                   
   366 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   367 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   368 │       │       │       │        │       │               │       │        from . import PpmImagePlugin                                                                                                                                                                                                      
   369 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   370 │       │       │       │        │       │               │       │        assert PpmImagePlugin                                                                                                                                                                                                             
   371 │       │       │       │        │       │               │       │    except ImportError:                                                                                                                                                                                                                   
   372 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   373 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   374 │       │       │       │        │       │               │       │        from . import PngImagePlugin                                                                                                                                                                                                      
   375 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   376 │       │       │       │        │       │               │       │        assert PngImagePlugin                                                                                                                                                                                                             
   377 │       │       │       │        │       │               │       │    except ImportError:                                                                                                                                                                                                                   
   378 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   379 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   380 │       │       │       │        │       │               │       │    _initialized = 1                                                                                                                                                                                                                      
   381 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   382 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   383 │       │       │       │        │       │               │       │def init() -> bool:                                                                                                                                                                                                                       
   384 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   385 │       │       │       │        │       │               │       │    Explicitly initializes the Python Imaging Library. This function                                                                                                                                                                      
   386 │       │       │       │        │       │               │       │    loads all available file format drivers.                                                                                                                                                                                              
   387 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   388 │       │       │       │        │       │               │       │    It is called when opening or saving images if :py:meth:`~preinit()` is                                                                                                                                                                
   389 │       │       │       │        │       │               │       │    insufficient, and by :py:meth:`~PIL.features.pilinfo`.                                                                                                                                                                                
   390 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   391 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   392 │       │       │       │        │       │               │       │    global _initialized                                                                                                                                                                                                                   
   393 │       │       │       │        │       │               │       │    if _initialized >= 2:                                                                                                                                                                                                                 
   394 │       │       │       │        │       │               │       │        return False                                                                                                                                                                                                                      
   395 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   396 │       │       │       │        │       │               │       │    parent_name = __name__.rpartition(".")[0]                                                                                                                                                                                             
   397 │       │       │       │        │       │               │       │    for plugin in _plugins:                                                                                                                                                                                                               
   398 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   399 │       │       │       │        │       │               │       │            logger.debug("Importing %s", plugin)                                                                                                                                                                                          
   400 │       │       │       │        │       │               │       │            __import__(f"{parent_name}.{plugin}", globals(), locals(), [])                                                                                                                                                                
   401 │       │       │       │        │       │               │       │        except ImportError as e:                                                                                                                                                                                                          
   402 │       │       │       │        │       │               │       │            logger.debug("Image: failed to import %s: %s", plugin, e)                                                                                                                                                                     
   403 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   404 │       │       │       │        │       │               │       │    if OPEN or SAVE:                                                                                                                                                                                                                      
   405 │       │       │       │        │       │               │       │        _initialized = 2                                                                                                                                                                                                                  
   406 │       │       │       │        │       │               │       │        return True                                                                                                                                                                                                                       
   407 │       │       │       │        │       │               │       │    return False                                                                                                                                                                                                                          
   408 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   409 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   410 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
   411 │       │       │       │        │       │               │       │# Codec factories (used by tobytes/frombytes and ImageFile.load)                                                                                                                                                                          
   412 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   413 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   414 │       │       │       │        │       │               │       │def _getdecoder(                                                                                                                                                                                                                          
   415 │       │       │       │        │       │               │       │    mode: str, decoder_name: str, args: Any, extra: tuple[Any, ...] = ()                                                                                                                                                                  
   416 │       │       │       │        │       │               │       │) -> core.ImagingDecoder | ImageFile.PyDecoder:                                                                                                                                                                                           
   417 │       │       │       │        │       │               │       │    # tweak arguments                                                                                                                                                                                                                     
   418 │       │       │       │        │       │               │       │    if args is None:                                                                                                                                                                                                                      
   419 │       │       │       │        │       │               │       │        args = ()                                                                                                                                                                                                                         
   420 │       │       │       │        │       │               │       │    elif not isinstance(args, tuple):                                                                                                                                                                                                     
   421 │       │       │       │        │       │               │       │        args = (args,)                                                                                                                                                                                                                    
   422 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   423 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   424 │       │       │       │        │       │               │       │        decoder = DECODERS[decoder_name]                                                                                                                                                                                                  
   425 │       │       │       │        │       │               │       │    except KeyError:                                                                                                                                                                                                                      
   426 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   427 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
   428 │       │       │       │        │       │               │       │        return decoder(mode, *args + extra)                                                                                                                                                                                               
   429 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   430 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   431 │       │       │       │        │       │               │       │        # get decoder                                                                                                                                                                                                                     
   432 │       │       │       │        │       │               │       │        decoder = getattr(core, f"{decoder_name}_decoder")                                                                                                                                                                                
   433 │       │       │       │        │       │               │       │    except AttributeError as e:                                                                                                                                                                                                           
   434 │       │       │       │        │       │               │       │        msg = f"decoder {decoder_name} not available"                                                                                                                                                                                     
   435 │       │       │       │        │       │               │       │        raise OSError(msg) from e                                                                                                                                                                                                         
   436 │       │       │       │        │       │               │       │    return decoder(mode, *args + extra)                                                                                                                                                                                                   
   437 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   438 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   439 │       │       │       │        │       │               │       │def _getencoder(                                                                                                                                                                                                                          
   440 │       │       │       │        │       │               │       │    mode: str, encoder_name: str, args: Any, extra: tuple[Any, ...] = ()                                                                                                                                                                  
   441 │       │       │       │        │       │               │       │) -> core.ImagingEncoder | ImageFile.PyEncoder:                                                                                                                                                                                           
   442 │       │       │       │        │       │               │       │    # tweak arguments                                                                                                                                                                                                                     
   443 │       │       │       │        │       │               │       │    if args is None:                                                                                                                                                                                                                      
   444 │       │       │       │        │       │               │       │        args = ()                                                                                                                                                                                                                         
   445 │       │       │       │        │       │               │       │    elif not isinstance(args, tuple):                                                                                                                                                                                                     
   446 │       │       │       │        │       │               │       │        args = (args,)                                                                                                                                                                                                                    
   447 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   448 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   449 │       │       │       │        │       │               │       │        encoder = ENCODERS[encoder_name]                                                                                                                                                                                                  
   450 │       │       │       │        │       │               │       │    except KeyError:                                                                                                                                                                                                                      
   451 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   452 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
   453 │       │       │       │        │       │               │       │        return encoder(mode, *args + extra)                                                                                                                                                                                               
   454 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   455 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   456 │       │       │       │        │       │               │       │        # get encoder                                                                                                                                                                                                                     
   457 │       │       │       │        │       │               │       │        encoder = getattr(core, f"{encoder_name}_encoder")                                                                                                                                                                                
   458 │       │       │       │        │       │               │       │    except AttributeError as e:                                                                                                                                                                                                           
   459 │       │       │       │        │       │               │       │        msg = f"encoder {encoder_name} not available"                                                                                                                                                                                     
   460 │       │       │       │        │       │               │       │        raise OSError(msg) from e                                                                                                                                                                                                         
   461 │       │       │       │        │       │               │       │    return encoder(mode, *args + extra)                                                                                                                                                                                                   
   462 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   463 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   464 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
   465 │       │       │       │        │       │               │       │# Simple expression analyzer                                                                                                                                                                                                              
   466 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   467 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   468 │       │       │       │        │       │               │       │class ImagePointTransform:                                                                                                                                                                                                                
   469 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   470 │       │       │       │        │       │               │       │    Used with :py:meth:`~PIL.Image.Image.point` for single band images with more than                                                                                                                                                     
   471 │       │       │       │        │       │               │       │    8 bits, this represents an affine transformation, where the value is multiplied by                                                                                                                                                    
   472 │       │       │       │        │       │               │       │    ``scale`` and ``offset`` is added.                                                                                                                                                                                                    
   473 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   474 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   475 │       │       │       │        │       │               │       │    def __init__(self, scale: float, offset: float) -> None:                                                                                                                                                                              
   476 │       │       │       │        │       │               │       │        self.scale = scale                                                                                                                                                                                                                
   477 │       │       │       │        │       │               │       │        self.offset = offset                                                                                                                                                                                                              
   478 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   479 │       │       │       │        │       │               │       │    def __neg__(self) -> ImagePointTransform:                                                                                                                                                                                             
   480 │       │       │       │        │       │               │       │        return ImagePointTransform(-self.scale, -self.offset)                                                                                                                                                                             
   481 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   482 │       │       │       │        │       │               │       │    def __add__(self, other: ImagePointTransform | float) -> ImagePointTransform:                                                                                                                                                         
   483 │       │       │       │        │       │               │       │        if isinstance(other, ImagePointTransform):                                                                                                                                                                                        
   484 │       │       │       │        │       │               │       │            return ImagePointTransform(                                                                                                                                                                                                   
   485 │       │       │       │        │       │               │       │                self.scale + other.scale, self.offset + other.offset                                                                                                                                                                      
   486 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   487 │       │       │       │        │       │               │       │        return ImagePointTransform(self.scale, self.offset + other)                                                                                                                                                                       
   488 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   489 │       │       │       │        │       │               │       │    __radd__ = __add__                                                                                                                                                                                                                    
   490 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   491 │       │       │       │        │       │               │       │    def __sub__(self, other: ImagePointTransform | float) -> ImagePointTransform:                                                                                                                                                         
   492 │       │       │       │        │       │               │       │        return self + -other                                                                                                                                                                                                              
   493 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   494 │       │       │       │        │       │               │       │    def __rsub__(self, other: ImagePointTransform | float) -> ImagePointTransform:                                                                                                                                                        
   495 │       │       │       │        │       │               │       │        return other + -self                                                                                                                                                                                                              
   496 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   497 │       │       │       │        │       │               │       │    def __mul__(self, other: ImagePointTransform | float) -> ImagePointTransform:                                                                                                                                                         
   498 │       │       │       │        │       │               │       │        if isinstance(other, ImagePointTransform):                                                                                                                                                                                        
   499 │       │       │       │        │       │               │       │            return NotImplemented                                                                                                                                                                                                         
   500 │       │       │       │        │       │               │       │        return ImagePointTransform(self.scale * other, self.offset * other)                                                                                                                                                               
   501 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   502 │       │       │       │        │       │               │       │    __rmul__ = __mul__                                                                                                                                                                                                                    
   503 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   504 │       │       │       │        │       │               │       │    def __truediv__(self, other: ImagePointTransform | float) -> ImagePointTransform:                                                                                                                                                     
   505 │       │       │       │        │       │               │       │        if isinstance(other, ImagePointTransform):                                                                                                                                                                                        
   506 │       │       │       │        │       │               │       │            return NotImplemented                                                                                                                                                                                                         
   507 │       │       │       │        │       │               │       │        return ImagePointTransform(self.scale / other, self.offset / other)                                                                                                                                                               
   508 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   509 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   510 │       │       │       │        │       │               │       │def _getscaleoffset(                                                                                                                                                                                                                      
   511 │       │       │       │        │       │               │       │    expr: Callable[[ImagePointTransform], ImagePointTransform | float],                                                                                                                                                                   
   512 │       │       │       │        │       │               │       │) -> tuple[float, float]:                                                                                                                                                                                                                 
   513 │       │       │       │        │       │               │       │    a = expr(ImagePointTransform(1, 0))                                                                                                                                                                                                   
   514 │       │       │       │        │       │               │       │    return (a.scale, a.offset) if isinstance(a, ImagePointTransform) else (0, a)                                                                                                                                                          
   515 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   516 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   517 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
   518 │       │       │       │        │       │               │       │# Implementation wrapper                                                                                                                                                                                                                  
   519 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   520 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   521 │       │       │       │        │       │               │       │class SupportsGetData(Protocol):                                                                                                                                                                                                          
   522 │       │       │       │        │       │               │       │    def getdata(                                                                                                                                                                                                                          
   523 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   524 │       │       │       │        │       │               │       │    ) -> tuple[Transform, Sequence[int]]: ...                                                                                                                                                                                             
   525 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   526 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   527 │       │       │       │        │       │               │       │class Image:                                                                                                                                                                                                                              
   528 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   529 │       │       │       │        │       │               │       │    This class represents an image object.  To create                                                                                                                                                                                     
   530 │       │       │       │        │       │               │       │    :py:class:`~PIL.Image.Image` objects, use the appropriate factory                                                                                                                                                                     
   531 │       │       │       │        │       │               │       │    functions.  There's hardly ever any reason to call the Image constructor                                                                                                                                                              
   532 │       │       │       │        │       │               │       │    directly.                                                                                                                                                                                                                             
   533 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   534 │       │       │       │        │       │               │       │    * :py:func:`~PIL.Image.open`                                                                                                                                                                                                          
   535 │       │       │       │        │       │               │       │    * :py:func:`~PIL.Image.new`                                                                                                                                                                                                           
   536 │       │       │       │        │       │               │       │    * :py:func:`~PIL.Image.frombytes`                                                                                                                                                                                                     
   537 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   538 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   539 │       │       │       │        │       │               │       │    format: str | None = None                                                                                                                                                                                                             
   540 │       │       │       │        │       │               │       │    format_description: str | None = None                                                                                                                                                                                                 
   541 │       │       │       │        │       │               │       │    _close_exclusive_fp_after_loading = True                                                                                                                                                                                              
   542 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   543 │       │       │       │        │       │               │       │    def __init__(self) -> None:                                                                                                                                                                                                           
   544 │       │       │       │        │       │               │       │        # FIXME: take "new" parameters / other image?                                                                                                                                                                                     
   545 │       │       │       │        │       │               │       │        self._im: core.ImagingCore | DeferredError | None = None                                                                                                                                                                          
   546 │       │       │       │        │       │               │       │        self._mode = ""                                                                                                                                                                                                                   
   547 │       │       │       │        │       │               │       │        self._size = (0, 0)                                                                                                                                                                                                               
   548 │       │       │       │        │       │               │       │        self.palette: ImagePalette.ImagePalette | None = None                                                                                                                                                                             
   549 │       │       │       │        │       │               │       │        self.info: dict[str | tuple[int, int], Any] = {}                                                                                                                                                                                  
   550 │       │       │       │        │       │               │       │        self.readonly = 0                                                                                                                                                                                                                 
   551 │       │       │       │        │       │               │       │        self._exif: Exif | None = None                                                                                                                                                                                                    
   552 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   553 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   554 │       │       │       │        │       │               │       │    def im(self) -> core.ImagingCore:                                                                                                                                                                                                     
   555 │       │       │       │        │       │               │       │        if isinstance(self._im, DeferredError):                                                                                                                                                                                           
   556 │       │       │       │        │       │               │       │            raise self._im.ex                                                                                                                                                                                                             
   557 │       │       │       │        │       │               │       │        assert self._im is not None                                                                                                                                                                                                       
   558 │       │       │       │        │       │               │       │        return self._im                                                                                                                                                                                                                   
   559 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   560 │       │       │       │        │       │               │       │    @im.setter                                                                                                                                                                                                                            
   561 │       │       │       │        │       │               │       │    def im(self, im: core.ImagingCore) -> None:                                                                                                                                                                                           
   562 │       │       │       │        │       │               │       │        self._im = im                                                                                                                                                                                                                     
   563 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   564 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   565 │       │       │       │        │       │               │       │    def width(self) -> int:                                                                                                                                                                                                               
   566 │       │       │       │        │       │               │       │        return self.size[0]                                                                                                                                                                                                               
   567 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   568 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   569 │       │       │       │        │       │               │       │    def height(self) -> int:                                                                                                                                                                                                              
   570 │       │       │       │        │       │               │       │        return self.size[1]                                                                                                                                                                                                               
   571 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   572 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   573 │       │       │       │        │       │               │       │    def size(self) -> tuple[int, int]:                                                                                                                                                                                                    
   574 │       │       │       │        │       │               │       │        return self._size                                                                                                                                                                                                                 
   575 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   576 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   577 │       │       │       │        │       │               │       │    def mode(self) -> str:                                                                                                                                                                                                                
   578 │       │       │       │        │       │               │       │        return self._mode                                                                                                                                                                                                                 
   579 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   580 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   581 │       │       │       │        │       │               │       │    def readonly(self) -> int:                                                                                                                                                                                                            
   582 │       │       │       │        │       │               │       │        return (self._im and self._im.readonly) or self._readonly                                                                                                                                                                         
   583 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   584 │       │       │       │        │       │               │       │    @readonly.setter                                                                                                                                                                                                                      
   585 │       │       │       │        │       │               │       │    def readonly(self, readonly: int) -> None:                                                                                                                                                                                            
   586 │       │       │       │        │       │               │       │        self._readonly = readonly                                                                                                                                                                                                         
   587 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   588 │       │       │       │        │       │               │       │    def _new(self, im: core.ImagingCore) -> Image:                                                                                                                                                                                        
   589 │       │       │       │        │       │               │       │        new = Image()                                                                                                                                                                                                                     
   590 │       │       │       │        │       │               │       │        new.im = im                                                                                                                                                                                                                       
   591 │       │       │       │        │       │               │       │        new._mode = im.mode                                                                                                                                                                                                               
   592 │       │       │       │        │       │               │       │        new._size = im.size                                                                                                                                                                                                               
   593 │       │       │       │        │       │               │       │        if im.mode in ("P", "PA"):                                                                                                                                                                                                        
   594 │       │       │       │        │       │               │       │            if self.palette:                                                                                                                                                                                                              
   595 │       │       │       │        │       │               │       │                new.palette = self.palette.copy()                                                                                                                                                                                         
   596 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   597 │       │       │       │        │       │               │       │                from . import ImagePalette                                                                                                                                                                                                
   598 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   599 │       │       │       │        │       │               │       │                new.palette = ImagePalette.ImagePalette()                                                                                                                                                                                 
   600 │       │       │       │        │       │               │       │        new.info = self.info.copy()                                                                                                                                                                                                       
   601 │       │       │       │        │       │               │       │        return new                                                                                                                                                                                                                        
   602 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   603 │       │       │       │        │       │               │       │    # Context manager support                                                                                                                                                                                                             
   604 │       │       │       │        │       │               │       │    def __enter__(self):                                                                                                                                                                                                                  
   605 │       │       │       │        │       │               │       │        return self                                                                                                                                                                                                                       
   606 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   607 │       │       │       │        │       │               │       │    def __exit__(self, *args):                                                                                                                                                                                                            
   608 │       │       │       │        │       │               │       │        from . import ImageFile                                                                                                                                                                                                           
   609 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   610 │       │       │       │        │       │               │       │        if isinstance(self, ImageFile.ImageFile):                                                                                                                                                                                         
   611 │       │       │       │        │       │               │       │            if getattr(self, "_exclusive_fp", False):                                                                                                                                                                                     
   612 │       │       │       │        │       │               │       │                self._close_fp()                                                                                                                                                                                                          
   613 │       │       │       │        │       │               │       │            self.fp = None                                                                                                                                                                                                                
   614 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   615 │       │       │       │        │       │               │       │    def close(self) -> None:                                                                                                                                                                                                              
   616 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   617 │       │       │       │        │       │               │       │        This operation will destroy the image core and release its memory.                                                                                                                                                                
   618 │       │       │       │        │       │               │       │        The image data will be unusable afterward.                                                                                                                                                                                        
   619 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   620 │       │       │       │        │       │               │       │        This function is required to close images that have multiple frames or                                                                                                                                                            
   621 │       │       │       │        │       │               │       │        have not had their file read and closed by the                                                                                                                                                                                    
   622 │       │       │       │        │       │               │       │        :py:meth:`~PIL.Image.Image.load` method. See :ref:`file-handling` for                                                                                                                                                             
   623 │       │       │       │        │       │               │       │        more information.                                                                                                                                                                                                                 
   624 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   625 │       │       │       │        │       │               │       │        if getattr(self, "map", None):                                                                                                                                                                                                    
   626 │       │       │       │        │       │               │       │            if sys.platform == "win32" and hasattr(sys, "pypy_version_info"):                                                                                                                                                             
   627 │       │       │       │        │       │               │       │                self.map.close()                                                                                                                                                                                                          
   628 │       │       │       │        │       │               │       │            self.map: mmap.mmap | None = None                                                                                                                                                                                             
   629 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   630 │       │       │       │        │       │               │       │        # Instead of simply setting to None, we're setting up a                                                                                                                                                                           
   631 │       │       │       │        │       │               │       │        # deferred error that will better explain that the core image                                                                                                                                                                     
   632 │       │       │       │        │       │               │       │        # object is gone.                                                                                                                                                                                                                 
   633 │       │       │       │        │       │               │       │        self._im = DeferredError(ValueError("Operation on closed image"))                                                                                                                                                                 
   634 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   635 │       │       │       │        │       │               │       │    def _copy(self) -> None:                                                                                                                                                                                                              
   636 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
   637 │       │       │       │        │       │               │       │        self.im = self.im.copy()                                                                                                                                                                                                          
   638 │       │       │       │        │       │               │       │        self.readonly = 0                                                                                                                                                                                                                 
   639 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   640 │       │       │       │        │       │               │       │    def _ensure_mutable(self) -> None:                                                                                                                                                                                                    
   641 │       │       │       │        │       │               │       │        if self.readonly:                                                                                                                                                                                                                 
   642 │       │       │       │        │       │               │       │            self._copy()                                                                                                                                                                                                                  
   643 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   644 │       │       │       │        │       │               │       │            self.load()                                                                                                                                                                                                                   
   645 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   646 │       │       │       │        │       │               │       │    def _dump(                                                                                                                                                                                                                            
   647 │       │       │       │        │       │               │       │        self, file: str | None = None, format: str | None = None, **options: Any                                                                                                                                                          
   648 │       │       │       │        │       │               │       │    ) -> str:                                                                                                                                                                                                                             
   649 │       │       │       │        │       │               │       │        suffix = ""                                                                                                                                                                                                                       
   650 │       │       │       │        │       │               │       │        if format:                                                                                                                                                                                                                        
   651 │       │       │       │        │       │               │       │            suffix = f".{format}"                                                                                                                                                                                                         
   652 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   653 │       │       │       │        │       │               │       │        if not file:                                                                                                                                                                                                                      
   654 │       │       │       │        │       │               │       │            f, filename = tempfile.mkstemp(suffix)                                                                                                                                                                                        
   655 │       │       │       │        │       │               │       │            os.close(f)                                                                                                                                                                                                                   
   656 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   657 │       │       │       │        │       │               │       │            filename = file                                                                                                                                                                                                               
   658 │       │       │       │        │       │               │       │            if not filename.endswith(suffix):                                                                                                                                                                                             
   659 │       │       │       │        │       │               │       │                filename = filename + suffix                                                                                                                                                                                              
   660 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   661 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
   662 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   663 │       │       │       │        │       │               │       │        if not format or format == "PPM":                                                                                                                                                                                                 
   664 │       │       │       │        │       │               │       │            self.im.save_ppm(filename)                                                                                                                                                                                                    
   665 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   666 │       │       │       │        │       │               │       │            self.save(filename, format, **options)                                                                                                                                                                                        
   667 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   668 │       │       │       │        │       │               │       │        return filename                                                                                                                                                                                                                   
   669 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   670 │       │       │       │        │       │               │       │    def __eq__(self, other: object) -> bool:                                                                                                                                                                                              
   671 │       │       │       │        │       │               │       │        if self.__class__ is not other.__class__:                                                                                                                                                                                         
   672 │       │       │       │        │       │               │       │            return False                                                                                                                                                                                                                  
   673 │       │       │       │        │       │               │       │        assert isinstance(other, Image)                                                                                                                                                                                                   
   674 │       │       │       │        │       │               │       │        return (                                                                                                                                                                                                                          
   675 │       │       │       │        │       │               │       │            self.mode == other.mode                                                                                                                                                                                                       
   676 │       │       │       │        │       │               │       │            and self.size == other.size                                                                                                                                                                                                   
   677 │       │       │       │        │       │               │       │            and self.info == other.info                                                                                                                                                                                                   
   678 │       │       │       │        │       │               │       │            and self.getpalette() == other.getpalette()                                                                                                                                                                                   
   679 │       │       │       │        │       │               │       │            and self.tobytes() == other.tobytes()                                                                                                                                                                                         
   680 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   681 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   682 │       │       │       │        │       │               │       │    def __repr__(self) -> str:                                                                                                                                                                                                            
   683 │       │       │       │        │       │               │       │        return (                                                                                                                                                                                                                          
   684 │       │       │       │        │       │               │       │            f"<{self.__class__.__module__}.{self.__class__.__name__} "                                                                                                                                                                    
   685 │       │       │       │        │       │               │       │            f"image mode={self.mode} size={self.size[0]}x{self.size[1]} "                                                                                                                                                                 
   686 │       │       │       │        │       │               │       │            f"at 0x{id(self):X}>"                                                                                                                                                                                                         
   687 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   688 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   689 │       │       │       │        │       │               │       │    def _repr_pretty_(self, p: PrettyPrinter, cycle: bool) -> None:                                                                                                                                                                       
   690 │       │       │       │        │       │               │       │        """IPython plain text display support"""                                                                                                                                                                                          
   691 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   692 │       │       │       │        │       │               │       │        # Same as __repr__ but without unpredictable id(self),                                                                                                                                                                            
   693 │       │       │       │        │       │               │       │        # to keep Jupyter notebook `text/plain` output stable.                                                                                                                                                                            
   694 │       │       │       │        │       │               │       │        p.text(                                                                                                                                                                                                                           
   695 │       │       │       │        │       │               │       │            f"<{self.__class__.__module__}.{self.__class__.__name__} "                                                                                                                                                                    
   696 │       │       │       │        │       │               │       │            f"image mode={self.mode} size={self.size[0]}x{self.size[1]}>"                                                                                                                                                                 
   697 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   698 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   699 │       │       │       │        │       │               │       │    def _repr_image(self, image_format: str, **kwargs: Any) -> bytes | None:                                                                                                                                                              
   700 │       │       │       │        │       │               │       │        """Helper function for iPython display hook.                                                                                                                                                                                      
   701 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   702 │       │       │       │        │       │               │       │        :param image_format: Image format.                                                                                                                                                                                                
   703 │       │       │       │        │       │               │       │        :returns: image as bytes, saved into the given format.                                                                                                                                                                            
   704 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   705 │       │       │       │        │       │               │       │        b = io.BytesIO()                                                                                                                                                                                                                  
   706 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   707 │       │       │       │        │       │               │       │            self.save(b, image_format, **kwargs)                                                                                                                                                                                          
   708 │       │       │       │        │       │               │       │        except Exception:                                                                                                                                                                                                                 
   709 │       │       │       │        │       │               │       │            return None                                                                                                                                                                                                                   
   710 │       │       │       │        │       │               │       │        return b.getvalue()                                                                                                                                                                                                               
   711 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   712 │       │       │       │        │       │               │       │    def _repr_png_(self) -> bytes | None:                                                                                                                                                                                                 
   713 │       │       │       │        │       │               │       │        """iPython display hook support for PNG format.                                                                                                                                                                                   
   714 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   715 │       │       │       │        │       │               │       │        :returns: PNG version of the image as bytes                                                                                                                                                                                       
   716 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   717 │       │       │       │        │       │               │       │        return self._repr_image("PNG", compress_level=1)                                                                                                                                                                                  
   718 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   719 │       │       │       │        │       │               │       │    def _repr_jpeg_(self) -> bytes | None:                                                                                                                                                                                                
   720 │       │       │       │        │       │               │       │        """iPython display hook support for JPEG format.                                                                                                                                                                                  
   721 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   722 │       │       │       │        │       │               │       │        :returns: JPEG version of the image as bytes                                                                                                                                                                                      
   723 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   724 │       │       │       │        │       │               │       │        return self._repr_image("JPEG")                                                                                                                                                                                                   
   725 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   726 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
   727 │       │       │       │        │       │               │       │    def __array_interface__(self) -> dict[str, str | bytes | int | tuple[int, ...]]:                                                                                                                                                      
   728 │       │       │       │        │       │               │       │        # numpy array interface support                                                                                                                                                                                                   
   729 │       │       │       │        │       │               │       │        new: dict[str, str | bytes | int | tuple[int, ...]] = {"version": 3}                                                                                                                                                              
   730 │       │       │       │        │       │               │       │        if self.mode == "1":                                                                                                                                                                                                              
   731 │       │       │       │        │       │               │       │            # Binary images need to be extended from bits to bytes                                                                                                                                                                        
   732 │       │       │       │        │       │               │       │            # See: https://github.com/python-pillow/Pillow/issues/350                                                                                                                                                                     
   733 │       │       │       │        │       │               │       │            new["data"] = self.tobytes("raw", "L")                                                                                                                                                                                        
   734 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   735 │       │       │       │        │       │               │       │            new["data"] = self.tobytes()                                                                                                                                                                                                  
   736 │       │       │       │        │       │               │       │        new["shape"], new["typestr"] = _conv_type_shape(self)                                                                                                                                                                             
   737 │       │       │       │        │       │               │       │        return new                                                                                                                                                                                                                        
   738 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   739 │       │       │       │        │       │               │       │    def __arrow_c_schema__(self) -> object:                                                                                                                                                                                               
   740 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
   741 │       │       │       │        │       │               │       │        return self.im.__arrow_c_schema__()                                                                                                                                                                                               
   742 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   743 │       │       │       │        │       │               │       │    def __arrow_c_array__(                                                                                                                                                                                                                
   744 │       │       │       │        │       │               │       │        self, requested_schema: object | None = None                                                                                                                                                                                      
   745 │       │       │       │        │       │               │       │    ) -> tuple[object, object]:                                                                                                                                                                                                           
   746 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
   747 │       │       │       │        │       │               │       │        return (self.im.__arrow_c_schema__(), self.im.__arrow_c_array__())                                                                                                                                                                
   748 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   749 │       │       │       │        │       │               │       │    def __getstate__(self) -> list[Any]:                                                                                                                                                                                                  
   750 │       │       │       │        │       │               │       │        im_data = self.tobytes()  # load image first                                                                                                                                                                                      
   751 │       │       │       │        │       │               │       │        return [self.info, self.mode, self.size, self.getpalette(), im_data]                                                                                                                                                              
   752 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   753 │       │       │       │        │       │               │       │    def __setstate__(self, state: list[Any]) -> None:                                                                                                                                                                                     
   754 │       │       │       │        │       │               │       │        Image.__init__(self)                                                                                                                                                                                                              
   755 │       │       │       │        │       │               │       │        info, mode, size, palette, data = state[:5]                                                                                                                                                                                       
   756 │       │       │       │        │       │               │       │        self.info = info                                                                                                                                                                                                                  
   757 │       │       │       │        │       │               │       │        self._mode = mode                                                                                                                                                                                                                 
   758 │       │       │       │        │       │               │       │        self._size = size                                                                                                                                                                                                                 
   759 │       │       │       │        │       │               │       │        self.im = core.new(mode, size)                                                                                                                                                                                                    
   760 │       │       │       │        │       │               │       │        if mode in ("L", "LA", "P", "PA") and palette:                                                                                                                                                                                    
   761 │       │       │       │        │       │               │       │            self.putpalette(palette)                                                                                                                                                                                                      
   762 │       │       │       │        │       │               │       │        self.frombytes(data)                                                                                                                                                                                                              
   763 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   764 │       │       │       │        │       │               │       │    def tobytes(self, encoder_name: str = "raw", *args: Any) -> bytes:                                                                                                                                                                    
   765 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   766 │       │       │       │        │       │               │       │        Return image as a bytes object.                                                                                                                                                                                                   
   767 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   768 │       │       │       │        │       │               │       │        .. warning::                                                                                                                                                                                                                      
   769 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   770 │       │       │       │        │       │               │       │            This method returns the raw image data from the internal                                                                                                                                                                      
   771 │       │       │       │        │       │               │       │            storage.  For compressed image data (e.g. PNG, JPEG) use                                                                                                                                                                      
   772 │       │       │       │        │       │               │       │            :meth:`~.save`, with a BytesIO parameter for in-memory                                                                                                                                                                        
   773 │       │       │       │        │       │               │       │            data.                                                                                                                                                                                                                         
   774 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   775 │       │       │       │        │       │               │       │        :param encoder_name: What encoder to use.  The default is to                                                                                                                                                                      
   776 │       │       │       │        │       │               │       │                             use the standard "raw" encoder.                                                                                                                                                                              
   777 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   778 │       │       │       │        │       │               │       │                             A list of C encoders can be seen under                                                                                                                                                                       
   779 │       │       │       │        │       │               │       │                             codecs section of the function array in                                                                                                                                                                      
   780 │       │       │       │        │       │               │       │                             :file:`_imaging.c`. Python encoders are                                                                                                                                                                      
   781 │       │       │       │        │       │               │       │                             registered within the relevant plugins.                                                                                                                                                                      
   782 │       │       │       │        │       │               │       │        :param args: Extra arguments to the encoder.                                                                                                                                                                                      
   783 │       │       │       │        │       │               │       │        :returns: A :py:class:`bytes` object.                                                                                                                                                                                             
   784 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   785 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   786 │       │       │       │        │       │               │       │        encoder_args: Any = args                                                                                                                                                                                                          
   787 │       │       │       │        │       │               │       │        if len(encoder_args) == 1 and isinstance(encoder_args[0], tuple):                                                                                                                                                                 
   788 │       │       │       │        │       │               │       │            # may pass tuple instead of argument list                                                                                                                                                                                     
   789 │       │       │       │        │       │               │       │            encoder_args = encoder_args[0]                                                                                                                                                                                                
   790 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   791 │       │       │       │        │       │               │       │        if encoder_name == "raw" and encoder_args == ():                                                                                                                                                                                  
   792 │       │       │       │        │       │               │       │            encoder_args = self.mode                                                                                                                                                                                                      
   793 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   794 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
   795 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   796 │       │       │       │        │       │               │       │        if self.width == 0 or self.height == 0:                                                                                                                                                                                           
   797 │       │       │       │        │       │               │       │            return b""                                                                                                                                                                                                                    
   798 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   799 │       │       │       │        │       │               │       │        # unpack data                                                                                                                                                                                                                     
   800 │       │       │       │        │       │               │       │        e = _getencoder(self.mode, encoder_name, encoder_args)                                                                                                                                                                            
   801 │       │       │       │        │       │               │       │        e.setimage(self.im)                                                                                                                                                                                                               
   802 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   803 │       │       │       │        │       │               │       │        bufsize = max(65536, self.size[0] * 4)  # see RawEncode.c                                                                                                                                                                         
   804 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   805 │       │       │       │        │       │               │       │        output = []                                                                                                                                                                                                                       
   806 │       │       │       │        │       │               │       │        while True:                                                                                                                                                                                                                       
   807 │       │       │       │        │       │               │       │            bytes_consumed, errcode, data = e.encode(bufsize)                                                                                                                                                                             
   808 │       │       │       │        │       │               │       │            output.append(data)                                                                                                                                                                                                           
   809 │       │       │       │        │       │               │       │            if errcode:                                                                                                                                                                                                                   
   810 │       │       │       │        │       │               │       │                break                                                                                                                                                                                                                     
   811 │       │       │       │        │       │               │       │        if errcode < 0:                                                                                                                                                                                                                   
   812 │       │       │       │        │       │               │       │            msg = f"encoder error {errcode} in tobytes"                                                                                                                                                                                   
   813 │       │       │       │        │       │               │       │            raise RuntimeError(msg)                                                                                                                                                                                                       
   814 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   815 │       │       │       │        │       │               │       │        return b"".join(output)                                                                                                                                                                                                           
   816 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   817 │       │       │       │        │       │               │       │    def tobitmap(self, name: str = "image") -> bytes:                                                                                                                                                                                     
   818 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   819 │       │       │       │        │       │               │       │        Returns the image converted to an X11 bitmap.                                                                                                                                                                                     
   820 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   821 │       │       │       │        │       │               │       │        .. note:: This method only works for mode "1" images.                                                                                                                                                                             
   822 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   823 │       │       │       │        │       │               │       │        :param name: The name prefix to use for the bitmap variables.                                                                                                                                                                     
   824 │       │       │       │        │       │               │       │        :returns: A string containing an X11 bitmap.                                                                                                                                                                                      
   825 │       │       │       │        │       │               │       │        :raises ValueError: If the mode is not "1"                                                                                                                                                                                        
   826 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   827 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   828 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
   829 │       │       │       │        │       │               │       │        if self.mode != "1":                                                                                                                                                                                                              
   830 │       │       │       │        │       │               │       │            msg = "not a bitmap"                                                                                                                                                                                                          
   831 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
   832 │       │       │       │        │       │               │       │        data = self.tobytes("xbm")                                                                                                                                                                                                        
   833 │       │       │       │        │       │               │       │        return b"".join(                                                                                                                                                                                                                  
   834 │       │       │       │        │       │               │       │            [                                                                                                                                                                                                                             
   835 │       │       │       │        │       │               │       │                f"#define {name}_width {self.size[0]}\n".encode("ascii"),                                                                                                                                                                 
   836 │       │       │       │        │       │               │       │                f"#define {name}_height {self.size[1]}\n".encode("ascii"),                                                                                                                                                                
   837 │       │       │       │        │       │               │       │                f"static char {name}_bits[] = {{\n".encode("ascii"),                                                                                                                                                                      
   838 │       │       │       │        │       │               │       │                data,                                                                                                                                                                                                                     
   839 │       │       │       │        │       │               │       │                b"};",                                                                                                                                                                                                                    
   840 │       │       │       │        │       │               │       │            ]                                                                                                                                                                                                                             
   841 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   842 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   843 │       │       │       │        │       │               │       │    def frombytes(                                                                                                                                                                                                                        
   844 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   845 │       │       │       │        │       │               │       │        data: bytes | bytearray | SupportsArrayInterface,                                                                                                                                                                                 
   846 │       │       │       │        │       │               │       │        decoder_name: str = "raw",                                                                                                                                                                                                        
   847 │       │       │       │        │       │               │       │        *args: Any,                                                                                                                                                                                                                       
   848 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
   849 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   850 │       │       │       │        │       │               │       │        Loads this image with pixel data from a bytes object.                                                                                                                                                                             
   851 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   852 │       │       │       │        │       │               │       │        This method is similar to the :py:func:`~PIL.Image.frombytes` function,                                                                                                                                                           
   853 │       │       │       │        │       │               │       │        but loads data into this image instead of creating a new image object.                                                                                                                                                            
   854 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   855 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   856 │       │       │       │        │       │               │       │        if self.width == 0 or self.height == 0:                                                                                                                                                                                           
   857 │       │       │       │        │       │               │       │            return                                                                                                                                                                                                                        
   858 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   859 │       │       │       │        │       │               │       │        decoder_args: Any = args                                                                                                                                                                                                          
   860 │       │       │       │        │       │               │       │        if len(decoder_args) == 1 and isinstance(decoder_args[0], tuple):                                                                                                                                                                 
   861 │       │       │       │        │       │               │       │            # may pass tuple instead of argument list                                                                                                                                                                                     
   862 │       │       │       │        │       │               │       │            decoder_args = decoder_args[0]                                                                                                                                                                                                
   863 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   864 │       │       │       │        │       │               │       │        # default format                                                                                                                                                                                                                  
   865 │       │       │       │        │       │               │       │        if decoder_name == "raw" and decoder_args == ():                                                                                                                                                                                  
   866 │       │       │       │        │       │               │       │            decoder_args = self.mode                                                                                                                                                                                                      
   867 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   868 │       │       │       │        │       │               │       │        # unpack data                                                                                                                                                                                                                     
   869 │       │       │       │        │       │               │       │        d = _getdecoder(self.mode, decoder_name, decoder_args)                                                                                                                                                                            
   870 │       │       │       │        │       │               │       │        d.setimage(self.im)                                                                                                                                                                                                               
   871 │       │       │       │        │       │               │       │        s = d.decode(data)                                                                                                                                                                                                                
   872 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   873 │       │       │       │        │       │               │       │        if s[0] >= 0:                                                                                                                                                                                                                     
   874 │       │       │       │        │       │               │       │            msg = "not enough image data"                                                                                                                                                                                                 
   875 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
   876 │       │       │       │        │       │               │       │        if s[1] != 0:                                                                                                                                                                                                                     
   877 │       │       │       │        │       │               │       │            msg = "cannot decode image data"                                                                                                                                                                                              
   878 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
   879 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   880 │       │       │       │        │       │               │       │    def load(self) -> core.PixelAccess | None:                                                                                                                                                                                            
   881 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   882 │       │       │       │        │       │               │       │        Allocates storage for the image and loads the pixel data.  In                                                                                                                                                                     
   883 │       │       │       │        │       │               │       │        normal cases, you don't need to call this method, since the                                                                                                                                                                       
   884 │       │       │       │        │       │               │       │        Image class automatically loads an opened image when it is                                                                                                                                                                        
   885 │       │       │       │        │       │               │       │        accessed for the first time.                                                                                                                                                                                                      
   886 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   887 │       │       │       │        │       │               │       │        If the file associated with the image was opened by Pillow, then this                                                                                                                                                             
   888 │       │       │       │        │       │               │       │        method will close it. The exception to this is if the image has                                                                                                                                                                   
   889 │       │       │       │        │       │               │       │        multiple frames, in which case the file will be left open for seek                                                                                                                                                                
   890 │       │       │       │        │       │               │       │        operations. See :ref:`file-handling` for more information.                                                                                                                                                                        
   891 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   892 │       │       │       │        │       │               │       │        :returns: An image access object.                                                                                                                                                                                                 
   893 │       │       │       │        │       │               │       │        :rtype: :py:class:`.PixelAccess`                                                                                                                                                                                                  
   894 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   895 │       │       │       │        │       │               │       │        if self._im is not None and self.palette and self.palette.dirty:                                                                                                                                                                  
   896 │       │       │       │        │       │               │       │            # realize palette                                                                                                                                                                                                             
   897 │       │       │       │        │       │               │       │            mode, arr = self.palette.getdata()                                                                                                                                                                                            
   898 │       │       │       │        │       │               │       │            self.im.putpalette(self.palette.mode, mode, arr)                                                                                                                                                                              
   899 │       │       │       │        │       │               │       │            self.palette.dirty = 0                                                                                                                                                                                                        
   900 │       │       │       │        │       │               │       │            self.palette.rawmode = None                                                                                                                                                                                                   
   901 │       │       │       │        │       │               │       │            if "transparency" in self.info and mode in ("LA", "PA"):                                                                                                                                                                      
   902 │       │       │       │        │       │               │       │                if isinstance(self.info["transparency"], int):                                                                                                                                                                            
   903 │       │       │       │        │       │               │       │                    self.im.putpalettealpha(self.info["transparency"], 0)                                                                                                                                                                 
   904 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
   905 │       │       │       │        │       │               │       │                    self.im.putpalettealphas(self.info["transparency"])                                                                                                                                                                   
   906 │       │       │       │        │       │               │       │                self.palette.mode = "RGBA"                                                                                                                                                                                                
   907 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   908 │       │       │       │        │       │               │       │                self.palette.palette = self.im.getpalette(                                                                                                                                                                                
   909 │       │       │       │        │       │               │       │                    self.palette.mode, self.palette.mode                                                                                                                                                                                  
   910 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   911 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   912 │       │       │       │        │       │               │       │        if self._im is not None:                                                                                                                                                                                                          
   913 │       │       │       │        │       │               │       │            return self.im.pixel_access(self.readonly)                                                                                                                                                                                    
   914 │       │       │       │        │       │               │       │        return None                                                                                                                                                                                                                       
   915 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   916 │       │       │       │        │       │               │       │    def verify(self) -> None:                                                                                                                                                                                                             
   917 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   918 │       │       │       │        │       │               │       │        Verifies the contents of a file. For data read from a file, this                                                                                                                                                                  
   919 │       │       │       │        │       │               │       │        method attempts to determine if the file is broken, without                                                                                                                                                                       
   920 │       │       │       │        │       │               │       │        actually decoding the image data.  If this method finds any                                                                                                                                                                       
   921 │       │       │       │        │       │               │       │        problems, it raises suitable exceptions.  If you need to load                                                                                                                                                                     
   922 │       │       │       │        │       │               │       │        the image after using this method, you must reopen the image                                                                                                                                                                      
   923 │       │       │       │        │       │               │       │        file.                                                                                                                                                                                                                             
   924 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   925 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
   926 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   927 │       │       │       │        │       │               │       │    def convert(                                                                                                                                                                                                                          
   928 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   929 │       │       │       │        │       │               │       │        mode: str | None = None,                                                                                                                                                                                                          
   930 │       │       │       │        │       │               │       │        matrix: tuple[float, ...] | None = None,                                                                                                                                                                                          
   931 │       │       │       │        │       │               │       │        dither: Dither | None = None,                                                                                                                                                                                                     
   932 │       │       │       │        │       │               │       │        palette: Palette = Palette.WEB,                                                                                                                                                                                                   
   933 │       │       │       │        │       │               │       │        colors: int = 256,                                                                                                                                                                                                                
   934 │       │       │       │        │       │               │       │    ) -> Image:                                                                                                                                                                                                                           
   935 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   936 │       │       │       │        │       │               │       │        Returns a converted copy of this image. For the "P" mode, this                                                                                                                                                                    
   937 │       │       │       │        │       │               │       │        method translates pixels through the palette.  If mode is                                                                                                                                                                         
   938 │       │       │       │        │       │               │       │        omitted, a mode is chosen so that all information in the image                                                                                                                                                                    
   939 │       │       │       │        │       │               │       │        and the palette can be represented without a palette.                                                                                                                                                                             
   940 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   941 │       │       │       │        │       │               │       │        This supports all possible conversions between "L", "RGB" and "CMYK". The                                                                                                                                                         
   942 │       │       │       │        │       │               │       │        ``matrix`` argument only supports "L" and "RGB".                                                                                                                                                                                  
   943 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   944 │       │       │       │        │       │               │       │        When translating a color image to grayscale (mode "L"),                                                                                                                                                                           
   945 │       │       │       │        │       │               │       │        the library uses the ITU-R 601-2 luma transform::                                                                                                                                                                                 
   946 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   947 │       │       │       │        │       │               │       │            L = R * 299/1000 + G * 587/1000 + B * 114/1000                                                                                                                                                                                
   948 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   949 │       │       │       │        │       │               │       │        The default method of converting a grayscale ("L") or "RGB"                                                                                                                                                                       
   950 │       │       │       │        │       │               │       │        image into a bilevel (mode "1") image uses Floyd-Steinberg                                                                                                                                                                        
   951 │       │       │       │        │       │               │       │        dither to approximate the original image luminosity levels. If                                                                                                                                                                    
   952 │       │       │       │        │       │               │       │        dither is ``None``, all values larger than 127 are set to 255 (white),                                                                                                                                                            
   953 │       │       │       │        │       │               │       │        all other values to 0 (black). To use other thresholds, use the                                                                                                                                                                   
   954 │       │       │       │        │       │               │       │        :py:meth:`~PIL.Image.Image.point` method.                                                                                                                                                                                         
   955 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   956 │       │       │       │        │       │               │       │        When converting from "RGBA" to "P" without a ``matrix`` argument,                                                                                                                                                                 
   957 │       │       │       │        │       │               │       │        this passes the operation to :py:meth:`~PIL.Image.Image.quantize`,                                                                                                                                                                
   958 │       │       │       │        │       │               │       │        and ``dither`` and ``palette`` are ignored.                                                                                                                                                                                       
   959 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   960 │       │       │       │        │       │               │       │        When converting from "PA", if an "RGBA" palette is present, the alpha                                                                                                                                                             
   961 │       │       │       │        │       │               │       │        channel from the image will be used instead of the values from the palette.                                                                                                                                                       
   962 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   963 │       │       │       │        │       │               │       │        :param mode: The requested mode. See: :ref:`concept-modes`.                                                                                                                                                                       
   964 │       │       │       │        │       │               │       │        :param matrix: An optional conversion matrix.  If given, this                                                                                                                                                                     
   965 │       │       │       │        │       │               │       │           should be 4- or 12-tuple containing floating point values.                                                                                                                                                                     
   966 │       │       │       │        │       │               │       │        :param dither: Dithering method, used when converting from                                                                                                                                                                        
   967 │       │       │       │        │       │               │       │           mode "RGB" to "P" or from "RGB" or "L" to "1".                                                                                                                                                                                 
   968 │       │       │       │        │       │               │       │           Available methods are :data:`Dither.NONE` or :data:`Dither.FLOYDSTEINBERG`                                                                                                                                                     
   969 │       │       │       │        │       │               │       │           (default). Note that this is not used when ``matrix`` is supplied.                                                                                                                                                             
   970 │       │       │       │        │       │               │       │        :param palette: Palette to use when converting from mode "RGB"                                                                                                                                                                    
   971 │       │       │       │        │       │               │       │           to "P".  Available palettes are :data:`Palette.WEB` or                                                                                                                                                                         
   972 │       │       │       │        │       │               │       │           :data:`Palette.ADAPTIVE`.                                                                                                                                                                                                      
   973 │       │       │       │        │       │               │       │        :param colors: Number of colors to use for the :data:`Palette.ADAPTIVE`                                                                                                                                                           
   974 │       │       │       │        │       │               │       │           palette. Defaults to 256.                                                                                                                                                                                                      
   975 │       │       │       │        │       │               │       │        :rtype: :py:class:`~PIL.Image.Image`                                                                                                                                                                                              
   976 │       │       │       │        │       │               │       │        :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                 
   977 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   978 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   979 │       │       │       │        │       │               │       │        if mode in ("BGR;15", "BGR;16", "BGR;24"):                                                                                                                                                                                        
   980 │       │       │       │        │       │               │       │            deprecate(mode, 12)                                                                                                                                                                                                           
   981 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   982 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
   983 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   984 │       │       │       │        │       │               │       │        has_transparency = "transparency" in self.info                                                                                                                                                                                    
   985 │       │       │       │        │       │               │       │        if not mode and self.mode == "P":                                                                                                                                                                                                 
   986 │       │       │       │        │       │               │       │            # determine default mode                                                                                                                                                                                                      
   987 │       │       │       │        │       │               │       │            if self.palette:                                                                                                                                                                                                              
   988 │       │       │       │        │       │               │       │                mode = self.palette.mode                                                                                                                                                                                                  
   989 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   990 │       │       │       │        │       │               │       │                mode = "RGB"                                                                                                                                                                                                              
   991 │       │       │       │        │       │               │       │            if mode == "RGB" and has_transparency:                                                                                                                                                                                        
   992 │       │       │       │        │       │               │       │                mode = "RGBA"                                                                                                                                                                                                             
   993 │       │       │       │        │       │               │       │        if not mode or (mode == self.mode and not matrix):                                                                                                                                                                                
   994 │       │       │       │        │       │               │       │            return self.copy()                                                                                                                                                                                                            
   995 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   996 │       │       │       │        │       │               │       │        if matrix:                                                                                                                                                                                                                        
   997 │       │       │       │        │       │               │       │            # matrix conversion                                                                                                                                                                                                           
   998 │       │       │       │        │       │               │       │            if mode not in ("L", "RGB"):                                                                                                                                                                                                  
   999 │       │       │       │        │       │               │       │                msg = "illegal conversion"                                                                                                                                                                                                
  1000 │       │       │       │        │       │               │       │                raise ValueError(msg)                                                                                                                                                                                                     
  1001 │       │       │       │        │       │               │       │            im = self.im.convert_matrix(mode, matrix)                                                                                                                                                                                     
  1002 │       │       │       │        │       │               │       │            new_im = self._new(im)                                                                                                                                                                                                        
  1003 │       │       │       │        │       │               │       │            if has_transparency and self.im.bands == 3:                                                                                                                                                                                   
  1004 │       │       │       │        │       │               │       │                transparency = new_im.info["transparency"]                                                                                                                                                                                
  1005 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1006 │       │       │       │        │       │               │       │                def convert_transparency(                                                                                                                                                                                                 
  1007 │       │       │       │        │       │               │       │                    m: tuple[float, ...], v: tuple[int, int, int]                                                                                                                                                                         
  1008 │       │       │       │        │       │               │       │                ) -> int:                                                                                                                                                                                                                 
  1009 │       │       │       │        │       │               │       │                    value = m[0] * v[0] + m[1] * v[1] + m[2] * v[2] + m[3] * 0.5                                                                                                                                                          
  1010 │       │       │       │        │       │               │       │                    return max(0, min(255, int(value)))                                                                                                                                                                                   
  1011 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1012 │       │       │       │        │       │               │       │                if mode == "L":                                                                                                                                                                                                           
  1013 │       │       │       │        │       │               │       │                    transparency = convert_transparency(matrix, transparency)                                                                                                                                                             
  1014 │       │       │       │        │       │               │       │                elif len(mode) == 3:                                                                                                                                                                                                      
  1015 │       │       │       │        │       │               │       │                    transparency = tuple(                                                                                                                                                                                                 
  1016 │       │       │       │        │       │               │       │                        convert_transparency(matrix[i * 4 : i * 4 + 4], transparency)                                                                                                                                                     
  1017 │       │       │       │        │       │               │       │                        for i in range(len(transparency))                                                                                                                                                                                 
  1018 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
  1019 │       │       │       │        │       │               │       │                new_im.info["transparency"] = transparency                                                                                                                                                                                
  1020 │       │       │       │        │       │               │       │            return new_im                                                                                                                                                                                                                 
  1021 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1022 │       │       │       │        │       │               │       │        if mode == "P" and self.mode == "RGBA":                                                                                                                                                                                           
  1023 │       │       │       │        │       │               │       │            return self.quantize(colors)                                                                                                                                                                                                  
  1024 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1025 │       │       │       │        │       │               │       │        trns = None                                                                                                                                                                                                                       
  1026 │       │       │       │        │       │               │       │        delete_trns = False                                                                                                                                                                                                               
  1027 │       │       │       │        │       │               │       │        # transparency handling                                                                                                                                                                                                           
  1028 │       │       │       │        │       │               │       │        if has_transparency:                                                                                                                                                                                                              
  1029 │       │       │       │        │       │               │       │            if (self.mode in ("1", "L", "I", "I;16") and mode in ("LA", "RGBA")) or (                                                                                                                                                     
  1030 │       │       │       │        │       │               │       │                self.mode == "RGB" and mode in ("La", "LA", "RGBa", "RGBA")                                                                                                                                                               
  1031 │       │       │       │        │       │               │       │            ):                                                                                                                                                                                                                            
  1032 │       │       │       │        │       │               │       │                # Use transparent conversion to promote from transparent                                                                                                                                                                  
  1033 │       │       │       │        │       │               │       │                # color to an alpha channel.                                                                                                                                                                                              
  1034 │       │       │       │        │       │               │       │                new_im = self._new(                                                                                                                                                                                                       
  1035 │       │       │       │        │       │               │       │                    self.im.convert_transparent(mode, self.info["transparency"])                                                                                                                                                          
  1036 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  1037 │       │       │       │        │       │               │       │                del new_im.info["transparency"]                                                                                                                                                                                           
  1038 │       │       │       │        │       │               │       │                return new_im                                                                                                                                                                                                             
  1039 │       │       │       │        │       │               │       │            elif self.mode in ("L", "RGB", "P") and mode in ("L", "RGB", "P"):                                                                                                                                                            
  1040 │       │       │       │        │       │               │       │                t = self.info["transparency"]                                                                                                                                                                                             
  1041 │       │       │       │        │       │               │       │                if isinstance(t, bytes):                                                                                                                                                                                                  
  1042 │       │       │       │        │       │               │       │                    # Dragons. This can't be represented by a single color                                                                                                                                                                
  1043 │       │       │       │        │       │               │       │                    warnings.warn(                                                                                                                                                                                                        
  1044 │       │       │       │        │       │               │       │                        "Palette images with Transparency expressed in bytes should be "                                                                                                                                                  
  1045 │       │       │       │        │       │               │       │                        "converted to RGBA images"                                                                                                                                                                                        
  1046 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
  1047 │       │       │       │        │       │               │       │                    delete_trns = True                                                                                                                                                                                                    
  1048 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
  1049 │       │       │       │        │       │               │       │                    # get the new transparency color.                                                                                                                                                                                     
  1050 │       │       │       │        │       │               │       │                    # use existing conversions                                                                                                                                                                                            
  1051 │       │       │       │        │       │               │       │                    trns_im = new(self.mode, (1, 1))                                                                                                                                                                                      
  1052 │       │       │       │        │       │               │       │                    if self.mode == "P":                                                                                                                                                                                                  
  1053 │       │       │       │        │       │               │       │                        assert self.palette is not None                                                                                                                                                                                   
  1054 │       │       │       │        │       │               │       │                        trns_im.putpalette(self.palette, self.palette.mode)                                                                                                                                                               
  1055 │       │       │       │        │       │               │       │                        if isinstance(t, tuple):                                                                                                                                                                                          
  1056 │       │       │       │        │       │               │       │                            err = "Couldn't allocate a palette color for transparency"                                                                                                                                                    
  1057 │       │       │       │        │       │               │       │                            assert trns_im.palette is not None                                                                                                                                                                            
  1058 │       │       │       │        │       │               │       │                            try:                                                                                                                                                                                                          
  1059 │       │       │       │        │       │               │       │                                t = trns_im.palette.getcolor(t, self)                                                                                                                                                                     
  1060 │       │       │       │        │       │               │       │                            except ValueError as e:                                                                                                                                                                                       
  1061 │       │       │       │        │       │               │       │                                if str(e) == "cannot allocate more than 256 colors":                                                                                                                                                      
  1062 │       │       │       │        │       │               │       │                                    # If all 256 colors are in use,                                                                                                                                                                       
  1063 │       │       │       │        │       │               │       │                                    # then there is no need for transparency                                                                                                                                                              
  1064 │       │       │       │        │       │               │       │                                    t = None                                                                                                                                                                                              
  1065 │       │       │       │        │       │               │       │                                else:                                                                                                                                                                                                     
  1066 │       │       │       │        │       │               │       │                                    raise ValueError(err) from e                                                                                                                                                                          
  1067 │       │       │       │        │       │               │       │                    if t is None:                                                                                                                                                                                                         
  1068 │       │       │       │        │       │               │       │                        trns = None                                                                                                                                                                                                       
  1069 │       │       │       │        │       │               │       │                    else:                                                                                                                                                                                                                 
  1070 │       │       │       │        │       │               │       │                        trns_im.putpixel((0, 0), t)                                                                                                                                                                                       
  1071 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1072 │       │       │       │        │       │               │       │                        if mode in ("L", "RGB"):                                                                                                                                                                                          
  1073 │       │       │       │        │       │               │       │                            trns_im = trns_im.convert(mode)                                                                                                                                                                               
  1074 │       │       │       │        │       │               │       │                        else:                                                                                                                                                                                                             
  1075 │       │       │       │        │       │               │       │                            # can't just retrieve the palette number, got to do it                                                                                                                                                        
  1076 │       │       │       │        │       │               │       │                            # after quantization.                                                                                                                                                                                         
  1077 │       │       │       │        │       │               │       │                            trns_im = trns_im.convert("RGB")                                                                                                                                                                              
  1078 │       │       │       │        │       │               │       │                        trns = trns_im.getpixel((0, 0))                                                                                                                                                                                   
  1079 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1080 │       │       │       │        │       │               │       │            elif self.mode == "P" and mode in ("LA", "PA", "RGBA"):                                                                                                                                                                       
  1081 │       │       │       │        │       │               │       │                t = self.info["transparency"]                                                                                                                                                                                             
  1082 │       │       │       │        │       │               │       │                delete_trns = True                                                                                                                                                                                                        
  1083 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1084 │       │       │       │        │       │               │       │                if isinstance(t, bytes):                                                                                                                                                                                                  
  1085 │       │       │       │        │       │               │       │                    self.im.putpalettealphas(t)                                                                                                                                                                                           
  1086 │       │       │       │        │       │               │       │                elif isinstance(t, int):                                                                                                                                                                                                  
  1087 │       │       │       │        │       │               │       │                    self.im.putpalettealpha(t, 0)                                                                                                                                                                                         
  1088 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
  1089 │       │       │       │        │       │               │       │                    msg = "Transparency for P mode should be bytes or int"                                                                                                                                                                
  1090 │       │       │       │        │       │               │       │                    raise ValueError(msg)                                                                                                                                                                                                 
  1091 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1092 │       │       │       │        │       │               │       │        if mode == "P" and palette == Palette.ADAPTIVE:                                                                                                                                                                                   
  1093 │       │       │       │        │       │               │       │            im = self.im.quantize(colors)                                                                                                                                                                                                 
  1094 │       │       │       │        │       │               │       │            new_im = self._new(im)                                                                                                                                                                                                        
  1095 │       │       │       │        │       │               │       │            from . import ImagePalette                                                                                                                                                                                                    
  1096 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1097 │       │       │       │        │       │               │       │            new_im.palette = ImagePalette.ImagePalette(                                                                                                                                                                                   
  1098 │       │       │       │        │       │               │       │                "RGB", new_im.im.getpalette("RGB")                                                                                                                                                                                        
  1099 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  1100 │       │       │       │        │       │               │       │            if delete_trns:                                                                                                                                                                                                               
  1101 │       │       │       │        │       │               │       │                # This could possibly happen if we requantize to fewer colors.                                                                                                                                                            
  1102 │       │       │       │        │       │               │       │                # The transparency would be totally off in that case.                                                                                                                                                                     
  1103 │       │       │       │        │       │               │       │                del new_im.info["transparency"]                                                                                                                                                                                           
  1104 │       │       │       │        │       │               │       │            if trns is not None:                                                                                                                                                                                                          
  1105 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
  1106 │       │       │       │        │       │               │       │                    new_im.info["transparency"] = new_im.palette.getcolor(                                                                                                                                                                
  1107 │       │       │       │        │       │               │       │                        cast(tuple[int, ...], trns),  # trns was converted to RGB                                                                                                                                                         
  1108 │       │       │       │        │       │               │       │                        new_im,                                                                                                                                                                                                           
  1109 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
  1110 │       │       │       │        │       │               │       │                except Exception:                                                                                                                                                                                                         
  1111 │       │       │       │        │       │               │       │                    # if we can't make a transparent color, don't leave the old                                                                                                                                                           
  1112 │       │       │       │        │       │               │       │                    # transparency hanging around to mess us up.                                                                                                                                                                          
  1113 │       │       │       │        │       │               │       │                    del new_im.info["transparency"]                                                                                                                                                                                       
  1114 │       │       │       │        │       │               │       │                    warnings.warn("Couldn't allocate palette entry for transparency")                                                                                                                                                     
  1115 │       │       │       │        │       │               │       │            return new_im                                                                                                                                                                                                                 
  1116 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1117 │       │       │       │        │       │               │       │        if "LAB" in (self.mode, mode):                                                                                                                                                                                                    
  1118 │       │       │       │        │       │               │       │            im = self                                                                                                                                                                                                                     
  1119 │       │       │       │        │       │               │       │            if mode == "LAB":                                                                                                                                                                                                             
  1120 │       │       │       │        │       │               │       │                if im.mode not in ("RGB", "RGBA", "RGBX"):                                                                                                                                                                                
  1121 │       │       │       │        │       │               │       │                    im = im.convert("RGBA")                                                                                                                                                                                               
  1122 │       │       │       │        │       │               │       │                other_mode = im.mode                                                                                                                                                                                                      
  1123 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  1124 │       │       │       │        │       │               │       │                other_mode = mode                                                                                                                                                                                                         
  1125 │       │       │       │        │       │               │       │            if other_mode in ("RGB", "RGBA", "RGBX"):                                                                                                                                                                                     
  1126 │       │       │       │        │       │               │       │                from . import ImageCms                                                                                                                                                                                                    
  1127 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1128 │       │       │       │        │       │               │       │                srgb = ImageCms.createProfile("sRGB")                                                                                                                                                                                     
  1129 │       │       │       │        │       │               │       │                lab = ImageCms.createProfile("LAB")                                                                                                                                                                                       
  1130 │       │       │       │        │       │               │       │                profiles = [lab, srgb] if im.mode == "LAB" else [srgb, lab]                                                                                                                                                               
  1131 │       │       │       │        │       │               │       │                transform = ImageCms.buildTransform(                                                                                                                                                                                      
  1132 │       │       │       │        │       │               │       │                    profiles[0], profiles[1], im.mode, mode                                                                                                                                                                               
  1133 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  1134 │       │       │       │        │       │               │       │                return transform.apply(im)                                                                                                                                                                                                
  1135 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1136 │       │       │       │        │       │               │       │        # colorspace conversion                                                                                                                                                                                                           
  1137 │       │       │       │        │       │               │       │        if dither is None:                                                                                                                                                                                                                
  1138 │       │       │       │        │       │               │       │            dither = Dither.FLOYDSTEINBERG                                                                                                                                                                                                
  1139 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1140 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  1141 │       │       │       │        │       │               │       │            im = self.im.convert(mode, dither)                                                                                                                                                                                            
  1142 │       │       │       │        │       │               │       │        except ValueError:                                                                                                                                                                                                                
  1143 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
  1144 │       │       │       │        │       │               │       │                # normalize source image and try again                                                                                                                                                                                    
  1145 │       │       │       │        │       │               │       │                modebase = getmodebase(self.mode)                                                                                                                                                                                         
  1146 │       │       │       │        │       │               │       │                if modebase == self.mode:                                                                                                                                                                                                 
  1147 │       │       │       │        │       │               │       │                    raise                                                                                                                                                                                                                 
  1148 │       │       │       │        │       │               │       │                im = self.im.convert(modebase)                                                                                                                                                                                            
  1149 │       │       │       │        │       │               │       │                im = im.convert(mode, dither)                                                                                                                                                                                             
  1150 │       │       │       │        │       │               │       │            except KeyError as e:                                                                                                                                                                                                         
  1151 │       │       │       │        │       │               │       │                msg = "illegal conversion"                                                                                                                                                                                                
  1152 │       │       │       │        │       │               │       │                raise ValueError(msg) from e                                                                                                                                                                                              
  1153 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1154 │       │       │       │        │       │               │       │        new_im = self._new(im)                                                                                                                                                                                                            
  1155 │       │       │       │        │       │               │       │        if mode == "P" and palette != Palette.ADAPTIVE:                                                                                                                                                                                   
  1156 │       │       │       │        │       │               │       │            from . import ImagePalette                                                                                                                                                                                                    
  1157 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1158 │       │       │       │        │       │               │       │            new_im.palette = ImagePalette.ImagePalette("RGB", im.getpalette("RGB"))                                                                                                                                                       
  1159 │       │       │       │        │       │               │       │        if delete_trns:                                                                                                                                                                                                                   
  1160 │       │       │       │        │       │               │       │            # crash fail if we leave a bytes transparency in an rgb/l mode.                                                                                                                                                               
  1161 │       │       │       │        │       │               │       │            del new_im.info["transparency"]                                                                                                                                                                                               
  1162 │       │       │       │        │       │               │       │        if trns is not None:                                                                                                                                                                                                              
  1163 │       │       │       │        │       │               │       │            if new_im.mode == "P" and new_im.palette:                                                                                                                                                                                     
  1164 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
  1165 │       │       │       │        │       │               │       │                    new_im.info["transparency"] = new_im.palette.getcolor(                                                                                                                                                                
  1166 │       │       │       │        │       │               │       │                        cast(tuple[int, ...], trns), new_im  # trns was converted to RGB                                                                                                                                                  
  1167 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
  1168 │       │       │       │        │       │               │       │                except ValueError as e:                                                                                                                                                                                                   
  1169 │       │       │       │        │       │               │       │                    del new_im.info["transparency"]                                                                                                                                                                                       
  1170 │       │       │       │        │       │               │       │                    if str(e) != "cannot allocate more than 256 colors":                                                                                                                                                                  
  1171 │       │       │       │        │       │               │       │                        # If all 256 colors are in use,                                                                                                                                                                                   
  1172 │       │       │       │        │       │               │       │                        # then there is no need for transparency                                                                                                                                                                          
  1173 │       │       │       │        │       │               │       │                        warnings.warn(                                                                                                                                                                                                    
  1174 │       │       │       │        │       │               │       │                            "Couldn't allocate palette entry for transparency"                                                                                                                                                            
  1175 │       │       │       │        │       │               │       │                        )                                                                                                                                                                                                                 
  1176 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  1177 │       │       │       │        │       │               │       │                new_im.info["transparency"] = trns                                                                                                                                                                                        
  1178 │       │       │       │        │       │               │       │        return new_im                                                                                                                                                                                                                     
  1179 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1180 │       │       │       │        │       │               │       │    def quantize(                                                                                                                                                                                                                         
  1181 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  1182 │       │       │       │        │       │               │       │        colors: int = 256,                                                                                                                                                                                                                
  1183 │       │       │       │        │       │               │       │        method: int | None = None,                                                                                                                                                                                                        
  1184 │       │       │       │        │       │               │       │        kmeans: int = 0,                                                                                                                                                                                                                  
  1185 │       │       │       │        │       │               │       │        palette: Image | None = None,                                                                                                                                                                                                     
  1186 │       │       │       │        │       │               │       │        dither: Dither = Dither.FLOYDSTEINBERG,                                                                                                                                                                                           
  1187 │       │       │       │        │       │               │       │    ) -> Image:                                                                                                                                                                                                                           
  1188 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1189 │       │       │       │        │       │               │       │        Convert the image to 'P' mode with the specified number                                                                                                                                                                           
  1190 │       │       │       │        │       │               │       │        of colors.                                                                                                                                                                                                                        
  1191 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1192 │       │       │       │        │       │               │       │        :param colors: The desired number of colors, <= 256                                                                                                                                                                               
  1193 │       │       │       │        │       │               │       │        :param method: :data:`Quantize.MEDIANCUT` (median cut),                                                                                                                                                                           
  1194 │       │       │       │        │       │               │       │                       :data:`Quantize.MAXCOVERAGE` (maximum coverage),                                                                                                                                                                   
  1195 │       │       │       │        │       │               │       │                       :data:`Quantize.FASTOCTREE` (fast octree),                                                                                                                                                                         
  1196 │       │       │       │        │       │               │       │                       :data:`Quantize.LIBIMAGEQUANT` (libimagequant; check support                                                                                                                                                       
  1197 │       │       │       │        │       │               │       │                       using :py:func:`PIL.features.check_feature` with                                                                                                                                                                   
  1198 │       │       │       │        │       │               │       │                       ``feature="libimagequant"``).                                                                                                                                                                                      
  1199 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1200 │       │       │       │        │       │               │       │                       By default, :data:`Quantize.MEDIANCUT` will be used.                                                                                                                                                               
  1201 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1202 │       │       │       │        │       │               │       │                       The exception to this is RGBA images. :data:`Quantize.MEDIANCUT`                                                                                                                                                   
  1203 │       │       │       │        │       │               │       │                       and :data:`Quantize.MAXCOVERAGE` do not support RGBA images, so                                                                                                                                                    
  1204 │       │       │       │        │       │               │       │                       :data:`Quantize.FASTOCTREE` is used by default instead.                                                                                                                                                            
  1205 │       │       │       │        │       │               │       │        :param kmeans: Integer greater than or equal to zero.                                                                                                                                                                             
  1206 │       │       │       │        │       │               │       │        :param palette: Quantize to the palette of given                                                                                                                                                                                  
  1207 │       │       │       │        │       │               │       │                        :py:class:`PIL.Image.Image`.                                                                                                                                                                                      
  1208 │       │       │       │        │       │               │       │        :param dither: Dithering method, used when converting from                                                                                                                                                                        
  1209 │       │       │       │        │       │               │       │           mode "RGB" to "P" or from "RGB" or "L" to "1".                                                                                                                                                                                 
  1210 │       │       │       │        │       │               │       │           Available methods are :data:`Dither.NONE` or :data:`Dither.FLOYDSTEINBERG`                                                                                                                                                     
  1211 │       │       │       │        │       │               │       │           (default).                                                                                                                                                                                                                     
  1212 │       │       │       │        │       │               │       │        :returns: A new image                                                                                                                                                                                                             
  1213 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1214 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1215 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1216 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1217 │       │       │       │        │       │               │       │        if method is None:                                                                                                                                                                                                                
  1218 │       │       │       │        │       │               │       │            # defaults:                                                                                                                                                                                                                   
  1219 │       │       │       │        │       │               │       │            method = Quantize.MEDIANCUT                                                                                                                                                                                                   
  1220 │       │       │       │        │       │               │       │            if self.mode == "RGBA":                                                                                                                                                                                                       
  1221 │       │       │       │        │       │               │       │                method = Quantize.FASTOCTREE                                                                                                                                                                                              
  1222 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1223 │       │       │       │        │       │               │       │        if self.mode == "RGBA" and method not in (                                                                                                                                                                                        
  1224 │       │       │       │        │       │               │       │            Quantize.FASTOCTREE,                                                                                                                                                                                                          
  1225 │       │       │       │        │       │               │       │            Quantize.LIBIMAGEQUANT,                                                                                                                                                                                                       
  1226 │       │       │       │        │       │               │       │        ):                                                                                                                                                                                                                                
  1227 │       │       │       │        │       │               │       │            # Caller specified an invalid mode.                                                                                                                                                                                           
  1228 │       │       │       │        │       │               │       │            msg = (                                                                                                                                                                                                                       
  1229 │       │       │       │        │       │               │       │                "Fast Octree (method == 2) and libimagequant (method == 3) "                                                                                                                                                              
  1230 │       │       │       │        │       │               │       │                "are the only valid methods for quantizing RGBA images"                                                                                                                                                                   
  1231 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  1232 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  1233 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1234 │       │       │       │        │       │               │       │        if palette:                                                                                                                                                                                                                       
  1235 │       │       │       │        │       │               │       │            # use palette from reference image                                                                                                                                                                                            
  1236 │       │       │       │        │       │               │       │            palette.load()                                                                                                                                                                                                                
  1237 │       │       │       │        │       │               │       │            if palette.mode != "P":                                                                                                                                                                                                       
  1238 │       │       │       │        │       │               │       │                msg = "bad mode for palette image"                                                                                                                                                                                        
  1239 │       │       │       │        │       │               │       │                raise ValueError(msg)                                                                                                                                                                                                     
  1240 │       │       │       │        │       │               │       │            if self.mode not in {"RGB", "L"}:                                                                                                                                                                                             
  1241 │       │       │       │        │       │               │       │                msg = "only RGB or L mode images can be quantized to a palette"                                                                                                                                                           
  1242 │       │       │       │        │       │               │       │                raise ValueError(msg)                                                                                                                                                                                                     
  1243 │       │       │       │        │       │               │       │            im = self.im.convert("P", dither, palette.im)                                                                                                                                                                                 
  1244 │       │       │       │        │       │               │       │            new_im = self._new(im)                                                                                                                                                                                                        
  1245 │       │       │       │        │       │               │       │            assert palette.palette is not None                                                                                                                                                                                            
  1246 │       │       │       │        │       │               │       │            new_im.palette = palette.palette.copy()                                                                                                                                                                                       
  1247 │       │       │       │        │       │               │       │            return new_im                                                                                                                                                                                                                 
  1248 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1249 │       │       │       │        │       │               │       │        if kmeans < 0:                                                                                                                                                                                                                    
  1250 │       │       │       │        │       │               │       │            msg = "kmeans must not be negative"                                                                                                                                                                                           
  1251 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  1252 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1253 │       │       │       │        │       │               │       │        im = self._new(self.im.quantize(colors, method, kmeans))                                                                                                                                                                          
  1254 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1255 │       │       │       │        │       │               │       │        from . import ImagePalette                                                                                                                                                                                                        
  1256 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1257 │       │       │       │        │       │               │       │        mode = im.im.getpalettemode()                                                                                                                                                                                                     
  1258 │       │       │       │        │       │               │       │        palette_data = im.im.getpalette(mode, mode)[: colors * len(mode)]                                                                                                                                                                 
  1259 │       │       │       │        │       │               │       │        im.palette = ImagePalette.ImagePalette(mode, palette_data)                                                                                                                                                                        
  1260 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1261 │       │       │       │        │       │               │       │        return im                                                                                                                                                                                                                         
  1262 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1263 │       │       │       │        │       │               │       │    def copy(self) -> Image:                                                                                                                                                                                                              
  1264 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1265 │       │       │       │        │       │               │       │        Copies this image. Use this method if you wish to paste things                                                                                                                                                                    
  1266 │       │       │       │        │       │               │       │        into an image, but still retain the original.                                                                                                                                                                                     
  1267 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1268 │       │       │       │        │       │               │       │        :rtype: :py:class:`~PIL.Image.Image`                                                                                                                                                                                              
  1269 │       │       │       │        │       │               │       │        :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                 
  1270 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1271 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1272 │       │       │       │        │       │               │       │        return self._new(self.im.copy())                                                                                                                                                                                                  
  1273 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1274 │       │       │       │        │       │               │       │    __copy__ = copy                                                                                                                                                                                                                       
  1275 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1276 │       │       │       │        │       │               │       │    def crop(self, box: tuple[float, float, float, float] | None = None) -> Image:                                                                                                                                                        
  1277 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1278 │       │       │       │        │       │               │       │        Returns a rectangular region from this image. The box is a                                                                                                                                                                        
  1279 │       │       │       │        │       │               │       │        4-tuple defining the left, upper, right, and lower pixel                                                                                                                                                                          
  1280 │       │       │       │        │       │               │       │        coordinate. See :ref:`coordinate-system`.                                                                                                                                                                                         
  1281 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1282 │       │       │       │        │       │               │       │        Note: Prior to Pillow 3.4.0, this was a lazy operation.                                                                                                                                                                           
  1283 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1284 │       │       │       │        │       │               │       │        :param box: The crop rectangle, as a (left, upper, right, lower)-tuple.                                                                                                                                                           
  1285 │       │       │       │        │       │               │       │        :rtype: :py:class:`~PIL.Image.Image`                                                                                                                                                                                              
  1286 │       │       │       │        │       │               │       │        :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                 
  1287 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1288 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1289 │       │       │       │        │       │               │       │        if box is None:                                                                                                                                                                                                                   
  1290 │       │       │       │        │       │               │       │            return self.copy()                                                                                                                                                                                                            
  1291 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1292 │       │       │       │        │       │               │       │        if box[2] < box[0]:                                                                                                                                                                                                               
  1293 │       │       │       │        │       │               │       │            msg = "Coordinate 'right' is less than 'left'"                                                                                                                                                                                
  1294 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  1295 │       │       │       │        │       │               │       │        elif box[3] < box[1]:                                                                                                                                                                                                             
  1296 │       │       │       │        │       │               │       │            msg = "Coordinate 'lower' is less than 'upper'"                                                                                                                                                                               
  1297 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  1298 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1299 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1300 │       │       │       │        │       │               │       │        return self._new(self._crop(self.im, box))                                                                                                                                                                                        
  1301 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1302 │       │       │       │        │       │               │       │    def _crop(                                                                                                                                                                                                                            
  1303 │       │       │       │        │       │               │       │        self, im: core.ImagingCore, box: tuple[float, float, float, float]                                                                                                                                                                
  1304 │       │       │       │        │       │               │       │    ) -> core.ImagingCore:                                                                                                                                                                                                                
  1305 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1306 │       │       │       │        │       │               │       │        Returns a rectangular region from the core image object im.                                                                                                                                                                       
  1307 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1308 │       │       │       │        │       │               │       │        This is equivalent to calling im.crop((x0, y0, x1, y1)), but                                                                                                                                                                      
  1309 │       │       │       │        │       │               │       │        includes additional sanity checks.                                                                                                                                                                                                
  1310 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1311 │       │       │       │        │       │               │       │        :param im: a core image object                                                                                                                                                                                                    
  1312 │       │       │       │        │       │               │       │        :param box: The crop rectangle, as a (left, upper, right, lower)-tuple.                                                                                                                                                           
  1313 │       │       │       │        │       │               │       │        :returns: A core image object.                                                                                                                                                                                                    
  1314 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1315 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1316 │       │       │       │        │       │               │       │        x0, y0, x1, y1 = map(int, map(round, box))                                                                                                                                                                                        
  1317 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1318 │       │       │       │        │       │               │       │        absolute_values = (abs(x1 - x0), abs(y1 - y0))                                                                                                                                                                                    
  1319 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1320 │       │       │       │        │       │               │       │        _decompression_bomb_check(absolute_values)                                                                                                                                                                                        
  1321 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1322 │       │       │       │        │       │               │       │        return im.crop((x0, y0, x1, y1))                                                                                                                                                                                                  
  1323 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1324 │       │       │       │        │       │               │       │    def draft(                                                                                                                                                                                                                            
  1325 │       │       │       │        │       │               │       │        self, mode: str | None, size: tuple[int, int] | None                                                                                                                                                                              
  1326 │       │       │       │        │       │               │       │    ) -> tuple[str, tuple[int, int, float, float]] | None:                                                                                                                                                                                
  1327 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1328 │       │       │       │        │       │               │       │        Configures the image file loader so it returns a version of the                                                                                                                                                                   
  1329 │       │       │       │        │       │               │       │        image that as closely as possible matches the given mode and                                                                                                                                                                      
  1330 │       │       │       │        │       │               │       │        size. For example, you can use this method to convert a color                                                                                                                                                                     
  1331 │       │       │       │        │       │               │       │        JPEG to grayscale while loading it.                                                                                                                                                                                               
  1332 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1333 │       │       │       │        │       │               │       │        If any changes are made, returns a tuple with the chosen ``mode`` and                                                                                                                                                             
  1334 │       │       │       │        │       │               │       │        ``box`` with coordinates of the original image within the altered one.                                                                                                                                                            
  1335 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1336 │       │       │       │        │       │               │       │        Note that this method modifies the :py:class:`~PIL.Image.Image` object                                                                                                                                                            
  1337 │       │       │       │        │       │               │       │        in place. If the image has already been loaded, this method has no                                                                                                                                                                
  1338 │       │       │       │        │       │               │       │        effect.                                                                                                                                                                                                                           
  1339 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1340 │       │       │       │        │       │               │       │        Note: This method is not implemented for most images. It is                                                                                                                                                                       
  1341 │       │       │       │        │       │               │       │        currently implemented only for JPEG and MPO images.                                                                                                                                                                               
  1342 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1343 │       │       │       │        │       │               │       │        :param mode: The requested mode.                                                                                                                                                                                                  
  1344 │       │       │       │        │       │               │       │        :param size: The requested size in pixels, as a 2-tuple:                                                                                                                                                                          
  1345 │       │       │       │        │       │               │       │           (width, height).                                                                                                                                                                                                               
  1346 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1347 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
  1348 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1349 │       │       │       │        │       │               │       │    def _expand(self, xmargin: int, ymargin: int | None = None) -> Image:                                                                                                                                                                 
  1350 │       │       │       │        │       │               │       │        if ymargin is None:                                                                                                                                                                                                               
  1351 │       │       │       │        │       │               │       │            ymargin = xmargin                                                                                                                                                                                                             
  1352 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1353 │       │       │       │        │       │               │       │        return self._new(self.im.expand(xmargin, ymargin))                                                                                                                                                                                
  1354 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1355 │       │       │       │        │       │               │       │    def filter(self, filter: ImageFilter.Filter | type[ImageFilter.Filter]) -> Image:                                                                                                                                                     
  1356 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1357 │       │       │       │        │       │               │       │        Filters this image using the given filter.  For a list of                                                                                                                                                                         
  1358 │       │       │       │        │       │               │       │        available filters, see the :py:mod:`~PIL.ImageFilter` module.                                                                                                                                                                     
  1359 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1360 │       │       │       │        │       │               │       │        :param filter: Filter kernel.                                                                                                                                                                                                     
  1361 │       │       │       │        │       │               │       │        :returns: An :py:class:`~PIL.Image.Image` object."""                                                                                                                                                                              
  1362 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1363 │       │       │       │        │       │               │       │        from . import ImageFilter                                                                                                                                                                                                         
  1364 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1365 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1366 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1367 │       │       │       │        │       │               │       │        if callable(filter):                                                                                                                                                                                                              
  1368 │       │       │       │        │       │               │       │            filter = filter()                                                                                                                                                                                                             
  1369 │       │       │       │        │       │               │       │        if not hasattr(filter, "filter"):                                                                                                                                                                                                 
  1370 │       │       │       │        │       │               │       │            msg = "filter argument should be ImageFilter.Filter instance or class"                                                                                                                                                        
  1371 │       │       │       │        │       │               │       │            raise TypeError(msg)                                                                                                                                                                                                          
  1372 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1373 │       │       │       │        │       │               │       │        multiband = isinstance(filter, ImageFilter.MultibandFilter)                                                                                                                                                                       
  1374 │       │       │       │        │       │               │       │        if self.im.bands == 1 or multiband:                                                                                                                                                                                               
  1375 │       │       │       │        │       │               │       │            return self._new(filter.filter(self.im))                                                                                                                                                                                      
  1376 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1377 │       │       │       │        │       │               │       │        ims = [                                                                                                                                                                                                                           
  1378 │       │       │       │        │       │               │       │            self._new(filter.filter(self.im.getband(c))) for c in range(self.im.bands)                                                                                                                                                    
  1379 │       │       │       │        │       │               │       │        ]                                                                                                                                                                                                                                 
  1380 │       │       │       │        │       │               │       │        return merge(self.mode, ims)                                                                                                                                                                                                      
  1381 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1382 │       │       │       │        │       │               │       │    def getbands(self) -> tuple[str, ...]:                                                                                                                                                                                                
  1383 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1384 │       │       │       │        │       │               │       │        Returns a tuple containing the name of each band in this image.                                                                                                                                                                   
  1385 │       │       │       │        │       │               │       │        For example, ``getbands`` on an RGB image returns ("R", "G", "B").                                                                                                                                                                
  1386 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1387 │       │       │       │        │       │               │       │        :returns: A tuple containing band names.                                                                                                                                                                                          
  1388 │       │       │       │        │       │               │       │        :rtype: tuple                                                                                                                                                                                                                     
  1389 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1390 │       │       │       │        │       │               │       │        return ImageMode.getmode(self.mode).bands                                                                                                                                                                                         
  1391 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1392 │       │       │       │        │       │               │       │    def getbbox(self, *, alpha_only: bool = True) -> tuple[int, int, int, int] | None:                                                                                                                                                    
  1393 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1394 │       │       │       │        │       │               │       │        Calculates the bounding box of the non-zero regions in the                                                                                                                                                                        
  1395 │       │       │       │        │       │               │       │        image.                                                                                                                                                                                                                            
  1396 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1397 │       │       │       │        │       │               │       │        :param alpha_only: Optional flag, defaulting to ``True``.                                                                                                                                                                         
  1398 │       │       │       │        │       │               │       │           If ``True`` and the image has an alpha channel, trim transparent pixels.                                                                                                                                                       
  1399 │       │       │       │        │       │               │       │           Otherwise, trim pixels when all channels are zero.                                                                                                                                                                             
  1400 │       │       │       │        │       │               │       │           Keyword-only argument.                                                                                                                                                                                                         
  1401 │       │       │       │        │       │               │       │        :returns: The bounding box is returned as a 4-tuple defining the                                                                                                                                                                  
  1402 │       │       │       │        │       │               │       │           left, upper, right, and lower pixel coordinate. See                                                                                                                                                                            
  1403 │       │       │       │        │       │               │       │           :ref:`coordinate-system`. If the image is completely empty, this                                                                                                                                                               
  1404 │       │       │       │        │       │               │       │           method returns None.                                                                                                                                                                                                           
  1405 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1406 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1407 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1408 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1409 │       │       │       │        │       │               │       │        return self.im.getbbox(alpha_only)                                                                                                                                                                                                
  1410 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1411 │       │       │       │        │       │               │       │    def getcolors(                                                                                                                                                                                                                        
  1412 │       │       │       │        │       │               │       │        self, maxcolors: int = 256                                                                                                                                                                                                        
  1413 │       │       │       │        │       │               │       │    ) -> list[tuple[int, tuple[int, ...]]] | list[tuple[int, float]] | None:                                                                                                                                                              
  1414 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1415 │       │       │       │        │       │               │       │        Returns a list of colors used in this image.                                                                                                                                                                                      
  1416 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1417 │       │       │       │        │       │               │       │        The colors will be in the image's mode. For example, an RGB image will                                                                                                                                                            
  1418 │       │       │       │        │       │               │       │        return a tuple of (red, green, blue) color values, and a P image will                                                                                                                                                             
  1419 │       │       │       │        │       │               │       │        return the index of the color in the palette.                                                                                                                                                                                     
  1420 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1421 │       │       │       │        │       │               │       │        :param maxcolors: Maximum number of colors.  If this number is                                                                                                                                                                    
  1422 │       │       │       │        │       │               │       │           exceeded, this method returns None.  The default limit is                                                                                                                                                                      
  1423 │       │       │       │        │       │               │       │           256 colors.                                                                                                                                                                                                                    
  1424 │       │       │       │        │       │               │       │        :returns: An unsorted list of (count, pixel) values.                                                                                                                                                                              
  1425 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1426 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1427 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1428 │       │       │       │        │       │               │       │        if self.mode in ("1", "L", "P"):                                                                                                                                                                                                  
  1429 │       │       │       │        │       │               │       │            h = self.im.histogram()                                                                                                                                                                                                       
  1430 │       │       │       │        │       │               │       │            out: list[tuple[int, float]] = [(h[i], i) for i in range(256) if h[i]]                                                                                                                                                        
  1431 │       │       │       │        │       │               │       │            if len(out) > maxcolors:                                                                                                                                                                                                      
  1432 │       │       │       │        │       │               │       │                return None                                                                                                                                                                                                               
  1433 │       │       │       │        │       │               │       │            return out                                                                                                                                                                                                                    
  1434 │       │       │       │        │       │               │       │        return self.im.getcolors(maxcolors)                                                                                                                                                                                               
  1435 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1436 │       │       │       │        │       │               │       │    def getdata(self, band: int | None = None) -> core.ImagingCore:                                                                                                                                                                       
  1437 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1438 │       │       │       │        │       │               │       │        Returns the contents of this image as a sequence object                                                                                                                                                                           
  1439 │       │       │       │        │       │               │       │        containing pixel values.  The sequence object is flattened, so                                                                                                                                                                    
  1440 │       │       │       │        │       │               │       │        that values for line one follow directly after the values of                                                                                                                                                                      
  1441 │       │       │       │        │       │               │       │        line zero, and so on.                                                                                                                                                                                                             
  1442 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1443 │       │       │       │        │       │               │       │        Note that the sequence object returned by this method is an                                                                                                                                                                       
  1444 │       │       │       │        │       │               │       │        internal PIL data type, which only supports certain sequence                                                                                                                                                                      
  1445 │       │       │       │        │       │               │       │        operations.  To convert it to an ordinary sequence (e.g. for                                                                                                                                                                      
  1446 │       │       │       │        │       │               │       │        printing), use ``list(im.getdata())``.                                                                                                                                                                                            
  1447 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1448 │       │       │       │        │       │               │       │        :param band: What band to return.  The default is to return                                                                                                                                                                       
  1449 │       │       │       │        │       │               │       │           all bands.  To return a single band, pass in the index                                                                                                                                                                         
  1450 │       │       │       │        │       │               │       │           value (e.g. 0 to get the "R" band from an "RGB" image).                                                                                                                                                                        
  1451 │       │       │       │        │       │               │       │        :returns: A sequence-like object.                                                                                                                                                                                                 
  1452 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1453 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1454 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1455 │       │       │       │        │       │               │       │        if band is not None:                                                                                                                                                                                                              
  1456 │       │       │       │        │       │               │       │            return self.im.getband(band)                                                                                                                                                                                                  
  1457 │       │       │       │        │       │               │       │        return self.im  # could be abused                                                                                                                                                                                                 
  1458 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1459 │       │       │       │        │       │               │       │    def getextrema(self) -> tuple[float, float] | tuple[tuple[int, int], ...]:                                                                                                                                                            
  1460 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1461 │       │       │       │        │       │               │       │        Gets the minimum and maximum pixel values for each band in                                                                                                                                                                        
  1462 │       │       │       │        │       │               │       │        the image.                                                                                                                                                                                                                        
  1463 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1464 │       │       │       │        │       │               │       │        :returns: For a single-band image, a 2-tuple containing the                                                                                                                                                                       
  1465 │       │       │       │        │       │               │       │           minimum and maximum pixel value.  For a multi-band image,                                                                                                                                                                      
  1466 │       │       │       │        │       │               │       │           a tuple containing one 2-tuple for each band.                                                                                                                                                                                  
  1467 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1468 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1469 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1470 │       │       │       │        │       │               │       │        if self.im.bands > 1:                                                                                                                                                                                                             
  1471 │       │       │       │        │       │               │       │            return tuple(self.im.getband(i).getextrema() for i in range(self.im.bands))                                                                                                                                                   
  1472 │       │       │       │        │       │               │       │        return self.im.getextrema()                                                                                                                                                                                                       
  1473 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1474 │       │       │       │        │       │               │       │    def getxmp(self) -> dict[str, Any]:                                                                                                                                                                                                   
  1475 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1476 │       │       │       │        │       │               │       │        Returns a dictionary containing the XMP tags.                                                                                                                                                                                     
  1477 │       │       │       │        │       │               │       │        Requires defusedxml to be installed.                                                                                                                                                                                              
  1478 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1479 │       │       │       │        │       │               │       │        :returns: XMP tags in a dictionary.                                                                                                                                                                                               
  1480 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1481 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1482 │       │       │       │        │       │               │       │        def get_name(tag: str) -> str:                                                                                                                                                                                                    
  1483 │       │       │       │        │       │               │       │            return re.sub("^{[^}]+}", "", tag)                                                                                                                                                                                            
  1484 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1485 │       │       │       │        │       │               │       │        def get_value(element: Element) -> str | dict[str, Any] | None:                                                                                                                                                                   
  1486 │       │       │       │        │       │               │       │            value: dict[str, Any] = {get_name(k): v for k, v in element.attrib.items()}                                                                                                                                                   
  1487 │       │       │       │        │       │               │       │            children = list(element)                                                                                                                                                                                                      
  1488 │       │       │       │        │       │               │       │            if children:                                                                                                                                                                                                                  
  1489 │       │       │       │        │       │               │       │                for child in children:                                                                                                                                                                                                    
  1490 │       │       │       │        │       │               │       │                    name = get_name(child.tag)                                                                                                                                                                                            
  1491 │       │       │       │        │       │               │       │                    child_value = get_value(child)                                                                                                                                                                                        
  1492 │       │       │       │        │       │               │       │                    if name in value:                                                                                                                                                                                                     
  1493 │       │       │       │        │       │               │       │                        if not isinstance(value[name], list):                                                                                                                                                                             
  1494 │       │       │       │        │       │               │       │                            value[name] = [value[name]]                                                                                                                                                                                   
  1495 │       │       │       │        │       │               │       │                        value[name].append(child_value)                                                                                                                                                                                   
  1496 │       │       │       │        │       │               │       │                    else:                                                                                                                                                                                                                 
  1497 │       │       │       │        │       │               │       │                        value[name] = child_value                                                                                                                                                                                         
  1498 │       │       │       │        │       │               │       │            elif value:                                                                                                                                                                                                                   
  1499 │       │       │       │        │       │               │       │                if element.text:                                                                                                                                                                                                          
  1500 │       │       │       │        │       │               │       │                    value["text"] = element.text                                                                                                                                                                                          
  1501 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  1502 │       │       │       │        │       │               │       │                return element.text                                                                                                                                                                                                       
  1503 │       │       │       │        │       │               │       │            return value                                                                                                                                                                                                                  
  1504 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1505 │       │       │       │        │       │               │       │        if ElementTree is None:                                                                                                                                                                                                           
  1506 │       │       │       │        │       │               │       │            warnings.warn("XMP data cannot be read without defusedxml dependency")                                                                                                                                                        
  1507 │       │       │       │        │       │               │       │            return {}                                                                                                                                                                                                                     
  1508 │       │       │       │        │       │               │       │        if "xmp" not in self.info:                                                                                                                                                                                                        
  1509 │       │       │       │        │       │               │       │            return {}                                                                                                                                                                                                                     
  1510 │       │       │       │        │       │               │       │        root = ElementTree.fromstring(self.info["xmp"].rstrip(b"\x00"))                                                                                                                                                                   
  1511 │       │       │       │        │       │               │       │        return {get_name(root.tag): get_value(root)}                                                                                                                                                                                      
  1512 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1513 │       │       │       │        │       │               │       │    def getexif(self) -> Exif:                                                                                                                                                                                                            
  1514 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1515 │       │       │       │        │       │               │       │        Gets EXIF data from the image.                                                                                                                                                                                                    
  1516 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1517 │       │       │       │        │       │               │       │        :returns: an :py:class:`~PIL.Image.Exif` object.                                                                                                                                                                                  
  1518 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1519 │       │       │       │        │       │               │       │        if self._exif is None:                                                                                                                                                                                                            
  1520 │       │       │       │        │       │               │       │            self._exif = Exif()                                                                                                                                                                                                           
  1521 │       │       │       │        │       │               │       │        elif self._exif._loaded:                                                                                                                                                                                                          
  1522 │       │       │       │        │       │               │       │            return self._exif                                                                                                                                                                                                             
  1523 │       │       │       │        │       │               │       │        self._exif._loaded = True                                                                                                                                                                                                         
  1524 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1525 │       │       │       │        │       │               │       │        exif_info = self.info.get("exif")                                                                                                                                                                                                 
  1526 │       │       │       │        │       │               │       │        if exif_info is None:                                                                                                                                                                                                             
  1527 │       │       │       │        │       │               │       │            if "Raw profile type exif" in self.info:                                                                                                                                                                                      
  1528 │       │       │       │        │       │               │       │                exif_info = bytes.fromhex(                                                                                                                                                                                                
  1529 │       │       │       │        │       │               │       │                    "".join(self.info["Raw profile type exif"].split("\n")[3:])                                                                                                                                                           
  1530 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  1531 │       │       │       │        │       │               │       │            elif hasattr(self, "tag_v2"):                                                                                                                                                                                                 
  1532 │       │       │       │        │       │               │       │                self._exif.bigtiff = self.tag_v2._bigtiff                                                                                                                                                                                 
  1533 │       │       │       │        │       │               │       │                self._exif.endian = self.tag_v2._endian                                                                                                                                                                                   
  1534 │       │       │       │        │       │               │       │                self._exif.load_from_fp(self.fp, self.tag_v2._offset)                                                                                                                                                                     
  1535 │       │       │       │        │       │               │       │        if exif_info is not None:                                                                                                                                                                                                         
  1536 │       │       │       │        │       │               │       │            self._exif.load(exif_info)                                                                                                                                                                                                    
  1537 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1538 │       │       │       │        │       │               │       │        # XMP tags                                                                                                                                                                                                                        
  1539 │       │       │       │        │       │               │       │        if ExifTags.Base.Orientation not in self._exif:                                                                                                                                                                                   
  1540 │       │       │       │        │       │               │       │            xmp_tags = self.info.get("XML:com.adobe.xmp")                                                                                                                                                                                 
  1541 │       │       │       │        │       │               │       │            if not xmp_tags and (xmp_tags := self.info.get("xmp")):                                                                                                                                                                       
  1542 │       │       │       │        │       │               │       │                xmp_tags = xmp_tags.decode("utf-8")                                                                                                                                                                                       
  1543 │       │       │       │        │       │               │       │            if xmp_tags:                                                                                                                                                                                                                  
  1544 │       │       │       │        │       │               │       │                match = re.search(r'tiff:Orientation(="|>)([0-9])', xmp_tags)                                                                                                                                                             
  1545 │       │       │       │        │       │               │       │                if match:                                                                                                                                                                                                                 
  1546 │       │       │       │        │       │               │       │                    self._exif[ExifTags.Base.Orientation] = int(match[2])                                                                                                                                                                 
  1547 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1548 │       │       │       │        │       │               │       │        return self._exif                                                                                                                                                                                                                 
  1549 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1550 │       │       │       │        │       │               │       │    def _reload_exif(self) -> None:                                                                                                                                                                                                       
  1551 │       │       │       │        │       │               │       │        if self._exif is None or not self._exif._loaded:                                                                                                                                                                                  
  1552 │       │       │       │        │       │               │       │            return                                                                                                                                                                                                                        
  1553 │       │       │       │        │       │               │       │        self._exif._loaded = False                                                                                                                                                                                                        
  1554 │       │       │       │        │       │               │       │        self.getexif()                                                                                                                                                                                                                    
  1555 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1556 │       │       │       │        │       │               │       │    def get_child_images(self) -> list[ImageFile.ImageFile]:                                                                                                                                                                              
  1557 │       │       │       │        │       │               │       │        from . import ImageFile                                                                                                                                                                                                           
  1558 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1559 │       │       │       │        │       │               │       │        deprecate("Image.Image.get_child_images", 13)                                                                                                                                                                                     
  1560 │       │       │       │        │       │               │       │        return ImageFile.ImageFile.get_child_images(self)  # type: ignore[arg-type]                                                                                                                                                       
  1561 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1562 │       │       │       │        │       │               │       │    def getim(self) -> CapsuleType:                                                                                                                                                                                                       
  1563 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1564 │       │       │       │        │       │               │       │        Returns a capsule that points to the internal image memory.                                                                                                                                                                       
  1565 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1566 │       │       │       │        │       │               │       │        :returns: A capsule object.                                                                                                                                                                                                       
  1567 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1568 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1569 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1570 │       │       │       │        │       │               │       │        return self.im.ptr                                                                                                                                                                                                                
  1571 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1572 │       │       │       │        │       │               │       │    def getpalette(self, rawmode: str | None = "RGB") -> list[int] | None:                                                                                                                                                                
  1573 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1574 │       │       │       │        │       │               │       │        Returns the image palette as a list.                                                                                                                                                                                              
  1575 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1576 │       │       │       │        │       │               │       │        :param rawmode: The mode in which to return the palette. ``None`` will                                                                                                                                                            
  1577 │       │       │       │        │       │               │       │           return the palette in its current mode.                                                                                                                                                                                        
  1578 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1579 │       │       │       │        │       │               │       │           .. versionadded:: 9.1.0                                                                                                                                                                                                        
  1580 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1581 │       │       │       │        │       │               │       │        :returns: A list of color values [r, g, b, ...], or None if the                                                                                                                                                                   
  1582 │       │       │       │        │       │               │       │           image has no palette.                                                                                                                                                                                                          
  1583 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1584 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1585 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1586 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  1587 │       │       │       │        │       │               │       │            mode = self.im.getpalettemode()                                                                                                                                                                                               
  1588 │       │       │       │        │       │               │       │        except ValueError:                                                                                                                                                                                                                
  1589 │       │       │       │        │       │               │       │            return None  # no palette                                                                                                                                                                                                     
  1590 │       │       │       │        │       │               │       │        if rawmode is None:                                                                                                                                                                                                               
  1591 │       │       │       │        │       │               │       │            rawmode = mode                                                                                                                                                                                                                
  1592 │       │       │       │        │       │               │       │        return list(self.im.getpalette(mode, rawmode))                                                                                                                                                                                    
  1593 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1594 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
  1595 │       │       │       │        │       │               │       │    def has_transparency_data(self) -> bool:                                                                                                                                                                                              
  1596 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1597 │       │       │       │        │       │               │       │        Determine if an image has transparency data, whether in the form of an                                                                                                                                                            
  1598 │       │       │       │        │       │               │       │        alpha channel, a palette with an alpha channel, or a "transparency" key                                                                                                                                                           
  1599 │       │       │       │        │       │               │       │        in the info dictionary.                                                                                                                                                                                                           
  1600 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1601 │       │       │       │        │       │               │       │        Note the image might still appear solid, if all of the values shown                                                                                                                                                               
  1602 │       │       │       │        │       │               │       │        within are opaque.                                                                                                                                                                                                                
  1603 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1604 │       │       │       │        │       │               │       │        :returns: A boolean.                                                                                                                                                                                                              
  1605 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1606 │       │       │       │        │       │               │       │        if (                                                                                                                                                                                                                              
  1607 │       │       │       │        │       │               │       │            self.mode in ("LA", "La", "PA", "RGBA", "RGBa")                                                                                                                                                                               
  1608 │       │       │       │        │       │               │       │            or "transparency" in self.info                                                                                                                                                                                                
  1609 │       │       │       │        │       │               │       │        ):                                                                                                                                                                                                                                
  1610 │       │       │       │        │       │               │       │            return True                                                                                                                                                                                                                   
  1611 │       │       │       │        │       │               │       │        if self.mode == "P":                                                                                                                                                                                                              
  1612 │       │       │       │        │       │               │       │            assert self.palette is not None                                                                                                                                                                                               
  1613 │       │       │       │        │       │               │       │            return self.palette.mode.endswith("A")                                                                                                                                                                                        
  1614 │       │       │       │        │       │               │       │        return False                                                                                                                                                                                                                      
  1615 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1616 │       │       │       │        │       │               │       │    def apply_transparency(self) -> None:                                                                                                                                                                                                 
  1617 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1618 │       │       │       │        │       │               │       │        If a P mode image has a "transparency" key in the info dictionary,                                                                                                                                                                
  1619 │       │       │       │        │       │               │       │        remove the key and instead apply the transparency to the palette.                                                                                                                                                                 
  1620 │       │       │       │        │       │               │       │        Otherwise, the image is unchanged.                                                                                                                                                                                                
  1621 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1622 │       │       │       │        │       │               │       │        if self.mode != "P" or "transparency" not in self.info:                                                                                                                                                                           
  1623 │       │       │       │        │       │               │       │            return                                                                                                                                                                                                                        
  1624 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1625 │       │       │       │        │       │               │       │        from . import ImagePalette                                                                                                                                                                                                        
  1626 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1627 │       │       │       │        │       │               │       │        palette = self.getpalette("RGBA")                                                                                                                                                                                                 
  1628 │       │       │       │        │       │               │       │        assert palette is not None                                                                                                                                                                                                        
  1629 │       │       │       │        │       │               │       │        transparency = self.info["transparency"]                                                                                                                                                                                          
  1630 │       │       │       │        │       │               │       │        if isinstance(transparency, bytes):                                                                                                                                                                                               
  1631 │       │       │       │        │       │               │       │            for i, alpha in enumerate(transparency):                                                                                                                                                                                      
  1632 │       │       │       │        │       │               │       │                palette[i * 4 + 3] = alpha                                                                                                                                                                                                
  1633 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1634 │       │       │       │        │       │               │       │            palette[transparency * 4 + 3] = 0                                                                                                                                                                                             
  1635 │       │       │       │        │       │               │       │        self.palette = ImagePalette.ImagePalette("RGBA", bytes(palette))                                                                                                                                                                  
  1636 │       │       │       │        │       │               │       │        self.palette.dirty = 1                                                                                                                                                                                                            
  1637 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1638 │       │       │       │        │       │               │       │        del self.info["transparency"]                                                                                                                                                                                                     
  1639 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1640 │       │       │       │        │       │               │       │    def getpixel(                                                                                                                                                                                                                         
  1641 │       │       │       │        │       │               │       │        self, xy: tuple[int, int] | list[int]                                                                                                                                                                                             
  1642 │       │       │       │        │       │               │       │    ) -> float | tuple[int, ...] | None:                                                                                                                                                                                                  
  1643 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1644 │       │       │       │        │       │               │       │        Returns the pixel value at a given position.                                                                                                                                                                                      
  1645 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1646 │       │       │       │        │       │               │       │        :param xy: The coordinate, given as (x, y). See                                                                                                                                                                                   
  1647 │       │       │       │        │       │               │       │           :ref:`coordinate-system`.                                                                                                                                                                                                      
  1648 │       │       │       │        │       │               │       │        :returns: The pixel value.  If the image is a multi-layer image,                                                                                                                                                                  
  1649 │       │       │       │        │       │               │       │           this method returns a tuple.                                                                                                                                                                                                   
  1650 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1651 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1652 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1653 │       │       │       │        │       │               │       │        return self.im.getpixel(tuple(xy))                                                                                                                                                                                                
  1654 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1655 │       │       │       │        │       │               │       │    def getprojection(self) -> tuple[list[int], list[int]]:                                                                                                                                                                               
  1656 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1657 │       │       │       │        │       │               │       │        Get projection to x and y axes                                                                                                                                                                                                    
  1658 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1659 │       │       │       │        │       │               │       │        :returns: Two sequences, indicating where there are non-zero                                                                                                                                                                      
  1660 │       │       │       │        │       │               │       │            pixels along the X-axis and the Y-axis, respectively.                                                                                                                                                                         
  1661 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1662 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1663 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1664 │       │       │       │        │       │               │       │        x, y = self.im.getprojection()                                                                                                                                                                                                    
  1665 │       │       │       │        │       │               │       │        return list(x), list(y)                                                                                                                                                                                                           
  1666 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1667 │       │       │       │        │       │               │       │    def histogram(                                                                                                                                                                                                                        
  1668 │       │       │       │        │       │               │       │        self, mask: Image | None = None, extrema: tuple[float, float] | None = None                                                                                                                                                       
  1669 │       │       │       │        │       │               │       │    ) -> list[int]:                                                                                                                                                                                                                       
  1670 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1671 │       │       │       │        │       │               │       │        Returns a histogram for the image. The histogram is returned as a                                                                                                                                                                 
  1672 │       │       │       │        │       │               │       │        list of pixel counts, one for each pixel value in the source                                                                                                                                                                      
  1673 │       │       │       │        │       │               │       │        image. Counts are grouped into 256 bins for each band, even if                                                                                                                                                                    
  1674 │       │       │       │        │       │               │       │        the image has more than 8 bits per band. If the image has more                                                                                                                                                                    
  1675 │       │       │       │        │       │               │       │        than one band, the histograms for all bands are concatenated (for                                                                                                                                                                 
  1676 │       │       │       │        │       │               │       │        example, the histogram for an "RGB" image contains 768 values).                                                                                                                                                                   
  1677 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1678 │       │       │       │        │       │               │       │        A bilevel image (mode "1") is treated as a grayscale ("L") image                                                                                                                                                                  
  1679 │       │       │       │        │       │               │       │        by this method.                                                                                                                                                                                                                   
  1680 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1681 │       │       │       │        │       │               │       │        If a mask is provided, the method returns a histogram for those                                                                                                                                                                   
  1682 │       │       │       │        │       │               │       │        parts of the image where the mask image is non-zero. The mask                                                                                                                                                                     
  1683 │       │       │       │        │       │               │       │        image must have the same size as the image, and be either a                                                                                                                                                                       
  1684 │       │       │       │        │       │               │       │        bi-level image (mode "1") or a grayscale image ("L").                                                                                                                                                                             
  1685 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1686 │       │       │       │        │       │               │       │        :param mask: An optional mask.                                                                                                                                                                                                    
  1687 │       │       │       │        │       │               │       │        :param extrema: An optional tuple of manually-specified extrema.                                                                                                                                                                  
  1688 │       │       │       │        │       │               │       │        :returns: A list containing pixel counts.                                                                                                                                                                                         
  1689 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1690 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1691 │       │       │       │        │       │               │       │        if mask:                                                                                                                                                                                                                          
  1692 │       │       │       │        │       │               │       │            mask.load()                                                                                                                                                                                                                   
  1693 │       │       │       │        │       │               │       │            return self.im.histogram((0, 0), mask.im)                                                                                                                                                                                     
  1694 │       │       │       │        │       │               │       │        if self.mode in ("I", "F"):                                                                                                                                                                                                       
  1695 │       │       │       │        │       │               │       │            return self.im.histogram(                                                                                                                                                                                                     
  1696 │       │       │       │        │       │               │       │                extrema if extrema is not None else self.getextrema()                                                                                                                                                                     
  1697 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  1698 │       │       │       │        │       │               │       │        return self.im.histogram()                                                                                                                                                                                                        
  1699 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1700 │       │       │       │        │       │               │       │    def entropy(                                                                                                                                                                                                                          
  1701 │       │       │       │        │       │               │       │        self, mask: Image | None = None, extrema: tuple[float, float] | None = None                                                                                                                                                       
  1702 │       │       │       │        │       │               │       │    ) -> float:                                                                                                                                                                                                                           
  1703 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1704 │       │       │       │        │       │               │       │        Calculates and returns the entropy for the image.                                                                                                                                                                                 
  1705 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1706 │       │       │       │        │       │               │       │        A bilevel image (mode "1") is treated as a grayscale ("L")                                                                                                                                                                        
  1707 │       │       │       │        │       │               │       │        image by this method.                                                                                                                                                                                                             
  1708 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1709 │       │       │       │        │       │               │       │        If a mask is provided, the method employs the histogram for                                                                                                                                                                       
  1710 │       │       │       │        │       │               │       │        those parts of the image where the mask image is non-zero.                                                                                                                                                                        
  1711 │       │       │       │        │       │               │       │        The mask image must have the same size as the image, and be                                                                                                                                                                       
  1712 │       │       │       │        │       │               │       │        either a bi-level image (mode "1") or a grayscale image ("L").                                                                                                                                                                    
  1713 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1714 │       │       │       │        │       │               │       │        :param mask: An optional mask.                                                                                                                                                                                                    
  1715 │       │       │       │        │       │               │       │        :param extrema: An optional tuple of manually-specified extrema.                                                                                                                                                                  
  1716 │       │       │       │        │       │               │       │        :returns: A float value representing the image entropy                                                                                                                                                                            
  1717 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1718 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1719 │       │       │       │        │       │               │       │        if mask:                                                                                                                                                                                                                          
  1720 │       │       │       │        │       │               │       │            mask.load()                                                                                                                                                                                                                   
  1721 │       │       │       │        │       │               │       │            return self.im.entropy((0, 0), mask.im)                                                                                                                                                                                       
  1722 │       │       │       │        │       │               │       │        if self.mode in ("I", "F"):                                                                                                                                                                                                       
  1723 │       │       │       │        │       │               │       │            return self.im.entropy(                                                                                                                                                                                                       
  1724 │       │       │       │        │       │               │       │                extrema if extrema is not None else self.getextrema()                                                                                                                                                                     
  1725 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  1726 │       │       │       │        │       │               │       │        return self.im.entropy()                                                                                                                                                                                                          
  1727 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1728 │       │       │       │        │       │               │       │    def paste(                                                                                                                                                                                                                            
  1729 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  1730 │       │       │       │        │       │               │       │        im: Image | str | float | tuple[float, ...],                                                                                                                                                                                      
  1731 │       │       │       │        │       │               │       │        box: Image | tuple[int, int, int, int] | tuple[int, int] | None = None,                                                                                                                                                           
  1732 │       │       │       │        │       │               │       │        mask: Image | None = None,                                                                                                                                                                                                        
  1733 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
  1734 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1735 │       │       │       │        │       │               │       │        Pastes another image into this image. The box argument is either                                                                                                                                                                  
  1736 │       │       │       │        │       │               │       │        a 2-tuple giving the upper left corner, a 4-tuple defining the                                                                                                                                                                    
  1737 │       │       │       │        │       │               │       │        left, upper, right, and lower pixel coordinate, or None (same as                                                                                                                                                                  
  1738 │       │       │       │        │       │               │       │        (0, 0)). See :ref:`coordinate-system`. If a 4-tuple is given, the size                                                                                                                                                            
  1739 │       │       │       │        │       │               │       │        of the pasted image must match the size of the region.                                                                                                                                                                            
  1740 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1741 │       │       │       │        │       │               │       │        If the modes don't match, the pasted image is converted to the mode of                                                                                                                                                            
  1742 │       │       │       │        │       │               │       │        this image (see the :py:meth:`~PIL.Image.Image.convert` method for                                                                                                                                                                
  1743 │       │       │       │        │       │               │       │        details).                                                                                                                                                                                                                         
  1744 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1745 │       │       │       │        │       │               │       │        Instead of an image, the source can be a integer or tuple                                                                                                                                                                         
  1746 │       │       │       │        │       │               │       │        containing pixel values.  The method then fills the region                                                                                                                                                                        
  1747 │       │       │       │        │       │               │       │        with the given color.  When creating RGB images, you can                                                                                                                                                                          
  1748 │       │       │       │        │       │               │       │        also use color strings as supported by the ImageColor module.                                                                                                                                                                     
  1749 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1750 │       │       │       │        │       │               │       │        If a mask is given, this method updates only the regions                                                                                                                                                                          
  1751 │       │       │       │        │       │               │       │        indicated by the mask. You can use either "1", "L", "LA", "RGBA"                                                                                                                                                                  
  1752 │       │       │       │        │       │               │       │        or "RGBa" images (if present, the alpha band is used as mask).                                                                                                                                                                    
  1753 │       │       │       │        │       │               │       │        Where the mask is 255, the given image is copied as is.  Where                                                                                                                                                                    
  1754 │       │       │       │        │       │               │       │        the mask is 0, the current value is preserved.  Intermediate                                                                                                                                                                      
  1755 │       │       │       │        │       │               │       │        values will mix the two images together, including their alpha                                                                                                                                                                    
  1756 │       │       │       │        │       │               │       │        channels if they have them.                                                                                                                                                                                                       
  1757 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1758 │       │       │       │        │       │               │       │        See :py:meth:`~PIL.Image.Image.alpha_composite` if you want to                                                                                                                                                                    
  1759 │       │       │       │        │       │               │       │        combine images with respect to their alpha channels.                                                                                                                                                                              
  1760 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1761 │       │       │       │        │       │               │       │        :param im: Source image or pixel value (integer, float or tuple).                                                                                                                                                                 
  1762 │       │       │       │        │       │               │       │        :param box: An optional 4-tuple giving the region to paste into.                                                                                                                                                                  
  1763 │       │       │       │        │       │               │       │           If a 2-tuple is used instead, it's treated as the upper left                                                                                                                                                                   
  1764 │       │       │       │        │       │               │       │           corner.  If omitted or None, the source is pasted into the                                                                                                                                                                     
  1765 │       │       │       │        │       │               │       │           upper left corner.                                                                                                                                                                                                             
  1766 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1767 │       │       │       │        │       │               │       │           If an image is given as the second argument and there is no                                                                                                                                                                    
  1768 │       │       │       │        │       │               │       │           third, the box defaults to (0, 0), and the second argument                                                                                                                                                                     
  1769 │       │       │       │        │       │               │       │           is interpreted as a mask image.                                                                                                                                                                                                
  1770 │       │       │       │        │       │               │       │        :param mask: An optional mask image.                                                                                                                                                                                              
  1771 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1772 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1773 │       │       │       │        │       │               │       │        if isinstance(box, Image):                                                                                                                                                                                                        
  1774 │       │       │       │        │       │               │       │            if mask is not None:                                                                                                                                                                                                          
  1775 │       │       │       │        │       │               │       │                msg = "If using second argument as mask, third argument must be None"                                                                                                                                                     
  1776 │       │       │       │        │       │               │       │                raise ValueError(msg)                                                                                                                                                                                                     
  1777 │       │       │       │        │       │               │       │            # abbreviated paste(im, mask) syntax                                                                                                                                                                                          
  1778 │       │       │       │        │       │               │       │            mask = box                                                                                                                                                                                                                    
  1779 │       │       │       │        │       │               │       │            box = None                                                                                                                                                                                                                    
  1780 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1781 │       │       │       │        │       │               │       │        if box is None:                                                                                                                                                                                                                   
  1782 │       │       │       │        │       │               │       │            box = (0, 0)                                                                                                                                                                                                                  
  1783 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1784 │       │       │       │        │       │               │       │        if len(box) == 2:                                                                                                                                                                                                                 
  1785 │       │       │       │        │       │               │       │            # upper left corner given; get size from image or mask                                                                                                                                                                        
  1786 │       │       │       │        │       │               │       │            if isinstance(im, Image):                                                                                                                                                                                                     
  1787 │       │       │       │        │       │               │       │                size = im.size                                                                                                                                                                                                            
  1788 │       │       │       │        │       │               │       │            elif isinstance(mask, Image):                                                                                                                                                                                                 
  1789 │       │       │       │        │       │               │       │                size = mask.size                                                                                                                                                                                                          
  1790 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  1791 │       │       │       │        │       │               │       │                # FIXME: use self.size here?                                                                                                                                                                                              
  1792 │       │       │       │        │       │               │       │                msg = "cannot determine region size; use 4-item box"                                                                                                                                                                      
  1793 │       │       │       │        │       │               │       │                raise ValueError(msg)                                                                                                                                                                                                     
  1794 │       │       │       │        │       │               │       │            box += (box[0] + size[0], box[1] + size[1])                                                                                                                                                                                   
  1795 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1796 │       │       │       │        │       │               │       │        source: core.ImagingCore | str | float | tuple[float, ...]                                                                                                                                                                        
  1797 │       │       │       │        │       │               │       │        if isinstance(im, str):                                                                                                                                                                                                           
  1798 │       │       │       │        │       │               │       │            from . import ImageColor                                                                                                                                                                                                      
  1799 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1800 │       │       │       │        │       │               │       │            source = ImageColor.getcolor(im, self.mode)                                                                                                                                                                                   
  1801 │       │       │       │        │       │               │       │        elif isinstance(im, Image):                                                                                                                                                                                                       
  1802 │       │       │       │        │       │               │       │            im.load()                                                                                                                                                                                                                     
  1803 │       │       │       │        │       │               │       │            if self.mode != im.mode:                                                                                                                                                                                                      
  1804 │       │       │       │        │       │               │       │                if self.mode != "RGB" or im.mode not in ("LA", "RGBA", "RGBa"):                                                                                                                                                           
  1805 │       │       │       │        │       │               │       │                    # should use an adapter for this!                                                                                                                                                                                     
  1806 │       │       │       │        │       │               │       │                    im = im.convert(self.mode)                                                                                                                                                                                            
  1807 │       │       │       │        │       │               │       │            source = im.im                                                                                                                                                                                                                
  1808 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1809 │       │       │       │        │       │               │       │            source = im                                                                                                                                                                                                                   
  1810 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1811 │       │       │       │        │       │               │       │        self._ensure_mutable()                                                                                                                                                                                                            
  1812 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1813 │       │       │       │        │       │               │       │        if mask:                                                                                                                                                                                                                          
  1814 │       │       │       │        │       │               │       │            mask.load()                                                                                                                                                                                                                   
  1815 │       │       │       │        │       │               │       │            self.im.paste(source, box, mask.im)                                                                                                                                                                                           
  1816 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1817 │       │       │       │        │       │               │       │            self.im.paste(source, box)                                                                                                                                                                                                    
  1818 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1819 │       │       │       │        │       │               │       │    def alpha_composite(                                                                                                                                                                                                                  
  1820 │       │       │       │        │       │               │       │        self, im: Image, dest: Sequence[int] = (0, 0), source: Sequence[int] = (0, 0)                                                                                                                                                     
  1821 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
  1822 │       │       │       │        │       │               │       │        """'In-place' analog of Image.alpha_composite. Composites an image                                                                                                                                                                
  1823 │       │       │       │        │       │               │       │        onto this image.                                                                                                                                                                                                                  
  1824 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1825 │       │       │       │        │       │               │       │        :param im: image to composite over this one                                                                                                                                                                                       
  1826 │       │       │       │        │       │               │       │        :param dest: Optional 2 tuple (left, top) specifying the upper                                                                                                                                                                    
  1827 │       │       │       │        │       │               │       │          left corner in this (destination) image.                                                                                                                                                                                        
  1828 │       │       │       │        │       │               │       │        :param source: Optional 2 (left, top) tuple for the upper left                                                                                                                                                                    
  1829 │       │       │       │        │       │               │       │          corner in the overlay source image, or 4 tuple (left, top, right,                                                                                                                                                               
  1830 │       │       │       │        │       │               │       │          bottom) for the bounds of the source rectangle                                                                                                                                                                                  
  1831 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1832 │       │       │       │        │       │               │       │        Performance Note: Not currently implemented in-place in the core layer.                                                                                                                                                           
  1833 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1834 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1835 │       │       │       │        │       │               │       │        if not isinstance(source, (list, tuple)):                                                                                                                                                                                         
  1836 │       │       │       │        │       │               │       │            msg = "Source must be a list or tuple"                                                                                                                                                                                        
  1837 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  1838 │       │       │       │        │       │               │       │        if not isinstance(dest, (list, tuple)):                                                                                                                                                                                           
  1839 │       │       │       │        │       │               │       │            msg = "Destination must be a list or tuple"                                                                                                                                                                                   
  1840 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  1841 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1842 │       │       │       │        │       │               │       │        if len(source) == 4:                                                                                                                                                                                                              
  1843 │       │       │       │        │       │               │       │            overlay_crop_box = tuple(source)                                                                                                                                                                                              
  1844 │       │       │       │        │       │               │       │        elif len(source) == 2:                                                                                                                                                                                                            
  1845 │       │       │       │        │       │               │       │            overlay_crop_box = tuple(source) + im.size                                                                                                                                                                                    
  1846 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1847 │       │       │       │        │       │               │       │            msg = "Source must be a sequence of length 2 or 4"                                                                                                                                                                            
  1848 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  1849 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1850 │       │       │       │        │       │               │       │        if not len(dest) == 2:                                                                                                                                                                                                            
  1851 │       │       │       │        │       │               │       │            msg = "Destination must be a sequence of length 2"                                                                                                                                                                            
  1852 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  1853 │       │       │       │        │       │               │       │        if min(source) < 0:                                                                                                                                                                                                               
  1854 │       │       │       │        │       │               │       │            msg = "Source must be non-negative"                                                                                                                                                                                           
  1855 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  1856 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1857 │       │       │       │        │       │               │       │        # over image, crop if it's not the whole image.                                                                                                                                                                                   
  1858 │       │       │       │        │       │               │       │        if overlay_crop_box == (0, 0) + im.size:                                                                                                                                                                                          
  1859 │       │       │       │        │       │               │       │            overlay = im                                                                                                                                                                                                                  
  1860 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1861 │       │       │       │        │       │               │       │            overlay = im.crop(overlay_crop_box)                                                                                                                                                                                           
  1862 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1863 │       │       │       │        │       │               │       │        # target for the paste                                                                                                                                                                                                            
  1864 │       │       │       │        │       │               │       │        box = tuple(dest) + (dest[0] + overlay.width, dest[1] + overlay.height)                                                                                                                                                           
  1865 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1866 │       │       │       │        │       │               │       │        # destination image. don't copy if we're using the whole image.                                                                                                                                                                   
  1867 │       │       │       │        │       │               │       │        if box == (0, 0) + self.size:                                                                                                                                                                                                     
  1868 │       │       │       │        │       │               │       │            background = self                                                                                                                                                                                                             
  1869 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1870 │       │       │       │        │       │               │       │            background = self.crop(box)                                                                                                                                                                                                   
  1871 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1872 │       │       │       │        │       │               │       │        result = alpha_composite(background, overlay)                                                                                                                                                                                     
  1873 │       │       │       │        │       │               │       │        self.paste(result, box)                                                                                                                                                                                                           
  1874 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1875 │       │       │       │        │       │               │       │    def point(                                                                                                                                                                                                                            
  1876 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  1877 │       │       │       │        │       │               │       │        lut: (                                                                                                                                                                                                                            
  1878 │       │       │       │        │       │               │       │            Sequence[float]                                                                                                                                                                                                               
  1879 │       │       │       │        │       │               │       │            | NumpyArray                                                                                                                                                                                                                  
  1880 │       │       │       │        │       │               │       │            | Callable[[int], float]                                                                                                                                                                                                      
  1881 │       │       │       │        │       │               │       │            | Callable[[ImagePointTransform], ImagePointTransform | float]                                                                                                                                                                
  1882 │       │       │       │        │       │               │       │            | ImagePointHandler                                                                                                                                                                                                           
  1883 │       │       │       │        │       │               │       │        ),                                                                                                                                                                                                                                
  1884 │       │       │       │        │       │               │       │        mode: str | None = None,                                                                                                                                                                                                          
  1885 │       │       │       │        │       │               │       │    ) -> Image:                                                                                                                                                                                                                           
  1886 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1887 │       │       │       │        │       │               │       │        Maps this image through a lookup table or function.                                                                                                                                                                               
  1888 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1889 │       │       │       │        │       │               │       │        :param lut: A lookup table, containing 256 (or 65536 if                                                                                                                                                                           
  1890 │       │       │       │        │       │               │       │           self.mode=="I" and mode == "L") values per band in the                                                                                                                                                                         
  1891 │       │       │       │        │       │               │       │           image.  A function can be used instead, it should take a                                                                                                                                                                       
  1892 │       │       │       │        │       │               │       │           single argument. The function is called once for each                                                                                                                                                                          
  1893 │       │       │       │        │       │               │       │           possible pixel value, and the resulting table is applied to                                                                                                                                                                    
  1894 │       │       │       │        │       │               │       │           all bands of the image.                                                                                                                                                                                                        
  1895 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1896 │       │       │       │        │       │               │       │           It may also be an :py:class:`~PIL.Image.ImagePointHandler`                                                                                                                                                                     
  1897 │       │       │       │        │       │               │       │           object::                                                                                                                                                                                                                       
  1898 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1899 │       │       │       │        │       │               │       │               class Example(Image.ImagePointHandler):                                                                                                                                                                                    
  1900 │       │       │       │        │       │               │       │                 def point(self, im: Image) -> Image:                                                                                                                                                                                     
  1901 │       │       │       │        │       │               │       │                   # Return result                                                                                                                                                                                                        
  1902 │       │       │       │        │       │               │       │        :param mode: Output mode (default is same as input). This can only be used if                                                                                                                                                     
  1903 │       │       │       │        │       │               │       │           the source image has mode "L" or "P", and the output has mode "1" or the                                                                                                                                                       
  1904 │       │       │       │        │       │               │       │           source image mode is "I" and the output mode is "L".                                                                                                                                                                           
  1905 │       │       │       │        │       │               │       │        :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                 
  1906 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1907 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1908 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  1909 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1910 │       │       │       │        │       │               │       │        if isinstance(lut, ImagePointHandler):                                                                                                                                                                                            
  1911 │       │       │       │        │       │               │       │            return lut.point(self)                                                                                                                                                                                                        
  1912 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1913 │       │       │       │        │       │               │       │        if callable(lut):                                                                                                                                                                                                                 
  1914 │       │       │       │        │       │               │       │            # if it isn't a list, it should be a function                                                                                                                                                                                 
  1915 │       │       │       │        │       │               │       │            if self.mode in ("I", "I;16", "F"):                                                                                                                                                                                           
  1916 │       │       │       │        │       │               │       │                # check if the function can be used with point_transform                                                                                                                                                                  
  1917 │       │       │       │        │       │               │       │                # UNDONE wiredfool -- I think this prevents us from ever doing                                                                                                                                                            
  1918 │       │       │       │        │       │               │       │                # a gamma function point transform on > 8bit images.                                                                                                                                                                      
  1919 │       │       │       │        │       │               │       │                scale, offset = _getscaleoffset(lut)  # type: ignore[arg-type]                                                                                                                                                            
  1920 │       │       │       │        │       │               │       │                return self._new(self.im.point_transform(scale, offset))                                                                                                                                                                  
  1921 │       │       │       │        │       │               │       │            # for other modes, convert the function to a table                                                                                                                                                                            
  1922 │       │       │       │        │       │               │       │            flatLut = [lut(i) for i in range(256)] * self.im.bands  # type: ignore[arg-type]                                                                                                                                              
  1923 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1924 │       │       │       │        │       │               │       │            flatLut = lut                                                                                                                                                                                                                 
  1925 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1926 │       │       │       │        │       │               │       │        if self.mode == "F":                                                                                                                                                                                                              
  1927 │       │       │       │        │       │               │       │            # FIXME: _imaging returns a confusing error message for this case                                                                                                                                                             
  1928 │       │       │       │        │       │               │       │            msg = "point operation not supported for this mode"                                                                                                                                                                           
  1929 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  1930 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1931 │       │       │       │        │       │               │       │        if mode != "F":                                                                                                                                                                                                                   
  1932 │       │       │       │        │       │               │       │            flatLut = [round(i) for i in flatLut]                                                                                                                                                                                         
  1933 │       │       │       │        │       │               │       │        return self._new(self.im.point(flatLut, mode))                                                                                                                                                                                    
  1934 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1935 │       │       │       │        │       │               │       │    def putalpha(self, alpha: Image | int) -> None:                                                                                                                                                                                       
  1936 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1937 │       │       │       │        │       │               │       │        Adds or replaces the alpha layer in this image.  If the image                                                                                                                                                                     
  1938 │       │       │       │        │       │               │       │        does not have an alpha layer, it's converted to "LA" or "RGBA".                                                                                                                                                                   
  1939 │       │       │       │        │       │               │       │        The new layer must be either "L" or "1".                                                                                                                                                                                          
  1940 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1941 │       │       │       │        │       │               │       │        :param alpha: The new alpha layer.  This can either be an "L" or "1"                                                                                                                                                              
  1942 │       │       │       │        │       │               │       │           image having the same size as this image, or an integer.                                                                                                                                                                       
  1943 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1944 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1945 │       │       │       │        │       │               │       │        self._ensure_mutable()                                                                                                                                                                                                            
  1946 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1947 │       │       │       │        │       │               │       │        if self.mode not in ("LA", "PA", "RGBA"):                                                                                                                                                                                         
  1948 │       │       │       │        │       │               │       │            # attempt to promote self to a matching alpha mode                                                                                                                                                                            
  1949 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
  1950 │       │       │       │        │       │               │       │                mode = getmodebase(self.mode) + "A"                                                                                                                                                                                       
  1951 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
  1952 │       │       │       │        │       │               │       │                    self.im.setmode(mode)                                                                                                                                                                                                 
  1953 │       │       │       │        │       │               │       │                except (AttributeError, ValueError) as e:                                                                                                                                                                                 
  1954 │       │       │       │        │       │               │       │                    # do things the hard way                                                                                                                                                                                              
  1955 │       │       │       │        │       │               │       │                    im = self.im.convert(mode)                                                                                                                                                                                            
  1956 │       │       │       │        │       │               │       │                    if im.mode not in ("LA", "PA", "RGBA"):                                                                                                                                                                               
  1957 │       │       │       │        │       │               │       │                        msg = "alpha channel could not be added"                                                                                                                                                                          
  1958 │       │       │       │        │       │               │       │                        raise ValueError(msg) from e  # sanity check                                                                                                                                                                      
  1959 │       │       │       │        │       │               │       │                    self.im = im                                                                                                                                                                                                          
  1960 │       │       │       │        │       │               │       │                self._mode = self.im.mode                                                                                                                                                                                                 
  1961 │       │       │       │        │       │               │       │            except KeyError as e:                                                                                                                                                                                                         
  1962 │       │       │       │        │       │               │       │                msg = "illegal image mode"                                                                                                                                                                                                
  1963 │       │       │       │        │       │               │       │                raise ValueError(msg) from e                                                                                                                                                                                              
  1964 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1965 │       │       │       │        │       │               │       │        if self.mode in ("LA", "PA"):                                                                                                                                                                                                     
  1966 │       │       │       │        │       │               │       │            band = 1                                                                                                                                                                                                                      
  1967 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1968 │       │       │       │        │       │               │       │            band = 3                                                                                                                                                                                                                      
  1969 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1970 │       │       │       │        │       │               │       │        if isinstance(alpha, Image):                                                                                                                                                                                                      
  1971 │       │       │       │        │       │               │       │            # alpha layer                                                                                                                                                                                                                 
  1972 │       │       │       │        │       │               │       │            if alpha.mode not in ("1", "L"):                                                                                                                                                                                              
  1973 │       │       │       │        │       │               │       │                msg = "illegal image mode"                                                                                                                                                                                                
  1974 │       │       │       │        │       │               │       │                raise ValueError(msg)                                                                                                                                                                                                     
  1975 │       │       │       │        │       │               │       │            alpha.load()                                                                                                                                                                                                                  
  1976 │       │       │       │        │       │               │       │            if alpha.mode == "1":                                                                                                                                                                                                         
  1977 │       │       │       │        │       │               │       │                alpha = alpha.convert("L")                                                                                                                                                                                                
  1978 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1979 │       │       │       │        │       │               │       │            # constant alpha                                                                                                                                                                                                              
  1980 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
  1981 │       │       │       │        │       │               │       │                self.im.fillband(band, alpha)                                                                                                                                                                                             
  1982 │       │       │       │        │       │               │       │            except (AttributeError, ValueError):                                                                                                                                                                                          
  1983 │       │       │       │        │       │               │       │                # do things the hard way                                                                                                                                                                                                  
  1984 │       │       │       │        │       │               │       │                alpha = new("L", self.size, alpha)                                                                                                                                                                                        
  1985 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  1986 │       │       │       │        │       │               │       │                return                                                                                                                                                                                                                    
  1987 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1988 │       │       │       │        │       │               │       │        self.im.putband(alpha.im, band)                                                                                                                                                                                                   
  1989 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1990 │       │       │       │        │       │               │       │    def putdata(                                                                                                                                                                                                                          
  1991 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  1992 │       │       │       │        │       │               │       │        data: Sequence[float] | Sequence[Sequence[int]] | core.ImagingCore | NumpyArray,                                                                                                                                                  
  1993 │       │       │       │        │       │               │       │        scale: float = 1.0,                                                                                                                                                                                                               
  1994 │       │       │       │        │       │               │       │        offset: float = 0.0,                                                                                                                                                                                                              
  1995 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
  1996 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1997 │       │       │       │        │       │               │       │        Copies pixel data from a flattened sequence object into the image. The                                                                                                                                                            
  1998 │       │       │       │        │       │               │       │        values should start at the upper left corner (0, 0), continue to the                                                                                                                                                              
  1999 │       │       │       │        │       │               │       │        end of the line, followed directly by the first value of the second                                                                                                                                                               
  2000 │       │       │       │        │       │               │       │        line, and so on. Data will be read until either the image or the                                                                                                                                                                  
  2001 │       │       │       │        │       │               │       │        sequence ends. The scale and offset values are used to adjust the                                                                                                                                                                 
  2002 │       │       │       │        │       │               │       │        sequence values: **pixel = value*scale + offset**.                                                                                                                                                                                
  2003 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2004 │       │       │       │        │       │               │       │        :param data: A flattened sequence object.                                                                                                                                                                                         
  2005 │       │       │       │        │       │               │       │        :param scale: An optional scale value.  The default is 1.0.                                                                                                                                                                       
  2006 │       │       │       │        │       │               │       │        :param offset: An optional offset value.  The default is 0.0.                                                                                                                                                                     
  2007 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2008 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2009 │       │       │       │        │       │               │       │        self._ensure_mutable()                                                                                                                                                                                                            
  2010 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2011 │       │       │       │        │       │               │       │        self.im.putdata(data, scale, offset)                                                                                                                                                                                              
  2012 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2013 │       │       │       │        │       │               │       │    def putpalette(                                                                                                                                                                                                                       
  2014 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  2015 │       │       │       │        │       │               │       │        data: ImagePalette.ImagePalette | bytes | Sequence[int],                                                                                                                                                                          
  2016 │       │       │       │        │       │               │       │        rawmode: str = "RGB",                                                                                                                                                                                                             
  2017 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
  2018 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2019 │       │       │       │        │       │               │       │        Attaches a palette to this image.  The image must be a "P", "PA", "L"                                                                                                                                                             
  2020 │       │       │       │        │       │               │       │        or "LA" image.                                                                                                                                                                                                                    
  2021 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2022 │       │       │       │        │       │               │       │        The palette sequence must contain at most 256 colors, made up of one                                                                                                                                                              
  2023 │       │       │       │        │       │               │       │        integer value for each channel in the raw mode.                                                                                                                                                                                   
  2024 │       │       │       │        │       │               │       │        For example, if the raw mode is "RGB", then it can contain at most 768                                                                                                                                                            
  2025 │       │       │       │        │       │               │       │        values, made up of red, green and blue values for the corresponding pixel                                                                                                                                                         
  2026 │       │       │       │        │       │               │       │        index in the 256 colors.                                                                                                                                                                                                          
  2027 │       │       │       │        │       │               │       │        If the raw mode is "RGBA", then it can contain at most 1024 values,                                                                                                                                                               
  2028 │       │       │       │        │       │               │       │        containing red, green, blue and alpha values.                                                                                                                                                                                     
  2029 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2030 │       │       │       │        │       │               │       │        Alternatively, an 8-bit string may be used instead of an integer sequence.                                                                                                                                                        
  2031 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2032 │       │       │       │        │       │               │       │        :param data: A palette sequence (either a list or a string).                                                                                                                                                                      
  2033 │       │       │       │        │       │               │       │        :param rawmode: The raw mode of the palette. Either "RGB", "RGBA", or a mode                                                                                                                                                      
  2034 │       │       │       │        │       │               │       │           that can be transformed to "RGB" or "RGBA" (e.g. "R", "BGR;15", "RGBA;L").                                                                                                                                                     
  2035 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2036 │       │       │       │        │       │               │       │        from . import ImagePalette                                                                                                                                                                                                        
  2037 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2038 │       │       │       │        │       │               │       │        if self.mode not in ("L", "LA", "P", "PA"):                                                                                                                                                                                       
  2039 │       │       │       │        │       │               │       │            msg = "illegal image mode"                                                                                                                                                                                                    
  2040 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  2041 │       │       │       │        │       │               │       │        if isinstance(data, ImagePalette.ImagePalette):                                                                                                                                                                                   
  2042 │       │       │       │        │       │               │       │            if data.rawmode is not None:                                                                                                                                                                                                  
  2043 │       │       │       │        │       │               │       │                palette = ImagePalette.raw(data.rawmode, data.palette)                                                                                                                                                                    
  2044 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  2045 │       │       │       │        │       │               │       │                palette = ImagePalette.ImagePalette(palette=data.palette)                                                                                                                                                                 
  2046 │       │       │       │        │       │               │       │                palette.dirty = 1                                                                                                                                                                                                         
  2047 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  2048 │       │       │       │        │       │               │       │            if not isinstance(data, bytes):                                                                                                                                                                                               
  2049 │       │       │       │        │       │               │       │                data = bytes(data)                                                                                                                                                                                                        
  2050 │       │       │       │        │       │               │       │            palette = ImagePalette.raw(rawmode, data)                                                                                                                                                                                     
  2051 │       │       │       │        │       │               │       │        self._mode = "PA" if "A" in self.mode else "P"                                                                                                                                                                                    
  2052 │       │       │       │        │       │               │       │        self.palette = palette                                                                                                                                                                                                            
  2053 │       │       │       │        │       │               │       │        self.palette.mode = "RGBA" if "A" in rawmode else "RGB"                                                                                                                                                                           
  2054 │       │       │       │        │       │               │       │        self.load()  # install new palette                                                                                                                                                                                                
  2055 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2056 │       │       │       │        │       │               │       │    def putpixel(                                                                                                                                                                                                                         
  2057 │       │       │       │        │       │               │       │        self, xy: tuple[int, int], value: float | tuple[int, ...] | list[int]                                                                                                                                                             
  2058 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
  2059 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2060 │       │       │       │        │       │               │       │        Modifies the pixel at the given position. The color is given as                                                                                                                                                                   
  2061 │       │       │       │        │       │               │       │        a single numerical value for single-band images, and a tuple for                                                                                                                                                                  
  2062 │       │       │       │        │       │               │       │        multi-band images. In addition to this, RGB and RGBA tuples are                                                                                                                                                                   
  2063 │       │       │       │        │       │               │       │        accepted for P and PA images.                                                                                                                                                                                                     
  2064 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2065 │       │       │       │        │       │               │       │        Note that this method is relatively slow.  For more extensive changes,                                                                                                                                                            
  2066 │       │       │       │        │       │               │       │        use :py:meth:`~PIL.Image.Image.paste` or the :py:mod:`~PIL.ImageDraw`                                                                                                                                                             
  2067 │       │       │       │        │       │               │       │        module instead.                                                                                                                                                                                                                   
  2068 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2069 │       │       │       │        │       │               │       │        See:                                                                                                                                                                                                                              
  2070 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2071 │       │       │       │        │       │               │       │        * :py:meth:`~PIL.Image.Image.paste`                                                                                                                                                                                               
  2072 │       │       │       │        │       │               │       │        * :py:meth:`~PIL.Image.Image.putdata`                                                                                                                                                                                             
  2073 │       │       │       │        │       │               │       │        * :py:mod:`~PIL.ImageDraw`                                                                                                                                                                                                        
  2074 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2075 │       │       │       │        │       │               │       │        :param xy: The pixel coordinate, given as (x, y). See                                                                                                                                                                             
  2076 │       │       │       │        │       │               │       │           :ref:`coordinate-system`.                                                                                                                                                                                                      
  2077 │       │       │       │        │       │               │       │        :param value: The pixel value.                                                                                                                                                                                                    
  2078 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2079 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2080 │       │       │       │        │       │               │       │        if self.readonly:                                                                                                                                                                                                                 
  2081 │       │       │       │        │       │               │       │            self._copy()                                                                                                                                                                                                                  
  2082 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  2083 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2084 │       │       │       │        │       │               │       │        if (                                                                                                                                                                                                                              
  2085 │       │       │       │        │       │               │       │            self.mode in ("P", "PA")                                                                                                                                                                                                      
  2086 │       │       │       │        │       │               │       │            and isinstance(value, (list, tuple))                                                                                                                                                                                          
  2087 │       │       │       │        │       │               │       │            and len(value) in [3, 4]                                                                                                                                                                                                      
  2088 │       │       │       │        │       │               │       │        ):                                                                                                                                                                                                                                
  2089 │       │       │       │        │       │               │       │            # RGB or RGBA value for a P or PA image                                                                                                                                                                                       
  2090 │       │       │       │        │       │               │       │            if self.mode == "PA":                                                                                                                                                                                                         
  2091 │       │       │       │        │       │               │       │                alpha = value[3] if len(value) == 4 else 255                                                                                                                                                                              
  2092 │       │       │       │        │       │               │       │                value = value[:3]                                                                                                                                                                                                         
  2093 │       │       │       │        │       │               │       │            assert self.palette is not None                                                                                                                                                                                               
  2094 │       │       │       │        │       │               │       │            palette_index = self.palette.getcolor(tuple(value), self)                                                                                                                                                                     
  2095 │       │       │       │        │       │               │       │            value = (palette_index, alpha) if self.mode == "PA" else palette_index                                                                                                                                                        
  2096 │       │       │       │        │       │               │       │        return self.im.putpixel(xy, value)                                                                                                                                                                                                
  2097 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2098 │       │       │       │        │       │               │       │    def remap_palette(                                                                                                                                                                                                                    
  2099 │       │       │       │        │       │               │       │        self, dest_map: list[int], source_palette: bytes | bytearray | None = None                                                                                                                                                        
  2100 │       │       │       │        │       │               │       │    ) -> Image:                                                                                                                                                                                                                           
  2101 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2102 │       │       │       │        │       │               │       │        Rewrites the image to reorder the palette.                                                                                                                                                                                        
  2103 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2104 │       │       │       │        │       │               │       │        :param dest_map: A list of indexes into the original palette.                                                                                                                                                                     
  2105 │       │       │       │        │       │               │       │           e.g. ``[1,0]`` would swap a two item palette, and ``list(range(256))``                                                                                                                                                         
  2106 │       │       │       │        │       │               │       │           is the identity transform.                                                                                                                                                                                                     
  2107 │       │       │       │        │       │               │       │        :param source_palette: Bytes or None.                                                                                                                                                                                             
  2108 │       │       │       │        │       │               │       │        :returns:  An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                
  2109 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2110 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2111 │       │       │       │        │       │               │       │        from . import ImagePalette                                                                                                                                                                                                        
  2112 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2113 │       │       │       │        │       │               │       │        if self.mode not in ("L", "P"):                                                                                                                                                                                                   
  2114 │       │       │       │        │       │               │       │            msg = "illegal image mode"                                                                                                                                                                                                    
  2115 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  2116 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2117 │       │       │       │        │       │               │       │        bands = 3                                                                                                                                                                                                                         
  2118 │       │       │       │        │       │               │       │        palette_mode = "RGB"                                                                                                                                                                                                              
  2119 │       │       │       │        │       │               │       │        if source_palette is None:                                                                                                                                                                                                        
  2120 │       │       │       │        │       │               │       │            if self.mode == "P":                                                                                                                                                                                                          
  2121 │       │       │       │        │       │               │       │                self.load()                                                                                                                                                                                                               
  2122 │       │       │       │        │       │               │       │                palette_mode = self.im.getpalettemode()                                                                                                                                                                                   
  2123 │       │       │       │        │       │               │       │                if palette_mode == "RGBA":                                                                                                                                                                                                
  2124 │       │       │       │        │       │               │       │                    bands = 4                                                                                                                                                                                                             
  2125 │       │       │       │        │       │               │       │                source_palette = self.im.getpalette(palette_mode, palette_mode)                                                                                                                                                           
  2126 │       │       │       │        │       │               │       │            else:  # L-mode                                                                                                                                                                                                               
  2127 │       │       │       │        │       │               │       │                source_palette = bytearray(i // 3 for i in range(768))                                                                                                                                                                    
  2128 │       │       │       │        │       │               │       │        elif len(source_palette) > 768:                                                                                                                                                                                                   
  2129 │       │       │       │        │       │               │       │            bands = 4                                                                                                                                                                                                                     
  2130 │       │       │       │        │       │               │       │            palette_mode = "RGBA"                                                                                                                                                                                                         
  2131 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2132 │       │       │       │        │       │               │       │        palette_bytes = b""                                                                                                                                                                                                               
  2133 │       │       │       │        │       │               │       │        new_positions = [0] * 256                                                                                                                                                                                                         
  2134 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2135 │       │       │       │        │       │               │       │        # pick only the used colors from the palette                                                                                                                                                                                      
  2136 │       │       │       │        │       │               │       │        for i, oldPosition in enumerate(dest_map):                                                                                                                                                                                        
  2137 │       │       │       │        │       │               │       │            palette_bytes += source_palette[                                                                                                                                                                                              
  2138 │       │       │       │        │       │               │       │                oldPosition * bands : oldPosition * bands + bands                                                                                                                                                                         
  2139 │       │       │       │        │       │               │       │            ]                                                                                                                                                                                                                             
  2140 │       │       │       │        │       │               │       │            new_positions[oldPosition] = i                                                                                                                                                                                                
  2141 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2142 │       │       │       │        │       │               │       │        # replace the palette color id of all pixel with the new id                                                                                                                                                                       
  2143 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2144 │       │       │       │        │       │               │       │        # Palette images are [0..255], mapped through a 1 or 3                                                                                                                                                                            
  2145 │       │       │       │        │       │               │       │        # byte/color map.  We need to remap the whole image                                                                                                                                                                               
  2146 │       │       │       │        │       │               │       │        # from palette 1 to palette 2. New_positions is                                                                                                                                                                                   
  2147 │       │       │       │        │       │               │       │        # an array of indexes into palette 1.  Palette 2 is                                                                                                                                                                               
  2148 │       │       │       │        │       │               │       │        # palette 1 with any holes removed.                                                                                                                                                                                               
  2149 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2150 │       │       │       │        │       │               │       │        # We're going to leverage the convert mechanism to use the                                                                                                                                                                        
  2151 │       │       │       │        │       │               │       │        # C code to remap the image from palette 1 to palette 2,                                                                                                                                                                          
  2152 │       │       │       │        │       │               │       │        # by forcing the source image into 'L' mode and adding a                                                                                                                                                                          
  2153 │       │       │       │        │       │               │       │        # mapping 'L' mode palette, then converting back to 'L'                                                                                                                                                                           
  2154 │       │       │       │        │       │               │       │        # sans palette thus converting the image bytes, then                                                                                                                                                                              
  2155 │       │       │       │        │       │               │       │        # assigning the optimized RGB palette.                                                                                                                                                                                            
  2156 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2157 │       │       │       │        │       │               │       │        # perf reference, 9500x4000 gif, w/~135 colors                                                                                                                                                                                    
  2158 │       │       │       │        │       │               │       │        # 14 sec prepatch, 1 sec postpatch with optimization forced.                                                                                                                                                                      
  2159 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2160 │       │       │       │        │       │               │       │        mapping_palette = bytearray(new_positions)                                                                                                                                                                                        
  2161 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2162 │       │       │       │        │       │               │       │        m_im = self.copy()                                                                                                                                                                                                                
  2163 │       │       │       │        │       │               │       │        m_im._mode = "P"                                                                                                                                                                                                                  
  2164 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2165 │       │       │       │        │       │               │       │        m_im.palette = ImagePalette.ImagePalette(                                                                                                                                                                                         
  2166 │       │       │       │        │       │               │       │            palette_mode, palette=mapping_palette * bands                                                                                                                                                                                 
  2167 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
  2168 │       │       │       │        │       │               │       │        # possibly set palette dirty, then                                                                                                                                                                                                
  2169 │       │       │       │        │       │               │       │        # m_im.putpalette(mapping_palette, 'L')  # converts to 'P'                                                                                                                                                                        
  2170 │       │       │       │        │       │               │       │        # or just force it.                                                                                                                                                                                                               
  2171 │       │       │       │        │       │               │       │        # UNDONE -- this is part of the general issue with palettes                                                                                                                                                                       
  2172 │       │       │       │        │       │               │       │        m_im.im.putpalette(palette_mode, palette_mode + ";L", m_im.palette.tobytes())                                                                                                                                                     
  2173 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2174 │       │       │       │        │       │               │       │        m_im = m_im.convert("L")                                                                                                                                                                                                          
  2175 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2176 │       │       │       │        │       │               │       │        m_im.putpalette(palette_bytes, palette_mode)                                                                                                                                                                                      
  2177 │       │       │       │        │       │               │       │        m_im.palette = ImagePalette.ImagePalette(palette_mode, palette=palette_bytes)                                                                                                                                                     
  2178 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2179 │       │       │       │        │       │               │       │        if "transparency" in self.info:                                                                                                                                                                                                   
  2180 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
  2181 │       │       │       │        │       │               │       │                m_im.info["transparency"] = dest_map.index(self.info["transparency"])                                                                                                                                                     
  2182 │       │       │       │        │       │               │       │            except ValueError:                                                                                                                                                                                                            
  2183 │       │       │       │        │       │               │       │                if "transparency" in m_im.info:                                                                                                                                                                                           
  2184 │       │       │       │        │       │               │       │                    del m_im.info["transparency"]                                                                                                                                                                                         
  2185 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2186 │       │       │       │        │       │               │       │        return m_im                                                                                                                                                                                                                       
  2187 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2188 │       │       │       │        │       │               │       │    def _get_safe_box(                                                                                                                                                                                                                    
  2189 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  2190 │       │       │       │        │       │               │       │        size: tuple[int, int],                                                                                                                                                                                                            
  2191 │       │       │       │        │       │               │       │        resample: Resampling,                                                                                                                                                                                                             
  2192 │       │       │       │        │       │               │       │        box: tuple[float, float, float, float],                                                                                                                                                                                           
  2193 │       │       │       │        │       │               │       │    ) -> tuple[int, int, int, int]:                                                                                                                                                                                                       
  2194 │       │       │       │        │       │               │       │        """Expands the box so it includes adjacent pixels                                                                                                                                                                                 
  2195 │       │       │       │        │       │               │       │        that may be used by resampling with the given resampling filter.                                                                                                                                                                  
  2196 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2197 │       │       │       │        │       │               │       │        filter_support = _filters_support[resample] - 0.5                                                                                                                                                                                 
  2198 │       │       │       │        │       │               │       │        scale_x = (box[2] - box[0]) / size[0]                                                                                                                                                                                             
  2199 │       │       │       │        │       │               │       │        scale_y = (box[3] - box[1]) / size[1]                                                                                                                                                                                             
  2200 │       │       │       │        │       │               │       │        support_x = filter_support * scale_x                                                                                                                                                                                              
  2201 │       │       │       │        │       │               │       │        support_y = filter_support * scale_y                                                                                                                                                                                              
  2202 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2203 │       │       │       │        │       │               │       │        return (                                                                                                                                                                                                                          
  2204 │       │       │       │        │       │               │       │            max(0, int(box[0] - support_x)),                                                                                                                                                                                              
  2205 │       │       │       │        │       │               │       │            max(0, int(box[1] - support_y)),                                                                                                                                                                                              
  2206 │       │       │       │        │       │               │       │            min(self.size[0], math.ceil(box[2] + support_x)),                                                                                                                                                                             
  2207 │       │       │       │        │       │               │       │            min(self.size[1], math.ceil(box[3] + support_y)),                                                                                                                                                                             
  2208 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
  2209 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2210 │       │       │       │        │       │               │       │    def resize(                                                                                                                                                                                                                           
  2211 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  2212 │       │       │       │        │       │               │       │        size: tuple[int, int] | list[int] | NumpyArray,                                                                                                                                                                                   
  2213 │       │       │       │        │       │               │       │        resample: int | None = None,                                                                                                                                                                                                      
  2214 │       │       │       │        │       │               │       │        box: tuple[float, float, float, float] | None = None,                                                                                                                                                                             
  2215 │       │       │       │        │       │               │       │        reducing_gap: float | None = None,                                                                                                                                                                                                
  2216 │       │       │       │        │       │               │       │    ) -> Image:                                                                                                                                                                                                                           
  2217 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2218 │       │       │       │        │       │               │       │        Returns a resized copy of this image.                                                                                                                                                                                             
  2219 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2220 │       │       │       │        │       │               │       │        :param size: The requested size in pixels, as a tuple or array:                                                                                                                                                                   
  2221 │       │       │       │        │       │               │       │           (width, height).                                                                                                                                                                                                               
  2222 │       │       │       │        │       │               │       │        :param resample: An optional resampling filter.  This can be                                                                                                                                                                      
  2223 │       │       │       │        │       │               │       │           one of :py:data:`Resampling.NEAREST`, :py:data:`Resampling.BOX`,                                                                                                                                                               
  2224 │       │       │       │        │       │               │       │           :py:data:`Resampling.BILINEAR`, :py:data:`Resampling.HAMMING`,                                                                                                                                                                 
  2225 │       │       │       │        │       │               │       │           :py:data:`Resampling.BICUBIC` or :py:data:`Resampling.LANCZOS`.                                                                                                                                                                
  2226 │       │       │       │        │       │               │       │           If the image has mode "1" or "P", it is always set to                                                                                                                                                                          
  2227 │       │       │       │        │       │               │       │           :py:data:`Resampling.NEAREST`. If the image mode is "BGR;15",                                                                                                                                                                  
  2228 │       │       │       │        │       │               │       │           "BGR;16" or "BGR;24", then the default filter is                                                                                                                                                                               
  2229 │       │       │       │        │       │               │       │           :py:data:`Resampling.NEAREST`. Otherwise, the default filter is                                                                                                                                                                
  2230 │       │       │       │        │       │               │       │           :py:data:`Resampling.BICUBIC`. See: :ref:`concept-filters`.                                                                                                                                                                    
  2231 │       │       │       │        │       │               │       │        :param box: An optional 4-tuple of floats providing                                                                                                                                                                               
  2232 │       │       │       │        │       │               │       │           the source image region to be scaled.                                                                                                                                                                                          
  2233 │       │       │       │        │       │               │       │           The values must be within (0, 0, width, height) rectangle.                                                                                                                                                                     
  2234 │       │       │       │        │       │               │       │           If omitted or None, the entire source is used.                                                                                                                                                                                 
  2235 │       │       │       │        │       │               │       │        :param reducing_gap: Apply optimization by resizing the image                                                                                                                                                                     
  2236 │       │       │       │        │       │               │       │           in two steps. First, reducing the image by integer times                                                                                                                                                                       
  2237 │       │       │       │        │       │               │       │           using :py:meth:`~PIL.Image.Image.reduce`.                                                                                                                                                                                      
  2238 │       │       │       │        │       │               │       │           Second, resizing using regular resampling. The last step                                                                                                                                                                       
  2239 │       │       │       │        │       │               │       │           changes size no less than by ``reducing_gap`` times.                                                                                                                                                                           
  2240 │       │       │       │        │       │               │       │           ``reducing_gap`` may be None (no first step is performed)                                                                                                                                                                      
  2241 │       │       │       │        │       │               │       │           or should be greater than 1.0. The bigger ``reducing_gap``,                                                                                                                                                                    
  2242 │       │       │       │        │       │               │       │           the closer the result to the fair resampling.                                                                                                                                                                                  
  2243 │       │       │       │        │       │               │       │           The smaller ``reducing_gap``, the faster resizing.                                                                                                                                                                             
  2244 │       │       │       │        │       │               │       │           With ``reducing_gap`` greater or equal to 3.0, the result is                                                                                                                                                                   
  2245 │       │       │       │        │       │               │       │           indistinguishable from fair resampling in most cases.                                                                                                                                                                          
  2246 │       │       │       │        │       │               │       │           The default value is None (no optimization).                                                                                                                                                                                   
  2247 │       │       │       │        │       │               │       │        :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                 
  2248 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2249 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2250 │       │       │       │        │       │               │       │        if resample is None:                                                                                                                                                                                                              
  2251 │       │       │       │        │       │               │       │            bgr = self.mode.startswith("BGR;")                                                                                                                                                                                            
  2252 │       │       │       │        │       │               │       │            resample = Resampling.NEAREST if bgr else Resampling.BICUBIC                                                                                                                                                                  
  2253 │       │       │       │        │       │               │       │        elif resample not in (                                                                                                                                                                                                            
  2254 │       │       │       │        │       │               │       │            Resampling.NEAREST,                                                                                                                                                                                                           
  2255 │       │       │       │        │       │               │       │            Resampling.BILINEAR,                                                                                                                                                                                                          
  2256 │       │       │       │        │       │               │       │            Resampling.BICUBIC,                                                                                                                                                                                                           
  2257 │       │       │       │        │       │               │       │            Resampling.LANCZOS,                                                                                                                                                                                                           
  2258 │       │       │       │        │       │               │       │            Resampling.BOX,                                                                                                                                                                                                               
  2259 │       │       │       │        │       │               │       │            Resampling.HAMMING,                                                                                                                                                                                                           
  2260 │       │       │       │        │       │               │       │        ):                                                                                                                                                                                                                                
  2261 │       │       │       │        │       │               │       │            msg = f"Unknown resampling filter ({resample})."                                                                                                                                                                              
  2262 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2263 │       │       │       │        │       │               │       │            filters = [                                                                                                                                                                                                                   
  2264 │       │       │       │        │       │               │       │                f"{filter[1]} ({filter[0]})"                                                                                                                                                                                              
  2265 │       │       │       │        │       │               │       │                for filter in (                                                                                                                                                                                                           
  2266 │       │       │       │        │       │               │       │                    (Resampling.NEAREST, "Image.Resampling.NEAREST"),                                                                                                                                                                     
  2267 │       │       │       │        │       │               │       │                    (Resampling.LANCZOS, "Image.Resampling.LANCZOS"),                                                                                                                                                                     
  2268 │       │       │       │        │       │               │       │                    (Resampling.BILINEAR, "Image.Resampling.BILINEAR"),                                                                                                                                                                   
  2269 │       │       │       │        │       │               │       │                    (Resampling.BICUBIC, "Image.Resampling.BICUBIC"),                                                                                                                                                                     
  2270 │       │       │       │        │       │               │       │                    (Resampling.BOX, "Image.Resampling.BOX"),                                                                                                                                                                             
  2271 │       │       │       │        │       │               │       │                    (Resampling.HAMMING, "Image.Resampling.HAMMING"),                                                                                                                                                                     
  2272 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  2273 │       │       │       │        │       │               │       │            ]                                                                                                                                                                                                                             
  2274 │       │       │       │        │       │               │       │            msg += f" Use {', '.join(filters[:-1])} or {filters[-1]}"                                                                                                                                                                     
  2275 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  2276 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2277 │       │       │       │        │       │               │       │        if reducing_gap is not None and reducing_gap < 1.0:                                                                                                                                                                               
  2278 │       │       │       │        │       │               │       │            msg = "reducing_gap must be 1.0 or greater"                                                                                                                                                                                   
  2279 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  2280 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2281 │       │       │       │        │       │               │       │        if box is None:                                                                                                                                                                                                                   
  2282 │       │       │       │        │       │               │       │            box = (0, 0) + self.size                                                                                                                                                                                                      
  2283 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2284 │       │       │       │        │       │               │       │        size = tuple(size)                                                                                                                                                                                                                
  2285 │       │       │       │        │       │               │       │        if self.size == size and box == (0, 0) + self.size:                                                                                                                                                                               
  2286 │       │       │       │        │       │               │       │            return self.copy()                                                                                                                                                                                                            
  2287 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2288 │       │       │       │        │       │               │       │        if self.mode in ("1", "P"):                                                                                                                                                                                                       
  2289 │       │       │       │        │       │               │       │            resample = Resampling.NEAREST                                                                                                                                                                                                 
  2290 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2291 │       │       │       │        │       │               │       │        if self.mode in ["LA", "RGBA"] and resample != Resampling.NEAREST:                                                                                                                                                                
  2292 │       │       │       │        │       │               │       │            im = self.convert({"LA": "La", "RGBA": "RGBa"}[self.mode])                                                                                                                                                                    
  2293 │       │       │       │        │       │               │       │            im = im.resize(size, resample, box)                                                                                                                                                                                           
  2294 │       │       │       │        │       │               │       │            return im.convert(self.mode)                                                                                                                                                                                                  
  2295 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2296 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  2297 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2298 │       │       │       │        │       │               │       │        if reducing_gap is not None and resample != Resampling.NEAREST:                                                                                                                                                                   
  2299 │       │       │       │        │       │               │       │            factor_x = int((box[2] - box[0]) / size[0] / reducing_gap) or 1                                                                                                                                                               
  2300 │       │       │       │        │       │               │       │            factor_y = int((box[3] - box[1]) / size[1] / reducing_gap) or 1                                                                                                                                                               
  2301 │       │       │       │        │       │               │       │            if factor_x > 1 or factor_y > 1:                                                                                                                                                                                              
  2302 │       │       │       │        │       │               │       │                reduce_box = self._get_safe_box(size, cast(Resampling, resample), box)                                                                                                                                                    
  2303 │       │       │       │        │       │               │       │                factor = (factor_x, factor_y)                                                                                                                                                                                             
  2304 │       │       │       │        │       │               │       │                self = (                                                                                                                                                                                                                  
  2305 │       │       │       │        │       │               │       │                    self.reduce(factor, box=reduce_box)                                                                                                                                                                                   
  2306 │       │       │       │        │       │               │       │                    if callable(self.reduce)                                                                                                                                                                                              
  2307 │       │       │       │        │       │               │       │                    else Image.reduce(self, factor, box=reduce_box)                                                                                                                                                                       
  2308 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  2309 │       │       │       │        │       │               │       │                box = (                                                                                                                                                                                                                   
  2310 │       │       │       │        │       │               │       │                    (box[0] - reduce_box[0]) / factor_x,                                                                                                                                                                                  
  2311 │       │       │       │        │       │               │       │                    (box[1] - reduce_box[1]) / factor_y,                                                                                                                                                                                  
  2312 │       │       │       │        │       │               │       │                    (box[2] - reduce_box[0]) / factor_x,                                                                                                                                                                                  
  2313 │       │       │       │        │       │               │       │                    (box[3] - reduce_box[1]) / factor_y,                                                                                                                                                                                  
  2314 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  2315 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2316 │       │       │       │        │       │               │       │        return self._new(self.im.resize(size, resample, box))                                                                                                                                                                             
  2317 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2318 │       │       │       │        │       │               │       │    def reduce(                                                                                                                                                                                                                           
  2319 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  2320 │       │       │       │        │       │               │       │        factor: int | tuple[int, int],                                                                                                                                                                                                    
  2321 │       │       │       │        │       │               │       │        box: tuple[int, int, int, int] | None = None,                                                                                                                                                                                     
  2322 │       │       │       │        │       │               │       │    ) -> Image:                                                                                                                                                                                                                           
  2323 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2324 │       │       │       │        │       │               │       │        Returns a copy of the image reduced ``factor`` times.                                                                                                                                                                             
  2325 │       │       │       │        │       │               │       │        If the size of the image is not dividable by ``factor``,                                                                                                                                                                          
  2326 │       │       │       │        │       │               │       │        the resulting size will be rounded up.                                                                                                                                                                                            
  2327 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2328 │       │       │       │        │       │               │       │        :param factor: A greater than 0 integer or tuple of two integers                                                                                                                                                                  
  2329 │       │       │       │        │       │               │       │           for width and height separately.                                                                                                                                                                                               
  2330 │       │       │       │        │       │               │       │        :param box: An optional 4-tuple of ints providing                                                                                                                                                                                 
  2331 │       │       │       │        │       │               │       │           the source image region to be reduced.                                                                                                                                                                                         
  2332 │       │       │       │        │       │               │       │           The values must be within ``(0, 0, width, height)`` rectangle.                                                                                                                                                                 
  2333 │       │       │       │        │       │               │       │           If omitted or ``None``, the entire source is used.                                                                                                                                                                             
  2334 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2335 │       │       │       │        │       │               │       │        if not isinstance(factor, (list, tuple)):                                                                                                                                                                                         
  2336 │       │       │       │        │       │               │       │            factor = (factor, factor)                                                                                                                                                                                                     
  2337 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2338 │       │       │       │        │       │               │       │        if box is None:                                                                                                                                                                                                                   
  2339 │       │       │       │        │       │               │       │            box = (0, 0) + self.size                                                                                                                                                                                                      
  2340 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2341 │       │       │       │        │       │               │       │        if factor == (1, 1) and box == (0, 0) + self.size:                                                                                                                                                                                
  2342 │       │       │       │        │       │               │       │            return self.copy()                                                                                                                                                                                                            
  2343 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2344 │       │       │       │        │       │               │       │        if self.mode in ["LA", "RGBA"]:                                                                                                                                                                                                   
  2345 │       │       │       │        │       │               │       │            im = self.convert({"LA": "La", "RGBA": "RGBa"}[self.mode])                                                                                                                                                                    
  2346 │       │       │       │        │       │               │       │            im = im.reduce(factor, box)                                                                                                                                                                                                   
  2347 │       │       │       │        │       │               │       │            return im.convert(self.mode)                                                                                                                                                                                                  
  2348 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2349 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  2350 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2351 │       │       │       │        │       │               │       │        return self._new(self.im.reduce(factor, box))                                                                                                                                                                                     
  2352 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2353 │       │       │       │        │       │               │       │    def rotate(                                                                                                                                                                                                                           
  2354 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  2355 │       │       │       │        │       │               │       │        angle: float,                                                                                                                                                                                                                     
  2356 │       │       │       │        │       │               │       │        resample: Resampling = Resampling.NEAREST,                                                                                                                                                                                        
  2357 │       │       │       │        │       │               │       │        expand: int | bool = False,                                                                                                                                                                                                       
  2358 │       │       │       │        │       │               │       │        center: tuple[float, float] | None = None,                                                                                                                                                                                        
  2359 │       │       │       │        │       │               │       │        translate: tuple[int, int] | None = None,                                                                                                                                                                                         
  2360 │       │       │       │        │       │               │       │        fillcolor: float | tuple[float, ...] | str | None = None,                                                                                                                                                                         
  2361 │       │       │       │        │       │               │       │    ) -> Image:                                                                                                                                                                                                                           
  2362 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2363 │       │       │       │        │       │               │       │        Returns a rotated copy of this image.  This method returns a                                                                                                                                                                      
  2364 │       │       │       │        │       │               │       │        copy of this image, rotated the given number of degrees counter                                                                                                                                                                   
  2365 │       │       │       │        │       │               │       │        clockwise around its centre.                                                                                                                                                                                                      
  2366 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2367 │       │       │       │        │       │               │       │        :param angle: In degrees counter clockwise.                                                                                                                                                                                       
  2368 │       │       │       │        │       │               │       │        :param resample: An optional resampling filter.  This can be                                                                                                                                                                      
  2369 │       │       │       │        │       │               │       │           one of :py:data:`Resampling.NEAREST` (use nearest neighbour),                                                                                                                                                                  
  2370 │       │       │       │        │       │               │       │           :py:data:`Resampling.BILINEAR` (linear interpolation in a 2x2                                                                                                                                                                  
  2371 │       │       │       │        │       │               │       │           environment), or :py:data:`Resampling.BICUBIC` (cubic spline                                                                                                                                                                   
  2372 │       │       │       │        │       │               │       │           interpolation in a 4x4 environment). If omitted, or if the image has                                                                                                                                                           
  2373 │       │       │       │        │       │               │       │           mode "1" or "P", it is set to :py:data:`Resampling.NEAREST`.                                                                                                                                                                   
  2374 │       │       │       │        │       │               │       │           See :ref:`concept-filters`.                                                                                                                                                                                                    
  2375 │       │       │       │        │       │               │       │        :param expand: Optional expansion flag.  If true, expands the output                                                                                                                                                              
  2376 │       │       │       │        │       │               │       │           image to make it large enough to hold the entire rotated image.                                                                                                                                                                
  2377 │       │       │       │        │       │               │       │           If false or omitted, make the output image the same size as the                                                                                                                                                                
  2378 │       │       │       │        │       │               │       │           input image.  Note that the expand flag assumes rotation around                                                                                                                                                                
  2379 │       │       │       │        │       │               │       │           the center and no translation.                                                                                                                                                                                                 
  2380 │       │       │       │        │       │               │       │        :param center: Optional center of rotation (a 2-tuple).  Origin is                                                                                                                                                                
  2381 │       │       │       │        │       │               │       │           the upper left corner.  Default is the center of the image.                                                                                                                                                                    
  2382 │       │       │       │        │       │               │       │        :param translate: An optional post-rotate translation (a 2-tuple).                                                                                                                                                                
  2383 │       │       │       │        │       │               │       │        :param fillcolor: An optional color for area outside the rotated image.                                                                                                                                                           
  2384 │       │       │       │        │       │               │       │        :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                 
  2385 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2386 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2387 │       │       │       │        │       │               │       │        angle = angle % 360.0                                                                                                                                                                                                             
  2388 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2389 │       │       │       │        │       │               │       │        # Fast paths regardless of filter, as long as we're not                                                                                                                                                                           
  2390 │       │       │       │        │       │               │       │        # translating or changing the center.                                                                                                                                                                                             
  2391 │       │       │       │        │       │               │       │        if not (center or translate):                                                                                                                                                                                                     
  2392 │       │       │       │        │       │               │       │            if angle == 0:                                                                                                                                                                                                                
  2393 │       │       │       │        │       │               │       │                return self.copy()                                                                                                                                                                                                        
  2394 │       │       │       │        │       │               │       │            if angle == 180:                                                                                                                                                                                                              
  2395 │       │       │       │        │       │               │       │                return self.transpose(Transpose.ROTATE_180)                                                                                                                                                                               
  2396 │       │       │       │        │       │               │       │            if angle in (90, 270) and (expand or self.width == self.height):                                                                                                                                                              
  2397 │       │       │       │        │       │               │       │                return self.transpose(                                                                                                                                                                                                    
  2398 │       │       │       │        │       │               │       │                    Transpose.ROTATE_90 if angle == 90 else Transpose.ROTATE_270                                                                                                                                                          
  2399 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  2400 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2401 │       │       │       │        │       │               │       │        # Calculate the affine matrix.  Note that this is the reverse                                                                                                                                                                     
  2402 │       │       │       │        │       │               │       │        # transformation (from destination image to source) because we                                                                                                                                                                    
  2403 │       │       │       │        │       │               │       │        # want to interpolate the (discrete) destination pixel from                                                                                                                                                                       
  2404 │       │       │       │        │       │               │       │        # the local area around the (floating) source pixel.                                                                                                                                                                              
  2405 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2406 │       │       │       │        │       │               │       │        # The matrix we actually want (note that it operates from the right):                                                                                                                                                             
  2407 │       │       │       │        │       │               │       │        # (1, 0, tx)   (1, 0, cx)   ( cos a, sin a, 0)   (1, 0, -cx)                                                                                                                                                                      
  2408 │       │       │       │        │       │               │       │        # (0, 1, ty) * (0, 1, cy) * (-sin a, cos a, 0) * (0, 1, -cy)                                                                                                                                                                      
  2409 │       │       │       │        │       │               │       │        # (0, 0,  1)   (0, 0,  1)   (     0,     0, 1)   (0, 0,   1)                                                                                                                                                                      
  2410 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2411 │       │       │       │        │       │               │       │        # The reverse matrix is thus:                                                                                                                                                                                                     
  2412 │       │       │       │        │       │               │       │        # (1, 0, cx)   ( cos -a, sin -a, 0)   (1, 0, -cx)   (1, 0, -tx)                                                                                                                                                                   
  2413 │       │       │       │        │       │               │       │        # (0, 1, cy) * (-sin -a, cos -a, 0) * (0, 1, -cy) * (0, 1, -ty)                                                                                                                                                                   
  2414 │       │       │       │        │       │               │       │        # (0, 0,  1)   (      0,      0, 1)   (0, 0,   1)   (0, 0,   1)                                                                                                                                                                   
  2415 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2416 │       │       │       │        │       │               │       │        # In any case, the final translation may be updated at the end to                                                                                                                                                                 
  2417 │       │       │       │        │       │               │       │        # compensate for the expand flag.                                                                                                                                                                                                 
  2418 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2419 │       │       │       │        │       │               │       │        w, h = self.size                                                                                                                                                                                                                  
  2420 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2421 │       │       │       │        │       │               │       │        if translate is None:                                                                                                                                                                                                             
  2422 │       │       │       │        │       │               │       │            post_trans = (0, 0)                                                                                                                                                                                                           
  2423 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  2424 │       │       │       │        │       │               │       │            post_trans = translate                                                                                                                                                                                                        
  2425 │       │       │       │        │       │               │       │        if center is None:                                                                                                                                                                                                                
  2426 │       │       │       │        │       │               │       │            center = (w / 2, h / 2)                                                                                                                                                                                                       
  2427 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2428 │       │       │       │        │       │               │       │        angle = -math.radians(angle)                                                                                                                                                                                                      
  2429 │       │       │       │        │       │               │       │        matrix = [                                                                                                                                                                                                                        
  2430 │       │       │       │        │       │               │       │            round(math.cos(angle), 15),                                                                                                                                                                                                   
  2431 │       │       │       │        │       │               │       │            round(math.sin(angle), 15),                                                                                                                                                                                                   
  2432 │       │       │       │        │       │               │       │            0.0,                                                                                                                                                                                                                          
  2433 │       │       │       │        │       │               │       │            round(-math.sin(angle), 15),                                                                                                                                                                                                  
  2434 │       │       │       │        │       │               │       │            round(math.cos(angle), 15),                                                                                                                                                                                                   
  2435 │       │       │       │        │       │               │       │            0.0,                                                                                                                                                                                                                          
  2436 │       │       │       │        │       │               │       │        ]                                                                                                                                                                                                                                 
  2437 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2438 │       │       │       │        │       │               │       │        def transform(x: float, y: float, matrix: list[float]) -> tuple[float, float]:                                                                                                                                                    
  2439 │       │       │       │        │       │               │       │            (a, b, c, d, e, f) = matrix                                                                                                                                                                                                   
  2440 │       │       │       │        │       │               │       │            return a * x + b * y + c, d * x + e * y + f                                                                                                                                                                                   
  2441 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2442 │       │       │       │        │       │               │       │        matrix[2], matrix[5] = transform(                                                                                                                                                                                                 
  2443 │       │       │       │        │       │               │       │            -center[0] - post_trans[0], -center[1] - post_trans[1], matrix                                                                                                                                                                
  2444 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
  2445 │       │       │       │        │       │               │       │        matrix[2] += center[0]                                                                                                                                                                                                            
  2446 │       │       │       │        │       │               │       │        matrix[5] += center[1]                                                                                                                                                                                                            
  2447 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2448 │       │       │       │        │       │               │       │        if expand:                                                                                                                                                                                                                        
  2449 │       │       │       │        │       │               │       │            # calculate output size                                                                                                                                                                                                       
  2450 │       │       │       │        │       │               │       │            xx = []                                                                                                                                                                                                                       
  2451 │       │       │       │        │       │               │       │            yy = []                                                                                                                                                                                                                       
  2452 │       │       │       │        │       │               │       │            for x, y in ((0, 0), (w, 0), (w, h), (0, h)):                                                                                                                                                                                 
  2453 │       │       │       │        │       │               │       │                transformed_x, transformed_y = transform(x, y, matrix)                                                                                                                                                                    
  2454 │       │       │       │        │       │               │       │                xx.append(transformed_x)                                                                                                                                                                                                  
  2455 │       │       │       │        │       │               │       │                yy.append(transformed_y)                                                                                                                                                                                                  
  2456 │       │       │       │        │       │               │       │            nw = math.ceil(max(xx)) - math.floor(min(xx))                                                                                                                                                                                 
  2457 │       │       │       │        │       │               │       │            nh = math.ceil(max(yy)) - math.floor(min(yy))                                                                                                                                                                                 
  2458 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2459 │       │       │       │        │       │               │       │            # We multiply a translation matrix from the right.  Because of its                                                                                                                                                            
  2460 │       │       │       │        │       │               │       │            # special form, this is the same as taking the image of the                                                                                                                                                                   
  2461 │       │       │       │        │       │               │       │            # translation vector as new translation vector.                                                                                                                                                                               
  2462 │       │       │       │        │       │               │       │            matrix[2], matrix[5] = transform(-(nw - w) / 2.0, -(nh - h) / 2.0, matrix)                                                                                                                                                    
  2463 │       │       │       │        │       │               │       │            w, h = nw, nh                                                                                                                                                                                                                 
  2464 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2465 │       │       │       │        │       │               │       │        return self.transform(                                                                                                                                                                                                            
  2466 │       │       │       │        │       │               │       │            (w, h), Transform.AFFINE, matrix, resample, fillcolor=fillcolor                                                                                                                                                               
  2467 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
  2468 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2469 │       │       │       │        │       │               │       │    def save(                                                                                                                                                                                                                             
  2470 │       │       │       │        │       │               │       │        self, fp: StrOrBytesPath | IO[bytes], format: str | None = None, **params: Any                                                                                                                                                    
  2471 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
  2472 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2473 │       │       │       │        │       │               │       │        Saves this image under the given filename.  If no format is                                                                                                                                                                       
  2474 │       │       │       │        │       │               │       │        specified, the format to use is determined from the filename                                                                                                                                                                      
  2475 │       │       │       │        │       │               │       │        extension, if possible.                                                                                                                                                                                                           
  2476 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2477 │       │       │       │        │       │               │       │        Keyword options can be used to provide additional instructions                                                                                                                                                                    
  2478 │       │       │       │        │       │               │       │        to the writer. If a writer doesn't recognise an option, it is                                                                                                                                                                     
  2479 │       │       │       │        │       │               │       │        silently ignored. The available options are described in the                                                                                                                                                                      
  2480 │       │       │       │        │       │               │       │        :doc:`image format documentation                                                                                                                                                                                                  
  2481 │       │       │       │        │       │               │       │        <../handbook/image-file-formats>` for each writer.                                                                                                                                                                                
  2482 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2483 │       │       │       │        │       │               │       │        You can use a file object instead of a filename. In this case,                                                                                                                                                                    
  2484 │       │       │       │        │       │               │       │        you must always specify the format. The file object must                                                                                                                                                                          
  2485 │       │       │       │        │       │               │       │        implement the ``seek``, ``tell``, and ``write``                                                                                                                                                                                   
  2486 │       │       │       │        │       │               │       │        methods, and be opened in binary mode.                                                                                                                                                                                            
  2487 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2488 │       │       │       │        │       │               │       │        :param fp: A filename (string), os.PathLike object or file object.                                                                                                                                                                
  2489 │       │       │       │        │       │               │       │        :param format: Optional format override.  If omitted, the                                                                                                                                                                         
  2490 │       │       │       │        │       │               │       │           format to use is determined from the filename extension.                                                                                                                                                                       
  2491 │       │       │       │        │       │               │       │           If a file object was used instead of a filename, this                                                                                                                                                                          
  2492 │       │       │       │        │       │               │       │           parameter should always be used.                                                                                                                                                                                               
  2493 │       │       │       │        │       │               │       │        :param params: Extra parameters to the image writer. These can also be                                                                                                                                                            
  2494 │       │       │       │        │       │               │       │           set on the image itself through ``encoderinfo``. This is useful when                                                                                                                                                           
  2495 │       │       │       │        │       │               │       │           saving multiple images::                                                                                                                                                                                                       
  2496 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2497 │       │       │       │        │       │               │       │             # Saving XMP data to a single image                                                                                                                                                                                          
  2498 │       │       │       │        │       │               │       │             from PIL import Image                                                                                                                                                                                                        
  2499 │       │       │       │        │       │               │       │             red = Image.new("RGB", (1, 1), "#f00")                                                                                                                                                                                       
  2500 │       │       │       │        │       │               │       │             red.save("out.mpo", xmp=b"test")                                                                                                                                                                                             
  2501 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2502 │       │       │       │        │       │               │       │             # Saving XMP data to the second frame of an image                                                                                                                                                                            
  2503 │       │       │       │        │       │               │       │             from PIL import Image                                                                                                                                                                                                        
  2504 │       │       │       │        │       │               │       │             black = Image.new("RGB", (1, 1))                                                                                                                                                                                             
  2505 │       │       │       │        │       │               │       │             red = Image.new("RGB", (1, 1), "#f00")                                                                                                                                                                                       
  2506 │       │       │       │        │       │               │       │             red.encoderinfo = {"xmp": b"test"}                                                                                                                                                                                           
  2507 │       │       │       │        │       │               │       │             black.save("out.mpo", save_all=True, append_images=[red])                                                                                                                                                                    
  2508 │       │       │       │        │       │               │       │        :returns: None                                                                                                                                                                                                                    
  2509 │       │       │       │        │       │               │       │        :exception ValueError: If the output format could not be determined                                                                                                                                                               
  2510 │       │       │       │        │       │               │       │           from the file name.  Use the format option to solve this.                                                                                                                                                                      
  2511 │       │       │       │        │       │               │       │        :exception OSError: If the file could not be written.  The file                                                                                                                                                                   
  2512 │       │       │       │        │       │               │       │           may have been created, and may contain partial data.                                                                                                                                                                           
  2513 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2514 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2515 │       │       │       │        │       │               │       │        filename: str | bytes = ""                                                                                                                                                                                                        
  2516 │       │       │       │        │       │               │       │        open_fp = False                                                                                                                                                                                                                   
  2517 │       │       │       │        │       │               │       │        if is_path(fp):                                                                                                                                                                                                                   
  2518 │       │       │       │        │       │               │       │            filename = os.fspath(fp)                                                                                                                                                                                                      
  2519 │       │       │       │        │       │               │       │            open_fp = True                                                                                                                                                                                                                
  2520 │       │       │       │        │       │               │       │        elif fp == sys.stdout:                                                                                                                                                                                                            
  2521 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
  2522 │       │       │       │        │       │               │       │                fp = sys.stdout.buffer                                                                                                                                                                                                    
  2523 │       │       │       │        │       │               │       │            except AttributeError:                                                                                                                                                                                                        
  2524 │       │       │       │        │       │               │       │                pass                                                                                                                                                                                                                      
  2525 │       │       │       │        │       │               │       │        if not filename and hasattr(fp, "name") and is_path(fp.name):                                                                                                                                                                     
  2526 │       │       │       │        │       │               │       │            # only set the name for metadata purposes                                                                                                                                                                                     
  2527 │       │       │       │        │       │               │       │            filename = os.fspath(fp.name)                                                                                                                                                                                                 
  2528 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2529 │       │       │       │        │       │               │       │        preinit()                                                                                                                                                                                                                         
  2530 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2531 │       │       │       │        │       │               │       │        filename_ext = os.path.splitext(filename)[1].lower()                                                                                                                                                                              
  2532 │       │       │       │        │       │               │       │        ext = filename_ext.decode() if isinstance(filename_ext, bytes) else filename_ext                                                                                                                                                  
  2533 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2534 │       │       │       │        │       │               │       │        if not format:                                                                                                                                                                                                                    
  2535 │       │       │       │        │       │               │       │            if ext not in EXTENSION:                                                                                                                                                                                                      
  2536 │       │       │       │        │       │               │       │                init()                                                                                                                                                                                                                    
  2537 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
  2538 │       │       │       │        │       │               │       │                format = EXTENSION[ext]                                                                                                                                                                                                   
  2539 │       │       │       │        │       │               │       │            except KeyError as e:                                                                                                                                                                                                         
  2540 │       │       │       │        │       │               │       │                msg = f"unknown file extension: {ext}"                                                                                                                                                                                    
  2541 │       │       │       │        │       │               │       │                raise ValueError(msg) from e                                                                                                                                                                                              
  2542 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2543 │       │       │       │        │       │               │       │        from . import ImageFile                                                                                                                                                                                                           
  2544 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2545 │       │       │       │        │       │               │       │        # may mutate self!                                                                                                                                                                                                                
  2546 │       │       │       │        │       │               │       │        if isinstance(self, ImageFile.ImageFile) and os.path.abspath(                                                                                                                                                                     
  2547 │       │       │       │        │       │               │       │            filename                                                                                                                                                                                                                      
  2548 │       │       │       │        │       │               │       │        ) == os.path.abspath(self.filename):                                                                                                                                                                                              
  2549 │       │       │       │        │       │               │       │            self._ensure_mutable()                                                                                                                                                                                                        
  2550 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  2551 │       │       │       │        │       │               │       │            self.load()                                                                                                                                                                                                                   
  2552 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2553 │       │       │       │        │       │               │       │        save_all = params.pop("save_all", None)                                                                                                                                                                                           
  2554 │       │       │       │        │       │               │       │        self.encoderinfo = {**getattr(self, "encoderinfo", {}), **params}                                                                                                                                                                 
  2555 │       │       │       │        │       │               │       │        self.encoderconfig: tuple[Any, ...] = ()                                                                                                                                                                                          
  2556 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2557 │       │       │       │        │       │               │       │        if format.upper() not in SAVE:                                                                                                                                                                                                    
  2558 │       │       │       │        │       │               │       │            init()                                                                                                                                                                                                                        
  2559 │       │       │       │        │       │               │       │        if save_all or (                                                                                                                                                                                                                  
  2560 │       │       │       │        │       │               │       │            save_all is None                                                                                                                                                                                                              
  2561 │       │       │       │        │       │               │       │            and params.get("append_images")                                                                                                                                                                                               
  2562 │       │       │       │        │       │               │       │            and format.upper() in SAVE_ALL                                                                                                                                                                                                
  2563 │       │       │       │        │       │               │       │        ):                                                                                                                                                                                                                                
  2564 │       │       │       │        │       │               │       │            save_handler = SAVE_ALL[format.upper()]                                                                                                                                                                                       
  2565 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  2566 │       │       │       │        │       │               │       │            save_handler = SAVE[format.upper()]                                                                                                                                                                                           
  2567 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2568 │       │       │       │        │       │               │       │        created = False                                                                                                                                                                                                                   
  2569 │       │       │       │        │       │               │       │        if open_fp:                                                                                                                                                                                                                       
  2570 │       │       │       │        │       │               │       │            created = not os.path.exists(filename)                                                                                                                                                                                        
  2571 │       │       │       │        │       │               │       │            if params.get("append", False):                                                                                                                                                                                               
  2572 │       │       │       │        │       │               │       │                # Open also for reading ("+"), because TIFF save_all                                                                                                                                                                      
  2573 │       │       │       │        │       │               │       │                # writer needs to go back and edit the written data.                                                                                                                                                                      
  2574 │       │       │       │        │       │               │       │                fp = builtins.open(filename, "r+b")                                                                                                                                                                                       
  2575 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  2576 │       │       │       │  96%   │   13M │▁   3%         │       │                fp = builtins.open(filename, "w+b")                                                                                                                                                                                       
  2577 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  2578 │       │       │       │        │       │               │       │            fp = cast(IO[bytes], fp)                                                                                                                                                                                                      
  2579 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2580 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  2581 │       │       │       │        │       │               │       │            save_handler(self, fp, filename)                                                                                                                                                                                              
  2582 │       │       │       │        │       │               │       │        except Exception:                                                                                                                                                                                                                 
  2583 │       │       │       │        │       │               │       │            if open_fp:                                                                                                                                                                                                                   
  2584 │       │       │       │        │       │               │       │                fp.close()                                                                                                                                                                                                                
  2585 │       │       │       │        │       │               │       │            if created:                                                                                                                                                                                                                   
  2586 │       │       │       │        │       │               │       │                try:                                                                                                                                                                                                                      
  2587 │       │       │       │        │       │               │       │                    os.remove(filename)                                                                                                                                                                                                   
  2588 │       │       │       │        │       │               │       │                except PermissionError:                                                                                                                                                                                                   
  2589 │       │       │       │        │       │               │       │                    pass                                                                                                                                                                                                                  
  2590 │       │       │       │        │       │               │       │            raise                                                                                                                                                                                                                         
  2591 │       │       │       │        │       │               │       │        finally:                                                                                                                                                                                                                          
  2592 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
  2593 │       │       │       │        │       │               │       │                del self.encoderinfo                                                                                                                                                                                                      
  2594 │       │       │       │        │       │               │       │            except AttributeError:                                                                                                                                                                                                        
  2595 │       │       │       │        │       │               │       │                pass                                                                                                                                                                                                                      
  2596 │       │       │       │        │       │               │       │        if open_fp:                                                                                                                                                                                                                       
  2597 │       │       │       │        │       │               │       │            fp.close()                                                                                                                                                                                                                    
  2598 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2599 │       │       │       │        │       │               │       │    def seek(self, frame: int) -> None:                                                                                                                                                                                                   
  2600 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2601 │       │       │       │        │       │               │       │        Seeks to the given frame in this sequence file. If you seek                                                                                                                                                                       
  2602 │       │       │       │        │       │               │       │        beyond the end of the sequence, the method raises an                                                                                                                                                                              
  2603 │       │       │       │        │       │               │       │        ``EOFError`` exception. When a sequence file is opened, the                                                                                                                                                                       
  2604 │       │       │       │        │       │               │       │        library automatically seeks to frame 0.                                                                                                                                                                                           
  2605 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2606 │       │       │       │        │       │               │       │        See :py:meth:`~PIL.Image.Image.tell`.                                                                                                                                                                                             
  2607 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2608 │       │       │       │        │       │               │       │        If defined, :attr:`~PIL.Image.Image.n_frames` refers to the                                                                                                                                                                       
  2609 │       │       │       │        │       │               │       │        number of available frames.                                                                                                                                                                                                       
  2610 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2611 │       │       │       │        │       │               │       │        :param frame: Frame number, starting at 0.                                                                                                                                                                                        
  2612 │       │       │       │        │       │               │       │        :exception EOFError: If the call attempts to seek beyond the end                                                                                                                                                                  
  2613 │       │       │       │        │       │               │       │            of the sequence.                                                                                                                                                                                                              
  2614 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2615 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2616 │       │       │       │        │       │               │       │        # overridden by file handlers                                                                                                                                                                                                     
  2617 │       │       │       │        │       │               │       │        if frame != 0:                                                                                                                                                                                                                    
  2618 │       │       │       │        │       │               │       │            msg = "no more images in file"                                                                                                                                                                                                
  2619 │       │       │       │        │       │               │       │            raise EOFError(msg)                                                                                                                                                                                                           
  2620 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2621 │       │       │       │        │       │               │       │    def show(self, title: str | None = None) -> None:                                                                                                                                                                                     
  2622 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2623 │       │       │       │        │       │               │       │        Displays this image. This method is mainly intended for debugging purposes.                                                                                                                                                       
  2624 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2625 │       │       │       │        │       │               │       │        This method calls :py:func:`PIL.ImageShow.show` internally. You can use                                                                                                                                                           
  2626 │       │       │       │        │       │               │       │        :py:func:`PIL.ImageShow.register` to override its default behaviour.                                                                                                                                                              
  2627 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2628 │       │       │       │        │       │               │       │        The image is first saved to a temporary file. By default, it will be in                                                                                                                                                           
  2629 │       │       │       │        │       │               │       │        PNG format.                                                                                                                                                                                                                       
  2630 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2631 │       │       │       │        │       │               │       │        On Unix, the image is then opened using the **xdg-open**, **display**,                                                                                                                                                            
  2632 │       │       │       │        │       │               │       │        **gm**, **eog** or **xv** utility, depending on which one can be found.                                                                                                                                                           
  2633 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2634 │       │       │       │        │       │               │       │        On macOS, the image is opened with the native Preview application.                                                                                                                                                                
  2635 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2636 │       │       │       │        │       │               │       │        On Windows, the image is opened with the standard PNG display utility.                                                                                                                                                            
  2637 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2638 │       │       │       │        │       │               │       │        :param title: Optional title to use for the image window, where possible.                                                                                                                                                         
  2639 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2640 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2641 │       │       │       │        │       │               │       │        _show(self, title=title)                                                                                                                                                                                                          
  2642 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2643 │       │       │       │        │       │               │       │    def split(self) -> tuple[Image, ...]:                                                                                                                                                                                                 
  2644 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2645 │       │       │       │        │       │               │       │        Split this image into individual bands. This method returns a                                                                                                                                                                     
  2646 │       │       │       │        │       │               │       │        tuple of individual image bands from an image. For example,                                                                                                                                                                       
  2647 │       │       │       │        │       │               │       │        splitting an "RGB" image creates three new images each                                                                                                                                                                            
  2648 │       │       │       │        │       │               │       │        containing a copy of one of the original bands (red, green,                                                                                                                                                                       
  2649 │       │       │       │        │       │               │       │        blue).                                                                                                                                                                                                                            
  2650 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2651 │       │       │       │        │       │               │       │        If you need only one band, :py:meth:`~PIL.Image.Image.getchannel`                                                                                                                                                                 
  2652 │       │       │       │        │       │               │       │        method can be more convenient and faster.                                                                                                                                                                                         
  2653 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2654 │       │       │       │        │       │               │       │        :returns: A tuple containing bands.                                                                                                                                                                                               
  2655 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2656 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2657 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  2658 │       │       │       │        │       │               │       │        if self.im.bands == 1:                                                                                                                                                                                                            
  2659 │       │       │       │        │       │               │       │            return (self.copy(),)                                                                                                                                                                                                         
  2660 │       │       │       │        │       │               │       │        return tuple(map(self._new, self.im.split()))                                                                                                                                                                                     
  2661 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2662 │       │       │       │        │       │               │       │    def getchannel(self, channel: int | str) -> Image:                                                                                                                                                                                    
  2663 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2664 │       │       │       │        │       │               │       │        Returns an image containing a single channel of the source image.                                                                                                                                                                 
  2665 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2666 │       │       │       │        │       │               │       │        :param channel: What channel to return. Could be index                                                                                                                                                                            
  2667 │       │       │       │        │       │               │       │          (0 for "R" channel of "RGB") or channel name                                                                                                                                                                                    
  2668 │       │       │       │        │       │               │       │          ("A" for alpha channel of "RGBA").                                                                                                                                                                                              
  2669 │       │       │       │        │       │               │       │        :returns: An image in "L" mode.                                                                                                                                                                                                   
  2670 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2671 │       │       │       │        │       │               │       │        .. versionadded:: 4.3.0                                                                                                                                                                                                           
  2672 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2673 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  2674 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2675 │       │       │       │        │       │               │       │        if isinstance(channel, str):                                                                                                                                                                                                      
  2676 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
  2677 │       │       │       │        │       │               │       │                channel = self.getbands().index(channel)                                                                                                                                                                                  
  2678 │       │       │       │        │       │               │       │            except ValueError as e:                                                                                                                                                                                                       
  2679 │       │       │       │        │       │               │       │                msg = f'The image has no channel "{channel}"'                                                                                                                                                                             
  2680 │       │       │       │        │       │               │       │                raise ValueError(msg) from e                                                                                                                                                                                              
  2681 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2682 │       │       │       │        │       │               │       │        return self._new(self.im.getband(channel))                                                                                                                                                                                        
  2683 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2684 │       │       │       │        │       │               │       │    def tell(self) -> int:                                                                                                                                                                                                                
  2685 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2686 │       │       │       │        │       │               │       │        Returns the current frame number. See :py:meth:`~PIL.Image.Image.seek`.                                                                                                                                                           
  2687 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2688 │       │       │       │        │       │               │       │        If defined, :attr:`~PIL.Image.Image.n_frames` refers to the                                                                                                                                                                       
  2689 │       │       │       │        │       │               │       │        number of available frames.                                                                                                                                                                                                       
  2690 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2691 │       │       │       │        │       │               │       │        :returns: Frame number, starting with 0.                                                                                                                                                                                          
  2692 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2693 │       │       │       │        │       │               │       │        return 0                                                                                                                                                                                                                          
  2694 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2695 │       │       │       │        │       │               │       │    def thumbnail(                                                                                                                                                                                                                        
  2696 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  2697 │       │       │       │        │       │               │       │        size: tuple[float, float],                                                                                                                                                                                                        
  2698 │       │       │       │        │       │               │       │        resample: Resampling = Resampling.BICUBIC,                                                                                                                                                                                        
  2699 │       │       │       │        │       │               │       │        reducing_gap: float | None = 2.0,                                                                                                                                                                                                 
  2700 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
  2701 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2702 │       │       │       │        │       │               │       │        Make this image into a thumbnail.  This method modifies the                                                                                                                                                                       
  2703 │       │       │       │        │       │               │       │        image to contain a thumbnail version of itself, no larger than                                                                                                                                                                    
  2704 │       │       │       │        │       │               │       │        the given size.  This method calculates an appropriate thumbnail                                                                                                                                                                  
  2705 │       │       │       │        │       │               │       │        size to preserve the aspect of the image, calls the                                                                                                                                                                               
  2706 │       │       │       │        │       │               │       │        :py:meth:`~PIL.Image.Image.draft` method to configure the file reader                                                                                                                                                             
  2707 │       │       │       │        │       │               │       │        (where applicable), and finally resizes the image.                                                                                                                                                                                
  2708 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2709 │       │       │       │        │       │               │       │        Note that this function modifies the :py:class:`~PIL.Image.Image`                                                                                                                                                                 
  2710 │       │       │       │        │       │               │       │        object in place.  If you need to use the full resolution image as well,                                                                                                                                                           
  2711 │       │       │       │        │       │               │       │        apply this method to a :py:meth:`~PIL.Image.Image.copy` of the original                                                                                                                                                           
  2712 │       │       │       │        │       │               │       │        image.                                                                                                                                                                                                                            
  2713 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2714 │       │       │       │        │       │               │       │        :param size: The requested size in pixels, as a 2-tuple:                                                                                                                                                                          
  2715 │       │       │       │        │       │               │       │           (width, height).                                                                                                                                                                                                               
  2716 │       │       │       │        │       │               │       │        :param resample: Optional resampling filter.  This can be one                                                                                                                                                                     
  2717 │       │       │       │        │       │               │       │           of :py:data:`Resampling.NEAREST`, :py:data:`Resampling.BOX`,                                                                                                                                                                   
  2718 │       │       │       │        │       │               │       │           :py:data:`Resampling.BILINEAR`, :py:data:`Resampling.HAMMING`,                                                                                                                                                                 
  2719 │       │       │       │        │       │               │       │           :py:data:`Resampling.BICUBIC` or :py:data:`Resampling.LANCZOS`.                                                                                                                                                                
  2720 │       │       │       │        │       │               │       │           If omitted, it defaults to :py:data:`Resampling.BICUBIC`.                                                                                                                                                                      
  2721 │       │       │       │        │       │               │       │           (was :py:data:`Resampling.NEAREST` prior to version 2.5.0).                                                                                                                                                                    
  2722 │       │       │       │        │       │               │       │           See: :ref:`concept-filters`.                                                                                                                                                                                                   
  2723 │       │       │       │        │       │               │       │        :param reducing_gap: Apply optimization by resizing the image                                                                                                                                                                     
  2724 │       │       │       │        │       │               │       │           in two steps. First, reducing the image by integer times                                                                                                                                                                       
  2725 │       │       │       │        │       │               │       │           using :py:meth:`~PIL.Image.Image.reduce` or                                                                                                                                                                                    
  2726 │       │       │       │        │       │               │       │           :py:meth:`~PIL.Image.Image.draft` for JPEG images.                                                                                                                                                                             
  2727 │       │       │       │        │       │               │       │           Second, resizing using regular resampling. The last step                                                                                                                                                                       
  2728 │       │       │       │        │       │               │       │           changes size no less than by ``reducing_gap`` times.                                                                                                                                                                           
  2729 │       │       │       │        │       │               │       │           ``reducing_gap`` may be None (no first step is performed)                                                                                                                                                                      
  2730 │       │       │       │        │       │               │       │           or should be greater than 1.0. The bigger ``reducing_gap``,                                                                                                                                                                    
  2731 │       │       │       │        │       │               │       │           the closer the result to the fair resampling.                                                                                                                                                                                  
  2732 │       │       │       │        │       │               │       │           The smaller ``reducing_gap``, the faster resizing.                                                                                                                                                                             
  2733 │       │       │       │        │       │               │       │           With ``reducing_gap`` greater or equal to 3.0, the result is                                                                                                                                                                   
  2734 │       │       │       │        │       │               │       │           indistinguishable from fair resampling in most cases.                                                                                                                                                                          
  2735 │       │       │       │        │       │               │       │           The default value is 2.0 (very close to fair resampling                                                                                                                                                                        
  2736 │       │       │       │        │       │               │       │           while still being faster in many cases).                                                                                                                                                                                       
  2737 │       │       │       │        │       │               │       │        :returns: None                                                                                                                                                                                                                    
  2738 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2739 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2740 │       │       │       │        │       │               │       │        provided_size = tuple(map(math.floor, size))                                                                                                                                                                                      
  2741 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2742 │       │       │       │        │       │               │       │        def preserve_aspect_ratio() -> tuple[int, int] | None:                                                                                                                                                                            
  2743 │       │       │       │        │       │               │       │            def round_aspect(number: float, key: Callable[[int], float]) -> int:                                                                                                                                                          
  2744 │       │       │       │        │       │               │       │                return max(min(math.floor(number), math.ceil(number), key=key), 1)                                                                                                                                                        
  2745 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2746 │       │       │       │        │       │               │       │            x, y = provided_size                                                                                                                                                                                                          
  2747 │       │       │       │        │       │               │       │            if x >= self.width and y >= self.height:                                                                                                                                                                                      
  2748 │       │       │       │        │       │               │       │                return None                                                                                                                                                                                                               
  2749 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2750 │       │       │       │        │       │               │       │            aspect = self.width / self.height                                                                                                                                                                                             
  2751 │       │       │       │        │       │               │       │            if x / y >= aspect:                                                                                                                                                                                                           
  2752 │       │       │       │        │       │               │       │                x = round_aspect(y * aspect, key=lambda n: abs(aspect - n / y))                                                                                                                                                           
  2753 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  2754 │       │       │       │        │       │               │       │                y = round_aspect(                                                                                                                                                                                                         
  2755 │       │       │       │        │       │               │       │                    x / aspect, key=lambda n: 0 if n == 0 else abs(aspect - x / n)                                                                                                                                                        
  2756 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  2757 │       │       │       │        │       │               │       │            return x, y                                                                                                                                                                                                                   
  2758 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2759 │       │       │       │        │       │               │       │        preserved_size = preserve_aspect_ratio()                                                                                                                                                                                          
  2760 │       │       │       │        │       │               │       │        if preserved_size is None:                                                                                                                                                                                                        
  2761 │       │       │       │        │       │               │       │            return                                                                                                                                                                                                                        
  2762 │       │       │       │        │       │               │       │        final_size = preserved_size                                                                                                                                                                                                       
  2763 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2764 │       │       │       │        │       │               │       │        box = None                                                                                                                                                                                                                        
  2765 │       │       │       │        │       │               │       │        if reducing_gap is not None:                                                                                                                                                                                                      
  2766 │       │       │       │        │       │               │       │            res = self.draft(                                                                                                                                                                                                             
  2767 │       │       │       │        │       │               │       │                None, (int(size[0] * reducing_gap), int(size[1] * reducing_gap))                                                                                                                                                          
  2768 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  2769 │       │       │       │        │       │               │       │            if res is not None:                                                                                                                                                                                                           
  2770 │       │       │       │        │       │               │       │                box = res[1]                                                                                                                                                                                                              
  2771 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2772 │       │       │       │        │       │               │       │        if self.size != final_size:                                                                                                                                                                                                       
  2773 │       │       │       │        │       │               │       │            im = self.resize(final_size, resample, box=box, reducing_gap=reducing_gap)                                                                                                                                                    
  2774 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2775 │       │       │       │        │       │               │       │            self.im = im.im                                                                                                                                                                                                               
  2776 │       │       │       │        │       │               │       │            self._size = final_size                                                                                                                                                                                                       
  2777 │       │       │       │        │       │               │       │            self._mode = self.im.mode                                                                                                                                                                                                     
  2778 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2779 │       │       │       │        │       │               │       │        self.readonly = 0                                                                                                                                                                                                                 
  2780 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2781 │       │       │       │        │       │               │       │    # FIXME: the different transform methods need further explanation                                                                                                                                                                     
  2782 │       │       │       │        │       │               │       │    # instead of bloating the method docs, add a separate chapter.                                                                                                                                                                        
  2783 │       │       │       │        │       │               │       │    def transform(                                                                                                                                                                                                                        
  2784 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  2785 │       │       │       │        │       │               │       │        size: tuple[int, int],                                                                                                                                                                                                            
  2786 │       │       │       │        │       │               │       │        method: Transform | ImageTransformHandler | SupportsGetData,                                                                                                                                                                      
  2787 │       │       │       │        │       │               │       │        data: Sequence[Any] | None = None,                                                                                                                                                                                                
  2788 │       │       │       │        │       │               │       │        resample: int = Resampling.NEAREST,                                                                                                                                                                                               
  2789 │       │       │       │        │       │               │       │        fill: int = 1,                                                                                                                                                                                                                    
  2790 │       │       │       │        │       │               │       │        fillcolor: float | tuple[float, ...] | str | None = None,                                                                                                                                                                         
  2791 │       │       │       │        │       │               │       │    ) -> Image:                                                                                                                                                                                                                           
  2792 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2793 │       │       │       │        │       │               │       │        Transforms this image.  This method creates a new image with the                                                                                                                                                                  
  2794 │       │       │       │        │       │               │       │        given size, and the same mode as the original, and copies data                                                                                                                                                                    
  2795 │       │       │       │        │       │               │       │        to the new image using the given transform.                                                                                                                                                                                       
  2796 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2797 │       │       │       │        │       │               │       │        :param size: The output size in pixels, as a 2-tuple:                                                                                                                                                                             
  2798 │       │       │       │        │       │               │       │           (width, height).                                                                                                                                                                                                               
  2799 │       │       │       │        │       │               │       │        :param method: The transformation method.  This is one of                                                                                                                                                                         
  2800 │       │       │       │        │       │               │       │          :py:data:`Transform.EXTENT` (cut out a rectangular subregion),                                                                                                                                                                  
  2801 │       │       │       │        │       │               │       │          :py:data:`Transform.AFFINE` (affine transform),                                                                                                                                                                                 
  2802 │       │       │       │        │       │               │       │          :py:data:`Transform.PERSPECTIVE` (perspective transform),                                                                                                                                                                       
  2803 │       │       │       │        │       │               │       │          :py:data:`Transform.QUAD` (map a quadrilateral to a rectangle), or                                                                                                                                                              
  2804 │       │       │       │        │       │               │       │          :py:data:`Transform.MESH` (map a number of source quadrilaterals                                                                                                                                                                
  2805 │       │       │       │        │       │               │       │          in one operation).                                                                                                                                                                                                              
  2806 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2807 │       │       │       │        │       │               │       │          It may also be an :py:class:`~PIL.Image.ImageTransformHandler`                                                                                                                                                                  
  2808 │       │       │       │        │       │               │       │          object::                                                                                                                                                                                                                        
  2809 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2810 │       │       │       │        │       │               │       │            class Example(Image.ImageTransformHandler):                                                                                                                                                                                   
  2811 │       │       │       │        │       │               │       │                def transform(self, size, data, resample, fill=1):                                                                                                                                                                        
  2812 │       │       │       │        │       │               │       │                    # Return result                                                                                                                                                                                                       
  2813 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2814 │       │       │       │        │       │               │       │          Implementations of :py:class:`~PIL.Image.ImageTransformHandler`                                                                                                                                                                 
  2815 │       │       │       │        │       │               │       │          for some of the :py:class:`Transform` methods are provided                                                                                                                                                                      
  2816 │       │       │       │        │       │               │       │          in :py:mod:`~PIL.ImageTransform`.                                                                                                                                                                                               
  2817 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2818 │       │       │       │        │       │               │       │          It may also be an object with a ``method.getdata`` method                                                                                                                                                                       
  2819 │       │       │       │        │       │               │       │          that returns a tuple supplying new ``method`` and ``data`` values::                                                                                                                                                             
  2820 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2821 │       │       │       │        │       │               │       │            class Example:                                                                                                                                                                                                                
  2822 │       │       │       │        │       │               │       │                def getdata(self):                                                                                                                                                                                                        
  2823 │       │       │       │        │       │               │       │                    method = Image.Transform.EXTENT                                                                                                                                                                                       
  2824 │       │       │       │        │       │               │       │                    data = (0, 0, 100, 100)                                                                                                                                                                                               
  2825 │       │       │       │        │       │               │       │                    return method, data                                                                                                                                                                                                   
  2826 │       │       │       │        │       │               │       │        :param data: Extra data to the transformation method.                                                                                                                                                                             
  2827 │       │       │       │        │       │               │       │        :param resample: Optional resampling filter.  It can be one of                                                                                                                                                                    
  2828 │       │       │       │        │       │               │       │           :py:data:`Resampling.NEAREST` (use nearest neighbour),                                                                                                                                                                         
  2829 │       │       │       │        │       │               │       │           :py:data:`Resampling.BILINEAR` (linear interpolation in a 2x2                                                                                                                                                                  
  2830 │       │       │       │        │       │               │       │           environment), or :py:data:`Resampling.BICUBIC` (cubic spline                                                                                                                                                                   
  2831 │       │       │       │        │       │               │       │           interpolation in a 4x4 environment). If omitted, or if the image                                                                                                                                                               
  2832 │       │       │       │        │       │               │       │           has mode "1" or "P", it is set to :py:data:`Resampling.NEAREST`.                                                                                                                                                               
  2833 │       │       │       │        │       │               │       │           See: :ref:`concept-filters`.                                                                                                                                                                                                   
  2834 │       │       │       │        │       │               │       │        :param fill: If ``method`` is an                                                                                                                                                                                                  
  2835 │       │       │       │        │       │               │       │          :py:class:`~PIL.Image.ImageTransformHandler` object, this is one of                                                                                                                                                             
  2836 │       │       │       │        │       │               │       │          the arguments passed to it. Otherwise, it is unused.                                                                                                                                                                            
  2837 │       │       │       │        │       │               │       │        :param fillcolor: Optional fill color for the area outside the                                                                                                                                                                    
  2838 │       │       │       │        │       │               │       │           transform in the output image.                                                                                                                                                                                                 
  2839 │       │       │       │        │       │               │       │        :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                 
  2840 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2841 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2842 │       │       │       │        │       │               │       │        if self.mode in ("LA", "RGBA") and resample != Resampling.NEAREST:                                                                                                                                                                
  2843 │       │       │       │        │       │               │       │            return (                                                                                                                                                                                                                      
  2844 │       │       │       │        │       │               │       │                self.convert({"LA": "La", "RGBA": "RGBa"}[self.mode])                                                                                                                                                                     
  2845 │       │       │       │        │       │               │       │                .transform(size, method, data, resample, fill, fillcolor)                                                                                                                                                                 
  2846 │       │       │       │        │       │               │       │                .convert(self.mode)                                                                                                                                                                                                       
  2847 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  2848 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2849 │       │       │       │        │       │               │       │        if isinstance(method, ImageTransformHandler):                                                                                                                                                                                     
  2850 │       │       │       │        │       │               │       │            return method.transform(size, self, resample=resample, fill=fill)                                                                                                                                                             
  2851 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2852 │       │       │       │        │       │               │       │        if hasattr(method, "getdata"):                                                                                                                                                                                                    
  2853 │       │       │       │        │       │               │       │            # compatibility w. old-style transform objects                                                                                                                                                                                
  2854 │       │       │       │        │       │               │       │            method, data = method.getdata()                                                                                                                                                                                               
  2855 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2856 │       │       │       │        │       │               │       │        if data is None:                                                                                                                                                                                                                  
  2857 │       │       │       │        │       │               │       │            msg = "missing method data"                                                                                                                                                                                                   
  2858 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  2859 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2860 │       │       │       │        │       │               │       │        im = new(self.mode, size, fillcolor)                                                                                                                                                                                              
  2861 │       │       │       │        │       │               │       │        if self.mode == "P" and self.palette:                                                                                                                                                                                             
  2862 │       │       │       │        │       │               │       │            im.palette = self.palette.copy()                                                                                                                                                                                              
  2863 │       │       │       │        │       │               │       │        im.info = self.info.copy()                                                                                                                                                                                                        
  2864 │       │       │       │        │       │               │       │        if method == Transform.MESH:                                                                                                                                                                                                      
  2865 │       │       │       │        │       │               │       │            # list of quads                                                                                                                                                                                                               
  2866 │       │       │       │        │       │               │       │            for box, quad in data:                                                                                                                                                                                                        
  2867 │       │       │       │        │       │               │       │                im.__transformer(                                                                                                                                                                                                         
  2868 │       │       │       │        │       │               │       │                    box, self, Transform.QUAD, quad, resample, fillcolor is None                                                                                                                                                          
  2869 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  2870 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  2871 │       │       │       │        │       │               │       │            im.__transformer(                                                                                                                                                                                                             
  2872 │       │       │       │        │       │               │       │                (0, 0) + size, self, method, data, resample, fillcolor is None                                                                                                                                                            
  2873 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  2874 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2875 │       │       │       │        │       │               │       │        return im                                                                                                                                                                                                                         
  2876 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2877 │       │       │       │        │       │               │       │    def __transformer(                                                                                                                                                                                                                    
  2878 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  2879 │       │       │       │        │       │               │       │        box: tuple[int, int, int, int],                                                                                                                                                                                                   
  2880 │       │       │       │        │       │               │       │        image: Image,                                                                                                                                                                                                                     
  2881 │       │       │       │        │       │               │       │        method: Transform,                                                                                                                                                                                                                
  2882 │       │       │       │        │       │               │       │        data: Sequence[float],                                                                                                                                                                                                            
  2883 │       │       │       │        │       │               │       │        resample: int = Resampling.NEAREST,                                                                                                                                                                                               
  2884 │       │       │       │        │       │               │       │        fill: bool = True,                                                                                                                                                                                                                
  2885 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
  2886 │       │       │       │        │       │               │       │        w = box[2] - box[0]                                                                                                                                                                                                               
  2887 │       │       │       │        │       │               │       │        h = box[3] - box[1]                                                                                                                                                                                                               
  2888 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2889 │       │       │       │        │       │               │       │        if method == Transform.AFFINE:                                                                                                                                                                                                    
  2890 │       │       │       │        │       │               │       │            data = data[:6]                                                                                                                                                                                                               
  2891 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2892 │       │       │       │        │       │               │       │        elif method == Transform.EXTENT:                                                                                                                                                                                                  
  2893 │       │       │       │        │       │               │       │            # convert extent to an affine transform                                                                                                                                                                                       
  2894 │       │       │       │        │       │               │       │            x0, y0, x1, y1 = data                                                                                                                                                                                                         
  2895 │       │       │       │        │       │               │       │            xs = (x1 - x0) / w                                                                                                                                                                                                            
  2896 │       │       │       │        │       │               │       │            ys = (y1 - y0) / h                                                                                                                                                                                                            
  2897 │       │       │       │        │       │               │       │            method = Transform.AFFINE                                                                                                                                                                                                     
  2898 │       │       │       │        │       │               │       │            data = (xs, 0, x0, 0, ys, y0)                                                                                                                                                                                                 
  2899 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2900 │       │       │       │        │       │               │       │        elif method == Transform.PERSPECTIVE:                                                                                                                                                                                             
  2901 │       │       │       │        │       │               │       │            data = data[:8]                                                                                                                                                                                                               
  2902 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2903 │       │       │       │        │       │               │       │        elif method == Transform.QUAD:                                                                                                                                                                                                    
  2904 │       │       │       │        │       │               │       │            # quadrilateral warp.  data specifies the four corners                                                                                                                                                                        
  2905 │       │       │       │        │       │               │       │            # given as NW, SW, SE, and NE.                                                                                                                                                                                                
  2906 │       │       │       │        │       │               │       │            nw = data[:2]                                                                                                                                                                                                                 
  2907 │       │       │       │        │       │               │       │            sw = data[2:4]                                                                                                                                                                                                                
  2908 │       │       │       │        │       │               │       │            se = data[4:6]                                                                                                                                                                                                                
  2909 │       │       │       │        │       │               │       │            ne = data[6:8]                                                                                                                                                                                                                
  2910 │       │       │       │        │       │               │       │            x0, y0 = nw                                                                                                                                                                                                                   
  2911 │       │       │       │        │       │               │       │            As = 1.0 / w                                                                                                                                                                                                                  
  2912 │       │       │       │        │       │               │       │            At = 1.0 / h                                                                                                                                                                                                                  
  2913 │       │       │       │        │       │               │       │            data = (                                                                                                                                                                                                                      
  2914 │       │       │       │        │       │               │       │                x0,                                                                                                                                                                                                                       
  2915 │       │       │       │        │       │               │       │                (ne[0] - x0) * As,                                                                                                                                                                                                        
  2916 │       │       │       │        │       │               │       │                (sw[0] - x0) * At,                                                                                                                                                                                                        
  2917 │       │       │       │        │       │               │       │                (se[0] - sw[0] - ne[0] + x0) * As * At,                                                                                                                                                                                   
  2918 │       │       │       │        │       │               │       │                y0,                                                                                                                                                                                                                       
  2919 │       │       │       │        │       │               │       │                (ne[1] - y0) * As,                                                                                                                                                                                                        
  2920 │       │       │       │        │       │               │       │                (sw[1] - y0) * At,                                                                                                                                                                                                        
  2921 │       │       │       │        │       │               │       │                (se[1] - sw[1] - ne[1] + y0) * As * At,                                                                                                                                                                                   
  2922 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  2923 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2924 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  2925 │       │       │       │        │       │               │       │            msg = "unknown transformation method"                                                                                                                                                                                         
  2926 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  2927 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2928 │       │       │       │        │       │               │       │        if resample not in (                                                                                                                                                                                                              
  2929 │       │       │       │        │       │               │       │            Resampling.NEAREST,                                                                                                                                                                                                           
  2930 │       │       │       │        │       │               │       │            Resampling.BILINEAR,                                                                                                                                                                                                          
  2931 │       │       │       │        │       │               │       │            Resampling.BICUBIC,                                                                                                                                                                                                           
  2932 │       │       │       │        │       │               │       │        ):                                                                                                                                                                                                                                
  2933 │       │       │       │        │       │               │       │            if resample in (Resampling.BOX, Resampling.HAMMING, Resampling.LANCZOS):                                                                                                                                                      
  2934 │       │       │       │        │       │               │       │                unusable: dict[int, str] = {                                                                                                                                                                                              
  2935 │       │       │       │        │       │               │       │                    Resampling.BOX: "Image.Resampling.BOX",                                                                                                                                                                               
  2936 │       │       │       │        │       │               │       │                    Resampling.HAMMING: "Image.Resampling.HAMMING",                                                                                                                                                                       
  2937 │       │       │       │        │       │               │       │                    Resampling.LANCZOS: "Image.Resampling.LANCZOS",                                                                                                                                                                       
  2938 │       │       │       │        │       │               │       │                }                                                                                                                                                                                                                         
  2939 │       │       │       │        │       │               │       │                msg = unusable[resample] + f" ({resample}) cannot be used."                                                                                                                                                               
  2940 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  2941 │       │       │       │        │       │               │       │                msg = f"Unknown resampling filter ({resample})."                                                                                                                                                                          
  2942 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2943 │       │       │       │        │       │               │       │            filters = [                                                                                                                                                                                                                   
  2944 │       │       │       │        │       │               │       │                f"{filter[1]} ({filter[0]})"                                                                                                                                                                                              
  2945 │       │       │       │        │       │               │       │                for filter in (                                                                                                                                                                                                           
  2946 │       │       │       │        │       │               │       │                    (Resampling.NEAREST, "Image.Resampling.NEAREST"),                                                                                                                                                                     
  2947 │       │       │       │        │       │               │       │                    (Resampling.BILINEAR, "Image.Resampling.BILINEAR"),                                                                                                                                                                   
  2948 │       │       │       │        │       │               │       │                    (Resampling.BICUBIC, "Image.Resampling.BICUBIC"),                                                                                                                                                                     
  2949 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  2950 │       │       │       │        │       │               │       │            ]                                                                                                                                                                                                                             
  2951 │       │       │       │        │       │               │       │            msg += f" Use {', '.join(filters[:-1])} or {filters[-1]}"                                                                                                                                                                     
  2952 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  2953 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2954 │       │       │       │        │       │               │       │        image.load()                                                                                                                                                                                                                      
  2955 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2956 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  2957 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2958 │       │       │       │        │       │               │       │        if image.mode in ("1", "P"):                                                                                                                                                                                                      
  2959 │       │       │       │        │       │               │       │            resample = Resampling.NEAREST                                                                                                                                                                                                 
  2960 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2961 │       │       │       │        │       │               │       │        self.im.transform(box, image.im, method, data, resample, fill)                                                                                                                                                                    
  2962 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2963 │       │       │       │        │       │               │       │    def transpose(self, method: Transpose) -> Image:                                                                                                                                                                                      
  2964 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2965 │       │       │       │        │       │               │       │        Transpose image (flip or rotate in 90 degree steps)                                                                                                                                                                               
  2966 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2967 │       │       │       │        │       │               │       │        :param method: One of :py:data:`Transpose.FLIP_LEFT_RIGHT`,                                                                                                                                                                       
  2968 │       │       │       │        │       │               │       │          :py:data:`Transpose.FLIP_TOP_BOTTOM`, :py:data:`Transpose.ROTATE_90`,                                                                                                                                                           
  2969 │       │       │       │        │       │               │       │          :py:data:`Transpose.ROTATE_180`, :py:data:`Transpose.ROTATE_270`,                                                                                                                                                               
  2970 │       │       │       │        │       │               │       │          :py:data:`Transpose.TRANSPOSE` or :py:data:`Transpose.TRANSVERSE`.                                                                                                                                                              
  2971 │       │       │       │        │       │               │       │        :returns: Returns a flipped or rotated copy of this image.                                                                                                                                                                        
  2972 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2973 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2974 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  2975 │       │       │       │        │       │               │       │        return self._new(self.im.transpose(method))                                                                                                                                                                                       
  2976 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2977 │       │       │       │        │       │               │       │    def effect_spread(self, distance: int) -> Image:                                                                                                                                                                                      
  2978 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2979 │       │       │       │        │       │               │       │        Randomly spread pixels in an image.                                                                                                                                                                                               
  2980 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2981 │       │       │       │        │       │               │       │        :param distance: Distance to spread pixels.                                                                                                                                                                                       
  2982 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  2983 │       │       │       │        │       │               │       │        self.load()                                                                                                                                                                                                                       
  2984 │       │       │       │        │       │               │       │        return self._new(self.im.effect_spread(distance))                                                                                                                                                                                 
  2985 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2986 │       │       │       │        │       │               │       │    def toqimage(self) -> ImageQt.ImageQt:                                                                                                                                                                                                
  2987 │       │       │       │        │       │               │       │        """Returns a QImage copy of this image"""                                                                                                                                                                                         
  2988 │       │       │       │        │       │               │       │        from . import ImageQt                                                                                                                                                                                                             
  2989 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2990 │       │       │       │        │       │               │       │        if not ImageQt.qt_is_installed:                                                                                                                                                                                                   
  2991 │       │       │       │        │       │               │       │            msg = "Qt bindings are not installed"                                                                                                                                                                                         
  2992 │       │       │       │        │       │               │       │            raise ImportError(msg)                                                                                                                                                                                                        
  2993 │       │       │       │        │       │               │       │        return ImageQt.toqimage(self)                                                                                                                                                                                                     
  2994 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2995 │       │       │       │        │       │               │       │    def toqpixmap(self) -> ImageQt.QPixmap:                                                                                                                                                                                               
  2996 │       │       │       │        │       │               │       │        """Returns a QPixmap copy of this image"""                                                                                                                                                                                        
  2997 │       │       │       │        │       │               │       │        from . import ImageQt                                                                                                                                                                                                             
  2998 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  2999 │       │       │       │        │       │               │       │        if not ImageQt.qt_is_installed:                                                                                                                                                                                                   
  3000 │       │       │       │        │       │               │       │            msg = "Qt bindings are not installed"                                                                                                                                                                                         
  3001 │       │       │       │        │       │               │       │            raise ImportError(msg)                                                                                                                                                                                                        
  3002 │       │       │       │        │       │               │       │        return ImageQt.toqpixmap(self)                                                                                                                                                                                                    
  3003 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3004 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3005 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
  3006 │       │       │       │        │       │               │       │# Abstract handlers.                                                                                                                                                                                                                      
  3007 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3008 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3009 │       │       │       │        │       │               │       │class ImagePointHandler(abc.ABC):                                                                                                                                                                                                         
  3010 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3011 │       │       │       │        │       │               │       │    Used as a mixin by point transforms                                                                                                                                                                                                   
  3012 │       │       │       │        │       │               │       │    (for use with :py:meth:`~PIL.Image.Image.point`)                                                                                                                                                                                      
  3013 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3014 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3015 │       │       │       │        │       │               │       │    @abc.abstractmethod                                                                                                                                                                                                                   
  3016 │       │       │       │        │       │               │       │    def point(self, im: Image) -> Image:                                                                                                                                                                                                  
  3017 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
  3018 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3019 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3020 │       │       │       │        │       │               │       │class ImageTransformHandler(abc.ABC):                                                                                                                                                                                                     
  3021 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3022 │       │       │       │        │       │               │       │    Used as a mixin by geometry transforms                                                                                                                                                                                                
  3023 │       │       │       │        │       │               │       │    (for use with :py:meth:`~PIL.Image.Image.transform`)                                                                                                                                                                                  
  3024 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3025 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3026 │       │       │       │        │       │               │       │    @abc.abstractmethod                                                                                                                                                                                                                   
  3027 │       │       │       │        │       │               │       │    def transform(                                                                                                                                                                                                                        
  3028 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  3029 │       │       │       │        │       │               │       │        size: tuple[int, int],                                                                                                                                                                                                            
  3030 │       │       │       │        │       │               │       │        image: Image,                                                                                                                                                                                                                     
  3031 │       │       │       │        │       │               │       │        **options: Any,                                                                                                                                                                                                                   
  3032 │       │       │       │        │       │               │       │    ) -> Image:                                                                                                                                                                                                                           
  3033 │       │       │       │        │       │               │       │        pass                                                                                                                                                                                                                              
  3034 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3035 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3036 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
  3037 │       │       │       │        │       │               │       │# Factories                                                                                                                                                                                                                               
  3038 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3039 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3040 │       │       │       │        │       │               │       │def _check_size(size: Any) -> None:                                                                                                                                                                                                       
  3041 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3042 │       │       │       │        │       │               │       │    Common check to enforce type and sanity check on size tuples                                                                                                                                                                          
  3043 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3044 │       │       │       │        │       │               │       │    :param size: Should be a 2 tuple of (width, height)                                                                                                                                                                                   
  3045 │       │       │       │        │       │               │       │    :returns: None, or raises a ValueError                                                                                                                                                                                                
  3046 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3047 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3048 │       │       │       │        │       │               │       │    if not isinstance(size, (list, tuple)):                                                                                                                                                                                               
  3049 │       │       │       │        │       │               │       │        msg = "Size must be a list or tuple"                                                                                                                                                                                              
  3050 │       │       │       │        │       │               │       │        raise ValueError(msg)                                                                                                                                                                                                             
  3051 │       │       │       │        │       │               │       │    if len(size) != 2:                                                                                                                                                                                                                    
  3052 │       │       │       │        │       │               │       │        msg = "Size must be a sequence of length 2"                                                                                                                                                                                       
  3053 │       │       │       │        │       │               │       │        raise ValueError(msg)                                                                                                                                                                                                             
  3054 │       │       │       │        │       │               │       │    if size[0] < 0 or size[1] < 0:                                                                                                                                                                                                        
  3055 │       │       │       │        │       │               │       │        msg = "Width and height must be >= 0"                                                                                                                                                                                             
  3056 │       │       │       │        │       │               │       │        raise ValueError(msg)                                                                                                                                                                                                             
  3057 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3058 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3059 │       │       │       │        │       │               │       │def new(                                                                                                                                                                                                                                  
  3060 │       │       │       │        │       │               │       │    mode: str,                                                                                                                                                                                                                            
  3061 │       │       │       │        │       │               │       │    size: tuple[int, int] | list[int],                                                                                                                                                                                                    
  3062 │       │       │       │        │       │               │       │    color: float | tuple[float, ...] | str | None = 0,                                                                                                                                                                                    
  3063 │       │       │       │        │       │               │       │) -> Image:                                                                                                                                                                                                                               
  3064 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3065 │       │       │       │        │       │               │       │    Creates a new image with the given mode and size.                                                                                                                                                                                     
  3066 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3067 │       │       │       │        │       │               │       │    :param mode: The mode to use for the new image. See:                                                                                                                                                                                  
  3068 │       │       │       │        │       │               │       │       :ref:`concept-modes`.                                                                                                                                                                                                              
  3069 │       │       │       │        │       │               │       │    :param size: A 2-tuple, containing (width, height) in pixels.                                                                                                                                                                         
  3070 │       │       │       │        │       │               │       │    :param color: What color to use for the image.  Default is black.                                                                                                                                                                     
  3071 │       │       │       │        │       │               │       │       If given, this should be a single integer or floating point value                                                                                                                                                                  
  3072 │       │       │       │        │       │               │       │       for single-band modes, and a tuple for multi-band modes (one value                                                                                                                                                                 
  3073 │       │       │       │        │       │               │       │       per band).  When creating RGB or HSV images, you can also use color                                                                                                                                                                
  3074 │       │       │       │        │       │               │       │       strings as supported by the ImageColor module.  If the color is                                                                                                                                                                    
  3075 │       │       │       │        │       │               │       │       None, the image is not initialised.                                                                                                                                                                                                
  3076 │       │       │       │        │       │               │       │    :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                     
  3077 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3078 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3079 │       │       │       │        │       │               │       │    if mode in ("BGR;15", "BGR;16", "BGR;24"):                                                                                                                                                                                            
  3080 │       │       │       │        │       │               │       │        deprecate(mode, 12)                                                                                                                                                                                                               
  3081 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3082 │       │       │       │        │       │               │       │    _check_size(size)                                                                                                                                                                                                                     
  3083 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3084 │       │       │       │        │       │               │       │    if color is None:                                                                                                                                                                                                                     
  3085 │       │       │       │        │       │               │       │        # don't initialize                                                                                                                                                                                                                
  3086 │       │       │       │        │       │               │       │        return Image()._new(core.new(mode, size))                                                                                                                                                                                         
  3087 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3088 │       │       │       │        │       │               │       │    if isinstance(color, str):                                                                                                                                                                                                            
  3089 │       │       │       │        │       │               │       │        # css3-style specifier                                                                                                                                                                                                            
  3090 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3091 │       │       │       │        │       │               │       │        from . import ImageColor                                                                                                                                                                                                          
  3092 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3093 │       │       │       │        │       │               │       │        color = ImageColor.getcolor(color, mode)                                                                                                                                                                                          
  3094 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3095 │       │       │       │        │       │               │       │    im = Image()                                                                                                                                                                                                                          
  3096 │       │       │       │        │       │               │       │    if (                                                                                                                                                                                                                                  
  3097 │       │       │       │        │       │               │       │        mode == "P"                                                                                                                                                                                                                       
  3098 │       │       │       │        │       │               │       │        and isinstance(color, (list, tuple))                                                                                                                                                                                              
  3099 │       │       │       │        │       │               │       │        and all(isinstance(i, int) for i in color)                                                                                                                                                                                        
  3100 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
  3101 │       │       │       │        │       │               │       │        color_ints: tuple[int, ...] = cast(tuple[int, ...], tuple(color))                                                                                                                                                                 
  3102 │       │       │       │        │       │               │       │        if len(color_ints) == 3 or len(color_ints) == 4:                                                                                                                                                                                  
  3103 │       │       │       │        │       │               │       │            # RGB or RGBA value for a P image                                                                                                                                                                                             
  3104 │       │       │       │        │       │               │       │            from . import ImagePalette                                                                                                                                                                                                    
  3105 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3106 │       │       │       │        │       │               │       │            im.palette = ImagePalette.ImagePalette()                                                                                                                                                                                      
  3107 │       │       │       │        │       │               │       │            color = im.palette.getcolor(color_ints)                                                                                                                                                                                       
  3108 │       │       │       │        │       │               │       │    return im._new(core.fill(mode, size, color))                                                                                                                                                                                          
  3109 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3110 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3111 │       │       │       │        │       │               │       │def frombytes(                                                                                                                                                                                                                            
  3112 │       │       │       │        │       │               │       │    mode: str,                                                                                                                                                                                                                            
  3113 │       │       │       │        │       │               │       │    size: tuple[int, int],                                                                                                                                                                                                                
  3114 │       │       │       │        │       │               │       │    data: bytes | bytearray | SupportsArrayInterface,                                                                                                                                                                                     
  3115 │       │       │       │        │       │               │       │    decoder_name: str = "raw",                                                                                                                                                                                                            
  3116 │       │       │       │        │       │               │       │    *args: Any,                                                                                                                                                                                                                           
  3117 │       │       │       │        │       │               │       │) -> Image:                                                                                                                                                                                                                               
  3118 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3119 │       │       │       │        │       │               │       │    Creates a copy of an image memory from pixel data in a buffer.                                                                                                                                                                        
  3120 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3121 │       │       │       │        │       │               │       │    In its simplest form, this function takes three arguments                                                                                                                                                                             
  3122 │       │       │       │        │       │               │       │    (mode, size, and unpacked pixel data).                                                                                                                                                                                                
  3123 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3124 │       │       │       │        │       │               │       │    You can also use any pixel decoder supported by PIL. For more                                                                                                                                                                         
  3125 │       │       │       │        │       │               │       │    information on available decoders, see the section                                                                                                                                                                                    
  3126 │       │       │       │        │       │               │       │    :ref:`Writing Your Own File Codec <file-codecs>`.                                                                                                                                                                                     
  3127 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3128 │       │       │       │        │       │               │       │    Note that this function decodes pixel data only, not entire images.                                                                                                                                                                   
  3129 │       │       │       │        │       │               │       │    If you have an entire image in a string, wrap it in a                                                                                                                                                                                 
  3130 │       │       │       │        │       │               │       │    :py:class:`~io.BytesIO` object, and use :py:func:`~PIL.Image.open` to load                                                                                                                                                            
  3131 │       │       │       │        │       │               │       │    it.                                                                                                                                                                                                                                   
  3132 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3133 │       │       │       │        │       │               │       │    :param mode: The image mode. See: :ref:`concept-modes`.                                                                                                                                                                               
  3134 │       │       │       │        │       │               │       │    :param size: The image size.                                                                                                                                                                                                          
  3135 │       │       │       │        │       │               │       │    :param data: A byte buffer containing raw data for the given mode.                                                                                                                                                                    
  3136 │       │       │       │        │       │               │       │    :param decoder_name: What decoder to use.                                                                                                                                                                                             
  3137 │       │       │       │        │       │               │       │    :param args: Additional parameters for the given decoder.                                                                                                                                                                             
  3138 │       │       │       │        │       │               │       │    :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                     
  3139 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3140 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3141 │       │       │       │        │       │               │       │    _check_size(size)                                                                                                                                                                                                                     
  3142 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3143 │       │       │       │        │       │               │       │    im = new(mode, size)                                                                                                                                                                                                                  
  3144 │       │       │       │        │       │               │       │    if im.width != 0 and im.height != 0:                                                                                                                                                                                                  
  3145 │       │       │       │        │       │               │       │        decoder_args: Any = args                                                                                                                                                                                                          
  3146 │       │       │       │        │       │               │       │        if len(decoder_args) == 1 and isinstance(decoder_args[0], tuple):                                                                                                                                                                 
  3147 │       │       │       │        │       │               │       │            # may pass tuple instead of argument list                                                                                                                                                                                     
  3148 │       │       │       │        │       │               │       │            decoder_args = decoder_args[0]                                                                                                                                                                                                
  3149 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3150 │       │       │       │        │       │               │       │        if decoder_name == "raw" and decoder_args == ():                                                                                                                                                                                  
  3151 │       │       │       │        │       │               │       │            decoder_args = mode                                                                                                                                                                                                           
  3152 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3153 │       │       │       │        │       │               │       │        im.frombytes(data, decoder_name, decoder_args)                                                                                                                                                                                    
  3154 │       │       │       │        │       │               │       │    return im                                                                                                                                                                                                                             
  3155 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3156 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3157 │       │       │       │        │       │               │       │def frombuffer(                                                                                                                                                                                                                           
  3158 │       │       │       │        │       │               │       │    mode: str,                                                                                                                                                                                                                            
  3159 │       │       │       │        │       │               │       │    size: tuple[int, int],                                                                                                                                                                                                                
  3160 │       │       │       │        │       │               │       │    data: bytes | SupportsArrayInterface,                                                                                                                                                                                                 
  3161 │       │       │       │        │       │               │       │    decoder_name: str = "raw",                                                                                                                                                                                                            
  3162 │       │       │       │        │       │               │       │    *args: Any,                                                                                                                                                                                                                           
  3163 │       │       │       │        │       │               │       │) -> Image:                                                                                                                                                                                                                               
  3164 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3165 │       │       │       │        │       │               │       │    Creates an image memory referencing pixel data in a byte buffer.                                                                                                                                                                      
  3166 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3167 │       │       │       │        │       │               │       │    This function is similar to :py:func:`~PIL.Image.frombytes`, but uses data                                                                                                                                                            
  3168 │       │       │       │        │       │               │       │    in the byte buffer, where possible.  This means that changes to the                                                                                                                                                                   
  3169 │       │       │       │        │       │               │       │    original buffer object are reflected in this image).  Not all modes can                                                                                                                                                               
  3170 │       │       │       │        │       │               │       │    share memory; supported modes include "L", "RGBX", "RGBA", and "CMYK".                                                                                                                                                                
  3171 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3172 │       │       │       │        │       │               │       │    Note that this function decodes pixel data only, not entire images.                                                                                                                                                                   
  3173 │       │       │       │        │       │               │       │    If you have an entire image file in a string, wrap it in a                                                                                                                                                                            
  3174 │       │       │       │        │       │               │       │    :py:class:`~io.BytesIO` object, and use :py:func:`~PIL.Image.open` to load it.                                                                                                                                                        
  3175 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3176 │       │       │       │        │       │               │       │    The default parameters used for the "raw" decoder differs from that used for                                                                                                                                                          
  3177 │       │       │       │        │       │               │       │    :py:func:`~PIL.Image.frombytes`. This is a bug, and will probably be fixed in a                                                                                                                                                       
  3178 │       │       │       │        │       │               │       │    future release. The current release issues a warning if you do this; to disable                                                                                                                                                       
  3179 │       │       │       │        │       │               │       │    the warning, you should provide the full set of parameters. See below for details.                                                                                                                                                    
  3180 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3181 │       │       │       │        │       │               │       │    :param mode: The image mode. See: :ref:`concept-modes`.                                                                                                                                                                               
  3182 │       │       │       │        │       │               │       │    :param size: The image size.                                                                                                                                                                                                          
  3183 │       │       │       │        │       │               │       │    :param data: A bytes or other buffer object containing raw                                                                                                                                                                            
  3184 │       │       │       │        │       │               │       │        data for the given mode.                                                                                                                                                                                                          
  3185 │       │       │       │        │       │               │       │    :param decoder_name: What decoder to use.                                                                                                                                                                                             
  3186 │       │       │       │        │       │               │       │    :param args: Additional parameters for the given decoder.  For the                                                                                                                                                                    
  3187 │       │       │       │        │       │               │       │        default encoder ("raw"), it's recommended that you provide the                                                                                                                                                                    
  3188 │       │       │       │        │       │               │       │        full set of parameters::                                                                                                                                                                                                          
  3189 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3190 │       │       │       │        │       │               │       │            frombuffer(mode, size, data, "raw", mode, 0, 1)                                                                                                                                                                               
  3191 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3192 │       │       │       │        │       │               │       │    :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                     
  3193 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3194 │       │       │       │        │       │               │       │    .. versionadded:: 1.1.4                                                                                                                                                                                                               
  3195 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3196 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3197 │       │       │       │        │       │               │       │    _check_size(size)                                                                                                                                                                                                                     
  3198 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3199 │       │       │       │        │       │               │       │    # may pass tuple instead of argument list                                                                                                                                                                                             
  3200 │       │       │       │        │       │               │       │    if len(args) == 1 and isinstance(args[0], tuple):                                                                                                                                                                                     
  3201 │       │       │       │        │       │               │       │        args = args[0]                                                                                                                                                                                                                    
  3202 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3203 │       │       │       │        │       │               │       │    if decoder_name == "raw":                                                                                                                                                                                                             
  3204 │       │       │       │        │       │               │       │        if args == ():                                                                                                                                                                                                                    
  3205 │       │       │       │        │       │               │       │            args = mode, 0, 1                                                                                                                                                                                                             
  3206 │       │       │       │        │       │               │       │        if args[0] in _MAPMODES:                                                                                                                                                                                                          
  3207 │       │       │       │        │       │               │       │            im = new(mode, (0, 0))                                                                                                                                                                                                        
  3208 │       │       │       │        │       │               │       │            im = im._new(core.map_buffer(data, size, decoder_name, 0, args))                                                                                                                                                              
  3209 │       │       │       │        │       │               │       │            if mode == "P":                                                                                                                                                                                                               
  3210 │       │       │       │        │       │               │       │                from . import ImagePalette                                                                                                                                                                                                
  3211 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3212 │       │       │       │        │       │               │       │                im.palette = ImagePalette.ImagePalette("RGB", im.im.getpalette("RGB"))                                                                                                                                                    
  3213 │       │       │       │        │       │               │       │            im.readonly = 1                                                                                                                                                                                                               
  3214 │       │       │       │        │       │               │       │            return im                                                                                                                                                                                                                     
  3215 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3216 │       │       │       │        │       │               │       │    return frombytes(mode, size, data, decoder_name, args)                                                                                                                                                                                
  3217 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3218 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3219 │       │       │       │        │       │               │       │class SupportsArrayInterface(Protocol):                                                                                                                                                                                                   
  3220 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3221 │       │       │       │        │       │               │       │    An object that has an ``__array_interface__`` dictionary.                                                                                                                                                                             
  3222 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3223 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3224 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
  3225 │       │       │       │        │       │               │       │    def __array_interface__(self) -> dict[str, Any]:                                                                                                                                                                                      
  3226 │       │       │       │        │       │               │       │        raise NotImplementedError()                                                                                                                                                                                                       
  3227 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3228 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3229 │       │       │       │        │       │               │       │class SupportsArrowArrayInterface(Protocol):                                                                                                                                                                                              
  3230 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3231 │       │       │       │        │       │               │       │    An object that has an ``__arrow_c_array__`` method corresponding to the arrow c                                                                                                                                                       
  3232 │       │       │       │        │       │               │       │    data interface.                                                                                                                                                                                                                       
  3233 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3234 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3235 │       │       │       │        │       │               │       │    def __arrow_c_array__(                                                                                                                                                                                                                
  3236 │       │       │       │        │       │               │       │        self, requested_schema: "PyCapsule" = None  # type: ignore[name-defined]  # noqa: F821, UP037                                                                                                                                     
  3237 │       │       │       │        │       │               │       │    ) -> tuple["PyCapsule", "PyCapsule"]:  # type: ignore[name-defined]  # noqa: F821, UP037                                                                                                                                              
  3238 │       │       │       │        │       │               │       │        raise NotImplementedError()                                                                                                                                                                                                       
  3239 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3240 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3241 │       │       │       │        │       │               │       │def fromarray(obj: SupportsArrayInterface, mode: str | None = None) -> Image:                                                                                                                                                             
  3242 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3243 │       │       │       │        │       │               │       │    Creates an image memory from an object exporting the array interface                                                                                                                                                                  
  3244 │       │       │       │        │       │               │       │    (using the buffer protocol)::                                                                                                                                                                                                         
  3245 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3246 │       │       │       │        │       │               │       │      from PIL import Image                                                                                                                                                                                                               
  3247 │       │       │       │        │       │               │       │      import numpy as np                                                                                                                                                                                                                  
  3248 │       │       │       │        │       │               │       │      a = np.zeros((5, 5))                                                                                                                                                                                                                
  3249 │       │       │       │        │       │               │       │      im = Image.fromarray(a)                                                                                                                                                                                                             
  3250 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3251 │       │       │       │        │       │               │       │    If ``obj`` is not contiguous, then the ``tobytes`` method is called                                                                                                                                                                   
  3252 │       │       │       │        │       │               │       │    and :py:func:`~PIL.Image.frombuffer` is used.                                                                                                                                                                                         
  3253 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3254 │       │       │       │        │       │               │       │    In the case of NumPy, be aware that Pillow modes do not always correspond                                                                                                                                                             
  3255 │       │       │       │        │       │               │       │    to NumPy dtypes. Pillow modes only offer 1-bit pixels, 8-bit pixels,                                                                                                                                                                  
  3256 │       │       │       │        │       │               │       │    32-bit signed integer pixels, and 32-bit floating point pixels.                                                                                                                                                                       
  3257 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3258 │       │       │       │        │       │               │       │    Pillow images can also be converted to arrays::                                                                                                                                                                                       
  3259 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3260 │       │       │       │        │       │               │       │      from PIL import Image                                                                                                                                                                                                               
  3261 │       │       │       │        │       │               │       │      import numpy as np                                                                                                                                                                                                                  
  3262 │       │       │       │        │       │               │       │      im = Image.open("hopper.jpg")                                                                                                                                                                                                       
  3263 │       │       │       │        │       │               │       │      a = np.asarray(im)                                                                                                                                                                                                                  
  3264 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3265 │       │       │       │        │       │               │       │    When converting Pillow images to arrays however, only pixel values are                                                                                                                                                                
  3266 │       │       │       │        │       │               │       │    transferred. This means that P and PA mode images will lose their palette.                                                                                                                                                            
  3267 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3268 │       │       │       │        │       │               │       │    :param obj: Object with array interface                                                                                                                                                                                               
  3269 │       │       │       │        │       │               │       │    :param mode: Optional mode to use when reading ``obj``. Will be determined from                                                                                                                                                       
  3270 │       │       │       │        │       │               │       │      type if ``None``.                                                                                                                                                                                                                   
  3271 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3272 │       │       │       │        │       │               │       │      This will not be used to convert the data after reading, but will be used to                                                                                                                                                        
  3273 │       │       │       │        │       │               │       │      change how the data is read::                                                                                                                                                                                                       
  3274 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3275 │       │       │       │        │       │               │       │        from PIL import Image                                                                                                                                                                                                             
  3276 │       │       │       │        │       │               │       │        import numpy as np                                                                                                                                                                                                                
  3277 │       │       │       │        │       │               │       │        a = np.full((1, 1), 300)                                                                                                                                                                                                          
  3278 │       │       │       │        │       │               │       │        im = Image.fromarray(a, mode="L")                                                                                                                                                                                                 
  3279 │       │       │       │        │       │               │       │        im.getpixel((0, 0))  # 44                                                                                                                                                                                                         
  3280 │       │       │       │        │       │               │       │        im = Image.fromarray(a, mode="RGB")                                                                                                                                                                                               
  3281 │       │       │       │        │       │               │       │        im.getpixel((0, 0))  # (44, 1, 0)                                                                                                                                                                                                 
  3282 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3283 │       │       │       │        │       │               │       │      See: :ref:`concept-modes` for general information about modes.                                                                                                                                                                      
  3284 │       │       │       │        │       │               │       │    :returns: An image object.                                                                                                                                                                                                            
  3285 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3286 │       │       │       │        │       │               │       │    .. versionadded:: 1.1.6                                                                                                                                                                                                               
  3287 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3288 │       │       │       │        │       │               │       │    arr = obj.__array_interface__                                                                                                                                                                                                         
  3289 │       │       │       │        │       │               │       │    shape = arr["shape"]                                                                                                                                                                                                                  
  3290 │       │       │       │        │       │               │       │    ndim = len(shape)                                                                                                                                                                                                                     
  3291 │       │       │       │        │       │               │       │    strides = arr.get("strides", None)                                                                                                                                                                                                    
  3292 │       │       │       │        │       │               │       │    if mode is None:                                                                                                                                                                                                                      
  3293 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  3294 │       │       │       │        │       │               │       │            typekey = (1, 1) + shape[2:], arr["typestr"]                                                                                                                                                                                  
  3295 │       │       │       │        │       │               │       │        except KeyError as e:                                                                                                                                                                                                             
  3296 │       │       │       │        │       │               │       │            msg = "Cannot handle this data type"                                                                                                                                                                                          
  3297 │       │       │       │        │       │               │       │            raise TypeError(msg) from e                                                                                                                                                                                                   
  3298 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  3299 │       │       │       │        │       │               │       │            mode, rawmode = _fromarray_typemap[typekey]                                                                                                                                                                                   
  3300 │       │       │       │        │       │               │       │        except KeyError as e:                                                                                                                                                                                                             
  3301 │       │       │       │        │       │               │       │            typekey_shape, typestr = typekey                                                                                                                                                                                              
  3302 │       │       │       │        │       │               │       │            msg = f"Cannot handle this data type: {typekey_shape}, {typestr}"                                                                                                                                                             
  3303 │       │       │       │        │       │               │       │            raise TypeError(msg) from e                                                                                                                                                                                                   
  3304 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
  3305 │       │       │       │        │       │               │       │        rawmode = mode                                                                                                                                                                                                                    
  3306 │       │       │       │        │       │               │       │    if mode in ["1", "L", "I", "P", "F"]:                                                                                                                                                                                                 
  3307 │       │       │       │        │       │               │       │        ndmax = 2                                                                                                                                                                                                                         
  3308 │       │       │       │        │       │               │       │    elif mode == "RGB":                                                                                                                                                                                                                   
  3309 │       │       │       │        │       │               │       │        ndmax = 3                                                                                                                                                                                                                         
  3310 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
  3311 │       │       │       │        │       │               │       │        ndmax = 4                                                                                                                                                                                                                         
  3312 │       │       │       │        │       │               │       │    if ndim > ndmax:                                                                                                                                                                                                                      
  3313 │       │       │       │        │       │               │       │        msg = f"Too many dimensions: {ndim} > {ndmax}."                                                                                                                                                                                   
  3314 │       │       │       │        │       │               │       │        raise ValueError(msg)                                                                                                                                                                                                             
  3315 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3316 │       │       │       │        │       │               │       │    size = 1 if ndim == 1 else shape[1], shape[0]                                                                                                                                                                                         
  3317 │       │       │       │        │       │               │       │    if strides is not None:                                                                                                                                                                                                               
  3318 │       │       │       │        │       │               │       │        if hasattr(obj, "tobytes"):                                                                                                                                                                                                       
  3319 │       │       │       │        │       │               │       │            obj = obj.tobytes()                                                                                                                                                                                                           
  3320 │       │       │       │        │       │               │       │        elif hasattr(obj, "tostring"):                                                                                                                                                                                                    
  3321 │       │       │       │        │       │               │       │            obj = obj.tostring()                                                                                                                                                                                                          
  3322 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  3323 │       │       │       │        │       │               │       │            msg = "'strides' requires either tobytes() or tostring()"                                                                                                                                                                     
  3324 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  3325 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3326 │       │       │       │        │       │               │       │    return frombuffer(mode, size, obj, "raw", rawmode, 0, 1)                                                                                                                                                                              
  3327 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3328 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3329 │       │       │       │        │       │               │       │def fromarrow(                                                                                                                                                                                                                            
  3330 │       │       │       │        │       │               │       │    obj: SupportsArrowArrayInterface, mode: str, size: tuple[int, int]                                                                                                                                                                    
  3331 │       │       │       │        │       │               │       │) -> Image:                                                                                                                                                                                                                               
  3332 │       │       │       │        │       │               │       │    """Creates an image with zero-copy shared memory from an object exporting                                                                                                                                                             
  3333 │       │       │       │        │       │               │       │    the arrow_c_array interface protocol::                                                                                                                                                                                                
  3334 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3335 │       │       │       │        │       │               │       │      from PIL import Image                                                                                                                                                                                                               
  3336 │       │       │       │        │       │               │       │      import pyarrow as pa                                                                                                                                                                                                                
  3337 │       │       │       │        │       │               │       │      arr = pa.array([0]*(5*5*4), type=pa.uint8())                                                                                                                                                                                        
  3338 │       │       │       │        │       │               │       │      im = Image.fromarrow(arr, 'RGBA', (5, 5))                                                                                                                                                                                           
  3339 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3340 │       │       │       │        │       │               │       │    If the data representation of the ``obj`` is not compatible with                                                                                                                                                                      
  3341 │       │       │       │        │       │               │       │    Pillow internal storage, a ValueError is raised.                                                                                                                                                                                      
  3342 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3343 │       │       │       │        │       │               │       │    Pillow images can also be converted to Arrow objects::                                                                                                                                                                                
  3344 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3345 │       │       │       │        │       │               │       │      from PIL import Image                                                                                                                                                                                                               
  3346 │       │       │       │        │       │               │       │      import pyarrow as pa                                                                                                                                                                                                                
  3347 │       │       │       │        │       │               │       │      im = Image.open('hopper.jpg')                                                                                                                                                                                                       
  3348 │       │       │       │        │       │               │       │      arr = pa.array(im)                                                                                                                                                                                                                  
  3349 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3350 │       │       │       │        │       │               │       │    As with array support, when converting Pillow images to arrays,                                                                                                                                                                       
  3351 │       │       │       │        │       │               │       │    only pixel values are transferred. This means that P and PA mode                                                                                                                                                                      
  3352 │       │       │       │        │       │               │       │    images will lose their palette.                                                                                                                                                                                                       
  3353 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3354 │       │       │       │        │       │               │       │    :param obj: Object with an arrow_c_array interface                                                                                                                                                                                    
  3355 │       │       │       │        │       │               │       │    :param mode: Image mode.                                                                                                                                                                                                              
  3356 │       │       │       │        │       │               │       │    :param size: Image size. This must match the storage of the arrow object.                                                                                                                                                             
  3357 │       │       │       │        │       │               │       │    :returns: An Image object                                                                                                                                                                                                             
  3358 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3359 │       │       │       │        │       │               │       │    Note that according to the Arrow spec, both the producer and the                                                                                                                                                                      
  3360 │       │       │       │        │       │               │       │    consumer should consider the exported array to be immutable, as                                                                                                                                                                       
  3361 │       │       │       │        │       │               │       │    unsynchronized updates will potentially cause inconsistent data.                                                                                                                                                                      
  3362 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3363 │       │       │       │        │       │               │       │    See: :ref:`arrow-support` for more detailed information                                                                                                                                                                               
  3364 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3365 │       │       │       │        │       │               │       │    .. versionadded:: 11.2.1                                                                                                                                                                                                              
  3366 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3367 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3368 │       │       │       │        │       │               │       │    if not hasattr(obj, "__arrow_c_array__"):                                                                                                                                                                                             
  3369 │       │       │       │        │       │               │       │        msg = "arrow_c_array interface not found"                                                                                                                                                                                         
  3370 │       │       │       │        │       │               │       │        raise ValueError(msg)                                                                                                                                                                                                             
  3371 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3372 │       │       │       │        │       │               │       │    (schema_capsule, array_capsule) = obj.__arrow_c_array__()                                                                                                                                                                             
  3373 │       │       │       │        │       │               │       │    _im = core.new_arrow(mode, size, schema_capsule, array_capsule)                                                                                                                                                                       
  3374 │       │       │       │        │       │               │       │    if _im:                                                                                                                                                                                                                               
  3375 │       │       │       │        │       │               │       │        return Image()._new(_im)                                                                                                                                                                                                          
  3376 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3377 │       │       │       │        │       │               │       │    msg = "new_arrow returned None without an exception"                                                                                                                                                                                  
  3378 │       │       │       │        │       │               │       │    raise ValueError(msg)                                                                                                                                                                                                                 
  3379 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3380 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3381 │       │       │       │        │       │               │       │def fromqimage(im: ImageQt.QImage) -> ImageFile.ImageFile:                                                                                                                                                                                
  3382 │       │       │       │        │       │               │       │    """Creates an image instance from a QImage image"""                                                                                                                                                                                   
  3383 │       │       │       │        │       │               │       │    from . import ImageQt                                                                                                                                                                                                                 
  3384 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3385 │       │       │       │        │       │               │       │    if not ImageQt.qt_is_installed:                                                                                                                                                                                                       
  3386 │       │       │       │        │       │               │       │        msg = "Qt bindings are not installed"                                                                                                                                                                                             
  3387 │       │       │       │        │       │               │       │        raise ImportError(msg)                                                                                                                                                                                                            
  3388 │       │       │       │        │       │               │       │    return ImageQt.fromqimage(im)                                                                                                                                                                                                         
  3389 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3390 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3391 │       │       │       │        │       │               │       │def fromqpixmap(im: ImageQt.QPixmap) -> ImageFile.ImageFile:                                                                                                                                                                              
  3392 │       │       │       │        │       │               │       │    """Creates an image instance from a QPixmap image"""                                                                                                                                                                                  
  3393 │       │       │       │        │       │               │       │    from . import ImageQt                                                                                                                                                                                                                 
  3394 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3395 │       │       │       │        │       │               │       │    if not ImageQt.qt_is_installed:                                                                                                                                                                                                       
  3396 │       │       │       │        │       │               │       │        msg = "Qt bindings are not installed"                                                                                                                                                                                             
  3397 │       │       │       │        │       │               │       │        raise ImportError(msg)                                                                                                                                                                                                            
  3398 │       │       │       │        │       │               │       │    return ImageQt.fromqpixmap(im)                                                                                                                                                                                                        
  3399 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3400 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3401 │       │       │       │        │       │               │       │_fromarray_typemap = {                                                                                                                                                                                                                    
  3402 │       │       │       │        │       │               │       │    # (shape, typestr) => mode, rawmode                                                                                                                                                                                                   
  3403 │       │       │       │        │       │               │       │    # first two members of shape are set to one                                                                                                                                                                                           
  3404 │       │       │       │        │       │               │       │    ((1, 1), "|b1"): ("1", "1;8"),                                                                                                                                                                                                        
  3405 │       │       │       │        │       │               │       │    ((1, 1), "|u1"): ("L", "L"),                                                                                                                                                                                                          
  3406 │       │       │       │        │       │               │       │    ((1, 1), "|i1"): ("I", "I;8"),                                                                                                                                                                                                        
  3407 │       │       │       │        │       │               │       │    ((1, 1), "<u2"): ("I", "I;16"),                                                                                                                                                                                                       
  3408 │       │       │       │        │       │               │       │    ((1, 1), ">u2"): ("I", "I;16B"),                                                                                                                                                                                                      
  3409 │       │       │       │        │       │               │       │    ((1, 1), "<i2"): ("I", "I;16S"),                                                                                                                                                                                                      
  3410 │       │       │       │        │       │               │       │    ((1, 1), ">i2"): ("I", "I;16BS"),                                                                                                                                                                                                     
  3411 │       │       │       │        │       │               │       │    ((1, 1), "<u4"): ("I", "I;32"),                                                                                                                                                                                                       
  3412 │       │       │       │        │       │               │       │    ((1, 1), ">u4"): ("I", "I;32B"),                                                                                                                                                                                                      
  3413 │       │       │       │        │       │               │       │    ((1, 1), "<i4"): ("I", "I;32S"),                                                                                                                                                                                                      
  3414 │       │       │       │        │       │               │       │    ((1, 1), ">i4"): ("I", "I;32BS"),                                                                                                                                                                                                     
  3415 │       │       │       │        │       │               │       │    ((1, 1), "<f4"): ("F", "F;32F"),                                                                                                                                                                                                      
  3416 │       │       │       │        │       │               │       │    ((1, 1), ">f4"): ("F", "F;32BF"),                                                                                                                                                                                                     
  3417 │       │       │       │        │       │               │       │    ((1, 1), "<f8"): ("F", "F;64F"),                                                                                                                                                                                                      
  3418 │       │       │       │        │       │               │       │    ((1, 1), ">f8"): ("F", "F;64BF"),                                                                                                                                                                                                     
  3419 │       │       │       │        │       │               │       │    ((1, 1, 2), "|u1"): ("LA", "LA"),                                                                                                                                                                                                     
  3420 │       │       │       │        │       │               │       │    ((1, 1, 3), "|u1"): ("RGB", "RGB"),                                                                                                                                                                                                   
  3421 │       │       │       │        │       │               │       │    ((1, 1, 4), "|u1"): ("RGBA", "RGBA"),                                                                                                                                                                                                 
  3422 │       │       │       │        │       │               │       │    # shortcuts:                                                                                                                                                                                                                          
  3423 │       │       │       │        │       │               │       │    ((1, 1), f"{_ENDIAN}i4"): ("I", "I"),                                                                                                                                                                                                 
  3424 │       │       │       │        │       │               │       │    ((1, 1), f"{_ENDIAN}f4"): ("F", "F"),                                                                                                                                                                                                 
  3425 │       │       │       │        │       │               │       │}                                                                                                                                                                                                                                         
  3426 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3427 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3428 │       │       │       │        │       │               │       │def _decompression_bomb_check(size: tuple[int, int]) -> None:                                                                                                                                                                             
  3429 │       │       │       │        │       │               │       │    if MAX_IMAGE_PIXELS is None:                                                                                                                                                                                                          
  3430 │       │       │       │        │       │               │       │        return                                                                                                                                                                                                                            
  3431 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3432 │       │       │       │        │       │               │       │    pixels = max(1, size[0]) * max(1, size[1])                                                                                                                                                                                            
  3433 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3434 │       │       │       │        │       │               │       │    if pixels > 2 * MAX_IMAGE_PIXELS:                                                                                                                                                                                                     
  3435 │       │       │       │        │       │               │       │        msg = (                                                                                                                                                                                                                           
  3436 │       │       │       │        │       │               │       │            f"Image size ({pixels} pixels) exceeds limit of {2 * MAX_IMAGE_PIXELS} "                                                                                                                                                      
  3437 │       │       │       │        │       │               │       │            "pixels, could be decompression bomb DOS attack."                                                                                                                                                                             
  3438 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
  3439 │       │       │       │        │       │               │       │        raise DecompressionBombError(msg)                                                                                                                                                                                                 
  3440 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3441 │       │       │       │        │       │               │       │    if pixels > MAX_IMAGE_PIXELS:                                                                                                                                                                                                         
  3442 │       │       │       │        │       │               │       │        warnings.warn(                                                                                                                                                                                                                    
  3443 │       │       │       │        │       │               │       │            f"Image size ({pixels} pixels) exceeds limit of {MAX_IMAGE_PIXELS} pixels, "                                                                                                                                                  
  3444 │       │       │       │        │       │               │       │            "could be decompression bomb DOS attack.",                                                                                                                                                                                    
  3445 │       │       │       │        │       │               │       │            DecompressionBombWarning,                                                                                                                                                                                                     
  3446 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
  3447 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3448 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3449 │       │       │       │        │       │               │       │def open(                                                                                                                                                                                                                                 
  3450 │       │       │       │        │       │               │       │    fp: StrOrBytesPath | IO[bytes],                                                                                                                                                                                                       
  3451 │       │       │       │        │       │               │       │    mode: Literal["r"] = "r",                                                                                                                                                                                                             
  3452 │       │       │       │        │       │               │       │    formats: list[str] | tuple[str, ...] | None = None,                                                                                                                                                                                   
  3453 │       │       │       │        │       │               │       │) -> ImageFile.ImageFile:                                                                                                                                                                                                                 
  3454 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3455 │       │       │       │        │       │               │       │    Opens and identifies the given image file.                                                                                                                                                                                            
  3456 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3457 │       │       │       │        │       │               │       │    This is a lazy operation; this function identifies the file, but                                                                                                                                                                      
  3458 │       │       │       │        │       │               │       │    the file remains open and the actual image data is not read from                                                                                                                                                                      
  3459 │       │       │       │        │       │               │       │    the file until you try to process the data (or call the                                                                                                                                                                               
  3460 │       │       │       │        │       │               │       │    :py:meth:`~PIL.Image.Image.load` method).  See                                                                                                                                                                                        
  3461 │       │       │       │        │       │               │       │    :py:func:`~PIL.Image.new`. See :ref:`file-handling`.                                                                                                                                                                                  
  3462 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3463 │       │       │       │        │       │               │       │    :param fp: A filename (string), os.PathLike object or a file object.                                                                                                                                                                  
  3464 │       │       │       │        │       │               │       │       The file object must implement ``file.read``,                                                                                                                                                                                      
  3465 │       │       │       │        │       │               │       │       ``file.seek``, and ``file.tell`` methods,                                                                                                                                                                                          
  3466 │       │       │       │        │       │               │       │       and be opened in binary mode. The file object will also seek to zero                                                                                                                                                               
  3467 │       │       │       │        │       │               │       │       before reading.                                                                                                                                                                                                                    
  3468 │       │       │       │        │       │               │       │    :param mode: The mode.  If given, this argument must be "r".                                                                                                                                                                          
  3469 │       │       │       │        │       │               │       │    :param formats: A list or tuple of formats to attempt to load the file in.                                                                                                                                                            
  3470 │       │       │       │        │       │               │       │       This can be used to restrict the set of formats checked.                                                                                                                                                                           
  3471 │       │       │       │        │       │               │       │       Pass ``None`` to try all supported formats. You can print the set of                                                                                                                                                               
  3472 │       │       │       │        │       │               │       │       available formats by running ``python3 -m PIL`` or using                                                                                                                                                                           
  3473 │       │       │       │        │       │               │       │       the :py:func:`PIL.features.pilinfo` function.                                                                                                                                                                                      
  3474 │       │       │       │        │       │               │       │    :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                     
  3475 │       │       │       │        │       │               │       │    :exception FileNotFoundError: If the file cannot be found.                                                                                                                                                                            
  3476 │       │       │       │        │       │               │       │    :exception PIL.UnidentifiedImageError: If the image cannot be opened and                                                                                                                                                              
  3477 │       │       │       │        │       │               │       │       identified.                                                                                                                                                                                                                        
  3478 │       │       │       │        │       │               │       │    :exception ValueError: If the ``mode`` is not "r", or if a ``StringIO``                                                                                                                                                               
  3479 │       │       │       │        │       │               │       │       instance is used for ``fp``.                                                                                                                                                                                                       
  3480 │       │       │       │        │       │               │       │    :exception TypeError: If ``formats`` is not ``None``, a list or a tuple.                                                                                                                                                              
  3481 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3482 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3483 │       │       │       │        │       │               │       │    if mode != "r":                                                                                                                                                                                                                       
  3484 │       │       │       │        │       │               │       │        msg = f"bad mode {repr(mode)}"  # type: ignore[unreachable]                                                                                                                                                                       
  3485 │       │       │       │        │       │               │       │        raise ValueError(msg)                                                                                                                                                                                                             
  3486 │       │       │       │        │       │               │       │    elif isinstance(fp, io.StringIO):                                                                                                                                                                                                     
  3487 │       │       │       │        │       │               │       │        msg = (  # type: ignore[unreachable]                                                                                                                                                                                              
  3488 │       │       │       │        │       │               │       │            "StringIO cannot be used to open an image. "                                                                                                                                                                                  
  3489 │       │       │       │        │       │               │       │            "Binary data must be used instead."                                                                                                                                                                                           
  3490 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
  3491 │       │       │       │        │       │               │       │        raise ValueError(msg)                                                                                                                                                                                                             
  3492 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3493 │       │       │       │        │       │               │       │    if formats is None:                                                                                                                                                                                                                   
  3494 │       │       │       │        │       │               │       │        formats = ID                                                                                                                                                                                                                      
  3495 │       │       │       │        │       │               │       │    elif not isinstance(formats, (list, tuple)):                                                                                                                                                                                          
  3496 │       │       │       │        │       │               │       │        msg = "formats must be a list or tuple"  # type: ignore[unreachable]                                                                                                                                                              
  3497 │       │       │       │        │       │               │       │        raise TypeError(msg)                                                                                                                                                                                                              
  3498 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3499 │       │       │       │        │       │               │       │    exclusive_fp = False                                                                                                                                                                                                                  
  3500 │       │       │       │        │       │               │       │    filename: str | bytes = ""                                                                                                                                                                                                            
  3501 │       │       │       │        │       │               │       │    if is_path(fp):                                                                                                                                                                                                                       
  3502 │       │       │       │        │       │               │       │        filename = os.fspath(fp)                                                                                                                                                                                                          
  3503 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3504 │       │       │       │        │       │               │       │    if filename:                                                                                                                                                                                                                          
  3505 │       │       │       │        │       │               │       │        fp = builtins.open(filename, "rb")                                                                                                                                                                                                
  3506 │       │       │       │        │       │               │       │        exclusive_fp = True                                                                                                                                                                                                               
  3507 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
  3508 │       │       │       │        │       │               │       │        fp = cast(IO[bytes], fp)                                                                                                                                                                                                          
  3509 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3510 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
  3511 │       │       │       │        │       │               │       │        fp.seek(0)                                                                                                                                                                                                                        
  3512 │       │       │       │        │       │               │       │    except (AttributeError, io.UnsupportedOperation):                                                                                                                                                                                     
  3513 │       │       │       │        │       │               │       │        fp = io.BytesIO(fp.read())                                                                                                                                                                                                        
  3514 │       │       │       │        │       │               │       │        exclusive_fp = True                                                                                                                                                                                                               
  3515 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3516 │       │       │       │        │       │               │       │    prefix = fp.read(16)                                                                                                                                                                                                                  
  3517 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3518 │       │       │       │        │       │               │       │    preinit()                                                                                                                                                                                                                             
  3519 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3520 │       │       │       │        │       │               │       │    warning_messages: list[str] = []                                                                                                                                                                                                      
  3521 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3522 │       │       │       │        │       │               │       │    def _open_core(                                                                                                                                                                                                                       
  3523 │       │       │       │        │       │               │       │        fp: IO[bytes],                                                                                                                                                                                                                    
  3524 │       │       │       │        │       │               │       │        filename: str | bytes,                                                                                                                                                                                                            
  3525 │       │       │       │        │       │               │       │        prefix: bytes,                                                                                                                                                                                                                    
  3526 │       │       │       │        │       │               │       │        formats: list[str] | tuple[str, ...],                                                                                                                                                                                             
  3527 │       │       │       │        │       │               │       │    ) -> ImageFile.ImageFile | None:                                                                                                                                                                                                      
  3528 │       │       │       │        │       │               │       │        for i in formats:                                                                                                                                                                                                                 
  3529 │       │       │       │        │       │               │       │            i = i.upper()                                                                                                                                                                                                                 
  3530 │       │       │       │        │       │               │       │            if i not in OPEN:                                                                                                                                                                                                             
  3531 │       │       │       │        │       │               │       │                init()                                                                                                                                                                                                                    
  3532 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
  3533 │       │       │       │        │       │               │       │                factory, accept = OPEN[i]                                                                                                                                                                                                 
  3534 │       │       │       │        │       │               │       │                result = not accept or accept(prefix)                                                                                                                                                                                     
  3535 │       │       │       │        │       │               │       │                if isinstance(result, str):                                                                                                                                                                                               
  3536 │       │       │       │        │       │               │       │                    warning_messages.append(result)                                                                                                                                                                                       
  3537 │       │       │       │        │       │               │       │                elif result:                                                                                                                                                                                                              
  3538 │       │       │       │        │       │               │       │                    fp.seek(0)                                                                                                                                                                                                            
  3539 │       │       │       │        │       │               │       │                    im = factory(fp, filename)                                                                                                                                                                                            
  3540 │       │       │       │        │       │               │       │                    _decompression_bomb_check(im.size)                                                                                                                                                                                    
  3541 │       │       │       │        │       │               │       │                    return im                                                                                                                                                                                                             
  3542 │       │       │       │        │       │               │       │            except (SyntaxError, IndexError, TypeError, struct.error) as e:                                                                                                                                                               
  3543 │       │       │       │        │       │               │       │                if WARN_POSSIBLE_FORMATS:                                                                                                                                                                                                 
  3544 │       │       │       │        │       │               │       │                    warning_messages.append(i + " opening failed. " + str(e))                                                                                                                                                             
  3545 │       │       │       │        │       │               │       │            except BaseException:                                                                                                                                                                                                         
  3546 │       │       │       │        │       │               │       │                if exclusive_fp:                                                                                                                                                                                                          
  3547 │       │       │       │        │       │               │       │                    fp.close()                                                                                                                                                                                                            
  3548 │       │       │       │        │       │               │       │                raise                                                                                                                                                                                                                     
  3549 │       │       │       │        │       │               │       │        return None                                                                                                                                                                                                                       
  3550 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3551 │       │       │       │        │       │               │       │    im = _open_core(fp, filename, prefix, formats)                                                                                                                                                                                        
  3552 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3553 │       │       │       │        │       │               │       │    if im is None and formats is ID:                                                                                                                                                                                                      
  3554 │       │       │       │        │       │               │       │        checked_formats = ID.copy()                                                                                                                                                                                                       
  3555 │       │       │       │        │       │               │       │        if init():                                                                                                                                                                                                                        
  3556 │       │       │       │        │       │               │       │            im = _open_core(                                                                                                                                                                                                              
  3557 │       │       │       │        │       │               │       │                fp,                                                                                                                                                                                                                       
  3558 │       │       │       │        │       │               │       │                filename,                                                                                                                                                                                                                 
  3559 │       │       │       │        │       │               │       │                prefix,                                                                                                                                                                                                                   
  3560 │       │       │       │        │       │               │       │                tuple(format for format in formats if format not in checked_formats),                                                                                                                                                     
  3561 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  3562 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3563 │       │       │       │        │       │               │       │    if im:                                                                                                                                                                                                                                
  3564 │       │       │       │        │       │               │       │        im._exclusive_fp = exclusive_fp                                                                                                                                                                                                   
  3565 │       │       │       │        │       │               │       │        return im                                                                                                                                                                                                                         
  3566 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3567 │       │       │       │        │       │               │       │    if exclusive_fp:                                                                                                                                                                                                                      
  3568 │       │       │       │        │       │               │       │        fp.close()                                                                                                                                                                                                                        
  3569 │       │       │       │        │       │               │       │    for message in warning_messages:                                                                                                                                                                                                      
  3570 │       │       │       │        │       │               │       │        warnings.warn(message)                                                                                                                                                                                                            
  3571 │       │       │       │        │       │               │       │    msg = "cannot identify image file %r" % (filename if filename else fp)                                                                                                                                                                
  3572 │       │       │       │        │       │               │       │    raise UnidentifiedImageError(msg)                                                                                                                                                                                                     
  3573 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3574 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3575 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
  3576 │       │       │       │        │       │               │       │# Image processing.                                                                                                                                                                                                                       
  3577 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3578 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3579 │       │       │       │        │       │               │       │def alpha_composite(im1: Image, im2: Image) -> Image:                                                                                                                                                                                     
  3580 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3581 │       │       │       │        │       │               │       │    Alpha composite im2 over im1.                                                                                                                                                                                                         
  3582 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3583 │       │       │       │        │       │               │       │    :param im1: The first image. Must have mode RGBA.                                                                                                                                                                                     
  3584 │       │       │       │        │       │               │       │    :param im2: The second image.  Must have mode RGBA, and the same size as                                                                                                                                                              
  3585 │       │       │       │        │       │               │       │       the first image.                                                                                                                                                                                                                   
  3586 │       │       │       │        │       │               │       │    :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                     
  3587 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3588 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3589 │       │       │       │        │       │               │       │    im1.load()                                                                                                                                                                                                                            
  3590 │       │       │       │        │       │               │       │    im2.load()                                                                                                                                                                                                                            
  3591 │       │       │       │        │       │               │       │    return im1._new(core.alpha_composite(im1.im, im2.im))                                                                                                                                                                                 
  3592 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3593 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3594 │       │       │       │        │       │               │       │def blend(im1: Image, im2: Image, alpha: float) -> Image:                                                                                                                                                                                 
  3595 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3596 │       │       │       │        │       │               │       │    Creates a new image by interpolating between two input images, using                                                                                                                                                                  
  3597 │       │       │       │        │       │               │       │    a constant alpha::                                                                                                                                                                                                                    
  3598 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3599 │       │       │       │        │       │               │       │        out = image1 * (1.0 - alpha) + image2 * alpha                                                                                                                                                                                     
  3600 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3601 │       │       │       │        │       │               │       │    :param im1: The first image.                                                                                                                                                                                                          
  3602 │       │       │       │        │       │               │       │    :param im2: The second image.  Must have the same mode and size as                                                                                                                                                                    
  3603 │       │       │       │        │       │               │       │       the first image.                                                                                                                                                                                                                   
  3604 │       │       │       │        │       │               │       │    :param alpha: The interpolation alpha factor.  If alpha is 0.0, a                                                                                                                                                                     
  3605 │       │       │       │        │       │               │       │       copy of the first image is returned. If alpha is 1.0, a copy of                                                                                                                                                                    
  3606 │       │       │       │        │       │               │       │       the second image is returned. There are no restrictions on the                                                                                                                                                                     
  3607 │       │       │       │        │       │               │       │       alpha value. If necessary, the result is clipped to fit into                                                                                                                                                                       
  3608 │       │       │       │        │       │               │       │       the allowed output range.                                                                                                                                                                                                          
  3609 │       │       │       │        │       │               │       │    :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                     
  3610 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3611 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3612 │       │       │       │        │       │               │       │    im1.load()                                                                                                                                                                                                                            
  3613 │       │       │       │        │       │               │       │    im2.load()                                                                                                                                                                                                                            
  3614 │       │       │       │        │       │               │       │    return im1._new(core.blend(im1.im, im2.im, alpha))                                                                                                                                                                                    
  3615 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3616 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3617 │       │       │       │        │       │               │       │def composite(image1: Image, image2: Image, mask: Image) -> Image:                                                                                                                                                                        
  3618 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3619 │       │       │       │        │       │               │       │    Create composite image by blending images using a transparency mask.                                                                                                                                                                  
  3620 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3621 │       │       │       │        │       │               │       │    :param image1: The first image.                                                                                                                                                                                                       
  3622 │       │       │       │        │       │               │       │    :param image2: The second image.  Must have the same mode and                                                                                                                                                                         
  3623 │       │       │       │        │       │               │       │       size as the first image.                                                                                                                                                                                                           
  3624 │       │       │       │        │       │               │       │    :param mask: A mask image.  This image can have mode                                                                                                                                                                                  
  3625 │       │       │       │        │       │               │       │       "1", "L", or "RGBA", and must have the same size as the                                                                                                                                                                            
  3626 │       │       │       │        │       │               │       │       other two images.                                                                                                                                                                                                                  
  3627 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3628 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3629 │       │       │       │        │       │               │       │    image = image2.copy()                                                                                                                                                                                                                 
  3630 │       │       │       │        │       │               │       │    image.paste(image1, None, mask)                                                                                                                                                                                                       
  3631 │       │       │       │        │       │               │       │    return image                                                                                                                                                                                                                          
  3632 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3633 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3634 │       │       │       │        │       │               │       │def eval(image: Image, *args: Callable[[int], float]) -> Image:                                                                                                                                                                           
  3635 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3636 │       │       │       │        │       │               │       │    Applies the function (which should take one argument) to each pixel                                                                                                                                                                   
  3637 │       │       │       │        │       │               │       │    in the given image. If the image has more than one band, the same                                                                                                                                                                     
  3638 │       │       │       │        │       │               │       │    function is applied to each band. Note that the function is                                                                                                                                                                           
  3639 │       │       │       │        │       │               │       │    evaluated once for each possible pixel value, so you cannot use                                                                                                                                                                       
  3640 │       │       │       │        │       │               │       │    random components or other generators.                                                                                                                                                                                                
  3641 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3642 │       │       │       │        │       │               │       │    :param image: The input image.                                                                                                                                                                                                        
  3643 │       │       │       │        │       │               │       │    :param function: A function object, taking one integer argument.                                                                                                                                                                      
  3644 │       │       │       │        │       │               │       │    :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                     
  3645 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3646 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3647 │       │       │       │        │       │               │       │    return image.point(args[0])                                                                                                                                                                                                           
  3648 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3649 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3650 │       │       │       │        │       │               │       │def merge(mode: str, bands: Sequence[Image]) -> Image:                                                                                                                                                                                    
  3651 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3652 │       │       │       │        │       │               │       │    Merge a set of single band images into a new multiband image.                                                                                                                                                                         
  3653 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3654 │       │       │       │        │       │               │       │    :param mode: The mode to use for the output image. See:                                                                                                                                                                               
  3655 │       │       │       │        │       │               │       │        :ref:`concept-modes`.                                                                                                                                                                                                             
  3656 │       │       │       │        │       │               │       │    :param bands: A sequence containing one single-band image for                                                                                                                                                                         
  3657 │       │       │       │        │       │               │       │        each band in the output image.  All bands must have the                                                                                                                                                                           
  3658 │       │       │       │        │       │               │       │        same size.                                                                                                                                                                                                                        
  3659 │       │       │       │        │       │               │       │    :returns: An :py:class:`~PIL.Image.Image` object.                                                                                                                                                                                     
  3660 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3661 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3662 │       │       │       │        │       │               │       │    if getmodebands(mode) != len(bands) or "*" in mode:                                                                                                                                                                                   
  3663 │       │       │       │        │       │               │       │        msg = "wrong number of bands"                                                                                                                                                                                                     
  3664 │       │       │       │        │       │               │       │        raise ValueError(msg)                                                                                                                                                                                                             
  3665 │       │       │       │        │       │               │       │    for band in bands[1:]:                                                                                                                                                                                                                
  3666 │       │       │       │        │       │               │       │        if band.mode != getmodetype(mode):                                                                                                                                                                                                
  3667 │       │       │       │        │       │               │       │            msg = "mode mismatch"                                                                                                                                                                                                         
  3668 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  3669 │       │       │       │        │       │               │       │        if band.size != bands[0].size:                                                                                                                                                                                                    
  3670 │       │       │       │        │       │               │       │            msg = "size mismatch"                                                                                                                                                                                                         
  3671 │       │       │       │        │       │               │       │            raise ValueError(msg)                                                                                                                                                                                                         
  3672 │       │       │       │        │       │               │       │    for band in bands:                                                                                                                                                                                                                    
  3673 │       │       │       │        │       │               │       │        band.load()                                                                                                                                                                                                                       
  3674 │       │       │       │        │       │               │       │    return bands[0]._new(core.merge(mode, *[b.im for b in bands]))                                                                                                                                                                        
  3675 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3676 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3677 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
  3678 │       │       │       │        │       │               │       │# Plugin registry                                                                                                                                                                                                                         
  3679 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3680 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3681 │       │       │       │        │       │               │       │def register_open(                                                                                                                                                                                                                        
  3682 │       │       │       │        │       │               │       │    id: str,                                                                                                                                                                                                                              
  3683 │       │       │       │        │       │               │       │    factory: (                                                                                                                                                                                                                            
  3684 │       │       │       │        │       │               │       │        Callable[[IO[bytes], str | bytes], ImageFile.ImageFile]                                                                                                                                                                           
  3685 │       │       │       │        │       │               │       │        | type[ImageFile.ImageFile]                                                                                                                                                                                                       
  3686 │       │       │       │        │       │               │       │    ),                                                                                                                                                                                                                                    
  3687 │       │       │       │        │       │               │       │    accept: Callable[[bytes], bool | str] | None = None,                                                                                                                                                                                  
  3688 │       │       │       │        │       │               │       │) -> None:                                                                                                                                                                                                                                
  3689 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3690 │       │       │       │        │       │               │       │    Register an image file plugin.  This function should not be used                                                                                                                                                                      
  3691 │       │       │       │        │       │               │       │    in application code.                                                                                                                                                                                                                  
  3692 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3693 │       │       │       │        │       │               │       │    :param id: An image format identifier.                                                                                                                                                                                                
  3694 │       │       │       │        │       │               │       │    :param factory: An image file factory method.                                                                                                                                                                                         
  3695 │       │       │       │        │       │               │       │    :param accept: An optional function that can be used to quickly                                                                                                                                                                       
  3696 │       │       │       │        │       │               │       │       reject images having another format.                                                                                                                                                                                               
  3697 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3698 │       │       │       │        │       │               │       │    id = id.upper()                                                                                                                                                                                                                       
  3699 │       │       │       │        │       │               │       │    if id not in ID:                                                                                                                                                                                                                      
  3700 │       │       │       │        │       │               │       │        ID.append(id)                                                                                                                                                                                                                     
  3701 │       │       │       │        │       │               │       │    OPEN[id] = factory, accept                                                                                                                                                                                                            
  3702 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3703 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3704 │       │       │       │        │       │               │       │def register_mime(id: str, mimetype: str) -> None:                                                                                                                                                                                        
  3705 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3706 │       │       │       │        │       │               │       │    Registers an image MIME type by populating ``Image.MIME``. This function                                                                                                                                                              
  3707 │       │       │       │        │       │               │       │    should not be used in application code.                                                                                                                                                                                               
  3708 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3709 │       │       │       │        │       │               │       │    ``Image.MIME`` provides a mapping from image format identifiers to mime                                                                                                                                                               
  3710 │       │       │       │        │       │               │       │    formats, but :py:meth:`~PIL.ImageFile.ImageFile.get_format_mimetype` can                                                                                                                                                              
  3711 │       │       │       │        │       │               │       │    provide a different result for specific images.                                                                                                                                                                                       
  3712 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3713 │       │       │       │        │       │               │       │    :param id: An image format identifier.                                                                                                                                                                                                
  3714 │       │       │       │        │       │               │       │    :param mimetype: The image MIME type for this format.                                                                                                                                                                                 
  3715 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3716 │       │       │       │        │       │               │       │    MIME[id.upper()] = mimetype                                                                                                                                                                                                           
  3717 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3718 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3719 │       │       │       │        │       │               │       │def register_save(                                                                                                                                                                                                                        
  3720 │       │       │       │        │       │               │       │    id: str, driver: Callable[[Image, IO[bytes], str | bytes], None]                                                                                                                                                                      
  3721 │       │       │       │        │       │               │       │) -> None:                                                                                                                                                                                                                                
  3722 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3723 │       │       │       │        │       │               │       │    Registers an image save function.  This function should not be                                                                                                                                                                        
  3724 │       │       │       │        │       │               │       │    used in application code.                                                                                                                                                                                                             
  3725 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3726 │       │       │       │        │       │               │       │    :param id: An image format identifier.                                                                                                                                                                                                
  3727 │       │       │       │        │       │               │       │    :param driver: A function to save images in this format.                                                                                                                                                                              
  3728 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3729 │       │       │       │        │       │               │       │    SAVE[id.upper()] = driver                                                                                                                                                                                                             
  3730 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3731 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3732 │       │       │       │        │       │               │       │def register_save_all(                                                                                                                                                                                                                    
  3733 │       │       │       │        │       │               │       │    id: str, driver: Callable[[Image, IO[bytes], str | bytes], None]                                                                                                                                                                      
  3734 │       │       │       │        │       │               │       │) -> None:                                                                                                                                                                                                                                
  3735 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3736 │       │       │       │        │       │               │       │    Registers an image function to save all the frames                                                                                                                                                                                    
  3737 │       │       │       │        │       │               │       │    of a multiframe format.  This function should not be                                                                                                                                                                                  
  3738 │       │       │       │        │       │               │       │    used in application code.                                                                                                                                                                                                             
  3739 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3740 │       │       │       │        │       │               │       │    :param id: An image format identifier.                                                                                                                                                                                                
  3741 │       │       │       │        │       │               │       │    :param driver: A function to save images in this format.                                                                                                                                                                              
  3742 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3743 │       │       │       │        │       │               │       │    SAVE_ALL[id.upper()] = driver                                                                                                                                                                                                         
  3744 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3745 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3746 │       │       │       │        │       │               │       │def register_extension(id: str, extension: str) -> None:                                                                                                                                                                                  
  3747 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3748 │       │       │       │        │       │               │       │    Registers an image extension.  This function should not be                                                                                                                                                                            
  3749 │       │       │       │        │       │               │       │    used in application code.                                                                                                                                                                                                             
  3750 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3751 │       │       │       │        │       │               │       │    :param id: An image format identifier.                                                                                                                                                                                                
  3752 │       │       │       │        │       │               │       │    :param extension: An extension used for this format.                                                                                                                                                                                  
  3753 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3754 │       │       │       │        │       │               │       │    EXTENSION[extension.lower()] = id.upper()                                                                                                                                                                                             
  3755 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3756 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3757 │       │       │       │        │       │               │       │def register_extensions(id: str, extensions: list[str]) -> None:                                                                                                                                                                          
  3758 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3759 │       │       │       │        │       │               │       │    Registers image extensions.  This function should not be                                                                                                                                                                              
  3760 │       │       │       │        │       │               │       │    used in application code.                                                                                                                                                                                                             
  3761 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3762 │       │       │       │        │       │               │       │    :param id: An image format identifier.                                                                                                                                                                                                
  3763 │       │       │       │        │       │               │       │    :param extensions: A list of extensions used for this format.                                                                                                                                                                         
  3764 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3765 │       │       │       │        │       │               │       │    for extension in extensions:                                                                                                                                                                                                          
  3766 │       │       │       │        │       │               │       │        register_extension(id, extension)                                                                                                                                                                                                 
  3767 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3768 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3769 │       │       │       │        │       │               │       │def registered_extensions() -> dict[str, str]:                                                                                                                                                                                            
  3770 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3771 │       │       │       │        │       │               │       │    Returns a dictionary containing all file extensions belonging                                                                                                                                                                         
  3772 │       │       │       │        │       │               │       │    to registered plugins                                                                                                                                                                                                                 
  3773 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3774 │       │       │       │        │       │               │       │    init()                                                                                                                                                                                                                                
  3775 │       │       │       │        │       │               │       │    return EXTENSION                                                                                                                                                                                                                      
  3776 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3777 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3778 │       │       │       │        │       │               │       │def register_decoder(name: str, decoder: type[ImageFile.PyDecoder]) -> None:                                                                                                                                                              
  3779 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3780 │       │       │       │        │       │               │       │    Registers an image decoder.  This function should not be                                                                                                                                                                              
  3781 │       │       │       │        │       │               │       │    used in application code.                                                                                                                                                                                                             
  3782 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3783 │       │       │       │        │       │               │       │    :param name: The name of the decoder                                                                                                                                                                                                  
  3784 │       │       │       │        │       │               │       │    :param decoder: An ImageFile.PyDecoder object                                                                                                                                                                                         
  3785 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3786 │       │       │       │        │       │               │       │    .. versionadded:: 4.1.0                                                                                                                                                                                                               
  3787 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3788 │       │       │       │        │       │               │       │    DECODERS[name] = decoder                                                                                                                                                                                                              
  3789 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3790 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3791 │       │       │       │        │       │               │       │def register_encoder(name: str, encoder: type[ImageFile.PyEncoder]) -> None:                                                                                                                                                              
  3792 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3793 │       │       │       │        │       │               │       │    Registers an image encoder.  This function should not be                                                                                                                                                                              
  3794 │       │       │       │        │       │               │       │    used in application code.                                                                                                                                                                                                             
  3795 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3796 │       │       │       │        │       │               │       │    :param name: The name of the encoder                                                                                                                                                                                                  
  3797 │       │       │       │        │       │               │       │    :param encoder: An ImageFile.PyEncoder object                                                                                                                                                                                         
  3798 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3799 │       │       │       │        │       │               │       │    .. versionadded:: 4.1.0                                                                                                                                                                                                               
  3800 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3801 │       │       │       │        │       │               │       │    ENCODERS[name] = encoder                                                                                                                                                                                                              
  3802 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3803 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3804 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
  3805 │       │       │       │        │       │               │       │# Simple display support.                                                                                                                                                                                                                 
  3806 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3807 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3808 │       │       │       │        │       │               │       │def _show(image: Image, **options: Any) -> None:                                                                                                                                                                                          
  3809 │       │       │       │        │       │               │       │    from . import ImageShow                                                                                                                                                                                                               
  3810 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3811 │       │       │       │        │       │               │       │    ImageShow.show(image, **options)                                                                                                                                                                                                      
  3812 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3813 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3814 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
  3815 │       │       │       │        │       │               │       │# Effects                                                                                                                                                                                                                                 
  3816 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3817 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3818 │       │       │       │        │       │               │       │def effect_mandelbrot(                                                                                                                                                                                                                    
  3819 │       │       │       │        │       │               │       │    size: tuple[int, int], extent: tuple[float, float, float, float], quality: int                                                                                                                                                        
  3820 │       │       │       │        │       │               │       │) -> Image:                                                                                                                                                                                                                               
  3821 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3822 │       │       │       │        │       │               │       │    Generate a Mandelbrot set covering the given extent.                                                                                                                                                                                  
  3823 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3824 │       │       │       │        │       │               │       │    :param size: The requested size in pixels, as a 2-tuple:                                                                                                                                                                              
  3825 │       │       │       │        │       │               │       │       (width, height).                                                                                                                                                                                                                   
  3826 │       │       │       │        │       │               │       │    :param extent: The extent to cover, as a 4-tuple:                                                                                                                                                                                     
  3827 │       │       │       │        │       │               │       │       (x0, y0, x1, y1).                                                                                                                                                                                                                  
  3828 │       │       │       │        │       │               │       │    :param quality: Quality.                                                                                                                                                                                                              
  3829 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3830 │       │       │       │        │       │               │       │    return Image()._new(core.effect_mandelbrot(size, extent, quality))                                                                                                                                                                    
  3831 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3832 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3833 │       │       │       │        │       │               │       │def effect_noise(size: tuple[int, int], sigma: float) -> Image:                                                                                                                                                                           
  3834 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3835 │       │       │       │        │       │               │       │    Generate Gaussian noise centered around 128.                                                                                                                                                                                          
  3836 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3837 │       │       │       │        │       │               │       │    :param size: The requested size in pixels, as a 2-tuple:                                                                                                                                                                              
  3838 │       │       │       │        │       │               │       │       (width, height).                                                                                                                                                                                                                   
  3839 │       │       │       │        │       │               │       │    :param sigma: Standard deviation of noise.                                                                                                                                                                                            
  3840 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3841 │       │       │       │        │       │               │       │    return Image()._new(core.effect_noise(size, sigma))                                                                                                                                                                                   
  3842 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3843 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3844 │       │       │       │        │       │               │       │def linear_gradient(mode: str) -> Image:                                                                                                                                                                                                  
  3845 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3846 │       │       │       │        │       │               │       │    Generate 256x256 linear gradient from black to white, top to bottom.                                                                                                                                                                  
  3847 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3848 │       │       │       │        │       │               │       │    :param mode: Input mode.                                                                                                                                                                                                              
  3849 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3850 │       │       │       │        │       │               │       │    return Image()._new(core.linear_gradient(mode))                                                                                                                                                                                       
  3851 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3852 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3853 │       │       │       │        │       │               │       │def radial_gradient(mode: str) -> Image:                                                                                                                                                                                                  
  3854 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3855 │       │       │       │        │       │               │       │    Generate 256x256 radial gradient from black to white, centre to edge.                                                                                                                                                                 
  3856 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3857 │       │       │       │        │       │               │       │    :param mode: Input mode.                                                                                                                                                                                                              
  3858 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3859 │       │       │       │        │       │               │       │    return Image()._new(core.radial_gradient(mode))                                                                                                                                                                                       
  3860 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3861 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3862 │       │       │       │        │       │               │       │# --------------------------------------------------------------------                                                                                                                                                                    
  3863 │       │       │       │        │       │               │       │# Resources                                                                                                                                                                                                                               
  3864 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3865 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3866 │       │       │       │        │       │               │       │def _apply_env_variables(env: dict[str, str] | None = None) -> None:                                                                                                                                                                      
  3867 │       │       │       │        │       │               │       │    env_dict = env if env is not None else os.environ                                                                                                                                                                                     
  3868 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3869 │       │       │       │        │       │               │       │    for var_name, setter in [                                                                                                                                                                                                             
  3870 │       │       │       │        │       │               │       │        ("PILLOW_ALIGNMENT", core.set_alignment),                                                                                                                                                                                         
  3871 │       │       │       │        │       │               │       │        ("PILLOW_BLOCK_SIZE", core.set_block_size),                                                                                                                                                                                       
  3872 │       │       │       │        │       │               │       │        ("PILLOW_BLOCKS_MAX", core.set_blocks_max),                                                                                                                                                                                       
  3873 │       │       │       │        │       │               │       │    ]:                                                                                                                                                                                                                                    
  3874 │       │       │       │        │       │               │       │        if var_name not in env_dict:                                                                                                                                                                                                      
  3875 │       │       │       │        │       │               │       │            continue                                                                                                                                                                                                                      
  3876 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3877 │       │       │       │        │       │               │       │        var = env_dict[var_name].lower()                                                                                                                                                                                                  
  3878 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3879 │       │       │       │        │       │               │       │        units = 1                                                                                                                                                                                                                         
  3880 │       │       │       │        │       │               │       │        for postfix, mul in [("k", 1024), ("m", 1024 * 1024)]:                                                                                                                                                                            
  3881 │       │       │       │        │       │               │       │            if var.endswith(postfix):                                                                                                                                                                                                     
  3882 │       │       │       │        │       │               │       │                units = mul                                                                                                                                                                                                               
  3883 │       │       │       │        │       │               │       │                var = var[: -len(postfix)]                                                                                                                                                                                                
  3884 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3885 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  3886 │       │       │       │        │       │               │       │            var_int = int(var) * units                                                                                                                                                                                                    
  3887 │       │       │       │        │       │               │       │        except ValueError:                                                                                                                                                                                                                
  3888 │       │       │       │        │       │               │       │            warnings.warn(f"{var_name} is not int")                                                                                                                                                                                       
  3889 │       │       │       │        │       │               │       │            continue                                                                                                                                                                                                                      
  3890 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3891 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  3892 │       │       │       │        │       │               │       │            setter(var_int)                                                                                                                                                                                                               
  3893 │       │       │       │        │       │               │       │        except ValueError as e:                                                                                                                                                                                                           
  3894 │       │       │       │        │       │               │       │            warnings.warn(f"{var_name}: {e}")                                                                                                                                                                                             
  3895 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3896 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3897 │       │       │       │        │       │               │       │_apply_env_variables()                                                                                                                                                                                                                    
  3898 │       │       │       │        │       │               │       │atexit.register(core.clear_cache)                                                                                                                                                                                                         
  3899 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3900 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3901 │       │       │       │        │       │               │       │if TYPE_CHECKING:                                                                                                                                                                                                                         
  3902 │       │       │       │        │       │               │       │    _ExifBase = MutableMapping[int, Any]                                                                                                                                                                                                  
  3903 │       │       │       │        │       │               │       │else:                                                                                                                                                                                                                                     
  3904 │       │       │       │        │       │               │       │    _ExifBase = MutableMapping                                                                                                                                                                                                            
  3905 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3906 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3907 │       │       │       │        │       │               │       │class Exif(_ExifBase):                                                                                                                                                                                                                    
  3908 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3909 │       │       │       │        │       │               │       │    This class provides read and write access to EXIF image data::                                                                                                                                                                        
  3910 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3911 │       │       │       │        │       │               │       │      from PIL import Image                                                                                                                                                                                                               
  3912 │       │       │       │        │       │               │       │      im = Image.open("exif.png")                                                                                                                                                                                                         
  3913 │       │       │       │        │       │               │       │      exif = im.getexif()  # Returns an instance of this class                                                                                                                                                                            
  3914 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3915 │       │       │       │        │       │               │       │    Information can be read and written, iterated over or deleted::                                                                                                                                                                       
  3916 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3917 │       │       │       │        │       │               │       │      print(exif[274])  # 1                                                                                                                                                                                                               
  3918 │       │       │       │        │       │               │       │      exif[274] = 2                                                                                                                                                                                                                       
  3919 │       │       │       │        │       │               │       │      for k, v in exif.items():                                                                                                                                                                                                           
  3920 │       │       │       │        │       │               │       │        print("Tag", k, "Value", v)  # Tag 274 Value 2                                                                                                                                                                                    
  3921 │       │       │       │        │       │               │       │      del exif[274]                                                                                                                                                                                                                       
  3922 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3923 │       │       │       │        │       │               │       │    To access information beyond IFD0, :py:meth:`~PIL.Image.Exif.get_ifd`                                                                                                                                                                 
  3924 │       │       │       │        │       │               │       │    returns a dictionary::                                                                                                                                                                                                                
  3925 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3926 │       │       │       │        │       │               │       │      from PIL import ExifTags                                                                                                                                                                                                            
  3927 │       │       │       │        │       │               │       │      im = Image.open("exif_gps.jpg")                                                                                                                                                                                                     
  3928 │       │       │       │        │       │               │       │      exif = im.getexif()                                                                                                                                                                                                                 
  3929 │       │       │       │        │       │               │       │      gps_ifd = exif.get_ifd(ExifTags.IFD.GPSInfo)                                                                                                                                                                                        
  3930 │       │       │       │        │       │               │       │      print(gps_ifd)                                                                                                                                                                                                                      
  3931 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3932 │       │       │       │        │       │               │       │    Other IFDs include ``ExifTags.IFD.Exif``, ``ExifTags.IFD.MakerNote``,                                                                                                                                                                 
  3933 │       │       │       │        │       │               │       │    ``ExifTags.IFD.Interop`` and ``ExifTags.IFD.IFD1``.                                                                                                                                                                                   
  3934 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3935 │       │       │       │        │       │               │       │    :py:mod:`~PIL.ExifTags` also has enum classes to provide names for data::                                                                                                                                                             
  3936 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3937 │       │       │       │        │       │               │       │      print(exif[ExifTags.Base.Software])  # PIL                                                                                                                                                                                          
  3938 │       │       │       │        │       │               │       │      print(gps_ifd[ExifTags.GPS.GPSDateStamp])  # 1999:99:99 99:99:99                                                                                                                                                                    
  3939 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
  3940 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3941 │       │       │       │        │       │               │       │    endian: str | None = None                                                                                                                                                                                                             
  3942 │       │       │       │        │       │               │       │    bigtiff = False                                                                                                                                                                                                                       
  3943 │       │       │       │        │       │               │       │    _loaded = False                                                                                                                                                                                                                       
  3944 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3945 │       │       │       │        │       │               │       │    def __init__(self) -> None:                                                                                                                                                                                                           
  3946 │       │       │       │        │       │               │       │        self._data: dict[int, Any] = {}                                                                                                                                                                                                   
  3947 │       │       │       │        │       │               │       │        self._hidden_data: dict[int, Any] = {}                                                                                                                                                                                            
  3948 │       │       │       │        │       │               │       │        self._ifds: dict[int, dict[int, Any]] = {}                                                                                                                                                                                        
  3949 │       │       │       │        │       │               │       │        self._info: TiffImagePlugin.ImageFileDirectory_v2 | None = None                                                                                                                                                                   
  3950 │       │       │       │        │       │               │       │        self._loaded_exif: bytes | None = None                                                                                                                                                                                            
  3951 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3952 │       │       │       │        │       │               │       │    def _fixup(self, value: Any) -> Any:                                                                                                                                                                                                  
  3953 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  3954 │       │       │       │        │       │               │       │            if len(value) == 1 and isinstance(value, tuple):                                                                                                                                                                              
  3955 │       │       │       │        │       │               │       │                return value[0]                                                                                                                                                                                                           
  3956 │       │       │       │        │       │               │       │        except Exception:                                                                                                                                                                                                                 
  3957 │       │       │       │        │       │               │       │            pass                                                                                                                                                                                                                          
  3958 │       │       │       │        │       │               │       │        return value                                                                                                                                                                                                                      
  3959 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3960 │       │       │       │        │       │               │       │    def _fixup_dict(self, src_dict: dict[int, Any]) -> dict[int, Any]:                                                                                                                                                                    
  3961 │       │       │       │        │       │               │       │        # Helper function                                                                                                                                                                                                                 
  3962 │       │       │       │        │       │               │       │        # returns a dict with any single item tuples/lists as individual values                                                                                                                                                           
  3963 │       │       │       │        │       │               │       │        return {k: self._fixup(v) for k, v in src_dict.items()}                                                                                                                                                                           
  3964 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3965 │       │       │       │        │       │               │       │    def _get_ifd_dict(                                                                                                                                                                                                                    
  3966 │       │       │       │        │       │               │       │        self, offset: int, group: int | None = None                                                                                                                                                                                       
  3967 │       │       │       │        │       │               │       │    ) -> dict[int, Any] | None:                                                                                                                                                                                                           
  3968 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
  3969 │       │       │       │        │       │               │       │            # an offset pointer to the location of the nested embedded IFD.                                                                                                                                                               
  3970 │       │       │       │        │       │               │       │            # It should be a long, but may be corrupted.                                                                                                                                                                                  
  3971 │       │       │       │        │       │               │       │            self.fp.seek(offset)                                                                                                                                                                                                          
  3972 │       │       │       │        │       │               │       │        except (KeyError, TypeError):                                                                                                                                                                                                     
  3973 │       │       │       │        │       │               │       │            return None                                                                                                                                                                                                                   
  3974 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  3975 │       │       │       │        │       │               │       │            from . import TiffImagePlugin                                                                                                                                                                                                 
  3976 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3977 │       │       │       │        │       │               │       │            info = TiffImagePlugin.ImageFileDirectory_v2(self.head, group=group)                                                                                                                                                          
  3978 │       │       │       │        │       │               │       │            info.load(self.fp)                                                                                                                                                                                                            
  3979 │       │       │       │        │       │               │       │            return self._fixup_dict(dict(info))                                                                                                                                                                                           
  3980 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3981 │       │       │       │        │       │               │       │    def _get_head(self) -> bytes:                                                                                                                                                                                                         
  3982 │       │       │       │        │       │               │       │        version = b"\x2b" if self.bigtiff else b"\x2a"                                                                                                                                                                                    
  3983 │       │       │       │        │       │               │       │        if self.endian == "<":                                                                                                                                                                                                            
  3984 │       │       │       │        │       │               │       │            head = b"II" + version + b"\x00" + o32le(8)                                                                                                                                                                                   
  3985 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  3986 │       │       │       │        │       │               │       │            head = b"MM\x00" + version + o32be(8)                                                                                                                                                                                         
  3987 │       │       │       │        │       │               │       │        if self.bigtiff:                                                                                                                                                                                                                  
  3988 │       │       │       │        │       │               │       │            head += o32le(8) if self.endian == "<" else o32be(8)                                                                                                                                                                          
  3989 │       │       │       │        │       │               │       │            head += b"\x00\x00\x00\x00"                                                                                                                                                                                                   
  3990 │       │       │       │        │       │               │       │        return head                                                                                                                                                                                                                       
  3991 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3992 │       │       │       │        │       │               │       │    def load(self, data: bytes) -> None:                                                                                                                                                                                                  
  3993 │       │       │       │        │       │               │       │        # Extract EXIF information.  This is highly experimental,                                                                                                                                                                         
  3994 │       │       │       │        │       │               │       │        # and is likely to be replaced with something better in a future                                                                                                                                                                  
  3995 │       │       │       │        │       │               │       │        # version.                                                                                                                                                                                                                        
  3996 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  3997 │       │       │       │        │       │               │       │        # The EXIF record consists of a TIFF file embedded in a JPEG                                                                                                                                                                      
  3998 │       │       │       │        │       │               │       │        # application marker (!).                                                                                                                                                                                                         
  3999 │       │       │       │        │       │               │       │        if data == self._loaded_exif:                                                                                                                                                                                                     
  4000 │       │       │       │        │       │               │       │            return                                                                                                                                                                                                                        
  4001 │       │       │       │        │       │               │       │        self._loaded_exif = data                                                                                                                                                                                                          
  4002 │       │       │       │        │       │               │       │        self._data.clear()                                                                                                                                                                                                                
  4003 │       │       │       │        │       │               │       │        self._hidden_data.clear()                                                                                                                                                                                                         
  4004 │       │       │       │        │       │               │       │        self._ifds.clear()                                                                                                                                                                                                                
  4005 │       │       │       │        │       │               │       │        while data and data.startswith(b"Exif\x00\x00"):                                                                                                                                                                                  
  4006 │       │       │       │        │       │               │       │            data = data[6:]                                                                                                                                                                                                               
  4007 │       │       │       │        │       │               │       │        if not data:                                                                                                                                                                                                                      
  4008 │       │       │       │        │       │               │       │            self._info = None                                                                                                                                                                                                             
  4009 │       │       │       │        │       │               │       │            return                                                                                                                                                                                                                        
  4010 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4011 │       │       │       │        │       │               │       │        self.fp: IO[bytes] = io.BytesIO(data)                                                                                                                                                                                             
  4012 │       │       │       │        │       │               │       │        self.head = self.fp.read(8)                                                                                                                                                                                                       
  4013 │       │       │       │        │       │               │       │        # process dictionary                                                                                                                                                                                                              
  4014 │       │       │       │        │       │               │       │        from . import TiffImagePlugin                                                                                                                                                                                                     
  4015 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4016 │       │       │       │        │       │               │       │        self._info = TiffImagePlugin.ImageFileDirectory_v2(self.head)                                                                                                                                                                     
  4017 │       │       │       │        │       │               │       │        self.endian = self._info._endian                                                                                                                                                                                                  
  4018 │       │       │       │        │       │               │       │        self.fp.seek(self._info.next)                                                                                                                                                                                                     
  4019 │       │       │       │        │       │               │       │        self._info.load(self.fp)                                                                                                                                                                                                          
  4020 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4021 │       │       │       │        │       │               │       │    def load_from_fp(self, fp: IO[bytes], offset: int | None = None) -> None:                                                                                                                                                             
  4022 │       │       │       │        │       │               │       │        self._loaded_exif = None                                                                                                                                                                                                          
  4023 │       │       │       │        │       │               │       │        self._data.clear()                                                                                                                                                                                                                
  4024 │       │       │       │        │       │               │       │        self._hidden_data.clear()                                                                                                                                                                                                         
  4025 │       │       │       │        │       │               │       │        self._ifds.clear()                                                                                                                                                                                                                
  4026 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4027 │       │       │       │        │       │               │       │        # process dictionary                                                                                                                                                                                                              
  4028 │       │       │       │        │       │               │       │        from . import TiffImagePlugin                                                                                                                                                                                                     
  4029 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4030 │       │       │       │        │       │               │       │        self.fp = fp                                                                                                                                                                                                                      
  4031 │       │       │       │        │       │               │       │        if offset is not None:                                                                                                                                                                                                            
  4032 │       │       │       │        │       │               │       │            self.head = self._get_head()                                                                                                                                                                                                  
  4033 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  4034 │       │       │       │        │       │               │       │            self.head = self.fp.read(8)                                                                                                                                                                                                   
  4035 │       │       │       │        │       │               │       │        self._info = TiffImagePlugin.ImageFileDirectory_v2(self.head)                                                                                                                                                                     
  4036 │       │       │       │        │       │               │       │        if self.endian is None:                                                                                                                                                                                                           
  4037 │       │       │       │        │       │               │       │            self.endian = self._info._endian                                                                                                                                                                                              
  4038 │       │       │       │        │       │               │       │        if offset is None:                                                                                                                                                                                                                
  4039 │       │       │       │        │       │               │       │            offset = self._info.next                                                                                                                                                                                                      
  4040 │       │       │       │        │       │               │       │        self.fp.tell()                                                                                                                                                                                                                    
  4041 │       │       │       │        │       │               │       │        self.fp.seek(offset)                                                                                                                                                                                                              
  4042 │       │       │       │        │       │               │       │        self._info.load(self.fp)                                                                                                                                                                                                          
  4043 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4044 │       │       │       │        │       │               │       │    def _get_merged_dict(self) -> dict[int, Any]:                                                                                                                                                                                         
  4045 │       │       │       │        │       │               │       │        merged_dict = dict(self)                                                                                                                                                                                                          
  4046 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4047 │       │       │       │        │       │               │       │        # get EXIF extension                                                                                                                                                                                                              
  4048 │       │       │       │        │       │               │       │        if ExifTags.IFD.Exif in self:                                                                                                                                                                                                     
  4049 │       │       │       │        │       │               │       │            ifd = self._get_ifd_dict(self[ExifTags.IFD.Exif], ExifTags.IFD.Exif)                                                                                                                                                          
  4050 │       │       │       │        │       │               │       │            if ifd:                                                                                                                                                                                                                       
  4051 │       │       │       │        │       │               │       │                merged_dict.update(ifd)                                                                                                                                                                                                   
  4052 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4053 │       │       │       │        │       │               │       │        # GPS                                                                                                                                                                                                                             
  4054 │       │       │       │        │       │               │       │        if ExifTags.IFD.GPSInfo in self:                                                                                                                                                                                                  
  4055 │       │       │       │        │       │               │       │            merged_dict[ExifTags.IFD.GPSInfo] = self._get_ifd_dict(                                                                                                                                                                       
  4056 │       │       │       │        │       │               │       │                self[ExifTags.IFD.GPSInfo], ExifTags.IFD.GPSInfo                                                                                                                                                                          
  4057 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  4058 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4059 │       │       │       │        │       │               │       │        return merged_dict                                                                                                                                                                                                                
  4060 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4061 │       │       │       │        │       │               │       │    def tobytes(self, offset: int = 8) -> bytes:                                                                                                                                                                                          
  4062 │       │       │       │        │       │               │       │        from . import TiffImagePlugin                                                                                                                                                                                                     
  4063 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4064 │       │       │       │        │       │               │       │        head = self._get_head()                                                                                                                                                                                                           
  4065 │       │       │       │        │       │               │       │        ifd = TiffImagePlugin.ImageFileDirectory_v2(ifh=head)                                                                                                                                                                             
  4066 │       │       │       │        │       │               │       │        for tag, ifd_dict in self._ifds.items():                                                                                                                                                                                          
  4067 │       │       │       │        │       │               │       │            if tag not in self:                                                                                                                                                                                                           
  4068 │       │       │       │        │       │               │       │                ifd[tag] = ifd_dict                                                                                                                                                                                                       
  4069 │       │       │       │        │       │               │       │        for tag, value in self.items():                                                                                                                                                                                                   
  4070 │       │       │       │        │       │               │       │            if tag in [                                                                                                                                                                                                                   
  4071 │       │       │       │        │       │               │       │                ExifTags.IFD.Exif,                                                                                                                                                                                                        
  4072 │       │       │       │        │       │               │       │                ExifTags.IFD.GPSInfo,                                                                                                                                                                                                     
  4073 │       │       │       │        │       │               │       │            ] and not isinstance(value, dict):                                                                                                                                                                                            
  4074 │       │       │       │        │       │               │       │                value = self.get_ifd(tag)                                                                                                                                                                                                 
  4075 │       │       │       │        │       │               │       │                if (                                                                                                                                                                                                                      
  4076 │       │       │       │        │       │               │       │                    tag == ExifTags.IFD.Exif                                                                                                                                                                                              
  4077 │       │       │       │        │       │               │       │                    and ExifTags.IFD.Interop in value                                                                                                                                                                                     
  4078 │       │       │       │        │       │               │       │                    and not isinstance(value[ExifTags.IFD.Interop], dict)                                                                                                                                                                 
  4079 │       │       │       │        │       │               │       │                ):                                                                                                                                                                                                                        
  4080 │       │       │       │        │       │               │       │                    value = value.copy()                                                                                                                                                                                                  
  4081 │       │       │       │        │       │               │       │                    value[ExifTags.IFD.Interop] = self.get_ifd(ExifTags.IFD.Interop)                                                                                                                                                      
  4082 │       │       │       │        │       │               │       │            ifd[tag] = value                                                                                                                                                                                                              
  4083 │       │       │       │        │       │               │       │        return b"Exif\x00\x00" + head + ifd.tobytes(offset)                                                                                                                                                                               
  4084 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4085 │       │       │       │        │       │               │       │    def get_ifd(self, tag: int) -> dict[int, Any]:                                                                                                                                                                                        
  4086 │       │       │       │        │       │               │       │        if tag not in self._ifds:                                                                                                                                                                                                         
  4087 │       │       │       │        │       │               │       │            if tag == ExifTags.IFD.IFD1:                                                                                                                                                                                                  
  4088 │       │       │       │        │       │               │       │                if self._info is not None and self._info.next != 0:                                                                                                                                                                       
  4089 │       │       │       │        │       │               │       │                    ifd = self._get_ifd_dict(self._info.next)                                                                                                                                                                             
  4090 │       │       │       │        │       │               │       │                    if ifd is not None:                                                                                                                                                                                                   
  4091 │       │       │       │        │       │               │       │                        self._ifds[tag] = ifd                                                                                                                                                                                             
  4092 │       │       │       │        │       │               │       │            elif tag in [ExifTags.IFD.Exif, ExifTags.IFD.GPSInfo]:                                                                                                                                                                        
  4093 │       │       │       │        │       │               │       │                offset = self._hidden_data.get(tag, self.get(tag))                                                                                                                                                                        
  4094 │       │       │       │        │       │               │       │                if offset is not None:                                                                                                                                                                                                    
  4095 │       │       │       │        │       │               │       │                    ifd = self._get_ifd_dict(offset, tag)                                                                                                                                                                                 
  4096 │       │       │       │        │       │               │       │                    if ifd is not None:                                                                                                                                                                                                   
  4097 │       │       │       │        │       │               │       │                        self._ifds[tag] = ifd                                                                                                                                                                                             
  4098 │       │       │       │        │       │               │       │            elif tag in [ExifTags.IFD.Interop, ExifTags.IFD.MakerNote]:                                                                                                                                                                   
  4099 │       │       │       │        │       │               │       │                if ExifTags.IFD.Exif not in self._ifds:                                                                                                                                                                                   
  4100 │       │       │       │        │       │               │       │                    self.get_ifd(ExifTags.IFD.Exif)                                                                                                                                                                                       
  4101 │       │       │       │        │       │               │       │                tag_data = self._ifds[ExifTags.IFD.Exif][tag]                                                                                                                                                                             
  4102 │       │       │       │        │       │               │       │                if tag == ExifTags.IFD.MakerNote:                                                                                                                                                                                         
  4103 │       │       │       │        │       │               │       │                    from .TiffImagePlugin import ImageFileDirectory_v2                                                                                                                                                                    
  4104 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4105 │       │       │       │        │       │               │       │                    if tag_data.startswith(b"FUJIFILM"):                                                                                                                                                                                  
  4106 │       │       │       │        │       │               │       │                        ifd_offset = i32le(tag_data, 8)                                                                                                                                                                                   
  4107 │       │       │       │        │       │               │       │                        ifd_data = tag_data[ifd_offset:]                                                                                                                                                                                  
  4108 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4109 │       │       │       │        │       │               │       │                        makernote = {}                                                                                                                                                                                                    
  4110 │       │       │       │        │       │               │       │                        for i in range(struct.unpack("<H", ifd_data[:2])[0]):                                                                                                                                                             
  4111 │       │       │       │        │       │               │       │                            ifd_tag, typ, count, data = struct.unpack(                                                                                                                                                                    
  4112 │       │       │       │        │       │               │       │                                "<HHL4s", ifd_data[i * 12 + 2 : (i + 1) * 12 + 2]                                                                                                                                                         
  4113 │       │       │       │        │       │               │       │                            )                                                                                                                                                                                                             
  4114 │       │       │       │        │       │               │       │                            try:                                                                                                                                                                                                          
  4115 │       │       │       │        │       │               │       │                                (                                                                                                                                                                                                         
  4116 │       │       │       │        │       │               │       │                                    unit_size,                                                                                                                                                                                            
  4117 │       │       │       │        │       │               │       │                                    handler,                                                                                                                                                                                              
  4118 │       │       │       │        │       │               │       │                                ) = ImageFileDirectory_v2._load_dispatch[typ]                                                                                                                                                             
  4119 │       │       │       │        │       │               │       │                            except KeyError:                                                                                                                                                                                              
  4120 │       │       │       │        │       │               │       │                                continue                                                                                                                                                                                                  
  4121 │       │       │       │        │       │               │       │                            size = count * unit_size                                                                                                                                                                                      
  4122 │       │       │       │        │       │               │       │                            if size > 4:                                                                                                                                                                                                  
  4123 │       │       │       │        │       │               │       │                                (offset,) = struct.unpack("<L", data)                                                                                                                                                                     
  4124 │       │       │       │        │       │               │       │                                data = ifd_data[offset - 12 : offset + size - 12]                                                                                                                                                         
  4125 │       │       │       │        │       │               │       │                            else:                                                                                                                                                                                                         
  4126 │       │       │       │        │       │               │       │                                data = data[:size]                                                                                                                                                                                        
  4127 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4128 │       │       │       │        │       │               │       │                            if len(data) != size:                                                                                                                                                                                         
  4129 │       │       │       │        │       │               │       │                                warnings.warn(                                                                                                                                                                                            
  4130 │       │       │       │        │       │               │       │                                    "Possibly corrupt EXIF MakerNote data.  "                                                                                                                                                             
  4131 │       │       │       │        │       │               │       │                                    f"Expecting to read {size} bytes but only got "                                                                                                                                                       
  4132 │       │       │       │        │       │               │       │                                    f"{len(data)}. Skipping tag {ifd_tag}"                                                                                                                                                                
  4133 │       │       │       │        │       │               │       │                                )                                                                                                                                                                                                         
  4134 │       │       │       │        │       │               │       │                                continue                                                                                                                                                                                                  
  4135 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4136 │       │       │       │        │       │               │       │                            if not data:                                                                                                                                                                                                  
  4137 │       │       │       │        │       │               │       │                                continue                                                                                                                                                                                                  
  4138 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4139 │       │       │       │        │       │               │       │                            makernote[ifd_tag] = handler(                                                                                                                                                                                 
  4140 │       │       │       │        │       │               │       │                                ImageFileDirectory_v2(), data, False                                                                                                                                                                      
  4141 │       │       │       │        │       │               │       │                            )                                                                                                                                                                                                             
  4142 │       │       │       │        │       │               │       │                        self._ifds[tag] = dict(self._fixup_dict(makernote))                                                                                                                                                               
  4143 │       │       │       │        │       │               │       │                    elif self.get(0x010F) == "Nintendo":                                                                                                                                                                                  
  4144 │       │       │       │        │       │               │       │                        makernote = {}                                                                                                                                                                                                    
  4145 │       │       │       │        │       │               │       │                        for i in range(struct.unpack(">H", tag_data[:2])[0]):                                                                                                                                                             
  4146 │       │       │       │        │       │               │       │                            ifd_tag, typ, count, data = struct.unpack(                                                                                                                                                                    
  4147 │       │       │       │        │       │               │       │                                ">HHL4s", tag_data[i * 12 + 2 : (i + 1) * 12 + 2]                                                                                                                                                         
  4148 │       │       │       │        │       │               │       │                            )                                                                                                                                                                                                             
  4149 │       │       │       │        │       │               │       │                            if ifd_tag == 0x1101:                                                                                                                                                                                         
  4150 │       │       │       │        │       │               │       │                                # CameraInfo                                                                                                                                                                                              
  4151 │       │       │       │        │       │               │       │                                (offset,) = struct.unpack(">L", data)                                                                                                                                                                     
  4152 │       │       │       │        │       │               │       │                                self.fp.seek(offset)                                                                                                                                                                                      
  4153 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4154 │       │       │       │        │       │               │       │                                camerainfo: dict[str, int | bytes] = {                                                                                                                                                                    
  4155 │       │       │       │        │       │               │       │                                    "ModelID": self.fp.read(4)                                                                                                                                                                            
  4156 │       │       │       │        │       │               │       │                                }                                                                                                                                                                                                         
  4157 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4158 │       │       │       │        │       │               │       │                                self.fp.read(4)                                                                                                                                                                                           
  4159 │       │       │       │        │       │               │       │                                # Seconds since 2000                                                                                                                                                                                      
  4160 │       │       │       │        │       │               │       │                                camerainfo["TimeStamp"] = i32le(self.fp.read(12))                                                                                                                                                         
  4161 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4162 │       │       │       │        │       │               │       │                                self.fp.read(4)                                                                                                                                                                                           
  4163 │       │       │       │        │       │               │       │                                camerainfo["InternalSerialNumber"] = self.fp.read(4)                                                                                                                                                      
  4164 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4165 │       │       │       │        │       │               │       │                                self.fp.read(12)                                                                                                                                                                                          
  4166 │       │       │       │        │       │               │       │                                parallax = self.fp.read(4)                                                                                                                                                                                
  4167 │       │       │       │        │       │               │       │                                handler = ImageFileDirectory_v2._load_dispatch[                                                                                                                                                           
  4168 │       │       │       │        │       │               │       │                                    TiffTags.FLOAT                                                                                                                                                                                        
  4169 │       │       │       │        │       │               │       │                                ][1]                                                                                                                                                                                                      
  4170 │       │       │       │        │       │               │       │                                camerainfo["Parallax"] = handler(                                                                                                                                                                         
  4171 │       │       │       │        │       │               │       │                                    ImageFileDirectory_v2(), parallax, False                                                                                                                                                              
  4172 │       │       │       │        │       │               │       │                                )[0]                                                                                                                                                                                                      
  4173 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4174 │       │       │       │        │       │               │       │                                self.fp.read(4)                                                                                                                                                                                           
  4175 │       │       │       │        │       │               │       │                                camerainfo["Category"] = self.fp.read(2)                                                                                                                                                                  
  4176 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4177 │       │       │       │        │       │               │       │                                makernote = {0x1101: camerainfo}                                                                                                                                                                          
  4178 │       │       │       │        │       │               │       │                        self._ifds[tag] = makernote                                                                                                                                                                                       
  4179 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
  4180 │       │       │       │        │       │               │       │                    # Interop                                                                                                                                                                                                             
  4181 │       │       │       │        │       │               │       │                    ifd = self._get_ifd_dict(tag_data, tag)                                                                                                                                                                               
  4182 │       │       │       │        │       │               │       │                    if ifd is not None:                                                                                                                                                                                                   
  4183 │       │       │       │        │       │               │       │                        self._ifds[tag] = ifd                                                                                                                                                                                             
  4184 │       │       │       │        │       │               │       │        ifd = self._ifds.setdefault(tag, {})                                                                                                                                                                                              
  4185 │       │       │       │        │       │               │       │        if tag == ExifTags.IFD.Exif and self._hidden_data:                                                                                                                                                                                
  4186 │       │       │       │        │       │               │       │            ifd = {                                                                                                                                                                                                                       
  4187 │       │       │       │        │       │               │       │                k: v                                                                                                                                                                                                                      
  4188 │       │       │       │        │       │               │       │                for (k, v) in ifd.items()                                                                                                                                                                                                 
  4189 │       │       │       │        │       │               │       │                if k not in (ExifTags.IFD.Interop, ExifTags.IFD.MakerNote)                                                                                                                                                                
  4190 │       │       │       │        │       │               │       │            }                                                                                                                                                                                                                             
  4191 │       │       │       │        │       │               │       │        return ifd                                                                                                                                                                                                                        
  4192 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4193 │       │       │       │        │       │               │       │    def hide_offsets(self) -> None:                                                                                                                                                                                                       
  4194 │       │       │       │        │       │               │       │        for tag in (ExifTags.IFD.Exif, ExifTags.IFD.GPSInfo):                                                                                                                                                                             
  4195 │       │       │       │        │       │               │       │            if tag in self:                                                                                                                                                                                                               
  4196 │       │       │       │        │       │               │       │                self._hidden_data[tag] = self[tag]                                                                                                                                                                                        
  4197 │       │       │       │        │       │               │       │                del self[tag]                                                                                                                                                                                                             
  4198 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4199 │       │       │       │        │       │               │       │    def __str__(self) -> str:                                                                                                                                                                                                             
  4200 │       │       │       │        │       │               │       │        if self._info is not None:                                                                                                                                                                                                        
  4201 │       │       │       │        │       │               │       │            # Load all keys into self._data                                                                                                                                                                                               
  4202 │       │       │       │        │       │               │       │            for tag in self._info:                                                                                                                                                                                                        
  4203 │       │       │       │        │       │               │       │                self[tag]                                                                                                                                                                                                                 
  4204 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4205 │       │       │       │        │       │               │       │        return str(self._data)                                                                                                                                                                                                            
  4206 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4207 │       │       │       │        │       │               │       │    def __len__(self) -> int:                                                                                                                                                                                                             
  4208 │       │       │       │        │       │               │       │        keys = set(self._data)                                                                                                                                                                                                            
  4209 │       │       │       │        │       │               │       │        if self._info is not None:                                                                                                                                                                                                        
  4210 │       │       │       │        │       │               │       │            keys.update(self._info)                                                                                                                                                                                                       
  4211 │       │       │       │        │       │               │       │        return len(keys)                                                                                                                                                                                                                  
  4212 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4213 │       │       │       │        │       │               │       │    def __getitem__(self, tag: int) -> Any:                                                                                                                                                                                               
  4214 │       │       │       │        │       │               │       │        if self._info is not None and tag not in self._data and tag in self._info:                                                                                                                                                        
  4215 │       │       │       │        │       │               │       │            self._data[tag] = self._fixup(self._info[tag])                                                                                                                                                                                
  4216 │       │       │       │        │       │               │       │            del self._info[tag]                                                                                                                                                                                                           
  4217 │       │       │       │        │       │               │       │        return self._data[tag]                                                                                                                                                                                                            
  4218 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4219 │       │       │       │        │       │               │       │    def __contains__(self, tag: object) -> bool:                                                                                                                                                                                          
  4220 │       │       │       │        │       │               │       │        return tag in self._data or (self._info is not None and tag in self._info)                                                                                                                                                        
  4221 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4222 │       │       │       │        │       │               │       │    def __setitem__(self, tag: int, value: Any) -> None:                                                                                                                                                                                  
  4223 │       │       │       │        │       │               │       │        if self._info is not None and tag in self._info:                                                                                                                                                                                  
  4224 │       │       │       │        │       │               │       │            del self._info[tag]                                                                                                                                                                                                           
  4225 │       │       │       │        │       │               │       │        self._data[tag] = value                                                                                                                                                                                                           
  4226 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4227 │       │       │       │        │       │               │       │    def __delitem__(self, tag: int) -> None:                                                                                                                                                                                              
  4228 │       │       │       │        │       │               │       │        if self._info is not None and tag in self._info:                                                                                                                                                                                  
  4229 │       │       │       │        │       │               │       │            del self._info[tag]                                                                                                                                                                                                           
  4230 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  4231 │       │       │       │        │       │               │       │            del self._data[tag]                                                                                                                                                                                                           
  4232 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  4233 │       │       │       │        │       │               │       │    def __iter__(self) -> Iterator[int]:                                                                                                                                                                                                  
  4234 │       │       │       │        │       │               │       │        keys = set(self._data)                                                                                                                                                                                                            
  4235 │       │       │       │        │       │               │       │        if self._info is not None:                                                                                                                                                                                                        
  4236 │       │       │       │        │       │               │       │            keys.update(self._info)                                                                                                                                                                                                       
  4237 │       │       │       │        │       │               │       │        return iter(keys)                                                                                                                                                                                                                 
  4238 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
╶──────┼───────┼───────┼───────┼────────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │       │        │       │               │       │function summary for /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/.venv/lib/python3.12/site-packages/PIL/Image.py                                                                                                     
   338 │       │       │       │        │       │               │       │preinit                                                                                                                                                                                                                                   
  2469 │       │       │       │  96%   │   13M │█   3%         │       │Image.save                                                                                                                                                                                                                                
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
Top PEAK memory consumption, by line:
(1)  2576:    13 MB                                                                                                                                                                                                                                                                                                 
                                                                                 /p/software/juwels/stages/2025/software/Python/3.12.3-GCCcore-13.3.0/lib/python3.12/tokenize.py: % of time =   0.00% (3.986ms) out of 2m:38.834s.                                                                                 
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/software/juwels/stages/2025/software/Python/3.12.3-GCCcore-13.3.0/lib/python3.12/tokenize.py                                                                                                                                           
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │"""Tokenization help for Python programs.                                                                                                                                                                                                 
     2 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
     3 │       │       │       │        │       │               │       │tokenize(readline) is a generator that breaks a stream of bytes into                                                                                                                                                                      
     4 │       │       │       │        │       │               │       │Python tokens.  It decodes the bytes according to PEP-0263 for                                                                                                                                                                            
     5 │       │       │       │        │       │               │       │determining source file encoding.                                                                                                                                                                                                         
     6 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
     7 │       │       │       │        │       │               │       │It accepts a readline-like method which is called repeatedly to get the                                                                                                                                                                   
     8 │       │       │       │        │       │               │       │next line of input (or b"" for EOF).  It generates 5-tuples with these                                                                                                                                                                    
     9 │       │       │       │        │       │               │       │members:                                                                                                                                                                                                                                  
    10 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    11 │       │       │       │        │       │               │       │    the token type (see token.py)                                                                                                                                                                                                         
    12 │       │       │       │        │       │               │       │    the token (a string)                                                                                                                                                                                                                  
    13 │       │       │       │        │       │               │       │    the starting (row, column) indices of the token (a 2-tuple of ints)                                                                                                                                                                   
    14 │       │       │       │        │       │               │       │    the ending (row, column) indices of the token (a 2-tuple of ints)                                                                                                                                                                     
    15 │       │       │       │        │       │               │       │    the original line (string)                                                                                                                                                                                                            
    16 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    17 │       │       │       │        │       │               │       │It is designed to match the working of the Python tokenizer exactly, except                                                                                                                                                               
    18 │       │       │       │        │       │               │       │that it produces COMMENT tokens for comments and gives type OP for all                                                                                                                                                                    
    19 │       │       │       │        │       │               │       │operators.  Additionally, all token lists start with an ENCODING token                                                                                                                                                                    
    20 │       │       │       │        │       │               │       │which tells you which encoding was used to decode the bytes stream.                                                                                                                                                                       
    21 │       │       │       │        │       │               │       │"""                                                                                                                                                                                                                                       
    22 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    23 │       │       │       │        │       │               │       │__author__ = 'Ka-Ping Yee <ping@lfw.org>'                                                                                                                                                                                                 
    24 │       │       │       │        │       │               │       │__credits__ = ('GvR, ESR, Tim Peters, Thomas Wouters, Fred Drake, '                                                                                                                                                                       
    25 │       │       │       │        │       │               │       │               'Skip Montanaro, Raymond Hettinger, Trent Nelson, '                                                                                                                                                                        
    26 │       │       │       │        │       │               │       │               'Michael Foord')                                                                                                                                                                                                           
    27 │       │       │       │        │       │               │       │from builtins import open as _builtin_open                                                                                                                                                                                                
    28 │       │       │       │        │       │               │       │from codecs import lookup, BOM_UTF8                                                                                                                                                                                                       
    29 │       │       │       │        │       │               │       │import collections                                                                                                                                                                                                                        
    30 │       │       │       │        │       │               │       │import functools                                                                                                                                                                                                                          
    31 │       │       │       │        │       │               │       │from io import TextIOWrapper                                                                                                                                                                                                              
    32 │       │       │       │        │       │               │       │import itertools as _itertools                                                                                                                                                                                                            
    33 │       │       │       │        │       │               │       │import re                                                                                                                                                                                                                                 
    34 │       │       │       │        │       │               │       │import sys                                                                                                                                                                                                                                
    35 │       │       │       │        │       │               │       │from token import *                                                                                                                                                                                                                       
    36 │       │       │       │        │       │               │       │from token import EXACT_TOKEN_TYPES                                                                                                                                                                                                       
    37 │       │       │       │        │       │               │       │import _tokenize                                                                                                                                                                                                                          
    38 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    39 │       │       │       │        │       │               │       │cookie_re = re.compile(r'^[ \t\f]*#.*?coding[:=][ \t]*([-\w.]+)', re.ASCII)                                                                                                                                                               
    40 │       │       │       │        │       │               │       │blank_re = re.compile(br'^[ \t\f]*(?:[#\r\n]|$)', re.ASCII)                                                                                                                                                                               
    41 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    42 │       │       │       │        │       │               │       │import token                                                                                                                                                                                                                              
    43 │       │       │       │        │       │               │       │__all__ = token.__all__ + ["tokenize", "generate_tokens", "detect_encoding",                                                                                                                                                              
    44 │       │       │       │        │       │               │       │                           "untokenize", "TokenInfo"]                                                                                                                                                                                     
    45 │       │       │       │        │       │               │       │del token                                                                                                                                                                                                                                 
    46 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    47 │       │       │       │        │       │               │       │class TokenInfo(collections.namedtuple('TokenInfo', 'type string start end line')):                                                                                                                                                       
    48 │       │       │       │        │       │               │       │    def __repr__(self):                                                                                                                                                                                                                   
    49 │       │       │       │        │       │               │       │        annotated_type = '%d (%s)' % (self.type, tok_name[self.type])                                                                                                                                                                     
    50 │       │       │       │        │       │               │       │        return ('TokenInfo(type=%s, string=%r, start=%r, end=%r, line=%r)' %                                                                                                                                                              
    51 │       │       │       │        │       │               │       │                self._replace(type=annotated_type))                                                                                                                                                                                       
    52 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    53 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
    54 │       │       │       │        │       │               │       │    def exact_type(self):                                                                                                                                                                                                                 
    55 │       │       │       │        │       │               │       │        if self.type == OP and self.string in EXACT_TOKEN_TYPES:                                                                                                                                                                          
    56 │       │       │       │        │       │               │       │            return EXACT_TOKEN_TYPES[self.string]                                                                                                                                                                                         
    57 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
    58 │       │       │       │        │       │               │       │            return self.type                                                                                                                                                                                                              
    59 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    60 │       │       │       │        │       │               │       │def group(*choices): return '(' + '|'.join(choices) + ')'                                                                                                                                                                                 
    61 │       │       │       │        │       │               │       │def any(*choices): return group(*choices) + '*'                                                                                                                                                                                           
    62 │       │       │       │        │       │               │       │def maybe(*choices): return group(*choices) + '?'                                                                                                                                                                                         
    63 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    64 │       │       │       │        │       │               │       │# Note: we use unicode matching for names ("\w") but ascii matching for                                                                                                                                                                   
    65 │       │       │       │        │       │               │       │# number literals.                                                                                                                                                                                                                        
    66 │       │       │       │        │       │               │       │Whitespace = r'[ \f\t]*'                                                                                                                                                                                                                  
    67 │       │       │       │        │       │               │       │Comment = r'#[^\r\n]*'                                                                                                                                                                                                                    
    68 │       │       │       │        │       │               │       │Ignore = Whitespace + any(r'\\\r?\n' + Whitespace) + maybe(Comment)                                                                                                                                                                       
    69 │       │       │       │        │       │               │       │Name = r'\w+'                                                                                                                                                                                                                             
    70 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    71 │       │       │       │        │       │               │       │Hexnumber = r'0[xX](?:_?[0-9a-fA-F])+'                                                                                                                                                                                                    
    72 │       │       │       │        │       │               │       │Binnumber = r'0[bB](?:_?[01])+'                                                                                                                                                                                                           
    73 │       │       │       │        │       │               │       │Octnumber = r'0[oO](?:_?[0-7])+'                                                                                                                                                                                                          
    74 │       │       │       │        │       │               │       │Decnumber = r'(?:0(?:_?0)*|[1-9](?:_?[0-9])*)'                                                                                                                                                                                            
    75 │       │       │       │        │       │               │       │Intnumber = group(Hexnumber, Binnumber, Octnumber, Decnumber)                                                                                                                                                                             
    76 │       │       │       │        │       │               │       │Exponent = r'[eE][-+]?[0-9](?:_?[0-9])*'                                                                                                                                                                                                  
    77 │       │       │       │        │       │               │       │Pointfloat = group(r'[0-9](?:_?[0-9])*\.(?:[0-9](?:_?[0-9])*)?',                                                                                                                                                                          
    78 │       │       │       │        │       │               │       │                   r'\.[0-9](?:_?[0-9])*') + maybe(Exponent)                                                                                                                                                                              
    79 │       │       │       │        │       │               │       │Expfloat = r'[0-9](?:_?[0-9])*' + Exponent                                                                                                                                                                                                
    80 │       │       │       │        │       │               │       │Floatnumber = group(Pointfloat, Expfloat)                                                                                                                                                                                                 
    81 │       │       │       │        │       │               │       │Imagnumber = group(r'[0-9](?:_?[0-9])*[jJ]', Floatnumber + r'[jJ]')                                                                                                                                                                       
    82 │       │       │       │        │       │               │       │Number = group(Imagnumber, Floatnumber, Intnumber)                                                                                                                                                                                        
    83 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    84 │       │       │       │        │       │               │       │# Return the empty string, plus all of the valid string prefixes.                                                                                                                                                                         
    85 │       │       │       │        │       │               │       │def _all_string_prefixes():                                                                                                                                                                                                               
    86 │       │       │       │        │       │               │       │    # The valid string prefixes. Only contain the lower case versions,                                                                                                                                                                    
    87 │       │       │       │        │       │               │       │    #  and don't contain any permutations (include 'fr', but not                                                                                                                                                                          
    88 │       │       │       │        │       │               │       │    #  'rf'). The various permutations will be generated.                                                                                                                                                                                 
    89 │       │       │       │        │       │               │       │    _valid_string_prefixes = ['b', 'r', 'u', 'f', 'br', 'fr']                                                                                                                                                                             
    90 │       │       │       │        │       │               │       │    # if we add binary f-strings, add: ['fb', 'fbr']                                                                                                                                                                                      
    91 │       │       │       │        │       │               │       │    result = {''}                                                                                                                                                                                                                         
    92 │       │       │       │        │       │               │       │    for prefix in _valid_string_prefixes:                                                                                                                                                                                                 
    93 │       │       │       │        │       │               │       │        for t in _itertools.permutations(prefix):                                                                                                                                                                                         
    94 │       │       │       │        │       │               │       │            # create a list with upper and lower versions of each                                                                                                                                                                         
    95 │       │       │       │        │       │               │       │            #  character                                                                                                                                                                                                                  
    96 │       │       │       │        │       │               │       │            for u in _itertools.product(*[(c, c.upper()) for c in t]):                                                                                                                                                                    
    97 │       │       │       │        │       │               │       │                result.add(''.join(u))                                                                                                                                                                                                    
    98 │       │       │       │        │       │               │       │    return result                                                                                                                                                                                                                         
    99 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   100 │       │       │       │        │       │               │       │@functools.lru_cache                                                                                                                                                                                                                      
   101 │       │       │       │        │       │               │       │def _compile(expr):                                                                                                                                                                                                                       
   102 │       │       │       │        │       │               │       │    return re.compile(expr, re.UNICODE)                                                                                                                                                                                                   
   103 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   104 │       │       │       │        │       │               │       │# Note that since _all_string_prefixes includes the empty string,                                                                                                                                                                         
   105 │       │       │       │        │       │               │       │#  StringPrefix can be the empty string (making it optional).                                                                                                                                                                             
   106 │       │       │       │        │       │               │       │StringPrefix = group(*_all_string_prefixes())                                                                                                                                                                                             
   107 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   108 │       │       │       │        │       │               │       │# Tail end of ' string.                                                                                                                                                                                                                   
   109 │       │       │       │        │       │               │       │Single = r"[^'\\]*(?:\\.[^'\\]*)*'"                                                                                                                                                                                                       
   110 │       │       │       │        │       │               │       │# Tail end of " string.                                                                                                                                                                                                                   
   111 │       │       │       │        │       │               │       │Double = r'[^"\\]*(?:\\.[^"\\]*)*"'                                                                                                                                                                                                       
   112 │       │       │       │        │       │               │       │# Tail end of ''' string.                                                                                                                                                                                                                 
   113 │       │       │       │        │       │               │       │Single3 = r"[^'\\]*(?:(?:\\.|'(?!''))[^'\\]*)*'''"                                                                                                                                                                                        
   114 │       │       │       │        │       │               │       │# Tail end of """ string.                                                                                                                                                                                                                 
   115 │       │       │       │        │       │               │       │Double3 = r'[^"\\]*(?:(?:\\.|"(?!""))[^"\\]*)*"""'                                                                                                                                                                                        
   116 │       │       │       │        │       │               │       │Triple = group(StringPrefix + "'''", StringPrefix + '"""')                                                                                                                                                                                
   117 │       │       │       │        │       │               │       │# Single-line ' or " string.                                                                                                                                                                                                              
   118 │       │       │       │        │       │               │       │String = group(StringPrefix + r"'[^\n'\\]*(?:\\.[^\n'\\]*)*'",                                                                                                                                                                            
   119 │       │       │       │        │       │               │       │               StringPrefix + r'"[^\n"\\]*(?:\\.[^\n"\\]*)*"')                                                                                                                                                                            
   120 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   121 │       │       │       │        │       │               │       │# Sorting in reverse order puts the long operators before their prefixes.                                                                                                                                                                 
   122 │       │       │       │        │       │               │       │# Otherwise if = came before ==, == would get recognized as two instances                                                                                                                                                                 
   123 │       │       │       │        │       │               │       │# of =.                                                                                                                                                                                                                                   
   124 │       │       │       │        │       │               │       │Special = group(*map(re.escape, sorted(EXACT_TOKEN_TYPES, reverse=True)))                                                                                                                                                                 
   125 │       │       │       │        │       │               │       │Funny = group(r'\r?\n', Special)                                                                                                                                                                                                          
   126 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   127 │       │       │       │        │       │               │       │PlainToken = group(Number, Funny, String, Name)                                                                                                                                                                                           
   128 │       │       │       │        │       │               │       │Token = Ignore + PlainToken                                                                                                                                                                                                               
   129 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   130 │       │       │       │        │       │               │       │# First (or only) line of ' or " string.                                                                                                                                                                                                  
   131 │       │       │       │        │       │               │       │ContStr = group(StringPrefix + r"'[^\n'\\]*(?:\\.[^\n'\\]*)*" +                                                                                                                                                                           
   132 │       │       │       │        │       │               │       │                group("'", r'\\\r?\n'),                                                                                                                                                                                                   
   133 │       │       │       │        │       │               │       │                StringPrefix + r'"[^\n"\\]*(?:\\.[^\n"\\]*)*' +                                                                                                                                                                           
   134 │       │       │       │        │       │               │       │                group('"', r'\\\r?\n'))                                                                                                                                                                                                   
   135 │       │       │       │        │       │               │       │PseudoExtras = group(r'\\\r?\n|\Z', Comment, Triple)                                                                                                                                                                                      
   136 │       │       │       │        │       │               │       │PseudoToken = Whitespace + group(PseudoExtras, Number, Funny, ContStr, Name)                                                                                                                                                              
   137 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   138 │       │       │       │        │       │               │       │# For a given string prefix plus quotes, endpats maps it to a regex                                                                                                                                                                       
   139 │       │       │       │        │       │               │       │#  to match the remainder of that string. _prefix can be empty, for                                                                                                                                                                       
   140 │       │       │       │        │       │               │       │#  a normal single or triple quoted string (with no prefix).                                                                                                                                                                              
   141 │       │       │       │        │       │               │       │endpats = {}                                                                                                                                                                                                                              
   142 │       │       │       │        │       │               │       │for _prefix in _all_string_prefixes():                                                                                                                                                                                                    
   143 │       │       │       │        │       │               │       │    endpats[_prefix + "'"] = Single                                                                                                                                                                                                       
   144 │       │       │       │        │       │               │       │    endpats[_prefix + '"'] = Double                                                                                                                                                                                                       
   145 │       │       │       │        │       │               │       │    endpats[_prefix + "'''"] = Single3                                                                                                                                                                                                    
   146 │       │       │       │        │       │               │       │    endpats[_prefix + '"""'] = Double3                                                                                                                                                                                                    
   147 │       │       │       │        │       │               │       │del _prefix                                                                                                                                                                                                                               
   148 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   149 │       │       │       │        │       │               │       │# A set of all of the single and triple quoted string prefixes,                                                                                                                                                                           
   150 │       │       │       │        │       │               │       │#  including the opening quotes.                                                                                                                                                                                                          
   151 │       │       │       │        │       │               │       │single_quoted = set()                                                                                                                                                                                                                     
   152 │       │       │       │        │       │               │       │triple_quoted = set()                                                                                                                                                                                                                     
   153 │       │       │       │        │       │               │       │for t in _all_string_prefixes():                                                                                                                                                                                                          
   154 │       │       │       │        │       │               │       │    for u in (t + '"', t + "'"):                                                                                                                                                                                                          
   155 │       │       │       │        │       │               │       │        single_quoted.add(u)                                                                                                                                                                                                              
   156 │       │       │       │        │       │               │       │    for u in (t + '"""', t + "'''"):                                                                                                                                                                                                      
   157 │       │       │       │        │       │               │       │        triple_quoted.add(u)                                                                                                                                                                                                              
   158 │       │       │       │        │       │               │       │del t, u                                                                                                                                                                                                                                  
   159 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   160 │       │       │       │        │       │               │       │tabsize = 8                                                                                                                                                                                                                               
   161 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   162 │       │       │       │        │       │               │       │class TokenError(Exception): pass                                                                                                                                                                                                         
   163 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   164 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   165 │       │       │       │        │       │               │       │class StopTokenizing(Exception): pass                                                                                                                                                                                                     
   166 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   167 │       │       │       │        │       │               │       │class Untokenizer:                                                                                                                                                                                                                        
   168 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   169 │       │       │       │        │       │               │       │    def __init__(self):                                                                                                                                                                                                                   
   170 │       │       │       │        │       │               │       │        self.tokens = []                                                                                                                                                                                                                  
   171 │       │       │       │        │       │               │       │        self.prev_row = 1                                                                                                                                                                                                                 
   172 │       │       │       │        │       │               │       │        self.prev_col = 0                                                                                                                                                                                                                 
   173 │       │       │       │        │       │               │       │        self.prev_type = None                                                                                                                                                                                                             
   174 │       │       │       │        │       │               │       │        self.encoding = None                                                                                                                                                                                                              
   175 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   176 │       │       │       │        │       │               │       │    def add_whitespace(self, start):                                                                                                                                                                                                      
   177 │       │       │       │        │       │               │       │        row, col = start                                                                                                                                                                                                                  
   178 │       │       │       │        │       │               │       │        if row < self.prev_row or row == self.prev_row and col < self.prev_col:                                                                                                                                                           
   179 │       │       │       │        │       │               │       │            raise ValueError("start ({},{}) precedes previous end ({},{})"                                                                                                                                                                
   180 │       │       │       │        │       │               │       │                             .format(row, col, self.prev_row, self.prev_col))                                                                                                                                                             
   181 │       │       │       │        │       │               │       │        row_offset = row - self.prev_row                                                                                                                                                                                                  
   182 │       │       │       │        │       │               │       │        if row_offset:                                                                                                                                                                                                                    
   183 │       │       │       │        │       │               │       │            self.tokens.append("\\\n" * row_offset)                                                                                                                                                                                       
   184 │       │       │       │        │       │               │       │            self.prev_col = 0                                                                                                                                                                                                             
   185 │       │       │       │        │       │               │       │        col_offset = col - self.prev_col                                                                                                                                                                                                  
   186 │       │       │       │        │       │               │       │        if col_offset:                                                                                                                                                                                                                    
   187 │       │       │       │        │       │               │       │            self.tokens.append(" " * col_offset)                                                                                                                                                                                          
   188 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   189 │       │       │       │        │       │               │       │    def escape_brackets(self, token):                                                                                                                                                                                                     
   190 │       │       │       │        │       │               │       │        characters = []                                                                                                                                                                                                                   
   191 │       │       │       │        │       │               │       │        consume_until_next_bracket = False                                                                                                                                                                                                
   192 │       │       │       │        │       │               │       │        for character in token:                                                                                                                                                                                                           
   193 │       │       │       │        │       │               │       │            if character == "}":                                                                                                                                                                                                          
   194 │       │       │       │        │       │               │       │                if consume_until_next_bracket:                                                                                                                                                                                            
   195 │       │       │       │        │       │               │       │                    consume_until_next_bracket = False                                                                                                                                                                                    
   196 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
   197 │       │       │       │        │       │               │       │                    characters.append(character)                                                                                                                                                                                          
   198 │       │       │       │        │       │               │       │            if character == "{":                                                                                                                                                                                                          
   199 │       │       │       │        │       │               │       │                n_backslashes = sum(                                                                                                                                                                                                      
   200 │       │       │       │        │       │               │       │                    1 for char in _itertools.takewhile(                                                                                                                                                                                   
   201 │       │       │       │        │       │               │       │                        "\\".__eq__,                                                                                                                                                                                                      
   202 │       │       │       │        │       │               │       │                        characters[-2::-1]                                                                                                                                                                                                
   203 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
   204 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   205 │       │       │       │        │       │               │       │                if n_backslashes % 2 == 0:                                                                                                                                                                                                
   206 │       │       │       │        │       │               │       │                    characters.append(character)                                                                                                                                                                                          
   207 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
   208 │       │       │       │        │       │               │       │                    consume_until_next_bracket = True                                                                                                                                                                                     
   209 │       │       │       │        │       │               │       │            characters.append(character)                                                                                                                                                                                                  
   210 │       │       │       │        │       │               │       │        return "".join(characters)                                                                                                                                                                                                        
   211 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   212 │       │       │       │        │       │               │       │    def untokenize(self, iterable):                                                                                                                                                                                                       
   213 │       │       │       │        │       │               │       │        it = iter(iterable)                                                                                                                                                                                                               
   214 │       │       │       │        │       │               │       │        indents = []                                                                                                                                                                                                                      
   215 │       │       │       │        │       │               │       │        startline = False                                                                                                                                                                                                                 
   216 │       │       │       │        │       │               │       │        for t in it:                                                                                                                                                                                                                      
   217 │       │       │       │        │       │               │       │            if len(t) == 2:                                                                                                                                                                                                               
   218 │       │       │       │        │       │               │       │                self.compat(t, it)                                                                                                                                                                                                        
   219 │       │       │       │        │       │               │       │                break                                                                                                                                                                                                                     
   220 │       │       │       │        │       │               │       │            tok_type, token, start, end, line = t                                                                                                                                                                                         
   221 │       │       │       │        │       │               │       │            if tok_type == ENCODING:                                                                                                                                                                                                      
   222 │       │       │       │        │       │               │       │                self.encoding = token                                                                                                                                                                                                     
   223 │       │       │       │        │       │               │       │                continue                                                                                                                                                                                                                  
   224 │       │       │       │        │       │               │       │            if tok_type == ENDMARKER:                                                                                                                                                                                                     
   225 │       │       │       │        │       │               │       │                break                                                                                                                                                                                                                     
   226 │       │       │       │        │       │               │       │            if tok_type == INDENT:                                                                                                                                                                                                        
   227 │       │       │       │        │       │               │       │                indents.append(token)                                                                                                                                                                                                     
   228 │       │       │       │        │       │               │       │                continue                                                                                                                                                                                                                  
   229 │       │       │       │        │       │               │       │            elif tok_type == DEDENT:                                                                                                                                                                                                      
   230 │       │       │       │        │       │               │       │                indents.pop()                                                                                                                                                                                                             
   231 │       │       │       │        │       │               │       │                self.prev_row, self.prev_col = end                                                                                                                                                                                        
   232 │       │       │       │        │       │               │       │                continue                                                                                                                                                                                                                  
   233 │       │       │       │        │       │               │       │            elif tok_type in (NEWLINE, NL):                                                                                                                                                                                               
   234 │       │       │       │        │       │               │       │                startline = True                                                                                                                                                                                                          
   235 │       │       │       │        │       │               │       │            elif startline and indents:                                                                                                                                                                                                   
   236 │       │       │       │        │       │               │       │                indent = indents[-1]                                                                                                                                                                                                      
   237 │       │       │       │        │       │               │       │                if start[1] >= len(indent):                                                                                                                                                                                               
   238 │       │       │       │        │       │               │       │                    self.tokens.append(indent)                                                                                                                                                                                            
   239 │       │       │       │        │       │               │       │                    self.prev_col = len(indent)                                                                                                                                                                                           
   240 │       │       │       │        │       │               │       │                startline = False                                                                                                                                                                                                         
   241 │       │       │       │        │       │               │       │            elif tok_type == FSTRING_MIDDLE:                                                                                                                                                                                              
   242 │       │       │       │        │       │               │       │                if '{' in token or '}' in token:                                                                                                                                                                                          
   243 │       │       │       │        │       │               │       │                    token = self.escape_brackets(token)                                                                                                                                                                                   
   244 │       │       │       │        │       │               │       │                    last_line = token.splitlines()[-1]                                                                                                                                                                                    
   245 │       │       │       │        │       │               │       │                    end_line, end_col = end                                                                                                                                                                                               
   246 │       │       │       │        │       │               │       │                    extra_chars = last_line.count("{{") + last_line.count("}}")                                                                                                                                                           
   247 │       │       │       │        │       │               │       │                    end = (end_line, end_col + extra_chars)                                                                                                                                                                               
   248 │       │       │       │        │       │               │       │            elif tok_type in (STRING, FSTRING_START) and self.prev_type in (STRING, FSTRING_END):                                                                                                                                         
   249 │       │       │       │        │       │               │       │                self.tokens.append(" ")                                                                                                                                                                                                   
   250 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   251 │       │       │       │        │       │               │       │            self.add_whitespace(start)                                                                                                                                                                                                    
   252 │       │       │       │        │       │               │       │            self.tokens.append(token)                                                                                                                                                                                                     
   253 │       │       │       │        │       │               │       │            self.prev_row, self.prev_col = end                                                                                                                                                                                            
   254 │       │       │       │        │       │               │       │            if tok_type in (NEWLINE, NL):                                                                                                                                                                                                 
   255 │       │       │       │        │       │               │       │                self.prev_row += 1                                                                                                                                                                                                        
   256 │       │       │       │        │       │               │       │                self.prev_col = 0                                                                                                                                                                                                         
   257 │       │       │       │        │       │               │       │            self.prev_type = tok_type                                                                                                                                                                                                     
   258 │       │       │       │        │       │               │       │        return "".join(self.tokens)                                                                                                                                                                                                       
   259 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   260 │       │       │       │        │       │               │       │    def compat(self, token, iterable):                                                                                                                                                                                                    
   261 │       │       │       │        │       │               │       │        indents = []                                                                                                                                                                                                                      
   262 │       │       │       │        │       │               │       │        toks_append = self.tokens.append                                                                                                                                                                                                  
   263 │       │       │       │        │       │               │       │        startline = token[0] in (NEWLINE, NL)                                                                                                                                                                                             
   264 │       │       │       │        │       │               │       │        prevstring = False                                                                                                                                                                                                                
   265 │       │       │       │        │       │               │       │        in_fstring = 0                                                                                                                                                                                                                    
   266 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   267 │       │       │       │        │       │               │       │        for tok in _itertools.chain([token], iterable):                                                                                                                                                                                   
   268 │       │       │       │        │       │               │       │            toknum, tokval = tok[:2]                                                                                                                                                                                                      
   269 │       │       │       │        │       │               │       │            if toknum == ENCODING:                                                                                                                                                                                                        
   270 │       │       │       │        │       │               │       │                self.encoding = tokval                                                                                                                                                                                                    
   271 │       │       │       │        │       │               │       │                continue                                                                                                                                                                                                                  
   272 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   273 │       │       │       │        │       │               │       │            if toknum in (NAME, NUMBER):                                                                                                                                                                                                  
   274 │       │       │       │        │       │               │       │                tokval += ' '                                                                                                                                                                                                             
   275 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   276 │       │       │       │        │       │               │       │            # Insert a space between two consecutive strings                                                                                                                                                                              
   277 │       │       │       │        │       │               │       │            if toknum == STRING:                                                                                                                                                                                                          
   278 │       │       │       │        │       │               │       │                if prevstring:                                                                                                                                                                                                            
   279 │       │       │       │        │       │               │       │                    tokval = ' ' + tokval                                                                                                                                                                                                 
   280 │       │       │       │        │       │               │       │                prevstring = True                                                                                                                                                                                                         
   281 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   282 │       │       │       │        │       │               │       │                prevstring = False                                                                                                                                                                                                        
   283 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   284 │       │       │       │        │       │               │       │            if toknum == FSTRING_START:                                                                                                                                                                                                   
   285 │       │       │       │        │       │               │       │                in_fstring += 1                                                                                                                                                                                                           
   286 │       │       │       │        │       │               │       │            elif toknum == FSTRING_END:                                                                                                                                                                                                   
   287 │       │       │       │        │       │               │       │                in_fstring -= 1                                                                                                                                                                                                           
   288 │       │       │       │        │       │               │       │            if toknum == INDENT:                                                                                                                                                                                                          
   289 │       │       │       │        │       │               │       │                indents.append(tokval)                                                                                                                                                                                                    
   290 │       │       │       │        │       │               │       │                continue                                                                                                                                                                                                                  
   291 │       │       │       │        │       │               │       │            elif toknum == DEDENT:                                                                                                                                                                                                        
   292 │       │       │       │        │       │               │       │                indents.pop()                                                                                                                                                                                                             
   293 │       │       │       │        │       │               │       │                continue                                                                                                                                                                                                                  
   294 │       │       │       │        │       │               │       │            elif toknum in (NEWLINE, NL):                                                                                                                                                                                                 
   295 │       │       │       │        │       │               │       │                startline = True                                                                                                                                                                                                          
   296 │       │       │       │        │       │               │       │            elif startline and indents:                                                                                                                                                                                                   
   297 │       │       │       │        │       │               │       │                toks_append(indents[-1])                                                                                                                                                                                                  
   298 │       │       │       │        │       │               │       │                startline = False                                                                                                                                                                                                         
   299 │       │       │       │        │       │               │       │            elif toknum == FSTRING_MIDDLE:                                                                                                                                                                                                
   300 │       │       │       │        │       │               │       │                tokval = self.escape_brackets(tokval)                                                                                                                                                                                     
   301 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   302 │       │       │       │        │       │               │       │            # Insert a space between two consecutive brackets if we are in an f-string                                                                                                                                                    
   303 │       │       │       │        │       │               │       │            if tokval in {"{", "}"} and self.tokens and self.tokens[-1] == tokval and in_fstring:                                                                                                                                         
   304 │       │       │       │        │       │               │       │                tokval = ' ' + tokval                                                                                                                                                                                                     
   305 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   306 │       │       │       │        │       │               │       │            # Insert a space between two consecutive f-strings                                                                                                                                                                            
   307 │       │       │       │        │       │               │       │            if toknum in (STRING, FSTRING_START) and self.prev_type in (STRING, FSTRING_END):                                                                                                                                             
   308 │       │       │       │        │       │               │       │                self.tokens.append(" ")                                                                                                                                                                                                   
   309 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   310 │       │       │       │        │       │               │       │            toks_append(tokval)                                                                                                                                                                                                           
   311 │       │       │       │        │       │               │       │            self.prev_type = toknum                                                                                                                                                                                                       
   312 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   313 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   314 │       │       │       │        │       │               │       │def untokenize(iterable):                                                                                                                                                                                                                 
   315 │       │       │       │        │       │               │       │    """Transform tokens back into Python source code.                                                                                                                                                                                     
   316 │       │       │       │        │       │               │       │    It returns a bytes object, encoded using the ENCODING                                                                                                                                                                                 
   317 │       │       │       │        │       │               │       │    token, which is the first token sequence output by tokenize.                                                                                                                                                                          
   318 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   319 │       │       │       │        │       │               │       │    Each element returned by the iterable must be a token sequence                                                                                                                                                                        
   320 │       │       │       │        │       │               │       │    with at least two elements, a token number and token value.  If                                                                                                                                                                       
   321 │       │       │       │        │       │               │       │    only two tokens are passed, the resulting output is poor.                                                                                                                                                                             
   322 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   323 │       │       │       │        │       │               │       │    Round-trip invariant for full input:                                                                                                                                                                                                  
   324 │       │       │       │        │       │               │       │        Untokenized source will match input source exactly                                                                                                                                                                                
   325 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   326 │       │       │       │        │       │               │       │    Round-trip invariant for limited input:                                                                                                                                                                                               
   327 │       │       │       │        │       │               │       │        # Output bytes will tokenize back to the input                                                                                                                                                                                    
   328 │       │       │       │        │       │               │       │        t1 = [tok[:2] for tok in tokenize(f.readline)]                                                                                                                                                                                    
   329 │       │       │       │        │       │               │       │        newcode = untokenize(t1)                                                                                                                                                                                                          
   330 │       │       │       │        │       │               │       │        readline = BytesIO(newcode).readline                                                                                                                                                                                              
   331 │       │       │       │        │       │               │       │        t2 = [tok[:2] for tok in tokenize(readline)]                                                                                                                                                                                      
   332 │       │       │       │        │       │               │       │        assert t1 == t2                                                                                                                                                                                                                   
   333 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   334 │       │       │       │        │       │               │       │    ut = Untokenizer()                                                                                                                                                                                                                    
   335 │       │       │       │        │       │               │       │    out = ut.untokenize(iterable)                                                                                                                                                                                                         
   336 │       │       │       │        │       │               │       │    if ut.encoding is not None:                                                                                                                                                                                                           
   337 │       │       │       │        │       │               │       │        out = out.encode(ut.encoding)                                                                                                                                                                                                     
   338 │       │       │       │        │       │               │       │    return out                                                                                                                                                                                                                            
   339 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   340 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   341 │       │       │       │        │       │               │       │def _get_normal_name(orig_enc):                                                                                                                                                                                                           
   342 │       │       │       │        │       │               │       │    """Imitates get_normal_name in tokenizer.c."""                                                                                                                                                                                        
   343 │       │       │       │        │       │               │       │    # Only care about the first 12 characters.                                                                                                                                                                                            
   344 │       │       │       │        │       │               │       │    enc = orig_enc[:12].lower().replace("_", "-")                                                                                                                                                                                         
   345 │       │       │       │        │       │               │       │    if enc == "utf-8" or enc.startswith("utf-8-"):                                                                                                                                                                                        
   346 │       │       │       │        │       │               │       │        return "utf-8"                                                                                                                                                                                                                    
   347 │       │       │       │        │       │               │       │    if enc in ("latin-1", "iso-8859-1", "iso-latin-1") or \                                                                                                                                                                               
   348 │       │       │       │        │       │               │       │       enc.startswith(("latin-1-", "iso-8859-1-", "iso-latin-1-")):                                                                                                                                                                       
   349 │       │       │       │        │       │               │       │        return "iso-8859-1"                                                                                                                                                                                                               
   350 │       │       │       │        │       │               │       │    return orig_enc                                                                                                                                                                                                                       
   351 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   352 │       │       │       │        │       │               │       │def detect_encoding(readline):                                                                                                                                                                                                            
   353 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   354 │       │       │       │        │       │               │       │    The detect_encoding() function is used to detect the encoding that should                                                                                                                                                             
   355 │       │       │       │        │       │               │       │    be used to decode a Python source file.  It requires one argument, readline,                                                                                                                                                          
   356 │       │       │       │        │       │               │       │    in the same way as the tokenize() generator.                                                                                                                                                                                          
   357 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   358 │       │       │       │        │       │               │       │    It will call readline a maximum of twice, and return the encoding used                                                                                                                                                                
   359 │       │       │       │        │       │               │       │    (as a string) and a list of any lines (left as bytes) it has read in.                                                                                                                                                                 
   360 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   361 │       │       │       │        │       │               │       │    It detects the encoding from the presence of a utf-8 bom or an encoding                                                                                                                                                               
   362 │       │       │       │        │       │               │       │    cookie as specified in pep-0263.  If both a bom and a cookie are present,                                                                                                                                                             
   363 │       │       │       │        │       │               │       │    but disagree, a SyntaxError will be raised.  If the encoding cookie is an                                                                                                                                                             
   364 │       │       │       │        │       │               │       │    invalid charset, raise a SyntaxError.  Note that if a utf-8 bom is found,                                                                                                                                                             
   365 │       │       │       │        │       │               │       │    'utf-8-sig' is returned.                                                                                                                                                                                                              
   366 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   367 │       │       │       │        │       │               │       │    If no encoding is specified, then the default of 'utf-8' will be returned.                                                                                                                                                            
   368 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   369 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   370 │       │       │       │        │       │               │       │        filename = readline.__self__.name                                                                                                                                                                                                 
   371 │       │       │       │        │       │               │       │    except AttributeError:                                                                                                                                                                                                                
   372 │       │       │       │        │       │               │       │        filename = None                                                                                                                                                                                                                   
   373 │       │       │       │        │       │               │       │    bom_found = False                                                                                                                                                                                                                     
   374 │       │       │       │        │       │               │       │    encoding = None                                                                                                                                                                                                                       
   375 │       │       │       │        │       │               │       │    default = 'utf-8'                                                                                                                                                                                                                     
   376 │       │       │       │        │       │               │       │    def read_or_stop():                                                                                                                                                                                                                   
   377 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   378 │       │       │       │        │       │               │       │            return readline()                                                                                                                                                                                                             
   379 │       │       │       │        │       │               │       │        except StopIteration:                                                                                                                                                                                                             
   380 │       │       │       │        │       │               │       │            return b''                                                                                                                                                                                                                    
   381 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   382 │       │       │       │        │       │               │       │    def find_cookie(line):                                                                                                                                                                                                                
   383 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   384 │       │       │       │        │       │               │       │            # Decode as UTF-8. Either the line is an encoding declaration,                                                                                                                                                                
   385 │       │       │       │        │       │               │       │            # in which case it should be pure ASCII, or it must be UTF-8                                                                                                                                                                  
   386 │       │       │       │        │       │               │       │            # per default encoding.                                                                                                                                                                                                       
   387 │       │       │       │        │       │               │       │            line_string = line.decode('utf-8')                                                                                                                                                                                            
   388 │       │       │       │        │       │               │       │        except UnicodeDecodeError:                                                                                                                                                                                                        
   389 │       │       │       │        │       │               │       │            msg = "invalid or missing encoding declaration"                                                                                                                                                                               
   390 │       │       │       │        │       │               │       │            if filename is not None:                                                                                                                                                                                                      
   391 │       │       │       │        │       │               │       │                msg = '{} for {!r}'.format(msg, filename)                                                                                                                                                                                 
   392 │       │       │       │        │       │               │       │            raise SyntaxError(msg)                                                                                                                                                                                                        
   393 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   394 │       │       │       │        │       │               │       │        match = cookie_re.match(line_string)                                                                                                                                                                                              
   395 │       │       │       │        │       │               │       │        if not match:                                                                                                                                                                                                                     
   396 │       │       │       │        │       │               │       │            return None                                                                                                                                                                                                                   
   397 │       │       │       │        │       │               │       │        encoding = _get_normal_name(match.group(1))                                                                                                                                                                                       
   398 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
   399 │       │       │       │        │       │               │       │            codec = lookup(encoding)                                                                                                                                                                                                      
   400 │       │       │       │        │       │               │       │        except LookupError:                                                                                                                                                                                                               
   401 │       │       │       │        │       │               │       │            # This behaviour mimics the Python interpreter                                                                                                                                                                                
   402 │       │       │       │        │       │               │       │            if filename is None:                                                                                                                                                                                                          
   403 │       │       │       │        │       │               │       │                msg = "unknown encoding: " + encoding                                                                                                                                                                                     
   404 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   405 │       │       │       │        │       │               │       │                msg = "unknown encoding for {!r}: {}".format(filename,                                                                                                                                                                    
   406 │       │       │       │        │       │               │       │                        encoding)                                                                                                                                                                                                         
   407 │       │       │       │        │       │               │       │            raise SyntaxError(msg)                                                                                                                                                                                                        
   408 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   409 │       │       │       │        │       │               │       │        if bom_found:                                                                                                                                                                                                                     
   410 │       │       │       │        │       │               │       │            if encoding != 'utf-8':                                                                                                                                                                                                       
   411 │       │       │       │        │       │               │       │                # This behaviour mimics the Python interpreter                                                                                                                                                                            
   412 │       │       │       │        │       │               │       │                if filename is None:                                                                                                                                                                                                      
   413 │       │       │       │        │       │               │       │                    msg = 'encoding problem: utf-8'                                                                                                                                                                                       
   414 │       │       │       │        │       │               │       │                else:                                                                                                                                                                                                                     
   415 │       │       │       │        │       │               │       │                    msg = 'encoding problem for {!r}: utf-8'.format(filename)                                                                                                                                                             
   416 │       │       │       │        │       │               │       │                raise SyntaxError(msg)                                                                                                                                                                                                    
   417 │       │       │       │        │       │               │       │            encoding += '-sig'                                                                                                                                                                                                            
   418 │       │       │       │        │       │               │       │        return encoding                                                                                                                                                                                                                   
   419 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   420 │       │       │       │        │       │               │       │    first = read_or_stop()                                                                                                                                                                                                                
   421 │       │       │       │        │       │               │       │    if first.startswith(BOM_UTF8):                                                                                                                                                                                                        
   422 │       │       │       │        │       │               │       │        bom_found = True                                                                                                                                                                                                                  
   423 │       │       │       │        │       │               │       │        first = first[3:]                                                                                                                                                                                                                 
   424 │       │       │       │        │       │               │       │        default = 'utf-8-sig'                                                                                                                                                                                                             
   425 │       │       │       │        │       │               │       │    if not first:                                                                                                                                                                                                                         
   426 │       │       │       │        │       │               │       │        return default, []                                                                                                                                                                                                                
   427 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   428 │       │       │       │        │       │               │       │    encoding = find_cookie(first)                                                                                                                                                                                                         
   429 │       │       │       │        │       │               │       │    if encoding:                                                                                                                                                                                                                          
   430 │       │       │       │        │       │               │       │        return encoding, [first]                                                                                                                                                                                                          
   431 │       │       │       │        │       │               │       │    if not blank_re.match(first):                                                                                                                                                                                                         
   432 │       │       │       │        │       │               │       │        return default, [first]                                                                                                                                                                                                           
   433 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   434 │       │       │       │        │       │               │       │    second = read_or_stop()                                                                                                                                                                                                               
   435 │       │       │       │        │       │               │       │    if not second:                                                                                                                                                                                                                        
   436 │       │       │       │        │       │               │       │        return default, [first]                                                                                                                                                                                                           
   437 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   438 │       │       │       │        │       │               │       │    encoding = find_cookie(second)                                                                                                                                                                                                        
   439 │       │       │       │        │       │               │       │    if encoding:                                                                                                                                                                                                                          
   440 │       │       │       │        │       │               │       │        return encoding, [first, second]                                                                                                                                                                                                  
   441 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   442 │       │       │       │        │       │               │       │    return default, [first, second]                                                                                                                                                                                                       
   443 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   444 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   445 │       │       │       │        │       │               │       │def open(filename):                                                                                                                                                                                                                       
   446 │       │       │       │        │       │               │       │    """Open a file in read only mode using the encoding detected by                                                                                                                                                                       
   447 │       │       │       │        │       │               │       │    detect_encoding().                                                                                                                                                                                                                    
   448 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   449 │       │       │       │  98%   │   13M │▁   3%         │       │    buffer = _builtin_open(filename, 'rb')                                                                                                                                                                                                
   450 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   451 │       │       │       │        │       │               │       │        encoding, lines = detect_encoding(buffer.readline)                                                                                                                                                                                
   452 │       │       │       │        │       │               │       │        buffer.seek(0)                                                                                                                                                                                                                    
   453 │       │       │       │        │       │               │       │        text = TextIOWrapper(buffer, encoding, line_buffering=True)                                                                                                                                                                       
   454 │       │       │       │        │       │               │       │        text.mode = 'r'                                                                                                                                                                                                                   
   455 │       │       │       │        │       │               │       │        return text                                                                                                                                                                                                                       
   456 │       │       │       │        │       │               │       │    except:                                                                                                                                                                                                                               
   457 │       │       │       │        │       │               │       │        buffer.close()                                                                                                                                                                                                                    
   458 │       │       │       │        │       │               │       │        raise                                                                                                                                                                                                                             
   459 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   460 │       │       │       │        │       │               │       │def tokenize(readline):                                                                                                                                                                                                                   
   461 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   462 │       │       │       │        │       │               │       │    The tokenize() generator requires one argument, readline, which                                                                                                                                                                       
   463 │       │       │       │        │       │               │       │    must be a callable object which provides the same interface as the                                                                                                                                                                    
   464 │       │       │       │        │       │               │       │    readline() method of built-in file objects.  Each call to the function                                                                                                                                                                
   465 │       │       │       │        │       │               │       │    should return one line of input as bytes.  Alternatively, readline                                                                                                                                                                    
   466 │       │       │       │        │       │               │       │    can be a callable function terminating with StopIteration:                                                                                                                                                                            
   467 │       │       │       │        │       │               │       │        readline = open(myfile, 'rb').__next__  # Example of alternate readline                                                                                                                                                           
   468 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   469 │       │       │       │        │       │               │       │    The generator produces 5-tuples with these members: the token type; the                                                                                                                                                               
   470 │       │       │       │        │       │               │       │    token string; a 2-tuple (srow, scol) of ints specifying the row and                                                                                                                                                                   
   471 │       │       │       │        │       │               │       │    column where the token begins in the source; a 2-tuple (erow, ecol) of                                                                                                                                                                
   472 │       │       │       │        │       │               │       │    ints specifying the row and column where the token ends in the source;                                                                                                                                                                
   473 │       │       │       │        │       │               │       │    and the line on which the token was found.  The line passed is the                                                                                                                                                                    
   474 │       │       │       │        │       │               │       │    physical line.                                                                                                                                                                                                                        
   475 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   476 │       │       │       │        │       │               │       │    The first token sequence will always be an ENCODING token                                                                                                                                                                             
   477 │       │       │       │        │       │               │       │    which tells you which encoding was used to decode the bytes stream.                                                                                                                                                                   
   478 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   479 │       │       │       │        │       │               │       │    encoding, consumed = detect_encoding(readline)                                                                                                                                                                                        
   480 │       │       │       │        │       │               │       │    rl_gen = _itertools.chain(consumed, iter(readline, b""))                                                                                                                                                                              
   481 │       │       │       │        │       │               │       │    if encoding is not None:                                                                                                                                                                                                              
   482 │       │       │       │        │       │               │       │        if encoding == "utf-8-sig":                                                                                                                                                                                                       
   483 │       │       │       │        │       │               │       │            # BOM will already have been stripped.                                                                                                                                                                                        
   484 │       │       │       │        │       │               │       │            encoding = "utf-8"                                                                                                                                                                                                            
   485 │       │       │       │        │       │               │       │        yield TokenInfo(ENCODING, encoding, (0, 0), (0, 0), '')                                                                                                                                                                           
   486 │       │       │       │        │       │               │       │    yield from _generate_tokens_from_c_tokenizer(rl_gen.__next__, encoding, extra_tokens=True)                                                                                                                                            
   487 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   488 │       │       │       │        │       │               │       │def generate_tokens(readline):                                                                                                                                                                                                            
   489 │       │       │       │        │       │               │       │    """Tokenize a source reading Python code as unicode strings.                                                                                                                                                                          
   490 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   491 │       │       │       │        │       │               │       │    This has the same API as tokenize(), except that it expects the *readline*                                                                                                                                                            
   492 │       │       │       │        │       │               │       │    callable to return str objects instead of bytes.                                                                                                                                                                                      
   493 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   494 │       │       │       │        │       │               │       │    return _generate_tokens_from_c_tokenizer(readline, extra_tokens=True)                                                                                                                                                                 
   495 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   496 │       │       │       │        │       │               │       │def main():                                                                                                                                                                                                                               
   497 │       │       │       │        │       │               │       │    import argparse                                                                                                                                                                                                                       
   498 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   499 │       │       │       │        │       │               │       │    # Helper error handling routines                                                                                                                                                                                                      
   500 │       │       │       │        │       │               │       │    def perror(message):                                                                                                                                                                                                                  
   501 │       │       │       │        │       │               │       │        sys.stderr.write(message)                                                                                                                                                                                                         
   502 │       │       │       │        │       │               │       │        sys.stderr.write('\n')                                                                                                                                                                                                            
   503 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   504 │       │       │       │        │       │               │       │    def error(message, filename=None, location=None):                                                                                                                                                                                     
   505 │       │       │       │        │       │               │       │        if location:                                                                                                                                                                                                                      
   506 │       │       │       │        │       │               │       │            args = (filename,) + location + (message,)                                                                                                                                                                                    
   507 │       │       │       │        │       │               │       │            perror("%s:%d:%d: error: %s" % args)                                                                                                                                                                                          
   508 │       │       │       │        │       │               │       │        elif filename:                                                                                                                                                                                                                    
   509 │       │       │       │        │       │               │       │            perror("%s: error: %s" % (filename, message))                                                                                                                                                                                 
   510 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   511 │       │       │       │        │       │               │       │            perror("error: %s" % message)                                                                                                                                                                                                 
   512 │       │       │       │        │       │               │       │        sys.exit(1)                                                                                                                                                                                                                       
   513 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   514 │       │       │       │        │       │               │       │    # Parse the arguments and options                                                                                                                                                                                                     
   515 │       │       │       │        │       │               │       │    parser = argparse.ArgumentParser(prog='python -m tokenize')                                                                                                                                                                           
   516 │       │       │       │        │       │               │       │    parser.add_argument(dest='filename', nargs='?',                                                                                                                                                                                       
   517 │       │       │       │        │       │               │       │                        metavar='filename.py',                                                                                                                                                                                            
   518 │       │       │       │        │       │               │       │                        help='the file to tokenize; defaults to stdin')                                                                                                                                                                   
   519 │       │       │       │        │       │               │       │    parser.add_argument('-e', '--exact', dest='exact', action='store_true',                                                                                                                                                               
   520 │       │       │       │        │       │               │       │                        help='display token names using the exact type')                                                                                                                                                                  
   521 │       │       │       │        │       │               │       │    args = parser.parse_args()                                                                                                                                                                                                            
   522 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   523 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   524 │       │       │       │        │       │               │       │        # Tokenize the input                                                                                                                                                                                                              
   525 │       │       │       │        │       │               │       │        if args.filename:                                                                                                                                                                                                                 
   526 │       │       │       │        │       │               │       │            filename = args.filename                                                                                                                                                                                                      
   527 │       │       │       │        │       │               │       │            with _builtin_open(filename, 'rb') as f:                                                                                                                                                                                      
   528 │       │       │       │        │       │               │       │                tokens = list(tokenize(f.readline))                                                                                                                                                                                       
   529 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   530 │       │       │       │        │       │               │       │            filename = "<stdin>"                                                                                                                                                                                                          
   531 │       │       │       │        │       │               │       │            tokens = _generate_tokens_from_c_tokenizer(                                                                                                                                                                                   
   532 │       │       │       │        │       │               │       │                sys.stdin.readline, extra_tokens=True)                                                                                                                                                                                    
   533 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   534 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   535 │       │       │       │        │       │               │       │        # Output the tokenization                                                                                                                                                                                                         
   536 │       │       │       │        │       │               │       │        for token in tokens:                                                                                                                                                                                                              
   537 │       │       │       │        │       │               │       │            token_type = token.type                                                                                                                                                                                                       
   538 │       │       │       │        │       │               │       │            if args.exact:                                                                                                                                                                                                                
   539 │       │       │       │        │       │               │       │                token_type = token.exact_type                                                                                                                                                                                             
   540 │       │       │       │        │       │               │       │            token_range = "%d,%d-%d,%d:" % (token.start + token.end)                                                                                                                                                                      
   541 │       │       │       │        │       │               │       │            print("%-20s%-15s%-15r" %                                                                                                                                                                                                     
   542 │       │       │       │        │       │               │       │                  (token_range, tok_name[token_type], token.string))                                                                                                                                                                      
   543 │       │       │       │        │       │               │       │    except IndentationError as err:                                                                                                                                                                                                       
   544 │       │       │       │        │       │               │       │        line, column = err.args[1][1:3]                                                                                                                                                                                                   
   545 │       │       │       │        │       │               │       │        error(err.args[0], filename, (line, column))                                                                                                                                                                                      
   546 │       │       │       │        │       │               │       │    except TokenError as err:                                                                                                                                                                                                             
   547 │       │       │       │        │       │               │       │        line, column = err.args[1]                                                                                                                                                                                                        
   548 │       │       │       │        │       │               │       │        error(err.args[0], filename, (line, column))                                                                                                                                                                                      
   549 │       │       │       │        │       │               │       │    except SyntaxError as err:                                                                                                                                                                                                            
   550 │       │       │       │        │       │               │       │        error(err, filename)                                                                                                                                                                                                              
   551 │       │       │       │        │       │               │       │    except OSError as err:                                                                                                                                                                                                                
   552 │       │       │       │        │       │               │       │        error(err)                                                                                                                                                                                                                        
   553 │       │       │       │        │       │               │       │    except KeyboardInterrupt:                                                                                                                                                                                                             
   554 │       │       │       │        │       │               │       │        print("interrupted\n")                                                                                                                                                                                                            
   555 │       │       │       │        │       │               │       │    except Exception as err:                                                                                                                                                                                                              
   556 │       │       │       │        │       │               │       │        perror("unexpected error: %s" % err)                                                                                                                                                                                              
   557 │       │       │       │        │       │               │       │        raise                                                                                                                                                                                                                             
   558 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   559 │       │       │       │        │       │               │       │def _transform_msg(msg):                                                                                                                                                                                                                  
   560 │       │       │       │        │       │               │       │    """Transform error messages from the C tokenizer into the Python tokenize                                                                                                                                                             
   561 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   562 │       │       │       │        │       │               │       │    The C tokenizer is more picky than the Python one, so we need to massage                                                                                                                                                              
   563 │       │       │       │        │       │               │       │    the error messages a bit for backwards compatibility.                                                                                                                                                                                 
   564 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   565 │       │       │       │        │       │               │       │    if "unterminated triple-quoted string literal" in msg:                                                                                                                                                                                
   566 │       │       │       │        │       │               │       │        return "EOF in multi-line string"                                                                                                                                                                                                 
   567 │       │       │       │        │       │               │       │    return msg                                                                                                                                                                                                                            
   568 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   569 │       │       │       │        │       │               │       │def _generate_tokens_from_c_tokenizer(source, encoding=None, extra_tokens=False):                                                                                                                                                         
   570 │       │       │       │        │       │               │       │    """Tokenize a source reading Python code as unicode strings using the internal C tokenizer"""                                                                                                                                         
   571 │       │       │       │        │       │               │       │    if encoding is None:                                                                                                                                                                                                                  
   572 │       │       │       │        │       │               │       │        it = _tokenize.TokenizerIter(source, extra_tokens=extra_tokens)                                                                                                                                                                   
   573 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
   574 │       │       │       │        │       │               │       │        it = _tokenize.TokenizerIter(source, encoding=encoding, extra_tokens=extra_tokens)                                                                                                                                                
   575 │       │       │       │        │       │               │       │    try:                                                                                                                                                                                                                                  
   576 │       │       │       │        │       │               │       │        for info in it:                                                                                                                                                                                                                   
   577 │       │       │       │        │       │               │       │            yield TokenInfo._make(info)                                                                                                                                                                                                   
   578 │       │       │       │        │       │               │       │    except SyntaxError as e:                                                                                                                                                                                                              
   579 │       │       │       │        │       │               │       │        if type(e) != SyntaxError:                                                                                                                                                                                                        
   580 │       │       │       │        │       │               │       │            raise e from None                                                                                                                                                                                                             
   581 │       │       │       │        │       │               │       │        msg = _transform_msg(e.msg)                                                                                                                                                                                                       
   582 │       │       │       │        │       │               │       │        raise TokenError(msg, (e.lineno, e.offset)) from None                                                                                                                                                                             
   583 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   584 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   585 │       │       │       │        │       │               │       │if __name__ == "__main__":                                                                                                                                                                                                                
   586 │       │       │       │        │       │               │       │    main()                                                                                                                                                                                                                                
   587 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
╶──────┼───────┼───────┼───────┼────────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │       │        │       │               │       │function summary for /p/software/juwels/stages/2025/software/Python/3.12.3-GCCcore-13.3.0/lib/python3.12/tokenize.py                                                                                                                      
   445 │       │       │       │  98%   │   13M │█   3%         │       │open                                                                                                                                                                                                                                      
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
Top PEAK memory consumption, by line:
(1)   449:    13 MB                                                                                                                                                                                                                                                                                                 
