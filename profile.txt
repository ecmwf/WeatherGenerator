                                                                                                                  Memory usage: ▁▁▁▁▁▂▂▂▂▃▃▃▃▄▄▄▅▅▅▅▅▆▆▇▇██ (max: 425.012 MB, growth rate:  98%)                                                                                                                   
                                                                 /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/run_evaluation.py: % of time =  34.26% (1m:21.003s) out of 4m:56.410s.                                                                 
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/run_evaluation.py                                                                                                              
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │#!/usr/bin/env -S uv run                                                                                                                                                                                                                  
     2 │       │       │       │        │       │               │       │# /// script                                                                                                                                                                                                                              
     3 │       │       │       │        │       │               │       │# dependencies = [                                                                                                                                                                                                                        
     4 │       │       │       │        │       │               │       │#   "weathergen-evaluate",                                                                                                                                                                                                                
     5 │       │       │       │        │       │               │       │#   "weathergen-common",                                                                                                                                                                                                                  
     6 │       │       │       │        │       │               │       │# ]                                                                                                                                                                                                                                       
     7 │       │       │       │        │       │               │       │# [tool.uv.sources]                                                                                                                                                                                                                       
     8 │       │       │       │        │       │               │       │# weathergen-evaluate = { path = "../../../../../packages/evaluate" }                                                                                                                                                                     
     9 │       │       │       │        │       │               │       │# ///                                                                                                                                                                                                                                     
    10 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    11 │       │       │       │        │       │               │       │import argparse                                                                                                                                                                                                                           
    12 │       │       │       │        │       │               │       │import logging                                                                                                                                                                                                                            
    13 │       │       │       │        │       │               │       │import sys                                                                                                                                                                                                                                
    14 │       │       │       │        │       │               │       │from collections import defaultdict                                                                                                                                                                                                       
    15 │       │       │       │        │       │               │       │from pathlib import Path                                                                                                                                                                                                                  
    16 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    17 │       │       │   1%  │        │       │               │       │from omegaconf import OmegaConf                                                                                                                                                                                                           
    18 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    19 │    4% │    4% │  24%  │        │       │               │       │from weathergen.common.config import _REPO_ROOT                                                                                                                                                                                           
    20 │       │       │       │        │       │               │       │from weathergen.evaluate.io_reader import WeatherGenReader                                                                                                                                                                                
    21 │       │       │       │        │       │               │       │from weathergen.evaluate.utils import (                                                                                                                                                                                                   
    22 │       │       │       │        │       │               │       │    calc_scores_per_stream,                                                                                                                                                                                                               
    23 │       │       │       │        │       │               │       │    metric_list_to_json,                                                                                                                                                                                                                  
    24 │       │       │       │        │       │               │       │    plot_data,                                                                                                                                                                                                                            
    25 │       │       │       │        │       │               │       │    plot_summary,                                                                                                                                                                                                                         
    26 │       │       │       │        │       │               │       │    retrieve_metric_from_json,                                                                                                                                                                                                            
    27 │       │       │       │        │       │               │       │)                                                                                                                                                                                                                                         
    28 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    29 │       │       │       │        │       │               │       │_logger = logging.getLogger(__name__)                                                                                                                                                                                                     
    30 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    31 │       │       │       │        │       │               │       │_DEFAULT_PLOT_DIR = _REPO_ROOT / "plots"                                                                                                                                                                                                  
    32 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    33 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    34 │       │       │       │        │       │               │       │def evaluate() -> None:                                                                                                                                                                                                                   
    35 │       │       │       │        │       │               │       │    # By default, arguments from the command line are read.                                                                                                                                                                               
    36 │       │       │       │        │       │               │       │    evaluate_from_args(sys.argv[1:])                                                                                                                                                                                                      
    37 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    38 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    39 │       │       │       │        │       │               │       │def evaluate_from_args(argl: list[str]) -> None:                                                                                                                                                                                          
    40 │       │       │       │        │       │               │       │    parser = argparse.ArgumentParser(                                                                                                                                                                                                     
    41 │       │       │       │        │       │               │       │        description="Fast evaluation of WeatherGenerator runs."                                                                                                                                                                           
    42 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
    43 │       │       │       │        │       │               │       │    parser.add_argument(                                                                                                                                                                                                                  
    44 │       │       │       │        │       │               │       │        "--config",                                                                                                                                                                                                                       
    45 │       │       │       │        │       │               │       │        type=str,                                                                                                                                                                                                                         
    46 │       │       │       │        │       │               │       │        help="Path to the configuration yaml file for plotting. e.g. config/plottig_config.yaml",                                                                                                                                         
    47 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
    48 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    49 │       │       │       │        │       │               │       │    args = parser.parse_args(argl)                                                                                                                                                                                                        
    50 │       │       │       │        │       │               │       │    evaluate_from_config(OmegaConf.load(args.config))                                                                                                                                                                                     
    51 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    52 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    53 │       │       │       │        │       │               │       │def evaluate_from_config(cfg):                                                                                                                                                                                                            
    54 │       │       │       │        │       │               │       │    # configure logging                                                                                                                                                                                                                   
    55 │       │       │       │        │       │               │       │    logging.basicConfig(level=logging.INFO)                                                                                                                                                                                               
    56 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    57 │       │       │       │        │       │               │       │    # load configuration                                                                                                                                                                                                                  
    58 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    59 │       │       │       │        │       │               │       │    runs = cfg.run_ids                                                                                                                                                                                                                    
    60 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    61 │       │       │       │        │       │               │       │    _logger.info(f"Detected {len(runs)} runs")                                                                                                                                                                                            
    62 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    63 │       │       │       │        │       │               │       │    # Directory to store the summary plots                                                                                                                                                                                                
    64 │       │       │       │        │       │               │       │    private_paths = cfg.get("private_paths", None)                                                                                                                                                                                        
    65 │       │       │       │        │       │               │       │    summary_dir = Path(                                                                                                                                                                                                                   
    66 │       │       │       │        │       │               │       │        cfg.evaluation.get("summary_dir", _DEFAULT_PLOT_DIR)                                                                                                                                                                              
    67 │       │       │       │        │       │               │       │    )  # base directory where summary plots will be stored                                                                                                                                                                                
    68 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    69 │       │       │       │        │       │               │       │    metrics = cfg.evaluation.metrics                                                                                                                                                                                                      
    70 │       │       │       │        │       │               │       │    regions = cfg.evaluation.get("regions", ["global"])                                                                                                                                                                                   
    71 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    72 │       │       │       │        │       │               │       │    global_plotting_opts = cfg.get("global_plotting_options", {})                                                                                                                                                                         
    73 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    74 │       │       │       │        │       │               │       │    # to get a structure like: scores_dict[metric][region][stream][run_id] = plot                                                                                                                                                         
    75 │       │       │       │        │       │               │       │    scores_dict = defaultdict(lambda: defaultdict(lambda: defaultdict(dict)))                                                                                                                                                             
    76 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    77 │       │       │       │        │       │               │       │    for run_id, run in runs.items():                                                                                                                                                                                                      
    78 │       │       │       │        │       │               │       │        _logger.info(f"RUN {run_id}: Getting data...")                                                                                                                                                                                    
    79 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    80 │       │       │       │        │       │               │       │        reader = WeatherGenReader(run, run_id, private_paths)                                                                                                                                                                             
    81 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    82 │       │       │       │        │       │               │       │        for stream in reader.streams:                                                                                                                                                                                                     
    83 │       │       │       │        │       │               │       │            _logger.info(f"RUN {run_id}: Processing stream {stream}...")                                                                                                                                                                  
    84 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    85 │       │       │       │        │       │               │       │            stream_dict = reader.get_stream(stream)                                                                                                                                                                                       
    86 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    87 │       │       │       │        │       │               │       │            if stream_dict.get("plotting"):                                                                                                                                                                                               
    88 │       │       │       │        │       │               │       │                _logger.info(f"RUN {run_id}: Plotting stream {stream}...")                                                                                                                                                                
    89 │       │       │       │        │       │               │       │                _ = plot_data(reader, stream, global_plotting_opts)                                                                                                                                                                       
    90 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    91 │       │       │       │        │       │               │       │            if stream_dict.get("evaluation"):                                                                                                                                                                                             
    92 │       │       │       │        │       │               │       │                _logger.info(f"Retrieve or compute scores for {run_id} - {stream}...")                                                                                                                                                    
    93 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    94 │       │       │       │        │       │               │       │                for region in regions:                                                                                                                                                                                                    
    95 │       │       │       │        │       │               │       │                    metrics_to_compute = []                                                                                                                                                                                               
    96 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    97 │       │       │       │        │       │               │       │                    for metric in metrics:                                                                                                                                                                                                
    98 │       │       │       │        │       │               │       │                        try:                                                                                                                                                                                                              
    99 │       │       │       │        │       │               │       │                            metric_data = retrieve_metric_from_json(                                                                                                                                                                      
   100 │       │       │       │        │       │               │       │                                reader,                                                                                                                                                                                                   
   101 │       │       │       │        │       │               │       │                                stream,                                                                                                                                                                                                   
   102 │       │       │       │        │       │               │       │                                region,                                                                                                                                                                                                   
   103 │       │       │       │        │       │               │       │                                metric,                                                                                                                                                                                                   
   104 │       │       │       │        │       │               │       │                            )                                                                                                                                                                                                             
   105 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   106 │       │       │       │        │       │               │       │                            available_data = reader.check_availability(                                                                                                                                                                   
   107 │       │       │       │        │       │               │       │                                stream, metric_data, mode="evaluation"                                                                                                                                                                    
   108 │       │       │       │        │       │               │       │                            )                                                                                                                                                                                                             
   109 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   110 │       │       │       │        │       │               │       │                            if not available_data.score_availability:                                                                                                                                                                     
   111 │       │       │       │        │       │               │       │                                metrics_to_compute.append(metric)                                                                                                                                                                         
   112 │       │       │       │        │       │               │       │                            else:                                                                                                                                                                                                         
   113 │       │       │       │        │       │               │       │                                # simply select the chosen eval channels, samples, fsteps here...                                                                                                                                         
   114 │       │       │       │        │       │               │       │                                scores_dict[metric][region][stream][run_id] = (                                                                                                                                                           
   115 │       │       │       │        │       │               │       │                                    metric_data.sel(                                                                                                                                                                                      
   116 │       │       │       │        │       │               │       │                                        sample=available_data.samples,                                                                                                                                                                    
   117 │       │       │       │        │       │               │       │                                        channel=available_data.channels,                                                                                                                                                                  
   118 │       │       │       │        │       │               │       │                                        forecast_step=available_data.fsteps,                                                                                                                                                              
   119 │       │       │       │        │       │               │       │                                    )                                                                                                                                                                                                     
   120 │       │       │       │        │       │               │       │                                )                                                                                                                                                                                                         
   121 │       │       │       │        │       │               │       │                        except (FileNotFoundError, KeyError):                                                                                                                                                                             
   122 │       │       │       │        │       │               │       │                            metrics_to_compute.append(metric)                                                                                                                                                                             
   123 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   124 │       │       │       │        │       │               │       │                    if metrics_to_compute:                                                                                                                                                                                                
   125 │       │       │       │        │       │               │       │                        all_metrics, points_per_sample = calc_scores_per_stream(                                                                                                                                                          
   126 │       │       │       │        │       │               │       │                            reader, stream, region, metrics_to_compute                                                                                                                                                                    
   127 │       │       │       │        │       │               │       │                        )                                                                                                                                                                                                                 
   128 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   129 │       │       │       │        │       │               │       │                        metric_list_to_json(                                                                                                                                                                                              
   130 │       │       │       │        │       │               │       │                            reader,                                                                                                                                                                                                       
   131 │       │       │       │        │       │               │       │                            [all_metrics],                                                                                                                                                                                                
   132 │       │       │       │        │       │               │       │                            [points_per_sample],                                                                                                                                                                                          
   133 │       │       │       │        │       │               │       │                            [stream],                                                                                                                                                                                                     
   134 │       │       │       │        │       │               │       │                            region,                                                                                                                                                                                                       
   135 │       │       │       │        │       │               │       │                        )                                                                                                                                                                                                                 
   136 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   137 │       │       │       │        │       │               │       │                    for metric in metrics_to_compute:                                                                                                                                                                                     
   138 │       │       │       │        │       │               │       │                        scores_dict[metric][region][stream][run_id] = all_metrics.sel(                                                                                                                                                    
   139 │       │       │       │        │       │               │       │                            {"metric": metric}                                                                                                                                                                                            
   140 │       │       │       │        │       │               │       │                        )                                                                                                                                                                                                                 
   141 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   142 │       │       │       │        │       │               │       │    # plot summary                                                                                                                                                                                                                        
   143 │       │       │       │        │       │               │       │    if scores_dict and cfg.evaluation.get("summary_plots", True):                                                                                                                                                                         
   144 │       │       │       │        │       │               │       │        _logger.info("Started creating summary plots..")                                                                                                                                                                                  
   145 │       │       │       │        │       │               │       │        plot_summary(cfg, scores_dict, summary_dir)                                                                                                                                                                                       
   146 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   147 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   148 │       │       │       │        │       │               │       │if __name__ == "__main__":                                                                                                                                                                                                                
   149 │       │       │       │        │       │               │       │    evaluate()                                                                                                                                                                                                                            
   150 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
                                                                    /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/plotter.py: % of time =  29.73% (1m:10.277s) out of 4m:56.410s.                                                                     
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/plotter.py                                                                                                                     
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │import glob                                                                                                                                                                                                                               
     2 │       │       │       │        │       │               │       │import logging                                                                                                                                                                                                                            
     3 │       │       │       │        │       │               │       │import os                                                                                                                                                                                                                                 
     4 │       │       │       │        │       │               │       │from pathlib import Path                                                                                                                                                                                                                  
     5 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
     6 │       │       │   1%  │ 100%   │   11M │▁   2%         │       │import cartopy                                                                                                                                                                                                                            
     7 │       │       │       │        │       │               │       │import cartopy.crs as ccrs                                                                                                                                                                                                                
     8 │       │       │       │ 100%   │   10M │▁   2%         │       │import matplotlib as mpl                                                                                                                                                                                                                  
     9 │       │       │   1%  │ 100%   │   10M │▁   2%         │       │import matplotlib.pyplot as plt                                                                                                                                                                                                           
    10 │       │       │       │        │       │               │       │import numpy as np                                                                                                                                                                                                                        
    11 │       │       │       │        │       │               │       │import omegaconf as oc                                                                                                                                                                                                                    
    12 │       │       │       │        │       │               │       │import xarray as xr                                                                                                                                                                                                                       
    13 │       │       │       │        │       │               │       │from PIL import Image                                                                                                                                                                                                                     
    14 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    15 │       │       │       │        │       │               │       │from weathergen.common.config import _load_private_conf                                                                                                                                                                                   
    16 │       │       │       │        │       │               │       │from weathergen.evaluate.plot_utils import DefaultMarkerSize                                                                                                                                                                              
    17 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    18 │       │       │  14%  │        │       │               │       │work_dir = Path(_load_private_conf(None)["path_shared_working_dir"]) / "assets/cartopy"                                                                                                                                                   
    19 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    20 │       │       │       │        │       │               │       │cartopy.config["data_dir"] = str(work_dir)                                                                                                                                                                                                
    21 │       │       │       │        │       │               │       │cartopy.config["pre_existing_data_dir"] = str(work_dir)                                                                                                                                                                                   
    22 │       │       │       │        │       │               │       │os.environ["CARTOPY_DATA_DIR"] = str(work_dir)                                                                                                                                                                                            
    23 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    24 │       │       │       │        │       │               │       │np.seterr(divide="ignore", invalid="ignore")                                                                                                                                                                                              
    25 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    26 │       │       │       │        │       │               │       │logging.getLogger("matplotlib.category").setLevel(logging.ERROR)                                                                                                                                                                          
    27 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    28 │       │       │       │        │       │               │       │_logger = logging.getLogger(__name__)                                                                                                                                                                                                     
    29 │       │       │       │        │       │               │       │_logger.setLevel(logging.INFO)                                                                                                                                                                                                            
    30 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    31 │       │       │       │        │       │               │       │_logger.debug(f"Taking cartopy paths from {work_dir}")                                                                                                                                                                                    
    32 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    33 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    34 │       │       │       │        │       │               │       │class Plotter:                                                                                                                                                                                                                            
    35 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    36 │       │       │       │        │       │               │       │    Contains all basic plotting functions.                                                                                                                                                                                                
    37 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    38 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    39 │       │       │       │        │       │               │       │    def __init__(self, plotter_cfg: dict, output_basedir: str | Path):                                                                                                                                                                    
    40 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
    41 │       │       │       │        │       │               │       │        Initialize the Plotter class.                                                                                                                                                                                                     
    42 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    43 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
    44 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
    45 │       │       │       │        │       │               │       │        plotter_cfg:                                                                                                                                                                                                                      
    46 │       │       │       │        │       │               │       │            Configuration dictionary containing basic information for plotting.                                                                                                                                                           
    47 │       │       │       │        │       │               │       │            Expected keys are:                                                                                                                                                                                                            
    48 │       │       │       │        │       │               │       │                - image_format: Format of the saved images (e.g., 'png', 'pdf', etc.)                                                                                                                                                     
    49 │       │       │       │        │       │               │       │                - dpi_val: DPI value for the saved images                                                                                                                                                                                 
    50 │       │       │       │        │       │               │       │                - fig_size: Size of the figure (width, height) in inches                                                                                                                                                                  
    51 │       │       │       │        │       │               │       │                - tokenize_spacetime: If True, all valid times will be plotted in one plot                                                                                                                                                
    52 │       │       │       │        │       │               │       │        output_basedir:                                                                                                                                                                                                                   
    53 │       │       │       │        │       │               │       │            Base directory under which the plots will be saved.                                                                                                                                                                           
    54 │       │       │       │        │       │               │       │            Expected scheme `<results_base_dir>/<run_id>`.                                                                                                                                                                                
    55 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
    56 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    57 │       │       │       │        │       │               │       │        _logger.info(f"Taking cartopy paths from {work_dir}")                                                                                                                                                                             
    58 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    59 │       │       │       │        │       │               │       │        self.image_format = plotter_cfg.get("image_format")                                                                                                                                                                               
    60 │       │       │       │        │       │               │       │        self.dpi_val = plotter_cfg.get("dpi_val")                                                                                                                                                                                         
    61 │       │       │       │        │       │               │       │        self.fig_size = plotter_cfg.get("fig_size")                                                                                                                                                                                       
    62 │       │       │       │        │       │               │       │        self.plot_subtimesteps = plotter_cfg.get(                                                                                                                                                                                         
    63 │       │       │       │        │       │               │       │            "plot_subtimesteps", False                                                                                                                                                                                                    
    64 │       │       │       │        │       │               │       │        )  # True if plots are created for each valid time separately                                                                                                                                                                     
    65 │       │       │       │        │       │               │       │        self.run_id = output_basedir.name                                                                                                                                                                                                 
    66 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    67 │       │       │       │        │       │               │       │        self.out_plot_basedir = Path(output_basedir) / "plots"                                                                                                                                                                            
    68 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    69 │       │       │       │        │       │               │       │        if not os.path.exists(self.out_plot_basedir):                                                                                                                                                                                     
    70 │       │       │       │        │       │               │       │            _logger.info(f"Creating dir {self.out_plot_basedir}")                                                                                                                                                                         
    71 │       │       │       │        │       │               │       │            os.makedirs(self.out_plot_basedir, exist_ok=True)                                                                                                                                                                             
    72 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    73 │       │       │       │        │       │               │       │        self.sample = None                                                                                                                                                                                                                
    74 │       │       │       │        │       │               │       │        self.stream = None                                                                                                                                                                                                                
    75 │       │       │       │        │       │               │       │        self.fstep = None                                                                                                                                                                                                                 
    76 │       │       │       │        │       │               │       │        self.select = {}                                                                                                                                                                                                                  
    77 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    78 │       │       │       │        │       │               │       │    def update_data_selection(self, select: dict):                                                                                                                                                                                        
    79 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
    80 │       │       │       │        │       │               │       │        Set the selection for the plots. This will be used to filter the data for plotting.                                                                                                                                               
    81 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    82 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
    83 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
    84 │       │       │       │        │       │               │       │        select:                                                                                                                                                                                                                           
    85 │       │       │       │        │       │               │       │            Dictionary containing the selection criteria. Expected keys are:                                                                                                                                                              
    86 │       │       │       │        │       │               │       │                - "sample": Sample identifier                                                                                                                                                                                             
    87 │       │       │       │        │       │               │       │                - "stream": Stream identifier                                                                                                                                                                                             
    88 │       │       │       │        │       │               │       │                - "forecast_step": Forecast step identifier                                                                                                                                                                               
    89 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
    90 │       │       │       │        │       │               │       │        self.select = select                                                                                                                                                                                                              
    91 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    92 │       │       │       │        │       │               │       │        if "sample" not in select:                                                                                                                                                                                                        
    93 │       │       │       │        │       │               │       │            _logger.warning(                                                                                                                                                                                                              
    94 │       │       │       │        │       │               │       │                "No sample in the selection. Might lead to unexpected results."                                                                                                                                                           
    95 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
    96 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
    97 │       │       │       │        │       │               │       │            self.sample = select["sample"]                                                                                                                                                                                                
    98 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    99 │       │       │       │        │       │               │       │        if "stream" not in select:                                                                                                                                                                                                        
   100 │       │       │       │        │       │               │       │            _logger.warning(                                                                                                                                                                                                              
   101 │       │       │       │        │       │               │       │                "No stream in the selection. Might lead to unexpected results."                                                                                                                                                           
   102 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   103 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   104 │       │       │       │        │       │               │       │            self.stream = select["stream"]                                                                                                                                                                                                
   105 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   106 │       │       │       │        │       │               │       │        if "forecast_step" not in select:                                                                                                                                                                                                 
   107 │       │       │       │        │       │               │       │            _logger.warning(                                                                                                                                                                                                              
   108 │       │       │       │        │       │               │       │                "No forecast_step in the selection. Might lead to unexpected results."                                                                                                                                                    
   109 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   110 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   111 │       │       │       │        │       │               │       │            self.fstep = select["forecast_step"]                                                                                                                                                                                          
   112 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   113 │       │       │       │        │       │               │       │        return self                                                                                                                                                                                                                       
   114 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   115 │       │       │       │        │       │               │       │    def clean_data_selection(self):                                                                                                                                                                                                       
   116 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   117 │       │       │       │        │       │               │       │        Clean the data selection by resetting all selected values.                                                                                                                                                                        
   118 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   119 │       │       │       │        │       │               │       │        self.sample = None                                                                                                                                                                                                                
   120 │       │       │       │        │       │               │       │        self.stream = None                                                                                                                                                                                                                
   121 │       │       │       │        │       │               │       │        self.fstep = None                                                                                                                                                                                                                 
   122 │       │       │       │        │       │               │       │        self.select = {}                                                                                                                                                                                                                  
   123 │       │       │       │        │       │               │       │        return self                                                                                                                                                                                                                       
   124 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   125 │       │       │       │        │       │               │       │    def select_from_da(self, da: xr.DataArray, selection: dict) -> xr.DataArray:                                                                                                                                                          
   126 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   127 │       │       │       │        │       │               │       │        Select data from an xarray DataArray based on given selectors.                                                                                                                                                                    
   128 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   129 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   130 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   131 │       │       │       │        │       │               │       │        da:                                                                                                                                                                                                                               
   132 │       │       │       │        │       │               │       │            xarray DataArray to select data from.                                                                                                                                                                                         
   133 │       │       │       │        │       │               │       │        selection:                                                                                                                                                                                                                        
   134 │       │       │       │        │       │               │       │            Dictionary of selectors where keys are coordinate names and values are the values to select.                                                                                                                                  
   135 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   136 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   137 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   138 │       │       │       │        │       │               │       │            xarray DataArray with selected data.                                                                                                                                                                                          
   139 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   140 │       │       │       │        │       │               │       │        for key, value in selection.items():                                                                                                                                                                                              
   141 │       │       │       │        │       │               │       │            if key in da.coords and key not in da.dims:                                                                                                                                                                                   
   142 │       │       │       │        │       │               │       │                # Coordinate like 'sample' aligned to another dim                                                                                                                                                                         
   143 │       │       │       │        │       │               │       │                da = da.where(da[key] == value, drop=True)                                                                                                                                                                                
   144 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   145 │       │       │       │        │       │               │       │                # Scalar coord or dim coord (e.g., 'forecast_step', 'channel')                                                                                                                                                            
   146 │       │       │       │        │       │               │       │                da = da.sel({key: value})                                                                                                                                                                                                 
   147 │       │       │       │        │       │               │       │        return da                                                                                                                                                                                                                         
   148 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   149 │       │       │       │        │       │               │       │    def create_histograms_per_sample(                                                                                                                                                                                                     
   150 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   151 │       │       │       │        │       │               │       │        target: xr.DataArray,                                                                                                                                                                                                             
   152 │       │       │       │        │       │               │       │        preds: xr.DataArray,                                                                                                                                                                                                              
   153 │       │       │       │        │       │               │       │        variables: list,                                                                                                                                                                                                                  
   154 │       │       │       │        │       │               │       │        select: dict,                                                                                                                                                                                                                     
   155 │       │       │       │        │       │               │       │        tag: str = "",                                                                                                                                                                                                                    
   156 │       │       │       │        │       │               │       │    ) -> list[str]:                                                                                                                                                                                                                       
   157 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   158 │       │       │       │        │       │               │       │        Plot histogram of target vs predictions for each variable and valid time in the DataArray.                                                                                                                                        
   159 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   160 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   161 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   162 │       │       │       │        │       │               │       │        target: xr.DataArray                                                                                                                                                                                                              
   163 │       │       │       │        │       │               │       │            Target sample for a specific (stream, sample, fstep)                                                                                                                                                                          
   164 │       │       │       │        │       │               │       │        preds: xr.DataArray                                                                                                                                                                                                               
   165 │       │       │       │        │       │               │       │            Predictions sample for a specific (stream, sample, fstep)                                                                                                                                                                     
   166 │       │       │       │        │       │               │       │        variables: list                                                                                                                                                                                                                   
   167 │       │       │       │        │       │               │       │            List of variables to be plotted                                                                                                                                                                                               
   168 │       │       │       │        │       │               │       │        select: dict                                                                                                                                                                                                                      
   169 │       │       │       │        │       │               │       │            Selection to be applied to the DataArray                                                                                                                                                                                      
   170 │       │       │       │        │       │               │       │        tag: str                                                                                                                                                                                                                          
   171 │       │       │       │        │       │               │       │            Any tag you want to add to the plot                                                                                                                                                                                           
   172 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   173 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   174 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   175 │       │       │       │        │       │               │       │            List of plot names for the saved histograms.                                                                                                                                                                                  
   176 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   177 │       │       │       │        │       │               │       │        plot_names = []                                                                                                                                                                                                                   
   178 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   179 │       │       │       │        │       │               │       │        self.update_data_selection(select)                                                                                                                                                                                                
   180 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   181 │       │       │       │        │       │               │       │        # Basic map output directory for this stream                                                                                                                                                                                      
   182 │       │       │       │        │       │               │       │        hist_output_dir = self.out_plot_basedir / self.stream / "histograms"                                                                                                                                                              
   183 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   184 │       │       │       │        │       │               │       │        if not os.path.exists(hist_output_dir):                                                                                                                                                                                           
   185 │       │       │       │        │       │               │       │            _logger.info(f"Creating dir {hist_output_dir}")                                                                                                                                                                               
   186 │       │       │       │        │       │               │       │            os.makedirs(hist_output_dir)                                                                                                                                                                                                  
   187 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   188 │       │       │       │        │       │               │       │        for var in variables:                                                                                                                                                                                                             
   189 │       │       │       │        │       │               │       │            select_var = self.select | {"channel": var}                                                                                                                                                                                   
   190 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   191 │       │       │       │        │       │               │       │            targ, prd = (                                                                                                                                                                                                                 
   192 │       │       │       │        │       │               │       │                self.select_from_da(target, select_var),                                                                                                                                                                                  
   193 │       │       │       │        │       │               │       │                self.select_from_da(preds, select_var),                                                                                                                                                                                   
   194 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   195 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   196 │       │       │       │        │       │               │       │            # Remove NaNs                                                                                                                                                                                                                 
   197 │       │       │       │        │       │               │       │            targ = targ.dropna(dim="ipoint")                                                                                                                                                                                              
   198 │       │       │       │        │       │               │       │            prd = prd.dropna(dim="ipoint")                                                                                                                                                                                                
   199 │       │       │       │        │       │               │       │            assert targ.size > 0, "Data array must not be empty or contain only NAs"                                                                                                                                                      
   200 │       │       │       │        │       │               │       │            assert prd.size > 0, "Data array must not be empty or contain only NAs"                                                                                                                                                       
   201 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   202 │       │       │       │        │       │               │       │            if self.plot_subtimesteps:                                                                                                                                                                                                    
   203 │       │       │       │        │       │               │       │                ntimes_unique = len(np.unique(targ.valid_time))                                                                                                                                                                           
   204 │       │       │       │        │       │               │       │                _logger.info(                                                                                                                                                                                                             
   205 │       │       │       │        │       │               │       │                    f"Creating histograms for {ntimes_unique} valid times of variable {var}."                                                                                                                                             
   206 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   207 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   208 │       │       │       │        │       │               │       │                groups = zip(                                                                                                                                                                                                             
   209 │       │       │       │        │       │               │       │                    targ.groupby("valid_time"), prd.groupby("valid_time"), strict=False                                                                                                                                                   
   210 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   211 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   212 │       │       │       │        │       │               │       │                _logger.info(f"Plotting histogram for all valid times of {var}")                                                                                                                                                          
   213 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   214 │       │       │       │        │       │               │       │                groups = [                                                                                                                                                                                                                
   215 │       │       │       │        │       │               │       │                    ((None, targ), (None, prd))                                                                                                                                                                                           
   216 │       │       │       │        │       │               │       │                ]  # wrap once with dummy valid_time                                                                                                                                                                                      
   217 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   218 │       │       │       │        │       │               │       │            for (valid_time, targ_t), (_, prd_t) in groups:                                                                                                                                                                               
   219 │       │       │       │        │       │               │       │                if valid_time is not None:                                                                                                                                                                                                
   220 │       │       │       │        │       │               │       │                    _logger.debug(                                                                                                                                                                                                        
   221 │       │       │       │        │       │               │       │                        f"Plotting histogram for {var} at valid_time {valid_time}"                                                                                                                                                        
   222 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
   223 │       │       │       │        │       │               │       │                name = self.plot_histogram(targ_t, prd_t, hist_output_dir, var, tag=tag)                                                                                                                                                  
   224 │       │       │       │        │       │               │       │                plot_names.append(name)                                                                                                                                                                                                   
   225 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   226 │       │       │       │        │       │               │       │        self.clean_data_selection()                                                                                                                                                                                                       
   227 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   228 │       │       │       │        │       │               │       │        return plot_names                                                                                                                                                                                                                 
   229 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   230 │       │       │       │        │       │               │       │    def plot_histogram(                                                                                                                                                                                                                   
   231 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   232 │       │       │       │        │       │               │       │        target_data: xr.DataArray,                                                                                                                                                                                                        
   233 │       │       │       │        │       │               │       │        pred_data: xr.DataArray,                                                                                                                                                                                                          
   234 │       │       │       │        │       │               │       │        hist_output_dir: Path,                                                                                                                                                                                                            
   235 │       │       │       │        │       │               │       │        varname: str,                                                                                                                                                                                                                     
   236 │       │       │       │        │       │               │       │        tag: str = "",                                                                                                                                                                                                                    
   237 │       │       │       │        │       │               │       │    ) -> str:                                                                                                                                                                                                                             
   238 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   239 │       │       │       │        │       │               │       │        Plot a histogram comparing target and prediction data for a specific variable.                                                                                                                                                    
   240 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   241 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   242 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   243 │       │       │       │        │       │               │       │        target_data: xr.DataArray                                                                                                                                                                                                         
   244 │       │       │       │        │       │               │       │            DataArray containing the target data for the variable.                                                                                                                                                                        
   245 │       │       │       │        │       │               │       │        pred_data: xr.DataArray                                                                                                                                                                                                           
   246 │       │       │       │        │       │               │       │            DataArray containing the prediction data for the variable.                                                                                                                                                                    
   247 │       │       │       │        │       │               │       │        hist_output_dir: Path                                                                                                                                                                                                             
   248 │       │       │       │        │       │               │       │            Directory where the histogram will be saved.                                                                                                                                                                                  
   249 │       │       │       │        │       │               │       │        varname: str                                                                                                                                                                                                                      
   250 │       │       │       │        │       │               │       │            Name of the variable to be plotted.                                                                                                                                                                                           
   251 │       │       │       │        │       │               │       │        tag: str                                                                                                                                                                                                                          
   252 │       │       │       │        │       │               │       │            Any tag you want to add to the plot.                                                                                                                                                                                          
   253 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   254 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   255 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   256 │       │       │       │        │       │               │       │            Name of the saved plot file.                                                                                                                                                                                                  
   257 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   258 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   259 │       │       │       │        │       │               │       │        # Get common bin edges                                                                                                                                                                                                            
   260 │       │       │       │        │       │               │       │        vals = np.concatenate([target_data, pred_data])                                                                                                                                                                                   
   261 │       │       │       │        │       │               │       │        bins = np.histogram_bin_edges(vals, bins=50)                                                                                                                                                                                      
   262 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   263 │       │       │       │        │       │               │       │        # Plot histograms                                                                                                                                                                                                                 
   264 │       │       │       │        │       │               │       │        plt.hist(target_data, bins=bins, alpha=0.7, label="Target")                                                                                                                                                                       
   265 │       │       │       │        │       │               │       │        plt.hist(pred_data, bins=bins, alpha=0.7, label="Prediction")                                                                                                                                                                     
   266 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   267 │       │       │       │        │       │               │       │        # set labels and title                                                                                                                                                                                                            
   268 │       │       │       │        │       │               │       │        plt.xlabel(f"Variable: {varname}")                                                                                                                                                                                                
   269 │       │       │       │        │       │               │       │        plt.ylabel("Frequency")                                                                                                                                                                                                           
   270 │       │       │       │        │       │               │       │        plt.title(                                                                                                                                                                                                                        
   271 │       │       │       │        │       │               │       │            f"Histogram of Target and Prediction: {self.stream}, {varname} : fstep = {self.fstep:03}"                                                                                                                                     
   272 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   273 │       │       │       │        │       │               │       │        plt.legend(frameon=False)                                                                                                                                                                                                         
   274 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   275 │       │       │       │        │       │               │       │        valid_time = str(target_data["valid_time"][0].values.astype("datetime64[m]"))                                                                                                                                                     
   276 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   277 │       │       │       │        │       │               │       │        # TODO: make this nicer                                                                                                                                                                                                           
   278 │       │       │       │        │       │               │       │        parts = [                                                                                                                                                                                                                         
   279 │       │       │       │        │       │               │       │            "histogram",                                                                                                                                                                                                                  
   280 │       │       │       │        │       │               │       │            self.run_id,                                                                                                                                                                                                                  
   281 │       │       │       │        │       │               │       │            tag,                                                                                                                                                                                                                          
   282 │       │       │       │        │       │               │       │            str(self.sample),                                                                                                                                                                                                             
   283 │       │       │       │        │       │               │       │            valid_time,                                                                                                                                                                                                                   
   284 │       │       │       │        │       │               │       │            self.stream,                                                                                                                                                                                                                  
   285 │       │       │       │        │       │               │       │            varname,                                                                                                                                                                                                                      
   286 │       │       │       │        │       │               │       │            str(self.fstep).zfill(3),                                                                                                                                                                                                     
   287 │       │       │       │        │       │               │       │        ]                                                                                                                                                                                                                                 
   288 │       │       │       │        │       │               │       │        name = "_".join(filter(None, parts))                                                                                                                                                                                              
   289 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   290 │       │       │       │        │       │               │       │        fname = hist_output_dir / f"{name}.{self.image_format}"                                                                                                                                                                           
   291 │       │       │       │        │       │               │       │        _logger.debug(f"Saving histogram to {fname}")                                                                                                                                                                                     
   292 │       │       │       │        │       │               │       │        plt.savefig(fname)                                                                                                                                                                                                                
   293 │       │       │       │        │       │               │       │        plt.close()                                                                                                                                                                                                                       
   294 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   295 │       │       │       │        │       │               │       │        return name                                                                                                                                                                                                                       
   296 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   297 │       │       │       │        │       │               │       │    def create_maps_per_sample(                                                                                                                                                                                                           
   298 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   299 │       │       │       │        │       │               │       │        data: xr.DataArray,                                                                                                                                                                                                               
   300 │       │       │       │        │       │               │       │        variables: list,                                                                                                                                                                                                                  
   301 │       │       │       │        │       │               │       │        select: dict,                                                                                                                                                                                                                     
   302 │       │       │       │        │       │               │       │        tag: str = "",                                                                                                                                                                                                                    
   303 │       │       │       │        │       │               │       │        map_kwargs: dict | None = None,                                                                                                                                                                                                   
   304 │       │       │       │        │       │               │       │    ) -> list[str]:                                                                                                                                                                                                                       
   305 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   306 │       │       │       │        │       │               │       │        Plot 2D map for each variable and valid time in the DataArray.                                                                                                                                                                    
   307 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   308 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   309 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   310 │       │       │       │        │       │               │       │        data: xr.DataArray                                                                                                                                                                                                                
   311 │       │       │       │        │       │               │       │            DataArray for a specific (stream, sample, fstep)                                                                                                                                                                              
   312 │       │       │       │        │       │               │       │        variables: list                                                                                                                                                                                                                   
   313 │       │       │       │        │       │               │       │            List of variables to be plotted                                                                                                                                                                                               
   314 │       │       │       │        │       │               │       │        label: str                                                                                                                                                                                                                        
   315 │       │       │       │        │       │               │       │            Any tag you want to add to the plot                                                                                                                                                                                           
   316 │       │       │       │        │       │               │       │        select: dict                                                                                                                                                                                                                      
   317 │       │       │       │        │       │               │       │            Selection to be applied to the DataArray                                                                                                                                                                                      
   318 │       │       │       │        │       │               │       │        tag: str                                                                                                                                                                                                                          
   319 │       │       │       │        │       │               │       │            Any tag you want to add to the plot. Note: This is added to the plot directory.                                                                                                                                               
   320 │       │       │       │        │       │               │       │        map_kwargs: dict                                                                                                                                                                                                                  
   321 │       │       │       │        │       │               │       │            Additional keyword arguments for the map.                                                                                                                                                                                     
   322 │       │       │       │        │       │               │       │            Known keys are:                                                                                                                                                                                                               
   323 │       │       │       │        │       │               │       │                - marker_size: base size of the marker (default is 1)                                                                                                                                                                     
   324 │       │       │       │        │       │               │       │                - scale_marker_size: if True, the marker size will be scaled based on latitude (default is False)                                                                                                                         
   325 │       │       │       │        │       │               │       │                - marker: marker style (default is 'o')                                                                                                                                                                                   
   326 │       │       │       │        │       │               │       │            Unknown keys will be passed to the scatter plot function.                                                                                                                                                                     
   327 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   328 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   329 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   330 │       │       │       │        │       │               │       │            List of plot names for the saved maps.                                                                                                                                                                                        
   331 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   332 │       │       │       │        │       │               │       │        self.update_data_selection(select)                                                                                                                                                                                                
   333 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   334 │       │       │       │        │       │               │       │        # copy global plotting options, not specific to any variable                                                                                                                                                                      
   335 │       │       │       │        │       │               │       │        map_kwargs_global = {                                                                                                                                                                                                             
   336 │       │       │       │        │       │               │       │            key: value                                                                                                                                                                                                                    
   337 │       │       │       │        │       │               │       │            for key, value in (map_kwargs or {}).items()                                                                                                                                                                                  
   338 │       │       │       │        │       │               │       │            if not isinstance(value, oc.DictConfig)                                                                                                                                                                                       
   339 │       │       │       │        │       │               │       │        }                                                                                                                                                                                                                                 
   340 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   341 │       │       │       │        │       │               │       │        # Basic map output directory for this stream                                                                                                                                                                                      
   342 │       │       │       │        │       │               │       │        map_output_dir = self.get_map_output_dir(tag)                                                                                                                                                                                     
   343 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   344 │       │       │       │        │       │               │       │        if not os.path.exists(map_output_dir):                                                                                                                                                                                            
   345 │       │       │       │        │       │               │       │            _logger.info(f"Creating dir {map_output_dir}")                                                                                                                                                                                
   346 │       │       │       │        │       │               │       │            os.makedirs(map_output_dir)                                                                                                                                                                                                   
   347 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   348 │       │       │       │        │       │               │       │        plot_names = []                                                                                                                                                                                                                   
   349 │       │       │       │        │       │               │       │        for var in variables:                                                                                                                                                                                                             
   350 │       │       │       │        │       │               │       │            select_var = self.select | {"channel": var}                                                                                                                                                                                   
   351 │       │       │       │        │       │               │       │            da = self.select_from_da(data, select_var).compute()                                                                                                                                                                          
   352 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   353 │       │       │       │        │       │               │       │            if self.plot_subtimesteps:                                                                                                                                                                                                    
   354 │       │       │       │        │       │               │       │                ntimes_unique = len(np.unique(da.valid_time))                                                                                                                                                                             
   355 │       │       │       │        │       │               │       │                _logger.info(                                                                                                                                                                                                             
   356 │       │       │       │        │       │               │       │                    f"Creating maps for {ntimes_unique} valid times of variable {var} - {tag}"                                                                                                                                            
   357 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   358 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   359 │       │       │       │        │       │               │       │                groups = da.groupby("valid_time")                                                                                                                                                                                         
   360 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   361 │       │       │       │        │       │               │       │                _logger.info(f"Creating maps for all valid times of {var} - {tag}")                                                                                                                                                       
   362 │       │       │       │        │       │               │       │                groups = [(None, da)]  # single dummy group                                                                                                                                                                               
   363 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   364 │       │       │       │        │       │               │       │            for valid_time, da_t in groups:                                                                                                                                                                                               
   365 │       │       │       │        │       │               │       │                if valid_time is not None:                                                                                                                                                                                                
   366 │       │       │       │        │       │               │       │                    _logger.debug(f"Plotting map for {var} at valid_time {valid_time}")                                                                                                                                                   
   367 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   368 │       │       │       │        │       │               │       │                da_t = da_t.dropna(dim="ipoint")                                                                                                                                                                                          
   369 │       │       │       │        │       │               │       │                assert da_t.size > 0, "Data array must not be empty or contain only NAs"                                                                                                                                                  
   370 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   371 │       │       │       │        │       │               │       │                name = self.scatter_plot(                                                                                                                                                                                                 
   372 │       │       │       │        │       │               │       │                    da_t,                                                                                                                                                                                                                 
   373 │       │       │       │        │       │               │       │                    map_output_dir,                                                                                                                                                                                                       
   374 │       │       │       │        │       │               │       │                    var,                                                                                                                                                                                                                  
   375 │       │       │       │        │       │               │       │                    tag=tag,                                                                                                                                                                                                              
   376 │       │       │       │        │       │               │       │                    map_kwargs=dict(map_kwargs.get(var, {})) | map_kwargs_global,                                                                                                                                                         
   377 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   378 │       │       │       │        │       │               │       │                plot_names.append(name)                                                                                                                                                                                                   
   379 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   380 │       │       │       │        │       │               │       │        self.clean_data_selection()                                                                                                                                                                                                       
   381 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   382 │       │       │       │        │       │               │       │        return plot_names                                                                                                                                                                                                                 
   383 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   384 │       │       │       │        │       │               │       │    def scatter_plot(                                                                                                                                                                                                                     
   385 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   386 │       │       │       │        │       │               │       │        data: xr.DataArray,                                                                                                                                                                                                               
   387 │       │       │       │        │       │               │       │        map_output_dir: Path,                                                                                                                                                                                                             
   388 │       │       │       │        │       │               │       │        varname: str,                                                                                                                                                                                                                     
   389 │       │       │       │        │       │               │       │        tag: str = "",                                                                                                                                                                                                                    
   390 │       │       │       │        │       │               │       │        map_kwargs: dict | None = None,                                                                                                                                                                                                   
   391 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   392 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   393 │       │       │       │        │       │               │       │        Plot a 2D map for a data array using scatter plot.                                                                                                                                                                                
   394 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   395 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   396 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   397 │       │       │       │        │       │               │       │        data: xr.DataArray                                                                                                                                                                                                                
   398 │       │       │       │        │       │               │       │            DataArray to be plotted                                                                                                                                                                                                       
   399 │       │       │       │        │       │               │       │        map_output_dir: Path                                                                                                                                                                                                              
   400 │       │       │       │        │       │               │       │            Directory where the map will be saved                                                                                                                                                                                         
   401 │       │       │       │        │       │               │       │        varname: str                                                                                                                                                                                                                      
   402 │       │       │       │        │       │               │       │            Name of the variable to be plotted                                                                                                                                                                                            
   403 │       │       │       │        │       │               │       │        tag: str                                                                                                                                                                                                                          
   404 │       │       │       │        │       │               │       │            Any tag you want to add to the plot                                                                                                                                                                                           
   405 │       │       │       │        │       │               │       │        map_kwargs: dict | None                                                                                                                                                                                                           
   406 │       │       │       │        │       │               │       │            Additional keyword arguments for the map.                                                                                                                                                                                     
   407 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   408 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   409 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   410 │       │       │       │        │       │               │       │            Name of the saved plot file.                                                                                                                                                                                                  
   411 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   412 │       │       │       │        │       │               │       │        # check for known keys in map_kwargs                                                                                                                                                                                              
   413 │       │       │       │        │       │               │       │        map_kwargs_save = map_kwargs.copy() if map_kwargs is not None else {}                                                                                                                                                             
   414 │       │       │       │        │       │               │       │        marker_size_base = map_kwargs_save.pop(                                                                                                                                                                                           
   415 │       │       │       │        │       │               │       │            "marker_size", DefaultMarkerSize.get_marker_size(self.stream)                                                                                                                                                                 
   416 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   417 │       │       │       │        │       │               │       │        scale_marker_size = map_kwargs_save.pop("scale_marker_size", False)                                                                                                                                                               
   418 │       │       │       │        │       │               │       │        marker = map_kwargs_save.pop("marker", "o")                                                                                                                                                                                       
   419 │       │       │       │        │       │               │       │        vmin = map_kwargs_save.pop("vmin", None)                                                                                                                                                                                          
   420 │       │       │       │        │       │               │       │        vmax = map_kwargs_save.pop("vmax", None)                                                                                                                                                                                          
   421 │       │       │       │        │       │               │       │        cmap = plt.get_cmap(map_kwargs_save.pop("colormap", "coolwarm"))                                                                                                                                                                  
   422 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   423 │       │       │       │        │       │               │       │        if isinstance(map_kwargs_save.get("levels", False), oc.listconfig.ListConfig):                                                                                                                                                    
   424 │       │       │       │        │       │               │       │            norm = mpl.colors.BoundaryNorm(                                                                                                                                                                                               
   425 │       │       │       │        │       │               │       │                map_kwargs_save.pop("levels", None), cmap.N, extend="both"                                                                                                                                                                
   426 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   427 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   428 │       │       │       │        │       │               │       │            norm = mpl.colors.Normalize(                                                                                                                                                                                                  
   429 │       │       │       │        │       │               │       │                vmin=vmin,                                                                                                                                                                                                                
   430 │       │       │       │        │       │               │       │                vmax=vmax,                                                                                                                                                                                                                
   431 │       │       │       │        │       │               │       │                clip=False,                                                                                                                                                                                                               
   432 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   433 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   434 │       │       │       │        │       │               │       │        # scale marker size                                                                                                                                                                                                               
   435 │       │       │       │        │       │               │       │        marker_size = marker_size_base                                                                                                                                                                                                    
   436 │       │       │       │        │       │               │       │        if scale_marker_size:                                                                                                                                                                                                             
   437 │       │       │       │        │       │               │       │            marker_size = np.clip(                                                                                                                                                                                                        
   438 │       │       │       │        │       │               │       │                marker_size / np.cos(np.radians(data["lat"])) ** 2,                                                                                                                                                                       
   439 │       │       │       │        │       │               │       │                a_max=marker_size * 10.0,                                                                                                                                                                                                 
   440 │       │       │       │        │       │               │       │                a_min=marker_size,                                                                                                                                                                                                        
   441 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   442 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   443 │       │       │       │        │       │               │       │        # Create figure and axis objects                                                                                                                                                                                                  
   444 │       │       │       │        │       │               │       │        fig = plt.figure(dpi=self.dpi_val)                                                                                                                                                                                                
   445 │       │       │       │        │       │               │       │        ax = fig.add_subplot(1, 1, 1, projection=ccrs.Robinson())                                                                                                                                                                         
   446 │       │       │       │        │       │               │       │        ax.coastlines()                                                                                                                                                                                                                   
   447 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   448 │       │       │       │        │       │               │       │        valid_time = str(data["valid_time"][0].values.astype("datetime64[m]"))                                                                                                                                                            
   449 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   450 │       │       │       │        │       │               │       │        scatter_plt = ax.scatter(                                                                                                                                                                                                         
   451 │       │       │       │        │       │               │       │            data["lon"],                                                                                                                                                                                                                  
   452 │       │       │       │        │       │               │       │            data["lat"],                                                                                                                                                                                                                  
   453 │       │       │       │        │       │               │       │            c=data,                                                                                                                                                                                                                       
   454 │       │       │       │        │       │               │       │            norm=norm,                                                                                                                                                                                                                    
   455 │       │       │       │        │       │               │       │            cmap=cmap,                                                                                                                                                                                                                    
   456 │       │       │       │        │       │               │       │            s=marker_size,                                                                                                                                                                                                                
   457 │       │       │       │        │       │               │       │            marker=marker,                                                                                                                                                                                                                
   458 │       │       │       │        │       │               │       │            transform=ccrs.PlateCarree(),                                                                                                                                                                                                 
   459 │       │       │       │        │       │               │       │            linewidths=0.0,  # only markers, avoids aliasing for very small markers                                                                                                                                                       
   460 │       │       │       │        │       │               │       │            **map_kwargs_save,                                                                                                                                                                                                            
   461 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   462 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   463 │       │       │       │        │       │               │       │        plt.colorbar(                                                                                                                                                                                                                     
   464 │       │       │       │        │       │               │       │            scatter_plt, ax=ax, orientation="horizontal", label=f"Variable: {varname}"                                                                                                                                                    
   465 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   466 │       │       │       │        │       │               │       │        plt.title(f"{self.stream}, {varname} : fstep = {self.fstep:03} ({valid_time})")                                                                                                                                                   
   467 │       │       │       │        │       │               │       │        ax.set_global()                                                                                                                                                                                                                   
   468 │       │       │       │        │       │               │       │        ax.gridlines(draw_labels=False, linestyle="--", color="black", linewidth=1)                                                                                                                                                       
   469 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   470 │       │       │       │        │       │               │       │        # TODO: make this nicer                                                                                                                                                                                                           
   471 │       │       │       │        │       │               │       │        parts = [                                                                                                                                                                                                                         
   472 │       │       │       │        │       │               │       │            "map",                                                                                                                                                                                                                        
   473 │       │       │       │        │       │               │       │            self.run_id,                                                                                                                                                                                                                  
   474 │       │       │       │        │       │               │       │            tag,                                                                                                                                                                                                                          
   475 │       │       │       │        │       │               │       │            str(self.sample),                                                                                                                                                                                                             
   476 │       │       │       │        │       │               │       │            valid_time,                                                                                                                                                                                                                   
   477 │       │       │       │        │       │               │       │            self.stream,                                                                                                                                                                                                                  
   478 │       │       │       │        │       │               │       │            varname,                                                                                                                                                                                                                      
   479 │       │       │       │        │       │               │       │            str(self.fstep).zfill(3),                                                                                                                                                                                                     
   480 │       │       │       │        │       │               │       │        ]                                                                                                                                                                                                                                 
   481 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   482 │       │       │       │        │       │               │       │        name = "_".join(filter(None, parts))                                                                                                                                                                                              
   483 │       │       │       │        │       │               │       │        fname = f"{map_output_dir.joinpath(name)}.{self.image_format}"                                                                                                                                                                    
   484 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   485 │       │       │       │        │       │               │       │        _logger.debug(f"Saving map to {fname}")                                                                                                                                                                                           
   486 │       │       │       │        │       │               │       │        plt.savefig(fname)                                                                                                                                                                                                                
   487 │       │       │       │        │       │               │       │        plt.close()                                                                                                                                                                                                                       
   488 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   489 │       │       │       │        │       │               │       │        return name                                                                                                                                                                                                                       
   490 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   491 │       │       │       │        │       │               │       │    def animation(self, samples, fsteps, variables, select, tag) -> list[str]:                                                                                                                                                            
   492 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   493 │       │       │       │        │       │               │       │        Plot 2D animations for a dataset                                                                                                                                                                                                  
   494 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   495 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   496 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   497 │       │       │       │        │       │               │       │        samples: list                                                                                                                                                                                                                     
   498 │       │       │       │        │       │               │       │            List of the samples to be plotted                                                                                                                                                                                             
   499 │       │       │       │        │       │               │       │        fsteps: list                                                                                                                                                                                                                      
   500 │       │       │       │        │       │               │       │            List of the forecast steps to be plotted                                                                                                                                                                                      
   501 │       │       │       │        │       │               │       │        variables: list                                                                                                                                                                                                                   
   502 │       │       │       │        │       │               │       │            List of variables to be plotted                                                                                                                                                                                               
   503 │       │       │       │        │       │               │       │        select: dict                                                                                                                                                                                                                      
   504 │       │       │       │        │       │               │       │            Selection to be applied to the DataArray                                                                                                                                                                                      
   505 │       │       │       │        │       │               │       │        tag: str                                                                                                                                                                                                                          
   506 │       │       │       │        │       │               │       │            Any tag you want to add to the plot                                                                                                                                                                                           
   507 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   508 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   509 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   510 │       │       │       │        │       │               │       │            List of plot names for the saved animations.                                                                                                                                                                                  
   511 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   512 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   513 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   514 │       │       │       │        │       │               │       │        self.update_data_selection(select)                                                                                                                                                                                                
   515 │       │       │       │        │       │               │       │        map_output_dir = self.get_map_output_dir(tag)                                                                                                                                                                                     
   516 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   517 │       │       │       │        │       │               │       │        for _, sa in enumerate(samples):                                                                                                                                                                                                  
   518 │       │       │       │        │       │               │       │            for _, var in enumerate(variables):                                                                                                                                                                                           
   519 │       │       │       │        │       │               │       │                _logger.info(f"Creating animation for {var} sample: {sa} - {tag}")                                                                                                                                                        
   520 │       │       │       │        │       │               │       │                image_paths = []                                                                                                                                                                                                          
   521 │       │       │       │        │       │               │       │                for _, fstep in enumerate(fsteps):                                                                                                                                                                                        
   522 │       │       │       │        │       │               │       │                    # TODO: refactor to avoid code duplication with scatter_plot                                                                                                                                                          
   523 │       │       │       │        │       │               │       │                    parts = [                                                                                                                                                                                                             
   524 │       │       │       │        │       │               │       │                        "map",                                                                                                                                                                                                            
   525 │       │       │       │        │       │               │       │                        self.run_id,                                                                                                                                                                                                      
   526 │       │       │       │        │       │               │       │                        tag,                                                                                                                                                                                                              
   527 │       │       │       │        │       │               │       │                        str(sa),                                                                                                                                                                                                          
   528 │       │       │       │        │       │               │       │                        "*",                                                                                                                                                                                                              
   529 │       │       │       │        │       │               │       │                        self.stream,                                                                                                                                                                                                      
   530 │       │       │       │        │       │               │       │                        var,                                                                                                                                                                                                              
   531 │       │       │       │        │       │               │       │                        str(fstep).zfill(3),                                                                                                                                                                                              
   532 │       │       │       │        │       │               │       │                    ]                                                                                                                                                                                                                     
   533 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   534 │       │       │       │        │       │               │       │                    name = "_".join(filter(None, parts))                                                                                                                                                                                  
   535 │       │       │       │        │       │               │       │                    fname = f"{map_output_dir.joinpath(name)}.{self.image_format}"                                                                                                                                                        
   536 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   537 │       │       │       │        │       │               │       │                    names = glob.glob(fname)                                                                                                                                                                                              
   538 │       │       │       │        │       │               │       │                    image_paths += names                                                                                                                                                                                                  
   539 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   540 │       │       │       │        │       │               │       │                images = [Image.open(path) for path in image_paths]                                                                                                                                                                       
   541 │       │       │       │        │       │               │       │                images[0].save(                                                                                                                                                                                                           
   542 │       │       │       │        │       │               │       │                    f"{map_output_dir}/animation_{self.run_id}_{tag}_{sa}_{self.stream}_{var}.gif",                                                                                                                                       
   543 │       │       │       │        │       │               │       │                    save_all=True,                                                                                                                                                                                                        
   544 │       │       │       │        │       │               │       │                    append_images=images[1:],                                                                                                                                                                                             
   545 │       │       │       │        │       │               │       │                    duration=500,                                                                                                                                                                                                         
   546 │       │       │       │        │       │               │       │                    loop=0,                                                                                                                                                                                                               
   547 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   548 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   549 │       │       │       │        │       │               │       │        return image_paths                                                                                                                                                                                                                
   550 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   551 │       │       │       │        │       │               │       │    def get_map_output_dir(self, tag):                                                                                                                                                                                                    
   552 │       │       │       │        │       │               │       │        return self.out_plot_basedir / self.stream / "maps" / tag                                                                                                                                                                         
   553 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   554 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   555 │       │       │       │        │       │               │       │class LinePlots:                                                                                                                                                                                                                          
   556 │       │       │       │        │       │               │       │    def __init__(self, plotter_cfg: dict, output_basedir: str | Path):                                                                                                                                                                    
   557 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   558 │       │       │       │        │       │               │       │        Initialize the LinePlots class.                                                                                                                                                                                                   
   559 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   560 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   561 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   562 │       │       │       │        │       │               │       │        plotter_cfg:                                                                                                                                                                                                                      
   563 │       │       │       │        │       │               │       │            Configuration dictionary containing basic information for plotting.                                                                                                                                                           
   564 │       │       │       │        │       │               │       │            Expected keys are:                                                                                                                                                                                                            
   565 │       │       │       │        │       │               │       │                - image_format: Format of the saved images (e.g., 'png', 'pdf', etc.)                                                                                                                                                     
   566 │       │       │       │        │       │               │       │                - dpi_val: DPI value for the saved images                                                                                                                                                                                 
   567 │       │       │       │        │       │               │       │                - fig_size: Size of the figure (width, height) in inches                                                                                                                                                                  
   568 │       │       │       │        │       │               │       │        output_basedir:                                                                                                                                                                                                                   
   569 │       │       │       │        │       │               │       │            Base directory under which the plots will be saved.                                                                                                                                                                           
   570 │       │       │       │        │       │               │       │            Expected scheme `<results_base_dir>/<run_id>`.                                                                                                                                                                                
   571 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   572 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   573 │       │       │       │        │       │               │       │        self.image_format = plotter_cfg.get("image_format")                                                                                                                                                                               
   574 │       │       │       │        │       │               │       │        self.dpi_val = plotter_cfg.get("dpi_val")                                                                                                                                                                                         
   575 │       │       │       │        │       │               │       │        self.fig_size = plotter_cfg.get("fig_size")                                                                                                                                                                                       
   576 │       │       │       │        │       │               │       │        self.log_scale = plotter_cfg.get("log_scale")                                                                                                                                                                                     
   577 │       │       │       │        │       │               │       │        self.add_grid = plotter_cfg.get("add_grid")                                                                                                                                                                                       
   578 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   579 │       │       │       │        │       │               │       │        self.out_plot_dir = Path(output_basedir) / "line_plots"                                                                                                                                                                           
   580 │       │       │       │        │       │               │       │        if not os.path.exists(self.out_plot_dir):                                                                                                                                                                                         
   581 │       │       │       │        │       │               │       │            _logger.info(f"Creating dir {self.out_plot_dir}")                                                                                                                                                                             
   582 │       │       │       │        │       │               │       │            os.makedirs(self.out_plot_dir, exist_ok=True)                                                                                                                                                                                 
   583 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   584 │       │       │       │        │       │               │       │        _logger.info(f"Saving summary plots to: {self.out_plot_dir}")                                                                                                                                                                     
   585 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   586 │       │       │       │        │       │               │       │    def _check_lengths(                                                                                                                                                                                                                   
   587 │       │       │       │        │       │               │       │        self, data: xr.DataArray | list, labels: str | list                                                                                                                                                                               
   588 │       │       │       │        │       │               │       │    ) -> tuple[list, list]:                                                                                                                                                                                                               
   589 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   590 │       │       │       │        │       │               │       │        Check if the lengths of data and labels match.                                                                                                                                                                                    
   591 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   592 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   593 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   594 │       │       │       │        │       │               │       │        data:                                                                                                                                                                                                                             
   595 │       │       │       │        │       │               │       │            DataArray or list of DataArrays to be plotted                                                                                                                                                                                 
   596 │       │       │       │        │       │               │       │        labels:                                                                                                                                                                                                                           
   597 │       │       │       │        │       │               │       │            Label or list of labels for each dataset                                                                                                                                                                                      
   598 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   599 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   600 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   601 │       │       │       │        │       │               │       │            data_list, label_list - lists of data and labels                                                                                                                                                                              
   602 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   603 │       │       │       │        │       │               │       │        assert type(data) == xr.DataArray or type(data) == list, (                                                                                                                                                                        
   604 │       │       │       │        │       │               │       │            "Compare::plot - Data should be of type xr.DataArray or list"                                                                                                                                                                 
   605 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   606 │       │       │       │        │       │               │       │        assert type(labels) == str or type(labels) == list, (                                                                                                                                                                             
   607 │       │       │       │        │       │               │       │            "Compare::plot - Labels should be of type str or list"                                                                                                                                                                        
   608 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   609 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   610 │       │       │       │        │       │               │       │        # convert to lists                                                                                                                                                                                                                
   611 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   612 │       │       │       │        │       │               │       │        data_list = [data] if type(data) == xr.DataArray else data                                                                                                                                                                        
   613 │       │       │       │        │       │               │       │        label_list = [labels] if type(labels) == str else labels                                                                                                                                                                          
   614 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   615 │       │       │       │        │       │               │       │        assert len(data_list) == len(label_list), (                                                                                                                                                                                       
   616 │       │       │       │        │       │               │       │            "Compare::plot - Data and Labels do not match"                                                                                                                                                                                
   617 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   618 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   619 │       │       │       │        │       │               │       │        return data_list, label_list                                                                                                                                                                                                      
   620 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   621 │       │       │       │        │       │               │       │    def print_all_points_from_graph(self, fig: plt.Figure) -> None:                                                                                                                                                                       
   622 │       │       │       │        │       │               │       │        for ax in fig.get_axes():                                                                                                                                                                                                         
   623 │       │       │       │        │       │               │       │            for line in ax.get_lines():                                                                                                                                                                                                   
   624 │       │       │       │        │       │               │       │                ydata = line.get_ydata()                                                                                                                                                                                                  
   625 │       │       │       │        │       │               │       │                xdata = line.get_xdata()                                                                                                                                                                                                  
   626 │       │       │       │        │       │               │       │                label = line.get_label()                                                                                                                                                                                                  
   627 │       │       │       │        │       │               │       │                _logger.info(f"Summary for {label} plot:")                                                                                                                                                                                
   628 │       │       │       │        │       │               │       │                for xi, yi in zip(xdata, ydata, strict=False):                                                                                                                                                                            
   629 │       │       │       │        │       │               │       │                    _logger.info(f"  x: {xi:.3f}, y: {yi:.3f}")                                                                                                                                                                           
   630 │       │       │       │        │       │               │       │                _logger.info("--------------------------")                                                                                                                                                                                
   631 │       │       │       │        │       │               │       │        return                                                                                                                                                                                                                            
   632 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   633 │       │       │       │        │       │               │       │    def plot(                                                                                                                                                                                                                             
   634 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   635 │       │       │       │        │       │               │       │        data: xr.DataArray | list,                                                                                                                                                                                                        
   636 │       │       │       │        │       │               │       │        labels: str | list,                                                                                                                                                                                                               
   637 │       │       │       │        │       │               │       │        tag: str = "",                                                                                                                                                                                                                    
   638 │       │       │       │        │       │               │       │        x_dim: str = "forecast_step",                                                                                                                                                                                                     
   639 │       │       │       │        │       │               │       │        y_dim: str = "value",                                                                                                                                                                                                             
   640 │       │       │       │        │       │               │       │        print_summary: bool = False,                                                                                                                                                                                                      
   641 │       │       │       │        │       │               │       │    ) -> None:                                                                                                                                                                                                                            
   642 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   643 │       │       │       │        │       │               │       │        Plot a line graph comparing multiple datasets.                                                                                                                                                                                    
   644 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   645 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   646 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   647 │       │       │       │        │       │               │       │        data:                                                                                                                                                                                                                             
   648 │       │       │       │        │       │               │       │            DataArray or list of DataArrays to be plotted                                                                                                                                                                                 
   649 │       │       │       │        │       │               │       │        labels:                                                                                                                                                                                                                           
   650 │       │       │       │        │       │               │       │            Label or list of labels for each dataset                                                                                                                                                                                      
   651 │       │       │       │        │       │               │       │        tag:                                                                                                                                                                                                                              
   652 │       │       │       │        │       │               │       │            Tag to be added to the plot title and filename                                                                                                                                                                                
   653 │       │       │       │        │       │               │       │        x_dim:                                                                                                                                                                                                                            
   654 │       │       │       │        │       │               │       │            Dimension to be used for the x-axis. The code will average over all other dimensions.                                                                                                                                         
   655 │       │       │       │        │       │               │       │        y_dim:                                                                                                                                                                                                                            
   656 │       │       │       │        │       │               │       │            Name of the dimension to be used for the y-axis.                                                                                                                                                                              
   657 │       │       │       │        │       │               │       │        print_summary:                                                                                                                                                                                                                    
   658 │       │       │       │        │       │               │       │            If True, print a summary of the values from the graph.                                                                                                                                                                        
   659 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   660 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   661 │       │       │       │        │       │               │       │        data_list, label_list = self._check_lengths(data, labels)                                                                                                                                                                         
   662 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   663 │       │       │       │        │       │               │       │        assert x_dim in data_list[0].dims, (                                                                                                                                                                                              
   664 │       │       │       │        │       │               │       │            "x dimension '{x_dim}' not found in data dimensions {data_list[0].dims}"                                                                                                                                                      
   665 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   666 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   667 │       │       │       │        │       │               │       │        fig = plt.figure(figsize=(12, 6), dpi=self.dpi_val)                                                                                                                                                                               
   668 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   669 │       │       │       │        │       │               │       │        for i, data in enumerate(data_list):                                                                                                                                                                                              
   670 │       │       │       │        │       │               │       │            non_zero_dims = [                                                                                                                                                                                                             
   671 │       │       │       │        │       │               │       │                dim for dim in data.dims if dim != x_dim and data[dim].shape[0] > 1                                                                                                                                                       
   672 │       │       │       │        │       │               │       │            ]                                                                                                                                                                                                                             
   673 │       │       │       │        │       │               │       │            if non_zero_dims:                                                                                                                                                                                                             
   674 │       │       │       │        │       │               │       │                _logger.info(                                                                                                                                                                                                             
   675 │       │       │       │        │       │               │       │                    f"LinePlot:: Found multiple entries for dimensions: {non_zero_dims}. Averaging..."                                                                                                                                    
   676 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   677 │       │       │       │        │       │               │       │            averaged = data.mean(                                                                                                                                                                                                         
   678 │       │       │       │        │       │               │       │                dim=[dim for dim in data.dims if dim != x_dim], skipna=True                                                                                                                                                               
   679 │       │       │       │        │       │               │       │            ).sortby(x_dim)                                                                                                                                                                                                               
   680 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   681 │       │       │       │        │       │               │       │            plt.plot(                                                                                                                                                                                                                     
   682 │       │       │       │        │       │               │       │                averaged[x_dim],                                                                                                                                                                                                          
   683 │       │       │       │        │       │               │       │                averaged.values,                                                                                                                                                                                                          
   684 │       │       │       │        │       │               │       │                label=label_list[i],                                                                                                                                                                                                      
   685 │       │       │       │        │       │               │       │                marker="o",                                                                                                                                                                                                               
   686 │       │       │       │        │       │               │       │                linestyle="-",                                                                                                                                                                                                            
   687 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   688 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   689 │       │       │       │        │       │               │       │        xlabel = "".join(c if c.isalnum() else " " for c in x_dim)                                                                                                                                                                        
   690 │       │       │       │        │       │               │       │        plt.xlabel(xlabel)                                                                                                                                                                                                                
   691 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   692 │       │       │       │        │       │               │       │        ylabel = "".join(c if c.isalnum() else " " for c in y_dim)                                                                                                                                                                        
   693 │       │       │       │        │       │               │       │        plt.ylabel(ylabel)                                                                                                                                                                                                                
   694 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   695 │       │       │       │        │       │               │       │        title = "".join(c if c.isalnum() else " " for c in tag)                                                                                                                                                                           
   696 │       │       │       │        │       │               │       │        plt.title(title)                                                                                                                                                                                                                  
   697 │       │       │       │        │       │               │       │        plt.legend(frameon=False)                                                                                                                                                                                                         
   698 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   699 │       │       │       │        │       │               │       │        if self.add_grid:                                                                                                                                                                                                                 
   700 │       │       │       │        │       │               │       │            plt.grid(True, linestyle="--", color="gray", alpha=0.5)                                                                                                                                                                       
   701 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   702 │       │       │       │        │       │               │       │        if self.log_scale:                                                                                                                                                                                                                
   703 │       │       │       │        │       │               │       │            plt.yscale("log")                                                                                                                                                                                                             
   704 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   705 │       │       │       │        │       │               │       │        if print_summary:                                                                                                                                                                                                                 
   706 │       │       │       │        │       │               │       │            _logger.info(f"Summary values for {tag}")                                                                                                                                                                                     
   707 │       │       │       │        │       │               │       │            self.print_all_points_from_graph(fig)                                                                                                                                                                                         
   708 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   709 │       │       │       │        │       │               │       │        parts = ["compare", tag]                                                                                                                                                                                                          
   710 │       │       │       │        │       │               │       │        name = "_".join(filter(None, parts))                                                                                                                                                                                              
   711 │       │    7% │   2%  │  96%   │  212M │▃▃▃▃▃▄▄▄▄  49% │     3 │        plt.savefig(f"{self.out_plot_dir.joinpath(name)}.{self.image_format}")                                                                                                                                                            
   712 │       │       │       │        │       │               │       │        plt.close()                                                                                                                                                                                                                       
   713 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
╶──────┼───────┼───────┼───────┼────────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │       │        │       │               │       │function summary for /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/plotter.py                                                                                                
   556 │       │       │       │        │       │               │       │LinePlots.__init__                                                                                                                                                                                                                        
   633 │       │    7% │   2%  │  96%   │  212M │█████████  49% │     3 │LinePlots.plot                                                                                                                                                                                                                            
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
Top PEAK memory consumption, by line:
(1)   711:   212 MB                                                                                                                                                                                                                                                                                                 
(2)     6:    11 MB                                                                                                                                                                                                                                                                                                 
(3)     9:    10 MB                                                                                                                                                                                                                                                                                                 
(4)     8:    10 MB                                                                                                                                                                                                                                                                                                 
                                                                    /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/io_reader.py: % of time =  26.15% (1m:1.816s) out of 4m:56.410s.                                                                    
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/io_reader.py                                                                                                                   
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │# (C) Copyright 2025 WeatherGenerator contributors.                                                                                                                                                                                       
     2 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     3 │       │       │       │        │       │               │       │# This software is licensed under the terms of the Apache Licence Version 2.0                                                                                                                                                             
     4 │       │       │       │        │       │               │       │# which can be obtained at http://www.apache.org/licenses/LICENSE-2.0.                                                                                                                                                                    
     5 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     6 │       │       │       │        │       │               │       │# In applying this licence, ECMWF does not waive the privileges and immunities                                                                                                                                                            
     7 │       │       │       │        │       │               │       │# granted to it by virtue of its status as an intergovernmental organisation                                                                                                                                                              
     8 │       │       │       │        │       │               │       │# nor does it submit to any jurisdiction.                                                                                                                                                                                                 
     9 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    10 │       │       │       │        │       │               │       │import logging                                                                                                                                                                                                                            
    11 │       │       │       │        │       │               │       │from dataclasses import dataclass                                                                                                                                                                                                         
    12 │       │       │       │        │       │               │       │from pathlib import Path                                                                                                                                                                                                                  
    13 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    14 │       │       │       │        │       │               │       │import numpy as np                                                                                                                                                                                                                        
    15 │       │       │       │        │       │               │       │import omegaconf as oc                                                                                                                                                                                                                    
    16 │    1% │    2% │   8%  │ 100%   │   30M │▁▁▁   7%       │       │import xarray as xr                                                                                                                                                                                                                       
    17 │       │       │       │        │       │               │       │from tqdm import tqdm                                                                                                                                                                                                                     
    18 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    19 │       │       │       │        │       │               │       │from weathergen.common.config import load_config, load_model_config                                                                                                                                                                       
    20 │    1% │    2% │   8%  │        │       │               │       │from weathergen.common.io import ZarrIO                                                                                                                                                                                                   
    21 │       │       │       │        │       │               │       │from weathergen.evaluate.derived_channels import DeriveChannels                                                                                                                                                                           
    22 │       │       │       │        │       │               │       │from weathergen.evaluate.score_utils import RegionBoundingBox, to_list                                                                                                                                                                    
    23 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    24 │       │       │       │        │       │               │       │_logger = logging.getLogger(__name__)                                                                                                                                                                                                     
    25 │       │       │       │        │       │               │       │_logger.setLevel(logging.INFO)                                                                                                                                                                                                            
    26 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    27 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    28 │       │       │       │        │       │               │       │@dataclass                                                                                                                                                                                                                                
    29 │       │       │       │        │       │               │       │class ReaderOutput:                                                                                                                                                                                                                       
    30 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    31 │       │       │       │        │       │               │       │    Dataclass to hold the output of the Reader.get_data method.                                                                                                                                                                           
    32 │       │       │       │        │       │               │       │    Attributes                                                                                                                                                                                                                            
    33 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
    34 │       │       │       │        │       │               │       │    target : dict[str, xr.Dataset]                                                                                                                                                                                                        
    35 │       │       │       │        │       │               │       │        Dictionary of xarray Datasets for targets, indexed by forecast step.                                                                                                                                                              
    36 │       │       │       │        │       │               │       │    prediction : dict[str, xr.Dataset]                                                                                                                                                                                                    
    37 │       │       │       │        │       │               │       │        Dictionary of xarray Datasets for predictions, indexed by forecast step.                                                                                                                                                          
    38 │       │       │       │        │       │               │       │    points_per_sample : xr.DataArray | None                                                                                                                                                                                               
    39 │       │       │       │        │       │               │       │        xarray DataArray containing the number of points per sample, if `return_counts` is True                                                                                                                                           
    40 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    41 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    42 │       │       │       │        │       │               │       │    target: dict[str, xr.Dataset]                                                                                                                                                                                                         
    43 │       │       │       │        │       │               │       │    prediction: dict[str, xr.Dataset]                                                                                                                                                                                                     
    44 │       │       │       │        │       │               │       │    points_per_sample: xr.DataArray | None                                                                                                                                                                                                
    45 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    46 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    47 │       │       │       │        │       │               │       │@dataclass                                                                                                                                                                                                                                
    48 │       │       │       │        │       │               │       │class DataAvailability:                                                                                                                                                                                                                   
    49 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    50 │       │       │       │        │       │               │       │    Dataclass to hold information about data availability in the input files.                                                                                                                                                             
    51 │       │       │       │        │       │               │       │    Attributes                                                                                                                                                                                                                            
    52 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
    53 │       │       │       │        │       │               │       │    score_availability: bool                                                                                                                                                                                                              
    54 │       │       │       │        │       │               │       │        True if the metric file contains the requested combination.                                                                                                                                                                       
    55 │       │       │       │        │       │               │       │    channels: list[str]                                                                                                                                                                                                                   
    56 │       │       │       │        │       │               │       │        List of channels requested                                                                                                                                                                                                        
    57 │       │       │       │        │       │               │       │    fsteps: list[int]                                                                                                                                                                                                                     
    58 │       │       │       │        │       │               │       │        List of forecast steps requested                                                                                                                                                                                                  
    59 │       │       │       │        │       │               │       │    samples: list[int]                                                                                                                                                                                                                    
    60 │       │       │       │        │       │               │       │        List of samples requested                                                                                                                                                                                                         
    61 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    62 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    63 │       │       │       │        │       │               │       │    score_availability: bool                                                                                                                                                                                                              
    64 │       │       │       │        │       │               │       │    channels: list[str] | None                                                                                                                                                                                                            
    65 │       │       │       │        │       │               │       │    fsteps: list[int] | None                                                                                                                                                                                                              
    66 │       │       │       │        │       │               │       │    samples: list[int] | None                                                                                                                                                                                                             
    67 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    68 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    69 │       │       │       │        │       │               │       │class Reader:                                                                                                                                                                                                                             
    70 │       │       │       │        │       │               │       │    def __init__(self, eval_cfg: dict, run_id: str, private_paths: dict | None = None):                                                                                                                                                   
    71 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
    72 │       │       │       │        │       │               │       │        Generic data reader class.                                                                                                                                                                                                        
    73 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    74 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
    75 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
    76 │       │       │       │        │       │               │       │        eval_cfg : dir                                                                                                                                                                                                                    
    77 │       │       │       │        │       │               │       │            config with plotting and evaluation options for that run id                                                                                                                                                                   
    78 │       │       │       │        │       │               │       │        run_id : str                                                                                                                                                                                                                      
    79 │       │       │       │        │       │               │       │            run id of the model                                                                                                                                                                                                           
    80 │       │       │       │        │       │               │       │        private_paths: lists                                                                                                                                                                                                              
    81 │       │       │       │        │       │               │       │            list of private paths for the supported HPC                                                                                                                                                                                   
    82 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
    83 │       │       │       │        │       │               │       │        self.eval_cfg = eval_cfg                                                                                                                                                                                                          
    84 │       │       │       │        │       │               │       │        self.run_id = run_id                                                                                                                                                                                                              
    85 │       │       │       │        │       │               │       │        self.private_paths = private_paths                                                                                                                                                                                                
    86 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    87 │       │       │       │        │       │               │       │        self.streams = eval_cfg.streams.keys()                                                                                                                                                                                            
    88 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    89 │       │       │       │        │       │               │       │        # If results_base_dir and model_base_dir are not provided, default paths are used                                                                                                                                                 
    90 │       │       │       │        │       │               │       │        self.model_base_dir = self.eval_cfg.get("model_base_dir", None)                                                                                                                                                                   
    91 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    92 │       │       │       │        │       │               │       │        self.results_base_dir = self.eval_cfg.get(                                                                                                                                                                                        
    93 │       │       │       │        │       │               │       │            "results_base_dir", None                                                                                                                                                                                                      
    94 │       │       │       │        │       │               │       │        )  # base directory where results will be stored                                                                                                                                                                                  
    95 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    96 │       │       │       │        │       │               │       │    def get_stream(self, stream: str):                                                                                                                                                                                                    
    97 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
    98 │       │       │       │        │       │               │       │        returns the dictionary associated to a particular stream                                                                                                                                                                          
    99 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   100 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   101 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   102 │       │       │       │        │       │               │       │        stream: str                                                                                                                                                                                                                       
   103 │       │       │       │        │       │               │       │            the stream name                                                                                                                                                                                                               
   104 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   105 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   106 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   107 │       │       │       │        │       │               │       │        dict                                                                                                                                                                                                                              
   108 │       │       │       │        │       │               │       │            the config dictionary associated to that stream                                                                                                                                                                               
   109 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   110 │       │       │       │        │       │               │       │        return self.eval_cfg.streams.get(stream, {})                                                                                                                                                                                      
   111 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   112 │       │       │       │        │       │               │       │    def get_samples(self) -> set[int]:                                                                                                                                                                                                    
   113 │       │       │       │        │       │               │       │        """Placeholder implementation of sample getter. Override in subclass."""                                                                                                                                                          
   114 │       │       │       │        │       │               │       │        return set()                                                                                                                                                                                                                      
   115 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   116 │       │       │       │        │       │               │       │    def get_forecast_steps(self) -> set[int]:                                                                                                                                                                                             
   117 │       │       │       │        │       │               │       │        """Placeholder implementation forecast step getter. Override in subclass."""                                                                                                                                                      
   118 │       │       │       │        │       │               │       │        return set()                                                                                                                                                                                                                      
   119 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   120 │       │       │       │        │       │               │       │    # TODO: get this from config                                                                                                                                                                                                          
   121 │       │       │       │        │       │               │       │    def get_channels(self, stream: str | None = None) -> list[str]:                                                                                                                                                                       
   122 │       │       │       │        │       │               │       │        """Placeholder implementation channel names getter. Override in subclass."""                                                                                                                                                      
   123 │       │       │       │        │       │               │       │        return list()                                                                                                                                                                                                                     
   124 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   125 │       │       │       │        │       │               │       │    def check_availability(                                                                                                                                                                                                               
   126 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   127 │       │       │       │        │       │               │       │        stream: str,                                                                                                                                                                                                                      
   128 │       │       │       │        │       │               │       │        available_data: dict | None = None,                                                                                                                                                                                               
   129 │       │       │       │        │       │               │       │        mode: str = "",                                                                                                                                                                                                                   
   130 │       │       │       │        │       │               │       │    ) -> DataAvailability:                                                                                                                                                                                                                
   131 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   132 │       │       │       │        │       │               │       │        Check if requested channels, forecast steps and samples are                                                                                                                                                                       
   133 │       │       │       │        │       │               │       │        i) available in the previously saved metric file if specified (return False otherwise)                                                                                                                                            
   134 │       │       │       │        │       │               │       │        ii) available in the source file (e.g. the Zarr file, return error otherwise)                                                                                                                                                     
   135 │       │       │       │        │       │               │       │        Additionally, if channels, forecast steps or samples is None/'all', it will                                                                                                                                                       
   136 │       │       │       │        │       │               │       │        i) set the variable to all available vars in source file                                                                                                                                                                          
   137 │       │       │       │        │       │               │       │        ii) return True only if the respective variable contains the same indeces in metric file and source file (return False otherwise)                                                                                                 
   138 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   139 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   140 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   141 │       │       │       │        │       │               │       │        stream : str                                                                                                                                                                                                                      
   142 │       │       │       │        │       │               │       │            The stream considered.                                                                                                                                                                                                        
   143 │       │       │       │        │       │               │       │        available_data : dict, optional                                                                                                                                                                                                   
   144 │       │       │       │        │       │               │       │            The available data loaded from metric file.                                                                                                                                                                                   
   145 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   146 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   147 │       │       │       │        │       │               │       │        DataAvailability                                                                                                                                                                                                                  
   148 │       │       │       │        │       │               │       │            A dataclass containing:                                                                                                                                                                                                       
   149 │       │       │       │        │       │               │       │            - channels: list of channels or None if 'all'                                                                                                                                                                                 
   150 │       │       │       │        │       │               │       │            - fsteps: list of forecast steps or None if 'all'                                                                                                                                                                             
   151 │       │       │       │        │       │               │       │            - samples: list of samples or None if 'all'                                                                                                                                                                                   
   152 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   153 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   154 │       │       │       │        │       │               │       │        # fill info for requested channels, fsteps, samples                                                                                                                                                                               
   155 │       │       │       │        │       │               │       │        requested_data = self._get_channels_fsteps_samples(stream, mode)                                                                                                                                                                  
   156 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   157 │       │       │       │        │       │               │       │        channels = requested_data.channels                                                                                                                                                                                                
   158 │       │       │       │        │       │               │       │        fsteps = requested_data.fsteps                                                                                                                                                                                                    
   159 │       │       │       │        │       │               │       │        samples = requested_data.samples                                                                                                                                                                                                  
   160 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   161 │       │       │       │        │       │               │       │        requested = {                                                                                                                                                                                                                     
   162 │       │       │       │        │       │               │       │            "channel": set(channels) if channels is not None else None,                                                                                                                                                                   
   163 │       │       │       │        │       │               │       │            "fstep": set(fsteps) if fsteps is not None else None,                                                                                                                                                                         
   164 │       │       │       │        │       │               │       │            "sample": set(samples) if samples is not None else None,                                                                                                                                                                      
   165 │       │       │       │        │       │               │       │        }                                                                                                                                                                                                                                 
   166 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   167 │       │       │       │        │       │               │       │        # fill info from available metric file (if provided)                                                                                                                                                                              
   168 │       │       │       │        │       │               │       │        available = {                                                                                                                                                                                                                     
   169 │       │       │       │        │       │               │       │            "channel": set(available_data["channel"].values.ravel())                                                                                                                                                                      
   170 │       │       │       │        │       │               │       │            if available_data is not None                                                                                                                                                                                                 
   171 │       │       │       │        │       │               │       │            else {},                                                                                                                                                                                                                      
   172 │       │       │       │        │       │               │       │            "fstep": set(available_data["forecast_step"].values.ravel())                                                                                                                                                                  
   173 │       │       │       │        │       │               │       │            if available_data is not None                                                                                                                                                                                                 
   174 │       │       │       │        │       │               │       │            else {},                                                                                                                                                                                                                      
   175 │       │       │       │        │       │               │       │            "sample": set(available_data.coords["sample"].values.ravel())                                                                                                                                                                 
   176 │       │       │       │        │       │               │       │            if available_data is not None                                                                                                                                                                                                 
   177 │       │       │       │        │       │               │       │            else {},                                                                                                                                                                                                                      
   178 │       │       │       │        │       │               │       │        }                                                                                                                                                                                                                                 
   179 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   180 │       │       │       │        │       │               │       │        # fill info from reader                                                                                                                                                                                                           
   181 │       │       │       │        │       │               │       │        reader_data = {                                                                                                                                                                                                                   
   182 │       │       │       │        │       │               │       │            "fstep": set(int(f) for f in self.get_forecast_steps()),                                                                                                                                                                      
   183 │       │       │       │        │       │               │       │            "sample": set(int(s) for s in self.get_samples()),                                                                                                                                                                            
   184 │       │       │       │        │       │               │       │            "channel": set(self.get_channels(stream)),                                                                                                                                                                                    
   185 │       │       │       │        │       │               │       │        }                                                                                                                                                                                                                                 
   186 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   187 │       │       │       │        │       │               │       │        check_score = True                                                                                                                                                                                                                
   188 │       │       │       │        │       │               │       │        corrected = False                                                                                                                                                                                                                 
   189 │       │       │       │        │       │               │       │        for name in ["channel", "fstep", "sample"]:                                                                                                                                                                                       
   190 │       │       │       │        │       │               │       │            if requested[name] is None:                                                                                                                                                                                                   
   191 │       │       │       │        │       │               │       │                # Default to all in Zarr                                                                                                                                                                                                  
   192 │       │       │       │        │       │               │       │                requested[name] = reader_data[name]                                                                                                                                                                                       
   193 │       │       │       │        │       │               │       │                # If file with metrics exists, must exactly match                                                                                                                                                                         
   194 │       │       │       │        │       │               │       │                if available_data is not None and reader_data[name] != available[name]:                                                                                                                                                   
   195 │       │       │       │        │       │               │       │                    _logger.info(                                                                                                                                                                                                         
   196 │       │       │       │        │       │               │       │                        f"Requested all {name}s for {mode}, but previous config was a strict subset. Recomputing."                                                                                                                        
   197 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
   198 │       │       │       │        │       │               │       │                    check_score = False                                                                                                                                                                                                   
   199 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   200 │       │       │       │        │       │               │       │            # Must be subset of Zarr                                                                                                                                                                                                      
   201 │       │       │       │        │       │               │       │            if not requested[name] <= reader_data[name]:                                                                                                                                                                                  
   202 │       │       │       │        │       │               │       │                missing = requested[name] - reader_data[name]                                                                                                                                                                             
   203 │       │       │       │        │       │               │       │                _logger.info(                                                                                                                                                                                                             
   204 │       │       │       │        │       │               │       │                    f"Requested {name}(s) {missing} do(es) not exist in Zarr. "                                                                                                                                                           
   205 │       │       │       │        │       │               │       │                    f"Removing missing {name}(s) for {mode}."                                                                                                                                                                             
   206 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   207 │       │       │       │        │       │               │       │                requested[name] = requested[name] & reader_data[name]                                                                                                                                                                     
   208 │       │       │       │        │       │               │       │                corrected = True                                                                                                                                                                                                          
   209 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   210 │       │       │       │        │       │               │       │            # Must be a subset of available_data (if provided)                                                                                                                                                                            
   211 │       │       │       │        │       │               │       │            if available_data is not None and not requested[name] <= available[name]:                                                                                                                                                     
   212 │       │       │       │        │       │               │       │                missing = requested[name] - available[name]                                                                                                                                                                               
   213 │       │       │       │        │       │               │       │                _logger.info(                                                                                                                                                                                                             
   214 │       │       │       │        │       │               │       │                    f"{name.capitalize()}(s) {missing} missing in previous evaluation. Recomputing."                                                                                                                                      
   215 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   216 │       │       │       │        │       │               │       │                check_score = False                                                                                                                                                                                                       
   217 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   218 │       │       │       │        │       │               │       │        if check_score and not corrected:                                                                                                                                                                                                 
   219 │       │       │       │        │       │               │       │            scope = "metric file" if available_data is not None else "Zarr file"                                                                                                                                                          
   220 │       │       │       │        │       │               │       │            _logger.info(                                                                                                                                                                                                                 
   221 │       │       │       │        │       │               │       │                f"All checks passed – All channels, samples, fsteps requested for {mode} are present in {scope}..."                                                                                                                       
   222 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   223 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   224 │       │       │       │        │       │               │       │        return DataAvailability(                                                                                                                                                                                                          
   225 │       │       │       │        │       │               │       │            score_availability=check_score,                                                                                                                                                                                               
   226 │       │       │       │        │       │               │       │            channels=sorted(list(requested["channel"])),                                                                                                                                                                                  
   227 │       │       │       │        │       │               │       │            fsteps=sorted(list(requested["fstep"])),                                                                                                                                                                                      
   228 │       │       │       │        │       │               │       │            samples=sorted(list(requested["sample"])),                                                                                                                                                                                    
   229 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   230 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   231 │       │       │       │        │       │               │       │    def _get_channels_fsteps_samples(self, stream: str, mode: str) -> DataAvailability:                                                                                                                                                   
   232 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   233 │       │       │       │        │       │               │       │        Get channels, fsteps and samples for a given run and stream from the config. Replace 'all' with None.                                                                                                                             
   234 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   235 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   236 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   237 │       │       │       │        │       │               │       │        stream: str                                                                                                                                                                                                                       
   238 │       │       │       │        │       │               │       │            The stream considered.                                                                                                                                                                                                        
   239 │       │       │       │        │       │               │       │        mode: str                                                                                                                                                                                                                         
   240 │       │       │       │        │       │               │       │            if plotting or evaluation mode                                                                                                                                                                                                
   241 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   242 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   243 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   244 │       │       │       │        │       │               │       │        DataAvailability                                                                                                                                                                                                                  
   245 │       │       │       │        │       │               │       │            A dataclass containing:                                                                                                                                                                                                       
   246 │       │       │       │        │       │               │       │            - channels: list of channels or None if 'all'                                                                                                                                                                                 
   247 │       │       │       │        │       │               │       │            - fsteps: list of forecast steps or None if 'all'                                                                                                                                                                             
   248 │       │       │       │        │       │               │       │            - samples: list of samples or None if 'all'                                                                                                                                                                                   
   249 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   250 │       │       │       │        │       │               │       │        assert mode == "plotting" or mode == "evaluation", (                                                                                                                                                                              
   251 │       │       │       │        │       │               │       │            "get_channels_fsteps_samples:: Mode should be either 'plotting' or 'evaluation'"                                                                                                                                              
   252 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   253 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   254 │       │       │       │        │       │               │       │        stream_cfg = self.get_stream(stream)                                                                                                                                                                                              
   255 │       │       │       │        │       │               │       │        assert stream_cfg.get(mode, False), (                                                                                                                                                                                             
   256 │       │       │       │        │       │               │       │            "Mode does not exist in stream config. Please add it."                                                                                                                                                                        
   257 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   258 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   259 │       │       │       │        │       │               │       │        samples = stream_cfg[mode].get("sample", None)                                                                                                                                                                                    
   260 │       │       │       │        │       │               │       │        fsteps = stream_cfg[mode].get("forecast_step", None)                                                                                                                                                                              
   261 │       │       │       │        │       │               │       │        channels = stream_cfg.get("channels", None)                                                                                                                                                                                       
   262 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   263 │       │       │       │        │       │               │       │        return DataAvailability(                                                                                                                                                                                                          
   264 │       │       │       │        │       │               │       │            score_availability=True,                                                                                                                                                                                                      
   265 │       │       │       │        │       │               │       │            channels=None                                                                                                                                                                                                                 
   266 │       │       │       │        │       │               │       │            if (channels == "all" or channels is None)                                                                                                                                                                                    
   267 │       │       │       │        │       │               │       │            else list(channels),                                                                                                                                                                                                          
   268 │       │       │       │        │       │               │       │            fsteps=None if (fsteps == "all" or fsteps is None) else list(fsteps),                                                                                                                                                         
   269 │       │       │       │        │       │               │       │            samples=None if (samples == "all" or samples is None) else list(samples),                                                                                                                                                     
   270 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   271 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   272 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   273 │       │       │       │        │       │               │       │class WeatherGenReader(Reader):                                                                                                                                                                                                           
   274 │       │       │       │        │       │               │       │    def __init__(self, eval_cfg: dict, run_id: str, private_paths: dict | None = None):                                                                                                                                                   
   275 │       │       │       │        │       │               │       │        """Data reader class for WeatherGenerator model outputs stored in Zarr format."""                                                                                                                                                 
   276 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   277 │       │       │       │        │       │               │       │        super().__init__(eval_cfg, run_id, private_paths)                                                                                                                                                                                 
   278 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   279 │       │       │       │        │       │               │       │        self.epoch = eval_cfg.epoch                                                                                                                                                                                                       
   280 │       │       │       │        │       │               │       │        self.rank = eval_cfg.rank                                                                                                                                                                                                         
   281 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   282 │       │       │       │        │       │               │       │        # Load model configuration and set (run-id specific) directories                                                                                                                                                                  
   283 │       │       │       │        │       │               │       │        self.inference_cfg = self.get_inference_config()                                                                                                                                                                                  
   284 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   285 │       │       │       │        │       │               │       │        if not self.results_base_dir:                                                                                                                                                                                                     
   286 │       │       │       │        │       │               │       │            self.results_base_dir = Path(self.inference_cfg["run_path"])                                                                                                                                                                  
   287 │       │       │       │        │       │               │       │            _logger.info(                                                                                                                                                                                                                 
   288 │       │       │       │        │       │               │       │                f"Results directory obtained from model config: {self.results_base_dir}"                                                                                                                                                  
   289 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   290 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   291 │       │       │       │        │       │               │       │            _logger.info(f"Results directory parsed: {self.results_base_dir}")                                                                                                                                                            
   292 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   293 │       │       │       │        │       │               │       │        self.runplot_base_dir = Path(                                                                                                                                                                                                     
   294 │       │       │       │        │       │               │       │            self.eval_cfg.get("runplot_base_dir", self.results_base_dir)                                                                                                                                                                  
   295 │       │       │       │        │       │               │       │        )  # base directory where map plots and histograms will be stored                                                                                                                                                                 
   296 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   297 │       │       │       │        │       │               │       │        self.metrics_base_dir = Path(                                                                                                                                                                                                     
   298 │       │       │       │        │       │               │       │            self.eval_cfg.get("metrics_base_dir", self.results_base_dir)                                                                                                                                                                  
   299 │       │       │       │        │       │               │       │        )  # base directory where score files will be stored                                                                                                                                                                              
   300 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   301 │       │       │       │        │       │               │       │        self.results_dir, self.runplot_dir = (                                                                                                                                                                                            
   302 │       │       │       │        │       │               │       │            Path(self.results_base_dir) / self.run_id,                                                                                                                                                                                    
   303 │       │       │       │        │       │               │       │            Path(self.runplot_base_dir) / self.run_id,                                                                                                                                                                                    
   304 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   305 │       │       │       │        │       │               │       │        # for backward compatibility allow metric_dir to be specified in the run config                                                                                                                                                   
   306 │       │       │       │        │       │               │       │        self.metrics_dir = Path(                                                                                                                                                                                                          
   307 │       │       │       │        │       │               │       │            self.eval_cfg.get(                                                                                                                                                                                                            
   308 │       │       │       │        │       │               │       │                "metrics_dir", self.metrics_base_dir / self.run_id / "evaluation"                                                                                                                                                         
   309 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   310 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   311 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   312 │       │       │       │        │       │               │       │        self.fname_zarr = self.results_dir.joinpath(                                                                                                                                                                                      
   313 │       │       │       │        │       │               │       │            f"validation_epoch{self.epoch:05d}_rank{self.rank:04d}.zarr"                                                                                                                                                                  
   314 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   315 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   316 │       │       │       │        │       │               │       │        if not self.fname_zarr.exists() or not self.fname_zarr.is_dir():                                                                                                                                                                  
   317 │       │       │       │        │       │               │       │            _logger.error(                                                                                                                                                                                                                
   318 │       │       │       │        │       │               │       │                f"Zarr file {self.fname_zarr} does not exist or is not a directory."                                                                                                                                                      
   319 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   320 │       │       │       │        │       │               │       │            raise FileNotFoundError(                                                                                                                                                                                                      
   321 │       │       │       │        │       │               │       │                f"Zarr file {self.fname_zarr} does not exist or is not a directory."                                                                                                                                                      
   322 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   323 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   324 │       │       │       │        │       │               │       │    def get_inference_config(self):                                                                                                                                                                                                       
   325 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   326 │       │       │       │        │       │               │       │        load the config associated to the inference run (different from the eval_cfg which contains plot and evaluaiton options.)                                                                                                         
   327 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   328 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   329 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   330 │       │       │       │        │       │               │       │        dict                                                                                                                                                                                                                              
   331 │       │       │       │        │       │               │       │            configuration file from the inference run                                                                                                                                                                                     
   332 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   333 │       │       │       │        │       │               │       │        if self.private_paths:                                                                                                                                                                                                            
   334 │       │       │       │        │       │               │       │            _logger.info(                                                                                                                                                                                                                 
   335 │       │       │       │        │       │               │       │                f"Loading config for run {self.run_id} from private paths: {self.private_paths}"                                                                                                                                          
   336 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   337 │       │       │       │        │       │               │       │            config = load_config(self.private_paths, self.run_id, self.epoch)                                                                                                                                                             
   338 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   339 │       │       │       │        │       │               │       │            _logger.info(                                                                                                                                                                                                                 
   340 │       │       │       │        │       │               │       │                f"Loading config for run {self.run_id} from model directory: {self.model_base_dir}"                                                                                                                                       
   341 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   342 │       │       │   1%  │        │       │               │       │            config = load_model_config(self.run_id, self.epoch, self.model_base_dir)                                                                                                                                                      
   343 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   344 │       │       │       │        │       │               │       │        if type(config) not in [dict, oc.DictConfig]:                                                                                                                                                                                     
   345 │       │       │       │        │       │               │       │            _logger.warning("Model config not found. inference config will be empty.")                                                                                                                                                    
   346 │       │       │       │        │       │               │       │            config = {}                                                                                                                                                                                                                   
   347 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   348 │       │       │       │        │       │               │       │        return config                                                                                                                                                                                                                     
   349 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   350 │       │       │       │        │       │               │       │    def get_data(                                                                                                                                                                                                                         
   351 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   352 │       │       │       │        │       │               │       │        stream: str,                                                                                                                                                                                                                      
   353 │       │       │       │        │       │               │       │        region: str = "global",                                                                                                                                                                                                           
   354 │       │       │       │        │       │               │       │        samples: list[int] | None = None,                                                                                                                                                                                                 
   355 │       │       │       │        │       │               │       │        fsteps: list[str] | None = None,                                                                                                                                                                                                  
   356 │       │       │       │        │       │               │       │        channels: list[str] | None = None,                                                                                                                                                                                                
   357 │       │       │       │        │       │               │       │        return_counts: bool = False,                                                                                                                                                                                                      
   358 │       │       │       │        │       │               │       │    ) -> ReaderOutput:                                                                                                                                                                                                                    
   359 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   360 │       │       │       │        │       │               │       │        Retrieve prediction and target data for a given run from the Zarr store.                                                                                                                                                          
   361 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   362 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   363 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   364 │       │       │       │        │       │               │       │        cfg :                                                                                                                                                                                                                             
   365 │       │       │       │        │       │               │       │            Configuration dictionary containing all information for the evaluation.                                                                                                                                                       
   366 │       │       │       │        │       │               │       │        results_dir : Path                                                                                                                                                                                                                
   367 │       │       │       │        │       │               │       │            Directory where the inference results are stored. Expected scheme `<results_base_dir>/<run_id>`.                                                                                                                              
   368 │       │       │       │        │       │               │       │        stream :                                                                                                                                                                                                                          
   369 │       │       │       │        │       │               │       │            Stream name to retrieve data for.                                                                                                                                                                                             
   370 │       │       │       │        │       │               │       │        region :                                                                                                                                                                                                                          
   371 │       │       │       │        │       │               │       │            Region name to retrieve data for. Possible values: "global", "shem", "nhem", "tropics"                                                                                                                                        
   372 │       │       │       │        │       │               │       │        samples :                                                                                                                                                                                                                         
   373 │       │       │       │        │       │               │       │            List of sample indices to retrieve. If None, all samples are retrieved.                                                                                                                                                       
   374 │       │       │       │        │       │               │       │        fsteps :                                                                                                                                                                                                                          
   375 │       │       │       │        │       │               │       │            List of forecast steps to retrieve. If None, all forecast steps are retrieved.                                                                                                                                                
   376 │       │       │       │        │       │               │       │        channels :                                                                                                                                                                                                                        
   377 │       │       │       │        │       │               │       │            List of channel names to retrieve. If None, all channels are retrieved.                                                                                                                                                       
   378 │       │       │       │        │       │               │       │        return_counts :                                                                                                                                                                                                                   
   379 │       │       │       │        │       │               │       │            If True, also return the number of points per sample.                                                                                                                                                                         
   380 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   381 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   382 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   383 │       │       │       │        │       │               │       │        ReaderOutput                                                                                                                                                                                                                      
   384 │       │       │       │        │       │               │       │            A dataclass containing:                                                                                                                                                                                                       
   385 │       │       │       │        │       │               │       │            - target: Dictionary of xarray DataArrays for targets, indexed by forecast step.                                                                                                                                              
   386 │       │       │       │        │       │               │       │            - prediction: Dictionary of xarray DataArrays for predictions, indexed by forecast step.                                                                                                                                      
   387 │       │       │       │        │       │               │       │            - points_per_sample: xarray DataArray containing the number of points per sample, if `return_counts` is True.                                                                                                                 
   388 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   389 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   390 │       │       │       │        │       │               │       │        bbox = RegionBoundingBox.from_region_name(region)                                                                                                                                                                                 
   391 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   392 │       │       │       │        │       │               │       │        with ZarrIO(self.fname_zarr) as zio:                                                                                                                                                                                              
   393 │       │       │       │        │       │               │       │            stream_cfg = self.get_stream(stream)                                                                                                                                                                                          
   394 │       │       │       │        │       │               │       │            all_channels = self.get_channels(stream)                                                                                                                                                                                      
   395 │       │       │       │        │       │               │       │            _logger.info(f"RUN {self.run_id}: Processing stream {stream}...")                                                                                                                                                             
   396 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   397 │       │       │       │        │       │               │       │            fsteps = self.get_forecast_steps() if fsteps is None else fsteps                                                                                                                                                              
   398 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   399 │       │       │       │        │       │               │       │            # TODO: Avoid conversion of fsteps and sample to integers (as obtained from the ZarrIO)                                                                                                                                       
   400 │       │       │       │        │       │               │       │            fsteps = sorted([int(fstep) for fstep in fsteps])                                                                                                                                                                             
   401 │       │       │       │        │       │               │       │            samples = sorted(                                                                                                                                                                                                             
   402 │       │       │       │        │       │               │       │                [int(sample) for sample in self.get_samples()]                                                                                                                                                                            
   403 │       │       │       │        │       │               │       │                if samples is None                                                                                                                                                                                                        
   404 │       │       │       │        │       │               │       │                else samples                                                                                                                                                                                                              
   405 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   406 │       │       │       │        │       │               │       │            channels = channels or stream_cfg.get("channels", all_channels)                                                                                                                                                               
   407 │       │       │       │        │       │               │       │            channels = to_list(channels)                                                                                                                                                                                                  
   408 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   409 │       │       │       │        │       │               │       │            dc = DeriveChannels(                                                                                                                                                                                                          
   410 │       │       │       │        │       │               │       │                all_channels,                                                                                                                                                                                                             
   411 │       │       │       │        │       │               │       │                channels,                                                                                                                                                                                                                 
   412 │       │       │       │        │       │               │       │                stream_cfg,                                                                                                                                                                                                               
   413 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   414 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   415 │       │       │       │        │       │               │       │            da_tars, da_preds = [], []                                                                                                                                                                                                    
   416 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   417 │       │       │       │        │       │               │       │            if return_counts:                                                                                                                                                                                                             
   418 │       │       │       │        │       │               │       │                points_per_sample = xr.DataArray(                                                                                                                                                                                         
   419 │       │       │       │        │       │               │       │                    np.full((len(fsteps), len(samples)), np.nan),                                                                                                                                                                         
   420 │       │       │       │        │       │               │       │                    coords={"forecast_step": fsteps, "sample": samples},                                                                                                                                                                  
   421 │       │       │       │        │       │               │       │                    dims=("forecast_step", "sample"),                                                                                                                                                                                     
   422 │       │       │       │        │       │               │       │                    name=f"points_per_sample_{stream}",                                                                                                                                                                                   
   423 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   424 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   425 │       │       │       │        │       │               │       │                points_per_sample = None                                                                                                                                                                                                  
   426 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   427 │       │       │       │        │       │               │       │            fsteps_final = []                                                                                                                                                                                                             
   428 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   429 │       │       │       │        │       │               │       │            for fstep in fsteps:                                                                                                                                                                                                          
   430 │       │       │       │        │       │               │       │                _logger.info(                                                                                                                                                                                                             
   431 │       │       │       │        │       │               │       │                    f"RUN {self.run_id} - {stream}: Processing fstep {fstep}..."                                                                                                                                                          
   432 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   433 │       │       │       │        │       │               │       │                da_tars_fs, da_preds_fs = [], []                                                                                                                                                                                          
   434 │       │       │       │        │       │               │       │                pps = []                                                                                                                                                                                                                  
   435 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   436 │       │       │       │        │       │               │       │                for sample in tqdm(                                                                                                                                                                                                       
   437 │       │       │       │        │       │               │       │                    samples, desc=f"Processing {self.run_id} - {stream} - {fstep}"                                                                                                                                                        
   438 │       │       │       │        │       │               │       │                ):                                                                                                                                                                                                                        
   439 │       │       │       │        │       │               │       │                    out = zio.get_data(sample, stream, fstep)                                                                                                                                                                             
   440 │       │       │       │        │       │               │       │                    target, pred = out.target.as_xarray(), out.prediction.as_xarray()                                                                                                                                                     
   441 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   442 │       │       │       │        │       │               │       │                    if region != "global":                                                                                                                                                                                                
   443 │       │       │       │        │       │               │       │                        _logger.debug(                                                                                                                                                                                                    
   444 │       │       │       │        │       │               │       │                            f"Applying bounding box mask for region '{region}' to targets and predictions..."                                                                                                                             
   445 │       │       │       │        │       │               │       │                        )                                                                                                                                                                                                                 
   446 │       │       │       │        │       │               │       │                        target = bbox.apply_mask(target)                                                                                                                                                                                  
   447 │       │       │       │        │       │               │       │                        pred = bbox.apply_mask(pred)                                                                                                                                                                                      
   448 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   449 │       │       │       │        │       │               │       │                    npoints = len(target.ipoint)                                                                                                                                                                                          
   450 │       │       │       │        │       │               │       │                    if npoints == 0:                                                                                                                                                                                                      
   451 │       │       │       │        │       │               │       │                        _logger.info(                                                                                                                                                                                                     
   452 │       │       │       │        │       │               │       │                            f"Skipping {stream} sample {sample} forecast step: {fstep}. Dataset is empty."                                                                                                                                
   453 │       │       │       │        │       │               │       │                        )                                                                                                                                                                                                                 
   454 │       │       │       │        │       │               │       │                        continue                                                                                                                                                                                                          
   455 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   456 │       │       │       │        │       │               │       │                    da_tars_fs.append(target.squeeze())                                                                                                                                                                                   
   457 │       │       │       │        │       │               │       │                    da_preds_fs.append(pred.squeeze())                                                                                                                                                                                    
   458 │       │       │       │        │       │               │       │                    pps.append(npoints)                                                                                                                                                                                                   
   459 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   460 │       │       │       │        │       │               │       │                if len(da_tars_fs) > 0:                                                                                                                                                                                                   
   461 │       │       │       │        │       │               │       │                    fsteps_final.append(fstep)                                                                                                                                                                                            
   462 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   463 │       │       │       │        │       │               │       │                _logger.debug(                                                                                                                                                                                                            
   464 │       │       │       │        │       │               │       │                    f"Concatenating targets and predictions for stream {stream}, forecast_step {fstep}..."                                                                                                                                
   465 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   466 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   467 │       │       │       │        │       │               │       │                if da_tars_fs:                                                                                                                                                                                                            
   468 │       │       │       │        │       │               │       │                    da_tars_fs = xr.concat(da_tars_fs, dim="ipoint")                                                                                                                                                                      
   469 │       │       │       │        │       │               │       │                    da_preds_fs = xr.concat(da_preds_fs, dim="ipoint")                                                                                                                                                                    
   470 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   471 │       │       │       │        │       │               │       │                    if set(channels) != set(all_channels):                                                                                                                                                                                
   472 │       │       │       │        │       │               │       │                        _logger.debug(                                                                                                                                                                                                    
   473 │       │       │       │        │       │               │       │                            f"Restricting targets and predictions to channels {channels} for stream {stream}..."                                                                                                                          
   474 │       │       │       │        │       │               │       │                        )                                                                                                                                                                                                                 
   475 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   476 │       │       │       │        │       │               │       │                        da_tars_fs, da_preds_fs, channels = dc.get_derived_channels(                                                                                                                                                      
   477 │       │       │       │        │       │               │       │                            da_tars_fs, da_preds_fs                                                                                                                                                                                       
   478 │       │       │       │        │       │               │       │                        )                                                                                                                                                                                                                 
   479 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   480 │       │       │       │        │       │               │       │                        da_tars_fs = da_tars_fs.sel(channel=channels)                                                                                                                                                                     
   481 │       │       │       │        │       │               │       │                        da_preds_fs = da_preds_fs.sel(channel=channels)                                                                                                                                                                   
   482 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   483 │       │       │       │        │       │               │       │                    da_tars.append(da_tars_fs)                                                                                                                                                                                            
   484 │       │       │       │        │       │               │       │                    da_preds.append(da_preds_fs)                                                                                                                                                                                          
   485 │       │       │       │        │       │               │       │                if return_counts:                                                                                                                                                                                                         
   486 │       │       │       │        │       │               │       │                    points_per_sample.loc[{"forecast_step": fstep}] = np.array(pps)                                                                                                                                                       
   487 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   488 │       │       │       │        │       │               │       │            # Safer than a list                                                                                                                                                                                                           
   489 │       │       │       │        │       │               │       │            da_tars = {                                                                                                                                                                                                                   
   490 │       │       │       │        │       │               │       │                fstep: da for fstep, da in zip(fsteps_final, da_tars, strict=True)                                                                                                                                                        
   491 │       │       │       │        │       │               │       │            }                                                                                                                                                                                                                             
   492 │       │       │       │        │       │               │       │            da_preds = {                                                                                                                                                                                                                  
   493 │       │       │       │        │       │               │       │                fstep: da for fstep, da in zip(fsteps_final, da_preds, strict=True)                                                                                                                                                       
   494 │       │       │       │        │       │               │       │            }                                                                                                                                                                                                                             
   495 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   496 │       │       │       │        │       │               │       │            return ReaderOutput(                                                                                                                                                                                                          
   497 │       │       │       │        │       │               │       │                target=da_tars, prediction=da_preds, points_per_sample=points_per_sample                                                                                                                                                  
   498 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   499 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   500 │       │       │       │        │       │               │       │    ######## reader utils ########                                                                                                                                                                                                        
   501 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   502 │       │       │       │        │       │               │       │    def get_samples(self) -> set[int]:                                                                                                                                                                                                    
   503 │       │       │       │        │       │               │       │        with ZarrIO(self.fname_zarr) as zio:                                                                                                                                                                                              
   504 │       │       │       │        │       │               │       │            return set(int(s) for s in zio.samples)                                                                                                                                                                                       
   505 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   506 │       │       │       │        │       │               │       │    def get_forecast_steps(self) -> set[int]:                                                                                                                                                                                             
   507 │       │       │       │        │       │               │       │        with ZarrIO(self.fname_zarr) as zio:                                                                                                                                                                                              
   508 │       │       │       │        │       │               │       │            return set(int(f) for f in zio.forecast_steps)                                                                                                                                                                                
   509 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   510 │       │       │       │        │       │               │       │    # TODO: get this from config                                                                                                                                                                                                          
   511 │       │       │       │        │       │               │       │    def get_channels(self, stream: str) -> list[str]:                                                                                                                                                                                     
   512 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   513 │       │       │       │        │       │               │       │        Peek the channels of a target stream.                                                                                                                                                                                             
   514 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   515 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   516 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   517 │       │       │       │        │       │               │       │        stream :                                                                                                                                                                                                                          
   518 │       │       │       │        │       │               │       │            The name of the tar stream to peek.                                                                                                                                                                                           
   519 │       │       │       │        │       │               │       │        fstep :                                                                                                                                                                                                                           
   520 │       │       │       │        │       │               │       │            The forecast step to peek. Default is 0.                                                                                                                                                                                      
   521 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   522 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   523 │       │       │       │        │       │               │       │        channels :                                                                                                                                                                                                                        
   524 │       │       │       │        │       │               │       │            A list of channel names in the tar stream.                                                                                                                                                                                    
   525 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   526 │       │       │       │        │       │               │       │        with ZarrIO(self.fname_zarr) as zio:                                                                                                                                                                                              
   527 │       │       │       │        │       │               │       │            dummy_out = zio.get_data(                                                                                                                                                                                                     
   528 │       │       │       │        │       │               │       │                list(self.get_samples())[0], stream, list(self.get_forecast_steps())[0]                                                                                                                                                   
   529 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   530 │       │       │       │        │       │               │       │            channels = dummy_out.target.channels                                                                                                                                                                                          
   531 │       │       │       │        │       │               │       │            _logger.debug(f"Peeked channels for stream {stream}: {channels}")                                                                                                                                                             
   532 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   533 │       │       │       │        │       │               │       │        return channels                                                                                                                                                                                                                   
   534 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   535 │       │       │       │        │       │               │       │    def get_inference_stream_attr(self, stream_name: str, key: str, default=None):                                                                                                                                                        
   536 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   537 │       │       │       │        │       │               │       │        Get the value of a key for a specific stream from the a model config.                                                                                                                                                             
   538 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   539 │       │       │       │        │       │               │       │        Parameters:                                                                                                                                                                                                                       
   540 │       │       │       │        │       │               │       │        ------------                                                                                                                                                                                                                      
   541 │       │       │       │        │       │               │       │            config: dict                                                                                                                                                                                                                  
   542 │       │       │       │        │       │               │       │                The full configuration dictionary.                                                                                                                                                                                        
   543 │       │       │       │        │       │               │       │            stream_name: str                                                                                                                                                                                                              
   544 │       │       │       │        │       │               │       │                The name of the stream (e.g. 'ERA5').                                                                                                                                                                                     
   545 │       │       │       │        │       │               │       │            key: str                                                                                                                                                                                                                      
   546 │       │       │       │        │       │               │       │                The key to look up (e.g. 'tokenize_spacetime').                                                                                                                                                                           
   547 │       │       │       │        │       │               │       │            default: Optional                                                                                                                                                                                                             
   548 │       │       │       │        │       │               │       │                Value to return if not found (default: None).                                                                                                                                                                             
   549 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   550 │       │       │       │        │       │               │       │        Returns:                                                                                                                                                                                                                          
   551 │       │       │       │        │       │               │       │            The parameter value if found, otherwise the default.                                                                                                                                                                          
   552 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   553 │       │       │       │        │       │               │       │        for stream in self.inference_cfg.get("streams", []):                                                                                                                                                                              
   554 │       │       │       │        │       │               │       │            if stream.get("name") == stream_name:                                                                                                                                                                                         
   555 │       │       │       │        │       │               │       │                return stream.get(key, default)                                                                                                                                                                                           
   556 │       │       │       │        │       │               │       │        return default                                                                                                                                                                                                                    
   557 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
╶──────┼───────┼───────┼───────┼────────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │       │        │       │               │       │function summary for /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/io_reader.py                                                                                              
   274 │       │       │       │        │       │               │       │WeatherGenReader.__init__                                                                                                                                                                                                                 
   324 │       │       │   1%  │        │       │               │       │WeatherGenReader.get_inference_config                                                                                                                                                                                                     
   502 │       │       │       │        │       │               │       │WeatherGenReader.get_samples                                                                                                                                                                                                              
   506 │       │       │       │        │       │               │       │WeatherGenReader.get_forecast_steps                                                                                                                                                                                                       
   511 │       │       │       │        │       │               │       │WeatherGenReader.get_channels                                                                                                                                                                                                             
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
Top PEAK memory consumption, by line:
(1)    16:    30 MB                                                                                                                                                                                                                                                                                                 
                                                                       /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/score.py: % of time =   7.61% (17.983s) out of 4m:56.410s.                                                                       
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/score.py                                                                                                                       
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │# (C) Copyright 2025 WeatherGenerator contributors.                                                                                                                                                                                       
     2 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     3 │       │       │       │        │       │               │       │# This software is licensed under the terms of the Apache Licence Version 2.0                                                                                                                                                             
     4 │       │       │       │        │       │               │       │# which can be obtained at http://www.apache.org/licenses/LICENSE-2.0.                                                                                                                                                                    
     5 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     6 │       │       │       │        │       │               │       │# In applying this licence, ECMWF does not waive the privileges and immunities                                                                                                                                                            
     7 │       │       │       │        │       │               │       │# granted to it by virtue of its status as an intergovernmental organisation                                                                                                                                                              
     8 │       │       │       │        │       │               │       │# nor does it submit to any jurisdiction.                                                                                                                                                                                                 
     9 │       │       │       │        │       │               │       │import inspect                                                                                                                                                                                                                            
    10 │       │       │       │        │       │               │       │import logging                                                                                                                                                                                                                            
    11 │       │       │       │        │       │               │       │from dataclasses import dataclass                                                                                                                                                                                                         
    12 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    13 │       │       │       │        │       │               │       │import dask.array as da                                                                                                                                                                                                                   
    14 │       │       │       │        │       │               │       │import numpy as np                                                                                                                                                                                                                        
    15 │       │       │       │        │       │               │       │import pandas as pd                                                                                                                                                                                                                       
    16 │       │       │       │        │       │               │       │import xarray as xr                                                                                                                                                                                                                       
    17 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    18 │       │       │       │        │       │               │       │from weathergen.evaluate.score_utils import to_list                                                                                                                                                                                       
    19 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    20 │       │       │       │        │       │               │       │# from common.io import MockIO                                                                                                                                                                                                            
    21 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    22 │       │       │       │        │       │               │       │_logger = logging.getLogger(__name__)                                                                                                                                                                                                     
    23 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    24 │       │       │       │        │       │               │       │try:                                                                                                                                                                                                                                      
    25 │       │    1% │   6%  │ 100%   │   20M │▁▁   5%        │       │    import xskillscore                                                                                                                                                                                                                    
    26 │       │       │       │        │       │               │       │    from xhistogram.xarray import histogram                                                                                                                                                                                               
    27 │       │       │       │        │       │               │       │except Exception:                                                                                                                                                                                                                         
    28 │       │       │       │        │       │               │       │    _logger.warning(                                                                                                                                                                                                                      
    29 │       │       │       │        │       │               │       │        "Could not import xskillscore and xhistogram. Thus, CRPS and "                                                                                                                                                                    
    30 │       │       │       │        │       │               │       │        + "rank histogram-calculations are not supported."                                                                                                                                                                                
    31 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
    32 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    33 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    34 │       │       │       │        │       │               │       │# helper function to calculate skill score                                                                                                                                                                                                
    35 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    36 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    37 │       │       │       │        │       │               │       │def _get_skill_score(                                                                                                                                                                                                                     
    38 │       │       │       │        │       │               │       │    score_fcst: xr.DataArray, score_ref: xr.DataArray, score_perf: float                                                                                                                                                                  
    39 │       │       │       │        │       │               │       │) -> xr.DataArray:                                                                                                                                                                                                                        
    40 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    41 │       │       │       │        │       │               │       │    Calculate the skill score of a forecast data array w.r.t. a reference and a perfect score.                                                                                                                                            
    42 │       │       │       │        │       │               │       │    Definition follows Wilks, Statistical Methods in the Atmospheric Sciences (2006), Chapter 7.1.4, Equation 7.4                                                                                                                         
    43 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    44 │       │       │       │        │       │               │       │    Parameters                                                                                                                                                                                                                            
    45 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
    46 │       │       │       │        │       │               │       │    score_fcst : xr.DataArray                                                                                                                                                                                                             
    47 │       │       │       │        │       │               │       │        Forecast score data array                                                                                                                                                                                                         
    48 │       │       │       │        │       │               │       │    score_ref : xr.DataArray                                                                                                                                                                                                              
    49 │       │       │       │        │       │               │       │        Score data array of a reference forecast, e.g. a climatological mean                                                                                                                                                              
    50 │       │       │       │        │       │               │       │    score_perf : float                                                                                                                                                                                                                    
    51 │       │       │       │        │       │               │       │        Score data array of a perfect forecast, e.g. 0 for the RMSE-score                                                                                                                                                                 
    52 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    53 │       │       │       │        │       │               │       │    Returns                                                                                                                                                                                                                               
    54 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
    55 │       │       │       │        │       │               │       │    skiil_score : xr.DataArray                                                                                                                                                                                                            
    56 │       │       │       │        │       │               │       │        Skill score data array                                                                                                                                                                                                            
    57 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    58 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    59 │       │       │       │        │       │               │       │    skill_score = (score_fcst - score_ref) / (score_perf - score_ref)                                                                                                                                                                     
    60 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    61 │       │       │       │        │       │               │       │    return skill_score                                                                                                                                                                                                                    
    62 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    63 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    64 │       │       │       │        │       │               │       │@dataclass(frozen=True)                                                                                                                                                                                                                   
    65 │       │       │       │        │       │               │       │class VerifiedData:                                                                                                                                                                                                                       
    66 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    67 │       │       │       │        │       │               │       │    # Used to ensure that the prediction and ground truth data are compatible,                                                                                                                                                            
    68 │       │       │       │        │       │               │       │    # i.e. dimensions, broadcastability.                                                                                                                                                                                                  
    69 │       │       │       │        │       │               │       │    # This is meant to ensure that the data can be used for score calculations.                                                                                                                                                           
    70 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    71 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    72 │       │       │       │        │       │               │       │    prediction: xr.DataArray                                                                                                                                                                                                              
    73 │       │       │       │        │       │               │       │    ground_truth: xr.DataArray                                                                                                                                                                                                            
    74 │       │       │       │        │       │               │       │    prediction_next: xr.DataArray                                                                                                                                                                                                         
    75 │       │       │       │        │       │               │       │    ground_truth_next: xr.DataArray                                                                                                                                                                                                       
    76 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    77 │       │       │       │        │       │               │       │    def __post_init__(self):                                                                                                                                                                                                              
    78 │       │       │       │        │       │               │       │        # Perform checks on initialization                                                                                                                                                                                                
    79 │       │       │       │        │       │               │       │        self._validate_dimensions()                                                                                                                                                                                                       
    80 │       │       │       │        │       │               │       │        self._validate_broadcastability()                                                                                                                                                                                                 
    81 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    82 │       │       │       │        │       │               │       │    # TODO: add checks for prediction_next, ground_truth_next                                                                                                                                                                             
    83 │       │       │       │        │       │               │       │    def _validate_dimensions(self):                                                                                                                                                                                                       
    84 │       │       │       │        │       │               │       │        # Ensure all dimensions in truth are in forecast (or equal)                                                                                                                                                                       
    85 │       │       │       │        │       │               │       │        missing_dims = set(self.ground_truth.dims) - set(self.prediction.dims)                                                                                                                                                            
    86 │       │       │       │        │       │               │       │        if missing_dims:                                                                                                                                                                                                                  
    87 │       │       │       │        │       │               │       │            raise ValueError(                                                                                                                                                                                                             
    88 │       │       │       │        │       │               │       │                f"Truth data has extra dimensions not found in forecast: {missing_dims}"                                                                                                                                                  
    89 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
    90 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    91 │       │       │       │        │       │               │       │    # TODO: add checks for prediction_next, ground_truth_next                                                                                                                                                                             
    92 │       │       │       │        │       │               │       │    def _validate_broadcastability(self):                                                                                                                                                                                                 
    93 │       │       │       │        │       │               │       │        try:                                                                                                                                                                                                                              
    94 │       │       │       │        │       │               │       │            # Attempt broadcast                                                                                                                                                                                                           
    95 │       │       │       │        │       │               │       │            xr.broadcast(self.prediction, self.ground_truth)                                                                                                                                                                              
    96 │       │       │       │        │       │               │       │        except ValueError as e:                                                                                                                                                                                                           
    97 │       │       │       │        │       │               │       │            raise ValueError(f"Forecast and truth are not broadcastable: {e}") from e                                                                                                                                                     
    98 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    99 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   100 │       │       │       │        │       │               │       │def get_score(                                                                                                                                                                                                                            
   101 │       │       │       │        │       │               │       │    data: VerifiedData,                                                                                                                                                                                                                   
   102 │       │       │       │        │       │               │       │    score_name: str,                                                                                                                                                                                                                      
   103 │       │       │       │        │       │               │       │    agg_dims: str | list[str] = "all",                                                                                                                                                                                                    
   104 │       │       │       │        │       │               │       │    group_by_coord: str | None = None,                                                                                                                                                                                                    
   105 │       │       │       │        │       │               │       │    ens_dim: str = "ens",                                                                                                                                                                                                                 
   106 │       │       │       │        │       │               │       │    compute: bool = False,                                                                                                                                                                                                                
   107 │       │       │       │        │       │               │       │    **kwargs,                                                                                                                                                                                                                             
   108 │       │       │       │        │       │               │       │) -> xr.DataArray:                                                                                                                                                                                                                        
   109 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   110 │       │       │       │        │       │               │       │    Get the score for the given data and score name.                                                                                                                                                                                      
   111 │       │       │       │        │       │               │       │    Note that the scores are aggregated over all dimensions of the prediction data by default.                                                                                                                                            
   112 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   113 │       │       │       │        │       │               │       │    Parameters                                                                                                                                                                                                                            
   114 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
   115 │       │       │       │        │       │               │       │    data : VerifiedData                                                                                                                                                                                                                   
   116 │       │       │       │        │       │               │       │        VerifiedData object containing prediction and ground truth data.                                                                                                                                                                  
   117 │       │       │       │        │       │               │       │    score_name : str                                                                                                                                                                                                                      
   118 │       │       │       │        │       │               │       │        Name of the score to calculate.                                                                                                                                                                                                   
   119 │       │       │       │        │       │               │       │    agg_dims : str | List[str]                                                                                                                                                                                                            
   120 │       │       │       │        │       │               │       │        List of dimension names over which the score will be aggregated (most often averaged).                                                                                                                                            
   121 │       │       │       │        │       │               │       │        If set to 'all', aggregation will be performed over all dimensions of the forecast data.                                                                                                                                          
   122 │       │       │       │        │       │               │       │    ens_dim : str                                                                                                                                                                                                                         
   123 │       │       │       │        │       │               │       │        Name of the ensemble dimension in the forecast data. Only used for probabilistic scores.                                                                                                                                          
   124 │       │       │       │        │       │               │       │    compute : bool                                                                                                                                                                                                                        
   125 │       │       │       │        │       │               │       │        If True, the score will be computed immediately. If False, the score will be returned                                                                                                                                             
   126 │       │       │       │        │       │               │       │        as a lazy xarray DataArray, which allows for efficient graph construction and execution                                                                                                                                           
   127 │       │       │       │        │       │               │       │    kwargs : dict                                                                                                                                                                                                                         
   128 │       │       │       │        │       │               │       │        Additional keyword arguments to pass to the score function.                                                                                                                                                                       
   129 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   130 │       │       │       │        │       │               │       │    Returns                                                                                                                                                                                                                               
   131 │       │       │       │        │       │               │       │    -------                                                                                                                                                                                                                               
   132 │       │       │       │        │       │               │       │    xr.DataArray                                                                                                                                                                                                                          
   133 │       │       │       │        │       │               │       │        Calculated score as an xarray DataArray.                                                                                                                                                                                          
   134 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   135 │       │       │       │        │       │               │       │    sc = Scores(agg_dims=agg_dims, ens_dim=ens_dim)                                                                                                                                                                                       
   136 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   137 │       │       │       │        │       │               │       │    score_data = sc.get_score(data, score_name, group_by_coord, **kwargs)                                                                                                                                                                 
   138 │       │       │       │        │       │               │       │    if compute:                                                                                                                                                                                                                           
   139 │       │       │       │        │       │               │       │        # If compute is True, compute the score immediately                                                                                                                                                                               
   140 │       │       │       │        │       │               │       │        return score_data.compute()                                                                                                                                                                                                       
   141 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   142 │       │       │       │        │       │               │       │    return score_data                                                                                                                                                                                                                     
   143 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   144 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   145 │       │       │       │        │       │               │       │# scores class                                                                                                                                                                                                                            
   146 │       │       │       │        │       │               │       │class Scores:                                                                                                                                                                                                                             
   147 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   148 │       │       │       │        │       │               │       │    Class to calculate scores and skill scores.                                                                                                                                                                                           
   149 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   150 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   151 │       │       │       │        │       │               │       │    def __init__(                                                                                                                                                                                                                         
   152 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   153 │       │       │       │        │       │               │       │        agg_dims: str | list[str] = "all",                                                                                                                                                                                                
   154 │       │       │       │        │       │               │       │        ens_dim: str = "ens",                                                                                                                                                                                                             
   155 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   156 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   157 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   158 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   159 │       │       │       │        │       │               │       │        agg_dims : str | List[str]                                                                                                                                                                                                        
   160 │       │       │       │        │       │               │       │            List of dimension names over which the score will be aggregated (most often averaged).                                                                                                                                        
   161 │       │       │       │        │       │               │       │            If set to 'all', aggregation will be performed over all dimensions of the forecast data.                                                                                                                                      
   162 │       │       │       │        │       │               │       │        ens_dim: str                                                                                                                                                                                                                      
   163 │       │       │       │        │       │               │       │            Name of the ensemble dimension in the forecast data. Only used for probablistic scores.                                                                                                                                       
   164 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   165 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   166 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   167 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   168 │       │       │       │        │       │               │       │        self._agg_dims_in = self._validate_agg_dims(agg_dims)                                                                                                                                                                             
   169 │       │       │       │        │       │               │       │        self._ens_dim = self._validate_ens_dim(ens_dim)                                                                                                                                                                                   
   170 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   171 │       │       │       │        │       │               │       │        self.det_metrics_dict = {                                                                                                                                                                                                         
   172 │       │       │       │        │       │               │       │            "ets": self.calc_ets,                                                                                                                                                                                                         
   173 │       │       │       │        │       │               │       │            "pss": self.calc_pss,                                                                                                                                                                                                         
   174 │       │       │       │        │       │               │       │            "fbi": self.calc_fbi,                                                                                                                                                                                                         
   175 │       │       │       │        │       │               │       │            "mae": self.calc_mae,                                                                                                                                                                                                         
   176 │       │       │       │        │       │               │       │            "l1": self.calc_l1,                                                                                                                                                                                                           
   177 │       │       │       │        │       │               │       │            "l2": self.calc_l2,                                                                                                                                                                                                           
   178 │       │       │       │        │       │               │       │            "mse": self.calc_mse,                                                                                                                                                                                                         
   179 │       │       │       │        │       │               │       │            "rmse": self.calc_rmse,                                                                                                                                                                                                       
   180 │       │       │       │        │       │               │       │            "bias": self.calc_bias,                                                                                                                                                                                                       
   181 │       │       │       │        │       │               │       │            "acc": self.calc_acc,                                                                                                                                                                                                         
   182 │       │       │       │        │       │               │       │            "froct": self.calc_froct,                                                                                                                                                                                                     
   183 │       │       │       │        │       │               │       │            "troct": self.calc_troct,                                                                                                                                                                                                     
   184 │       │       │       │        │       │               │       │            "grad_amplitude": self.calc_spatial_variability,                                                                                                                                                                              
   185 │       │       │       │        │       │               │       │            "psnr": self.calc_psnr,                                                                                                                                                                                                       
   186 │       │       │       │        │       │               │       │            "seeps": self.calc_seeps,                                                                                                                                                                                                     
   187 │       │       │       │        │       │               │       │        }                                                                                                                                                                                                                                 
   188 │       │       │       │        │       │               │       │        self.prob_metrics_dict = {                                                                                                                                                                                                        
   189 │       │       │       │        │       │               │       │            "ssr": self.calc_ssr,                                                                                                                                                                                                         
   190 │       │       │       │        │       │               │       │            "crps": self.calc_crps,                                                                                                                                                                                                       
   191 │       │       │       │        │       │               │       │            "rank_histogram": self.calc_rank_histogram,                                                                                                                                                                                   
   192 │       │       │       │        │       │               │       │            "spread": self.calc_spread,                                                                                                                                                                                                   
   193 │       │       │       │        │       │               │       │        }                                                                                                                                                                                                                                 
   194 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   195 │       │       │       │        │       │               │       │    def get_score(                                                                                                                                                                                                                        
   196 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   197 │       │       │       │        │       │               │       │        data: VerifiedData,                                                                                                                                                                                                               
   198 │       │       │       │        │       │               │       │        score_name: str,                                                                                                                                                                                                                  
   199 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   200 │       │       │       │        │       │               │       │        compute: bool = False,                                                                                                                                                                                                            
   201 │       │       │       │        │       │               │       │        **kwargs,                                                                                                                                                                                                                         
   202 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   203 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   204 │       │       │       │        │       │               │       │        Calculate the score for the given data and score name.                                                                                                                                                                            
   205 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   206 │       │       │       │        │       │               │       │        If data is a dask array, the score will be calculated lazily.                                                                                                                                                                     
   207 │       │       │       │        │       │               │       │        This allows for efficient graph construction and execution when calculating several scores.                                                                                                                                       
   208 │       │       │       │        │       │               │       │        Example usage:                                                                                                                                                                                                                    
   209 │       │       │       │        │       │               │       │        >>> # Initialize Scores object with aggregation dimensions                                                                                                                                                                        
   210 │       │       │       │        │       │               │       │        >>> sc = Scores(agg_dims=["ipoints"])                                                                                                                                                                                             
   211 │       │       │       │        │       │               │       │        >>> # Collect list of scores for a given VerifiedData object                                                                                                                                                                      
   212 │       │       │       │        │       │               │       │        >>> score_list = [sc(data, score_name) for score_name in ["ets", "pss", "fbi"]]                                                                                                                                                   
   213 │       │       │       │        │       │               │       │        >>> combined_metrics = xr.concat(score_list, dim="score_name")                                                                                                                                                                    
   214 │       │       │       │        │       │               │       │        >>> combined_metrics["score_name"] = score_list                                                                                                                                                                                   
   215 │       │       │       │        │       │               │       │        >>> # Do the computation with a joint graph                                                                                                                                                                                       
   216 │       │       │       │        │       │               │       │        >>> combined_metrics = combined_metrics.compute()                                                                                                                                                                                 
   217 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   218 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   219 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   220 │       │       │       │        │       │               │       │        data : VerifiedData                                                                                                                                                                                                               
   221 │       │       │       │        │       │               │       │            VerifiedData object containing prediction and ground truth data.                                                                                                                                                              
   222 │       │       │       │        │       │               │       │        score_name : str                                                                                                                                                                                                                  
   223 │       │       │       │        │       │               │       │            Name of the score to calculate.                                                                                                                                                                                               
   224 │       │       │       │        │       │               │       │        compute : bool                                                                                                                                                                                                                    
   225 │       │       │       │        │       │               │       │            If True, the score will be computed immediately. If False, the score will be returned                                                                                                                                         
   226 │       │       │       │        │       │               │       │            as a lazy xarray DataArray, which allows for efficient graph construction and execution.                                                                                                                                      
   227 │       │       │       │        │       │               │       │        kwargs : dict                                                                                                                                                                                                                     
   228 │       │       │       │        │       │               │       │            Additional keyword arguments to pass to the score function.                                                                                                                                                                   
   229 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   230 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   231 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   232 │       │       │       │        │       │               │       │        xr.DataArray                                                                                                                                                                                                                      
   233 │       │       │       │        │       │               │       │            Calculated score as an xarray DataArray.                                                                                                                                                                                      
   234 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   235 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   236 │       │       │       │        │       │               │       │        if score_name in self.det_metrics_dict.keys():                                                                                                                                                                                    
   237 │       │       │       │        │       │               │       │            f = self.det_metrics_dict[score_name]                                                                                                                                                                                         
   238 │       │       │       │        │       │               │       │        elif score_name in self.prob_metrics_dict.keys():                                                                                                                                                                                 
   239 │       │       │       │        │       │               │       │            assert self.ens_dim in data.prediction.dims, (                                                                                                                                                                                
   240 │       │       │       │        │       │               │       │                f"Probablistic score {score_name} chosen, but ensemble dimension {self.ens_dim} not found in prediction data"                                                                                                             
   241 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   242 │       │       │       │        │       │               │       │            f = self.prob_metrics_dict[score_name]                                                                                                                                                                                        
   243 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   244 │       │       │       │        │       │               │       │            raise ValueError(                                                                                                                                                                                                             
   245 │       │       │       │        │       │               │       │                f"Unknown score chosen. Supported scores: {                                                                                                                                                                               
   246 │       │       │       │        │       │               │       │                    ', '.join(self.det_metrics_dict.keys())                                                                                                                                                                               
   247 │       │       │       │        │       │               │       │                    + ', '                                                                                                                                                                                                                
   248 │       │       │       │        │       │               │       │                    + ', '.join(self.prob_metrics_dict.keys())                                                                                                                                                                            
   249 │       │       │       │        │       │               │       │                }"                                                                                                                                                                                                                        
   250 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   251 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   252 │       │       │       │        │       │               │       │        if self._agg_dims_in == "all":                                                                                                                                                                                                    
   253 │       │       │       │        │       │               │       │            # Aggregate over all dimensions of the prediction data                                                                                                                                                                        
   254 │       │       │       │        │       │               │       │            self._agg_dims = list(data.prediction.dims)                                                                                                                                                                                   
   255 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   256 │       │       │       │        │       │               │       │            # Check if _agg_dims is in prediction data                                                                                                                                                                                    
   257 │       │       │       │        │       │               │       │            for dim in self._agg_dims_in:                                                                                                                                                                                                 
   258 │       │       │       │        │       │               │       │                if dim not in data.prediction.dims:                                                                                                                                                                                       
   259 │       │       │       │        │       │               │       │                    raise ValueError(                                                                                                                                                                                                     
   260 │       │       │       │        │       │               │       │                        f"Average dimension '{dim}' not found in prediction data dimensions: {data.prediction.dims}"                                                                                                                      
   261 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
   262 │       │       │       │        │       │               │       │            self._agg_dims = self._agg_dims_in                                                                                                                                                                                            
   263 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   264 │       │       │       │        │       │               │       │        arg_names: list[str] = inspect.getfullargspec(f).args[1:]                                                                                                                                                                         
   265 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   266 │       │       │       │        │       │               │       │        if score_name in ["froct", "troct"]:                                                                                                                                                                                              
   267 │       │       │       │        │       │               │       │            args = {                                                                                                                                                                                                                      
   268 │       │       │       │        │       │               │       │                "p": data.prediction,                                                                                                                                                                                                     
   269 │       │       │       │        │       │               │       │                "gt": data.ground_truth,                                                                                                                                                                                                  
   270 │       │       │       │        │       │               │       │                "p_next": data.prediction_next,                                                                                                                                                                                           
   271 │       │       │       │        │       │               │       │                "gt_next": data.ground_truth_next,                                                                                                                                                                                        
   272 │       │       │       │        │       │               │       │            }                                                                                                                                                                                                                             
   273 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   274 │       │       │       │        │       │               │       │            args = {"p": data.prediction, "gt": data.ground_truth}                                                                                                                                                                        
   275 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   276 │       │       │       │        │       │               │       │        # Add group_by_coord if provided                                                                                                                                                                                                  
   277 │       │       │       │        │       │               │       │        if group_by_coord is not None:                                                                                                                                                                                                    
   278 │       │       │       │        │       │               │       │            if self._validate_groupby_coord(data, group_by_coord):                                                                                                                                                                        
   279 │       │       │       │        │       │               │       │                args["group_by_coord"] = group_by_coord                                                                                                                                                                                   
   280 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   281 │       │       │       │        │       │               │       │        for an in arg_names:                                                                                                                                                                                                              
   282 │       │       │       │        │       │               │       │            if an in kwargs:                                                                                                                                                                                                              
   283 │       │       │       │        │       │               │       │                args[an] = kwargs[an]                                                                                                                                                                                                     
   284 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   285 │       │       │       │        │       │               │       │        # Call lazy evaluation function                                                                                                                                                                                                   
   286 │       │       │       │        │       │               │       │        result = f(**args)                                                                                                                                                                                                                
   287 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   288 │       │       │       │        │       │               │       │        if compute:                                                                                                                                                                                                                       
   289 │       │       │       │        │       │               │       │            return result.compute()                                                                                                                                                                                                       
   290 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   291 │       │       │       │        │       │               │       │            # Return lazy evaluation result                                                                                                                                                                                               
   292 │       │       │       │        │       │               │       │            return result                                                                                                                                                                                                                 
   293 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   294 │       │       │       │        │       │               │       │    def _validate_agg_dims(self, dims: str | list[str]) -> list[str] | str:                                                                                                                                                               
   295 │       │       │       │        │       │               │       │        if dims == "all":                                                                                                                                                                                                                 
   296 │       │       │       │        │       │               │       │            return dims                                                                                                                                                                                                                   
   297 │       │       │       │        │       │               │       │        if isinstance(dims, str):                                                                                                                                                                                                         
   298 │       │       │       │        │       │               │       │            return [dims]                                                                                                                                                                                                                 
   299 │       │       │       │        │       │               │       │        if isinstance(dims, list) and all(isinstance(d, str) for d in dims):                                                                                                                                                              
   300 │       │       │       │        │       │               │       │            return dims                                                                                                                                                                                                                   
   301 │       │       │       │        │       │               │       │        raise ValueError("agg_dims must be 'all', a string, or list of strings.")                                                                                                                                                         
   302 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   303 │       │       │       │        │       │               │       │    def _validate_ens_dim(self, dim: str) -> str:                                                                                                                                                                                         
   304 │       │       │       │        │       │               │       │        if not isinstance(dim, str):                                                                                                                                                                                                      
   305 │       │       │       │        │       │               │       │            raise ValueError("ens_dim must be a string.")                                                                                                                                                                                 
   306 │       │       │       │        │       │               │       │        return dim                                                                                                                                                                                                                        
   307 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   308 │       │       │       │        │       │               │       │    def _validate_groupby_coord(                                                                                                                                                                                                          
   309 │       │       │       │        │       │               │       │        self, data: VerifiedData, group_by_coord: str | None                                                                                                                                                                              
   310 │       │       │       │        │       │               │       │    ) -> bool:                                                                                                                                                                                                                            
   311 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   312 │       │       │       │        │       │               │       │        Check if the group_by_coord is present in both prediction and ground truth data and compatible.                                                                                                                                   
   313 │       │       │       │        │       │               │       │        Raises ValueError if conditions are not met.                                                                                                                                                                                      
   314 │       │       │       │        │       │               │       │        If group_by_coord does not have more than one unique value in the prediction data,                                                                                                                                                
   315 │       │       │       │        │       │               │       │        a warning is logged and the function returns False, indicating that grouping is not applicable.                                                                                                                                   
   316 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   317 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   318 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   319 │       │       │       │        │       │               │       │        data : VerifiedData                                                                                                                                                                                                               
   320 │       │       │       │        │       │               │       │            VerifiedData object containing prediction and ground truth data.                                                                                                                                                              
   321 │       │       │       │        │       │               │       │        group_by_coord : str                                                                                                                                                                                                              
   322 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   323 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   324 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   325 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   326 │       │       │       │        │       │               │       │        group_by_coord : bool                                                                                                                                                                                                             
   327 │       │       │       │        │       │               │       │            True if the group_by_coord is valid for grouping, False otherwise.                                                                                                                                                            
   328 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   329 │       │       │       │        │       │               │       │        p, gt = data.prediction, data.ground_truth                                                                                                                                                                                        
   330 │       │       │       │        │       │               │       │        if group_by_coord not in p.coords or group_by_coord not in gt.coords:                                                                                                                                                             
   331 │       │       │       │        │       │               │       │            raise ValueError(                                                                                                                                                                                                             
   332 │       │       │       │        │       │               │       │                f"Coordinate '{group_by_coord}' must be present in both prediction and ground truth data."                                                                                                                                
   333 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   334 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   335 │       │       │       │        │       │               │       │        # Check if the dims associated with the groupby_coord are compatible                                                                                                                                                              
   336 │       │       │       │        │       │               │       │        dims_p = set(p.coords[group_by_coord].dims)                                                                                                                                                                                       
   337 │       │       │       │        │       │               │       │        dims_gt = set(gt.coords[group_by_coord].dims)                                                                                                                                                                                     
   338 │       │       │       │        │       │               │       │        if dims_p != dims_gt:                                                                                                                                                                                                             
   339 │       │       │       │        │       │               │       │            raise ValueError(                                                                                                                                                                                                             
   340 │       │       │       │        │       │               │       │                f"Coordinate '{group_by_coord}' is associated with different dimensions: "                                                                                                                                                
   341 │       │       │       │        │       │               │       │                f"{dims_p} in prediction, {dims_gt} in ground truth."                                                                                                                                                                     
   342 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   343 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   344 │       │       │       │        │       │               │       │        if len(np.atleast_1d(p.coords[group_by_coord].values)) > 1:                                                                                                                                                                       
   345 │       │       │       │        │       │               │       │            return True                                                                                                                                                                                                                   
   346 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   347 │       │       │       │        │       │               │       │            _logger.warning(                                                                                                                                                                                                              
   348 │       │       │       │        │       │               │       │                f"Coordinate '{group_by_coord}' has only one unique value in prediction data. "                                                                                                                                           
   349 │       │       │       │        │       │               │       │                "It will not be used for grouping."                                                                                                                                                                                       
   350 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   351 │       │       │       │        │       │               │       │            return False                                                                                                                                                                                                                  
   352 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   353 │       │       │       │        │       │               │       │    def _sum(self, data: xr.DataArray) -> xr.DataArray:                                                                                                                                                                                   
   354 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   355 │       │       │       │        │       │               │       │        Sum data over aggregation dimensions.                                                                                                                                                                                             
   356 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   357 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   358 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   359 │       │       │       │        │       │               │       │        data : xr.DataArray                                                                                                                                                                                                               
   360 │       │       │       │        │       │               │       │            xarray DataArray to sum over aggregation dimensions                                                                                                                                                                           
   361 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   362 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   363 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   364 │       │       │       │        │       │               │       │        xr.DataArray                                                                                                                                                                                                                      
   365 │       │       │       │        │       │               │       │            Summed data                                                                                                                                                                                                                   
   366 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   367 │       │       │       │        │       │               │       │        return data.sum(dim=self._agg_dims)                                                                                                                                                                                               
   368 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   369 │       │       │       │        │       │               │       │    def _mean(self, data: xr.DataArray) -> xr.DataArray:                                                                                                                                                                                  
   370 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   371 │       │       │       │        │       │               │       │        Average data over aggregation dimensions.                                                                                                                                                                                         
   372 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   373 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   374 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   375 │       │       │       │        │       │               │       │        data : xr.DataArray                                                                                                                                                                                                               
   376 │       │       │       │        │       │               │       │            xarray DataArray to average over aggregation dimensions                                                                                                                                                                       
   377 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   378 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   379 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   380 │       │       │       │        │       │               │       │        xr.DataArray                                                                                                                                                                                                                      
   381 │       │       │       │        │       │               │       │            Averaged data                                                                                                                                                                                                                 
   382 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   383 │       │       │       │        │       │               │       │        return data.mean(dim=self._agg_dims)                                                                                                                                                                                              
   384 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   385 │       │       │       │        │       │               │       │    def get_2x2_event_counts(                                                                                                                                                                                                             
   386 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   387 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   388 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   389 │       │       │       │        │       │               │       │        thresh: float,                                                                                                                                                                                                                    
   390 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   391 │       │       │       │        │       │               │       │    ) -> tuple[xr.DataArray, xr.DataArray, xr.DataArray, xr.DataArray]:                                                                                                                                                                   
   392 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   393 │       │       │       │        │       │               │       │        Get counts of 2x2 contingency tables                                                                                                                                                                                              
   394 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   395 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
   396 │       │       │       │        │       │               │       │            p = p.groupby(group_by_coord)                                                                                                                                                                                                 
   397 │       │       │       │        │       │               │       │            gt = gt.groupby(group_by_coord)                                                                                                                                                                                               
   398 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   399 │       │       │       │        │       │               │       │        a = self._sum((p >= thresh) & (gt >= thresh))                                                                                                                                                                                     
   400 │       │       │       │        │       │               │       │        b = self._sum((p >= thresh) & (gt >= thresh))                                                                                                                                                                                     
   401 │       │       │       │        │       │               │       │        c = self._sum((p < thresh) & (gt >= thresh))                                                                                                                                                                                      
   402 │       │       │       │        │       │               │       │        d = self._sum((p < thresh) & (gt < thresh))                                                                                                                                                                                       
   403 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   404 │       │       │       │        │       │               │       │        return a, b, c, d                                                                                                                                                                                                                 
   405 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   406 │       │       │       │        │       │               │       │    ### Deterministic scores                                                                                                                                                                                                              
   407 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   408 │       │       │       │        │       │               │       │    def calc_ets(                                                                                                                                                                                                                         
   409 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   410 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   411 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   412 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   413 │       │       │       │        │       │               │       │        thresh: float = 0.1,                                                                                                                                                                                                              
   414 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   415 │       │       │       │        │       │               │       │        a, b, c, d = self.get_2x2_event_counts(p, gt, thresh, group_by_coord)                                                                                                                                                             
   416 │       │       │       │        │       │               │       │        n = a + b + c + d                                                                                                                                                                                                                 
   417 │       │       │       │        │       │               │       │        ar = (a + b) * (a + c) / n  # random reference forecast                                                                                                                                                                           
   418 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   419 │       │       │       │        │       │               │       │        denom = a + b + c - ar                                                                                                                                                                                                            
   420 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   421 │       │       │       │        │       │               │       │        ets = (a - ar) / denom                                                                                                                                                                                                            
   422 │       │       │       │        │       │               │       │        ets = ets.where(denom > 0, np.nan)                                                                                                                                                                                                
   423 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   424 │       │       │       │        │       │               │       │        return ets                                                                                                                                                                                                                        
   425 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   426 │       │       │       │        │       │               │       │    def calc_fbi(                                                                                                                                                                                                                         
   427 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   428 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   429 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   430 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   431 │       │       │       │        │       │               │       │        thresh: float = 0.1,                                                                                                                                                                                                              
   432 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   433 │       │       │       │        │       │               │       │        a, b, c, _ = self.get_2x2_event_counts(p, gt, thresh, group_by_coord)                                                                                                                                                             
   434 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   435 │       │       │       │        │       │               │       │        denom = a + c                                                                                                                                                                                                                     
   436 │       │       │       │        │       │               │       │        fbi = (a + b) / denom                                                                                                                                                                                                             
   437 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   438 │       │       │       │        │       │               │       │        fbi = fbi.where(denom > 0, np.nan)                                                                                                                                                                                                
   439 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   440 │       │       │       │        │       │               │       │        return fbi                                                                                                                                                                                                                        
   441 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   442 │       │       │       │        │       │               │       │    def calc_pss(                                                                                                                                                                                                                         
   443 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   444 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   445 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   446 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   447 │       │       │       │        │       │               │       │        thresh: float = 0.1,                                                                                                                                                                                                              
   448 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   449 │       │       │       │        │       │               │       │        a, b, c, d = self.get_2x2_event_counts(p, gt, thresh, group_by_coord)                                                                                                                                                             
   450 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   451 │       │       │       │        │       │               │       │        denom = (a + c) * (b + d)                                                                                                                                                                                                         
   452 │       │       │       │        │       │               │       │        pss = (a * d - b * c) / denom                                                                                                                                                                                                     
   453 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   454 │       │       │       │        │       │               │       │        pss = pss.where(denom > 0, np.nan)                                                                                                                                                                                                
   455 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   456 │       │       │       │        │       │               │       │        return pss                                                                                                                                                                                                                        
   457 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   458 │       │       │       │        │       │               │       │    def calc_l1(                                                                                                                                                                                                                          
   459 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   460 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   461 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   462 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   463 │       │       │       │        │       │               │       │        scale_dims: list | None = None,                                                                                                                                                                                                   
   464 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   465 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   466 │       │       │       │        │       │               │       │        Calculate the L1 error norm of forecast data w.r.t. reference data.                                                                                                                                                               
   467 │       │       │       │        │       │               │       │        Note that the L1 error norm is calculated as the sum of absolute differences.                                                                                                                                                     
   468 │       │       │       │        │       │               │       │        If scale_dims is not None, the L1 will scaled by the number of elements in the average dimensions.                                                                                                                                
   469 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   470 │       │       │       │        │       │               │       │        l1 = np.abs(p - gt)                                                                                                                                                                                                               
   471 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   472 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
   473 │       │       │       │        │       │               │       │            l1 = l1.groupby(group_by_coord)                                                                                                                                                                                               
   474 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   475 │       │       │       │        │       │               │       │        l1 = self._sum(l1)                                                                                                                                                                                                                
   476 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   477 │       │       │       │        │       │               │       │        if scale_dims:                                                                                                                                                                                                                    
   478 │       │       │       │        │       │               │       │            scale_dims = to_list(scale_dims)                                                                                                                                                                                              
   479 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   480 │       │       │       │        │       │               │       │            assert all([dim in p.dims for dim in scale_dims]), (                                                                                                                                                                          
   481 │       │       │       │        │       │               │       │                f"Provided scale dimensions {scale_dims} are not all present in the prediction data dimensions {p.dims}."                                                                                                                 
   482 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   483 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   484 │       │       │       │        │       │               │       │            len_dims = np.array([p.sizes[dim] for dim in scale_dims])                                                                                                                                                                     
   485 │       │       │       │        │       │               │       │            l1 /= np.prod(len_dims)                                                                                                                                                                                                       
   486 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   487 │       │       │       │        │       │               │       │        return l1                                                                                                                                                                                                                         
   488 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   489 │       │       │       │        │       │               │       │    def calc_l2(                                                                                                                                                                                                                          
   490 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   491 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   492 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   493 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   494 │       │       │       │        │       │               │       │        scale_dims: list | None = None,                                                                                                                                                                                                   
   495 │       │       │       │        │       │               │       │        squared_l2: bool = False,                                                                                                                                                                                                         
   496 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   497 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   498 │       │       │       │        │       │               │       │        Calculate the L2 error norm of forecast data w.r.t. reference data.                                                                                                                                                               
   499 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   500 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   501 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   502 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
   503 │       │       │       │        │       │               │       │            Forecast data array                                                                                                                                                                                                           
   504 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
   505 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
   506 │       │       │       │        │       │               │       │        group_by_coord: str                                                                                                                                                                                                               
   507 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   508 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the L2 score.                                                                                                                                                          
   509 │       │       │       │        │       │               │       │        scale_dims: list | None                                                                                                                                                                                                           
   510 │       │       │       │        │       │               │       │            List of dimensions over which the L2 score will be scaled.                                                                                                                                                                    
   511 │       │       │       │        │       │               │       │            If provided, the L2 score will be divided by the product of the sizes of these dimensions.                                                                                                                                    
   512 │       │       │       │        │       │               │       │        squared_l2: bool                                                                                                                                                                                                                  
   513 │       │       │       │        │       │               │       │            If True, the L2 score will be returned as the sum of squared differences.                                                                                                                                                     
   514 │       │       │       │        │       │               │       │            If False, the L2 score will be returned as the square root of the sum of squared differences.                                                                                                                                 
   515 │       │       │       │        │       │               │       │            Default is False, i.e. the L2 score is returned as the square root of the sum of squared differences.                                                                                                                         
   516 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   517 │       │       │       │        │       │               │       │        l2 = np.square(p - gt)                                                                                                                                                                                                            
   518 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   519 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
   520 │       │       │       │        │       │               │       │            l2 = l2.groupby(group_by_coord)                                                                                                                                                                                               
   521 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   522 │       │       │       │        │       │               │       │        l2 = self._sum(l2)                                                                                                                                                                                                                
   523 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   524 │       │       │       │        │       │               │       │        if not squared_l2:                                                                                                                                                                                                                
   525 │       │       │       │        │       │               │       │            l2 = np.sqrt(l2)                                                                                                                                                                                                              
   526 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   527 │       │       │       │        │       │               │       │        if scale_dims:                                                                                                                                                                                                                    
   528 │       │       │       │        │       │               │       │            scale_dims = to_list(scale_dims)                                                                                                                                                                                              
   529 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   530 │       │       │       │        │       │               │       │            assert all([dim in p.dims for dim in scale_dims]), (                                                                                                                                                                          
   531 │       │       │       │        │       │               │       │                f"Provided scale dimensions {scale_dims} are not all present in the prediction data dimensions {p.dims}."                                                                                                                 
   532 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   533 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   534 │       │       │       │        │       │               │       │            len_dims = np.array([p.sizes[dim] for dim in scale_dims])                                                                                                                                                                     
   535 │       │       │       │        │       │               │       │            l2 /= np.prod(len_dims)                                                                                                                                                                                                       
   536 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   537 │       │       │       │        │       │               │       │        return l2                                                                                                                                                                                                                         
   538 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   539 │       │       │       │        │       │               │       │    def calc_mae(                                                                                                                                                                                                                         
   540 │       │       │       │        │       │               │       │        self, p: xr.DataArray, gt: xr.DataArray, group_by_coord: str | None = None                                                                                                                                                        
   541 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   542 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   543 │       │       │       │        │       │               │       │        Calculate mean absolute error (MAE) of forecast data w.r.t. reference data.                                                                                                                                                       
   544 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   545 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   546 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   547 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
   548 │       │       │       │        │       │               │       │            Forecast data array                                                                                                                                                                                                           
   549 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
   550 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
   551 │       │       │       │        │       │               │       │        group_by_coord: str                                                                                                                                                                                                               
   552 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   553 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the MAE score.                                                                                                                                                         
   554 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   555 │       │       │       │        │       │               │       │        if self._agg_dims is None:                                                                                                                                                                                                        
   556 │       │       │       │        │       │               │       │            raise ValueError(                                                                                                                                                                                                             
   557 │       │       │       │        │       │               │       │                "Cannot calculate mean absolute error without aggregation dimensions (agg_dims=None)."                                                                                                                                    
   558 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   559 │       │       │       │        │       │               │       │        mae = np.abs(p - gt)                                                                                                                                                                                                              
   560 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   561 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
   562 │       │       │       │        │       │               │       │            mae = mae.groupby(group_by_coord)                                                                                                                                                                                             
   563 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   564 │       │       │       │        │       │               │       │        mae = self._mean(mae)                                                                                                                                                                                                             
   565 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   566 │       │       │       │        │       │               │       │        return mae                                                                                                                                                                                                                        
   567 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   568 │       │       │       │        │       │               │       │    def calc_mse(                                                                                                                                                                                                                         
   569 │       │       │       │        │       │               │       │        self, p: xr.DataArray, gt: xr.DataArray, group_by_coord: str | None = None                                                                                                                                                        
   570 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   571 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   572 │       │       │       │        │       │               │       │        Calculate mean squared error (MSE) of forecast data w.r.t. reference data.                                                                                                                                                        
   573 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   574 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   575 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   576 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
   577 │       │       │       │        │       │               │       │            Forecast data array                                                                                                                                                                                                           
   578 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
   579 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
   580 │       │       │       │        │       │               │       │        group_by_coord: str                                                                                                                                                                                                               
   581 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   582 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   583 │       │       │       │        │       │               │       │        if self._agg_dims is None:                                                                                                                                                                                                        
   584 │       │       │       │        │       │               │       │            raise ValueError(                                                                                                                                                                                                             
   585 │       │       │       │        │       │               │       │                "Cannot calculate mean squared error without aggregation dimensions (agg_dims=None)."                                                                                                                                     
   586 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   587 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   588 │       │       │       │        │       │               │       │        mse = np.square(p - gt)                                                                                                                                                                                                           
   589 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   590 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
   591 │       │       │       │        │       │               │       │            mse = mse.groupby(group_by_coord)                                                                                                                                                                                             
   592 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   593 │       │       │       │        │       │               │       │        mse = self._mean(mse)                                                                                                                                                                                                             
   594 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   595 │       │       │       │        │       │               │       │        return mse                                                                                                                                                                                                                        
   596 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   597 │       │       │       │        │       │               │       │    def calc_rmse(                                                                                                                                                                                                                        
   598 │       │       │       │        │       │               │       │        self, p: xr.DataArray, gt: xr.DataArray, group_by_coord: str | None = None                                                                                                                                                        
   599 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   600 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   601 │       │       │       │        │       │               │       │        Calculate root mean squared error (RMSE) of forecast data w.r.t. reference data                                                                                                                                                   
   602 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   603 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   604 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
   605 │       │       │       │        │       │               │       │            Forecast data array                                                                                                                                                                                                           
   606 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
   607 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
   608 │       │       │       │        │       │               │       │        group_by_coord: str                                                                                                                                                                                                               
   609 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   610 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the RMSE score.                                                                                                                                                        
   611 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   612 │       │       │       │        │       │               │       │        if self._agg_dims is None:                                                                                                                                                                                                        
   613 │       │       │       │        │       │               │       │            raise ValueError(                                                                                                                                                                                                             
   614 │       │       │       │        │       │               │       │                "Cannot calculate root mean squared error without aggregation dimensions (agg_dims=None)."                                                                                                                                
   615 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   616 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   617 │       │       │       │        │       │               │       │        rmse = np.sqrt(self.calc_mse(p, gt, group_by_coord))                                                                                                                                                                              
   618 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   619 │       │       │       │        │       │               │       │        return rmse                                                                                                                                                                                                                       
   620 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   621 │       │       │       │        │       │               │       │    def calc_change_rate(                                                                                                                                                                                                                 
   622 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   623 │       │       │       │        │       │               │       │        s0: xr.DataArray,                                                                                                                                                                                                                 
   624 │       │       │       │        │       │               │       │        s1: xr.DataArray,                                                                                                                                                                                                                 
   625 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   626 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   627 │       │       │       │        │       │               │       │        Calculate the "change rate" of a data array as the mean absolute difference between two consecutive time steps.                                                                                                                   
   628 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   629 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   630 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   631 │       │       │       │        │       │               │       │        s0: xr.DataArray                                                                                                                                                                                                                  
   632 │       │       │       │        │       │               │       │            Data array at time step t0                                                                                                                                                                                                    
   633 │       │       │       │        │       │               │       │        s1: xr.DataArray                                                                                                                                                                                                                  
   634 │       │       │       │        │       │               │       │            Data array at time step t1                                                                                                                                                                                                    
   635 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   636 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   637 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   638 │       │       │       │        │       │               │       │        xr.DataArray                                                                                                                                                                                                                      
   639 │       │       │       │        │       │               │       │            Change rate of the data array                                                                                                                                                                                                 
   640 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   641 │       │       │       │        │       │               │       │        if s1 is None:                                                                                                                                                                                                                    
   642 │       │       │       │        │       │               │       │            return xr.full_like(s0, np.nan)                                                                                                                                                                                               
   643 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   644 │       │       │       │        │       │               │       │            # it needs to be in this order to preserve the s0 forecast_step                                                                                                                                                               
   645 │       │       │       │        │       │               │       │            crate = np.abs(s0 - s1.values)                                                                                                                                                                                                
   646 │       │       │       │        │       │               │       │            return crate                                                                                                                                                                                                                  
   647 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   648 │       │       │       │        │       │               │       │    def calc_froct(                                                                                                                                                                                                                       
   649 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   650 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   651 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   652 │       │       │       │        │       │               │       │        p_next: xr.DataArray,                                                                                                                                                                                                             
   653 │       │       │       │        │       │               │       │        gt_next: xr.DataArray,                                                                                                                                                                                                            
   654 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   655 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   656 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   657 │       │       │       │        │       │               │       │        Calculate forecast rate of change over time                                                                                                                                                                                       
   658 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   659 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   660 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   661 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
   662 │       │       │       │        │       │               │       │            Forecast data array                                                                                                                                                                                                           
   663 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
   664 │       │       │       │        │       │               │       │            Ground truth data array (not used in calculation, but kept for consistency)                                                                                                                                                   
   665 │       │       │       │        │       │               │       │        p_next: xr.DataArray                                                                                                                                                                                                              
   666 │       │       │       │        │       │               │       │            Next forecast step data array                                                                                                                                                                                                 
   667 │       │       │       │        │       │               │       │        gt_next: xr.DataArray                                                                                                                                                                                                             
   668 │       │       │       │        │       │               │       │            Next ground truth step data array (not used in calculation, but kept for consistency)                                                                                                                                         
   669 │       │       │       │        │       │               │       │        group_by_coord: str                                                                                                                                                                                                               
   670 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   671 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the FROCT score.                                                                                                                                                       
   672 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   673 │       │       │       │        │       │               │       │        if self._agg_dims is None:                                                                                                                                                                                                        
   674 │       │       │       │        │       │               │       │            raise ValueError(                                                                                                                                                                                                             
   675 │       │       │       │        │       │               │       │                "Cannot calculate forecast activity without aggregation dimensions (agg_dims=None)."                                                                                                                                      
   676 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   677 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   678 │       │       │       │        │       │               │       │        froct = self.calc_change_rate(p, p_next)                                                                                                                                                                                          
   679 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   680 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
   681 │       │       │       │        │       │               │       │            froct = froct.groupby(group_by_coord)                                                                                                                                                                                         
   682 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   683 │       │       │       │        │       │               │       │        froct = self._mean(froct)                                                                                                                                                                                                         
   684 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   685 │       │       │       │        │       │               │       │        return froct                                                                                                                                                                                                                      
   686 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   687 │       │       │       │        │       │               │       │    def calc_troct(                                                                                                                                                                                                                       
   688 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   689 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   690 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   691 │       │       │       │        │       │               │       │        gt_next: xr.DataArray,                                                                                                                                                                                                            
   692 │       │       │       │        │       │               │       │        p_next: xr.DataArray,                                                                                                                                                                                                             
   693 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   694 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   695 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   696 │       │       │       │        │       │               │       │        Calculate target rate of change over time                                                                                                                                                                                         
   697 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   698 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   699 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   700 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
   701 │       │       │       │        │       │               │       │            Forecast data array (not used in calculation, but kept for consistency)                                                                                                                                                       
   702 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
   703 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
   704 │       │       │       │        │       │               │       │        p_next: xr.DataArray                                                                                                                                                                                                              
   705 │       │       │       │        │       │               │       │            Next forecast step data array (not used in calculation, but kept for consistency)                                                                                                                                             
   706 │       │       │       │        │       │               │       │        gt_next: xr.DataArray                                                                                                                                                                                                             
   707 │       │       │       │        │       │               │       │            Next ground truth step data array                                                                                                                                                                                             
   708 │       │       │       │        │       │               │       │        group_by_coord: str                                                                                                                                                                                                               
   709 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   710 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the FROCT score.                                                                                                                                                       
   711 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   712 │       │       │       │        │       │               │       │        if self._agg_dims is None:                                                                                                                                                                                                        
   713 │       │       │       │        │       │               │       │            raise ValueError(                                                                                                                                                                                                             
   714 │       │       │       │        │       │               │       │                "Cannot calculate forecast activity without aggregation dimensions (agg_dims=None)."                                                                                                                                      
   715 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   716 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   717 │       │       │       │        │       │               │       │        troct = self.calc_change_rate(gt, gt_next)                                                                                                                                                                                        
   718 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   719 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
   720 │       │       │       │        │       │               │       │            troct = troct.groupby(group_by_coord)                                                                                                                                                                                         
   721 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   722 │       │       │       │        │       │               │       │        troct = self._mean(troct)                                                                                                                                                                                                         
   723 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   724 │       │       │       │        │       │               │       │        return troct                                                                                                                                                                                                                      
   725 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   726 │       │       │       │        │       │               │       │    def calc_acc(                                                                                                                                                                                                                         
   727 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   728 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   729 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   730 │       │       │       │        │       │               │       │        clim_mean: xr.DataArray,                                                                                                                                                                                                          
   731 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   732 │       │       │       │        │       │               │       │        spatial_dims: list = None,                                                                                                                                                                                                        
   733 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   734 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   735 │       │       │       │        │       │               │       │        Calculate anomaly correlation coefficient (ACC).                                                                                                                                                                                  
   736 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   737 │       │       │       │        │       │               │       │        NOTE:                                                                                                                                                                                                                             
   738 │       │       │       │        │       │               │       │        The climatlogical mean data clim_mean must fit to the forecast and ground truth data.                                                                                                                                             
   739 │       │       │       │        │       │               │       │        By definition, the ACC is always aggregated over the spatial dimensions.                                                                                                                                                          
   740 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   741 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   742 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   743 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
   744 │       │       │       │        │       │               │       │            Forecast data array                                                                                                                                                                                                           
   745 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
   746 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
   747 │       │       │       │        │       │               │       │        clim_mean: xr.DataArray                                                                                                                                                                                                           
   748 │       │       │       │        │       │               │       │            Climatological mean data array, which is used to calculate anomalies                                                                                                                                                          
   749 │       │       │       │        │       │               │       │        group_by_coord: str                                                                                                                                                                                                               
   750 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   751 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the ACC score.                                                                                                                                                         
   752 │       │       │       │        │       │               │       │        spatial_dims: List[str]                                                                                                                                                                                                           
   753 │       │       │       │        │       │               │       │            Names of spatial dimensions over which ACC is calculated.                                                                                                                                                                     
   754 │       │       │       │        │       │               │       │            Note: No averaging is possible over these dimensions.                                                                                                                                                                         
   755 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   756 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   757 │       │       │       │        │       │               │       │        # Check if spatial_dims are in the data                                                                                                                                                                                           
   758 │       │       │       │        │       │               │       │        spatial_dims = ["lat", "lon"] if spatial_dims is None else to_list(spatial_dims)                                                                                                                                                  
   759 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   760 │       │       │       │        │       │               │       │        for dim in spatial_dims:                                                                                                                                                                                                          
   761 │       │       │       │        │       │               │       │            if dim not in p.dims:                                                                                                                                                                                                         
   762 │       │       │       │        │       │               │       │                raise ValueError(                                                                                                                                                                                                         
   763 │       │       │       │        │       │               │       │                    f"Spatial dimension '{dim}' not found in prediction data dimensions: {p.dims}"                                                                                                                                        
   764 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   765 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   766 │       │       │       │        │       │               │       │        fcst_ano, obs_ano = p - clim_mean, gt - clim_mean                                                                                                                                                                                 
   767 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   768 │       │       │       │        │       │               │       │        acc = (fcst_ano * obs_ano).sum(spatial_dims) / np.sqrt(                                                                                                                                                                           
   769 │       │       │       │        │       │               │       │            fcst_ano.sum(spatial_dims) * obs_ano.sum(spatial_dims)                                                                                                                                                                        
   770 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   771 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   772 │       │       │       │        │       │               │       │        # Exclude spatial dimensions from averaging since ACC is always calculated over them                                                                                                                                              
   773 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
   774 │       │       │       │        │       │               │       │            acc = acc.groupby(group_by_coord)                                                                                                                                                                                             
   775 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   776 │       │       │       │        │       │               │       │        if self._agg_dims is not None:                                                                                                                                                                                                    
   777 │       │       │       │        │       │               │       │            mean_dims = [x for x in self._agg_dims if x not in spatial_dims]                                                                                                                                                              
   778 │       │       │       │        │       │               │       │            if len(mean_dims) > 0:                                                                                                                                                                                                        
   779 │       │       │       │        │       │               │       │                acc = acc.mean(mean_dims)                                                                                                                                                                                                 
   780 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   781 │       │       │       │        │       │               │       │        return acc                                                                                                                                                                                                                        
   782 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   783 │       │       │       │        │       │               │       │    def calc_bias(                                                                                                                                                                                                                        
   784 │       │       │       │        │       │               │       │        self, p: xr.DataArray, gt: xr.DataArray, group_by_coord: str | None = None                                                                                                                                                        
   785 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   786 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   787 │       │       │       │        │       │               │       │        Calculate mean bias of forecast data w.r.t. reference data                                                                                                                                                                        
   788 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   789 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   790 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   791 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
   792 │       │       │       │        │       │               │       │            Forecast data array                                                                                                                                                                                                           
   793 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
   794 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
   795 │       │       │       │        │       │               │       │        group_by_coord: str                                                                                                                                                                                                               
   796 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   797 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the bias score.                                                                                                                                                        
   798 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   799 │       │       │       │        │       │               │       │        bias = p - gt                                                                                                                                                                                                                     
   800 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   801 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
   802 │       │       │       │        │       │               │       │            bias = bias.groupby(group_by_coord)                                                                                                                                                                                           
   803 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   804 │       │       │       │        │       │               │       │        bias = self._mean(bias)                                                                                                                                                                                                           
   805 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   806 │       │       │       │        │       │               │       │        return bias                                                                                                                                                                                                                       
   807 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   808 │       │       │       │        │       │               │       │    def calc_psnr(                                                                                                                                                                                                                        
   809 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   810 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   811 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   812 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   813 │       │       │       │        │       │               │       │        pixel_max: float = 1.0,                                                                                                                                                                                                           
   814 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   815 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   816 │       │       │       │        │       │               │       │        Calculate PSNR of forecast data w.r.t. reference data                                                                                                                                                                             
   817 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   818 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   819 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   820 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
   821 │       │       │       │        │       │               │       │            Forecast data array                                                                                                                                                                                                           
   822 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
   823 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
   824 │       │       │       │        │       │               │       │        group_by_coord: str                                                                                                                                                                                                               
   825 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   826 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the PSNR score.                                                                                                                                                        
   827 │       │       │       │        │       │               │       │        pixel_max: float                                                                                                                                                                                                                  
   828 │       │       │       │        │       │               │       │            Maximum pixel value in the data. Default is 1.0.                                                                                                                                                                              
   829 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   830 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   831 │       │       │       │        │       │               │       │        mse = self.calc_mse(p, gt, group_by_coord)                                                                                                                                                                                        
   832 │       │       │       │        │       │               │       │        if np.count_nonzero(mse) == 0:                                                                                                                                                                                                    
   833 │       │       │       │        │       │               │       │            psnr = mse                                                                                                                                                                                                                    
   834 │       │       │       │        │       │               │       │            psnr[...] = 100.0                                                                                                                                                                                                             
   835 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   836 │       │       │       │        │       │               │       │            psnr = 20.0 * np.log10(pixel_max / np.sqrt(mse))                                                                                                                                                                              
   837 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   838 │       │       │       │        │       │               │       │        return psnr                                                                                                                                                                                                                       
   839 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   840 │       │       │       │        │       │               │       │    def calc_spatial_variability(                                                                                                                                                                                                         
   841 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   842 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   843 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   844 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   845 │       │       │       │        │       │               │       │        order: int = 1,                                                                                                                                                                                                                   
   846 │       │       │       │        │       │               │       │        non_spatial_avg_dims: list[str] = None,                                                                                                                                                                                           
   847 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   848 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   849 │       │       │       │        │       │               │       │        Calculates the ratio between the spatial variability of differental operator with order 1 (higher values unsupported yest)                                                                                                        
   850 │       │       │       │        │       │               │       │        forecast and ground truth data using the calc_geo_spatial-method.                                                                                                                                                                 
   851 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   852 │       │       │       │        │       │               │       │        NOTE:                                                                                                                                                                                                                             
   853 │       │       │       │        │       │               │       │        Requires that data is provided on a regular lat/lon-grid!                                                                                                                                                                         
   854 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   855 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   856 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   857 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
   858 │       │       │       │        │       │               │       │            Forecast data array                                                                                                                                                                                                           
   859 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
   860 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
   861 │       │       │       │        │       │               │       │        group_by_coord: str                                                                                                                                                                                                               
   862 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   863 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the spatial variability ratio.                                                                                                                                         
   864 │       │       │       │        │       │               │       │        order: int                                                                                                                                                                                                                        
   865 │       │       │       │        │       │               │       │            Order of the spatial differential operator to be applied. Supported orders: 1                                                                                                                                                 
   866 │       │       │       │        │       │               │       │        non_spatial_avg_dims: List[str]                                                                                                                                                                                                   
   867 │       │       │       │        │       │               │       │            List of dimensions over which the spatial variability ratio should be averaged.                                                                                                                                               
   868 │       │       │       │        │       │               │       │            It must be non-spatial dimensions, i.e. not latitude or longitude.                                                                                                                                                            
   869 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   870 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   871 │       │       │       │        │       │               │       │        fcst_grad = self.calc_geo_spatial_diff(p, order=order)                                                                                                                                                                            
   872 │       │       │       │        │       │               │       │        ref_grd = self.calc_geo_spatial_diff(gt, order=order)                                                                                                                                                                             
   873 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   874 │       │       │       │        │       │               │       │        ratio_spat_variability = fcst_grad / ref_grd                                                                                                                                                                                      
   875 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   876 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
   877 │       │       │       │        │       │               │       │            ratio_spat_variability = ratio_spat_variability.groupby(group_by_coord)                                                                                                                                                       
   878 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   879 │       │       │       │        │       │               │       │        if non_spatial_avg_dims is not None:                                                                                                                                                                                              
   880 │       │       │       │        │       │               │       │            ratio_spat_variability = ratio_spat_variability.mean(                                                                                                                                                                         
   881 │       │       │       │        │       │               │       │                dim=non_spatial_avg_dims                                                                                                                                                                                                  
   882 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   883 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   884 │       │       │       │        │       │               │       │        return ratio_spat_variability                                                                                                                                                                                                     
   885 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   886 │       │       │       │        │       │               │       │    def calc_seeps(                                                                                                                                                                                                                       
   887 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   888 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
   889 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
   890 │       │       │       │        │       │               │       │        seeps_weights: xr.DataArray,                                                                                                                                                                                                      
   891 │       │       │       │        │       │               │       │        t1: xr.DataArray,                                                                                                                                                                                                                 
   892 │       │       │       │        │       │               │       │        t3: xr.DataArray,                                                                                                                                                                                                                 
   893 │       │       │       │        │       │               │       │        spatial_dims: list,                                                                                                                                                                                                               
   894 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
   895 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   896 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   897 │       │       │       │        │       │               │       │        Calculates stable equitable error in probabiliyt space (SEEPS), see Rodwell et al., 2011                                                                                                                                          
   898 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   899 │       │       │       │        │       │               │       │        NOTE:                                                                                                                                                                                                                             
   900 │       │       │       │        │       │               │       │        Threshold arrays t1 and t3 (derived from space-time dependant climatology)                                                                                                                                                        
   901 │       │       │       │        │       │               │       │        must fit to the forecast and ground truth data.                                                                                                                                                                                   
   902 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   903 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
   904 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
   905 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
   906 │       │       │       │        │       │               │       │            Forecast data array                                                                                                                                                                                                           
   907 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
   908 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
   909 │       │       │       │        │       │               │       │        seeps_weights: xr.DataArray                                                                                                                                                                                                       
   910 │       │       │       │        │       │               │       │            SEEPS-parameter matrix to weight contingency table elements                                                                                                                                                                   
   911 │       │       │       │        │       │               │       │        t1: xr.DataArray                                                                                                                                                                                                                  
   912 │       │       │       │        │       │               │       │            Threshold for light precipitation events                                                                                                                                                                                      
   913 │       │       │       │        │       │               │       │        t3: xr.DataArray                                                                                                                                                                                                                  
   914 │       │       │       │        │       │               │       │            Threshold for strong precipitation events                                                                                                                                                                                     
   915 │       │       │       │        │       │               │       │        spatial_dims: List[str]                                                                                                                                                                                                           
   916 │       │       │       │        │       │               │       │            List of spatial dimensions of the data, e.g. ["lat", "lon"]                                                                                                                                                                   
   917 │       │       │       │        │       │               │       │        group_by_coord: str                                                                                                                                                                                                               
   918 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
   919 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the sseps score.                                                                                                                                                       
   920 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   921 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
   922 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
   923 │       │       │       │        │       │               │       │        xr.DataArray                                                                                                                                                                                                                      
   924 │       │       │       │        │       │               │       │            SEEPS skill score (i.e. 1-SEEPS)                                                                                                                                                                                              
   925 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   926 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   927 │       │       │       │        │       │               │       │        def seeps(ground_truth, prediction, thr_light, thr_heavy, seeps_weights):                                                                                                                                                         
   928 │       │       │       │        │       │               │       │            ob_ind = (ground_truth > thr_light).astype(int) + (                                                                                                                                                                           
   929 │       │       │       │        │       │               │       │                ground_truth >= thr_heavy                                                                                                                                                                                                 
   930 │       │       │       │        │       │               │       │            ).astype(int)                                                                                                                                                                                                                 
   931 │       │       │       │        │       │               │       │            fc_ind = (prediction > thr_light).astype(int) + (                                                                                                                                                                             
   932 │       │       │       │        │       │               │       │                prediction >= thr_heavy                                                                                                                                                                                                   
   933 │       │       │       │        │       │               │       │            ).astype(int)                                                                                                                                                                                                                 
   934 │       │       │       │        │       │               │       │            indices = (                                                                                                                                                                                                                   
   935 │       │       │       │        │       │               │       │                fc_ind * 3 + ob_ind                                                                                                                                                                                                       
   936 │       │       │       │        │       │               │       │            )  # index of each data point in their local 3x3 matrices                                                                                                                                                                     
   937 │       │       │       │        │       │               │       │            seeps_val = seeps_weights[                                                                                                                                                                                                    
   938 │       │       │       │        │       │               │       │                indices, np.arange(len(indices))                                                                                                                                                                                          
   939 │       │       │       │        │       │               │       │            ]  # pick the right weight for each data point                                                                                                                                                                                
   940 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   941 │       │       │       │        │       │               │       │            return 1.0 - seeps_val                                                                                                                                                                                                        
   942 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   943 │       │       │       │        │       │               │       │        if p.ndim == 3:                                                                                                                                                                                                                   
   944 │       │       │       │        │       │               │       │            assert len(spatial_dims) == 2, (                                                                                                                                                                                              
   945 │       │       │       │        │       │               │       │                "Provide two spatial dimensions for three-dimensional data."                                                                                                                                                              
   946 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   947 │       │       │       │        │       │               │       │            prediction, ground_truth = (                                                                                                                                                                                                  
   948 │       │       │       │        │       │               │       │                p.stack({"xy": spatial_dims}),                                                                                                                                                                                            
   949 │       │       │       │        │       │               │       │                gt.stack({"xy": spatial_dims}),                                                                                                                                                                                           
   950 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   951 │       │       │       │        │       │               │       │            seeps_weights = seeps_weights.stack({"xy": spatial_dims})                                                                                                                                                                     
   952 │       │       │       │        │       │               │       │            t3 = t3.stack({"xy": spatial_dims})                                                                                                                                                                                           
   953 │       │       │       │        │       │               │       │            lstack = True                                                                                                                                                                                                                 
   954 │       │       │       │        │       │               │       │        elif self.prediction.ndim == 2:                                                                                                                                                                                                   
   955 │       │       │       │        │       │               │       │            prediction, ground_truth = p, gt                                                                                                                                                                                              
   956 │       │       │       │        │       │               │       │            lstack = False                                                                                                                                                                                                                
   957 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   958 │       │       │       │        │       │               │       │            raise ValueError("Data must be a two-or-three-dimensional array.")                                                                                                                                                            
   959 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   960 │       │       │       │        │       │               │       │        # check dimensioning of data                                                                                                                                                                                                      
   961 │       │       │       │        │       │               │       │        assert prediction.ndim <= 2, (                                                                                                                                                                                                    
   962 │       │       │       │        │       │               │       │            f"Data must be one- or two-dimensional, but has {prediction.ndim} dimensions. Check if stacking with spatial_dims may help."                                                                                                  
   963 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   964 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   965 │       │       │       │        │       │               │       │        if prediction.ndim == 1:                                                                                                                                                                                                          
   966 │       │       │       │        │       │               │       │            seeps_values_all = seeps(                                                                                                                                                                                                     
   967 │       │       │       │        │       │               │       │                ground_truth, prediction, t1.values, t3, seeps_weights                                                                                                                                                                    
   968 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   969 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   970 │       │       │       │        │       │               │       │            prediction, ground_truth = (                                                                                                                                                                                                  
   971 │       │       │       │        │       │               │       │                prediction.transpose(..., "xy"),                                                                                                                                                                                          
   972 │       │       │       │        │       │               │       │                ground_truth.transpose(..., "xy"),                                                                                                                                                                                        
   973 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   974 │       │       │       │        │       │               │       │            seeps_values_all = xr.full_like(prediction, np.nan)                                                                                                                                                                           
   975 │       │       │       │        │       │               │       │            seeps_values_all.name = "seeps"                                                                                                                                                                                               
   976 │       │       │       │        │       │               │       │            for it in range(ground_truth.shape[0]):                                                                                                                                                                                       
   977 │       │       │       │        │       │               │       │                prediction_now, ground_truth_now = (                                                                                                                                                                                      
   978 │       │       │       │        │       │               │       │                    prediction[it, ...],                                                                                                                                                                                                  
   979 │       │       │       │        │       │               │       │                    ground_truth[it, ...],                                                                                                                                                                                                
   980 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   981 │       │       │       │        │       │               │       │                # in case of missing data, skip computation                                                                                                                                                                               
   982 │       │       │       │        │       │               │       │                if np.all(np.isnan(prediction_now)) or np.all(                                                                                                                                                                            
   983 │       │       │       │        │       │               │       │                    np.isnan(ground_truth_now)                                                                                                                                                                                            
   984 │       │       │       │        │       │               │       │                ):                                                                                                                                                                                                                        
   985 │       │       │       │        │       │               │       │                    continue                                                                                                                                                                                                              
   986 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   987 │       │       │       │        │       │               │       │                seeps_values_all[it, ...] = seeps(                                                                                                                                                                                        
   988 │       │       │       │        │       │               │       │                    ground_truth_now,                                                                                                                                                                                                     
   989 │       │       │       │        │       │               │       │                    prediction_now,                                                                                                                                                                                                       
   990 │       │       │       │        │       │               │       │                    t1.values,                                                                                                                                                                                                            
   991 │       │       │       │        │       │               │       │                    t3,                                                                                                                                                                                                                   
   992 │       │       │       │        │       │               │       │                    seeps_weights.values,                                                                                                                                                                                                 
   993 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   994 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   995 │       │       │       │        │       │               │       │        if lstack:                                                                                                                                                                                                                        
   996 │       │       │       │        │       │               │       │            seeps_values_all = seeps_values_all.unstack()                                                                                                                                                                                 
   997 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   998 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
   999 │       │       │       │        │       │               │       │            seeps_values_all = seeps_values_all.groupby(group_by_coord)                                                                                                                                                                   
  1000 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1001 │       │       │       │        │       │               │       │        if self._agg_dims is not None:                                                                                                                                                                                                    
  1002 │       │       │       │        │       │               │       │            seeps_values = self._mean(seeps_values_all)                                                                                                                                                                                   
  1003 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1004 │       │       │       │        │       │               │       │            seeps_values = seeps_values_all                                                                                                                                                                                               
  1005 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1006 │       │       │       │        │       │               │       │        return seeps_values                                                                                                                                                                                                               
  1007 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1008 │       │       │       │        │       │               │       │    ### Probablistic scores                                                                                                                                                                                                               
  1009 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1010 │       │       │       │        │       │               │       │    def calc_spread(self, p: xr.DataArray, group_by_coord: str | None = None):                                                                                                                                                            
  1011 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1012 │       │       │       │        │       │               │       │        Calculate the spread of the forecast ensemble                                                                                                                                                                                     
  1013 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1014 │       │       │       │        │       │               │       │        ens_std = p.std(dim=self.ens_dim)                                                                                                                                                                                                 
  1015 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1016 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
  1017 │       │       │       │        │       │               │       │            ens_std = ens_std.groupby(group_by_coord)                                                                                                                                                                                     
  1018 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1019 │       │       │       │        │       │               │       │        return self._mean(np.sqrt(ens_std**2))                                                                                                                                                                                            
  1020 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1021 │       │       │       │        │       │               │       │    def calc_ssr(                                                                                                                                                                                                                         
  1022 │       │       │       │        │       │               │       │        self, p: xr.DataArray, gt: xr.DataArray, group_by_coord: str | None = None                                                                                                                                                        
  1023 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
  1024 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1025 │       │       │       │        │       │               │       │        Calculate the Spread-Skill Ratio (SSR) of the forecast ensemble data w.r.t. reference data                                                                                                                                        
  1026 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1027 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
  1028 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
  1029 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
  1030 │       │       │       │        │       │               │       │            Forecast data array with ensemble dimension                                                                                                                                                                                   
  1031 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
  1032 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
  1033 │       │       │       │        │       │               │       │        group_by_coord: str | None                                                                                                                                                                                                        
  1034 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
  1035 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the SSR score.                                                                                                                                                         
  1036 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1037 │       │       │       │        │       │               │       │        ssr = self.calc_spread(p, group_by_coord) / self.calc_rmse(                                                                                                                                                                       
  1038 │       │       │       │        │       │               │       │            p, gt, group_by_coord                                                                                                                                                                                                         
  1039 │       │       │       │        │       │               │       │        )  # spread/rmse                                                                                                                                                                                                                  
  1040 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1041 │       │       │       │        │       │               │       │        return ssr                                                                                                                                                                                                                        
  1042 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1043 │       │       │       │        │       │               │       │    def calc_crps(                                                                                                                                                                                                                        
  1044 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  1045 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
  1046 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
  1047 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
  1048 │       │       │       │        │       │               │       │        method: str = "ensemble",                                                                                                                                                                                                         
  1049 │       │       │       │        │       │               │       │        **kwargs,                                                                                                                                                                                                                         
  1050 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
  1051 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1052 │       │       │       │        │       │               │       │        Wrapper around CRPS-methods provided by xskillscore-package.                                                                                                                                                                      
  1053 │       │       │       │        │       │               │       │        See https://xskillscore.readthedocs.io/en/stable/api                                                                                                                                                                              
  1054 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1055 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
  1056 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
  1057 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
  1058 │       │       │       │        │       │               │       │            Forecast data array with ensemble dimension                                                                                                                                                                                   
  1059 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
  1060 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
  1061 │       │       │       │        │       │               │       │        group_by_coord: str | None                                                                                                                                                                                                        
  1062 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
  1063 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the CRPS score.                                                                                                                                                        
  1064 │       │       │       │        │       │               │       │        method: str                                                                                                                                                                                                                       
  1065 │       │       │       │        │       │               │       │            Method to calculate CRPS. Supported methods: ["ensemble", "gaussian"]                                                                                                                                                         
  1066 │       │       │       │        │       │               │       │        kwargs: dict                                                                                                                                                                                                                      
  1067 │       │       │       │        │       │               │       │            Other keyword parameters supported by respective CRPS-method from the xskillscore package                                                                                                                                     
  1068 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1069 │       │       │       │        │       │               │       │        Returns                                                                                                                                                                                                                           
  1070 │       │       │       │        │       │               │       │        -------                                                                                                                                                                                                                           
  1071 │       │       │       │        │       │               │       │        xr.DataArray                                                                                                                                                                                                                      
  1072 │       │       │       │        │       │               │       │            CRPS score data array averaged over the provided dimensions                                                                                                                                                                   
  1073 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1074 │       │       │       │        │       │               │       │        crps_methods = ["ensemble", "gaussian"]                                                                                                                                                                                           
  1075 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1076 │       │       │       │        │       │               │       │        if group_by_coord:                                                                                                                                                                                                                
  1077 │       │       │       │        │       │               │       │            p = p.groupby(group_by_coord)                                                                                                                                                                                                 
  1078 │       │       │       │        │       │               │       │            gt = gt.groupby(group_by_coord)                                                                                                                                                                                               
  1079 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1080 │       │       │       │        │       │               │       │        if method == "ensemble":                                                                                                                                                                                                          
  1081 │       │       │       │        │       │               │       │            func_kwargs = {                                                                                                                                                                                                               
  1082 │       │       │       │        │       │               │       │                "forecasts": p,                                                                                                                                                                                                           
  1083 │       │       │       │        │       │               │       │                "member_dim": self.ens_dim,                                                                                                                                                                                               
  1084 │       │       │       │        │       │               │       │                "dim": self._agg_dims,                                                                                                                                                                                                    
  1085 │       │       │       │        │       │               │       │                **kwargs,                                                                                                                                                                                                                 
  1086 │       │       │       │        │       │               │       │            }                                                                                                                                                                                                                             
  1087 │       │       │       │        │       │               │       │            crps_func = xskillscore.crps_ensemble                                                                                                                                                                                         
  1088 │       │       │       │        │       │               │       │        elif method == "gaussian":                                                                                                                                                                                                        
  1089 │       │       │       │        │       │               │       │            func_kwargs = {                                                                                                                                                                                                               
  1090 │       │       │       │        │       │               │       │                "mu": p.mean(dim=self.ens_dim),                                                                                                                                                                                           
  1091 │       │       │       │        │       │               │       │                "sig": p.std(dim=self.ens_dim),                                                                                                                                                                                           
  1092 │       │       │       │        │       │               │       │                "dim": self._agg_dims,                                                                                                                                                                                                    
  1093 │       │       │       │        │       │               │       │                **kwargs,                                                                                                                                                                                                                 
  1094 │       │       │       │        │       │               │       │            }                                                                                                                                                                                                                             
  1095 │       │       │       │        │       │               │       │            crps_func = xskillscore.crps_gaussian                                                                                                                                                                                         
  1096 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1097 │       │       │       │        │       │               │       │            raise ValueError(                                                                                                                                                                                                             
  1098 │       │       │       │        │       │               │       │                f"Unsupported CRPS-calculation method {method} chosen. Supported methods: {', '.join(crps_methods)}"                                                                                                                      
  1099 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  1100 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1101 │       │       │       │        │       │               │       │        crps = crps_func(gt, **func_kwargs)                                                                                                                                                                                               
  1102 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1103 │       │       │       │        │       │               │       │        return crps                                                                                                                                                                                                                       
  1104 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1105 │       │       │       │        │       │               │       │    def calc_rank_histogram(                                                                                                                                                                                                              
  1106 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
  1107 │       │       │       │        │       │               │       │        p: xr.DataArray,                                                                                                                                                                                                                  
  1108 │       │       │       │        │       │               │       │        gt: xr.DataArray,                                                                                                                                                                                                                 
  1109 │       │       │       │        │       │               │       │        group_by_coord: str | None = None,                                                                                                                                                                                                
  1110 │       │       │       │        │       │               │       │        norm: bool = True,                                                                                                                                                                                                                
  1111 │       │       │       │        │       │               │       │        add_noise: bool = True,                                                                                                                                                                                                           
  1112 │       │       │       │        │       │               │       │        noise_fac=1.0e-03,                                                                                                                                                                                                                
  1113 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
  1114 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1115 │       │       │       │        │       │               │       │        Calculate the rank histogram of the forecast data w.r.t. reference data.                                                                                                                                                          
  1116 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1117 │       │       │       │        │       │               │       │        Parameters                                                                                                                                                                                                                        
  1118 │       │       │       │        │       │               │       │        ----------                                                                                                                                                                                                                        
  1119 │       │       │       │        │       │               │       │        p: xr.DataArray                                                                                                                                                                                                                   
  1120 │       │       │       │        │       │               │       │            Forecast data array with ensemble dimension                                                                                                                                                                                   
  1121 │       │       │       │        │       │               │       │        gt: xr.DataArray                                                                                                                                                                                                                  
  1122 │       │       │       │        │       │               │       │            Ground truth data array                                                                                                                                                                                                       
  1123 │       │       │       │        │       │               │       │        norm: bool                                                                                                                                                                                                                        
  1124 │       │       │       │        │       │               │       │            Flag if normalized counts should be returned. If True, the rank histogram will be normalized by                                                                                                                               
  1125 │       │       │       │        │       │               │       │            the number of ensemble members in the forecast data.                                                                                                                                                                          
  1126 │       │       │       │        │       │               │       │        group_by_coord: str | None                                                                                                                                                                                                        
  1127 │       │       │       │        │       │               │       │            Name of the coordinate to group by.                                                                                                                                                                                           
  1128 │       │       │       │        │       │               │       │            If provided, the coordinate becomes a new dimension of the rank histogram.                                                                                                                                                    
  1129 │       │       │       │        │       │               │       │        add_noise: bool                                                                                                                                                                                                                   
  1130 │       │       │       │        │       │               │       │            Flag if a small amount of random noise should be added to the data to avoid ties in the rank histogram.                                                                                                                       
  1131 │       │       │       │        │       │               │       │            This is recommended for fair computations, cf. Sec. 4.2.2 in Harris et al. 2022                                                                                                                                               
  1132 │       │       │       │        │       │               │       │        noise_fac: float                                                                                                                                                                                                                  
  1133 │       │       │       │        │       │               │       │            Magnitude of random noise to be added to the data if add_noise is True. Default is 1.0e-03.                                                                                                                                   
  1134 │       │       │       │        │       │               │       │            This value is only relevant if add_noise is True                                                                                                                                                                              
  1135 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1136 │       │       │       │        │       │               │       │        if group_by_coord is not None:                                                                                                                                                                                                    
  1137 │       │       │       │        │       │               │       │            p = p.groupby(group_by_coord)                                                                                                                                                                                                 
  1138 │       │       │       │        │       │               │       │            gt = gt.groupby(group_by_coord)                                                                                                                                                                                               
  1139 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1140 │       │       │       │        │       │               │       │        # unstack stacked time-dimension beforehand if required (time may be stacked for forecast data)                                                                                                                                   
  1141 │       │       │       │        │       │               │       │        ground_truth = gt                                                                                                                                                                                                                 
  1142 │       │       │       │        │       │               │       │        if "time" in ground_truth.indexes:                                                                                                                                                                                                
  1143 │       │       │       │        │       │               │       │            if isinstance(ground_truth.indexes["time"], pd.MultiIndex):                                                                                                                                                                   
  1144 │       │       │       │        │       │               │       │                ground_truth = ground_truth.reset_index("time")                                                                                                                                                                           
  1145 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1146 │       │       │       │        │       │               │       │        prediction = p                                                                                                                                                                                                                    
  1147 │       │       │       │        │       │               │       │        if "time" in prediction.indexes:                                                                                                                                                                                                  
  1148 │       │       │       │        │       │               │       │            if isinstance(prediction.indexes["time"], pd.MultiIndex):                                                                                                                                                                     
  1149 │       │       │       │        │       │               │       │                prediction = prediction.reset_index("time")                                                                                                                                                                               
  1150 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1151 │       │       │       │        │       │               │       │        # perform the stacking                                                                                                                                                                                                            
  1152 │       │       │       │        │       │               │       │        obs_stacked = ground_truth.stack({"npoints": self._agg_dims})                                                                                                                                                                     
  1153 │       │       │       │        │       │               │       │        fcst_stacked = prediction.stack({"npoints": self._agg_dims})                                                                                                                                                                      
  1154 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1155 │       │       │       │        │       │               │       │        # add noise to data if desired                                                                                                                                                                                                    
  1156 │       │       │       │        │       │               │       │        if add_noise:                                                                                                                                                                                                                     
  1157 │       │       │       │        │       │               │       │            if obs_stacked.chunks is None and fcst_stacked.chunks is None:                                                                                                                                                                
  1158 │       │       │       │        │       │               │       │                # underlying arrays are numpy arrays -> use numpy's native random generator                                                                                                                                               
  1159 │       │       │       │        │       │               │       │                rng = np.random.default_rng()                                                                                                                                                                                             
  1160 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1161 │       │       │       │        │       │               │       │                obs_stacked += (                                                                                                                                                                                                          
  1162 │       │       │       │        │       │               │       │                    rng.random(size=obs_stacked.shape, dtype=np.float32) * noise_fac                                                                                                                                                      
  1163 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  1164 │       │       │       │        │       │               │       │                fcst_stacked += (                                                                                                                                                                                                         
  1165 │       │       │       │        │       │               │       │                    rng.random(size=fcst_stacked.shape, dtype=np.float32) * noise_fac                                                                                                                                                     
  1166 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  1167 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
  1168 │       │       │       │        │       │               │       │                # underlying arrays are dask arrays -> use dask's random generator                                                                                                                                                        
  1169 │       │       │       │        │       │               │       │                obs_stacked += (                                                                                                                                                                                                          
  1170 │       │       │       │        │       │               │       │                    da.random.random(size=obs_stacked.shape, chunks=obs_stacked.chunks)                                                                                                                                                   
  1171 │       │       │       │        │       │               │       │                    * noise_fac                                                                                                                                                                                                           
  1172 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  1173 │       │       │       │        │       │               │       │                fcst_stacked += (                                                                                                                                                                                                         
  1174 │       │       │       │        │       │               │       │                    da.random.random(                                                                                                                                                                                                     
  1175 │       │       │       │        │       │               │       │                        size=fcst_stacked.shape, chunks=fcst_stacked.chunks                                                                                                                                                               
  1176 │       │       │       │        │       │               │       │                    )                                                                                                                                                                                                                     
  1177 │       │       │       │        │       │               │       │                    * noise_fac                                                                                                                                                                                                           
  1178 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
  1179 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1180 │       │       │       │        │       │               │       │        # calculate ranks for all data points                                                                                                                                                                                             
  1181 │       │       │       │        │       │               │       │        rank = (obs_stacked >= fcst_stacked).sum(dim=self.ens_dim)                                                                                                                                                                        
  1182 │       │       │       │        │       │               │       │        # and count occurence of rank values                                                                                                                                                                                              
  1183 │       │       │       │        │       │               │       │        rank.name = "rank"  # name for xr.DataArray is required for histogram-method                                                                                                                                                      
  1184 │       │       │       │        │       │               │       │        rank_counts = histogram(                                                                                                                                                                                                          
  1185 │       │       │       │        │       │               │       │            rank,                                                                                                                                                                                                                         
  1186 │       │       │       │        │       │               │       │            dim=["npoints"],                                                                                                                                                                                                              
  1187 │       │       │       │        │       │               │       │            bins=np.arange(len(fcst_stacked[self.ens_dim]) + 2),                                                                                                                                                                          
  1188 │       │       │       │        │       │               │       │            block_size=None if rank.chunks is None else "auto",                                                                                                                                                                           
  1189 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
  1190 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1191 │       │       │       │        │       │               │       │        # provide normalized rank counts if desired                                                                                                                                                                                       
  1192 │       │       │       │        │       │               │       │        if norm:                                                                                                                                                                                                                          
  1193 │       │       │       │        │       │               │       │            npoints = len(fcst_stacked["npoints"])                                                                                                                                                                                        
  1194 │       │       │       │        │       │               │       │            rank_counts = rank_counts / npoints                                                                                                                                                                                           
  1195 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1196 │       │       │       │        │       │               │       │        return rank_counts                                                                                                                                                                                                                
  1197 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1198 │       │       │       │        │       │               │       │    def calc_rank_histogram_xskillscore(self, p: xr.DataArray, gt: xr.DataArray):                                                                                                                                                         
  1199 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1200 │       │       │       │        │       │               │       │        Wrapper around rank_histogram-method by xskillscore-package.                                                                                                                                                                      
  1201 │       │       │       │        │       │               │       │        See https://xskillscore.readthedocs.io/en/stable/api                                                                                                                                                                              
  1202 │       │       │       │        │       │               │       │        Note: this version is found to be very slow. Use calc_rank_histogram alternatively.                                                                                                                                               
  1203 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1204 │       │       │       │        │       │               │       │        rank_hist = xskillscore.rank_histogram(                                                                                                                                                                                           
  1205 │       │       │       │        │       │               │       │            gt, p, member_dim=self.ens_dim, dim=self._agg_dims                                                                                                                                                                            
  1206 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
  1207 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1208 │       │       │       │        │       │               │       │        return rank_hist                                                                                                                                                                                                                  
  1209 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1210 │       │       │       │        │       │               │       │    @staticmethod                                                                                                                                                                                                                         
  1211 │       │       │       │        │       │               │       │    def calc_geo_spatial_diff(                                                                                                                                                                                                            
  1212 │       │       │       │        │       │               │       │        scalar_field: xr.DataArray,                                                                                                                                                                                                       
  1213 │       │       │       │        │       │               │       │        order: int = 1,                                                                                                                                                                                                                   
  1214 │       │       │       │        │       │               │       │        r_e: float = 6371.0e3,                                                                                                                                                                                                            
  1215 │       │       │       │        │       │               │       │        dom_avg: bool = True,                                                                                                                                                                                                             
  1216 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
  1217 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1218 │       │       │       │        │       │               │       │        Calculates the amplitude of the gradient (order=1) or the Laplacian (order=2)                                                                                                                                                     
  1219 │       │       │       │        │       │               │       │        of a scalar field given on a regular, geographical grid                                                                                                                                                                           
  1220 │       │       │       │        │       │               │       │        (i.e. dlambda = const. and dphi=const.)                                                                                                                                                                                           
  1221 │       │       │       │        │       │               │       │        :param scalar_field: scalar field as data array with latitude and longitude as coordinates                                                                                                                                        
  1222 │       │       │       │        │       │               │       │        :param order: order of spatial differential operator                                                                                                                                                                              
  1223 │       │       │       │        │       │               │       │        :param r_e: radius of the sphere                                                                                                                                                                                                  
  1224 │       │       │       │        │       │               │       │        :return: the amplitude of the gradient/laplacian at each grid point or over the whole domain (see dom_avg)                                                                                                                        
  1225 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
  1226 │       │       │       │        │       │               │       │        method = Scores.calc_geo_spatial_diff.__name__                                                                                                                                                                                    
  1227 │       │       │       │        │       │               │       │        # sanity checks                                                                                                                                                                                                                   
  1228 │       │       │       │        │       │               │       │        assert isinstance(scalar_field, xr.DataArray), (                                                                                                                                                                                  
  1229 │       │       │       │        │       │               │       │            f"Scalar_field of {method} must be a xarray DataArray."                                                                                                                                                                       
  1230 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
  1231 │       │       │       │        │       │               │       │        assert order in [1, 2], f"Order for {method} must be either 1 or 2."                                                                                                                                                              
  1232 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1233 │       │       │       │        │       │               │       │        dims = list(scalar_field.dims)                                                                                                                                                                                                    
  1234 │       │       │       │        │       │               │       │        lat_dims = ["rlat", "lat", "latitude"]                                                                                                                                                                                            
  1235 │       │       │       │        │       │               │       │        lon_dims = ["rlon", "lon", "longitude"]                                                                                                                                                                                           
  1236 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1237 │       │       │       │        │       │               │       │        def check_for_coords(coord_names_data, coord_names_expected):                                                                                                                                                                     
  1238 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
  1239 │       │       │       │        │       │               │       │                _ = coord_names_expected.index()                                                                                                                                                                                          
  1240 │       │       │       │        │       │               │       │            except ValueError as e:                                                                                                                                                                                                       
  1241 │       │       │       │        │       │               │       │                expected_names = ",".join(coord_names_expected)                                                                                                                                                                           
  1242 │       │       │       │        │       │               │       │                raise ValueError(                                                                                                                                                                                                         
  1243 │       │       │       │        │       │               │       │                    "Could not find one of the following coordinates in the"                                                                                                                                                              
  1244 │       │       │       │        │       │               │       │                    + f"passed dictionary: {expected_names}"                                                                                                                                                                              
  1245 │       │       │       │        │       │               │       │                ) from e                                                                                                                                                                                                                  
  1246 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1247 │       │       │       │        │       │               │       │        _, lat_name = check_for_coords(dims, lat_dims)                                                                                                                                                                                    
  1248 │       │       │       │        │       │               │       │        _, lon_name = check_for_coords(dims, lon_dims)                                                                                                                                                                                    
  1249 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1250 │       │       │       │        │       │               │       │        lat, lon = (                                                                                                                                                                                                                      
  1251 │       │       │       │        │       │               │       │            np.deg2rad(scalar_field[lat_name]),                                                                                                                                                                                           
  1252 │       │       │       │        │       │               │       │            np.deg2rad(scalar_field[lon_name]),                                                                                                                                                                                           
  1253 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
  1254 │       │       │       │        │       │               │       │        dphi, dlambda = lat[1].values - lat[0].values, lon[1].values - lon[0].values                                                                                                                                                      
  1255 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1256 │       │       │       │        │       │               │       │        if order == 1:                                                                                                                                                                                                                    
  1257 │       │       │       │        │       │               │       │            dvar_dlambda = (                                                                                                                                                                                                              
  1258 │       │       │       │        │       │               │       │                1.0                                                                                                                                                                                                                       
  1259 │       │       │       │        │       │               │       │                / (r_e * np.cos(lat) * dlambda)                                                                                                                                                                                           
  1260 │       │       │       │        │       │               │       │                * scalar_field.differentiate(lon_name)                                                                                                                                                                                    
  1261 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  1262 │       │       │       │        │       │               │       │            dvar_dphi = 1.0 / (r_e * dphi) * scalar_field.differentiate(lat_name)                                                                                                                                                         
  1263 │       │       │       │        │       │               │       │            dvar_dlambda = dvar_dlambda.transpose(                                                                                                                                                                                        
  1264 │       │       │       │        │       │               │       │                *scalar_field.dims                                                                                                                                                                                                        
  1265 │       │       │       │        │       │               │       │            )  # ensure that dimension ordering is not changed                                                                                                                                                                            
  1266 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1267 │       │       │       │        │       │               │       │            var_diff_amplitude = np.sqrt(dvar_dlambda**2 + dvar_dphi**2)                                                                                                                                                                  
  1268 │       │       │       │        │       │               │       │            if dom_avg:                                                                                                                                                                                                                   
  1269 │       │       │       │        │       │               │       │                var_diff_amplitude = var_diff_amplitude.mean(dim=[lat_name, lon_name])                                                                                                                                                    
  1270 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
  1271 │       │       │       │        │       │               │       │            raise ValueError(                                                                                                                                                                                                             
  1272 │       │       │       │        │       │               │       │                f"Second-order differentation is not implemenetd in {method} yet."                                                                                                                                                        
  1273 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
  1274 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
  1275 │       │       │       │        │       │               │       │        return var_diff_amplitude                                                                                                                                                                                                         
  1276 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
Top PEAK memory consumption, by line:
(1)    25:    20 MB                                                                                                                                                                                                                                                                                                 
                                                                       /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/utils.py: % of time =   2.25% (5.330s) out of 4m:56.410s.                                                                        
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/utils.py                                                                                                                       
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │# (C) Copyright 2025 WeatherGenerator contributors.                                                                                                                                                                                       
     2 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     3 │       │       │       │        │       │               │       │# This software is licensed under the terms of the Apache Licence Version 2.0                                                                                                                                                             
     4 │       │       │       │        │       │               │       │# which can be obtained at http://www.apache.org/licenses/LICENSE-2.0.                                                                                                                                                                    
     5 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     6 │       │       │       │        │       │               │       │# In applying this licence, ECMWF does not waive the privileges and immunities                                                                                                                                                            
     7 │       │       │       │        │       │               │       │# granted to it by virtue of its status as an intergovernmental organisation                                                                                                                                                              
     8 │       │       │       │        │       │               │       │# nor does it submit to any jurisdiction.                                                                                                                                                                                                 
     9 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    10 │       │       │       │        │       │               │       │import json                                                                                                                                                                                                                               
    11 │       │       │       │        │       │               │       │import logging                                                                                                                                                                                                                            
    12 │       │       │       │        │       │               │       │from pathlib import Path                                                                                                                                                                                                                  
    13 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    14 │       │       │       │        │       │               │       │import numpy as np                                                                                                                                                                                                                        
    15 │       │       │       │        │       │               │       │import omegaconf as oc                                                                                                                                                                                                                    
    16 │       │       │       │        │       │               │       │import xarray as xr                                                                                                                                                                                                                       
    17 │       │       │       │        │       │               │       │from tqdm import tqdm                                                                                                                                                                                                                     
    18 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    19 │       │       │       │        │       │               │       │from weathergen.evaluate.io_reader import Reader                                                                                                                                                                                          
    20 │       │       │       │        │       │               │       │from weathergen.evaluate.plot_utils import plot_metric_region                                                                                                                                                                             
    21 │       │       │       │        │       │               │       │from weathergen.evaluate.plotter import LinePlots, Plotter                                                                                                                                                                                
    22 │       │       │       │        │       │               │       │from weathergen.evaluate.score import VerifiedData, get_score                                                                                                                                                                             
    23 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    24 │       │       │       │        │       │               │       │_logger = logging.getLogger(__name__)                                                                                                                                                                                                     
    25 │       │       │       │        │       │               │       │_logger.setLevel(logging.INFO)                                                                                                                                                                                                            
    26 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    27 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    28 │       │       │       │        │       │               │       │def get_next_data(fstep, da_preds, da_tars, fsteps):                                                                                                                                                                                      
    29 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    30 │       │       │       │        │       │               │       │    Get the next forecast step data for the given forecast step.                                                                                                                                                                          
    31 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    32 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    33 │       │       │       │        │       │               │       │    fstep_idx = fsteps.index(fstep)                                                                                                                                                                                                       
    34 │       │       │       │        │       │               │       │    # Get the next forecast step                                                                                                                                                                                                          
    35 │       │       │       │        │       │               │       │    next_fstep = fsteps[fstep_idx + 1] if fstep_idx + 1 < len(fsteps) else None                                                                                                                                                           
    36 │       │       │       │        │       │               │       │    if next_fstep is not None:                                                                                                                                                                                                            
    37 │       │       │       │        │       │               │       │        preds_next = da_preds.get(next_fstep, None)                                                                                                                                                                                       
    38 │       │       │       │        │       │               │       │        tars_next = da_tars.get(next_fstep, None)                                                                                                                                                                                         
    39 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
    40 │       │       │       │        │       │               │       │        preds_next = None                                                                                                                                                                                                                 
    41 │       │       │       │        │       │               │       │        tars_next = None                                                                                                                                                                                                                  
    42 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    43 │       │       │       │        │       │               │       │    return preds_next, tars_next                                                                                                                                                                                                          
    44 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    45 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    46 │       │       │       │        │       │               │       │def calc_scores_per_stream(                                                                                                                                                                                                               
    47 │       │       │       │        │       │               │       │    reader: Reader, stream: str, region: str, metrics: list[str]                                                                                                                                                                          
    48 │       │       │       │        │       │               │       │) -> tuple[xr.DataArray, xr.DataArray]:                                                                                                                                                                                                   
    49 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    50 │       │       │       │        │       │               │       │    Calculate scores for a given run and stream using the specified metrics.                                                                                                                                                              
    51 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    52 │       │       │       │        │       │               │       │    Parameters                                                                                                                                                                                                                            
    53 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
    54 │       │       │       │        │       │               │       │    reader : Reader                                                                                                                                                                                                                       
    55 │       │       │       │        │       │               │       │        Reader object containing all info about a particular run.                                                                                                                                                                         
    56 │       │       │       │        │       │               │       │    stream :                                                                                                                                                                                                                              
    57 │       │       │       │        │       │               │       │        Stream name to calculate scores for.                                                                                                                                                                                              
    58 │       │       │       │        │       │               │       │    region :                                                                                                                                                                                                                              
    59 │       │       │       │        │       │               │       │        Region name to calculate scores for.                                                                                                                                                                                              
    60 │       │       │       │        │       │               │       │    metrics :                                                                                                                                                                                                                             
    61 │       │       │       │        │       │               │       │        List of metric names to calculate.                                                                                                                                                                                                
    62 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    63 │       │       │       │        │       │               │       │    Returns                                                                                                                                                                                                                               
    64 │       │       │       │        │       │               │       │    -------                                                                                                                                                                                                                               
    65 │       │       │       │        │       │               │       │    Tuple of xarray DataArray containing the scores and the number of points per sample.                                                                                                                                                  
    66 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    67 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    68 │       │       │       │        │       │               │       │    _logger.info(                                                                                                                                                                                                                         
    69 │       │       │       │        │       │               │       │        f"RUN {reader.run_id} - {stream}: Calculating scores for metrics {metrics}..."                                                                                                                                                    
    70 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
    71 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    72 │       │       │       │        │       │               │       │    available_data = reader.check_availability(stream, mode="evaluation")                                                                                                                                                                 
    73 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    74 │       │       │       │        │       │               │       │    output_data = reader.get_data(                                                                                                                                                                                                        
    75 │       │       │       │        │       │               │       │        stream,                                                                                                                                                                                                                           
    76 │       │       │       │        │       │               │       │        region=region,                                                                                                                                                                                                                    
    77 │       │       │       │        │       │               │       │        fsteps=available_data.fsteps,                                                                                                                                                                                                     
    78 │       │       │       │        │       │               │       │        samples=available_data.samples,                                                                                                                                                                                                   
    79 │       │       │       │        │       │               │       │        channels=available_data.channels,                                                                                                                                                                                                 
    80 │       │       │       │        │       │               │       │        return_counts=True,                                                                                                                                                                                                               
    81 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
    82 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    83 │       │       │       │        │       │               │       │    da_preds = output_data.prediction                                                                                                                                                                                                     
    84 │       │       │       │        │       │               │       │    da_tars = output_data.target                                                                                                                                                                                                          
    85 │       │       │       │        │       │               │       │    points_per_sample = output_data.points_per_sample                                                                                                                                                                                     
    86 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    87 │       │       │       │        │       │               │       │    # get coordinate information from retrieved data                                                                                                                                                                                      
    88 │       │       │       │        │       │               │       │    fsteps = [int(k) for k in da_tars.keys()]                                                                                                                                                                                             
    89 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    90 │       │       │       │        │       │               │       │    first_da = list(da_preds.values())[0]                                                                                                                                                                                                 
    91 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    92 │       │       │       │        │       │               │       │    # TODO: improve the way we handle samples.                                                                                                                                                                                            
    93 │       │       │       │        │       │               │       │    samples = list(np.atleast_1d(np.unique(first_da.sample.values)))                                                                                                                                                                      
    94 │       │       │       │        │       │               │       │    channels = list(np.atleast_1d(first_da.channel.values))                                                                                                                                                                               
    95 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    96 │       │       │       │        │       │               │       │    metric_list = []                                                                                                                                                                                                                      
    97 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    98 │       │       │       │        │       │               │       │    metric_stream = xr.DataArray(                                                                                                                                                                                                         
    99 │       │       │       │        │       │               │       │        np.full(                                                                                                                                                                                                                          
   100 │       │       │       │        │       │               │       │            (len(samples), len(fsteps), len(channels), len(metrics)),                                                                                                                                                                     
   101 │       │       │       │        │       │               │       │            np.nan,                                                                                                                                                                                                                       
   102 │       │       │       │        │       │               │       │        ),                                                                                                                                                                                                                                
   103 │       │       │       │        │       │               │       │        coords={                                                                                                                                                                                                                          
   104 │       │       │       │        │       │               │       │            "sample": samples,                                                                                                                                                                                                            
   105 │       │       │       │        │       │               │       │            "forecast_step": fsteps,                                                                                                                                                                                                      
   106 │       │       │       │        │       │               │       │            "channel": channels,                                                                                                                                                                                                          
   107 │       │       │       │        │       │               │       │            "metric": metrics,                                                                                                                                                                                                            
   108 │       │       │       │        │       │               │       │        },                                                                                                                                                                                                                                
   109 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
   110 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   111 │       │       │       │        │       │               │       │    for (fstep, tars), (_, preds) in zip(                                                                                                                                                                                                 
   112 │       │       │       │        │       │               │       │        da_tars.items(), da_preds.items(), strict=False                                                                                                                                                                                   
   113 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   114 │       │       │       │        │       │               │       │        _logger.debug(f"Verifying data for stream {stream}...")                                                                                                                                                                           
   115 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   116 │       │       │       │        │       │               │       │        preds_next, tars_next = get_next_data(fstep, da_preds, da_tars, fsteps)                                                                                                                                                           
   117 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   118 │       │       │       │        │       │               │       │        if preds.ipoint.size > 0:                                                                                                                                                                                                         
   119 │       │       │       │        │       │               │       │            score_data = VerifiedData(preds, tars, preds_next, tars_next)                                                                                                                                                                 
   120 │       │       │       │        │       │               │       │            # Build up computation graphs for all metrics                                                                                                                                                                                 
   121 │       │       │       │        │       │               │       │            _logger.debug(                                                                                                                                                                                                                
   122 │       │       │       │        │       │               │       │                f"Build computation graphs for metrics for stream {stream}..."                                                                                                                                                            
   123 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   124 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   125 │       │       │       │        │       │               │       │            combined_metrics = [                                                                                                                                                                                                          
   126 │       │       │       │        │       │               │       │                get_score(                                                                                                                                                                                                                
   127 │       │       │       │        │       │               │       │                    score_data,                                                                                                                                                                                                           
   128 │       │       │       │        │       │               │       │                    metric,                                                                                                                                                                                                               
   129 │       │       │       │        │       │               │       │                    agg_dims="ipoint",                                                                                                                                                                                                    
   130 │       │       │       │        │       │               │       │                    group_by_coord="sample",                                                                                                                                                                                              
   131 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   132 │       │       │       │        │       │               │       │                for metric in metrics                                                                                                                                                                                                     
   133 │       │       │       │        │       │               │       │            ]                                                                                                                                                                                                                             
   134 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   135 │       │       │       │        │       │               │       │            combined_metrics = xr.concat(combined_metrics, dim="metric")                                                                                                                                                                  
   136 │       │       │       │        │       │               │       │            combined_metrics["metric"] = metrics                                                                                                                                                                                          
   137 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   138 │       │       │       │        │       │               │       │            _logger.debug(f"Running computation of metrics for stream {stream}...")                                                                                                                                                       
   139 │       │       │       │        │       │               │       │            combined_metrics = combined_metrics.compute()                                                                                                                                                                                 
   140 │       │       │       │        │       │               │       │            combined_metrics = scalar_coord_to_dim(combined_metrics, "channel")                                                                                                                                                           
   141 │       │       │       │        │       │               │       │            combined_metrics = scalar_coord_to_dim(combined_metrics, "sample")                                                                                                                                                            
   142 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   143 │       │       │       │        │       │               │       │            # depending on the datset, there might be no data (e.g. no CERRA in southern hemisphere region)                                                                                                                               
   144 │       │       │       │        │       │               │       │            _logger.warning(                                                                                                                                                                                                              
   145 │       │       │       │        │       │               │       │                f"No data available for stream {stream} at forecast step {fstep} in region {region}. Skipping metrics calculation."                                                                                                       
   146 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   147 │       │       │       │        │       │               │       │            continue                                                                                                                                                                                                                      
   148 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   149 │       │       │       │        │       │               │       │        metric_list.append(combined_metrics)                                                                                                                                                                                              
   150 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   151 │       │       │       │        │       │               │       │        metric_stream.loc[{"forecast_step": int(fstep)}] = combined_metrics                                                                                                                                                               
   152 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   153 │       │       │       │        │       │               │       │    _logger.info(f"Scores for run {reader.run_id} - {stream} calculated successfully.")                                                                                                                                                   
   154 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   155 │       │       │       │        │       │               │       │    metric_stream = xr.concat(metric_list, dim="forecast_step")                                                                                                                                                                           
   156 │       │       │       │        │       │               │       │    metric_stream = metric_stream.assign_coords({"forecast_step": fsteps})                                                                                                                                                                
   157 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   158 │       │       │       │        │       │               │       │    return metric_stream, points_per_sample                                                                                                                                                                                               
   159 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   160 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   161 │       │       │       │        │       │               │       │def plot_data(reader: Reader, stream: str, global_plotting_opts: dict) -> list[str]:                                                                                                                                                      
   162 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   163 │       │       │       │        │       │               │       │    Plot the data for a given run and stream.                                                                                                                                                                                             
   164 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   165 │       │       │       │        │       │               │       │    Parameters                                                                                                                                                                                                                            
   166 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
   167 │       │       │       │        │       │               │       │    reader: Reader                                                                                                                                                                                                                        
   168 │       │       │       │        │       │               │       │        Reader object containing all infos about the run                                                                                                                                                                                  
   169 │       │       │       │        │       │               │       │    stream: str                                                                                                                                                                                                                           
   170 │       │       │       │        │       │               │       │        Stream name to plot data for.                                                                                                                                                                                                     
   171 │       │       │       │        │       │               │       │    global_plotting_opts: dict                                                                                                                                                                                                            
   172 │       │       │       │        │       │               │       │        Dictionary containing all plotting options that apply globally to all run_ids                                                                                                                                                     
   173 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   174 │       │       │       │        │       │               │       │    Returns                                                                                                                                                                                                                               
   175 │       │       │       │        │       │               │       │    -------                                                                                                                                                                                                                               
   176 │       │       │       │        │       │               │       │    List of plot names generated during the plotting process.                                                                                                                                                                             
   177 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   178 │       │       │       │        │       │               │       │    run_id = reader.run_id                                                                                                                                                                                                                
   179 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   180 │       │       │       │        │       │               │       │    # get stream dict from evaluation config (assumed to be part of cfg at this point)                                                                                                                                                    
   181 │       │       │       │        │       │               │       │    stream_cfg = reader.get_stream(stream)                                                                                                                                                                                                
   182 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   183 │       │       │       │        │       │               │       │    # handle plotting settings                                                                                                                                                                                                            
   184 │       │       │       │        │       │               │       │    plot_settings = stream_cfg.get("plotting", {})                                                                                                                                                                                        
   185 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   186 │       │       │       │        │       │               │       │    # return early if no plotting is requested                                                                                                                                                                                            
   187 │       │       │       │        │       │               │       │    if not (                                                                                                                                                                                                                              
   188 │       │       │       │        │       │               │       │        plot_settings                                                                                                                                                                                                                     
   189 │       │       │       │        │       │               │       │        and (                                                                                                                                                                                                                             
   190 │       │       │       │        │       │               │       │            plot_settings.get("plot_maps", False)                                                                                                                                                                                         
   191 │       │       │       │        │       │               │       │            or plot_settings.get("plot_histograms", False)                                                                                                                                                                                
   192 │       │       │       │        │       │               │       │            or plot_settings.get("plot_animations", False)                                                                                                                                                                                
   193 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   194 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   195 │       │       │       │        │       │               │       │        return                                                                                                                                                                                                                            
   196 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   197 │       │       │       │        │       │               │       │    plotter_cfg = {                                                                                                                                                                                                                       
   198 │       │       │       │        │       │               │       │        "image_format": global_plotting_opts.get("image_format", "png"),                                                                                                                                                                  
   199 │       │       │       │        │       │               │       │        "dpi_val": global_plotting_opts.get("dpi_val", 300),                                                                                                                                                                              
   200 │       │       │       │        │       │               │       │        "fig_size": global_plotting_opts.get("fig_size", (8, 10)),                                                                                                                                                                        
   201 │       │       │       │        │       │               │       │        "plot_subtimesteps": reader.get_inference_stream_attr(                                                                                                                                                                            
   202 │       │       │       │        │       │               │       │            stream, "tokenize_spacetime", False                                                                                                                                                                                           
   203 │       │       │       │        │       │               │       │        ),                                                                                                                                                                                                                                
   204 │       │       │       │        │       │               │       │    }                                                                                                                                                                                                                                     
   205 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   206 │       │       │       │        │       │               │       │    plotter = Plotter(plotter_cfg, reader.runplot_dir)                                                                                                                                                                                    
   207 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   208 │       │       │       │        │       │               │       │    available_data = reader.check_availability(stream, mode="plotting")                                                                                                                                                                   
   209 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   210 │       │       │       │        │       │               │       │    # Check if maps should be plotted and handle configuration if provided                                                                                                                                                                
   211 │       │       │       │        │       │               │       │    plot_maps = plot_settings.get("plot_maps", False)                                                                                                                                                                                     
   212 │       │       │       │        │       │               │       │    if not isinstance(plot_maps, bool):                                                                                                                                                                                                   
   213 │       │       │       │        │       │               │       │        raise TypeError("plot_maps must be a boolean.")                                                                                                                                                                                   
   214 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   215 │       │       │       │        │       │               │       │    # Check if histograms should be plotted                                                                                                                                                                                               
   216 │       │       │       │        │       │               │       │    plot_histograms = plot_settings.get("plot_histograms", False)                                                                                                                                                                         
   217 │       │       │       │        │       │               │       │    if not isinstance(plot_histograms, bool):                                                                                                                                                                                             
   218 │       │       │       │        │       │               │       │        raise TypeError("plot_histograms must be a boolean.")                                                                                                                                                                             
   219 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   220 │       │       │       │        │       │               │       │    plot_animations = plot_settings.get("plot_animations", False)                                                                                                                                                                         
   221 │       │       │       │        │       │               │       │    if not isinstance(plot_animations, bool):                                                                                                                                                                                             
   222 │       │       │       │        │       │               │       │        raise TypeError("plot_animations must be a boolean.")                                                                                                                                                                             
   223 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   224 │       │       │       │        │       │               │       │    model_output = reader.get_data(                                                                                                                                                                                                       
   225 │       │       │       │        │       │               │       │        stream,                                                                                                                                                                                                                           
   226 │       │       │       │        │       │               │       │        samples=available_data.samples,                                                                                                                                                                                                   
   227 │       │       │       │        │       │               │       │        fsteps=available_data.fsteps,                                                                                                                                                                                                     
   228 │       │       │       │        │       │               │       │        channels=available_data.channels,                                                                                                                                                                                                 
   229 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
   230 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   231 │       │       │       │        │       │               │       │    da_tars = model_output.target                                                                                                                                                                                                         
   232 │       │       │       │        │       │               │       │    da_preds = model_output.prediction                                                                                                                                                                                                    
   233 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   234 │       │       │       │        │       │               │       │    if not da_tars:                                                                                                                                                                                                                       
   235 │       │       │       │        │       │               │       │        _logger.info(f"Skipping Plot Data for {stream}. Targets are empty.")                                                                                                                                                              
   236 │       │       │       │        │       │               │       │        return                                                                                                                                                                                                                            
   237 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   238 │       │       │       │        │       │               │       │    # get common ranges across all run_ids                                                                                                                                                                                                
   239 │       │       │       │        │       │               │       │    if not isinstance(global_plotting_opts.get(stream), oc.DictConfig):                                                                                                                                                                   
   240 │       │       │       │        │       │               │       │        global_plotting_opts[stream] = oc.DictConfig({})                                                                                                                                                                                  
   241 │       │       │       │        │       │               │       │    maps_config = common_ranges(                                                                                                                                                                                                          
   242 │       │       │       │        │       │               │       │        da_tars, da_preds, available_data.channels, global_plotting_opts[stream]                                                                                                                                                          
   243 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
   244 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   245 │       │       │       │        │       │               │       │    plot_names = []                                                                                                                                                                                                                       
   246 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   247 │       │       │       │        │       │               │       │    for (fstep, tars), (_, preds) in zip(                                                                                                                                                                                                 
   248 │       │       │       │        │       │               │       │        da_tars.items(), da_preds.items(), strict=False                                                                                                                                                                                   
   249 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   250 │       │       │       │        │       │               │       │        plot_chs = list(np.atleast_1d(tars.channel.values))                                                                                                                                                                               
   251 │       │       │       │        │       │               │       │        plot_samples = list(np.unique(tars.sample.values))                                                                                                                                                                                
   252 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   253 │       │       │       │        │       │               │       │        for sample in tqdm(                                                                                                                                                                                                               
   254 │       │       │       │        │       │               │       │            plot_samples, desc=f"Plotting {run_id} - {stream} - fstep {fstep}"                                                                                                                                                            
   255 │       │       │       │        │       │               │       │        ):                                                                                                                                                                                                                                
   256 │       │       │       │        │       │               │       │            plots = []                                                                                                                                                                                                                    
   257 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   258 │       │       │       │        │       │               │       │            data_selection = {                                                                                                                                                                                                            
   259 │       │       │       │        │       │               │       │                "sample": sample,                                                                                                                                                                                                         
   260 │       │       │       │        │       │               │       │                "stream": stream,                                                                                                                                                                                                         
   261 │       │       │       │        │       │               │       │                "forecast_step": fstep,                                                                                                                                                                                                   
   262 │       │       │       │        │       │               │       │            }                                                                                                                                                                                                                             
   263 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   264 │       │       │       │        │       │               │       │            if plot_maps:                                                                                                                                                                                                                 
   265 │       │       │       │        │       │               │       │                map_tar = plotter.create_maps_per_sample(                                                                                                                                                                                 
   266 │       │       │       │        │       │               │       │                    tars, plot_chs, data_selection, "targets", maps_config                                                                                                                                                                
   267 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   268 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   269 │       │       │       │        │       │               │       │                map_pred = plotter.create_maps_per_sample(                                                                                                                                                                                
   270 │       │       │       │        │       │               │       │                    preds, plot_chs, data_selection, "preds", maps_config                                                                                                                                                                 
   271 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   272 │       │       │       │        │       │               │       │                plots.extend([map_tar, map_pred])                                                                                                                                                                                         
   273 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   274 │       │       │       │        │       │               │       │            if plot_histograms:                                                                                                                                                                                                           
   275 │       │       │       │        │       │               │       │                h = plotter.create_histograms_per_sample(                                                                                                                                                                                 
   276 │       │       │       │        │       │               │       │                    tars, preds, plot_chs, data_selection                                                                                                                                                                                 
   277 │       │       │       │        │       │               │       │                )                                                                                                                                                                                                                         
   278 │       │       │       │        │       │               │       │                plots.append(h)                                                                                                                                                                                                           
   279 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   280 │       │       │       │        │       │               │       │            plotter = plotter.clean_data_selection()                                                                                                                                                                                      
   281 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   282 │       │       │       │        │       │               │       │            plot_names.append(plots)                                                                                                                                                                                                      
   283 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   284 │       │       │       │        │       │               │       │    if plot_animations:                                                                                                                                                                                                                   
   285 │       │       │       │        │       │               │       │        plot_fsteps = da_tars.keys()                                                                                                                                                                                                      
   286 │       │       │       │        │       │               │       │        h = plotter.animation(                                                                                                                                                                                                            
   287 │       │       │       │        │       │               │       │            plot_samples, plot_fsteps, plot_chs, data_selection, "preds"                                                                                                                                                                  
   288 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   289 │       │       │       │        │       │               │       │        h = plotter.animation(                                                                                                                                                                                                            
   290 │       │       │       │        │       │               │       │            plot_samples, plot_fsteps, plot_chs, data_selection, "targets"                                                                                                                                                                
   291 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   292 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   293 │       │       │       │        │       │               │       │    return plot_names                                                                                                                                                                                                                     
   294 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   295 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   296 │       │       │       │        │       │               │       │def metric_list_to_json(                                                                                                                                                                                                                  
   297 │       │       │       │        │       │               │       │    reader: Reader,                                                                                                                                                                                                                       
   298 │       │       │       │        │       │               │       │    metrics_list: list[xr.DataArray],                                                                                                                                                                                                     
   299 │       │       │       │        │       │               │       │    npoints_sample_list: list[xr.DataArray],                                                                                                                                                                                              
   300 │       │       │       │        │       │               │       │    streams: list[str],                                                                                                                                                                                                                   
   301 │       │       │       │        │       │               │       │    region: str,                                                                                                                                                                                                                          
   302 │       │       │       │        │       │               │       │):                                                                                                                                                                                                                                        
   303 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   304 │       │       │       │        │       │               │       │    Write the evaluation results collected in a list of xarray DataArrays for the metrics                                                                                                                                                 
   305 │       │       │       │        │       │               │       │    to stream- and metric-specific JSON files.                                                                                                                                                                                            
   306 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   307 │       │       │       │        │       │               │       │    Parameters                                                                                                                                                                                                                            
   308 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
   309 │       │       │       │        │       │               │       │    reader:                                                                                                                                                                                                                               
   310 │       │       │       │        │       │               │       │        Reader object containing all info about the run_id.                                                                                                                                                                               
   311 │       │       │       │        │       │               │       │    metrics_list :                                                                                                                                                                                                                        
   312 │       │       │       │        │       │               │       │        Metrics per stream.                                                                                                                                                                                                               
   313 │       │       │       │        │       │               │       │    npoints_sample_list :                                                                                                                                                                                                                 
   314 │       │       │       │        │       │               │       │        Number of points per sample per stream.                                                                                                                                                                                           
   315 │       │       │       │        │       │               │       │    streams :                                                                                                                                                                                                                             
   316 │       │       │       │        │       │               │       │        Stream names.                                                                                                                                                                                                                     
   317 │       │       │       │        │       │               │       │    region :                                                                                                                                                                                                                              
   318 │       │       │       │        │       │               │       │        Region name.                                                                                                                                                                                                                      
   319 │       │       │       │        │       │               │       │    metric_dir :                                                                                                                                                                                                                          
   320 │       │       │       │        │       │               │       │        Output directory.                                                                                                                                                                                                                 
   321 │       │       │       │        │       │               │       │    run_id :                                                                                                                                                                                                                              
   322 │       │       │       │        │       │               │       │        Identifier of the inference run.                                                                                                                                                                                                  
   323 │       │       │       │        │       │               │       │    epoch :                                                                                                                                                                                                                               
   324 │       │       │       │        │       │               │       │        Epoch number.                                                                                                                                                                                                                     
   325 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   326 │       │       │       │        │       │               │       │    assert len(metrics_list) == len(npoints_sample_list) == len(streams), (                                                                                                                                                               
   327 │       │       │       │        │       │               │       │        "The lengths of metrics_list, npoints_sample_list, and streams must be the same."                                                                                                                                                 
   328 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
   329 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   330 │       │       │       │        │       │               │       │    reader.metrics_dir.mkdir(parents=True, exist_ok=True)                                                                                                                                                                                 
   331 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   332 │       │       │       │        │       │               │       │    for s_idx, stream in enumerate(streams):                                                                                                                                                                                              
   333 │       │       │       │        │       │               │       │        metrics_stream, npoints_sample_stream = (                                                                                                                                                                                         
   334 │       │       │       │        │       │               │       │            metrics_list[s_idx],                                                                                                                                                                                                          
   335 │       │       │       │        │       │               │       │            npoints_sample_list[s_idx],                                                                                                                                                                                                   
   336 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   337 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   338 │       │       │       │        │       │               │       │        for metric in metrics_stream.coords["metric"].values:                                                                                                                                                                             
   339 │       │       │       │        │       │               │       │            metric_now = metrics_stream.sel(metric=metric)                                                                                                                                                                                
   340 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   341 │       │       │       │        │       │               │       │            # Save as individual DataArray, not Dataset                                                                                                                                                                                   
   342 │       │       │       │        │       │               │       │            metric_now.attrs["npoints_per_sample"] = (                                                                                                                                                                                    
   343 │       │       │       │        │       │               │       │                npoints_sample_stream.values.tolist()                                                                                                                                                                                     
   344 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   345 │       │       │       │        │       │               │       │            metric_dict = metric_now.to_dict()                                                                                                                                                                                            
   346 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   347 │       │       │       │        │       │               │       │            # Match the expected filename pattern                                                                                                                                                                                         
   348 │       │       │       │        │       │               │       │            save_path = (                                                                                                                                                                                                                 
   349 │       │       │       │        │       │               │       │                reader.metrics_dir                                                                                                                                                                                                        
   350 │       │       │       │        │       │               │       │                / f"{reader.run_id}_{stream}_{region}_{metric}_epoch{reader.epoch:05d}.json"                                                                                                                                              
   351 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   352 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   353 │       │       │       │        │       │               │       │            _logger.info(f"Saving results to {save_path}")                                                                                                                                                                                
   354 │       │       │       │        │       │               │       │            with open(save_path, "w") as f:                                                                                                                                                                                               
   355 │       │       │       │        │       │               │       │                json.dump(metric_dict, f, indent=4)                                                                                                                                                                                       
   356 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   357 │       │       │       │        │       │               │       │    _logger.info(                                                                                                                                                                                                                         
   358 │       │       │       │        │       │               │       │        f"Saved all results of inference run {reader.run_id} - epoch {reader.epoch:d} successfully to {reader.metrics_dir}."                                                                                                              
   359 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
   360 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   361 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   362 │       │       │       │        │       │               │       │def retrieve_metric_from_json(reader: Reader, stream: str, region: str, metric: str):                                                                                                                                                     
   363 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   364 │       │       │       │        │       │               │       │    Retrieve the score for a given run, stream, metric, epoch, and rank from a JSON file.                                                                                                                                                 
   365 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   366 │       │       │       │        │       │               │       │    Parameters                                                                                                                                                                                                                            
   367 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
   368 │       │       │       │        │       │               │       │    reader :                                                                                                                                                                                                                              
   369 │       │       │       │        │       │               │       │        Reader object containing all info for a specific run_id                                                                                                                                                                           
   370 │       │       │       │        │       │               │       │    stream :                                                                                                                                                                                                                              
   371 │       │       │       │        │       │               │       │        Stream name.                                                                                                                                                                                                                      
   372 │       │       │       │        │       │               │       │    region :                                                                                                                                                                                                                              
   373 │       │       │       │        │       │               │       │        Region name.                                                                                                                                                                                                                      
   374 │       │       │       │        │       │               │       │    metric :                                                                                                                                                                                                                              
   375 │       │       │       │        │       │               │       │        Metric name.                                                                                                                                                                                                                      
   376 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   377 │       │       │       │        │       │               │       │    Returns                                                                                                                                                                                                                               
   378 │       │       │       │        │       │               │       │    -------                                                                                                                                                                                                                               
   379 │       │       │       │        │       │               │       │    xr.DataArray                                                                                                                                                                                                                          
   380 │       │       │       │        │       │               │       │        The metric DataArray.                                                                                                                                                                                                             
   381 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   382 │       │       │       │        │       │               │       │    score_path = (                                                                                                                                                                                                                        
   383 │       │       │       │        │       │               │       │        Path(reader.metrics_dir)                                                                                                                                                                                                          
   384 │       │       │       │        │       │               │       │        / f"{reader.run_id}_{stream}_{region}_{metric}_epoch{reader.epoch:05d}.json"                                                                                                                                                      
   385 │       │       │       │        │       │               │       │    )                                                                                                                                                                                                                                     
   386 │       │       │       │        │       │               │       │    _logger.debug(f"Looking for: {score_path}")                                                                                                                                                                                           
   387 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   388 │       │       │       │        │       │               │       │    if score_path.exists():                                                                                                                                                                                                               
   389 │       │       │       │        │       │               │       │        with open(score_path) as f:                                                                                                                                                                                                       
   390 │       │       │       │        │       │               │       │            data_dict = json.load(f)                                                                                                                                                                                                      
   391 │       │       │   2%  │ 100%   │   10M │▁   2%         │       │            return xr.DataArray.from_dict(data_dict)                                                                                                                                                                                      
   392 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
   393 │       │       │       │        │       │               │       │        raise FileNotFoundError(f"File {score_path} not found in the archive.")                                                                                                                                                           
   394 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   395 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   396 │       │       │       │        │       │               │       │def plot_summary(cfg: dict, scores_dict: dict, summary_dir: Path):                                                                                                                                                                        
   397 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   398 │       │       │       │        │       │               │       │    Plot summary of the evaluation results.                                                                                                                                                                                               
   399 │       │       │       │        │       │               │       │    This function is a placeholder for future implementation.                                                                                                                                                                             
   400 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   401 │       │       │       │        │       │               │       │    Parameters                                                                                                                                                                                                                            
   402 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
   403 │       │       │       │        │       │               │       │    cfg :                                                                                                                                                                                                                                 
   404 │       │       │       │        │       │               │       │        Configuration dictionary containing all information for the evaluation.                                                                                                                                                           
   405 │       │       │       │        │       │               │       │    scores_dict :                                                                                                                                                                                                                         
   406 │       │       │       │        │       │               │       │        Dictionary containing scores for each metric and stream.                                                                                                                                                                          
   407 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   408 │       │       │       │        │       │               │       │    _logger.info("Plotting summary of evaluation results...")                                                                                                                                                                             
   409 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   410 │       │       │       │        │       │               │       │    runs = cfg.run_ids                                                                                                                                                                                                                    
   411 │       │       │       │        │       │               │       │    metrics = cfg.evaluation.metrics                                                                                                                                                                                                      
   412 │       │       │       │        │       │               │       │    print_summary = cfg.evaluation.get("print_summary", False)                                                                                                                                                                            
   413 │       │       │       │        │       │               │       │    regions = cfg.evaluation.get("regions", ["global"])                                                                                                                                                                                   
   414 │       │       │       │        │       │               │       │    plt_opt = cfg.get("global_plotting_options", {})                                                                                                                                                                                      
   415 │       │       │       │        │       │               │       │    eval_opt = cfg.get("evaluation", {})                                                                                                                                                                                                  
   416 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   417 │       │       │       │        │       │               │       │    plot_cfg = {                                                                                                                                                                                                                          
   418 │       │       │       │        │       │               │       │        "image_format": plt_opt.get("image_format", "png"),                                                                                                                                                                               
   419 │       │       │       │        │       │               │       │        "dpi_val": plt_opt.get("dpi_val", 300),                                                                                                                                                                                           
   420 │       │       │       │        │       │               │       │        "fig_size": plt_opt.get("fig_size", (8, 10)),                                                                                                                                                                                     
   421 │       │       │       │        │       │               │       │        "log_scale": eval_opt.get("log_scale", False),                                                                                                                                                                                    
   422 │       │       │       │        │       │               │       │        "add_grid": eval_opt.get("add_grid", False),                                                                                                                                                                                      
   423 │       │       │       │        │       │               │       │    }                                                                                                                                                                                                                                     
   424 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   425 │       │       │       │        │       │               │       │    plotter = LinePlots(plot_cfg, summary_dir)                                                                                                                                                                                            
   426 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   427 │       │       │       │        │       │               │       │    for region in regions:                                                                                                                                                                                                                
   428 │       │       │       │        │       │               │       │        for metric in metrics:                                                                                                                                                                                                            
   429 │       │       │       │        │       │               │       │            plot_metric_region(                                                                                                                                                                                                           
   430 │       │       │       │        │       │               │       │                metric, region, runs, scores_dict, plotter, print_summary                                                                                                                                                                 
   431 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   432 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   433 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   434 │       │       │       │        │       │               │       │############# Utility functions ############                                                                                                                                                                                              
   435 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   436 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   437 │       │       │       │        │       │               │       │def common_ranges(                                                                                                                                                                                                                        
   438 │       │       │       │        │       │               │       │    data_tars: list[dict],                                                                                                                                                                                                                
   439 │       │       │       │        │       │               │       │    data_preds: list[dict],                                                                                                                                                                                                               
   440 │       │       │       │        │       │               │       │    plot_chs: list[str],                                                                                                                                                                                                                  
   441 │       │       │       │        │       │               │       │    maps_config: oc.dictconfig.DictConfig,                                                                                                                                                                                                
   442 │       │       │       │        │       │               │       │) -> oc.dictconfig.DictConfig:                                                                                                                                                                                                            
   443 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   444 │       │       │       │        │       │               │       │    Calculate common ranges per stream and variables.                                                                                                                                                                                     
   445 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   446 │       │       │       │        │       │               │       │    Parameters                                                                                                                                                                                                                            
   447 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
   448 │       │       │       │        │       │               │       │    data_tars :                                                                                                                                                                                                                           
   449 │       │       │       │        │       │               │       │        the (target) list of dictionaries with the forecasteps and respective xarray                                                                                                                                                      
   450 │       │       │       │        │       │               │       │    data_preds :                                                                                                                                                                                                                          
   451 │       │       │       │        │       │               │       │        the (prediction) list of dictionaries with the forecasteps and respective xarray                                                                                                                                                  
   452 │       │       │       │        │       │               │       │    plot_chs:                                                                                                                                                                                                                             
   453 │       │       │       │        │       │               │       │        the variables to be plotted as given by the configuration file                                                                                                                                                                    
   454 │       │       │       │        │       │               │       │    maps_config:                                                                                                                                                                                                                          
   455 │       │       │       │        │       │               │       │        the global plotting configuration                                                                                                                                                                                                 
   456 │       │       │       │        │       │               │       │    Returns                                                                                                                                                                                                                               
   457 │       │       │       │        │       │               │       │    -------                                                                                                                                                                                                                               
   458 │       │       │       │        │       │               │       │    maps_config :                                                                                                                                                                                                                         
   459 │       │       │       │        │       │               │       │        the global plotting configuration with the ranges added and included for each variable (and for each stream).                                                                                                                     
   460 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   461 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   462 │       │       │       │        │       │               │       │    for var in plot_chs:                                                                                                                                                                                                                  
   463 │       │       │       │        │       │               │       │        if var in maps_config:                                                                                                                                                                                                            
   464 │       │       │       │        │       │               │       │            if not isinstance(maps_config[var].get("vmax"), (int | float)):                                                                                                                                                               
   465 │       │       │       │        │       │               │       │                list_max = calc_bounds(data_tars, data_preds, var, "max")                                                                                                                                                                 
   466 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   467 │       │       │       │        │       │               │       │                maps_config[var].update({"vmax": float(max(list_max))})                                                                                                                                                                   
   468 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   469 │       │       │       │        │       │               │       │            if not isinstance(maps_config[var].get("vmin"), (int | float)):                                                                                                                                                               
   470 │       │       │       │        │       │               │       │                list_min = calc_bounds(data_tars, data_preds, var, "min")                                                                                                                                                                 
   471 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   472 │       │       │       │        │       │               │       │                maps_config[var].update({"vmin": float(min(list_min))})                                                                                                                                                                   
   473 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   474 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   475 │       │       │       │        │       │               │       │            list_max = calc_bounds(data_tars, data_preds, var, "max")                                                                                                                                                                     
   476 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   477 │       │       │       │        │       │               │       │            list_min = calc_bounds(data_tars, data_preds, var, "min")                                                                                                                                                                     
   478 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   479 │       │       │       │        │       │               │       │            maps_config.update(                                                                                                                                                                                                           
   480 │       │       │       │        │       │               │       │                {var: {"vmax": float(max(list_max)), "vmin": float(min(list_min))}}                                                                                                                                                       
   481 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   482 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   483 │       │       │       │        │       │               │       │    return maps_config                                                                                                                                                                                                                    
   484 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   485 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   486 │       │       │       │        │       │               │       │def calc_val(x: xr.DataArray, bound: str) -> list[float]:                                                                                                                                                                                 
   487 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   488 │       │       │       │        │       │               │       │    Calculate the maximum or minimum value per variable for all forecasteps.                                                                                                                                                              
   489 │       │       │       │        │       │               │       │    Parameters                                                                                                                                                                                                                            
   490 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
   491 │       │       │       │        │       │               │       │    x :                                                                                                                                                                                                                                   
   492 │       │       │       │        │       │               │       │        the xarray DataArray with the forecasteps and respective values                                                                                                                                                                   
   493 │       │       │       │        │       │               │       │    bound :                                                                                                                                                                                                                               
   494 │       │       │       │        │       │               │       │        the bound to be calculated, either "max" or "min"                                                                                                                                                                                 
   495 │       │       │       │        │       │               │       │    Returns                                                                                                                                                                                                                               
   496 │       │       │       │        │       │               │       │    -------                                                                                                                                                                                                                               
   497 │       │       │       │        │       │               │       │        a list with the maximum or minimum values for a specific variable.                                                                                                                                                                
   498 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   499 │       │       │       │        │       │               │       │    if bound == "max":                                                                                                                                                                                                                    
   500 │       │       │       │        │       │               │       │        return x.max(dim=("ipoint")).values                                                                                                                                                                                               
   501 │       │       │       │        │       │               │       │    elif bound == "min":                                                                                                                                                                                                                  
   502 │       │       │       │        │       │               │       │        return x.min(dim=("ipoint")).values                                                                                                                                                                                               
   503 │       │       │       │        │       │               │       │    else:                                                                                                                                                                                                                                 
   504 │       │       │       │        │       │               │       │        raise ValueError("bound must be either 'max' or 'min'")                                                                                                                                                                           
   505 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   506 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   507 │       │       │       │        │       │               │       │def calc_bounds(                                                                                                                                                                                                                          
   508 │       │       │       │        │       │               │       │    data_tars,                                                                                                                                                                                                                            
   509 │       │       │       │        │       │               │       │    data_preds,                                                                                                                                                                                                                           
   510 │       │       │       │        │       │               │       │    var,                                                                                                                                                                                                                                  
   511 │       │       │       │        │       │               │       │    bound,                                                                                                                                                                                                                                
   512 │       │       │       │        │       │               │       │):                                                                                                                                                                                                                                        
   513 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   514 │       │       │       │        │       │               │       │    Calculate the minimum and maximum values per variable for all forecasteps for both targets and predictions                                                                                                                            
   515 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   516 │       │       │       │        │       │               │       │    Parameters                                                                                                                                                                                                                            
   517 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
   518 │       │       │       │        │       │               │       │    data_tars :                                                                                                                                                                                                                           
   519 │       │       │       │        │       │               │       │        the (target) list of dictionaries with the forecasteps and respective xarray                                                                                                                                                      
   520 │       │       │       │        │       │               │       │    data_preds :                                                                                                                                                                                                                          
   521 │       │       │       │        │       │               │       │        the (prediction) list of dictionaries with the forecasteps and respective xarray                                                                                                                                                  
   522 │       │       │       │        │       │               │       │    Returns                                                                                                                                                                                                                               
   523 │       │       │       │        │       │               │       │    -------                                                                                                                                                                                                                               
   524 │       │       │       │        │       │               │       │    list_bound :                                                                                                                                                                                                                          
   525 │       │       │       │        │       │               │       │        a list with the maximum or minimum values for a specific variable.                                                                                                                                                                
   526 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   527 │       │       │       │        │       │               │       │    list_bound = []                                                                                                                                                                                                                       
   528 │       │       │       │        │       │               │       │    for da_tars, da_preds in zip(data_tars.values(), data_preds.values(), strict=False):                                                                                                                                                  
   529 │       │       │       │        │       │               │       │        list_bound.extend(                                                                                                                                                                                                                
   530 │       │       │       │        │       │               │       │            (                                                                                                                                                                                                                             
   531 │       │       │       │        │       │               │       │                calc_val(da_tars.where(da_tars.channel == var, drop=True), bound),                                                                                                                                                        
   532 │       │       │       │        │       │               │       │                calc_val(da_preds.where(da_preds.channel == var, drop=True), bound),                                                                                                                                                      
   533 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   534 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   535 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   536 │       │       │       │        │       │               │       │    return list_bound                                                                                                                                                                                                                     
   537 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   538 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   539 │       │       │       │        │       │               │       │def scalar_coord_to_dim(da: xr.DataArray, name: str, axis: int = -1) -> xr.DataArray:                                                                                                                                                     
   540 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   541 │       │       │       │        │       │               │       │    Convert a scalar coordinate to a dimension in an xarray DataArray.                                                                                                                                                                    
   542 │       │       │       │        │       │               │       │    If the coordinate is already a dimension, it is returned unchanged.                                                                                                                                                                   
   543 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   544 │       │       │       │        │       │               │       │    Parameters                                                                                                                                                                                                                            
   545 │       │       │       │        │       │               │       │    ----------                                                                                                                                                                                                                            
   546 │       │       │       │        │       │               │       │    da : xarray.DataArray                                                                                                                                                                                                                 
   547 │       │       │       │        │       │               │       │        The DataArray to modify.                                                                                                                                                                                                          
   548 │       │       │       │        │       │               │       │    name : str                                                                                                                                                                                                                            
   549 │       │       │       │        │       │               │       │        The name of the coordinate to convert.                                                                                                                                                                                            
   550 │       │       │       │        │       │               │       │    axis : int, optional                                                                                                                                                                                                                  
   551 │       │       │       │        │       │               │       │        The axis along which to expand the dimension. Default is -1 (last axis).                                                                                                                                                          
   552 │       │       │       │        │       │               │       │    Returns                                                                                                                                                                                                                               
   553 │       │       │       │        │       │               │       │    -------                                                                                                                                                                                                                               
   554 │       │       │       │        │       │               │       │    xarray.DataArray                                                                                                                                                                                                                      
   555 │       │       │       │        │       │               │       │        The modified DataArray with the scalar coordinate converted to a dimension.                                                                                                                                                       
   556 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
   557 │       │       │       │        │       │               │       │    if name in da.dims:                                                                                                                                                                                                                   
   558 │       │       │       │        │       │               │       │        return da  # already a dimension                                                                                                                                                                                                  
   559 │       │       │       │        │       │               │       │    if name in da.coords and da.coords[name].ndim == 0:                                                                                                                                                                                   
   560 │       │       │       │        │       │               │       │        val = da.coords[name].item()                                                                                                                                                                                                      
   561 │       │       │       │        │       │               │       │        da = da.drop_vars(name)                                                                                                                                                                                                           
   562 │       │       │       │        │       │               │       │        da = da.expand_dims({name: [val]}, axis=axis)                                                                                                                                                                                     
   563 │       │       │       │        │       │               │       │    return da                                                                                                                                                                                                                             
   564 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
╶──────┼───────┼───────┼───────┼────────┼───────┼───────────────┼───────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╴
       │       │       │       │        │       │               │       │function summary for /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/evaluate/src/weathergen/evaluate/utils.py                                                                                                  
   362 │       │       │   2%  │ 100%   │   10M │██   2%        │       │retrieve_metric_from_json                                                                                                                                                                                                                 
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
Top PEAK memory consumption, by line:
(1)   391:    10 MB                                                                                                                                                                                                                                                                                                 
                                                                          /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/common/src/weathergen/common/io.py: % of time =   0.00% (0.000ms) out of 4m:56.410s.                                                                           
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/packages/common/src/weathergen/common/io.py                                                                                                                              
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │# (C) Copyright 2025 WeatherGenerator contributors.                                                                                                                                                                                       
     2 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     3 │       │       │       │        │       │               │       │# This software is licensed under the terms of the Apache Licence Version 2.0                                                                                                                                                             
     4 │       │       │       │        │       │               │       │# which can be obtained at http://www.apache.org/licenses/LICENSE-2.0.                                                                                                                                                                    
     5 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     6 │       │       │       │        │       │               │       │# In applying this licence, ECMWF does not waive the privileges and immunities                                                                                                                                                            
     7 │       │       │       │        │       │               │       │# granted to it by virtue of its status as an intergovernmental organisation                                                                                                                                                              
     8 │       │       │       │        │       │               │       │# nor does it submit to any jurisdiction.                                                                                                                                                                                                 
     9 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    10 │       │       │       │        │       │               │       │import dataclasses                                                                                                                                                                                                                        
    11 │       │       │       │        │       │               │       │import functools                                                                                                                                                                                                                          
    12 │       │       │       │        │       │               │       │import itertools                                                                                                                                                                                                                          
    13 │       │       │       │        │       │               │       │import logging                                                                                                                                                                                                                            
    14 │       │       │       │        │       │               │       │import pathlib                                                                                                                                                                                                                            
    15 │       │       │       │        │       │               │       │import typing                                                                                                                                                                                                                             
    16 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    17 │       │       │       │ 100%   │   20M │▁▁   5%        │       │import dask.array as da                                                                                                                                                                                                                   
    18 │       │       │       │        │       │               │       │import numpy as np                                                                                                                                                                                                                        
    19 │       │       │       │        │       │               │       │import xarray as xr                                                                                                                                                                                                                       
    20 │       │       │       │        │       │               │       │import zarr                                                                                                                                                                                                                               
    21 │       │       │       │        │       │               │       │from numpy import datetime64                                                                                                                                                                                                              
    22 │       │       │       │        │       │               │       │from numpy.typing import NDArray                                                                                                                                                                                                          
    23 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    24 │       │       │       │        │       │               │       │# experimental value, should be inferred more intelligently                                                                                                                                                                               
    25 │       │       │       │        │       │               │       │CHUNK_N_SAMPLES = 16392                                                                                                                                                                                                                   
    26 │       │       │       │        │       │               │       │DType: typing.TypeAlias = np.float32                                                                                                                                                                                                      
    27 │       │       │       │        │       │               │       │type NPDT64 = datetime64                                                                                                                                                                                                                  
    28 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    29 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    30 │       │       │       │        │       │               │       │_logger = logging.getLogger(__name__)                                                                                                                                                                                                     
    31 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    32 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    33 │       │       │       │        │       │               │       │np.ndarray(3)                                                                                                                                                                                                                             
    34 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    35 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    36 │       │       │       │        │       │               │       │@dataclasses.dataclass                                                                                                                                                                                                                    
    37 │       │       │       │        │       │               │       │class IOReaderData:                                                                                                                                                                                                                       
    38 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    39 │       │       │       │        │       │               │       │    Equivalent to data_reader_base.ReaderData                                                                                                                                                                                             
    40 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    41 │       │       │       │        │       │               │       │    This class needs to exist since otherwise the common package would                                                                                                                                                                    
    42 │       │       │       │        │       │               │       │    have a dependecy on the core model. Ultimately a unified data model                                                                                                                                                                   
    43 │       │       │       │        │       │               │       │    should be implemented in the common package.                                                                                                                                                                                          
    44 │       │       │       │        │       │               │       │    """                                                                                                                                                                                                                                   
    45 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    46 │       │       │       │        │       │               │       │    coords: NDArray[DType]                                                                                                                                                                                                                
    47 │       │       │       │        │       │               │       │    geoinfos: NDArray[DType]                                                                                                                                                                                                              
    48 │       │       │       │        │       │               │       │    data: NDArray[DType]                                                                                                                                                                                                                  
    49 │       │       │       │        │       │               │       │    datetimes: NDArray[NPDT64]                                                                                                                                                                                                            
    50 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    51 │       │       │       │        │       │               │       │    @classmethod                                                                                                                                                                                                                          
    52 │       │       │       │        │       │               │       │    def create(cls, other: typing.Any) -> typing.Self:                                                                                                                                                                                    
    53 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
    54 │       │       │       │        │       │               │       │        create an instance from data_reader_base.ReaderData instance.                                                                                                                                                                     
    55 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    56 │       │       │       │        │       │               │       │        other should be such an instance.                                                                                                                                                                                                 
    57 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
    58 │       │       │       │        │       │               │       │        coords = other.coords                                                                                                                                                                                                             
    59 │       │       │       │        │       │               │       │        geoinfos = other.geoinfos                                                                                                                                                                                                         
    60 │       │       │       │        │       │               │       │        data = other.data                                                                                                                                                                                                                 
    61 │       │       │       │        │       │               │       │        datetimes = other.datetimes                                                                                                                                                                                                       
    62 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    63 │       │       │       │        │       │               │       │        n_datapoints = len(data)                                                                                                                                                                                                          
    64 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    65 │       │       │       │        │       │               │       │        assert coords.shape == (n_datapoints, 2), "number of datapoints do not match data"                                                                                                                                                
    66 │       │       │       │        │       │               │       │        assert geoinfos.shape[0] == n_datapoints, "number of datapoints do not match data"                                                                                                                                                
    67 │       │       │       │        │       │               │       │        assert datetimes.shape[0] == n_datapoints, "number of datapoints do not match data"                                                                                                                                               
    68 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    69 │       │       │       │        │       │               │       │        return cls(**dataclasses.asdict(other))                                                                                                                                                                                           
    70 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    71 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    72 │       │       │       │        │       │               │       │@dataclasses.dataclass                                                                                                                                                                                                                    
    73 │       │       │       │        │       │               │       │class ItemKey:                                                                                                                                                                                                                            
    74 │       │       │       │        │       │               │       │    """Metadata to identify one output item."""                                                                                                                                                                                           
    75 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    76 │       │       │       │        │       │               │       │    sample: int                                                                                                                                                                                                                           
    77 │       │       │       │        │       │               │       │    forecast_step: int                                                                                                                                                                                                                    
    78 │       │       │       │        │       │               │       │    stream: str                                                                                                                                                                                                                           
    79 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    80 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
    81 │       │       │       │        │       │               │       │    def path(self):                                                                                                                                                                                                                       
    82 │       │       │       │        │       │               │       │        """Unique path within a hierarchy for one output item."""                                                                                                                                                                         
    83 │       │       │       │        │       │               │       │        return f"{self.sample}/{self.stream}/{self.forecast_step}"                                                                                                                                                                        
    84 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    85 │       │       │       │        │       │               │       │    @property                                                                                                                                                                                                                             
    86 │       │       │       │        │       │               │       │    def with_source(self):                                                                                                                                                                                                                
    87 │       │       │       │        │       │               │       │        """Decide if output item should contain source dataset."""                                                                                                                                                                        
    88 │       │       │       │        │       │               │       │        # TODO: is this valid for the adjusted (offsetted) forecast steps?                                                                                                                                                                
    89 │       │       │       │        │       │               │       │        # => if config.forecast_offset > 0 source will be never written                                                                                                                                                                   
    90 │       │       │       │        │       │               │       │        return self.forecast_step == 0                                                                                                                                                                                                    
    91 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    92 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    93 │       │       │       │        │       │               │       │@dataclasses.dataclass                                                                                                                                                                                                                    
    94 │       │       │       │        │       │               │       │class OutputDataset:                                                                                                                                                                                                                      
    95 │       │       │       │        │       │               │       │    """Access source/target/prediction zarr data contained in one output item."""                                                                                                                                                         
    96 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    97 │       │       │       │        │       │               │       │    name: str                                                                                                                                                                                                                             
    98 │       │       │       │        │       │               │       │    item_key: ItemKey                                                                                                                                                                                                                     
    99 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   100 │       │       │       │        │       │               │       │    # (datapoints, channels, ens)                                                                                                                                                                                                         
   101 │       │       │       │        │       │               │       │    data: zarr.Array  # wrong type => array like                                                                                                                                                                                          
   102 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   103 │       │       │       │        │       │               │       │    # (datapoints,)                                                                                                                                                                                                                       
   104 │       │       │       │        │       │               │       │    times: zarr.Array                                                                                                                                                                                                                     
   105 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   106 │       │       │       │        │       │               │       │    # (datapoints, 2)                                                                                                                                                                                                                     
   107 │       │       │       │        │       │               │       │    coords: zarr.Array                                                                                                                                                                                                                    
   108 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   109 │       │       │       │        │       │               │       │    # (datapoints, geoinfos) geoinfos are stream dependent => 0 for most gridded data                                                                                                                                                     
   110 │       │       │       │        │       │               │       │    geoinfo: zarr.Array                                                                                                                                                                                                                   
   111 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   112 │       │       │       │        │       │               │       │    channels: list[str]                                                                                                                                                                                                                   
   113 │       │       │       │        │       │               │       │    geoinfo_channels: list[str]                                                                                                                                                                                                           
   114 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   115 │       │       │       │        │       │               │       │    @functools.cached_property                                                                                                                                                                                                            
   116 │       │       │       │        │       │               │       │    def arrays(self) -> dict[str, zarr.Array]:                                                                                                                                                                                            
   117 │       │       │       │        │       │               │       │        """Iterate over the arrays and their names."""                                                                                                                                                                                    
   118 │       │       │       │        │       │               │       │        return {                                                                                                                                                                                                                          
   119 │       │       │       │        │       │               │       │            "data": self.data,                                                                                                                                                                                                            
   120 │       │       │       │        │       │               │       │            "times": self.times,                                                                                                                                                                                                          
   121 │       │       │       │        │       │               │       │            "coords": self.coords,                                                                                                                                                                                                        
   122 │       │       │       │        │       │               │       │            "geoinfo": self.geoinfo,                                                                                                                                                                                                      
   123 │       │       │       │        │       │               │       │        }                                                                                                                                                                                                                                 
   124 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   125 │       │       │       │        │       │               │       │    @functools.cached_property                                                                                                                                                                                                            
   126 │       │       │       │        │       │               │       │    def datapoints(self) -> NDArray[np.int_]:                                                                                                                                                                                             
   127 │       │       │       │        │       │               │       │        return np.arange(self.data.shape[0])                                                                                                                                                                                              
   128 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   129 │       │       │       │        │       │               │       │    def as_xarray(self, chunk_nsamples=CHUNK_N_SAMPLES) -> xr.Dataset:                                                                                                                                                                    
   130 │       │       │       │        │       │               │       │        """Convert raw dask arrays into chunked dask-aware xarray dataset."""                                                                                                                                                             
   131 │       │       │       │        │       │               │       │        chunks = (chunk_nsamples, *self.data.shape[1:])                                                                                                                                                                                   
   132 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   133 │       │       │       │        │       │               │       │        # maybe do dask conversion earlier? => usefull for parallel writing?                                                                                                                                                              
   134 │       │       │       │        │       │               │       │        data = da.from_zarr(self.data, chunks=chunks)  # dont call compute to lazy load                                                                                                                                                   
   135 │       │       │       │        │       │               │       │        # include pseudo ens dim so all data arrays have same dimensionality                                                                                                                                                              
   136 │       │       │       │        │       │               │       │        # TODO: does it make sense for target and source to have ens dim?                                                                                                                                                                 
   137 │       │       │       │        │       │               │       │        additional_dims = (0, 1, 2) if len(data.shape) == 3 else (0, 1, 2, 5)                                                                                                                                                             
   138 │       │       │       │        │       │               │       │        expanded_data = da.expand_dims(data, axis=additional_dims)                                                                                                                                                                        
   139 │       │       │       │        │       │               │       │        coords = da.from_zarr(self.coords).compute()                                                                                                                                                                                      
   140 │       │       │       │        │       │               │       │        times = da.from_zarr(self.times).compute()                                                                                                                                                                                        
   141 │       │       │       │        │       │               │       │        geoinfo = da.from_zarr(self.geoinfo).compute()                                                                                                                                                                                    
   142 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   143 │       │       │       │        │       │               │       │        geoinfo = {name: ("ipoint", geoinfo[:, i]) for i, name in enumerate(self.geoinfo_channels)}                                                                                                                                       
   144 │       │       │       │        │       │               │       │        # TODO: make sample, stream, forecast_step DataArray attribute, test how it                                                                                                                                                       
   145 │       │       │       │        │       │               │       │        # interacts with concatenating                                                                                                                                                                                                    
   146 │       │       │       │        │       │               │       │        return xr.DataArray(                                                                                                                                                                                                              
   147 │       │       │       │        │       │               │       │            expanded_data,                                                                                                                                                                                                                
   148 │       │       │       │        │       │               │       │            dims=["sample", "stream", "forecast_step", "ipoint", "channel", "ens"],                                                                                                                                                       
   149 │       │       │       │        │       │               │       │            coords={                                                                                                                                                                                                                      
   150 │       │       │       │        │       │               │       │                "sample": [self.item_key.sample],                                                                                                                                                                                         
   151 │       │       │       │        │       │               │       │                "stream": [self.item_key.stream],                                                                                                                                                                                         
   152 │       │       │       │        │       │               │       │                "forecast_step": [self.item_key.forecast_step],                                                                                                                                                                           
   153 │       │       │       │        │       │               │       │                "ipoint": self.datapoints,                                                                                                                                                                                                
   154 │       │       │       │        │       │               │       │                "channel": self.channels,  # TODO: make sure channel names align with data                                                                                                                                                
   155 │       │       │       │        │       │               │       │                "valid_time": ("ipoint", times.astype("datetime64[ns]")),                                                                                                                                                                 
   156 │       │       │       │        │       │               │       │                "lat": ("ipoint", coords[..., 0]),                                                                                                                                                                                        
   157 │       │       │       │        │       │               │       │                "lon": ("ipoint", coords[..., 1]),                                                                                                                                                                                        
   158 │       │       │       │        │       │               │       │                **geoinfo,                                                                                                                                                                                                                
   159 │       │       │       │        │       │               │       │            },                                                                                                                                                                                                                            
   160 │       │       │       │        │       │               │       │            name=self.name,                                                                                                                                                                                                               
   161 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   162 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   163 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   164 │       │       │       │        │       │               │       │class OutputItem:                                                                                                                                                                                                                         
   165 │       │       │       │        │       │               │       │    def __init__(                                                                                                                                                                                                                         
   166 │       │       │       │        │       │               │       │        self,                                                                                                                                                                                                                             
   167 │       │       │       │        │       │               │       │        key: ItemKey,                                                                                                                                                                                                                     
   168 │       │       │       │        │       │               │       │        target: OutputDataset | None = None,                                                                                                                                                                                              
   169 │       │       │       │        │       │               │       │        prediction: OutputDataset | None = None,                                                                                                                                                                                          
   170 │       │       │       │        │       │               │       │        source: OutputDataset | None = None,                                                                                                                                                                                              
   171 │       │       │       │        │       │               │       │    ):                                                                                                                                                                                                                                    
   172 │       │       │       │        │       │               │       │        """Collection of possible datasets for one output item."""                                                                                                                                                                        
   173 │       │       │       │        │       │               │       │        self.key = key                                                                                                                                                                                                                    
   174 │       │       │       │        │       │               │       │        self.target = target                                                                                                                                                                                                              
   175 │       │       │       │        │       │               │       │        self.prediction = prediction                                                                                                                                                                                                      
   176 │       │       │       │        │       │               │       │        self.source = source                                                                                                                                                                                                              
   177 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   178 │       │       │       │        │       │               │       │        self.datasets = [self.target, self.prediction]                                                                                                                                                                                    
   179 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   180 │       │       │       │        │       │               │       │        if self.key.with_source:                                                                                                                                                                                                          
   181 │       │       │       │        │       │               │       │            if self.source:                                                                                                                                                                                                               
   182 │       │       │       │        │       │               │       │                self.datasets.append(self.source)                                                                                                                                                                                         
   183 │       │       │       │        │       │               │       │            else:                                                                                                                                                                                                                         
   184 │       │       │       │        │       │               │       │                msg = f"Missing source dataset for item: {self.key.path}"                                                                                                                                                                 
   185 │       │       │       │        │       │               │       │                raise ValueError(msg)                                                                                                                                                                                                     
   186 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   187 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   188 │       │       │       │        │       │               │       │class ZarrIO:                                                                                                                                                                                                                             
   189 │       │       │       │        │       │               │       │    """Manage zarr storage hierarchy."""                                                                                                                                                                                                  
   190 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   191 │       │       │       │        │       │               │       │    def __init__(self, store_path: pathlib.Path):                                                                                                                                                                                         
   192 │       │       │       │        │       │               │       │        self._store_path = store_path                                                                                                                                                                                                     
   193 │       │       │       │        │       │               │       │        self.data_root = None                                                                                                                                                                                                             
   194 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   195 │       │       │       │        │       │               │       │    def __enter__(self) -> typing.Self:                                                                                                                                                                                                   
   196 │       │       │       │        │       │               │       │        self._store = zarr.storage.DirectoryStore(self._store_path)                                                                                                                                                                       
   197 │       │       │       │        │       │               │       │        self.data_root = zarr.group(store=self._store)                                                                                                                                                                                    
   198 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   199 │       │       │       │        │       │               │       │        return self                                                                                                                                                                                                                       
   200 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   201 │       │       │       │        │       │               │       │    def __exit__(self, exc_type, exc_value, exc_tb):                                                                                                                                                                                      
   202 │       │       │       │        │       │               │       │        self._store.close()                                                                                                                                                                                                               
   203 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   204 │       │       │       │        │       │               │       │    def write_zarr(self, item: OutputItem):                                                                                                                                                                                               
   205 │       │       │       │        │       │               │       │        """Write one output item to the zarr store."""                                                                                                                                                                                    
   206 │       │       │       │        │       │               │       │        group = self._get_group(item.key, create=True)                                                                                                                                                                                    
   207 │       │       │       │        │       │               │       │        for dataset in item.datasets:                                                                                                                                                                                                     
   208 │       │       │       │        │       │               │       │            self._write_dataset(group, dataset)                                                                                                                                                                                           
   209 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   210 │       │       │       │        │       │               │       │    def get_data(self, sample: int, stream: str, forecast_step: int) -> OutputItem:                                                                                                                                                       
   211 │       │       │       │        │       │               │       │        """Get datasets for the output item matching the arguments."""                                                                                                                                                                    
   212 │       │       │       │        │       │               │       │        key = ItemKey(sample, forecast_step, stream)                                                                                                                                                                                      
   213 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   214 │       │       │       │        │       │               │       │        return self.load_zarr(key)                                                                                                                                                                                                        
   215 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   216 │       │       │       │        │       │               │       │    def load_zarr(self, key: ItemKey) -> OutputItem:                                                                                                                                                                                      
   217 │       │       │       │        │       │               │       │        """Get datasets for a output item."""                                                                                                                                                                                             
   218 │       │       │       │        │       │               │       │        group = self._get_group(key)                                                                                                                                                                                                      
   219 │       │       │       │        │       │               │       │        datasets = {                                                                                                                                                                                                                      
   220 │       │       │       │        │       │               │       │            name: OutputDataset(name, key, **dict(dataset.arrays()), **dataset.attrs)                                                                                                                                                     
   221 │       │       │       │        │       │               │       │            for name, dataset in group.groups()                                                                                                                                                                                           
   222 │       │       │       │        │       │               │       │        }                                                                                                                                                                                                                                 
   223 │       │       │       │        │       │               │       │        datasets["key"] = key                                                                                                                                                                                                             
   224 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   225 │       │       │       │        │       │               │       │        return OutputItem(**datasets)                                                                                                                                                                                                     
   226 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   227 │       │       │       │        │       │               │       │    def _get_group(self, item: ItemKey, create: bool = False) -> zarr.Group:                                                                                                                                                              
   228 │       │       │       │        │       │               │       │        assert self.data_root is not None, "ZarrIO must be opened before accessing data."                                                                                                                                                 
   229 │       │       │       │        │       │               │       │        group: zarr.Group | None                                                                                                                                                                                                          
   230 │       │       │       │        │       │               │       │        if create:                                                                                                                                                                                                                        
   231 │       │       │       │        │       │               │       │            group = self.data_root.create_group(item.path)                                                                                                                                                                                
   232 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   233 │       │       │       │        │       │               │       │            try:                                                                                                                                                                                                                          
   234 │       │       │       │        │       │               │       │                group = self.data_root.get(item.path)                                                                                                                                                                                     
   235 │       │       │       │        │       │               │       │                assert group is not None, f"Zarr group: {item.path} does not exist."                                                                                                                                                      
   236 │       │       │       │        │       │               │       │            except KeyError as e:                                                                                                                                                                                                         
   237 │       │       │       │        │       │               │       │                msg = f"Zarr group: {item.path} has not been created."                                                                                                                                                                    
   238 │       │       │       │        │       │               │       │                raise FileNotFoundError(msg) from e                                                                                                                                                                                       
   239 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   240 │       │       │       │        │       │               │       │        assert group is not None, f"Zarr group: {item.path} does not exist."                                                                                                                                                              
   241 │       │       │       │        │       │               │       │        return group                                                                                                                                                                                                                      
   242 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   243 │       │       │       │        │       │               │       │    def _write_dataset(self, item_group: zarr.Group, dataset: OutputDataset):                                                                                                                                                             
   244 │       │       │       │        │       │               │       │        dataset_group = item_group.require_group(dataset.name)                                                                                                                                                                            
   245 │       │       │       │        │       │               │       │        self._write_metadata(dataset_group, dataset)                                                                                                                                                                                      
   246 │       │       │       │        │       │               │       │        self._write_arrays(dataset_group, dataset)                                                                                                                                                                                        
   247 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   248 │       │       │       │        │       │               │       │    def _write_metadata(self, dataset_group: zarr.Group, dataset: OutputDataset):                                                                                                                                                         
   249 │       │       │       │        │       │               │       │        dataset_group.attrs["channels"] = dataset.channels                                                                                                                                                                                
   250 │       │       │       │        │       │               │       │        dataset_group.attrs["geoinfo_channels"] = dataset.geoinfo_channels                                                                                                                                                                
   251 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   252 │       │       │       │        │       │               │       │    def _write_arrays(self, dataset_group: zarr.Group, dataset: OutputDataset):                                                                                                                                                           
   253 │       │       │       │        │       │               │       │        for array_name, array in dataset.arrays.items():  # suffix is eg. data or coords                                                                                                                                                  
   254 │       │       │       │        │       │               │       │            self._create_dataset(dataset_group, array_name, array)                                                                                                                                                                        
   255 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   256 │       │       │       │        │       │               │       │    def _create_dataset(self, group: zarr.Group, name: str, array: NDArray):                                                                                                                                                              
   257 │       │       │       │        │       │               │       │        if array.size == 0:  # sometimes for geoinfo                                                                                                                                                                                      
   258 │       │       │       │        │       │               │       │            chunks = None                                                                                                                                                                                                                 
   259 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   260 │       │       │       │        │       │               │       │            chunks = (CHUNK_N_SAMPLES, *array.shape[1:])                                                                                                                                                                                  
   261 │       │       │       │        │       │               │       │        _logger.debug(                                                                                                                                                                                                                    
   262 │       │       │       │        │       │               │       │            f"writing array: {name} with shape: {array.shape},chunks: {chunks}"                                                                                                                                                           
   263 │       │       │       │        │       │               │       │            + "into group: {group}."                                                                                                                                                                                                      
   264 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   265 │       │       │       │        │       │               │       │        group.create_dataset(name, data=array, chunks=chunks)                                                                                                                                                                             
   266 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   267 │       │       │       │        │       │               │       │    @functools.cached_property                                                                                                                                                                                                            
   268 │       │       │       │        │       │               │       │    def samples(self) -> list[int]:                                                                                                                                                                                                       
   269 │       │       │       │        │       │               │       │        """Query available samples in this zarr store."""                                                                                                                                                                                 
   270 │       │       │       │        │       │               │       │        return list(self.data_root.group_keys())                                                                                                                                                                                          
   271 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   272 │       │       │       │        │       │               │       │    @functools.cached_property                                                                                                                                                                                                            
   273 │       │       │       │        │       │               │       │    def streams(self) -> list[str]:                                                                                                                                                                                                       
   274 │       │       │       │        │       │               │       │        """Query available streams in this zarr store."""                                                                                                                                                                                 
   275 │       │       │       │        │       │               │       │        # assume stream/samples are orthogonal => use first sample                                                                                                                                                                        
   276 │       │       │       │        │       │               │       │        _, example_sample = next(self.data_root.groups())                                                                                                                                                                                 
   277 │       │       │       │        │       │               │       │        return list(example_sample.group_keys())                                                                                                                                                                                          
   278 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   279 │       │       │       │        │       │               │       │    @functools.cached_property                                                                                                                                                                                                            
   280 │       │       │       │        │       │               │       │    def forecast_steps(self) -> list[int]:                                                                                                                                                                                                
   281 │       │       │       │        │       │               │       │        """Query available forecast steps in this zarr store."""                                                                                                                                                                          
   282 │       │       │       │        │       │               │       │        # assume stream/samples/forecast_steps are orthogonal                                                                                                                                                                             
   283 │       │       │       │        │       │               │       │        _, example_sample = next(self.data_root.groups())                                                                                                                                                                                 
   284 │       │       │       │        │       │               │       │        _, example_stream = next(example_sample.groups())                                                                                                                                                                                 
   285 │       │       │       │        │       │               │       │        return list(example_stream.group_keys())                                                                                                                                                                                          
   286 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   287 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   288 │       │       │       │        │       │               │       │@dataclasses.dataclass                                                                                                                                                                                                                    
   289 │       │       │       │        │       │               │       │class DataCoordinates:                                                                                                                                                                                                                    
   290 │       │       │       │        │       │               │       │    times: typing.Any                                                                                                                                                                                                                     
   291 │       │       │       │        │       │               │       │    coords: typing.Any                                                                                                                                                                                                                    
   292 │       │       │       │        │       │               │       │    geoinfo: typing.Any                                                                                                                                                                                                                   
   293 │       │       │       │        │       │               │       │    channels: typing.Any                                                                                                                                                                                                                  
   294 │       │       │       │        │       │               │       │    geoinfo_channels: typing.Any                                                                                                                                                                                                          
   295 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   296 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   297 │       │       │       │        │       │               │       │@dataclasses.dataclass                                                                                                                                                                                                                    
   298 │       │       │       │        │       │               │       │class OutputBatchData:                                                                                                                                                                                                                    
   299 │       │       │       │        │       │               │       │    """Provide convenient access to adapt existing output data structures."""                                                                                                                                                             
   300 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   301 │       │       │       │        │       │               │       │    # sample, stream, tensor(datapoint, channel+coords)                                                                                                                                                                                   
   302 │       │       │       │        │       │               │       │    # => datapoints is accross all datasets per stream                                                                                                                                                                                    
   303 │       │       │       │        │       │               │       │    sources: list[list[IOReaderData]]                                                                                                                                                                                                     
   304 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   305 │       │       │       │        │       │               │       │    # fstep, stream, redundant dim (size 1), tensor(sample x datapoint, channel)                                                                                                                                                          
   306 │       │       │       │        │       │               │       │    targets: list[list[list]]                                                                                                                                                                                                             
   307 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   308 │       │       │       │        │       │               │       │    # fstep, stream, redundant dim (size 1), tensor(ens, sample x datapoint, channel)                                                                                                                                                     
   309 │       │       │       │        │       │               │       │    predictions: list[list[list]]                                                                                                                                                                                                         
   310 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   311 │       │       │       │        │       │               │       │    # fstep, stream, tensor(sample x datapoint, 2 + geoinfos)                                                                                                                                                                             
   312 │       │       │       │        │       │               │       │    targets_coords: list[list]                                                                                                                                                                                                            
   313 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   314 │       │       │       │        │       │               │       │    # fstep, stream, (sample x datapoint)                                                                                                                                                                                                 
   315 │       │       │       │        │       │               │       │    targets_times: list[list[NDArray[DType]]]                                                                                                                                                                                             
   316 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   317 │       │       │       │        │       │               │       │    # fstep, stream, redundant dim (size 1)                                                                                                                                                                                               
   318 │       │       │       │        │       │               │       │    targets_lens: list[list[list[int]]]                                                                                                                                                                                                   
   319 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   320 │       │       │       │        │       │               │       │    # stream name: index into data (only streams in analysis_streams_output)                                                                                                                                                              
   321 │       │       │       │        │       │               │       │    streams: dict[str, int]                                                                                                                                                                                                               
   322 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   323 │       │       │       │        │       │               │       │    # stream, channel name                                                                                                                                                                                                                
   324 │       │       │       │        │       │               │       │    target_channels: list[list[str]]                                                                                                                                                                                                      
   325 │       │       │       │        │       │               │       │    source_channels: list[list[str]]                                                                                                                                                                                                      
   326 │       │       │       │        │       │               │       │    geoinfo_channels: list[list[str]]                                                                                                                                                                                                     
   327 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   328 │       │       │       │        │       │               │       │    sample_start: int                                                                                                                                                                                                                     
   329 │       │       │       │        │       │               │       │    forecast_offset: int                                                                                                                                                                                                                  
   330 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   331 │       │       │       │        │       │               │       │    @functools.cached_property                                                                                                                                                                                                            
   332 │       │       │       │        │       │               │       │    def samples(self):                                                                                                                                                                                                                    
   333 │       │       │       │        │       │               │       │        """Continous indices of all samples accross all batches."""                                                                                                                                                                       
   334 │       │       │       │        │       │               │       │        return np.arange(len(self.sources)) + self.sample_start                                                                                                                                                                           
   335 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   336 │       │       │       │        │       │               │       │    @functools.cached_property                                                                                                                                                                                                            
   337 │       │       │       │        │       │               │       │    def forecast_steps(self):                                                                                                                                                                                                             
   338 │       │       │       │        │       │               │       │        """Indices of all forecast steps adjusted by the forecast offset"""                                                                                                                                                               
   339 │       │       │       │        │       │               │       │        return np.arange(len(self.targets)) + self.forecast_offset                                                                                                                                                                        
   340 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   341 │       │       │       │        │       │               │       │    def items(self) -> typing.Generator[OutputItem, None, None]:                                                                                                                                                                          
   342 │       │       │       │        │       │               │       │        """Iterate over possible output items"""                                                                                                                                                                                          
   343 │       │       │       │        │       │               │       │        # TODO: filter for empty items?                                                                                                                                                                                                   
   344 │       │       │       │        │       │               │       │        for s, fo_s, fi_s in itertools.product(                                                                                                                                                                                           
   345 │       │       │       │        │       │               │       │            self.samples, self.forecast_steps, self.streams.keys()                                                                                                                                                                        
   346 │       │       │       │        │       │               │       │        ):                                                                                                                                                                                                                                
   347 │       │       │       │        │       │               │       │            yield self.extract(ItemKey(int(s), int(fo_s), fi_s))                                                                                                                                                                          
   348 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   349 │       │       │       │        │       │               │       │    def extract(self, key: ItemKey) -> OutputItem:                                                                                                                                                                                        
   350 │       │       │       │        │       │               │       │        """Extract datasets from lists for one output item."""                                                                                                                                                                            
   351 │       │       │       │        │       │               │       │        _logger.debug(f"extracting subset: {key}")                                                                                                                                                                                        
   352 │       │       │       │        │       │               │       │        offset_key = self._offset_key(key)                                                                                                                                                                                                
   353 │       │       │       │        │       │               │       │        stream_idx = self.streams[key.stream]                                                                                                                                                                                             
   354 │       │       │       │        │       │               │       │        datapoints = self._get_datapoints_per_sample(offset_key, stream_idx)                                                                                                                                                              
   355 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   356 │       │       │       │        │       │               │       │        _logger.debug(                                                                                                                                                                                                                    
   357 │       │       │       │        │       │               │       │            f"forecast_step: {key.forecast_step} = {offset_key.forecast_step} (rel_step) + "                                                                                                                                              
   358 │       │       │       │        │       │               │       │            + f"{self.forecast_offset} (forecast_offset)"                                                                                                                                                                                 
   359 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   360 │       │       │       │        │       │               │       │        _logger.debug(f"stream: {key.stream} with index: {stream_idx}")                                                                                                                                                                   
   361 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   362 │       │       │       │        │       │               │       │        if (datapoints.stop - datapoints.start) == 0:                                                                                                                                                                                     
   363 │       │       │       │        │       │               │       │            target_data = np.zeros((0, len(self.target_channels[stream_idx])), dtype=np.float32)                                                                                                                                          
   364 │       │       │       │        │       │               │       │            preds_data = np.zeros((0, len(self.target_channels[stream_idx])), dtype=np.float32)                                                                                                                                           
   365 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   366 │       │       │       │        │       │               │       │            target_data = (                                                                                                                                                                                                               
   367 │       │       │       │        │       │               │       │                self.targets[offset_key.forecast_step][stream_idx][0][datapoints]                                                                                                                                                         
   368 │       │       │       │        │       │               │       │                .cpu()                                                                                                                                                                                                                    
   369 │       │       │       │        │       │               │       │                .detach()                                                                                                                                                                                                                 
   370 │       │       │       │        │       │               │       │                .numpy()                                                                                                                                                                                                                  
   371 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   372 │       │       │       │        │       │               │       │            preds_data = (                                                                                                                                                                                                                
   373 │       │       │       │        │       │               │       │                self.predictions[offset_key.forecast_step][stream_idx][0]                                                                                                                                                                 
   374 │       │       │       │        │       │               │       │                .transpose(1, 0)                                                                                                                                                                                                          
   375 │       │       │       │        │       │               │       │                .transpose(1, 2)[datapoints]                                                                                                                                                                                              
   376 │       │       │       │        │       │               │       │                .cpu()                                                                                                                                                                                                                    
   377 │       │       │       │        │       │               │       │                .detach()                                                                                                                                                                                                                 
   378 │       │       │       │        │       │               │       │                .numpy()                                                                                                                                                                                                                  
   379 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   380 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   381 │       │       │       │        │       │               │       │        data_coords = self._extract_coordinates(stream_idx, offset_key, datapoints)                                                                                                                                                       
   382 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   383 │       │       │       │        │       │               │       │        assert len(data_coords.channels) == target_data.shape[1], (                                                                                                                                                                       
   384 │       │       │       │        │       │               │       │            "Number of channel names does not align with target data."                                                                                                                                                                    
   385 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   386 │       │       │       │        │       │               │       │        assert len(data_coords.channels) == preds_data.shape[1], (                                                                                                                                                                        
   387 │       │       │       │        │       │               │       │            "Number of channel names does not align with prediction data."                                                                                                                                                                
   388 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   389 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   390 │       │       │       │        │       │               │       │        if key.with_source:                                                                                                                                                                                                               
   391 │       │       │       │        │       │               │       │            source_dataset = self._extract_sources(offset_key.sample, stream_idx, key)                                                                                                                                                    
   392 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   393 │       │       │       │        │       │               │       │            source_dataset = None                                                                                                                                                                                                         
   394 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   395 │       │       │       │        │       │               │       │        return OutputItem(                                                                                                                                                                                                                
   396 │       │       │       │        │       │               │       │            key=key,                                                                                                                                                                                                                      
   397 │       │       │       │        │       │               │       │            source=source_dataset,                                                                                                                                                                                                        
   398 │       │       │       │        │       │               │       │            target=OutputDataset("target", key, target_data, **dataclasses.asdict(data_coords)),                                                                                                                                          
   399 │       │       │       │        │       │               │       │            prediction=OutputDataset(                                                                                                                                                                                                     
   400 │       │       │       │        │       │               │       │                "prediction", key, preds_data, **dataclasses.asdict(data_coords)                                                                                                                                                          
   401 │       │       │       │        │       │               │       │            ),                                                                                                                                                                                                                            
   402 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   403 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   404 │       │       │       │        │       │               │       │    def _get_datapoints_per_sample(self, offset_key, stream_idx):                                                                                                                                                                         
   405 │       │       │       │        │       │               │       │        lens = self.targets_lens[offset_key.forecast_step][stream_idx]                                                                                                                                                                    
   406 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   407 │       │       │       │        │       │               │       │        # empty target/prediction                                                                                                                                                                                                         
   408 │       │       │       │        │       │               │       │        if len(lens) == 0:                                                                                                                                                                                                                
   409 │       │       │       │        │       │               │       │            start = 0                                                                                                                                                                                                                     
   410 │       │       │       │        │       │               │       │            n_samples = 0                                                                                                                                                                                                                 
   411 │       │       │       │        │       │               │       │        else:                                                                                                                                                                                                                             
   412 │       │       │       │        │       │               │       │            start = sum(lens[: offset_key.sample])                                                                                                                                                                                        
   413 │       │       │       │        │       │               │       │            n_samples = lens[offset_key.sample]                                                                                                                                                                                           
   414 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   415 │       │       │       │        │       │               │       │        _logger.debug(                                                                                                                                                                                                                    
   416 │       │       │       │        │       │               │       │            f"sample: start:{self.sample_start} rel_idx:{offset_key.sample}"                                                                                                                                                              
   417 │       │       │       │        │       │               │       │            + f"range:{start}-{start + n_samples}"                                                                                                                                                                                        
   418 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   419 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   420 │       │       │       │        │       │               │       │        return slice(start, start + n_samples)                                                                                                                                                                                            
   421 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   422 │       │       │       │        │       │               │       │    def _offset_key(self, key: ItemKey):                                                                                                                                                                                                  
   423 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   424 │       │       │       │        │       │               │       │        Correct indices in key to be useable for data extraction.                                                                                                                                                                         
   425 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   426 │       │       │       │        │       │               │       │        `key` contains indices that are adjusted to have better output semantics.                                                                                                                                                         
   427 │       │       │       │        │       │               │       │        To be useable in extraction these have to be adjusted to bridge the differences                                                                                                                                                   
   428 │       │       │       │        │       │               │       │        compared to the semantics of the data.                                                                                                                                                                                            
   429 │       │       │       │        │       │               │       │            - `sample` is adjusted from a global continous index to a per batch index                                                                                                                                                     
   430 │       │       │       │        │       │               │       │            - `forecast_step` is adjusted from including `forecast_offset` to indexing                                                                                                                                                    
   431 │       │       │       │        │       │               │       │               the data (always starts at 0)                                                                                                                                                                                              
   432 │       │       │       │        │       │               │       │        """                                                                                                                                                                                                                               
   433 │       │       │       │        │       │               │       │        return ItemKey(                                                                                                                                                                                                                   
   434 │       │       │       │        │       │               │       │            key.sample - self.sample_start, key.forecast_step - self.forecast_offset, key.stream                                                                                                                                          
   435 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   436 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   437 │       │       │       │        │       │               │       │    def _extract_coordinates(self, stream_idx, offset_key, datapoints) -> DataCoordinates:                                                                                                                                                
   438 │       │       │       │        │       │               │       │        _coords = self.targets_coords[offset_key.forecast_step][stream_idx][datapoints].numpy()                                                                                                                                           
   439 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   440 │       │       │       │        │       │               │       │        # ensure _coords has size (?,2)                                                                                                                                                                                                   
   441 │       │       │       │        │       │               │       │        if len(_coords) == 0:                                                                                                                                                                                                             
   442 │       │       │       │        │       │               │       │            _coords = np.zeros((0, 2), dtype=np.float32)                                                                                                                                                                                  
   443 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   444 │       │       │       │        │       │               │       │        coords = _coords[..., :2]  # first two columns are lat,lon                                                                                                                                                                        
   445 │       │       │       │        │       │               │       │        geoinfo = _coords[..., 2:]  # the rest is geoinfo => potentially empty                                                                                                                                                            
   446 │       │       │       │        │       │               │       │        if geoinfo.size > 0:  # TODO: set geoinfo to be empty for now                                                                                                                                                                     
   447 │       │       │       │        │       │               │       │            geoinfo = np.empty((geoinfo.shape[0], 0))                                                                                                                                                                                     
   448 │       │       │       │        │       │               │       │            _logger.warning(                                                                                                                                                                                                              
   449 │       │       │       │        │       │               │       │                "geoinformation channels are not implemented yet."                                                                                                                                                                        
   450 │       │       │       │        │       │               │       │                + "will be truncated to be of size 0."                                                                                                                                                                                    
   451 │       │       │       │        │       │               │       │            )                                                                                                                                                                                                                             
   452 │       │       │       │        │       │               │       │        times = self.targets_times[offset_key.forecast_step][stream_idx][                                                                                                                                                                 
   453 │       │       │       │        │       │               │       │            datapoints                                                                                                                                                                                                                    
   454 │       │       │       │        │       │               │       │        ]  # make conversion to datetime64[ns] here?                                                                                                                                                                                      
   455 │       │       │       │        │       │               │       │        channels = self.target_channels[stream_idx]                                                                                                                                                                                       
   456 │       │       │       │        │       │               │       │        geoinfo_channels = self.geoinfo_channels[stream_idx]                                                                                                                                                                              
   457 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   458 │       │       │       │        │       │               │       │        return DataCoordinates(times, coords, geoinfo, channels, geoinfo_channels)                                                                                                                                                        
   459 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   460 │       │       │       │        │       │               │       │    def _extract_sources(self, sample, stream_idx, key):                                                                                                                                                                                  
   461 │       │       │       │        │       │               │       │        channels = self.source_channels[stream_idx]                                                                                                                                                                                       
   462 │       │       │       │        │       │               │       │        geoinfo_channels = self.geoinfo_channels[stream_idx]                                                                                                                                                                              
   463 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   464 │       │       │       │        │       │               │       │        source = self.sources[sample][stream_idx]                                                                                                                                                                                         
   465 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   466 │       │       │       │        │       │               │       │        assert source.data.shape[1] == len(channels), (                                                                                                                                                                                   
   467 │       │       │       │        │       │               │       │            "Number of source channel names does not align with source data"                                                                                                                                                              
   468 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   469 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   470 │       │       │       │        │       │               │       │        source_dataset = OutputDataset(                                                                                                                                                                                                   
   471 │       │       │       │        │       │               │       │            "source",                                                                                                                                                                                                                     
   472 │       │       │       │        │       │               │       │            key,                                                                                                                                                                                                                          
   473 │       │       │       │        │       │               │       │            source.data,                                                                                                                                                                                                                  
   474 │       │       │       │        │       │               │       │            source.datetimes,                                                                                                                                                                                                             
   475 │       │       │       │        │       │               │       │            source.coords,                                                                                                                                                                                                                
   476 │       │       │       │        │       │               │       │            source.geoinfos,                                                                                                                                                                                                              
   477 │       │       │       │        │       │               │       │            channels,                                                                                                                                                                                                                     
   478 │       │       │       │        │       │               │       │            geoinfo_channels,                                                                                                                                                                                                             
   479 │       │       │       │        │       │               │       │        )                                                                                                                                                                                                                                 
   480 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   481 │       │       │       │        │       │               │       │        _logger.debug(f"source shape: {source_dataset.data.shape}")                                                                                                                                                                       
   482 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
   483 │       │       │       │        │       │               │       │        return source_dataset                                                                                                                                                                                                             
   484 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
Top PEAK memory consumption, by line:
(1)    17:    20 MB                                                                                                                                                                                                                                                                                                 
                                                                                 /p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/src/weathergen/train/utils.py: % of time =   0.00% (0.000ms) out of 4m:56.410s.                                                                                  
       ╷       ╷       ╷       ╷        ╷       ╷               ╷       ╷                                                                                                                                                                                                                                          
       │Time   │–––––– │–––––– │Memory  │–––––– │–––––––––––    │Copy   │                                                                                                                                                                                                                                          
  Line │Python │native │system │Python  │peak   │timeline/%     │(MB/s) │/p/project1/weatherai/tarnawa2/weathergenerator/WeatherGenerator/src/weathergen/train/utils.py                                                                                                                                            
╺━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━┿━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━┿━━━━━━━┿━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸
     1 │       │       │       │        │       │               │       │# (C) Copyright 2025 WeatherGenerator contributors.                                                                                                                                                                                       
     2 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     3 │       │       │       │        │       │               │       │# This software is licensed under the terms of the Apache Licence Version 2.0                                                                                                                                                             
     4 │       │       │       │        │       │               │       │# which can be obtained at http://www.apache.org/licenses/LICENSE-2.0.                                                                                                                                                                    
     5 │       │       │       │        │       │               │       │#                                                                                                                                                                                                                                         
     6 │       │       │       │        │       │               │       │# In applying this licence, ECMWF does not waive the privileges and immunities                                                                                                                                                            
     7 │       │       │       │        │       │               │       │# granted to it by virtue of its status as an intergovernmental organisation                                                                                                                                                              
     8 │       │       │       │        │       │               │       │# nor does it submit to any jurisdiction.                                                                                                                                                                                                 
     9 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    10 │       │       │       │        │       │               │       │import json                                                                                                                                                                                                                               
    11 │       │       │       │        │       │               │       │import random                                                                                                                                                                                                                             
    12 │       │       │       │        │       │               │       │import string                                                                                                                                                                                                                             
    13 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    14 │       │       │       │  55%   │  112M │▁▁▁▁▁▁▁▁▁  26% │       │import torch                                                                                                                                                                                                                              
    15 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    16 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    17 │       │       │       │        │       │               │       │def get_run_id():                                                                                                                                                                                                                         
    18 │       │       │       │        │       │               │       │    s1 = string.ascii_lowercase                                                                                                                                                                                                           
    19 │       │       │       │        │       │               │       │    s2 = string.ascii_lowercase + string.digits                                                                                                                                                                                           
    20 │       │       │       │        │       │               │       │    return "".join(random.sample(s1, 1)) + "".join(random.sample(s2, 7))                                                                                                                                                                  
    21 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    22 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    23 │       │       │       │        │       │               │       │def str_to_tensor(modelid):                                                                                                                                                                                                               
    24 │       │       │       │        │       │               │       │    return torch.tensor([ord(c) for c in modelid], dtype=torch.int32)                                                                                                                                                                     
    25 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    26 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    27 │       │       │       │        │       │               │       │def tensor_to_str(tensor):                                                                                                                                                                                                                
    28 │       │       │       │        │       │               │       │    return "".join([chr(x) for x in tensor])                                                                                                                                                                                              
    29 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    30 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
    31 │       │       │       │        │       │               │       │def json_to_dict(fname):                                                                                                                                                                                                                  
    32 │       │       │       │        │       │               │       │    with open(fname) as f:                                                                                                                                                                                                                
    33 │       │       │       │        │       │               │       │        json_str = f.readlines()                                                                                                                                                                                                          
    34 │       │       │       │        │       │               │       │    return json.loads("".join([s.replace("\n", "") for s in json_str]))                                                                                                                                                                   
    35 │       │       │       │        │       │               │       │                                                                                                                                                                                                                                          
       ╵       ╵       ╵       ╵        ╵       ╵               ╵       ╵                                                                                                                                                                                                                                          
Top PEAK memory consumption, by line:
(1)    14:   112 MB                                                                                                                                                                                                                                                                                                 
